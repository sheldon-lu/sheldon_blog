<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Golang并发篇</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E7%AF%87/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="Golang之并发篇"><a href="#Golang之并发篇" class="headerlink" title="Golang之并发篇"></a>Golang之并发篇</h2><h3 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A.进程是程序在操作系统中的一次执行过程，系统进行资源分配和调度的一个独立单位。</span><br><span class="line"></span><br><span class="line">B.线程是进程的一个执行实体，是CPU调度和分派的基本单位，它是比进程更小的能独立运行的基本单位。</span><br><span class="line"></span><br><span class="line">C.一个进程可以创建和撤销多个线程；同一进程中的多个线程之间可以并发执行。</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119160736443-318205395.png" alt="img"></p><h3 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行<a id="more"></a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">并发：多线程程序在一个核的cpu上运行</span><br><span class="line">并行：多线程程序在多个核的cpu上运行</span><br><span class="line">举例: 一个妈给一个碗给多个小孩喂饭，，是并发</span><br><span class="line">　　　　一个妈给每个小孩一人一个碗，就是并行</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119161120193-1746947231.png" alt="img"></p><h3 id="协程和线程"><a href="#协程和线程" class="headerlink" title="协程和线程"></a>协程和线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">协程：独立的栈空间，共享堆空间，调度由用户自己控制，本质上有点类似于用户级协程，这些用户级线程的调度也是自己实现的。</span><br><span class="line">线程：一个线程上可以跑多个协程，协程是轻量级的线程。</span><br></pre></td></tr></table></figure><p><strong>例子</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> test() <span class="comment">//起一个协程执行test（）</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"i : runnging in main"</span>)</span><br><span class="line">        time.Sleep(time.Second )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="GPM"><a href="#GPM" class="headerlink" title="GPM"></a>GPM</h3><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119164420162-1968227687.png" alt="img"></p><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119164737381-1301671524.png" alt="img"></p><p><strong>设置Golang运行的cpu核数。</strong></p><p><strong>1.8版本以上，默认跑多个核</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    num := runtime.NumCPU()</span><br><span class="line">    runtime.GOMAXPROCS(num)</span><br><span class="line">    fmt.Println(num)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并发计算</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    m    = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">uint64</span>)</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> task <span class="keyword">struct</span> &#123;</span><br><span class="line">    n <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calc</span><span class="params">(t *task)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">uint64</span></span><br><span class="line">    sum = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; t.n; i++ &#123;</span><br><span class="line">        sum *= <span class="keyword">uint64</span>(i)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(t.n, sum)</span><br><span class="line">    lock.Lock()</span><br><span class="line">    m[t.n] = sum</span><br><span class="line">    lock.Unlock()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">        t := &amp;task&#123;n: i&#125;</span><br><span class="line">        <span class="keyword">go</span> calc(t)<span class="comment">//并发执行，谁快谁先出 </span></span><br><span class="line">    &#125;</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">    <span class="comment">//lock.Lock()</span></span><br><span class="line">    <span class="comment">//for k, v := range m &#123;</span></span><br><span class="line">    <span class="comment">//    fmt.Printf("%d!=%v\n", k, v)</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">//lock.Unlock()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><h4 id="channel概念"><a href="#channel概念" class="headerlink" title="channel概念"></a>channel概念</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a.类似unix中的管道(pipe)</span><br><span class="line">b.先进先出</span><br><span class="line">c.线程安全，多个goroutine同时访问，不需要枷锁</span><br><span class="line">d.channel是有类型的，一个整数的channel只能存整数</span><br></pre></td></tr></table></figure><h4 id="channel声明"><a href="#channel声明" class="headerlink" title="channel声明"></a>channel声明</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> age <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> mapchan <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> test <span class="keyword">chan</span> student</span><br><span class="line"><span class="keyword">var</span> test1 <span class="keyword">chan</span> *student</span><br></pre></td></tr></table></figure><h4 id="channel初始化"><a href="#channel初始化" class="headerlink" title="channel初始化"></a>channel初始化</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用<span class="built_in">make</span>进行初始化</span><br><span class="line"><span class="keyword">var</span> test <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">test = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>,<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">test=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>,<span class="number">10</span>)</span><br></pre></td></tr></table></figure><h4 id="channel基本操作"><a href="#channel基本操作" class="headerlink" title="channel基本操作"></a>channel基本操作</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">从channel读取数据</span><br><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line">a = &lt;-testChan</span><br></pre></td></tr></table></figure><h4 id="从channel写入数据"><a href="#从channel写入数据" class="headerlink" title="从channel写入数据"></a>从channel写入数据</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span> = <span class="number">10</span></span><br><span class="line">testChan &lt;- a</span><br></pre></td></tr></table></figure><p>第一个例子</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> stuChan <span class="keyword">chan</span> *student</span><br><span class="line">    stuChan = <span class="built_in">make</span>(<span class="keyword">chan</span> *student, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    stu := student&#123;name: <span class="string">"stu001"</span>&#125;</span><br><span class="line"></span><br><span class="line">    stuChan &lt;- &amp;stu</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stu01 <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    stu01 = &lt;-stuChan</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stu02 *student</span><br><span class="line">    stu02, ok := stu01.(*student)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        fmt.Println(<span class="string">"can not convert"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(stu02)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="goroutine与channel"><a href="#goroutine与channel" class="headerlink" title="goroutine与channel"></a>goroutine与channel</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//起一个读的协程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> b <span class="keyword">int</span></span><br><span class="line">        b = &lt;-ch</span><br><span class="line">        fmt.Println(b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    intChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">go</span> write(intChan)</span><br><span class="line">    <span class="keyword">go</span> read(intChan)</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读，取，字符串</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    ch &lt;- <span class="string">"Washington"</span></span><br><span class="line">    ch &lt;- <span class="string">"Tripoli"</span></span><br><span class="line">    ch &lt;- <span class="string">"London"</span></span><br><span class="line">    ch &lt;- <span class="string">"Beijing"</span></span><br><span class="line">    ch &lt;- <span class="string">"Tokio"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        input = &lt;-ch</span><br><span class="line">        fmt.Println(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> sendData(ch)</span><br><span class="line">    <span class="keyword">go</span> getData(ch)</span><br><span class="line">    time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Channel缓冲区"><a href="#Channel缓冲区" class="headerlink" title="Channel缓冲区"></a>Channel缓冲区</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只能放一个元素的testChan</span></span><br><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line">a = &lt;-testChan</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// testChan是带缓冲区的chan，一次可以放10个元素</span></span><br><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span> = <span class="number">10</span></span><br><span class="line">testChan &lt;- a</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    m    = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">uint64</span>)</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> task <span class="keyword">struct</span> &#123;</span><br><span class="line">    n <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calc</span><span class="params">(t *task)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">uint64</span></span><br><span class="line">    sum = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; t.n; i++ &#123;</span><br><span class="line">        sum *= <span class="keyword">uint64</span>(i)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(t.n, sum)</span><br><span class="line">    lock.Lock()</span><br><span class="line">    m[t.n] = sum</span><br><span class="line">    lock.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">        t := &amp;task&#123;n: i&#125;</span><br><span class="line">        <span class="keyword">go</span> calc(t)</span><br><span class="line">    &#125;</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">    lock.Lock()</span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"%d!=%v\n"</span>, k, v)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    lock.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calc</span><span class="params">(taskChan <span class="keyword">chan</span> <span class="keyword">int</span>, resChan <span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> taskChan &#123;</span><br><span class="line">        flag := <span class="literal">true</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">2</span>; i &lt; v; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> v%i == <span class="number">0</span> &#123;</span><br><span class="line">                flag = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> flag &#123;</span><br><span class="line">            resChan &lt;- v</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">"exit"</span>)</span><br><span class="line">    exitChan &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    intChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1000</span>)</span><br><span class="line">    resultChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1000</span>)</span><br><span class="line">    exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">            intChan &lt;- i</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(intChan)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> calc(intChan, resultChan, exitChan)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待所有计算的goroutine全部退出</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">            &lt;-exitChan</span><br><span class="line">            fmt.Println(<span class="string">"wait goroute"</span>, i, <span class="string">"exited"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(resultChan)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> resultChan &#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        v, ok := &lt;-ch</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> send(ch, exitChan)</span><br><span class="line">    <span class="keyword">go</span> recv(ch, exitChan)</span><br><span class="line">    <span class="keyword">var</span> total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ = <span class="keyword">range</span> exitChan &#123;</span><br><span class="line">        total++</span><br><span class="line">        <span class="keyword">if</span> total == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="检测管道是否关闭"><a href="#检测管道是否关闭" class="headerlink" title="检测管道是否关闭"></a>检测管道是否关闭</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> b <span class="keyword">int</span></span><br><span class="line">        b, ok := &lt;-ch</span><br><span class="line">        <span class="comment">//检测管道是否关闭</span></span><br><span class="line">        <span class="keyword">if</span> ok == <span class="literal">false</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"chan is close"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如何关闭chan"><a href="#如何关闭chan" class="headerlink" title="如何关闭chan"></a>如何关闭chan</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 使用内置函数close进行关闭，chan关闭之后，for range遍历chan中</span><br><span class="line">已经存在的元素后结束</span><br><span class="line">2. 使用内置函数close进行关闭，chan关闭之后，没有使用for range的写法</span><br><span class="line">需要使用，v, ok := &lt;- ch进行判断chan是否关闭</span><br></pre></td></tr></table></figure><h3 id="chan的只读和只写"><a href="#chan的只读和只写" class="headerlink" title="chan的只读和只写"></a>chan的只读和只写</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">只读的声明</span><br><span class="line">Var 变量的名字 &lt;-chan int</span><br><span class="line">Var readChan &lt;- chan int</span><br><span class="line"></span><br><span class="line">只写的声明</span><br><span class="line">Var 变量的名字 chan&lt;- int</span><br><span class="line">Var writeChan chan&lt;- int</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//只写chan</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只读chan</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        v, ok := &lt;-ch</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>) <span class="comment">//初始化chan</span></span><br><span class="line">    exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> send(ch, exitChan)</span><br><span class="line">    <span class="keyword">go</span> recv(ch, exitChan)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ = <span class="keyword">range</span> exitChan &#123;</span><br><span class="line">        total++</span><br><span class="line">        <span class="keyword">if</span> total == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不阻塞</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            ch &lt;- i</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            ch2 &lt;- i * i</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            i++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> v := &lt;-ch:</span><br><span class="line">            fmt.Println(v)</span><br><span class="line">        <span class="keyword">case</span> v := &lt;-ch2:</span><br><span class="line">            fmt.Println(v)</span><br><span class="line">        <span class="keyword">case</span> &lt;-time.After(time.Second):</span><br><span class="line">            fmt.Println(<span class="string">"get data timeout"</span>)</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发之条件变量</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<blockquote><p>条件变量</p></blockquote><p>在Go语言中，sync.Cond类型代表了条件变量。与互斥锁和读写锁不同，简单的声明无法创建出一个可用的条件变量。为了得到这样一个条件变量，我们需要用到sync.NewCond函数。该函数的声明如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCond</span><span class="params">(l Locker)</span> *<span class="title">Cond</span></span></span><br></pre></td></tr></table></figure><p>条件变量总是要与互斥量组合使用。因此，sync.NewCond函数的唯一参数是sync.Locker类型的，而具体的参数值既可以是一个互斥锁也可以是一个读写锁。sync.NewCond函数在被调用之后会返回一个*sync.Cond类型的结果值。我们可以调用该值拥有的几个方法来操纵对应的条件变量。<a id="more"></a></p><p>类型*sync.Cond的方法集合中有三个方法，即：Wait方法、Signal方法和Broadcast方法。它们分别代表了等待通知、单发通知和广播通知的操作。</p><p>方法Wait会自动的对与该条件变量关联的那个锁进行解锁，并且使调用方所在的Goroutine被阻塞。一旦该方法收到通知，就会试图再次锁定该锁。如果锁定成功，它就会唤醒那个被它阻塞的Goroutine。否则，该方法会等待下一个通知，那个Goroutine也会继续被阻塞。而方法Signal和Broadcast的作用都是发送通知以唤醒正在为此而被阻塞的Goroutine。不同的是，前者的目标只有一个，而后者的目标则是所有。</p><p>在Read方法中，我们对一种边界情况进行了特殊处理，即：如果*os.File类型的f字段的ReadAt方法在被调用后返回了一个非nil且等于io.EOF的错误值，那么Read方法就忽略这个错误并再次尝试读取相同位置的数据块，直到读取成功为止。从这个特殊处理的具体流程上来看，似乎使用条件变量来作为辅助手段会带来一些好处。下面我们就来动手试验一下。</p><p>我们先在结构体类型myDataFile增加一个类型为*sync.Cond的字段rcond。为了快速实现想法，我们暂时不考虑怎样初始化这个字段，而直接去改造Read方法和Write方法。</p><p>在Read方法中，我们使用一个for循环来达到重新尝试获取数据块的目的。为此，我们添加了若干条重复的语句、降低了程序的性能，还造成了一个潜在的问题——在某个情况下读写锁fmutex不会被读解锁。为了解决这一系列新生的问题，我们使用代表条件变量的字段rcond。Read方法的第三个版本如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(df *myDataFile)</span> <span class="title">Read</span><span class="params">()</span> <span class="params">(rsn <span class="keyword">int64</span>, d Data, err error)</span></span> &#123;</span><br><span class="line"><span class="comment">// 读取并更新读偏移量</span></span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line"><span class="comment">// 读取一个数据块</span></span><br><span class="line">rsn = offset / <span class="keyword">int64</span>(df.dataLen)</span><br><span class="line">bytes := <span class="built_in">make</span>([]<span class="keyword">byte</span>, df.dataLen)</span><br><span class="line">df.fmutex.RLock()</span><br><span class="line"><span class="keyword">defer</span> df.fmutex.RUnlock()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">_, err = df.f.ReadAt(bytes, offset)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">df.rcond.Wait()</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">d = bytes</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们假设条件变量rcond与读写锁fmutex中的“读锁”相关联。可以看到，我们让defer df.fmutex.RUnlock()语句回归了，并删除了所有return语句和continue语句前面的针对fmutex的读解锁操作。这都得益于新增在continue语句前面的df.rcond.Wait()。添加这条语句的意义在于：当发现由文件内容读取造成的EOF错误时，要让当前Goroutine暂时放弃fmutex的“读锁”并等待通知的到来。放弃fmutex的“读锁”也就意味着Write方法中的数据块写操作不会受到它的阻碍了。在写操作完成之后，我们应该及时向条件变量rcond发送通知以唤醒为此而等待的Goroutine。请注意，在某个Goroutine被唤醒之后，应该再次检查需要被满足的条件。在这里，这个需要被满足的条件是在进行文件内容读取时不会造成EOF错误。如果该条件被满足，那么就可以进行后续的操作了。否则，应该再次放弃“读锁”并等待通知。这也是我们依然保留for循环的原因。</p><p>这里有两点需要特别注意。</p><ul><li>一定要在调用rcond的Wait方法之前锁定与之关联的那个“读锁”，否则就会造成对Wait方法的调用永远无法返回。这种情况会导致流程执行的停滞，甚至整个程序的死锁！导致这种结果的原因与条件变量和读写锁的内部实现方式有关（结果也许并不应该是这样，作者已经向Go语言官方提交了一个issue；Go语言官方已经接受了这个issue，并承诺将会在Go 1.4版本中改进它）。假设，与条件变量rcond关联的是某个读写锁的“写锁”或普通的互斥锁，那么对rcond.Wait方法的调用将会引发一个运行时恐慌。原因是，该方法会先对与之关联的锁进行解锁，而试图解锁未被锁定的锁就会引发一个运行时恐慌。</li><li>一定不要忘记在读操作完成之前解锁与条件变量rcond关联的那个“读锁”，否则对读写锁的写锁定操作将会阻塞相关的Goroutine。其根本原因是，条件变量rcond的Wait方法在返回之前会重新锁定与之关联的那个“读锁”。因此，在结束这个从文件中读取一个数据块的流程之前，我们应该调用fmutex字段的RLock方法。那条defer语句就起到了这个作用。</li></ul><p>我们对Read方法的这次改进使得它的实现变得更加简洁和清晰了。不过，要想使其中的条件变量rcond真正发挥作用，还需要Write方法的配合。换句话说，为了让rcond.Wait方法可以适时的返回，我们要在向文件写入一个数据块之后及时的向rcond发送通知。添加了这一操作的Write方法如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(df *myDataFile)</span> <span class="title">Write</span><span class="params">(d Data)</span> <span class="params">(wsn <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line"><span class="keyword">var</span> bytes []<span class="keyword">byte</span></span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line">df.fmutex.Lock()</span><br><span class="line"><span class="keyword">defer</span> df.fmutex.Unlock()</span><br><span class="line">_, err = df.f.Write(bytes)</span><br><span class="line">df.rcond.Signal()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于一个数据块只能由某一个读操作读取，所以我们只是使用条件变量的Signal方法去通知某一个为此等待的Wait方法，并以此唤醒某一个相关的Goroutine。这可以免去其它相关的Goroutine中的一些无谓操作。</p><p>与Wait方法不同，我们在调用条件变量的Signal方法和Broadcast方法之前无需锁定与之关联的锁。随之，相应的解锁操作也是不需要的。在这个Write方法中的锁定操作和解锁的操作针对的并不是df.rcond.Signal()语句。</p><p>我们一直在说，条件变量rcond是与读写锁fmutex的“读锁”关联的。这是怎样做到的呢？读者还记得我们在上一节提到读写锁的RLocker方法吗？它会返回当前读写锁中的“读锁”。这个结果值同时也是sync.Locker接口的实现。因此，我们可以把它作为参数值传给sync.NewCond函数。所以，我们在NewDataFile函数中的声明df变量的语句的后面加入了这样一条语句：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.rcond = sync.NewCond(df.fmutex.RLocker())</span><br></pre></td></tr></table></figure><p>在这之后，我们就可以像前面那样使用这个条件变量了。</p><p>随着对*myDataFile类型和NewDataFile函数的改造的完成，我们也将结束本节。Go语言提供的互斥锁、读写锁和条件变量都基本遵循了POSIX标准中描述的对应的同步工具的行为规范。它们简单且高效。我们可以使用它们为复杂的类型提供并发安全的保证。在一些情况下，它们比通道更加灵活。在只需对一个或多个临界区进行保护的时候，使用锁往往会对程序的性能损耗更小。</p>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列一</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%97%E4%B8%80/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%97%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro系列一-–-入门篇"><a href="#Go-Micro系列一-–-入门篇" class="headerlink" title="Go-Micro系列一 – 入门篇"></a>Go-Micro系列一 – 入门篇</h2><p><code>go 1.13.0</code> go版本 1.12 - 1.13</p><blockquote><p>官方貌似20200227开始更新版本，关于micro的V2、GO MOD更新</p></blockquote><h3 id="安装go-micro"><a href="#安装go-micro" class="headerlink" title="安装go-micro"></a>安装go-micro</h3><h4 id="安装consul"><a href="#安装consul" class="headerlink" title="安装consul"></a>安装consul</h4><p>安装服务发现能力，<strong>docker安装consul</strong>或者<strong>本地安装运行consul</strong>，consul在本地开发环境使用方便便于调试。</p><p>1、docker安装consul<a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net=host -e &apos;CONSUL_LOCAL_CONFIG=&#123;&quot;skip_leave_on_interrupt&quot;: true&#125;&apos;  --name consul_server  consul agent -server -bind=192.168.0.111 -bootstrap-expect=1  -node=node1 -client 0.0.0.0 -ui</span><br></pre></td></tr></table></figure><p>2、本地安装运行consul</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">windows:</span><br><span class="line">https://www.consul.io/downloads.html</span><br><span class="line">mac:</span><br><span class="line">https://www.consul.io/downloads.html</span><br><span class="line"></span><br><span class="line">直接下载对应操作系统的版本即可，自行添加环境变量</span><br><span class="line">consul命令即可直接运行，默认端口8500</span><br><span class="line"></span><br><span class="line">consul agent -server -bind=192.168.0.111 -bootstrap-expect=1  -node=node1 -client 0.0.0.0 -ui</span><br><span class="line">consul agent -dev  # 本地开发测试直接运行dev即可</span><br></pre></td></tr></table></figure><p>以上两种方式运行，浏览器输入<a href="http://192.168.0.111:8500/" target="_blank" rel="noopener">http://192.168.0.111:8500</a> 能看到consul的UI页面表示正常启动</p><h4 id="安装Micro"><a href="#安装Micro" class="headerlink" title="安装Micro"></a>安装Micro</h4><h5 id="基础知识补充"><a href="#基础知识补充" class="headerlink" title="基础知识补充"></a>基础知识补充</h5><p>go的包管理工具 – gomod</p><p>可参考：<a href="https://segmentfault.com/a/1190000018389353?utm_source=tag-newest" target="_blank" rel="noopener">https://segmentfault.com/a/1190000018389353?utm_source=tag-newest</a></p><p> <a href="https://segmentfault.com/a/1190000020293616?utm_source=tag-newest" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020293616?utm_source=tag-newest</a></p><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#linux/mac 下</span><br><span class="line">export GO111MODULE=on</span><br><span class="line">export GOPROXY=https://goproxy.cn,direct</span><br><span class="line"># windows下设置如下环境变量</span><br><span class="line">setx GO111MODULE on</span><br><span class="line">setx GOPROXY https://goproxy.cn,direct</span><br><span class="line"></span><br><span class="line"># go 1.12</span><br><span class="line">export GO111MODULE=on</span><br><span class="line">export GOPROXY=https://goproxy.cn</span><br><span class="line"># 使用如下指令安装</span><br><span class="line"># micro为二进制命令文件</span><br><span class="line">go get -u -v github.com/micro/micro</span><br><span class="line">go get -u -v github.com/micro/go-micro</span><br><span class="line"></span><br><span class="line">#如果没有git请自行安装git</span><br><span class="line">#下载地址</span><br><span class="line">#https://git-scm.com/downloads/</span><br></pre></td></tr></table></figure><h4 id="安装Protoc"><a href="#安装Protoc" class="headerlink" title="安装Protoc"></a>安装Protoc</h4><p>1、访问如下网址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/protocolbuffers/protobuf/releases</span><br></pre></td></tr></table></figure><p>2、下载,不同的版本文件名称不一样，Win选择protoc-xx-win64.zip，Mac选择protoc-xx-osx-x86_64.zip</p><p>3、解压到目标zip文件，添加<code>xxxxx\bin</code>到环境变量<code>path</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Win</span><br><span class="line">e:\dev\protoc-xx-win64\bin</span><br><span class="line">Mac</span><br><span class="line">/xxx/user/protoc-xx-osx-x86_64/bin</span><br></pre></td></tr></table></figure><p>PS：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/micro/protobuf/&#123;proto,protoc-gen-go&#125;</span><br></pre></td></tr></table></figure><p>发现无法用 <code>protoc-gen-go</code> 生成代码。所以我去下载了<code>protobuf</code>。</p><p>这里我是MAC系统所以，下载对应的mac版本 <a href="https://github.com/google/protobuf/releases/download/v3.0.0/protoc-3.0.0-osx-x86_64.zip" target="_blank" rel="noopener">protobuf</a>，有问题可以自行选择各种系统版本。</p><h4 id="安装protoc-gen-micro插件"><a href="#安装protoc-gen-micro插件" class="headerlink" title="安装protoc-gen-micro插件"></a>安装protoc-gen-micro插件</h4><p>这个插件主要作用是通过<code>.proto</code>文件生成适用于<code>go-micro</code>的代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u -v github.com/micro/protoc-gen-micro</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">consul</span><br><span class="line">protoc</span><br><span class="line">micro --version</span><br></pre></td></tr></table></figure><h4 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h4><p>两种方法，一种使用micro自动生成代码，另一种手动创建；注意，手动创建可以自定义目录，自行<code>go mod init</code>，自动生成代码会生成在goPath中的指定目录。可自行选择</p><p>这里使用自动生成代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt;micro new $GOPATH/microapp/hello</span><br><span class="line">Creating service go.micro.srv.hello in $GOPATH\microapp\hello</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">├── main.go</span><br><span class="line">├── plugin.go</span><br><span class="line">├── handler</span><br><span class="line">│   └── hello.go</span><br><span class="line">├── subscriber</span><br><span class="line">│   └── hello.go</span><br><span class="line">├── proto\hello</span><br><span class="line">│   └── hello.proto</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── Makefile</span><br><span class="line">├── README.md</span><br><span class="line">└── go.mod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">download protobuf for micro:</span><br><span class="line"></span><br><span class="line">brew install protobuf</span><br><span class="line">go get -u github.com/golang/protobuf/&#123;proto,protoc-gen-go&#125;</span><br><span class="line">go get -u github.com/micro/protoc-gen-micro</span><br><span class="line"></span><br><span class="line">compile the proto file hello.proto:</span><br><span class="line"></span><br><span class="line">cd $GOPATH\microapp\hello</span><br><span class="line">protoc --proto_path=.:$GOPATH/src --go_out=. --micro_out=. proto/hello/hello.proto</span><br></pre></td></tr></table></figure><h5 id="生成适配proto的golang代码"><a href="#生成适配proto的golang代码" class="headerlink" title="生成适配proto的golang代码"></a>生成适配proto的golang代码</h5><blockquote><p>注意：在win系统下<code>$GOPATH</code>环境变量无效,因此如上脚本将创建微服务失败,因此我们需要对如上脚本进行处理</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#切换到项目目录下</span><br><span class="line">&gt;cd $GOPATH\microapp\hello</span><br><span class="line"></span><br><span class="line"># 根据proto生成文件</span><br><span class="line">&gt;protoc --proto_path=. --go_out=. --micro_out=. proto/hello/hello.proto</span><br></pre></td></tr></table></figure><h5 id="启动应用"><a href="#启动应用" class="headerlink" title="启动应用"></a>启动应用</h5><p><strong>对于现在的新版本已经默认不使用consul了。可以降低micro版本或者插件代码插入consul插件即可使用consul</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#启动consul</span><br><span class="line">&gt;consul agent -dev</span><br><span class="line">#默认mdns启动</span><br><span class="line">&gt;go run main.go </span><br><span class="line">2019/08/19 13:00:46 Transport [http] Listening on [::]:54689</span><br><span class="line">2019/08/19 13:00:46 Broker [http] Connected to [::]:54690</span><br><span class="line">2019/08/19 13:00:46 Registry [mdns] Registering node: go.micro.srv.hello-4851dce2-ab5d-4e4c-801e-44dae5d93f26</span><br><span class="line">2019/08/19 13:00:46 Subscribing go.micro.srv.hello-4851dce2-ab5d-4e4c-801e-44dae5d93f26 to topic: go.micro.srv.hello</span><br><span class="line">2019/08/19 13:00:46 Subscribing go.micro.srv.hello-4851dce2-ab5d-4e4c-801e-44dae5d93f26 to topic: go.micro.srv.hello</span><br><span class="line"></span><br><span class="line">#指定registry只需要添加参数即可，默认使用端口8500</span><br><span class="line">&gt;go run main.go --registry=consul</span><br><span class="line"></span><br><span class="line">## 注意这里没有指定注册consul，默认使用mdns（windows中无法使用mdns，并不是注册中心，使用的广播）</span><br><span class="line">## 了解mdns，自行查看</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在mian.go目录下新建一个插件文件plugins.go</span></span><br><span class="line"><span class="comment">// cat plugins.go 导入consul插件即可</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="string">"github.com/micro/go-plugins/registry/consul"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用的时候或者build带上plugins文件</span></span><br><span class="line"><span class="comment">// go run main.go plugins.go --registry=consul</span></span><br></pre></td></tr></table></figure><p><a href="https://micro.mu/docs/" target="_blank" rel="noopener">官方文档附上链接</a></p><h5 id="查看是否启动"><a href="#查看是否启动" class="headerlink" title="查看是否启动"></a>查看是否启动</h5><p><strong>这里说一个micro需要跟go-micro的版本兼容，不然无法使用micro命令</strong></p><p><strong>当然，如果你后期不适用micro api，micro命令不用也没关系</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#也可以去consul的ui查看，更加直观</span><br><span class="line">&gt;micro list services --registry=consul</span><br><span class="line">go.micro.srv.hello</span><br><span class="line">topic:go.micro.srv.hello</span><br></pre></td></tr></table></figure><h5 id="启动restful-api接口支持支持"><a href="#启动restful-api接口支持支持" class="headerlink" title="启动restful api接口支持支持"></a>启动restful api接口支持支持</h5><p>注意其中的–namespace参数,我们每一个微服务都属于一个命名空间,通过api暴露出来该命名空间后,满足<code>go.micro.srv.*</code>格式的微服务都可以访问。如<code>go.micro.srv.hello</code>可以通过如下格式访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/user/call</span><br><span class="line">&gt;micro api --namespace=go.micro.srv --registry=consul</span><br><span class="line">2019/08/19 13:07:11 Registering API Default Handler at /</span><br><span class="line">2019/08/19 13:07:11 HTTP API Listening on [::]:8080</span><br><span class="line">2019/08/19 13:07:11 Transport [http] Listening on [::]:54934</span><br><span class="line">2019/08/19 13:07:11 Broker [http] Connected to [::]:54935</span><br><span class="line">2019/08/19 13:07:11 Registry [consul] Registering node: go.micro.api-1753185c-b8e1-49c4-aa0f-617f243a8e2a</span><br></pre></td></tr></table></figure><h5 id="验证api接口"><a href="#验证api接口" class="headerlink" title="验证api接口"></a>验证api接口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST -d &quot;&#123;name: nihao&#125;&quot; http://127.0.0.1:8080/user/call -H &quot;Content-Type:application/json&quot;</span><br><span class="line"></span><br><span class="line"># output: hello nihao</span><br></pre></td></tr></table></figure><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; <a href="/passages/Go-Micro系列一/" title="Go-Micro系列一-入门篇">Go-Micro系列一-入门篇</a></p><p>-&gt; <a href="/passages/Go-Micro系列二/" title="Go-Micro系列二-micro介绍以及微服务">Go-Micro系列二-micro介绍以及微服务</a></p><p>-&gt; <a href="/passages/Go-Micro系列三/" title="Go-Micro系列三-">Go-Micro系列三-</a></p><p>-&gt; <a href="/passages/Go-Micro系列四/" title="Go-Micro系列四-">Go-Micro系列四-</a></p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列四</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%97%E5%9B%9B/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%97%E5%9B%9B/</url>
      
        <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><a id="more"></a><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; <a href="/passages/Go-Micro系列一/" title="Go-Micro系列一-入门篇">Go-Micro系列一-入门篇</a></p><p>-&gt; <a href="/passages/Go-Micro系列二/" title="Go-Micro系列二-micro介绍以及微服务">Go-Micro系列二-micro介绍以及微服务</a></p><p>-&gt; <a href="/passages/Go-Micro系列三/" title="Go-Micro系列三-">Go-Micro系列三-</a></p><p>-&gt; <a href="/passages/Go-Micro系列四/" title="Go-Micro系列四-">Go-Micro系列四-</a></p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列三</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%97%E4%B8%89/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%97%E4%B8%89/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro系列三-–-micro使用"><a href="#Go-Micro系列三-–-micro使用" class="headerlink" title="Go-Micro系列三 – micro使用"></a>Go-Micro系列三 – micro使用</h2><p>go_micro框架微服务架构为srv、api</p><a id="more"></a><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; <a href="/passages/Go-Micro系列一/" title="Go-Micro系列一-入门篇">Go-Micro系列一-入门篇</a></p><p>-&gt; <a href="/passages/Go-Micro系列二/" title="Go-Micro系列二-micro介绍以及微服务">Go-Micro系列二-micro介绍以及微服务</a></p><p>-&gt; <a href="/passages/Go-Micro系列三/" title="Go-Micro系列三-">Go-Micro系列三-</a></p><p>-&gt; <a href="/passages/Go-Micro系列四/" title="Go-Micro系列四-">Go-Micro系列四-</a></p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列二</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%97%E4%BA%8C/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%97%E4%BA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro系列二-–-micro介绍以及微服务"><a href="#Go-Micro系列二-–-micro介绍以及微服务" class="headerlink" title="Go-Micro系列二 – micro介绍以及微服务"></a>Go-Micro系列二 – micro介绍以及微服务</h2><h3 id="MicroInstroduct"><a href="#MicroInstroduct" class="headerlink" title="MicroInstroduct"></a>Micro<em>Instroduct</em></h3><p>go-micro是一个go语言的微服务框架，可以大幅度的提升开发效率，并完成一套微服务的架构，其架构借用官方的图</p><p><img src="https://micro.mu/images/runtime01.svg?load" alt="img"></p><p>首先go-micro框架是一套微服务分布式的框架，其拥有以下特性：<a id="more"></a></p><ul><li>服务注册/发现</li><li>负载均衡</li><li>消息解码，并默认支持json以及protobuf</li><li>基于rpc的请求响应</li><li>异步的消息通讯</li><li>最后也是我觉得最牛的一点，接口可插拔，你可以不管用运行环境到底是使用的etcd或者consul来做服务发现，是使用http或rabbitmq做通讯，使用kafka做订阅还是用rabbitmq或者redis，是的，所有的一些都是可以插拔的，只要在运行时加入对应的启动参数，就可以使用对应的插件</li></ul><h3 id="微服务Instroduct"><a href="#微服务Instroduct" class="headerlink" title="微服务Instroduct"></a>微服务<em>Instroduct</em></h3><p><strong>微服务</strong>的概念，可以理解为，将单体应用（所有功能揉在一起的应用）拆分成 N 个小型的应用（服务），每个应用只完成很小的一部分服务，拆分的粒度没有硬性标准，一般按照业务边界进行拆分，如订单服务、用户服务这样的垂直拆分。微服务的理念在传统的单机部署中并未见到明显的优势，但当越来越多的应用被部署到云中的时候，微服务的优势就立刻体现出来了，包括：</p><img src="/passages/Go-Micro系列二/micro1.jpeg"> <p>单应用共用数据库，而微服务每个服务使用不同或相同数据库</p><ul><li>独立部署，每个服务独立去部署，独立运行于不同的进程，使得每个服务可以根据负载做部署数量调整</li><li>服务降级，当系统负载增高，需要对某些关键业务做优先增配时，可以对不关键、低级别的业务做服务降级，临时关闭某些服务来保证关键业务的稳定</li><li>功能单一，技术选型更广，由于微服务的功能相对单一，可以针对不同的微服务采用更适合的编程语言、数据库等，例如做朋友关系、二度好友功能就考虑使用neo4j的图形数据库，底层稳定性要求高的微服务则可以通过Java来开发，并发比较高的微服务则可以考虑使用Go来开发等等</li><li>后期维护隔离，对功能的后期开发升级不会影响整体的应用稳定性</li><li>单独测试，单独开发，可以使每个微服务由不同的团队去开发、去单独测试，增加了整体开发的速度</li><li>复用性，多个不同的应用可以直接复用某个微服务</li></ul><img src="/passages/Go-Micro系列二/micro2.jpeg"><p>单应用不同模块运行在单一进程中，而微服务则每个服务运行于不同的进程</p><p>而go-micro正是这样一个针对微服务开发的框架，其将所有热插拔的插件发布于<a href="https://github.com/micro/go-plugins/" target="_blank" rel="noopener">go-plugins</a>，开发者可以根据需求引用，同时在运行时追加响应的运行参数即可启用插件。</p><p>PS: <a href="https://mp.weixin.qq.com/s?__biz=MzU5MjkwNTAzNA==&amp;mid=2247483742&amp;idx=1&amp;sn=7a32c1ad0e01d577e6b6b669065bca8f&amp;chksm=fe19d77bc96e5e6d6bc23678880b6f5e923f3e5bf25ffe4117479d0b7faad1e632584b8b1b55&amp;scene=126&amp;sessionid=1587439120&amp;key=528b03e392832552fff01d7f6d7bb71cb74141bf62d10a2545ba16e56c33c6a8a9f0cab4370878c147eee86713742c1138f0430325d9e5bd626d662caf29d442242c7a258a90938d671e0fffb9eeac9d&amp;ascene=1&amp;uin=MTk3MjAxMzk4MQ%3D%3D&amp;devicetype=Windows+10&amp;version=62080079&amp;lang=zh_CN&amp;exportkey=AUB7EkRmscCAjEhbBRmp6RM%3D&amp;pass_ticket=zvIYROTKu1pgkZLFPYjFyvHC7STAirxDtBXR4TJMT%2FpbNqhaYU2SQEtJ4TnDY%2BUs" target="_blank" rel="noopener">Micro更新V2公告</a></p><p><a href="https://github.com/micro/go-micro" target="_blank" rel="noopener">Micro项目地址</a></p><p><center>更新时间：2020-04-21<center></center></center></p><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; <a href="/passages/Go-Micro系列一/" title="Go-Micro系列一-入门篇">Go-Micro系列一-入门篇</a></p><p>-&gt; <a href="/passages/Go-Micro系列二/" title="Go-Micro系列二-micro介绍以及微服务">Go-Micro系列二-micro介绍以及微服务</a></p><p>-&gt; <a href="/passages/Go-Micro系列三/" title="Go-Micro系列三-">Go-Micro系列三-</a></p><p>-&gt; <a href="/passages/Go-Micro系列四/" title="Go-Micro系列四-">Go-Micro系列四-</a></p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro相关</title>
      <link href="/passages/Go-Micro%E7%9B%B8%E5%85%B3/"/>
      <url>/passages/Go-Micro%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro的那些"><a href="#Go-Micro的那些" class="headerlink" title="Go-Micro的那些"></a>Go-Micro的那些</h2><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React相关</title>
      <link href="/passages/React%E7%9B%B8%E5%85%B3/"/>
      <url>/passages/React%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<p>TODO</p><a id="more"></a>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Ceph集群部署</title>
      <link href="/passages/Ceph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
      <url>/passages/Ceph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h3 id="CentOS7下安装Ceph供Kubernetes使用"><a href="#CentOS7下安装Ceph供Kubernetes使用" class="headerlink" title="CentOS7下安装Ceph供Kubernetes使用"></a>CentOS7下安装Ceph供Kubernetes使用</h3><h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">系统：CentOS7，一个非系统分区分配给ceph</span><br><span class="line">docker：18.06-ce</span><br><span class="line">kubernetes：1.11.3</span><br><span class="line">ceph：luminous</span><br></pre></td></tr></table></figure><h4 id="Ceph部署准备"><a href="#Ceph部署准备" class="headerlink" title="Ceph部署准备"></a>Ceph部署准备<a id="more"></a></h4><h5 id="节点规划"><a href="#节点规划" class="headerlink" title="节点规划"></a>节点规划</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.105.92 lab1  # master1</span><br><span class="line">192.168.105.93 lab2  # master2</span><br><span class="line">192.168.105.94 lab3  # master3</span><br><span class="line">192.168.105.95 lab4  # node4</span><br><span class="line">192.168.105.96 lab5  # node5</span><br><span class="line">192.168.105.97 lab6  # node6</span><br><span class="line">192.168.105.98 lab7  # node7</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">监控节点：lab1、lab2、lab3</span><br><span class="line">OSD节点：lab4、lab5、lab6、lab7</span><br><span class="line">MDS节点：lab4</span><br></pre></td></tr></table></figure><h5 id="添加yum源"><a href="#添加yum源" class="headerlink" title="添加yum源"></a>添加yum源</h5><p>我们使用阿里云yum源：(CeontOS和epel也是阿里云yum源)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/ceph.repo</span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-luminous/el7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-luminous/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-luminous/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc</span><br></pre></td></tr></table></figure><p>注意：ceph集群中节点都需要添加该yum源</p><h5 id="安装Ceph部署工具"><a href="#安装Ceph部署工具" class="headerlink" title="安装Ceph部署工具"></a>安装Ceph部署工具</h5><p><strong>以下操作在lab1上root用户操作</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装 ceph-deploy</span><br><span class="line">yum -y install ceph-deploy</span><br></pre></td></tr></table></figure><h5 id="安装时间同步工具chrony"><a href="#安装时间同步工具chrony" class="headerlink" title="安装时间同步工具chrony"></a>安装时间同步工具chrony</h5><p>以下操作在所有ceph节点root用户操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 修改/etc/chrony.conf前面的server段为如下</span><br><span class="line">server ntp1.aliyun.com iburst</span><br><span class="line">server ntp2.aliyun.com iburst</span><br><span class="line">server ntp3.aliyun.com iburst</span><br><span class="line">server ntp4.aliyun.com iburst</span><br></pre></td></tr></table></figure><h5 id="安装SSH服务"><a href="#安装SSH服务" class="headerlink" title="安装SSH服务"></a>安装SSH服务</h5><p>默认已正常运行，略</p><h5 id="创建部署-CEPH-的用户"><a href="#创建部署-CEPH-的用户" class="headerlink" title="创建部署 CEPH 的用户"></a>创建部署 CEPH 的用户</h5><p><strong>以下操作在所有ceph节点root用户操作</strong></p><p>ceph-deploy 工具必须以普通用户登录 Ceph 节点，且此用户拥有无密码使用 sudo 的权限，因为它需要在安装软件及配置文件的过程中，不必输入密码。</p><p>较新版的 ceph-deploy 支持用 –username 选项提供可无密码使用 sudo 的用户名（包括 root ，虽然不建议这样做）。使用 ceph-deploy –username {username} 命令时，指定的用户必须能够通过无密码 SSH 连接到 Ceph 节点，因为 ceph-deploy 中途不会提示输入密码。</p><p>建议在集群内的所有 Ceph 节点上给 ceph-deploy 创建一个特定的用户，但不要用 “ceph” 这个名字。全集群统一的用户名可简化操作（非必需），然而你应该避免使用知名用户名，因为黑客们会用它做暴力破解（如 root 、 admin 、 {productname} ）。后续步骤描述了如何创建无 sudo 密码的用户，你要用自己取的名字替换 {username} 。</p><p>注意：<br>从 Infernalis 版起，用户名 “ceph” 保留给了 Ceph 守护进程。如果 Ceph 节点上已经有了 “ceph” 用户，升级前必须先删掉这个用户。</p><p><strong>我们使用用户名ceph-admin</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username="ceph-admin"</span><br><span class="line">useradd $&#123;username&#125; &amp;&amp; echo 'PASSWORD' | passwd $&#123;ceph-admin&#125; --stdinecho "$&#123;username&#125; ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod 0440 /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod a+x /etc/sudoers.d/</span><br></pre></td></tr></table></figure><h5 id="允许无密码-SSH-登录"><a href="#允许无密码-SSH-登录" class="headerlink" title="允许无密码 SSH 登录"></a>允许无密码 SSH 登录</h5><p>以下操作在lab1节点ceph-admin用户操作</p><p>正因为 ceph-deploy 不支持输入密码，你必须在管理节点上生成 SSH 密钥并把其公钥分发到各 Ceph 节点。 ceph-deploy 会尝试给初始 monitors 生成 SSH 密钥对。</p><p>生成 SSH 密钥对，但不要用 sudo 或 root 用户。提示 “Enter passphrase” 时，直接回车，口令即为空：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">su - ceph-admin  # 切换到此用户，因为ceph-deploy也用此用户</span><br><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/ceph-admin/.ssh/id_rsa): </span><br><span class="line">/home/ceph-admin/.ssh/id_rsa already exists.</span><br><span class="line">Overwrite (y/n)? y</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /home/ceph-admin/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /home/ceph-admin/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br></pre></td></tr></table></figure><p>把公钥拷贝到各 Ceph 节点，把下列命令中的 {username} 替换成前面创建部署 Ceph 的用户里的用户名。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username="ceph-admin"</span><br><span class="line">ssh-copy-id $&#123;username&#125;@lab1</span><br><span class="line">ssh-copy-id $&#123;username&#125;@lab2</span><br><span class="line">ssh-copy-id $&#123;username&#125;@lab3</span><br></pre></td></tr></table></figure><p>（推荐做法）修改 ceph-deploy 管理节点上的 ~/.ssh/config 文件，这样 ceph-deploy 就能用你所建的用户名登录 Ceph 节点了，而无需每次执行 ceph-deploy 都要指定 –username {username} 。这样做同时也简化了 ssh 和 scp 的用法。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Host lab1</span><br><span class="line">   Hostname lab1</span><br><span class="line">   User ceph-admin</span><br><span class="line">Host lab2</span><br><span class="line">   Hostname lab2</span><br><span class="line">   User ceph-admin</span><br><span class="line">Host lab3</span><br><span class="line">   Hostname lab3</span><br><span class="line">   User ceph-admin</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Bad owner or permissions on /home/ceph-admin/.ssh/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 需要用chmod 600 ~/.ssh/config解决。</span><br></pre></td></tr></table></figure><h5 id="开放所需端口"><a href="#开放所需端口" class="headerlink" title="开放所需端口"></a>开放所需端口</h5><blockquote><p>以下操作在所有监视器节点<code>root</code>用户操作</p></blockquote><p>Ceph Monitors 之间默认使用 <code>6789</code> 端口通信， OSD 之间默认用 6800:7300 这个范围内的端口通信。</p><p><code>firewall-cmd --zone=public --add-port=6789/tcp --permanent &amp;&amp; firewall-cmd --reload</code></p><h5 id="终端（-TTY-）"><a href="#终端（-TTY-）" class="headerlink" title="终端（ TTY ）"></a>终端（ TTY ）</h5><blockquote><p>以下操作在所有ceph节点root用户操作</p></blockquote><p>在 CentOS 和 RHEL 上执行 ceph-deploy 命令时可能会报错。如果你的 Ceph 节点默认设置了 requiretty ，执行 sudo visudo 禁用它，并找到 Defaults requiretty 选项，把它改为 Defaults:ceph !requiretty 或者直接注释掉，这样 ceph-deploy 就可以用之前创建的用户（创建部署 Ceph 的用户 ）连接了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i -r 's@Defaults(.*)!visiblepw@Defaults:ceph-admin\1!visiblepw@g' /etc/sudoers</span><br></pre></td></tr></table></figure><h5 id="SELINUX"><a href="#SELINUX" class="headerlink" title="SELINUX"></a>SELINUX</h5><blockquote><p>以下操作在所有ceph节点root用户操作</p></blockquote><p>如果原来是开启的，需要重启生效。</p><p>永久关闭 修改/etc/sysconfig/selinux文件设置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux</span><br></pre></td></tr></table></figure><h5 id="整理以上所有ceph节点操作"><a href="#整理以上所有ceph节点操作" class="headerlink" title="整理以上所有ceph节点操作"></a>整理以上所有ceph节点操作</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line"></span><br><span class="line">username="ceph-admin"</span><br><span class="line">useradd $&#123;username&#125; &amp;&amp; echo 'PASSWORD' | passwd $&#123;username&#125; --stdin</span><br><span class="line">echo "$&#123;username&#125; ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod 0440 /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod a+x /etc/sudoers.d/</span><br><span class="line">sed -i -r 's@Defaults(.*)!visiblepw@Defaults:ceph-admin\1!visiblepw@g' /etc/sudoers</span><br><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux</span><br><span class="line">yum -y install ceph</span><br></pre></td></tr></table></figure><h4 id="存储集群部署"><a href="#存储集群部署" class="headerlink" title="存储集群部署"></a>存储集群部署</h4><blockquote><p>以下操作在lab节点<code>ceph-admin</code>用户操作</p></blockquote><p>我们创建一个 Ceph 存储集群，它有一个 Monitor 和两个 OSD 守护进程。一旦集群达到 active + clean 状态，再扩展它：增加第三个 OSD 、增加元数据服务器和两个 Ceph Monitors。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - ceph-admin</span><br><span class="line">mkdir ceph-cluster</span><br></pre></td></tr></table></figure><p>如果在某些地方碰到麻烦，想从头再来，可以用下列命令清除配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy purgedata &#123;ceph-node&#125; [&#123;ceph-node&#125;]</span><br><span class="line">ceph-deploy forgetkeys</span><br><span class="line">rm -rf /etc/ceph/*</span><br><span class="line">rm -rf /var/lib/ceph/*/*</span><br><span class="line">rm -rf /var/log/ceph/*</span><br><span class="line">rm -rf /var/run/ceph/*</span><br></pre></td></tr></table></figure><h5 id="创建集群并准备配置"><a href="#创建集群并准备配置" class="headerlink" title="创建集群并准备配置"></a>创建集群并准备配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ceph-cluster</span><br><span class="line">ceph-deploy new lab1</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ls -l</span><br><span class="line">total 24</span><br><span class="line">-rw-rw-r-- 1 ceph-admin ceph-admin   196 Aug 17 14:31 ceph.conf</span><br><span class="line">-rw-rw-r-- 1 ceph-admin ceph-admin 12759 Aug 17 14:31 ceph-deploy-ceph.log</span><br><span class="line">-rw------- 1 ceph-admin ceph-admin    73 Aug 17 14:31 ceph.mon.keyring</span><br><span class="line">[ceph-admin@lab1 ceph-cluster]$ more ceph.mon.keyring </span><br><span class="line">[mon.]</span><br><span class="line">key = AQC2a3ZbAAAAABAAor15nkYQCXuC681B/Q53og==</span><br><span class="line">caps mon = allow *</span><br><span class="line">[ceph-admin@lab1 ceph-cluster]$ more ceph.conf </span><br><span class="line">[global]</span><br><span class="line">fsid = fb212173-233c-4c5e-a98e-35be9359f8e2</span><br><span class="line">mon_initial_members = lab1</span><br><span class="line">mon_host = 192.168.105.92</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><p>把 Ceph 配置文件里的默认副本数从 3 改成 2 ，这样只有两个 OSD 也可以达到 active + clean 状态。把下面这行加入 [global] 段：</p><p><code>osd pool default size = 2</code></p><p>再把 <code>public network</code> 写入 Ceph 配置文件的<code>[global]</code>段下</p><p><code>public network = 192.168.105.0/24</code></p><p>安装 Ceph</p><p><code>ceph-deploy install lab1 lab4 lab5 --no-adjust-repos</code></p><p>配置monitor(s)并收集所有密钥：</p><p><code>ceph-deploy mon create-initial</code></p><p>完成上述操作后，当前目录里应该会出现这些密钥环：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy mon create-initial</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy mon create-initial</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : create-initial</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x1160f38&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function mon at 0x115c2a8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  keyrings                      : None</span><br><span class="line">[ceph_deploy.mon][DEBUG ] Deploying mon, cluster ceph hosts lab1</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host lab1 ...</span><br><span class="line">[lab1][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab1][DEBUG ] connected to host: lab1 </span><br><span class="line">[lab1][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab1][DEBUG ] detect machine type</span><br><span class="line">[lab1][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO ] distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[lab1][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[lab1][DEBUG ] get remote short hostname</span><br><span class="line">[lab1][DEBUG ] deploying mon to lab1</span><br><span class="line">[lab1][DEBUG ] get remote short hostname</span><br><span class="line">[lab1][DEBUG ] remote hostname: lab1</span><br><span class="line">[lab1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[lab1][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[lab1][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-lab1/done</span><br><span class="line">[lab1][DEBUG ] done path does not exist: /var/lib/ceph/mon/ceph-lab1/done</span><br><span class="line">[lab1][INFO ] creating keyring file: /var/lib/ceph/tmp/ceph-lab1.mon.keyring</span><br><span class="line">[lab1][DEBUG ] create the monitor keyring file</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph-mon --cluster ceph --mkfs -i lab1 --keyring /var/lib/ceph/tmp/ceph-lab1.mon.keyring --setuser 167 --setgroup 167</span><br><span class="line">[lab1][INFO ] unlinking keyring file /var/lib/ceph/tmp/ceph-lab1.mon.keyring</span><br><span class="line">[lab1][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[lab1][DEBUG ] create the init path if it does not exist</span><br><span class="line">[lab1][INFO ] Running command: sudo systemctl enable ceph.target</span><br><span class="line">[lab1][INFO ] Running command: sudo systemctl enable ceph-mon@lab1</span><br><span class="line">[lab1][INFO ] Running command: sudo systemctl start ceph-mon@lab1</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[lab1][DEBUG ] ********************************************************************************</span><br><span class="line">[lab1][DEBUG ] status for monitor: mon.lab1</span><br><span class="line">[lab1][DEBUG ] &#123;</span><br><span class="line">[lab1][DEBUG ]   "election_epoch": 3, </span><br><span class="line">[lab1][DEBUG ]   "extra_probe_peers": [], </span><br><span class="line">[lab1][DEBUG ]   "feature_map": &#123;</span><br><span class="line">[lab1][DEBUG ]     "mon": &#123;</span><br><span class="line">[lab1][DEBUG ]       "group": &#123;</span><br><span class="line">[lab1][DEBUG ]         "features": "0x3ffddff8eea4fffb", </span><br><span class="line">[lab1][DEBUG ]         "num": 1, </span><br><span class="line">[lab1][DEBUG ]         "release": "luminous"</span><br><span class="line">[lab1][DEBUG ]       &#125;</span><br><span class="line">[lab1][DEBUG ]     &#125;</span><br><span class="line">[lab1][DEBUG ]   &#125;, </span><br><span class="line">[lab1][DEBUG ]   "features": &#123;</span><br><span class="line">[lab1][DEBUG ]     "quorum_con": "4611087853745930235", </span><br><span class="line">[lab1][DEBUG ]     "quorum_mon": [</span><br><span class="line">[lab1][DEBUG ]       "kraken", </span><br><span class="line">[lab1][DEBUG ]       "luminous"</span><br><span class="line">[lab1][DEBUG ]     ], </span><br><span class="line">[lab1][DEBUG ]     "required_con": "153140804152475648", </span><br><span class="line">[lab1][DEBUG ]     "required_mon": [</span><br><span class="line">[lab1][DEBUG ]       "kraken", </span><br><span class="line">[lab1][DEBUG ]       "luminous"</span><br><span class="line">[lab1][DEBUG ]     ]</span><br><span class="line">[lab1][DEBUG ]   &#125;, </span><br><span class="line">[lab1][DEBUG ]   "monmap": &#123;</span><br><span class="line">[lab1][DEBUG ]     "created": "2018-08-17 14:46:18.770540", </span><br><span class="line">[lab1][DEBUG ]     "epoch": 1, </span><br><span class="line">[lab1][DEBUG ]     "features": &#123;</span><br><span class="line">[lab1][DEBUG ]       "optional": [], </span><br><span class="line">[lab1][DEBUG ]       "persistent": [</span><br><span class="line">[lab1][DEBUG ]         "kraken", </span><br><span class="line">[lab1][DEBUG ]         "luminous"</span><br><span class="line">[lab1][DEBUG ]       ]</span><br><span class="line">[lab1][DEBUG ]     &#125;, </span><br><span class="line">[lab1][DEBUG ]     "fsid": "fb212173-233c-4c5e-a98e-35be9359f8e2", </span><br><span class="line">[lab1][DEBUG ]     "modified": "2018-08-17 14:46:18.770540", </span><br><span class="line">[lab1][DEBUG ]     "mons": [</span><br><span class="line">[lab1][DEBUG ]       &#123;</span><br><span class="line">[lab1][DEBUG ]         "addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab1][DEBUG ]         "name": "lab1", </span><br><span class="line">[lab1][DEBUG ]         "public_addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab1][DEBUG ]         "rank": 0</span><br><span class="line">[lab1][DEBUG ]       &#125;</span><br><span class="line">[lab1][DEBUG ]     ]</span><br><span class="line">[lab1][DEBUG ]   &#125;, </span><br><span class="line">[lab1][DEBUG ]   "name": "lab1", </span><br><span class="line">[lab1][DEBUG ]   "outside_quorum": [], </span><br><span class="line">[lab1][DEBUG ]   "quorum": [</span><br><span class="line">[lab1][DEBUG ]     0</span><br><span class="line">[lab1][DEBUG ]   ], </span><br><span class="line">[lab1][DEBUG ]   "rank": 0, </span><br><span class="line">[lab1][DEBUG ]   "state": "leader", </span><br><span class="line">[lab1][DEBUG ]   "sync_provider": []</span><br><span class="line">[lab1][DEBUG ] &#125;</span><br><span class="line">[lab1][DEBUG ] ********************************************************************************</span><br><span class="line">[lab1][INFO ] monitor: mon.lab1 is running</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO ] processing monitor mon.lab1</span><br><span class="line">[lab1][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab1][DEBUG ] connected to host: lab1 </span><br><span class="line">[lab1][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab1][DEBUG ] detect machine type</span><br><span class="line">[lab1][DEBUG ] find the location of an executable</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO ] mon.lab1 monitor has reached quorum!</span><br><span class="line">[ceph_deploy.mon][INFO ] all initial monitors are running and have formed quorum</span><br><span class="line">[ceph_deploy.mon][INFO ] Running gatherkeys...</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing keys in temp directory /tmp/tmpfUkCWD</span><br><span class="line">[lab1][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab1][DEBUG ] connected to host: lab1 </span><br><span class="line">[lab1][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab1][DEBUG ] detect machine type</span><br><span class="line">[lab1][DEBUG ] get remote short hostname</span><br><span class="line">[lab1][DEBUG ] fetch remote file</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --admin-daemon=/var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.admin</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.admin osd allow * mds allow * mon allow * mgr allow *</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-mds</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-mds mon allow profile bootstrap-mds</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-mgr</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-mgr mon allow profile bootstrap-mgr</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-osd</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-osd mon allow profile bootstrap-osd</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-rgw</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-rgw mon allow profile bootstrap-rgw</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.client.admin.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-mds.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-mgr.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] keyring 'ceph.mon.keyring' already exists</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-osd.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-rgw.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Destroy temp directory /tmp/tmpfUkCWD</span><br></pre></td></tr></table></figure><p>用 ceph-deploy 把配置文件和 admin 密钥拷贝到管理节点和 Ceph 节点，这样你每次执行 Ceph 命令行时就无需指定 <code>monitor</code> 地址和<code>ceph.client.admin.keyring</code>了。</p><p><code>ceph-deploy admin lab1 lab4 lab5</code></p><blockquote><p>注意<br>ceph-deploy 和本地管理主机（ admin-node ）通信时，必须通过主机名可达。必要时可修改 /etc/hosts ，加入管理主机的名字。</p></blockquote><p>确保你对 ceph.client.admin.keyring 有正确的操作权限。</p><p><code>sudo chmod +r /etc/ceph/ceph.client.admin.keyring</code></p><p>安装mrg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mgr create lab1</span><br><span class="line">ceph-deploy mgr create lab2</span><br><span class="line">ceph-deploy mgr create lab3</span><br></pre></td></tr></table></figure><p>检查集群的健康状况。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph health</span><br><span class="line">HEALTH_OK</span><br></pre></td></tr></table></figure><h5 id="增加OSD"><a href="#增加OSD" class="headerlink" title="增加OSD"></a>增加OSD</h5><p>列举磁盘并擦净</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy disk list lab4</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy disk list lab4</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  debug                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : list</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x20d97e8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  host                          : ['lab4']</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function disk at 0x20ca7d0&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[lab4][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab4][DEBUG ] connected to host: lab4 </span><br><span class="line">[lab4][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab4][DEBUG ] detect machine type</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo fdisk -l</span><br><span class="line">[lab4][INFO ] Disk /dev/sda: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/cl-root: 97.8 GB, 97840529408 bytes, 191094784 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/cl-swap: 8455 MB, 8455716864 bytes, 16515072 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43_tmeta: 12 MB, 12582912 bytes, 24576 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43_tdata: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43-tpool: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-brick_1f4ce4f4bfb224aa385f35516236af43: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy disk zap lab4 /dev/sdb</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy disk zap lab4 /dev/sdb</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  debug                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : zap</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0xd447e8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  host                          : lab4</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function disk at 0xd357d0&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  disk                          : ['/dev/sdb']</span><br><span class="line">[ceph_deploy.osd][DEBUG ] zapping /dev/sdb on lab4</span><br><span class="line">[lab4][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab4][DEBUG ] connected to host: lab4 </span><br><span class="line">[lab4][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab4][DEBUG ] detect machine type</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.osd][INFO ] Distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[lab4][DEBUG ] zeroing last few blocks of device</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo /usr/sbin/ceph-volume lvm zap /dev/sdb</span><br><span class="line">[lab4][DEBUG ] --&gt; Zapping: /dev/sdb</span><br><span class="line">[lab4][DEBUG ] Running command: /usr/sbin/cryptsetup status /dev/mapper/</span><br><span class="line">[lab4][DEBUG ]  stdout: /dev/mapper/ is inactive.</span><br><span class="line">[lab4][DEBUG ] Running command: wipefs --all /dev/sdb</span><br><span class="line">[lab4][DEBUG ] Running command: dd if=/dev/zero of=/dev/sdb bs=1M count=10</span><br><span class="line">[lab4][DEBUG ] --&gt; Zapping successful for: /dev/sdb</span><br></pre></td></tr></table></figure><p>同理，lab5的sdb也一样。</p><p>创建pv、vg、lv，略。</p><p>创建 OSD</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy osd create lab4 --fs-type btrfs --data vg1/lvol0     </span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy osd create lab4 --fs-type btrfs --data vg1/lvol0</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  bluestore                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x26d4908&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  fs_type                       : btrfs</span><br><span class="line">[ceph_deploy.cli][INFO ]  block_wal                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  journal                       : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : create</span><br><span class="line">[ceph_deploy.cli][INFO ]  host                          : lab4</span><br><span class="line">[ceph_deploy.cli][INFO ]  filestore                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function osd at 0x26c4758&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  zap_disk                      : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  data                          : vg1/lvol0</span><br><span class="line">[ceph_deploy.cli][INFO ]  block_db                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  dmcrypt                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  dmcrypt_key_dir               : /etc/ceph/dmcrypt-keys</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  debug                         : False</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Creating OSD on cluster ceph with data device vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab4][DEBUG ] connected to host: lab4 </span><br><span class="line">[lab4][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab4][DEBUG ] detect machine type</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.osd][INFO ] Distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Deploying osd to lab4</span><br><span class="line">[lab4][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo /usr/sbin/ceph-volume --cluster ceph lvm create --bluestore --data vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph-authtool --gen-print-key</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring -i - osd new 7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph-authtool --gen-print-key</span><br><span class="line">[lab4][DEBUG ] Running command: mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-1</span><br><span class="line">[lab4][DEBUG ] Running command: chown -h ceph:ceph /dev/vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /dev/dm-2</span><br><span class="line">[lab4][DEBUG ] Running command: ln -s /dev/vg1/lvol0 /var/lib/ceph/osd/ceph-1/block</span><br><span class="line">[lab4][DEBUG ] Running command: ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring mon getmap -o /var/lib/ceph/osd/ceph-1/activate.monmap</span><br><span class="line">[lab4][DEBUG ]  stderr: got monmap epoch 1</span><br><span class="line">[lab4][DEBUG ] Running command: ceph-authtool /var/lib/ceph/osd/ceph-1/keyring --create-keyring --name osd.1 --add-key AQAmjHZbiiGUChAAVCWdPZqHms99mLgSZ7M+fQ==</span><br><span class="line">[lab4][DEBUG ]  stdout: creating /var/lib/ceph/osd/ceph-1/keyring</span><br><span class="line">[lab4][DEBUG ] added entity osd.1 auth auth(auid = 18446744073709551615 key=AQAmjHZbiiGUChAAVCWdPZqHms99mLgSZ7M+fQ== with 0 caps)</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-1/keyring</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-1/</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph-osd --cluster ceph --osd-objectstore bluestore --mkfs -i 1 --monmap /var/lib/ceph/osd/ceph-1/activate.monmap --keyfile - --osd-data /var/lib/ceph/osd/ceph-1/ --osd-uuid 7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62 --setuser ceph --setgroup ceph</span><br><span class="line">[lab4][DEBUG ] --&gt; ceph-volume lvm prepare successful for: vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] Running command: ceph-bluestore-tool --cluster=ceph prime-osd-dir --dev /dev/vg1/lvol0 --path /var/lib/ceph/osd/ceph-1</span><br><span class="line">[lab4][DEBUG ] Running command: ln -snf /dev/vg1/lvol0 /var/lib/ceph/osd/ceph-1/block</span><br><span class="line">[lab4][DEBUG ] Running command: chown -h ceph:ceph /var/lib/ceph/osd/ceph-1/block</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /dev/dm-2</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-1</span><br><span class="line">[lab4][DEBUG ] Running command: systemctl enable ceph-volume@lvm-1-7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62</span><br><span class="line">[lab4][DEBUG ]  stderr: Created symlink from /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-1-7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62.service to /usr/lib/systemd/system/ceph-volume@.service.</span><br><span class="line">[lab4][DEBUG ] Running command: systemctl start ceph-osd@1</span><br><span class="line">[lab4][DEBUG ] --&gt; ceph-volume lvm activate successful for osd ID: 1</span><br><span class="line">[lab4][DEBUG ] --&gt; ceph-volume lvm create successful for: vg1/lvol0</span><br><span class="line">[lab4][INFO ] checking OSD status...</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo /bin/ceph --cluster=ceph osd stat --format=json</span><br><span class="line">[lab4][WARNIN] there is 1 OSD down</span><br><span class="line">[lab4][WARNIN] there is 1 OSD out</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Host lab4 is now ready for osd use.</span><br></pre></td></tr></table></figure><p><code>ceph-deploy osd create lab5 --fs-type btrfs --data vg1/lvol0</code></p><h4 id="扩展集群"><a href="#扩展集群" class="headerlink" title="扩展集群"></a>扩展集群</h4><p>一个基本的集群启动并开始运行后，下一步就是扩展集群。在 lab6、lab7 各上添加一个 OSD 守护进程和一个元数据服务器。然后分别在 lab2 和 lab3 上添加 <code>Ceph Monitor</code>，以形成 Monitors 的法定人数。</p><p>添加 MONITORS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mon add lab2</span><br><span class="line">ceph-deploy mon add lab3</span><br></pre></td></tr></table></figure><p>过程：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy mon add lab3</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy mon add lab3</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : add</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x29f0f38&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  mon                           : ['lab3']</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function mon at 0x29ec2a8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  address                       : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.mon][INFO ] ensuring configuration of new mon host: lab3</span><br><span class="line">[ceph_deploy.admin][DEBUG ] Pushing admin keys and conf to lab3</span><br><span class="line">[lab3][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab3][DEBUG ] connected to host: lab3 </span><br><span class="line">[lab3][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab3][DEBUG ] detect machine type</span><br><span class="line">[lab3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_deploy.mon][DEBUG ] Adding mon to cluster ceph, host lab3</span><br><span class="line">[ceph_deploy.mon][DEBUG ] using mon address by resolving host: 192.168.105.94</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host lab3 ...</span><br><span class="line">[lab3][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab3][DEBUG ] connected to host: lab3 </span><br><span class="line">[lab3][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab3][DEBUG ] detect machine type</span><br><span class="line">[lab3][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO ] distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[lab3][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[lab3][DEBUG ] get remote short hostname</span><br><span class="line">[lab3][DEBUG ] adding mon to lab3</span><br><span class="line">[lab3][DEBUG ] get remote short hostname</span><br><span class="line">[lab3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[lab3][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[lab3][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-lab3/done</span><br><span class="line">[lab3][DEBUG ] done path does not exist: /var/lib/ceph/mon/ceph-lab3/done</span><br><span class="line">[lab3][INFO ] creating keyring file: /var/lib/ceph/tmp/ceph-lab3.mon.keyring</span><br><span class="line">[lab3][DEBUG ] create the monitor keyring file</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph --cluster ceph mon getmap -o /var/lib/ceph/tmp/ceph.lab3.monmap</span><br><span class="line">[lab3][WARNIN] got monmap epoch 2</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph-mon --cluster ceph --mkfs -i lab3 --monmap /var/lib/ceph/tmp/ceph.lab3.monmap --keyring /var/lib/ceph/tmp/ceph-lab3.mon.keyring --setuser 167 --setgroup 167</span><br><span class="line">[lab3][INFO ] unlinking keyring file /var/lib/ceph/tmp/ceph-lab3.mon.keyring</span><br><span class="line">[lab3][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[lab3][DEBUG ] create the init path if it does not exist</span><br><span class="line">[lab3][INFO ] Running command: sudo systemctl enable ceph.target</span><br><span class="line">[lab3][INFO ] Running command: sudo systemctl enable ceph-mon@lab3</span><br><span class="line">[lab3][WARNIN] Created symlink from /etc/systemd/system/ceph-mon.target.wants/ceph-mon@lab3.service to /usr/lib/systemd/system/ceph-mon@.service.</span><br><span class="line">[lab3][INFO ] Running command: sudo systemctl start ceph-mon@lab3</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab3.asok mon_status</span><br><span class="line">[lab3][WARNIN] lab3 is not defined in `mon initial members`</span><br><span class="line">[lab3][WARNIN] monitor lab3 does not exist in monmap</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab3.asok mon_status</span><br><span class="line">[lab3][DEBUG ] ********************************************************************************</span><br><span class="line">[lab3][DEBUG ] status for monitor: mon.lab3</span><br><span class="line">[lab3][DEBUG ] &#123;</span><br><span class="line">[lab3][DEBUG ]   "election_epoch": 0, </span><br><span class="line">[lab3][DEBUG ]   "extra_probe_peers": [</span><br><span class="line">[lab3][DEBUG ]     "192.168.105.93:6789/0"</span><br><span class="line">[lab3][DEBUG ]   ], </span><br><span class="line">[lab3][DEBUG ]   "feature_map": &#123;</span><br><span class="line">[lab3][DEBUG ]     "mon": &#123;</span><br><span class="line">[lab3][DEBUG ]       "group": &#123;</span><br><span class="line">[lab3][DEBUG ]         "features": "0x3ffddff8eea4fffb", </span><br><span class="line">[lab3][DEBUG ]         "num": 1, </span><br><span class="line">[lab3][DEBUG ]         "release": "luminous"</span><br><span class="line">[lab3][DEBUG ]       &#125;</span><br><span class="line">[lab3][DEBUG ]     &#125;</span><br><span class="line">[lab3][DEBUG ]   &#125;, </span><br><span class="line">[lab3][DEBUG ]   "features": &#123;</span><br><span class="line">[lab3][DEBUG ]     "quorum_con": "0", </span><br><span class="line">[lab3][DEBUG ]     "quorum_mon": [], </span><br><span class="line">[lab3][DEBUG ]     "required_con": "144115188077969408", </span><br><span class="line">[lab3][DEBUG ]     "required_mon": [</span><br><span class="line">[lab3][DEBUG ]       "kraken", </span><br><span class="line">[lab3][DEBUG ]       "luminous"</span><br><span class="line">[lab3][DEBUG ]     ]</span><br><span class="line">[lab3][DEBUG ]   &#125;, </span><br><span class="line">[lab3][DEBUG ]   "monmap": &#123;</span><br><span class="line">[lab3][DEBUG ]     "created": "2018-08-17 16:38:21.075805", </span><br><span class="line">[lab3][DEBUG ]     "epoch": 3, </span><br><span class="line">[lab3][DEBUG ]     "features": &#123;</span><br><span class="line">[lab3][DEBUG ]       "optional": [], </span><br><span class="line">[lab3][DEBUG ]       "persistent": [</span><br><span class="line">[lab3][DEBUG ]         "kraken", </span><br><span class="line">[lab3][DEBUG ]         "luminous"</span><br><span class="line">[lab3][DEBUG ]       ]</span><br><span class="line">[lab3][DEBUG ]     &#125;, </span><br><span class="line">[lab3][DEBUG ]     "fsid": "4395328d-17fc-4039-96d0-1d3241a4cafa", </span><br><span class="line">[lab3][DEBUG ]     "modified": "2018-08-17 17:58:23.179585", </span><br><span class="line">[lab3][DEBUG ]     "mons": [</span><br><span class="line">[lab3][DEBUG ]       &#123;</span><br><span class="line">[lab3][DEBUG ]         "addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "name": "lab1", </span><br><span class="line">[lab3][DEBUG ]         "public_addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "rank": 0</span><br><span class="line">[lab3][DEBUG ]       &#125;, </span><br><span class="line">[lab3][DEBUG ]       &#123;</span><br><span class="line">[lab3][DEBUG ]         "addr": "192.168.105.93:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "name": "lab2", </span><br><span class="line">[lab3][DEBUG ]         "public_addr": "192.168.105.93:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "rank": 1</span><br><span class="line">[lab3][DEBUG ]       &#125;, </span><br><span class="line">[lab3][DEBUG ]       &#123;</span><br><span class="line">[lab3][DEBUG ]         "addr": "192.168.105.94:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "name": "lab3", </span><br><span class="line">[lab3][DEBUG ]         "public_addr": "192.168.105.94:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "rank": 2</span><br><span class="line">[lab3][DEBUG ]       &#125;</span><br><span class="line">[lab3][DEBUG ]     ]</span><br><span class="line">[lab3][DEBUG ]   &#125;, </span><br><span class="line">[lab3][DEBUG ]   "name": "lab3", </span><br><span class="line">[lab3][DEBUG ]   "outside_quorum": [</span><br><span class="line">[lab3][DEBUG ]     "lab3"</span><br><span class="line">[lab3][DEBUG ]   ], </span><br><span class="line">[lab3][DEBUG ]   "quorum": [], </span><br><span class="line">[lab3][DEBUG ]   "rank": 2, </span><br><span class="line">[lab3][DEBUG ]   "state": "probing", </span><br><span class="line">[lab3][DEBUG ]   "sync_provider": []</span><br><span class="line">[lab3][DEBUG ] &#125;</span><br><span class="line">[lab3][DEBUG ] ********************************************************************************</span><br><span class="line">[lab3][INFO ] monitor: mon.lab3 is running</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph quorum_status --format json-pretty</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "election_epoch": 12,</span><br><span class="line">    "quorum": [</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        2</span><br><span class="line">    ],</span><br><span class="line">    "quorum_names": [</span><br><span class="line">        "lab1",</span><br><span class="line">        "lab2",</span><br><span class="line">        "lab3"</span><br><span class="line">    ],</span><br><span class="line">    "quorum_leader_name": "lab1",</span><br><span class="line">    "monmap": &#123;</span><br><span class="line">        "epoch": 3,</span><br><span class="line">        "fsid": "4395328d-17fc-4039-96d0-1d3241a4cafa",</span><br><span class="line">        "modified": "2018-08-17 17:58:23.179585",</span><br><span class="line">        "created": "2018-08-17 16:38:21.075805",</span><br><span class="line">        "features": &#123;</span><br><span class="line">            "persistent": [</span><br><span class="line">                "kraken",</span><br><span class="line">                "luminous"</span><br><span class="line">            ],</span><br><span class="line">            "optional": []</span><br><span class="line">        &#125;,</span><br><span class="line">        "mons": [</span><br><span class="line">            &#123;</span><br><span class="line">                "rank": 0,</span><br><span class="line">                "name": "lab1",</span><br><span class="line">                "addr": "192.168.105.92:6789/0",</span><br><span class="line">                "public_addr": "192.168.105.92:6789/0"</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "rank": 1,</span><br><span class="line">                "name": "lab2",</span><br><span class="line">                "addr": "192.168.105.93:6789/0",</span><br><span class="line">                "public_addr": "192.168.105.93:6789/0"</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "rank": 2,</span><br><span class="line">                "name": "lab3",</span><br><span class="line">                "addr": "192.168.105.94:6789/0",</span><br><span class="line">                "public_addr": "192.168.105.94:6789/0"</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>添加元数据服务器</em></p><p>至少需要一个元数据服务器才能使用 CephFS ，执行下列命令创建元数据服务器：</p><p><code>ceph-deploy mds create lab4</code></p><p>到此，可以创建RBD和cephFS的ceph集群搭建完成。</p><h4 id="Ceph使用技巧"><a href="#Ceph使用技巧" class="headerlink" title="Ceph使用技巧"></a>Ceph使用技巧</h4><p><em>推送配置文件</em></p><p>只推送配置文件</p><p><code>ceph-deploy --overwrite-conf config push lab1 lab2</code></p><p>推送配置文件和client.admin key</p><p><code>ceph-deploy admin lab1 lab2</code></p><p><em>查看状态的常用命令</em></p><p>集群状态</p><p><code>ceph -s</code></p><p>查看正在操作的动作</p><p><code>ceph -w</code></p><p>查看已经创建的磁盘</p><p><code>rbd ls -l</code></p><p>查看ceph集群 </p><p><code>ceph osd tree</code></p><p>查看ceph授权信息</p><p><code>ceph auth get client.admin</code></p><p>移除monitor节点</p><p><code>ceph-deploy mon destroy lab1</code></p><p>详细列出集群每块磁盘的使用情况</p><p><code>ceph osd df</code></p><p>检查 MDS 状态:</p><p><code>ceph mds stat</code></p><p><em>开启Dashbord管理界面</em></p><p>创建管理域密钥<br><code>ceph auth get-or-create mgr.lab1 mon &#39;allow profile mgr&#39; osd &#39;allow *&#39; mds &#39;allow *&#39;</code><br>或：<br><code>ceph auth get-key client.admin | base64</code></p><p><em>开启 ceph-mgr 管理域</em></p><p><code>ceph-mgr -i master</code></p><p>开启dashboard</p><p><code>ceph mgr module enable dashboard</code></p><p>绑定开启 dashboard 模块的 ceph-mgr 节点的 ip 地址</p><p><code>ceph config-key set mgr/dashboard/master/server_addr 192.168.105.92</code></p><p>dashboard 默认运行在7000端口</p><p><em>RBD常用命令</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">创建pool</span><br><span class="line">若少于5个OSD， 设置pg_num为128。</span><br><span class="line">5~10个OSD，设置pg_num为512。</span><br><span class="line">10~50个OSD，设置pg_num为4096。</span><br><span class="line"></span><br><span class="line">超过50个OSD，可以参考pgcalc计算。</span><br><span class="line">ceph osd pool create rbd 128 128 </span><br><span class="line">rbd pool init rbd</span><br><span class="line"></span><br><span class="line">删除pool</span><br><span class="line">ceph osd pool rm rbd rbd –yes-i-really-really-mean-it </span><br><span class="line">## ceph.conf 添加 </span><br><span class="line">## mon_allow_pool_delete = true</span><br><span class="line"></span><br><span class="line">手动创建一个rbd磁盘</span><br><span class="line">rbd create --image-feature layering [rbd-name] -s 10240</span><br></pre></td></tr></table></figure><p><em>OSD常用命令</em></p><p>清除磁盘上的逻辑卷</p><p><code>ceph-volume lvm zap --destroy /dev/vdc</code>   # 本机操作<br><code>ceph-deploy disk zap lab4 /dev/sdb</code>           # 远程操作</p><p>创建osd</p><p><code>ceph-deploy osd create lab4 --fs-type btrfs --data vg1/lvol0</code></p><p>删除osd节点的node4</p><p>查看节点node4上的所有osd，比如osd.9 osd.10：</p><p><code>ceph osd tree</code>                                                        #查看目前cluster状态</p><p>把node4上的所欲osd踢出集群：（node1节点上执行）</p><p><code>ceph osd out osd.9</code><br><code>ceph osd out osd.10</code></p><p>让node4上的所有osd停止工作：（node4上执行）</p><p><code>service ceph stop osd.9</code><br><code>service ceph stop osd.10</code></p><p>查看node4上osd的状态是否为down，权重为0</p><p><code>ceph osd tree</code></p><p>移除node4上的所有osd：</p><p><code>ceph osd crush remove osd.9</code><br><code>ceph osd crush remove osd.10</code></p><p>删除节点node4：</p><p><code>ceph osd crush remove ceph-node4</code></p><p>替换一个失效的磁盘驱动</p><p>首先<code>ceph osd tree</code> 查看down掉的osd，将因盘问题down掉的osd及相关key删除</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph osd out osd.0                         # 都在node1节点下执行</span><br><span class="line">ceph osd crush rm osd.0</span><br><span class="line">ceph auth del osd.0</span><br><span class="line">ceph osd rm osd.0</span><br></pre></td></tr></table></figure><p>zap新磁盘 清理新磁盘：<br><code>ceph-deploy disk zap node1 /dev/sdb</code><br>在磁盘上新建一个osd，ceph会把它添加为osd:0：<br><code>ceph-deploy --overwrite-conf osd create node1 /dev/sdb</code></p><h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p>[1] <a href="http://docs.ceph.com/docs/master/start/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/start/</a><br>[2] <a href="http://docs.ceph.org.cn/start/" target="_blank" rel="noopener">http://docs.ceph.org.cn/start/</a><br>[3] <a href="http://docs.ceph.org.cn/install/manual-deployment/" target="_blank" rel="noopener">http://docs.ceph.org.cn/install/manual-deployment/</a><br>[4] <a href="http://www.cnblogs.com/freedom314/p/9247602.html" target="_blank" rel="noopener">http://www.cnblogs.com/freedom314/p/9247602.html</a><br>[5] <a href="http://docs.ceph.org.cn/rados/operations/monitoring/" target="_blank" rel="noopener">http://docs.ceph.org.cn/rados/operations/monitoring/</a></p>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph单节点部署</title>
      <link href="/passages/Ceph%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2/"/>
      <url>/passages/Ceph%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h2 id="Ceph集群单节点安装"><a href="#Ceph集群单节点安装" class="headerlink" title="Ceph集群单节点安装"></a>Ceph集群单节点安装</h2><p>创建虚拟机（正常步骤）</p><p>添加ceph.repo，安装ceph-deploy<a id="more"></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/yum.repos.d/ceph.repo</span><br><span class="line"></span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=http://hk.ceph.com/rpm-jewel/el7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=http://hk.ceph.com/rpm-jewel/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=http://hk.ceph.com/rpm-jewel/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装ceph-deploy</span><br><span class="line">yum clean all</span><br><span class="line">yum install ceph-deploy</span><br></pre></td></tr></table></figure><p>创建集群，并安装ceph相关软件包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建目录</span><br><span class="line">mkdir -p  /root/cluster &amp; cd /root/cluster &amp; rm -f /root/cluster/*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 进入目录，创建集群</span><br><span class="line">cd /root/cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装依赖</span><br><span class="line">yum install -y yum-utils &amp;&amp; yum-config-manager --add-repo  https://dl.fedoraproject.org/pub/epel/7/x86_64/ &amp;&amp; yum install --nogpgcheck -y  epel-release &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &amp;&amp; rm -f  /etc/yum.repos.d/dl.fedoraproject.org*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 这一步非常重要，如果跳过这一步，直接进行ceph的安装，可能会报如下的错误：</span><br><span class="line">Error: Package: 1:ceph-common-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: libbabeltrace.so.1()(64bit)</span><br><span class="line">Error: Package: 1:librados2-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 1:librgw2-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: libfcgi.so.0()(64bit)</span><br><span class="line">Error: Package: 1:librbd1-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 1:ceph-common-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: libbabeltrace-ctf.so.1()(64bit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装ceph软件包</span><br><span class="line">yum install ceph ceph-radosgw</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 虚机准备工作</span><br><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span> swapoff -a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 确认ceph软件包版本</span><br><span class="line">ceph-deploy --version</span><br><span class="line">ceph -v</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 开始部署</span><br><span class="line">ceph-deploy new $HOSTNAME</span><br></pre></td></tr></table></figure><p>修改配置文件，配置初始化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> osd的pool副本数size为1，可设置</span><br><span class="line">echo osd pool default size = 1 &gt;&gt; ceph.conf   </span><br><span class="line">echo osd crush chooseleaf type = 0 &gt;&gt; ceph.conf</span><br><span class="line">echo osd max object name len = 256 &gt;&gt; ceph.conf</span><br><span class="line">echo osd journal size = 128 &gt;&gt; ceph.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> ceph.conf配置</span><br><span class="line">cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = 90602ee8-b900-44f2-b218-9dd4fc8273af</span><br><span class="line">mon_initial_members = ceph-node</span><br><span class="line">mon_host = 10.100.2.36</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line">osd pool default size = 1    </span><br><span class="line">osd crush chooseleaf type = 0</span><br><span class="line">osd max object name len = 256</span><br><span class="line">osd journal size = 128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> monitor初始化</span><br><span class="line">ceph-deploy mon create-initial</span><br></pre></td></tr></table></figure><p>添加osd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 创建文件夹，添加osd</span><br><span class="line">mkdir -p /var/run/ceph/</span><br><span class="line">chown ceph:ceph /var/run/ceph/</span><br><span class="line">mkdir -p /osd &amp; rm -rf /osd/*</span><br><span class="line">chown ceph:ceph /osd</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy osd prepare $HOSTNAME:/osd</span><br><span class="line">ceph-deploy osd activate $HOSTNAME:/osd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 验证ceph状态是否健康</span><br><span class="line">ceph -s</span><br></pre></td></tr></table></figure><h2 id="Ceph开启CephFS挂载"><a href="#Ceph开启CephFS挂载" class="headerlink" title="Ceph开启CephFS挂载"></a>Ceph开启CephFS挂载</h2><p>安装前确定集群状态是正常的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ceph -s</span><br><span class="line">​    cluster 817696dd-7d7d-459d-8ce3-314326f2c056</span><br><span class="line">​     health HEALTH_OK</span><br><span class="line">​     monmap e1: 1 mons at &#123;ceph-node=10.100.2.36:6789/0&#125;</span><br><span class="line">​            election epoch 3, quorum 0 ceph-node</span><br><span class="line">​      fsmap e5: 1/1/1 up &#123;0=ceph-node=up:active&#125;</span><br><span class="line">​     osdmap e10: 1 osds: 1 up, 1 in</span><br><span class="line">​            flags sortbitwise,require_jewel_osds</span><br><span class="line">​      pgmap v10806: 192 pgs, 3 pools, 2068 bytes data, 20 objects</span><br><span class="line">​            1681 MB used, 49493 MB / 51175 MB avail</span><br><span class="line">​                 192 active+clean</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> cephfs需要启用mds元数据数据服务，检查元数据服务是否创建</span><br><span class="line">ceph mds stat</span><br><span class="line"><span class="meta">#</span> 如下则为正常</span><br><span class="line">ceph mds stat</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 正常显示为 e5: 1/1/1 up &#123;0=ceph-node=up:active&#125;</span><br><span class="line"><span class="meta">#</span> 全为0的话，则添加mds节点</span><br><span class="line">ceph-deploy mds create ceph-node</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 创建cephfs文件系统</span><br><span class="line">ceph osd pool create cephfs_data 64</span><br><span class="line">ceph osd pool create cephfs_metadata 64</span><br><span class="line">ceph fs new cephfs cephfs_metadata cephfs_data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 挂载，这里默认使用admin用户；可自己创建用户挂载</span><br><span class="line">mkdir /mnt/cephfs</span><br><span class="line">mount -t ceph 10.100.2.36:6789:/ /aseit-data/cephfs -o name=admin,secret=AQBM82RdI6TAExAAoix7KkMBtSPDSh6ZG69iHg==</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> secret在/etc/ceph/ceph.client.admin.keyring的base64</span><br><span class="line"><span class="meta">#</span> 可创建client用户来使用</span><br><span class="line"><span class="meta">#</span> 验证</span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>## 安装以及挂载cephfs时出现的问题：</span><br><span class="line"><span class="meta">#</span> 1.mount error 5 = Input/output error</span><br><span class="line"><span class="meta">#</span> 2. mount error 22 = Invalid argument</span><br><span class="line"><span class="meta">#</span> 第一个，首先先查mds服务是正常，不存在则添加，即ceph-deploy mds create ceph-node</span><br><span class="line"><span class="meta">#</span> 第二个，密钥不正确，检查密钥，即-o name=admin,secret=AQBM82RdI6TAExAAoix7KkMBtSPDSh6ZG69iHg==挂载时使用</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 下面为卸载ceph操作</span><br><span class="line">ps aux|grep ceph |awk '&#123;print $2&#125;'|xargs kill -9</span><br><span class="line">ps -ef|grep ceph</span><br><span class="line">ceph-deploy uninstall  [&#123;ceph-node&#125;]                                  # 卸载所有ceph程序</span><br><span class="line">ceph-deploy purge   [[ceph-node&#125; [&#123;ceph-node&#125;]                        #删除ceph相关的包</span><br><span class="line">ceph-deploy purgedata &#123;ceph-node&#125; [&#123;ceph-node&#125;]                       # 删除ceph相关的包</span><br><span class="line">ceph-deploy forgetkeys</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录:"></a>附录:</h2><h3 id="单节点安装ceph脚本"><a href="#单节点安装ceph脚本" class="headerlink" title="单节点安装ceph脚本"></a>单节点安装ceph脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>echo 10.100.2.36 $HOSTNAME &gt;&gt;  /etc/hosts</span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line"><span class="meta">#</span>rm -rf /etc/yum.repos.d/*.repo</span><br><span class="line"><span class="meta">#</span>wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"><span class="meta">#</span>wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br><span class="line"><span class="meta">#</span>sed -i '/aliyuncs/d' /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line"><span class="meta">#</span>sed -i 's/$releasever/7/g' /etc/yum.repos.d/CentOS-Base.repo</span><br><span class="line"><span class="meta">#</span>sed -i '/aliyuncs/d' /etc/yum.repos.d/epel.repo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>echo "</span><br><span class="line"><span class="meta">#</span>[ceph]</span><br><span class="line"><span class="meta">#</span>name=ceph</span><br><span class="line"><span class="meta">#</span>baseurl=https://mirrors.aliyun.com/ceph/rpm-jewel/el7/x86_64/</span><br><span class="line"><span class="meta">#</span>gpgcheck=0</span><br><span class="line"><span class="meta">#</span>[ceph-noarch]</span><br><span class="line"><span class="meta">#</span>name=cephnoarch</span><br><span class="line"><span class="meta">#</span>baseurl=https://mirrors.aliyun.com/ceph/rpm-jewel/el7/noarch/</span><br><span class="line"><span class="meta">#</span>gpgcheck=0</span><br><span class="line"><span class="meta">#</span>" &gt; /etc/yum.repos.d/ceph.repo</span><br><span class="line"></span><br><span class="line">yum install -y yum-utils &amp;&amp; yum-config-manager --add-repo https://dl.fedoraproject.org/pub/epel/7/x86_64/ &amp;&amp; yum install --nogpgcheck -y epel-release &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &amp;&amp; rm -f /etc/yum.repos.d/dl.fedoraproject.org*</span><br><span class="line"></span><br><span class="line">yum install ceph ceph-radosgw ceph-deploy -y</span><br><span class="line"></span><br><span class="line">mkdir -p  /root/cluster &amp; cd /root/cluster &amp; rm -f /root/cluster/*</span><br><span class="line">cd /root/cluster</span><br><span class="line"></span><br><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span>swapoff -a</span><br><span class="line"></span><br><span class="line">ceph-deploy new $HOSTNAME</span><br><span class="line"></span><br><span class="line">echo osd pool default size = 1 &gt;&gt; ceph.conf</span><br><span class="line">echo osd crush chooseleaf type = 0 &gt;&gt; ceph.conf</span><br><span class="line">echo osd max object name len = 256 &gt;&gt; ceph.conf</span><br><span class="line">echo osd journal size = 128 &gt;&gt; ceph.conf</span><br><span class="line"></span><br><span class="line">mkdir -p /var/run/ceph/</span><br><span class="line">chown ceph:ceph /var/run/ceph/</span><br><span class="line">mkdir -p /osd &amp; rm -rf /osd/*</span><br><span class="line">chown ceph:ceph /osd</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy osd prepare $HOSTNAME:/osd</span><br><span class="line">ceph-deploy osd activate  $HOSTNAME:/osd</span><br><span class="line"></span><br><span class="line">ceph -s</span><br></pre></td></tr></table></figure><h3 id="ceph重装清理脚本"><a href="#ceph重装清理脚本" class="headerlink" title="ceph重装清理脚本"></a>ceph重装清理脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">\#!/bin/bash</span><br><span class="line"></span><br><span class="line">ps aux|grep ceph |awk '&#123;print $2&#125;'|xargs kill -9</span><br><span class="line">ps -ef|grep ceph</span><br><span class="line"></span><br><span class="line">umount /var/lib/ceph/osd/*</span><br><span class="line">rm -rf /var/lib/ceph/osd/*</span><br><span class="line">rm -rf /var/lib/ceph/mon/*</span><br><span class="line">rm -rf /var/lib/ceph/mds/*</span><br><span class="line">rm -rf /var/lib/ceph/bootstrap-mds/*</span><br><span class="line">rm -rf /var/lib/ceph/bootstrap-osd/*</span><br><span class="line">rm -rf /var/lib/ceph/bootstrap-mon/*</span><br><span class="line">rm -rf /var/lib/ceph/tmp/*</span><br><span class="line">rm -rf /etc/ceph/*</span><br><span class="line">rm -rf /var/run/ceph/*</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ceph相关概念</title>
      <link href="/passages/Ceph%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/"/>
      <url>/passages/Ceph%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Ceph是一个统一的分布式存储系统，最早起源于Sage就读博士期间的工作（最早的成果于2004年发表），随后贡献给开源社区。其设计初衷是提供较好的性能、可靠性和可扩展性。在经过多年的发展之后，目前已得到众多云计算厂商的支持并被广泛应用。RedHat及OpenStack都可与Ceph整合以支持虚拟机镜像的后端存储。  </p><p>Ceph的优势可以概括为以下四个方面：<a id="more"></a></p><ol><li>高性能 <ul><li>摒弃了传统的集中式存储元数据寻址的方案，采用CRUSH算法，数据分布均衡，并行度高</li><li>考虑了容灾域的隔离，能够实现各类负载的副本放置规则，例如跨机房、机架感知等</li><li>能够支持上千个存储节点的规模。支持TB到PB级的数据  </li></ul></li><li>高可用  <ul><li>副本数可以灵活控制</li><li>支持故障域分隔，数据强一致性</li><li>多种故障场景自动进行修复自愈</li><li>没有单点故障，自动管理  </li></ul></li><li>高扩展性<ul><li>去中心化</li><li>扩展灵活</li><li>随着节点增加，性能线性增长</li></ul></li><li>特性丰富<ul><li>支持三种存储接口：<font color="red">对象存储</font>，<font color="red">块设备存储</font>，<font color="red">文件存储</font></li><li>支持自定义接口，支持多种语言驱动  </li></ul></li></ol><h2 id="Ceph基本结构"><a href="#Ceph基本结构" class="headerlink" title="Ceph基本结构"></a>Ceph基本结构</h2><p>Ceph的基本组成结构如下图：  </p><img src="/passages/Ceph相关概念/images/Ceph架构图.png"><p>Ceph的底层是<strong>RADOS</strong>，RADOS本身也是分布式存储系统，Ceph所有的存储功能都是基于RADOS实现的。RADOS采用C++开发，所提供的原生Librados API包括C和C++两种。Ceph的上层应用调用本机上的librados API，再由后者通过socket与RADOS集群中的其他节点通信并完成各种操作。  </p><p>RADOS GateWay、RBD其作用是在librados库的基础上提供抽象层次更高、更便于应用或客户端使用的上层接口。其中RADOS GW是一个提供与Amazon S3和Swift兼容的RESTful API的gateway，以供相应的对象存储应用开发使用。RBD则提供了一个标准的块设备接口，常用于在虚拟化的场景下为虚拟机创建volume。目前，RedHat已经将RBD驱动集成在KVM/QEMU中，以提供虚拟机访问性能。这两种方式目前在云计算中应用的比较多。  </p><p>CephFS则提供了POSIX接口，用户可直接通过客户端挂载使用。它是内核态的程序，所有无需调用用户空间的librados库。它通过内核中的net模块来与RADOS进行交互。  </p><h2 id="Ceph基本组件及概念"><a href="#Ceph基本组件及概念" class="headerlink" title="Ceph基本组件及概念"></a>Ceph基本组件及概念</h2><h3 id="Ceph基本组件"><a href="#Ceph基本组件" class="headerlink" title="Ceph基本组件"></a>Ceph基本组件</h3><img src="/passages/Ceph相关概念/images/Ceph基本组件.png">  <p>如上图所示，Ceph主要有三个基本进程：  </p><ul><li>OSD  </li></ul><p>用于集群中所有数据与对象的存储。处理集群数据的复制、恢复、回填、再均衡。并向其他osd守护进程发送心跳，然后向Mon提供一些监控信息。  </p><p>当Ceph存储集群设定的数据有两个副本时（一共存两份），则至少需要两个OSD守护进程，即两个OSD节点，集群才能到达active+clean状态。  </p><ul><li>MDS(可选)  </li></ul><p>为Ceph文件系统提供元数据计算、缓存与同步。在Ceph中，元数据也是存储在osd节点中的，mds类似于元数据的代理缓存服务器。MDS进程并不是必须的进程，只有需要使用CephFS时，才需要配置MDS节点。  </p><ul><li>Monitor  </li></ul><p>监控整个集群的状态，维护集群的cluster MAP二进制表，保证集群数据的一致性。ClusterMAP描述了对象块存储的物理位置，以及一个将设备聚合到物理位置的桶列表。  </p><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul><li>Object  </li></ul><p>Ceph最底层的存储单元，每个Object包含元数据和原始数据。  </p><ul><li>PG  </li></ul><p>全称Placement Groups，是一个逻辑的概念，一个PG包含多个OSD。引入PG这一层其实是为了更好的分配数据和定位数据。  </p><ul><li>RADOS  </li></ul><p>全称Reliable Autonomic Distributed Object Store，是Ceph集群的精华，用户实现数据分配、Failover等集群操作。  </p><ul><li>Librados  </li></ul><p>Librados是RADOS提供的库。因为RADOS很难直接访问，因此上层的RBD、RGW和CephFS都是通过Librados访问的。  </p><ul><li>CRUSH  </li></ul><p>是Ceph使用的数据分布算法，让数据分配到预期的地方。  </p><ul><li>RBD  </li></ul><p>全称RADOS block device，是Ceph对外提供的块设备服务。  </p><ul><li>RGW  </li></ul><p>全称RADOS GateWay，是Ceph对外提供的对象存储服务，接口与S3、Swift兼容。  </p><ul><li>CephFS  </li></ul><p>全称Ceph File System，是Ceph对外提供的文件系统服务。  </p><h2 id="Ceph-核心组件"><a href="#Ceph-核心组件" class="headerlink" title="Ceph 核心组件"></a>Ceph 核心组件</h2><p>Ceph的核心组件包括Ceph OSD、Ceph Monitor和Ceph MSD。</p><h3 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h3><p>首先介绍下Ceph数据的存储过程，如下图：  </p><img src="/passages/Ceph相关概念/images/Ceph数据存储过程.png">  <p>无论使用哪种存储方式（对象、块、文件系统），存储的数据都会被切分成对象（Objects）。Objects size大小可以由管理员调整，通常为2M或者4M。每个对象都会有一个唯一的OID，有ino和ono生成：ino是文件的File ID，用于全局唯一标示每一个文件，而ono是分片的编号。例如，一个文件FileID是A，它被切成两个对象，一个编号为0，另一个编号为1，那么这两个对象的OID则为A0和A1。OID的好处是可以唯一标示每一个不同的对象，并且存储了对象与文件的从属关系。由于Ceph的所有数据都虚拟成了整齐划一的对象，所以在读写时效率都会比较高。  </p><p>但是对象并不会直接存储进OSD中，因为对象的size很小，在一个大规模的集群中可能有几百到几千万个对象。如此多的对象光是遍历寻址速度都会很缓慢；而且如果将对象直接通过某种固定映射的哈希算法映射到osd上，当这个osd损坏时，对象无法自动迁移到其他osd上面（因为映射函数不允许）。为了解决这些问题，Ceph引入了归置组的概念，即PG。  </p><p>PG是一个逻辑概念，Linux系统中可以直接看到对象，但是无法直接看到PG。它在数据寻址时类似于数据库中的索引：每个对象都会固定映射进一个PG中，所以当我们寻找一个对象时，只需要先找到对象所属的PG，然后遍历这个PG就可以了，无需遍历所有对象。而且在数据迁移时，也是一PG作为基本单位进行迁移，Ceph不会直接操作对象。  </p><p>对象是如何映射进PG的？首先使用静态hash函数对OID做hash取出特征码，用特征码与PG的数量取模，得到的序号就是PGID。由于这种设计，PG的数量多寡直接决定了数据分布的均匀性，所以合理设置的PG数量可以很好地提升Ceph集群的性能并使数据均匀分布。  </p><p>最后PG会根据管理员设置的副本数量进行复制，然后通过CRUSH算法存储到不同的OSD节点上（其实是把PG中的所有对象存储到节点上），第一个osd节点即为主节点，其余均为从节点。  </p><p>下面是一段Ceph中的伪代码，简要描述了Ceph的数据存储流程：  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">locator = object_name</span><br><span class="line">obj_hash = hash(locator)</span><br><span class="line">pg = obj_hash % num_pg</span><br><span class="line">osds_for_pg = crush(pg) <span class="comment"># return a list of osds</span></span><br><span class="line">primary = osds_for_pg[<span class="number">0</span>]</span><br><span class="line">replicas = osds_for_og[<span class="number">1</span>:]</span><br></pre></td></tr></table></figure><img src="/passages/Ceph相关概念/images/OSDs.png">  <p>上图中更好地诠释了Ceph数据流的存储过程，数据无论是从三个接口哪一种写入的，最终都要切分成对象存储到底层的RADOS中。逻辑上通过算法先映射到PG上，最终存储进OSD节点里。图中除了之前介绍过的概念之外多了个pools的概念。  </p><img src="/passages/Ceph相关概念/images/pools.png">  <p>Pool是管理员自定义的命名空间，像其他的命名空间一样，用来隔离对象与PG。我们在调用API存储，即使用对象存储时，需要指定对象要存储进哪一个POOL中。除了隔离数据，我们也可以分别对不同的POOL设置不同的优化策略，比如副本数、数据清洗次数、数据块及对象大小等。  </p><p>OSD是强一致性的分布式存储，它的读写流程如下图：  </p><img src="/passages/Ceph相关概念/images/Ceph读写流程.png">  <p>Ceph的读写操作采用主从模型，客户端要读写数据时，只能向对象所对应的的主OSD节点发起请求。主节点在接受写请求时，会同步的向从OSD中写入数据。当所有的OSD节点都写入完成后，主节点才会向客户端报告写入完成的信息，因此保证了主从节点数据的高度一致性。而读取的时候，客户端也只会向主OSD节点发送读请求，并不会有类似数据库中读写分离的情况出现，这也是处于强一致性的考虑。由于所有写操作都要交给主OSD节点来处理，所以在数据量很大的时候，性能可能会比较慢，为了克服这个问题以及让Ceph能支持事务，每个OSD节点都包含一个journal文件，稍后介绍。  </p><p>数据流向的介绍就先到这，现在回到正题：OSD进程。在Ceph中，每一个OSD进程都可以称作是一个OSD节点，也就是说，每台存储服务器可靠包含了众多的OSD节点，每个OSD节点监听不同的端口，类似于在同一台服务器上跑多个MySQL或Redis。每个OSD节点可以设置一个目录作为实际存储区域，也可以是一个分区、一整块硬盘。如下图，当前这台机器上跑了两个OSD进程，每个OSD监听4个端口，分别用于接收客户请求、传输数据、发送心跳、同步数据等操作。  </p><img src="/passages/Ceph相关概念/images/OSD进程.png">  <p>如上图所示，osd节点默认监听tcp的6800到6803端口，如果同一台服务器上有多个OSD节点，则依次往后排序。  </p><p>在生成环境中OSD最少可能都有上百个，所以每个OSD都有一个全局的编号，类似OSD0、OSD1、OSD2等等，序号根据OSD诞生的顺序排列，并且是全局唯一的。存储了相同PG的OSD节点除了想Mon节点发送心跳外，还会互相发送心跳信息以检测PG数据副本是否正常。  </p><p>之前在介绍数据流向时说过，每个OSD节点都包含一个journal文件，如下图：  </p><img src="/passages/Ceph相关概念/images/journal.png">  <p>默认大小为5G，也就是说创建一个OSD节点，还没使用就要被journal占用5G的空间。这个值是可以调整的，具体大小要依据OSD的总大小而定。  </p><p>Journal的作用类似于MySQL innodb引擎中的事务日志系统。当有突发的大量写入操作时，Ceph可以先把一些零散的，随机的IO请求保存到缓存中进行合并，然后在同一向内核发起IO请求。这样做效率会比较高，但是一旦OSD节点崩溃，缓存中的数据就会丢失，所以数据在还未写进硬盘时，都会记录到journal中，当OSD崩溃后重新启东市，会自动尝试从journal恢复因崩溃而丢失的缓存数据。因此journal的IO是非常密集的，而且由于一个数据IO两次，很大程度上也损耗了硬件的IO性能，所以通常在生产环境中，使用ssd来单独存储journal文件以提高Ceph的读写性能。  </p><h3 id="monitor节点"><a href="#monitor节点" class="headerlink" title="monitor节点"></a>monitor节点</h3><p>Mon节点监控着整个Ceph集群的状态信息，监听于tcp的6789端口。每个Ceph集群中至少要有一个Mon节点，官方推荐每个集群至少部署三台。Mon节点中保存了最新的版本集群数据分布图（Cluster Map）的主副本。客户端在使用时，需要挂载Mon节点的6789端口，下载最新的Cluster Map，通过CRUSH算法获得集群中各OSD的IP地址，然后再与OSD节点直接建立连接来传输数据。所以对于Ceph来说，并不需要有集中式的主节点用于计算与寻址，客户端分摊了这部分工作。而且客户端也可以直接和OSD通信，省去了中间代理服务器的额外开销。  </p><p>Mon节点之间使用Paxos算法来保持各节点Cluster Map的一致性；各Mon节点的功能总体是一样的，相互间的关系可以被简单理解为主备关系。如果主Mon节点损坏，其他Mon存活节点超过半数时，集群还可以正常运行。当故障Mon节点恢复时，会主动从其他Mon节点拉取最新的Cluster Map。  </p><p>Mon节点并不会主动轮询各个OSD的当前状态，相反，OSD只有在一些特殊情况下才会上报自己的信息，平常只会简单的发送心跳。特殊情况包括：1、新的OSD被加入集群；2、某个OSD发现自身或其他OSD发生异常。Mon节点在收到这些上报信息时，则会更新Cluster Map信息并加以扩缩。  </p><p>Cluster Map信息是以异步且lazy的形式扩散的。Monitor并不会在每一次Cluster Map版本更新后都将新版广播至全体OSD，而是有OSD向自己上报信息时，将更新恢复给对方。类似的，各个OSD也是在和其他OSD通信时，如果发现对方的OSD中持有的Cluster Map版本较低，则把自己更新的版本发送给对方。  </p><img src="/passages/Ceph相关概念/images/推荐架构.png">  <p>这里的Ceph除了管理网段外，设了两个网段，一个用于客户端读写传输数据，另一个用于各OSD节点之间同步数据和发送心跳信息等。这样做的好处是可以分担网卡的IO压力。否则在数据清洗时，客户端的读写速度会变得极为缓慢。  </p><h3 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h3><p>Mds是Ceph集群中的元数据服务器，而通常情况它都不是必须的，因为只有在使用CephFS的时候才需要它，而目前云计算中用到的更广泛的是另外两种存储方式。  </p><p>Mds虽然是元数据服务器，但是它不负责存储元数据，元数据也是被切成对象存在各个OSD节点中，如下图：  </p>  <p>在创建CephFS时，要至少创建两个Pool，一个用于存储数据，另一个用于存放元数据。Mds只是负责接收用户的元数据查询请求，然后从OSD中把数据取出来映射进自己的内存中供客户访问。所以Mds其实类似一个代理缓存服务器，替OSD分担了用户的访问压力，如下图：  </p><img src="/passages/Ceph相关概念/images/Mds.png">  <h2 id="Ceph-各概念之间的关系"><a href="#Ceph-各概念之间的关系" class="headerlink" title="Ceph 各概念之间的关系"></a>Ceph 各概念之间的关系</h2><h3 id="存储数据与Object的关系"><a href="#存储数据与Object的关系" class="headerlink" title="存储数据与Object的关系"></a>存储数据与Object的关系</h3><p>当用户要将数据存储到Ceph集群时，存储数据都会被分割成多个Object，每个Object都有一个Object ID，每个Object的大小是可以设置的，默认为4MB。Object可以看做是Ceph存储的最小存储单元。 </p><h4 id="Object-与-PG"><a href="#Object-与-PG" class="headerlink" title="Object 与 PG"></a>Object 与 PG</h4><p>由于Object的数量很多，所以Ceph引入了PG的概念用于管理Object，每个Object最后都会通过CRUSH计算映射到某个PG中，一个PG可以包含多个Object。</p><p>Ceph条带化之后，将获得N个带有唯一OID（即Object的id）。Object id是进行线性映射生成的，即有file的元数据、Ceph条带化产生的Object的序号连缀而成。此时object需要映射到PG中，该映射包括两部分：  </p><ol><li>有Ceph集群指定的静态Hash函数计算Object的OID，获取到其Hash值</li><li>将该Hash值与mask进行操作，从而获得PG ID  </li></ol><p>根据RADOS的设计，假定集群中设定的PG总数为M（M一般为2的整数幂），则mask的值为M-1.由此，Hash值计算之后，进行按位与操作是想从所有PG中近似均匀地随机选择。基于该原理以及概率论的相关原理，当用于数据量庞大的Object以及PG时，获得到的PG ID是近似均匀的，  </p><h4 id="PG-与-OSD"><a href="#PG-与-OSD" class="headerlink" title="PG 与 OSD"></a>PG 与 OSD</h4><p>由PG映射到数据存储的实际单元OSD中，该映射是由CRUSH算法来确定的，将PG ID作为该算法的输入，获得到包含N个OSD的集合，集合的第一个OSD被作为主OSD，其余的OSD则依次作为从OSD。N为该PG所在POOL下的副本数量，在生产环境中N一般为3；OSD集合中的OSD将共同存储和维护该PG下的Object。需要注意的是，CRUSH算法的结果不是绝对不变的，而是受其他因素的影响。其影响因素主要有以下两个：  </p><ol><li>当前系统状态，也就是Cluster Map（集群映射）。当系统中的OSD状态、数量发生变化时，Cluster Map可能发生变化，而这种变化将会影响到PG和OSD之间的映射</li><li>存储策略配置。这里的策略主要与安全相关。利用策略配置，系统管理员可以指定承载同一个PG的3个OSD分别位于数据中心的不同服务器乃至机架上，从而进一步改善存储的可靠性。  </li></ol><p>因此，只有在Cluster Map和存储策略都不发生变化的时候，PG和OSD之间的映射关系才是固定不变的。在实际使用中，策略已经配置通常不会改变。而系统状态的改变或者是因为设备损坏，或者是因为存储集群规模扩大。好在Ceph本身提供了对于这种变化的自动化支持，因而即便PG和OSD之间的映射关系发生了变化，并不会对应用造成困扰。事实上，Ceph正是需要有目的的利用这种动态映射关系。正是利用了CRUSH的动态特性，Ceph才可以将一个PG根据需要动态迁移到不同的OSD组合上，从而自动化地实现高可靠性、数据分布re-blancing等特性。  </p><p>之所以在此次映射中使用CRUSH算法，而不是其他Hash算法，原因之一是CRUSH具有上述可配置特性，可以根据管理员的配置参数决定OSD的物理位置映射策略；另一方面是因为CRUSH具有特殊的“稳定性”，也就是当系统中加入新的OSD导致系统规模增大时，大部分PG与OSD之间的映射关系不会发生改变，只是少部分PG的映射关系会发生变化并引发数据迁移。这种可配置性和稳定性都不是普通Hash算法所能提供的。因此，CRUSH算法的设计也是Ceph的核心内容之一。  </p><h4 id="PG-与-PGP"><a href="#PG-与-PGP" class="headerlink" title="PG 与 PGP"></a>PG 与 PGP</h4><p>PG是用来存放Object的，PGP相当于是PG存放OSD的一种排列组合。举个例子，比如有3个OSD，OSD.1、OSD.2和OSD.3，副本数是2，如果PGP的数目为1，那么PG存放的OSD组合就只有一种可能：[OSD.1，OSD.2]，那么所有的PG主从副本分别存放到OSD.1和OSD.2；如果PGP设为2，那么OSD组合就有两种，[OSD.1，OSD.2]和[OSD.1，OSD.3]，是不是很像数学中的排列组合，PGP就是代表这个意思。一般来说应该将PG和PGP的数量设置为相等。接下来我们来通过一组实验来进一步说明：  </p><p>先创建一个名为testpool包含6个PG和6个PGP的存储池：  </p><blockquote><p>ceph osd pool create testpool 6 6</p></blockquote><p>通过写数据后我们查看下PG的分布情况，使用以下命令：      </p><blockquote><p>ceph pg dump pgs | grep ^1 | awk ‘{print $1,$2,$15}’  </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumped pgs in format plain</span><br><span class="line">1.1 75 [3,6,0]</span><br><span class="line">1.0 83 [7,0,6]</span><br><span class="line">1.3 144 [4,1,2]</span><br><span class="line">1.2 146 [7,4,1]</span><br><span class="line">1.5 86 [4,6,3]</span><br><span class="line">1.4 80 [3,0,4]</span><br></pre></td></tr></table></figure><p>第1列为PG的ID，第2列为该PG所存储的对象数目，第3列为该PG所在的OSD。  </p><p>我们扩大PG再看看：  </p><blockquote><p>ceph osd pool set testpool pg_num 12  </p></blockquote><p>再用上面的命令查询分布情况：  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.1 37 [3,6,0]</span><br><span class="line">1.9 38 [3,6,0]</span><br><span class="line">1.0 41 [7,0,6]</span><br><span class="line">1.8 42 [7,0,6]</span><br><span class="line">1.3 48 [4,1,2]</span><br><span class="line">1.b 48 [4,1,2]</span><br><span class="line">1.7 48 [4,1,2]</span><br><span class="line">1.2 48 [7,4,1]</span><br><span class="line">1.6 49 [7,4,1]</span><br><span class="line">1.a 49 [7,4,1]</span><br><span class="line">1.5 86 [4,6,3]</span><br><span class="line">1.4 80 [3,0,4]</span><br></pre></td></tr></table></figure><p>可以看到PG的数量增加到12个了，PG1.1的对象数量本来是75个，现在是37个，可以看到它把对象数分给新增的PG1.9了，刚好是38，加起来为75，而且可以看到PG1.1和PG1.9的OSD盘是一样的。而且可以看到OSD盘的组合还是那6种。  </p><p>我们增加PGP的数量来看下，使用命令：  </p><blockquote><p>ceph osd pool set testpool pgp_num 12  </p></blockquote><p>在看下：  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.a 49 [1,2,6]</span><br><span class="line">1.b 48 [1,6,2]</span><br><span class="line">1.1 37 [3,6,0]</span><br><span class="line">1.0 41 [7,0,6]</span><br><span class="line">1.3 48 [4,1,2]</span><br><span class="line">1.2 48 [7,4,1]</span><br><span class="line">1.5 86 [4,6,3]</span><br><span class="line">1.4 80 [3,0,4]</span><br><span class="line">1.7 48 [1,6,0]</span><br><span class="line">1.6 49 [3,6,7]</span><br><span class="line">1.9 38 [1,4,2]</span><br><span class="line">1.8 42 [1,2,3]</span><br></pre></td></tr></table></figure><p>再看PG1.1和PG1.9，可以看到PG1.9不在[3,6,0]上，而是在[1,4,2]上，该组合时新增加的。可以知道增加PGP_NUM其实是增加了OSD盘的组合。  </p><p>通过上述实验可以得出：  </p><ol><li>PG是指定存储池存储对象的目录有多少个，PGP是存储池PG的OSD分布组合个数</li><li>PG的增加会引起PG内的数据进行分裂，分裂到相同的OSD上新生成的PG中</li><li>PGP的增加会引起部分PG的分布变化，但是不会引起PG内对象的变动</li></ol><h4 id="PG-与-Pool"><a href="#PG-与-Pool" class="headerlink" title="PG 与 Pool"></a>PG 与 Pool</h4><p>Pool也是一个逻辑存储概念，我们创建存储池pool的时候，都需要指定PG和PGP的数量，逻辑上来说PG是属于某个存储池的，就像Object是属于某个PG的一样。  </p><p>下图表明了存储数据、Object、PG、Pool、OSD、存储磁盘的关系：  </p><img src="/passages/Ceph相关概念/images/关系图.png"><h3 id="Ceph-条带化"><a href="#Ceph-条带化" class="headerlink" title="Ceph 条带化"></a>Ceph 条带化</h3><p>众所周知，存储设备具有吞吐量限制，它影响读写性能和可扩展性能。所以存储系统通常都支持条带化以增加存储系统的吞吐量并提升性能，数据条带化最常见的方式是做RAID。与Ceph的条带化最相似的是RAID 0或者是“带区卷”。Ceph条带化提供了类似RAID 0的吞吐量，N路RAID镜像的可靠性已经更快速的恢复能力。  </p><p>在磁盘阵列中，数据是以条带（stripe）的方式贯穿在磁盘阵列所有硬盘中的。这种数据的分配方式可以弥补OS读取数据量跟不上的不足。  </p><p>1.将条带单元（stripe unit）从阵列的第一个硬盘到最后一个硬盘收集起来，就可以称为条带（stripe）。有的时候，条带单元也被称为交错深度。在光纤技术中，一个条带单元被叫做段。  </p><p>2.数据在阵列中的硬盘上是以条带的形式分布的，条带化是指数据在阵列中所有硬盘中的存储过程。文件中的数据被分割成小块的数据段在阵列中的硬盘顺序上的存储，这个最小数据块就叫做条带单元。  </p><p>决定Ceph条带化数据的3个因素：  </p><ul><li><p>对象大小：处于分布式集群中的对象拥有一个最大可配置的尺寸（例如，2MB，4MB等），对象大小应该足够大以适应大量的条带单元。</p></li><li><p>条带宽度：条带有一个可以配置的单元大小，Ceph Client端将数据写入对象，分成相同大小的条带单元，除了最后一个条带之外；每个条带宽度，应该是对象大小的一部分，这样使得一个对象可以包含多个条带单元。</p></li><li><p>条带总量：Ceph客户端写入一系列的条带单元到一系列的对象，这就决定了条带的总量，这些对象被称为对象集。当Ceph客户端写入的对象集合中的最后一个对象之后，它将会返回到对象集合中的第一个对象处。  </p></li></ul><h2 id="CRUSH-算法"><a href="#CRUSH-算法" class="headerlink" title="CRUSH 算法"></a>CRUSH 算法</h2><h3 id="数据分布算法挑战"><a href="#数据分布算法挑战" class="headerlink" title="数据分布算法挑战"></a>数据分布算法挑战</h3><ul><li><strong>数据分布和负载均衡</strong>：<ul><li>a.数据分布均衡，使数据能均匀地分布到各个节点上</li><li>b.负载均衡，使数据访问读写操作的负载在各个节点和磁盘的负载均衡</li></ul></li><li><strong>灵活应对集群伸缩</strong>：<ul><li>a.系统可以方便的增加或者删除节点设备，并且对节点失效进行处理</li><li>b.增加或者删除节点设备后，能自动实现数据的均衡，并且尽可能少的迁移数据</li></ul></li><li><strong>支持大规模集群</strong>：<ul><li>要求数据分布算法维护的元数据相对较小，并且计算量不能太大。随着集群规模的增加，数据分布算法的开销相对较小</li></ul></li></ul><h3 id="CRUSH-算法说明"><a href="#CRUSH-算法说明" class="headerlink" title="CRUSH 算法说明"></a>CRUSH 算法说明</h3><ul><li>CRUSH（Controlled Replication Under Scalable Hashing）是一种基于伪随机控制数据分布、复制的算法。Ceph是为大规模分布式存储系统（PB级的数据和成百上千台存储设备）而设计的，在大规模的存储系统里，必须考虑数据的平衡分布和负载（提高资源利用率）、最大化系统的性能以及系统的扩展和硬件容错等。CRUSH就是为解决上述问题而设计的。在Ceph集群里，CRUSH只需要一个简洁而层次清晰的设备描述，包括存储集群和副本放置策略，就可以有效地把数据对象映射到存储设备上，且这个过程是完全分布式的，在集群系统中的任何一方都可以独立计算任何对象的位置；另外，大型系统存储结构是动态变化的（存储节点的扩展或者缩容、硬件故障等），CRUSH能够处理存储设备的变更（添加或删除），并最小化由于存储设备的变更而导致的数据迁移。   </li><li>PG到OSD的映射过程的算法叫做CRUSH算法。</li><li>CRUSH算法是一个伪随机的过程，它可以从所有的OSD中，随机性选择一个OSD集合，但是同一个PG每次随机选择的结果是不变的，也就是映射的OSD集合是固定的。</li></ul><h3 id="CRUSH-基本原理"><a href="#CRUSH-基本原理" class="headerlink" title="CRUSH 基本原理"></a>CRUSH 基本原理</h3><p><strong>CRUSH 算法因子</strong>：  </p><ul><li><strong>层次化的Cluster Map</strong>： 反映了存储系统层级的物理拓扑结构。定义了OSD集群具有层级关系的静态拓扑结构。OSD层级使得CRUSH算法在选择OSD时实现了机架感知能力，也就是通过规则定义，使得副本可以分布在不同的机架、不同的机房中，提高数据的安全性</li><li><strong>Placement Rules</strong>： 决定了一个PG的对象副本如何选择的规则，通过这些可以自己设定规则，用户可以自定义设置副本在集群中的分布</li></ul><h3 id="CRUSH-关系分析"><a href="#CRUSH-关系分析" class="headerlink" title="CRUSH 关系分析"></a>CRUSH 关系分析</h3><p>从本质上讲，CRUSH算法是通过存储设备的权重来计算数据对象的分布。在计算过程中，通过Cluster Map（集群映射）、Data Distribution Policy（数据分布策略）和给出的一个随机数共同决定数据对象的最终位置。  </p><h4 id="Cluster-Map"><a href="#Cluster-Map" class="headerlink" title="Cluster Map"></a>Cluster Map</h4><p>Cluster Map记录所有可用的存储资源以及可用的存储资源及相互之间的空间层次结构（集群中有多少个机架、机架上有多少个服务器、每个服务器上有多少磁盘等信息）。所谓Map，顾名思义，就是类似于我们生活中的地图。在Ceph存储里，数据的索引都是通过各种不同的Map来实现的。另一方面，Map使得Ceph集群存储设备在物理层做了一层防护。例如，在多副本结构上，通过设置合理的Map（故障域设置为Host级），可以保证在某一服务器死机的情况下，有其他副本保留在正常的存储节点上，能够继续提供服务，实现存储的高可用。设置更高的故障域级别（如Rack、Row等）能保证整机柜或同一排机柜在掉电情况下数据的高可用性和完整性。  </p><h5 id="1-Cluster-Map的分层结构"><a href="#1-Cluster-Map的分层结构" class="headerlink" title="1.Cluster Map的分层结构"></a>1.Cluster Map的分层结构</h5><p>Cluster Map由Device和Bucket构成。它们都有自己的ID和权重值，并且形成一个以Device为叶子节点、Bucket为躯干的树状结果。  </p><img src="/passages/Ceph相关概念/images/CRUSH架构图.png">  <p>Bucket拥有不同的类型，如Host、Row、Rack、Room等，通常我们默认把机架类型定义为Rack，主机类型定义为Host，数据中心（IDC机房）定义为Data Center。Bucket的类型都是虚拟结构，可以根据自己的喜好设计合适的类型。Device节点的权重值代表了存储设备的容量与性能。其中，磁盘容量是权重大小的关键因素。  </p><p>OSD的权重值越高，对应磁盘会被分配写入更多的数据。总体来说，数据会被均匀写入分布于集群所有磁盘，从而提高整体性能和可靠性。无论磁盘的规格容量，总能够均匀使用。  </p><p>关于OSD权重值的大小值的配比，官方默认值设置为1TB容量的硬盘，对应权重为1。可以在/etc/init.d/ceph源码里查看相关的内容。  </p><p><strong>Bucket随机算法类型</strong>  </p><img src="/passages/Ceph相关概念/images/ceph_bucket.png">  <ul><li><strong>一般的buckets</strong>：适合所有子节点权重相同，而且很少添加删除item</li><li><strong>list buckets</strong>：适用于集群扩展类型。增加item，产生最优的数据移动，查找item，时间复杂对为O(n)</li><li><strong>tree buckets</strong>：查找复杂的为O(log n)，添加删除叶子节点是，其它节点node_id不变</li><li><strong>straw buckets</strong>：允许所有项通过类似抽签的方式来与其它项公平“竞争”。定位副本时，bucket中的每一项都对应一个随机长度的straw，且拥有最长长度的straw会获得胜利（被选中）；添加或者重新计算，子树之间的数据移动提供最优的解决方案</li></ul><h5 id="2-恢复与动态平衡"><a href="#2-恢复与动态平衡" class="headerlink" title="2.恢复与动态平衡"></a>2.恢复与动态平衡</h5><p>在默认情况下，当集群里有组件故障时（主要是OSD，也可能是磁盘或者网络等），Ceph会把OSD标记为down，如果在300s内未能回复，集群就会开始进行恢复状态。这个“300s”可以通过“mon osd down ourt interval”配置选项修改等待时间。PG（Placement Groups）是Ceph数据管理（包括复制、修复等操作）单元。当客户端把读写请求（对象单元）推送到Ceph时，通过CRUSH提供的Hash算法把对象映射到PG。PG在CRUSH策略的影响下，最终会被映射到OSD上。  </p><h4 id="Data-Distribution-Policy"><a href="#Data-Distribution-Policy" class="headerlink" title="Data Distribution Policy"></a>Data Distribution Policy</h4><p>Data Distribution Policy由Placement Rules组成。Rule决定了每个数据对象有多少个副本，这些副本存储的限制条件（比如3个副本放在不同的机架中）。一个典型的rule如下所示：  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule replicated_ruleset &#123;                   ##rule名字</span><br><span class="line">      ruleset 0                             #rule的ID</span><br><span class="line">      type replicated                       ##类型为副本模式，另外一种模式为纠删码（EC）</span><br><span class="line">      min_size 1                            ##如果存储池的副本数大于这个值，此rule不会应用</span><br><span class="line">      max_size 10                           ##如果存储池的副本数大于这个值，此rule不会应用</span><br><span class="line">      step take default                     ##以default root 为入口</span><br><span class="line">      step chooseleaf firstn 0 type host    ##隔离城为host级，即不同副本在不同的主机上</span><br><span class="line">      step emit                             ##提交</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据实际的设备环境，可以定制符合自己需求的Rule。  </p><h3 id="CRUSH-中的伪随机"><a href="#CRUSH-中的伪随机" class="headerlink" title="CRUSH 中的伪随机"></a>CRUSH 中的伪随机</h3><p>$$CRUSH(x) \quad \rightarrow \quad (osd1,osd2 \cdots\cdots osdN)$$  </p><p>CRUSH使用了多参数的Hash函数，在Hash之后，映射都是按既定规则选择的，这使得从x到OSD的集合是确定的和独立的。CRUSH只使用Cluster Map、Placement Ruels、X。CRUSH是伪随机算法，相似输入的结果之间没有相关性。  </p><p>下面通过计算PG的ID来看CRUSH的一个计算过程：  </p><ol><li>Client输入pool ID和对象ID（如pool=’liverpool’,object-id=’john’）</li><li>CRUSH获得对象ID并对其Hash运算</li><li>CRUSH计算OSD个数，Hash取模获得PG的ID（如0x58）</li><li>CRUSH获得已命名pool的ID（如liverpool=4）</li><li>CRUSH预先考虑到pool ID相同的PG ID（如4.0x58）</li></ol><p>在Ceph集群里，当有数据对象要写入集群时，需要进行两次映射，第一次从Object–&gt;PG，第二层是PG–&gt;OSD set。每一次的映射都是与其他对象不相关的，这充分体现了CEUSH的独立性（充分分散）和确定性（可确定的存储位置）。  </p><h2 id="Ceph-IO流程及数据分布"><a href="#Ceph-IO流程及数据分布" class="headerlink" title="Ceph IO流程及数据分布"></a>Ceph IO流程及数据分布</h2><img src="/passages/Ceph相关概念/images/rados_io_1.png">  <h3 id="正常IO流程图"><a href="#正常IO流程图" class="headerlink" title="正常IO流程图"></a>正常IO流程图</h3><img src="/passages/Ceph相关概念/images/ceph_io_2.png">  <p>步骤：  </p><ol><li>Client 创建Cluster handler</li><li>Client 读取配置文件</li><li>Client 连接上Monitor，获取集群map信息</li><li>Client 读写IO 根据Crushmap算法请求对应的主OSD数据节点</li><li>主OSD数据节点同时写入另外两个副本节点数据</li><li>等待主节点以及另外两个副本节点写完数据状态</li><li>主节点及副本节点写入状态都成功后，返回给Client，IO写入完成  </li></ol><h3 id="新主IO流程图"><a href="#新主IO流程图" class="headerlink" title="新主IO流程图"></a>新主IO流程图</h3><p>说明：  </p><p>如果新加入的OSD1取代了原有的OSD4成为Primary OSD，由于OSD1上未创建PG，不存在数据，那么PG上的IO无法进行，怎样工作呢？  </p><img src="/passages/Ceph相关概念/images/ceph_io_3.png">  <p>步骤：  </p><ol><li>Client 连接Monitor获取集群Map信息</li><li>同时新主OSD1由于没有PG，数据会主动上报Monitor告知让OSD2临时接替为主</li><li>临时主OSD2会把数据全量同步给新主OSD1</li><li>Client IO读写直接连接临时主OSD2进行读写</li><li>OSD2收到读写IO，同时写入另外两个副本节点</li><li>等待OSD2以及另外两副本写入成功  </li><li>OSD2三分数据都写入成功返回给Client，此时Client IO读写完毕</li><li>如果OSD1数据同步完毕，临时主OSD2会交出主角色</li><li>OSD1成为主节点，OSD2变成副本  </li></ol><h3 id="Ceph-IO算法流程"><a href="#Ceph-IO算法流程" class="headerlink" title="Ceph IO算法流程"></a>Ceph IO算法流程</h3><img src="/passages/Ceph相关概念/images/ceph_io_4.png">   <ol><li>File用户需要读写文件，File-&gt;Object映射：  <ul><li>a. ino（File的元数据，File的唯一ID）</li><li>b. ono（File切分产生的某个Object的序号，默认以4M切分一个块大小）</li><li>c. oid（object id： ino + ono）</li></ul></li><li>Object是RADOS需要的对象。Ceph指定一个静态Hash函数计算OID的值，将OID映射成一个近似均匀分布的伪随机值，然后和mask按位相与，得到PGID。Object-&gt;PG映射：  <ul><li>a. hash(oid) &amp; mask -&gt; pgid</li><li>b. mask = PG总数m（m为2的整数幂）-1</li></ul></li><li>PG（Placement Group），用途是对Object的存储进行组织和位置映射，类似Redis Cluster里面的slot的概念。一个PG里面会有很多Object。采用CRUSH算法，将PGID带入其中，然后得到一组OSD。PG-&gt;OSD映射：  <ul><li>CRUSH(pgid) -&gt; (osd1,osd2,osd3)</li></ul></li></ol><h3 id="Ceph-RBD-IO流程"><a href="#Ceph-RBD-IO流程" class="headerlink" title="Ceph RBD IO流程"></a>Ceph RBD IO流程</h3><img src="/passages/Ceph相关概念/images/ceph_rbd_io.png">  <p>步骤：  </p><ol><li>客户端创建一个Pool，需要为这个Pool指定PG的数量</li><li>创建pool/image RBD设备进行挂载</li><li>用户写入的数据进行切块，每个块的大小默认为4M，并且每个块都有一个名字，即Object+序号</li><li>将每个Object通过PG进行副本位置的分配</li><li>PG根据CRUSH算法会寻找3个OSD，把这个Object分别保存在这三个OSD上</li><li>OSD上实际是把底层的Disk进行了格式化操作，一般部署工具会将它格式化为xfs文件系统</li><li>Object的存储就变成了存储一个名为rbd0.object1.file的文件  </li></ol><h3 id="Ceph-RBD-IO框架图"><a href="#Ceph-RBD-IO框架图" class="headerlink" title="Ceph RBD IO框架图"></a>Ceph RBD IO框架图</h3><img src="/passages/Ceph相关概念/images/ceph_rbd_io1.png">  <p>客户端写数据OSD过程：  </p><ol><li>采用的是librbd的形式，使用librbd创建一个块设备，向这个块设备写入数据  </li><li>在客户端本地通过调用librados接口，然后经过pool、rbd、object、pg进行层层映射，在PG这一层中，可以知道数据保存在哪3个OSD上，以及这3个OSD的主从关系</li><li>客户端与primary OSD建立socket通信，将要写入的数据传给primary OSD，由primary OSD再将数据发送给其他replica OSD数据节点  </li></ol><h3 id="Ceph-数据扩容PG分布"><a href="#Ceph-数据扩容PG分布" class="headerlink" title="Ceph 数据扩容PG分布"></a>Ceph 数据扩容PG分布</h3><p>场景数据迁移流程：  </p><ul><li>现状3个OSD，4个PG</li><li>扩容到4个OSD，4个PG</li></ul><p>现状：  </p><img src="/passages/Ceph相关概念/images/ceph_recory_1.png">  <p>扩容后：  </p><img src="/passages/Ceph相关概念/images/ceph_recory_2.png">  <p>说明：  </p><p>每个OSD上分布很多PG，并且每个PG会自动散落在不同的OSD上。如果扩容，那么相应的PG会自动迁移到新的OSD上，保证PG数量的均衡  </p><h2 id="Ceph心跳机制"><a href="#Ceph心跳机制" class="headerlink" title="Ceph心跳机制"></a>Ceph心跳机制</h2><h3 id="心跳介绍"><a href="#心跳介绍" class="headerlink" title="心跳介绍"></a>心跳介绍</h3><p>心跳是用于节点间检测对方是否发送故障，以便及时发现故障点进入相应的故障处理流程。  </p><p><strong>问题：</strong>  </p><ul><li>故障检测时间和心跳报文带来的负载之间做权衡</li><li>心跳频率太高则过多的心跳报文会影响系统性能</li><li>心跳频率过低则会延长发现故障节点的时间，从而影响系统的可用性  </li></ul><p><strong>故障检测策略应该能够做到：</strong></p><ul><li><strong>及时</strong>：节点发生异常如宕机或网络中断时，集群可以在可接受的时间范围内感知</li><li><strong>适当的压力</strong>：包括对节点的压力和网络的压力</li><li><strong>容忍网络抖动</strong>：网络偶尔延迟</li><li><strong>扩散机制</strong>：节点存活状态改变导致的元信息变化需要通过某种机制扩散到整个集群</li></ul><h3 id="Ceph-心跳检查"><a href="#Ceph-心跳检查" class="headerlink" title="Ceph 心跳检查"></a>Ceph 心跳检查</h3><img src="/passages/Ceph相关概念/images/ceph_heartbeat_1.png">  <p><strong>OSD节点会监听public、cluster、front和back四个端口</strong></p><ul><li><strong>public端口</strong>：监听来自Monitor和Client的连接</li><li><strong>cluster端口</strong>：监听来自OSD Peer的连接</li><li><strong>front端口</strong>：供客户端连接集群使用的网卡，这里临时给集群内部之间进行心跳</li><li><strong>back端口</strong>：供集群内部使用的网卡，集群内部之间进行心跳</li><li><strong>hbclient</strong>：发送ping心跳的messenger</li></ul><h3 id="Ceph-OSD之间相互心跳检查"><a href="#Ceph-OSD之间相互心跳检查" class="headerlink" title="Ceph OSD之间相互心跳检查"></a>Ceph OSD之间相互心跳检查</h3><img src="/passages/Ceph相关概念/images/ceph_heartbeat_osd.png"><p>步骤：  </p><ul><li>同一个PG内的OSD相互心跳，它们互相发送PING/PONG信息</li><li>每隔6s检测一次（实际会在这个基础上加一个随机时间来避免峰值）</li><li>20s没有检测到心跳回复，加入failure队列  </li></ul><h3 id="Ceph-OSD与Mon心跳检测"><a href="#Ceph-OSD与Mon心跳检测" class="headerlink" title="Ceph OSD与Mon心跳检测"></a>Ceph OSD与Mon心跳检测</h3><img src="/passages/Ceph相关概念/images/ceph_heartbeat_mon.png">  <p><strong>OSD报告给Monitor</strong>:</p><ul><li>OSD有事件发生时（比如故障、PG变更）</li><li>自身启动5s内</li><li>OSD周期性的上报给Monitor<ul><li>OSD检查failure_queue中的伙伴OSD失败信息</li><li>向Monitor发送失效报告，并将失败信息加入failure_pending队列，然后将其从failure_queue移除</li><li>收到来自failure_queue或者failure_pending中的OSD的心跳时，将其从这两个队列中移除，并告知Monitor取消之前的失效报告</li><li>当发生与Monitor网络重连时，会将failure_pending中的错误报告加回到failure_queue中，并再次发送给Monitor</li></ul></li><li>Monitor统计下线OSD<ul><li>Monitor收集来自OSD的伙伴失效报告</li><li>当错误报告指向的OSD失效超过一定阈值，且足够多的OSD报告其失效时，将该OSD下线  </li></ul></li></ul><h2 id="Ceph心跳检测总结"><a href="#Ceph心跳检测总结" class="headerlink" title="Ceph心跳检测总结"></a>Ceph心跳检测总结</h2><p>Ceph通过伙伴OSD汇报失效节点和Monitor统计来自OSD的心跳两种方式判定OSD节点失效。  </p><ul><li><p><strong>及时</strong>：伙伴OSD可以在秒级发现节点失效并汇报Monitor，并在几分钟内由Monitor将失效OSD下线</p></li><li><p><strong>适当压力</strong>：由于有伙伴OSD汇报机制，Monitor与OSD之间的心跳统计更像是一种保险措施，因此OSD向Monitor发送心跳的间隔可以长达600s，Monitor的检测阈值也可以长达900s。Ceph实际上是将故障检测过程中中心节点的压力分散到所有的OSD上，以此提高中心节点Monitor的可靠性，进而提高这个集群的可靠性</p></li><li><p><strong>容忍网络抖动</strong>：Monitor收到OSD对其伙伴OSD的汇报后，并没有马上将目标OSD下线，而是周期性地等待几个条件：  </p><ul><li>目标OSD的失效时间大于通过固定量osd_heartbeat_grace和历史网络条件动态确定的阈值</li><li>来自不同主机的汇报到的mod_osd_min_down_reports</li><li>慢速前两个条件失效汇报没有被源OSD取消</li></ul></li><li><p><strong>扩散</strong>：作为中心节点的Monitor并没有在更OSDMap后尝试广播通知所有的OSD和Client，而是惰性的等待OSD和Client来获取，以此来减少Monitor压力并简化交互逻辑</p></li></ul><h2 id="Ceph通信框架"><a href="#Ceph通信框架" class="headerlink" title="Ceph通信框架"></a>Ceph通信框架</h2><h3 id="Ceph通信框架种类介绍"><a href="#Ceph通信框架种类介绍" class="headerlink" title="Ceph通信框架种类介绍"></a>Ceph通信框架种类介绍</h3><p><strong>网络通信框架三种不同的实现方式</strong>：  </p><ul><li><strong>Simple线程模式</strong><ul><li><strong>特点</strong>：每一个网络链接，都会创建两个线程，一个用于接收，一个用于发送</li><li><strong>缺点</strong>：大量的链接会产生大量的线程，会消耗CPU资源，影响性能</li></ul></li><li><strong>Async事件的I/O多路复用模式</strong><ul><li><strong>说明</strong>：这种是目前网络通信中广泛采用的方式。K版默认已经使用Async</li></ul></li><li><strong>XIO方式使用了开源的网络通信库accelio来实现</strong><ul><li><strong>说明</strong>：这种方式需要依赖第三方库accelio的稳定性</li></ul></li></ul><h3 id="Ceph通信框架设计模式"><a href="#Ceph通信框架设计模式" class="headerlink" title="Ceph通信框架设计模式"></a>Ceph通信框架设计模式</h3><p><strong>设计模式（Subscribe/Publish）</strong></p><p>订阅发布模式又名观察者模式，它意图是”定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变是，所有依赖于它的对象都得到通知并被自动更新“。  </p><h3 id="Ceph通信框架流程图"><a href="#Ceph通信框架流程图" class="headerlink" title="Ceph通信框架流程图"></a>Ceph通信框架流程图</h3><img src="/passages/Ceph相关概念/images/ceph_message.png">  <p>步骤：  </p><ul><li>Accepter监听peer的请求，调用SimpleMessenger::add_accept_pip3()创建新的pipe到SimpleMessenger::pipes来处理该请求</li><li>Pipe用于消息的读取和发生。该类主要有两个组件：Pipe::Reader，Pipe::Writer用来处理消息读取和发送</li><li>Messenger作为消息的发布者，各个Dispatcher子类作为消息的订阅者，Messenger收到消息之后，通过Pipe对取消息，然后转给Dispatcher处理</li><li>Dispatcher是订阅者的基类，具体的订阅者后端继承该类，初始化的时候通过Messenger::add_dispatcher_tail/head注册到Messenger::dispatchers。收到消息后，通知该类处理</li><li>DispatchQueue该类用来缓存收到的消息，然后唤醒DispatchQueue::dispatch_thread线程找到后端的Dispatch处理消息</li></ul><img src="/passages/Ceph相关概念/images/ceph_message_2.png">  <h3 id="Ceph通信框架类图"><a href="#Ceph通信框架类图" class="headerlink" title="Ceph通信框架类图"></a>Ceph通信框架类图</h3><img src="/passages/Ceph相关概念/images/ceph_message_3.png">  <h3 id="Ceph通信数据格式"><a href="#Ceph通信数据格式" class="headerlink" title="Ceph通信数据格式"></a>Ceph通信数据格式</h3><p>通信协议格式需要双方约定数据格式。  </p><p><strong>消息的内容主要分为三部分</strong>：  </p><ul><li>header        //消息头 类型消息的信封</li><li>user data     //需要发送的实际数据<ul><li>payload     //操作保存元数据</li><li>middle      //预留字段</li><li>data        //读写数据</li></ul></li><li>footer        //消息的结束标记  </li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span> :</span> <span class="keyword">public</span> RefCountedObject &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  ceph_msg_header  header;      <span class="comment">// 消息头</span></span><br><span class="line">  ceph_msg_footer  footer;      <span class="comment">// 消息尾</span></span><br><span class="line">  bufferlist       payload;  <span class="comment">// "front" unaligned blob</span></span><br><span class="line">  bufferlist       middle;   <span class="comment">// "middle" unaligned blob</span></span><br><span class="line">  bufferlist       data;     <span class="comment">// data payload (page-alignment will be preserved where possible)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* recv_stamp is set when the Messenger starts reading the</span></span><br><span class="line"><span class="comment">   * Message off the wire */</span></span><br><span class="line">  <span class="keyword">utime_t</span> recv_stamp;       <span class="comment">//开始接收数据的时间戳</span></span><br><span class="line">  <span class="comment">/* dispatch_stamp is set when the Messenger starts calling dispatch() on</span></span><br><span class="line"><span class="comment">   * its endpoints */</span></span><br><span class="line">  <span class="keyword">utime_t</span> dispatch_stamp;   <span class="comment">//dispatch 的时间戳</span></span><br><span class="line">  <span class="comment">/* throttle_stamp is the point at which we got throttle */</span></span><br><span class="line">  <span class="keyword">utime_t</span> throttle_stamp;   <span class="comment">//获取throttle 的slot的时间戳</span></span><br><span class="line">  <span class="comment">/* time at which message was fully read */</span></span><br><span class="line">  <span class="keyword">utime_t</span> recv_complete_stamp;  <span class="comment">//接收完成的时间戳</span></span><br><span class="line"></span><br><span class="line">  ConnectionRef connection;     <span class="comment">//网络连接</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> magic = <span class="number">0</span>;           <span class="comment">//消息的魔术字</span></span><br><span class="line"></span><br><span class="line">  bi::list_member_hook&lt;&gt; dispatch_q;    <span class="comment">//boost::intrusive 成员字段</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ceph_msg_header</span> &#123;</span></span><br><span class="line">    __le64 seq;       <span class="comment">// 当前session内 消息的唯一 序号</span></span><br><span class="line">    __le64 tid;       <span class="comment">// 消息的全局唯一的 id</span></span><br><span class="line">    __le16 type;      <span class="comment">// 消息类型</span></span><br><span class="line">    __le16 priority;  <span class="comment">// 优先级</span></span><br><span class="line">    __le16 version;   <span class="comment">// 版本号</span></span><br><span class="line"></span><br><span class="line">    __le32 front_len; <span class="comment">// payload 的长度</span></span><br><span class="line">    __le32 middle_len;<span class="comment">// middle 的长度</span></span><br><span class="line">    __le32 data_len;  <span class="comment">// data 的 长度</span></span><br><span class="line">    __le16 data_off;  <span class="comment">// 对象的数据偏移量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ceph_entity_name</span> <span class="title">src</span>;</span> <span class="comment">//消息源</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* oldest code we think can decode this.  unknown if zero. */</span></span><br><span class="line">    __le16 compat_version;</span><br><span class="line">    __le16 reserved;</span><br><span class="line">    __le32 crc;       <span class="comment">/* header crc32c */</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ceph_msg_footer</span> &#123;</span></span><br><span class="line">    __le32 front_crc, middle_crc, data_crc; <span class="comment">//crc校验码</span></span><br><span class="line">    __le64  sig; <span class="comment">//消息的64位signature</span></span><br><span class="line">    __u8 flags; <span class="comment">//结束标志</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Ceph </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes_Istio-Gateway_Ingress-Controller</title>
      <link href="/passages/Kubernetes-Istio-Gateway-Ingress-Controller/"/>
      <url>/passages/Kubernetes-Istio-Gateway-Ingress-Controller/</url>
      
        <content type="html"><![CDATA[<blockquote><p>最近在istio，然后想总结下ingress-controller和istio-gateway的区别。</p><p>在Kubernetes环境中，Kubernetes Ingress用于配置需要在集群外部公开的服务。</p><p>但是在Istio服务网格中，更好的方法是使用新的配置模型，即Istio Gateway；Gateway允许将Istio流量管理的功能应用于进入集群的流量。</p><p>这里的ingress为nginx ingress</p></blockquote><p>通过灰度发布，来看一下ingress与istio的实现方式的差异 <a id="more"></a></p><h3 id="环境准备："><a href="#环境准备：" class="headerlink" title="环境准备："></a>环境准备：</h3><blockquote><p>kubernetes环境     1.13.5</p><p>部署istio                 1.1.1</p></blockquote><h3 id="Istio："><a href="#Istio：" class="headerlink" title="Istio："></a>Istio：</h3><blockquote><p>部署两个服务：</p><p>old</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/xxxxx/old-nginx</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    run:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><blockquote><p>new</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/xxxxx/new-nginx</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    run:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><blockquote><p>输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   172.19.0.1      &lt;none&gt;        443/TCP        9h</span><br><span class="line">new-nginx    NodePort    172.19.8.168    &lt;none&gt;        80:31904/TCP   4h</span><br><span class="line">old-nginx    NodePort    172.19.12.148   &lt;none&gt;        80:31545/TCP   4h</span><br></pre></td></tr></table></figure><blockquote><p>测试两个服务</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl run -it --rm bash --image=appropriate/curl --restart=Never curl 172.19.8.168</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> kubectl run -it --rm bash --image=appropriate/curl --restart=Never curl 172.19.12.148</span><br><span class="line">old</span><br></pre></td></tr></table></figure><blockquote><p>创建Gateway对象/用的istio官方yaml</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld-gateway</span> <span class="comment"># name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span>  <span class="comment"># use istio default controller</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure><blockquote><p>确定Istio入口IP和port</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> kubectl get svc istio-ingressgateway -n istio-system</span><br><span class="line">NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                                      AGE</span><br><span class="line">istio-ingressgateway   LoadBalancer   172.19.14.182   (pending)   80:31380/TCP,443:31390/TCP,31400:31400/...   10h</span><br></pre></td></tr></table></figure><blockquote><p>确认<code>EXTERNAL-IP</code>设置了值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST= $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.status.loadBalancer.ingress[0].ip&#125;')</span><br><span class="line">export INGRESS_PORT= $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http")].port&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT= $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].port&#125;')</span><br></pre></td></tr></table></figure><blockquote><p>满足特定规则：</p><p>例如，我们希望请求头中带有user且值为new的客户端请求才能访问new service</p><p>我们可以创建一个对应的<code>VirtualService</code>为通过<code>Gateway</code>进入的流量配置路由</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span>   <span class="comment"># istio route rule </span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld</span>     <span class="comment"># name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">helloworld-gateway</span> <span class="comment"># link Gateway</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">new</span>       <span class="comment"># match headers -&gt; user (-&gt; exact -&gt;) new  [headers: user: new]</span></span><br><span class="line"><span class="attr">    route:</span>                 <span class="comment"># 会访问new-nginx，满足头部要求即可</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  - route:</span>                 <span class="comment"># 否则就访问old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><blockquote><p>客户端测试</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br></pre></td></tr></table></figure><blockquote><p>在满足特定规则和权重：</p><p>例如，我们希望请求头中带有user且值为new的客户端请求有50%的比例访问new service，那么我们可以创建一个这样的<code>VirtualService</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">helloworld-gateway</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">new</span>          <span class="comment"># 这里跟上面的一样，符合头部 user: new就会访问到这一层</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">50</span>              </span><br><span class="line">                             <span class="comment"># 另外因为这里设置了两个访问规则，即首先符合头部，然后会有50%的几率会访问到new-nginx，另外50%会访问到old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">  - route:</span>                    <span class="comment"># 如果不匹配头部，那就全部访问到old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><blockquote><p>客户端测试</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span> curl -H "user: new" http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br></pre></td></tr></table></figure><blockquote><p>权重随机访问：</p><p>例如，我们仅仅希望20%的客户端请求访问new service，那么我们可以创建一个这样的<code>VirtualService</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">helloworld-gateway</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span>                        </span><br><span class="line">  <span class="comment"># 这条virtual Service 设置了权重来几率性访问nginx；20%new-nginx，80% old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>客户端测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span> curl http://$INGRESS_HOST:$INGRESS_PORT</span><br><span class="line">new</span><br></pre></td></tr></table></figure><h3 id="Nginx-Ingress"><a href="#Nginx-Ingress" class="headerlink" title="Nginx Ingress"></a>Nginx Ingress</h3><blockquote><p>不支持权重，貌似能够支持headers头</p></blockquote><p>Nginx:</p><blockquote><p>使用$http_ 获取http请求的header，根据配置中是否为完整或者正则匹配，匹配foo的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ....</span><br><span class="line">    if ($http_foo = "bar") &#123;  //完全匹配</span><br><span class="line">    #if ($http_foo ~ "bar") &#123;  //正则匹配</span><br><span class="line">           proxy_pass http://default-new-nginx-80;</span><br><span class="line">           break;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://default-old-nginx-80;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>使用$cookie_获取http请求的cookie，根据配置中是否为完整或者正则匹配，匹配foo的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ....</span><br><span class="line">    if ($cookie_foo ~ "^bar") &#123;  //正则匹配</span><br><span class="line">    # if ($cookie_foo = "bar") &#123;  //完全匹配</span><br><span class="line">         proxy_pass http://default-new-nginx-80;</span><br><span class="line">         break;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://default-old-nginx-80;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><blockquote><p>使用$arg_获取http的请求参数，根据配置中是否为完整或者正则匹配，匹配foo的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ....</span><br><span class="line">    if ($arg_foo ~ "^bar") &#123;  //正则匹配</span><br><span class="line">    # if ($arg_foo = "bar") &#123;  //完全匹配</span><br><span class="line">         proxy_pass http://default-new-nginx-80;</span><br><span class="line">         break;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://default-old-nginx-80;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>这里用到的两个服务为istio用的两个服务：</p><blockquote><p>应用部署完毕后，我们看要怎么配置ingress才能够正确的刷新到ngixn.conf，在nginx-ingress-controller中，它支持 nginx.ingress.kubernetes.io/configuration-snippet 这样一个注解允许我们在location里配置自定义需求。同时结合nginx-ingress-controller的upstream命名方式namespace-serviceName-port的方式配置注解信息。如下ingress yaml所示:</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">       if ($http_foo ~ "^.*bar$") &#123;</span></span><br><span class="line"><span class="string">         proxy_pass http://default-new-nginx-80;</span></span><br><span class="line"><span class="string">         break;</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  name:</span> <span class="string">gray-release</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">    - host:</span> <span class="string">www.example.com</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="attr">          - backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">          - backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure><blockquote><p>输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> curl -H "Host: www.example.com"  http://172.16.0.9</span><br><span class="line">old</span><br><span class="line"> curl -H "Host: www.example.com"  http://172.16.0.9</span><br><span class="line">old</span><br><span class="line"> curl -H "Host: www.example.com"  http://172.16.0.9</span><br><span class="line">old</span><br><span class="line"> curl -H "Host: www.example.com" -H "foo: bar" http://172.16.0.9</span><br><span class="line">new</span><br><span class="line"> curl -H "Host: www.example.com" -H "foo: bar" http://172.16.0.9</span><br><span class="line">new</span><br><span class="line"> curl -H "Host: www.example.com" -H "foo: bar" http://172.16.0.9</span><br><span class="line">new</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Istio </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes_1.13.5_ingress</title>
      <link href="/passages/Kubernetes-1-13-5%E9%83%A8%E7%BD%B2ingress/"/>
      <url>/passages/Kubernetes-1-13-5%E9%83%A8%E7%BD%B2ingress/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes部署mysql-opreator</title>
      <link href="/passages/Kubernetes%E9%83%A8%E7%BD%B2mysql-opreator/"/>
      <url>/passages/Kubernetes%E9%83%A8%E7%BD%B2mysql-opreator/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
            <tag> kubernetes-opreator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安装-kubeadm_1.13.5(非外部etcd)</title>
      <link href="/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5-%E9%9D%9E%E5%A4%96%E9%83%A8etcd/"/>
      <url>/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5-%E9%9D%9E%E5%A4%96%E9%83%A8etcd/</url>
      
        <content type="html"><![CDATA[<blockquote><p>之前写过一篇kubernetes安装的，用到的是外部的etcd，即etcd单独二进制安装，kubeadm初始化指定即可；</p><p>本篇用的纯kubeadm安装高可用集群，master组件静态pod</p></blockquote><h2 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h2><blockquote><p>kubernetes version：1.13.5</p><p>docker version：18.6.3</p><p>Redhat：7.6</p></blockquote><a id="more"></a><table><thead><tr><th style="text-align:left">x.x.x.1</th><th style="text-align:center">master-1</th><th>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</th></tr></thead><tbody><tr><td style="text-align:left"><strong>x.x.x.2</strong></td><td style="text-align:center"><strong>master-2</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.3</strong></td><td style="text-align:center"><strong>master-3</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.4</strong></td><td style="text-align:center"><strong>vip</strong></td><td></td></tr><tr><td style="text-align:left"><strong>x.x.x.5</strong></td><td style="text-align:center"><strong>node-1</strong></td><td><strong>kubelet、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.6</strong></td><td style="text-align:center"><strong>node-2</strong></td><td><strong>kubelet、docker</strong></td></tr></tbody></table><p>因为担心kubeadm起来的etcd不稳定，这里用到的etcd对于kubernetes来说作为外部etcd集群。即使用二进制安装etcd集群，其余组件用kubeadm来完成安装。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">echo "1" &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class="line"><span class="meta">#</span> 停防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span> 关闭Swap</span><br><span class="line">swapoff -a</span><br><span class="line">sed 's/.*swap.*/#&amp;/' /etc/fstab</span><br><span class="line"><span class="meta">#</span> 关闭防火墙</span><br><span class="line">systemctl disable firewalld &amp;&amp; systemctl stop firewalld &amp;&amp; systemctl status firewalld</span><br><span class="line"><span class="meta">#</span> 关闭Selinux</span><br><span class="line">setenforce  0</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="2、docker安装"><a href="#2、docker安装" class="headerlink" title="2、docker安装"></a>2、docker安装</h3><h4 id="1、下载设置源"><a href="#1、下载设置源" class="headerlink" title="1、下载设置源"></a>1、下载设置源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.daocloud.io/docker/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="2、安装docker"><a href="#2、安装docker" class="headerlink" title="2、安装docker"></a>2、安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r  # 列出docker-ce的版本list</span><br><span class="line">yum install docker-ce-&lt;版本号&gt; -y # -y 安装docker需要的依赖，其中有个container-selinux的也可以单独下载</span><br><span class="line"><span class="meta">#</span> rpm -ivh container-selinux-2.33-1.git86f33cd.el7.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="3、启动docker"><a href="#3、启动docker" class="headerlink" title="3、启动docker"></a>3、启动docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">docker version # 验证docker安装是否完成并启动成功</span><br></pre></td></tr></table></figure><h3 id="3、kubeadm-kubelet-kubectl安装"><a href="#3、kubeadm-kubelet-kubectl安装" class="headerlink" title="3、kubeadm/kubelet/kubectl安装"></a>3、kubeadm/kubelet/kubectl安装</h3><blockquote><p>各节点安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.13.5 kubeadm-1.13.5 kubectl-1.13.5 --disableexcludes=kubernetes  #禁用除kubernetes之外的仓库,要用 -y 参数，会自动安装kube-cni等插件</span><br><span class="line"></span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet # kubeadm 要求kubelet保持开机自启状态</span><br></pre></td></tr></table></figure><h3 id="4、keepalive安装"><a href="#4、keepalive安装" class="headerlink" title="4、keepalive安装"></a>4、keepalive安装</h3><blockquote><p>master节点安装：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line"></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script CheckK8sMaster &#123;</span><br><span class="line">    script &quot;curl -k https://10.70.49.130:6443&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    timeout 9</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens256 # 网卡</span><br><span class="line">    virtual_router_id 61</span><br><span class="line">    # 主节点权重最高 依次减少</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line">    #修改为本地IP </span><br><span class="line">    mcast_src_ip x.x.x.2</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass sqP05dQgMSlzrxHj</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        x.x.x.1</span><br><span class="line">        #x.x.x.2</span><br><span class="line">        x.x.x.3</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        x.x.x.4</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        CheckK8sMaster</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="kubernetes部署"><a href="#kubernetes部署" class="headerlink" title="kubernetes部署"></a>kubernetes部署</h2><h4 id="1、master部署"><a href="#1、master部署" class="headerlink" title="1、master部署"></a>1、master部署</h4><blockquote><p>部署之前请确保下载好相关image，翻墙下载或者国内dockerhub下载kubernetes镜像</p></blockquote><h5 id="1、初始化master1"><a href="#1、初始化master1" class="headerlink" title="1、初始化master1"></a>1、初始化master1</h5><blockquote><p>创建master1的初始化配置文件,网络插件采用flannel，CIDR地址是 “10.244.0.0/16”，如下为1.13.5新版本配置文件。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubeadm-master.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">nodeRegistration:</span><br><span class="line">  name: 10.78.229.193        # 指定node name，kubectl get no会显示ip</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: x.x.x.1  # 本机ip，这里为x.x.x.1-3</span><br><span class="line">  bindPort: 6443</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.5   # kubernetes版本 对应下载的image</span><br><span class="line">imageRepository: k8s.gcr.io  # 自己修改为自己的镜像库名</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - "master1"</span><br><span class="line">  - "master2"</span><br><span class="line">  - "master3"</span><br><span class="line">  - "x.x.x.1"</span><br><span class="line">  - "x.x.x.2"</span><br><span class="line">  - "x.x.x.3"</span><br><span class="line">  - "x.x.x.4"</span><br><span class="line">  - "127.0.0.1"</span><br><span class="line"></span><br><span class="line">controlPlaneEndpoint: "x.x.x.4:8443" # 控制台ip指定，即vip 实现apiserver高可用</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd     # 随意指定即可</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: "10.244.0.0/16"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 运行初始化命令即可，前提要把相关设置关闭，详情至准备工作</span><br><span class="line"><span class="meta">#</span> 其中在kubelet配置里加入--pod-infra-container-image 参数指定 pause私有镜像库镜像</span><br><span class="line">kubeadm init --config kubeadm-master.yaml</span><br></pre></td></tr></table></figure><blockquote><p>在初始化配置里，对于etcd有两种高可用的选项，一个使用内部etcd，一个使用外部etcd(独立搭建的etcd集群，而不是在初始化中搭建的)，两者初始化配置文件略有不同。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 使用内部etcd的话，初始化yaml文件中etcd配置如下：</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: "https://127.0.0.1:2379,https://x.x.x.x:2379"</span><br><span class="line">      advertise-client-urls: "https://x.x.x.x:2379"</span><br><span class="line">      listen-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-advertise-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-cluster: "master1.hanli.com=https://x.x.x.x:2380"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用外部etcd的话，</span><br><span class="line">etcd:    #ETCD的地址</span><br><span class="line">   external:</span><br><span class="line">     endpoints:</span><br><span class="line">     - https://x.x.x.1:2379</span><br><span class="line">     - https://x.x.x.2:2379</span><br><span class="line">     - https://x.x.x.3:2379</span><br></pre></td></tr></table></figure><blockquote><p>init初始化之后，如果成功会出现<code>join</code>，这时就可以运行一下命令</p><p>机器上的用户要使用<code>kubectl</code>来管理集群操作集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><blockquote><p>验证命令</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs # 如下信息</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br><span class="line"></span><br><span class="line">kubectl get node # notReady 状态，是因为没有安装网络插件 Name成ip，可修改kubelet的启动参数即可</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1     NotReady      master     1m      v1.13.5</span><br></pre></td></tr></table></figure><h5 id="2、启动flannel服务"><a href="#2、启动flannel服务" class="headerlink" title="2、启动flannel服务"></a>2、启动flannel服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta">#</span> flannel 默认会使用主机的第一张网卡，如果你有多张网卡，需要通过配置单独指定。修改 kube-flannel.yml 中的以下部分</span><br><span class="line">cat kube-flannel.yml </span><br><span class="line"> containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.11.0-amd64 # 修改下自己私有镜像库的flannel镜像名</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=ens33              #添加</span><br></pre></td></tr></table></figure><hr><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml # 创建pod，因为是ds的所以后续集群里面加节点就会自动启动flannel</span><br><span class="line">kubectl get node # 会发现 node状态变成了 Ready</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1       Ready      master     10m      v1.13.5</span><br><span class="line"></span><br><span class="line">kubectl get po --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-86c58d9df4-r59rv                   1/1     Running   0          59m</span><br><span class="line">kube-system   coredns-86c58d9df4-rbzx5                   1/1     Running   0          59m</span><br><span class="line">kube-system   kube-apiserver-master1                     1/1     Running   0          58m</span><br><span class="line">kube-system   kube-controller-manager-master1            1/1     Running   16         58m</span><br><span class="line">kube-system   kube-flannel-ds-amd64-229j2                1/1     Running   0          42m</span><br><span class="line">kube-system   kube-proxy-4wrg5                           1/1     Running   0          59m</span><br><span class="line">kube-system   kube-scheduler-master1                     1/1     Running   13         58m</span><br></pre></td></tr></table></figure><blockquote><p>不是running状态，就说明出错了，通过查看</p><p>描述：kubectl describe pod kube-scheduler-master.hanli.com -n kube-system</p><p>日志：kubectl logs kube-scheduler-master.hanli.com -n kube-system</p><p>flannel服务启动成功后，coredns也就会自动启动成功，状态为Running</p></blockquote><h5 id="3、初始化其他master节点"><a href="#3、初始化其他master节点" class="headerlink" title="3、初始化其他master节点"></a>3、初始化其他master节点</h5><blockquote><p>首先把master1上生成的ca证书等，拷贝到其他master节点上，最好免密，可使用pscp等批量任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> #!/bin/bash</span><br><span class="line"><span class="meta">&gt;</span> #注意修改为自己的主机名</span><br><span class="line"><span class="meta">&gt;</span> export CONTROL_PLANE_IPS="master2 master3"  </span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> # 保证节点有/etc/kubernetes/pki目录</span><br><span class="line"><span class="meta">&gt;</span> # 把以下证书复制到其他master节点</span><br><span class="line"><span class="meta">&gt;</span> for host in $&#123;CONTROL_PLANE_IPS&#125;; do</span><br><span class="line"><span class="meta">&gt;</span> # ！！！修正拷贝证书的时候请指定特定证书拷贝（之前的已经备注，新加的有etcd目录，没有用外部etcd集群），因为在证书拷贝的情况下吃过亏，因此修改此处！！！</span><br><span class="line"><span class="meta">&gt;</span> # 附issue：https://github.com/kubernetes/kubeadm/issues/1321 </span><br><span class="line"><span class="meta">&gt;</span> # 找了好久终于！！！哭</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/pki/*.crt $host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/pki/*.key $host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/pki/*.pub $host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/admin.conf $host:/etc/kubernetes/admin.conf</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/ca.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/sa.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/front-proxy-ca.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/etcd/ca.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/etcd/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/admin.conf "$&#123;USER&#125;"@$host:/etc/kubernetes/</span><br><span class="line"><span class="meta">&gt;</span> done</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> tree /etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> /etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-etcd-client.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-etcd-client.key</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver.key</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-kubelet-client.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-kubelet-client.key</span><br><span class="line"><span class="meta">&gt;</span> ├── ca.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── ca.key</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-ca.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-ca.key</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-client.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-client.key</span><br><span class="line"><span class="meta">&gt;</span> ├── sa.key</span><br><span class="line"><span class="meta">&gt;</span> └── sa.pub</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span> 分别修改对应ip 参数`--node-name`，在在master2、3执行master1出现的join命令即可 步骤如下：</span><br><span class="line"><span class="meta">#</span> 对于控制平面node 增加 `--experimental-control-plane` 即可，只有master node采用，更方便。当然还有复杂的通过原子操作来add etcd node 增加 etcd-cluster</span><br><span class="line">kubeadm join x.x.x.4:8443 --token bnnsb7.amapp1t78llxn54d --discovery-token-ca-cert-hash sha256:520ef89be84c30e480db6d441a7e4179634a9455f0009e249ebe8f35fa792087 --experimental-control-plane --node-name=x.x.x.2#(对应主机ip) </span><br><span class="line"><span class="meta">#</span> 等待kube-proxy flannel启动成功即可</span><br><span class="line"><span class="meta">#</span> 这种方案，kubectl get cs直观的看不到etcd集群的，可通过一下命令：</span><br><span class="line">kubectl exec -n kube-system etcd-x.x.x.1 -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://x.x.x.1:2379 member list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 这里把master2、3节点采用原子操作加入etcd集群步骤写下来：</span><br><span class="line"><span class="meta">#</span> 配置证书</span><br><span class="line">kubeadm init phase certs all --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span> etcd证书</span><br><span class="line">kubeadm init phase etcd local --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span> 生成kubelet配置文件</span><br><span class="line">kubeadm init phase kubeconfig kubelet --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span> 启动kubelet</span><br><span class="line">kubeadm init phase kubelet-start --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span> 配置kubectl命令</span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta">#</span> etcd集群加节点</span><br><span class="line">kubectl exec -n kube-system etcd-x.x.x.1 -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://x.x.x.1:2379 member add etcd2 https://x.x.x.2:2380</span><br><span class="line"><span class="meta">#</span> 启动 kube-apiserver、kube-controller-manager、kube-scheduler</span><br><span class="line">kubeadm init phase kubeconfig all --config kubernetes.yaml</span><br><span class="line">kubeadm init phase control-plane all --config kubernetes.yaml</span><br><span class="line"><span class="meta">#</span> 标记master</span><br><span class="line">kubeadm init phase mark-control-plane --config kubernetes.yaml</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n kube-system</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-9f9d9c76-4zrt4                  1/1     Running   0          2d</span><br><span class="line">coredns-9f9d9c76-dqd4c                  1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-1   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-2   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-3   1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-7ghn7             1/1     Running   1          2d</span><br><span class="line">kube-flannel-ds-amd64-9cqts             1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-f57nh             1/1     Running   1          2d</span><br><span class="line">kube-proxy-8fwts                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-95tjb                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-bls94                        1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kubernetes-dashboard-67d49f7868-x79wf   1/1     Running   0          76m</span><br></pre></td></tr></table></figure><h4 id="2、Work节点加入集群"><a href="#2、Work节点加入集群" class="headerlink" title="2、Work节点加入集群"></a>2、Work节点加入集群</h4><blockquote><p>输入master节点初始化成功之后出现的<code>join</code>命令，出现<code>kubectl get nodes</code>即成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> kubeadm join x.x.x.4:8443 --token bnnsb7.amapp1t78llxn54d --discovery-token-ca-cert-hash sha256:520ef89be84c30e480db6d441a7e4179634a9455f0009e249ebe8f35fa792087</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><h4 id="3、集群验证"><a href="#3、集群验证" class="headerlink" title="3、集群验证"></a>3、集群验证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 节点状态</span><br><span class="line">[root@master] ~$ kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 组件状态</span><br><span class="line">[root@master] ~$  kubectl get cs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 服务账户</span><br><span class="line">[root@master] ~$ kubectl get serviceaccount</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 集群信息</span><br><span class="line">[root@master] ~$ kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 验证dns功能</span><br><span class="line">[root@master] ~$ kubectl run curl --image=radial/busyboxplus:curl -it</span><br><span class="line">[ root@curl-66959f6557-r4crd:/ ]$ nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure><blockquote><p>附录：</p><p><strong><code>打算把以前kubernetes二进制安装的步骤，也迁过来。kubeadm已经GA，之后也会一直用kubeadm了</code></strong></p><p><strong><em><code>kubeadm token create --print-join-command</code></em></strong>可以获取 kubeadm join命令，比以前真的方便很多了         =。=</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> # kubelet.service配置文件 /use/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><hr><p>参考链接：</p><p>kubeadm安装1.13.5：<a href="https://blog.csdn.net/fanren224/article/details/86573264#2master1_165" target="_blank" rel="noopener">https://blog.csdn.net/fanren224/article/details/86573264#2master1_165</a></p><p>二进制安装：<a href="https://github.com/mritd/ktool" target="_blank" rel="noopener">https://github.com/mritd/ktool</a></p><p>二进制安装kubernetes_v1.13.4：<a href="https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/" target="_blank" rel="noopener">https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/</a></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Kubernetes_ha </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_set集合操作</title>
      <link href="/passages/Python-set%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/"/>
      <url>/passages/Python-set%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="Python-set集合类型小结"><a href="#Python-set集合类型小结" class="headerlink" title="Python_set集合类型小结"></a>Python_set集合类型小结</h2><p>下面来点简单的小例子说明把。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = set(<span class="string">'spam'</span>)</span><br><span class="line">y = set([<span class="string">'h'</span>,<span class="string">'a'</span>,<span class="string">'m'</span>])</span><br><span class="line">x, y</span><br><span class="line">(set([<span class="string">'a'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'m'</span>]), set([<span class="string">'a'</span>, <span class="string">'h'</span>, <span class="string">'m'</span>]))</span><br></pre></td></tr></table></figure><p>再来些小应用。<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; &gt; x &amp; y <span class="comment"># 交集</span></span><br><span class="line">&gt; &gt; &gt; set([<span class="string">'a'</span>, <span class="string">'m'</span>])</span><br><span class="line"></span><br><span class="line">&gt; &gt; &gt; x | y <span class="comment"># 并集</span></span><br><span class="line">&gt; &gt; &gt; set([<span class="string">'a'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'m'</span>])</span><br><span class="line"></span><br><span class="line">&gt; &gt; &gt; x - y <span class="comment"># 差集</span></span><br><span class="line">&gt; &gt; &gt; set([<span class="string">'p'</span>, <span class="string">'s'</span>])</span><br></pre></td></tr></table></figure><p>记得以前个网友提问怎么去除海量列表里重复元素，用hash来解决也行，只不过感觉在性能上不是很高，用set解决还是很不错的，示例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>,<span class="number">11</span>,<span class="number">22</span>]</span><br><span class="line">b = set(a)</span><br><span class="line">b</span><br><span class="line">set([<span class="number">33</span>, <span class="number">11</span>, <span class="number">44</span>, <span class="number">22</span>])</span><br><span class="line">c = [i <span class="keyword">for</span> i <span class="keyword">in</span> b]</span><br><span class="line">c</span><br><span class="line">[<span class="number">33</span>, <span class="number">11</span>, <span class="number">44</span>, <span class="number">22</span>]</span><br></pre></td></tr></table></figure><p>很酷把，几行就可以搞定。</p><h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>集合用于包含一组无序的对象。要创建集合，可使用set()函数并像下面这样提供一系列的项：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = set([<span class="number">3</span>,<span class="number">5</span>,<span class="number">9</span>,<span class="number">10</span>])      <span class="comment">#创建一个数值集合</span></span><br><span class="line">t = set(<span class="string">"Hello"</span>)         <span class="comment">#创建一个唯一字符的集合</span></span><br></pre></td></tr></table></figure><p>与列表和元组不同，集合是无序的，也无法通过数字进行索引。此外，集合中的元素不能重复。例如，如果检查前面代码中t集合的值，结果会是:</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; &gt; t</span><br><span class="line">set([<span class="string">'H'</span>, <span class="string">'e'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>])</span><br></pre></td></tr></table></figure><p>注意只出现了一个’l’。</p><p>集合支持一系列标准操作，包括并集、交集、差集和对称差集，例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = t | s          <span class="comment"># t 和 s的并集</span></span><br><span class="line">b = t &amp; s          <span class="comment"># t 和 s的交集</span></span><br><span class="line">c = t – s          <span class="comment"># 求差集（项在t中，但不在s中）</span></span><br><span class="line">d = t ^ s          <span class="comment"># 对称差集（项在t或s中，但不会同时出现在二者中）</span></span><br></pre></td></tr></table></figure><p>基本操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t.add(<span class="string">'x'</span>)            <span class="comment"># 添加一项</span></span><br><span class="line"></span><br><span class="line">s.update([<span class="number">10</span>,<span class="number">37</span>,<span class="number">42</span>])  <span class="comment"># 在s中添加多项</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">t.remove(<span class="string">'H'</span>)</span><br><span class="line"><span class="comment"># 使用remove()可以删除一项：</span></span><br><span class="line"></span><br><span class="line">len(s)</span><br><span class="line"><span class="comment"># set 的长度</span></span><br><span class="line"></span><br><span class="line">x <span class="keyword">in</span> s</span><br><span class="line"><span class="comment"># 测试 x 是否是 s 的成员</span></span><br><span class="line"></span><br><span class="line">x <span class="keyword">not</span> <span class="keyword">in</span> s</span><br><span class="line"><span class="comment"># 测试 x 是否不是 s 的成员</span></span><br><span class="line"></span><br><span class="line">s.issubset(t)</span><br><span class="line">s &lt;= t</span><br><span class="line"><span class="comment"># 测试是否 s 中的每一个元素都在 t 中</span></span><br><span class="line"></span><br><span class="line">s.issuperset(t)</span><br><span class="line">s &gt;= t</span><br><span class="line"><span class="comment"># 测试是否 t 中的每一个元素都在 s 中</span></span><br><span class="line"></span><br><span class="line">s.union(t)</span><br><span class="line">s | t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 和 t 中的每一个元素</span></span><br><span class="line"></span><br><span class="line">s.intersection(t)</span><br><span class="line">s &amp; t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 和 t 中的公共元素</span></span><br><span class="line"></span><br><span class="line">s.difference(t)</span><br><span class="line">s - t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 中有但是 t 中没有的元素</span></span><br><span class="line"></span><br><span class="line">s.symmetric_difference(t)</span><br><span class="line">s ^ t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 和 t 中不重复的元素</span></span><br><span class="line"></span><br><span class="line">s.copy()</span><br><span class="line"><span class="comment"># 返回 set “s”的一个浅复制</span></span><br></pre></td></tr></table></figure><blockquote><p>请注意：union(), intersection(), difference() 和 symmetric_difference() 的非运算符（non-operator，就是形如 s.union()这样的）版本将会接受任何 iterable 作为参数。相反，它们的运算符版本（operator based counterparts）要求参数必须是 sets。这样可以避免潜在的错误，如：为了更可读而使用 set(‘abc’) &amp; ‘cbs’ 来替代 set(‘abc’).intersection(‘cbs’)。从 2.3.1 版本中做的更改：以前所有参数都必须是 sets。</p><p>另外，Set 和 ImmutableSet 两者都支持 set 与 set 之间的比较。两个 sets 在也只有在这种情况下是相等的：每一个 set 中的元素都是另一个中的元素（二者互为subset）。一个 set 比另一个 set 小，只有在第一个 set 是第二个 set 的 subset 时（是一个 subset，但是并不相等）。一个 set 比另一个 set 打，只有在第一个 set 是第二个 set 的 superset 时（是一个 superset，但是并不相等）</p></blockquote><p><strong>子 set 和相等比较并不产生完整的排序功能。例如：任意两个 sets 都不相等也不互为子 set，因此以下的运算都会返回 False：a&lt;b, a==b, 或者a&gt;b。因此，sets 不提供 <strong>cmp</strong> 方法。</strong></p><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">hash(s)</span><br><span class="line"><span class="comment"># 返回 s 的 hash 值</span></span><br><span class="line"></span><br><span class="line">s.update(t)</span><br><span class="line">s |= t</span><br><span class="line"><span class="comment"># 返回增加了 set “t”中元素后的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.intersection_update(t)</span><br><span class="line">s &amp;= t</span><br><span class="line"><span class="comment"># 返回只保留含有 set “t”中元素的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.difference_update(t)</span><br><span class="line">s -= t</span><br><span class="line"><span class="comment"># 返回删除了 set “t”中含有的元素后的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.symmetric_difference_update(t)</span><br><span class="line">s ^= t</span><br><span class="line"><span class="comment"># 返回含有 set “t”或者 set “s”中有而不是两者都有的元素的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.add(x)</span><br><span class="line"><span class="comment"># 向 set “s”中增加元素 x</span></span><br><span class="line"></span><br><span class="line">s.remove(x)</span><br><span class="line"><span class="comment"># 从 set “s”中删除元素 x, 如果不存在则引发 KeyError</span></span><br><span class="line"></span><br><span class="line">s.discard(x)</span><br><span class="line"><span class="comment"># 如果在 set “s”中存在元素 x, 则删除</span></span><br><span class="line"></span><br><span class="line">s.pop()</span><br><span class="line"><span class="comment"># 删除并且返回 set “s”中的一个不确定的元素, 如果为空则引发 KeyError，随机删除并打印</span></span><br><span class="line"></span><br><span class="line">s.clear()</span><br><span class="line"><span class="comment"># 删除 set “s”中的所有元素</span></span><br></pre></td></tr></table></figure><blockquote><p>请注意：非运算符版本的 update(), intersection_update(), difference_update()和symmetric_difference_update()将会接受任意 iterable 作为参数。从 2.3.1 版本做的更改：以前所有参数都必须是 sets。</p><p>还请注意：这个模块还包含一个 union_update() 方法，它是 update() 方法的一个别名。包含这个方法是为了向后兼容。程序员们应该多使用 update() 方法，因为这个方法也被内置的 set() 和 frozenset() 类型支持。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_list或dict合并</title>
      <link href="/passages/Python-list%E6%88%96dict%E5%90%88%E5%B9%B6/"/>
      <url>/passages/Python-list%E6%88%96dict%E5%90%88%E5%B9%B6/</url>
      
        <content type="html"><![CDATA[<h3 id="对于两个list、两个dict合并数据"><a href="#对于两个list、两个dict合并数据" class="headerlink" title="对于两个list、两个dict合并数据"></a>对于两个list、两个dict合并数据</h3><h4 id="1-两个字典："><a href="#1-两个字典：" class="headerlink" title="1.两个字典："></a>1.两个字典：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a= &#123;<span class="string">'a'</span>:<span class="number">1</span>,<span class="string">'b'</span>:<span class="number">2</span>,<span class="string">'c'</span>:<span class="number">3</span>&#125; </span><br><span class="line">b= &#123;<span class="string">'aa'</span>:<span class="number">11</span>,<span class="string">'bb'</span>:<span class="number">22</span>,<span class="string">'cc'</span>:<span class="number">33</span>&#125;</span><br></pre></td></tr></table></figure><p>合并1：dict(a,**b)  操作如下：<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = dict(a,**b)</span><br></pre></td></tr></table></figure><p>合并2：dict(a.items()+b.items())  如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = dict(a.item() + b.items())</span><br></pre></td></tr></table></figure><p>合并3：c = {}  c.update(a)  c.update(b) 输出c 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c = &#123;&#125;</span><br><span class="line">c.update(a)</span><br><span class="line">c.update(b)</span><br></pre></td></tr></table></figure><h3 id="2-两个list合并："><a href="#2-两个list合并：" class="headerlink" title="2.两个list合并："></a>2.两个list合并：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>] </span><br><span class="line">b = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>]</span><br></pre></td></tr></table></figure><p>合并1：a+b 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = a+b</span><br></pre></td></tr></table></figure><p>合并2：a+=b 这时a的值变成了合并后的结果，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a += b  <span class="comment"># ====&gt; a = a+b</span></span><br></pre></td></tr></table></figure><p>合并3：a.extend(b) 和+=结果一样，输出a  如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.extend(b) <span class="comment"># a += b</span></span><br></pre></td></tr></table></figure><p>合并4：a.append(b)将b看成list一个元素和a合并成一个新的list，合并后的结果输入a 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.append(b) <span class="comment"># list add other list &gt;&gt; [1,2,3,[1,2,3]]</span></span><br></pre></td></tr></table></figure><p> 合并5：a[0:0] = b 使用切片，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="number">0</span>:<span class="number">0</span>] = b</span><br></pre></td></tr></table></figure><blockquote><p>附录：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># 方法一：</span></span><br><span class="line">&gt; list1 = [<span class="string">'k1'</span>,<span class="string">'k2'</span>,<span class="string">'k3'</span>]</span><br><span class="line">&gt; list2 = [<span class="string">'v1'</span>,<span class="string">'v2'</span>,<span class="string">'v3'</span>]</span><br><span class="line">&gt; dic = dict(map(<span class="keyword">lambda</span> x,y:[x,y],list1,list2))</span><br><span class="line">&gt; &gt;&gt;&gt; print(dic)</span><br><span class="line">&gt; &#123;<span class="string">'k3'</span>: <span class="string">'v3'</span>, <span class="string">'k2'</span>: <span class="string">'v2'</span>, <span class="string">'k1'</span>: <span class="string">'v1'</span>&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment"># 方法二：</span></span><br><span class="line">&gt; &gt;&gt;&gt; dict(zip(list1,list2))</span><br><span class="line">&gt; &#123;<span class="string">'k3'</span>: <span class="string">'v3'</span>, <span class="string">'k2'</span>: <span class="string">'v2'</span>, <span class="string">'k1'</span>: <span class="string">'v1'</span>&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment"># 方法三：</span></span><br><span class="line">&gt; &gt;&gt;&gt; l1=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line">&gt; &gt;&gt;&gt; l2=[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]</span><br><span class="line">&gt; &gt;&gt;&gt; &#123;k:v <span class="keyword">for</span> k,v <span class="keyword">in</span> zip(l1,l2)&#125;</span><br><span class="line">&gt; &#123;<span class="number">1</span>: <span class="number">4</span>, <span class="number">2</span>: <span class="number">5</span>, <span class="number">3</span>: <span class="number">6</span>, <span class="number">4</span>: <span class="number">7</span>, <span class="number">5</span>: <span class="number">8</span>, <span class="number">6</span>: <span class="number">9</span>&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; &gt;&gt;&gt; x = &#123;<span class="number">1</span>: <span class="number">4</span>, <span class="number">2</span>: <span class="number">5</span>, <span class="number">3</span>: <span class="number">6</span>, <span class="number">4</span>: <span class="number">7</span>, <span class="number">5</span>: <span class="number">8</span>, <span class="number">6</span>: <span class="number">9</span>&#125;</span><br><span class="line">&gt; &gt;&gt;&gt; &#123;v:k <span class="keyword">for</span> k,v <span class="keyword">in</span> x.items()&#125;            <span class="comment">#反过来 将字典中的v和k调换</span></span><br><span class="line">&gt; &#123;<span class="number">4</span>: <span class="number">1</span>, <span class="number">5</span>: <span class="number">2</span>, <span class="number">6</span>: <span class="number">3</span>, <span class="number">7</span>: <span class="number">4</span>, <span class="number">8</span>: <span class="number">5</span>, <span class="number">9</span>: <span class="number">6</span>&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote></blockquote>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_list交集、差集和并集</title>
      <link href="/passages/Python-list%E4%BA%A4%E9%9B%86%E3%80%81%E5%B7%AE%E9%9B%86%E5%92%8C%E5%B9%B6%E9%9B%86/"/>
      <url>/passages/Python-list%E4%BA%A4%E9%9B%86%E3%80%81%E5%B7%AE%E9%9B%86%E5%92%8C%E5%B9%B6%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<blockquote><p>举例说明</p></blockquote><p>a_list = [1,2,3,4]<br>b_list = [1,4,5]</p><h3 id="一-差集"><a href="#一-差集" class="headerlink" title="一. 差集"></a>一. 差集</h3><p>很明显结果是[2,3,5]，下面我们说一下具体方法。<a id="more"></a><br>方法a.正常法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ret_list = []</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> a_list:</span><br><span class="line">    <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> b_list:</span><br><span class="line">        ret_list.append(item)</span><br></pre></td></tr></table></figure><p>方法b.简化版：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = [item <span class="keyword">for</span> item <span class="keyword">in</span> a_list <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> b_list]</span><br></pre></td></tr></table></figure><p>方法c.高级版：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = list(set(a_list)^set(b_list))</span><br></pre></td></tr></table></figure><h3 id="二-并集"><a href="#二-并集" class="headerlink" title="二. 并集"></a>二. 并集</h3><p>很明显结果是[1,2,3,4,5],下面是具体方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = list(set(a_list).union(set(b_list)))</span><br></pre></td></tr></table></figure><h3 id="三-交集"><a href="#三-交集" class="headerlink" title="三. 交集"></a>三. 交集</h3><p>很明显结果是[1,4]，下面是具体方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = list( ( set(a_list).union(set(b_list)) )^( set(a_list)^set(b_list) ) )</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_问题小结(2)</title>
      <link href="/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-2/"/>
      <url>/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>环境：未特别注明的话，均为Python 3.6.5，IDE：VS code</p><p>遇到的都是基础问题，分了两篇。</p><p>担心一篇写多了会看不下去</p><p><a href="https://blog.csdn.net/xinzechen/article/details/89446322" target="_blank" rel="noopener">https://blog.csdn.net/xinzechen/article/details/89446322</a>  vscode的问题</p></blockquote><h2 id="『1』关于python无法显示中文的问题：SyntaxError-Non-ASCII-character-‘-xe4’-in-file-test-py-on-line-3-but-no-encoding-declared。"><a href="#『1』关于python无法显示中文的问题：SyntaxError-Non-ASCII-character-‘-xe4’-in-file-test-py-on-line-3-but-no-encoding-declared。" class="headerlink" title="『1』关于python无法显示中文的问题：SyntaxError: Non-ASCII character ‘\xe4’ in file test.py on line 3, but no encoding declared。"></a>『1』关于python无法显示中文的问题：SyntaxError: Non-ASCII character ‘\xe4’ in file test.py on line 3, but no encoding declared。</h2><p>python：2.7.15</p><p>解决办法：  在以后的每一个需要显示汉字的python文件中， 可以采用如下方法在 #!/usr/bin/python的下一行加上一句话来定义编码格式， 我以utf-8编码为例。<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 第一种：</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 第二种：</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 第三种：</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#vim: set fileencoding:utf-8</span></span><br></pre></td></tr></table></figure><h2 id="『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文"><a href="#『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文" class="headerlink" title="『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文"></a>『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文</h2><p>解决:</p><p>“反编码”我自己起的名字，大概意思就是我得到一串字符，是unicode码，如：‘\u53eb\u6211’，进行反编码后得到其对应的汉字。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="string">'\u53eb\u6211'</span></span><br><span class="line"><span class="keyword">print</span> f</span><br><span class="line">print(f.decode(<span class="string">'unicode-escape'</span>))</span><br><span class="line"></span><br><span class="line">list_words为列表类型</span><br><span class="line">str(list_words).decode( <span class="string">'string_escape'</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">list_words = [ <span class="string">'你'</span>, <span class="string">'我'</span>, <span class="string">'他'</span> ]</span><br><span class="line">print( list_words )                                        </span><br><span class="line">print( str(list_words).decode( <span class="string">'string_escape'</span> ) )         <span class="comment"># 正常显示汉字（可靠性不高，原因尚不明确）</span></span><br><span class="line"> </span><br><span class="line">list_words_result = json.dumps( list_words, encoding=<span class="string">'UTF-8'</span>, ensure_ascii=<span class="literal">False</span> )   <span class="comment"># 正常显示汉字 （经实验可靠性较高）</span></span><br></pre></td></tr></table></figure><p>结果为: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\u53eb\u6211 </span><br><span class="line">叫我</span><br></pre></td></tr></table></figure><h2 id="『3』在编译时会出现这样的错：IndentationError-expected-an-indented-block"><a href="#『3』在编译时会出现这样的错：IndentationError-expected-an-indented-block" class="headerlink" title="『3』在编译时会出现这样的错：IndentationError:expected an indented block"></a>『3』在编译时会出现这样的错：<strong>IndentationError:expected an indented block</strong></h2><p>说明此处需要缩进，你只要在出现错误的那一行，按空格或Tab（但不能混用）键缩进就行。</p><h2 id="『4』SyntaxError-invalid-syntax-：语法错误。"><a href="#『4』SyntaxError-invalid-syntax-：语法错误。" class="headerlink" title="『4』SyntaxError:invalid syntax ：语法错误。"></a>『4』<strong>SyntaxError:invalid syntax</strong> ：语法错误。</h2><p>最常见的，最基础的错误</p><p>英文是“非法语句”的意思。漏标点符号（例如漏分号，漏&amp;号），多标点符号，拼写错，等等都会造成这种错</p><h2 id="『5』url连接超时解决："><a href="#『5』url连接超时解决：" class="headerlink" title="『5』url连接超时解决："></a>『5』<strong>url连接超时解决</strong>：</h2><p>1）使用的是urllib不是urllib2，所以无法直接在urlopen里面加timeout参数，只能是设置全局脚本的超时时间</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">socket.setdefaulttimeout(<span class="number">60</span>)</span><br></pre></td></tr></table></figure><p>设置全局的超时时间为60s。</p><p>2）urllib，urllib2常会一起使用（两者分别提供不同的功能）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">html = urllib.urlopen(url).read()</span><br><span class="line"><span class="comment"># 修改为</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">html = urllib2.urlopen(url, timeout=<span class="number">60</span>).read()</span><br></pre></td></tr></table></figure><h2 id="『6』UnboundLocalError-local-variable-‘appname’-referenced-before-assignment："><a href="#『6』UnboundLocalError-local-variable-‘appname’-referenced-before-assignment：" class="headerlink" title="『6』UnboundLocalError: local variable ‘appname’ referenced before assignment："></a>『6』<strong>UnboundLocalError: local variable ‘appname’ referenced before assignment：</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;u&apos;batchrealnameverifytask&apos;: 99.41, u&apos;bptask100000188408&apos;: 98.77, u&apos;clsexpflowmaintask576&apos;: 101.28&#125;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;get_app_cpu_from_influxdb.py&quot;, line 89, in &lt;module&gt;</span><br><span class="line">    appname = get_sql_info(key)</span><br><span class="line">  File &quot;get_app_cpu_from_influxdb.py&quot;, line 28, in get_sql_info</span><br><span class="line">    return appname</span><br></pre></td></tr></table></figure><p>变量问题：变量在被赋值之前被使用定义</p><h2 id="『7』TypeError-sequence-item-1-expected-string-or-Unicode-NoneType-found"><a href="#『7』TypeError-sequence-item-1-expected-string-or-Unicode-NoneType-found" class="headerlink" title="『7』TypeError: sequence item 1: expected string or Unicode, NoneType found"></a>『7』<strong>TypeError: sequence item 1: expected string or Unicode, NoneType found</strong></h2><p>期望值未发现：str或者unicode类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">message = <span class="string">u"应用的CPU利用率超过%s,请检查应用:%s"</span>%(str(threshold)+<span class="string">'%'</span>,<span class="string">","</span>.join(app_name))</span><br><span class="line"></span><br><span class="line"><span class="comment"># =====================&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"></span><br><span class="line">message = <span class="string">"应用的CPU利用率超过%s,请检查应用:%s"</span>%(str(threshold)+<span class="string">'%'</span>,<span class="string">","</span>.join(app_name))</span><br></pre></td></tr></table></figure><h2 id="『8』UnicodeDecodeError-‘ascii’-codec-can’t-decode-byte-0xe5-in-position-1-ordinal-not-in-range-128"><a href="#『8』UnicodeDecodeError-‘ascii’-codec-can’t-decode-byte-0xe5-in-position-1-ordinal-not-in-range-128" class="headerlink" title="『8』UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xe5 in position 1: ordinal not in range(128)"></a>『8』<strong>UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xe5 in position 1: ordinal not in range(128)</strong></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关于编码问题：</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding( <span class="string">"utf-8"</span> )</span><br></pre></td></tr></table></figure><h2 id="『9』IndentationError-unindent-does-not-match-any-outer-indentation-level"><a href="#『9』IndentationError-unindent-does-not-match-any-outer-indentation-level" class="headerlink" title="『9』IndentationError: unindent does not match any outer indentation level"></a>『9』<strong>IndentationError: unindent does not match any outer indentation level</strong></h2><p>【问题】</p><p>一个python脚本，本来都运行好好的，然后写了几行代码，而且也都确保每行都对齐了，但是运行的时候，却出现语法错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IndentationError: unindent does not match any outer indentation level</span><br></pre></td></tr></table></figure><p>【解决过程】</p><p>1.对于此错误，最常见的原因是，的确没有对齐。但是我根据错误提示的行数，去代码中看了下，没啥问题啊。</p><p>都是用TAB键，对齐好了的，没有不对齐的行数啊。</p><p>2.以为是前面的注释的内容影响后面的语句的语法了，所以把前面的注释也删除了。</p><p>结果还是此语法错误。</p><p>3.后来折腾了半天，突然想到了，把当前python脚本的所有字符都显示出来看看有没有啥特殊的字符。tab与空格混用了</p><h2 id="『10』request-https报错："><a href="#『10』request-https报错：" class="headerlink" title="『10』request  https报错："></a>『10』<strong>request  https报错：</strong></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  忽略警告：InsecureRequestWarning: Unverified HTTPS request is being made. Adding certificate verification is strongly advised.</span></span><br><span class="line">requests.packages.urllib3.disable_warnings(）</span><br></pre></td></tr></table></figure><h2 id="『11』python安装MySQLdb的时候一直有问题"><a href="#『11』python安装MySQLdb的时候一直有问题" class="headerlink" title="『11』python安装MySQLdb的时候一直有问题"></a>『11』<strong>python安装MySQLdb的时候一直有问题</strong></h2><p>在Linux下 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install MySQL-python</span><br></pre></td></tr></table></figure><p>如果安装之后仍不能正常运行，尝试用yum install MySQL-python，因为这个模块需要一些第三方程序来运行的。 </p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_问题小结(1)</title>
      <link href="/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-1/"/>
      <url>/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>环境：未特别注明的话，均为Python 3.6.5，IDE：VS code</p></blockquote><h2 id="『1』TypeError-unbound-method-问题"><a href="#『1』TypeError-unbound-method-问题" class="headerlink" title="『1』TypeError: unbound method 问题"></a>『1』TypeError: unbound method 问题</h2><p>今天执行了下之前写的Python接口文件，源码如下:<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">'Administrator'</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> readData <span class="keyword">import</span> dictionary</span><br><span class="line">readIt = &#123;&#125;</span><br><span class="line">readIt = dictionary.onlyCellValue(<span class="string">"E:\python\API\eadData.xls"</span>, <span class="string">"Sheet1"</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> readIt</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> readIt:</span><br><span class="line">    temp_list = readIt[key]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(temp_list)):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"第"</span>+(i+<span class="number">1</span>)+<span class="string">"个参数为"</span>+temp_list[i]</span><br></pre></td></tr></table></figure><p>在运行时报错：TypeError: unbound method onlyCellValue() must be called with dictionary instance as first argument (got str instance instead)，后经在网上查看，发现时由于调用其他类时，未在后面添加括号，添加括号后，运行正常。这是由于未添加括号情况下，未被认为是类的实例，故报此错；</p><blockquote><p>改正后的：readIt = dictionary().onlyCellValue(“E:\python\API\eadData.xls”, “Sheet1”, 1)</p></blockquote><h2 id="『2』Python访问MySQL"><a href="#『2』Python访问MySQL" class="headerlink" title="『2』Python访问MySQL"></a>『2』Python访问MySQL</h2><p>听说很多人都使用著名的<a href="http://sourceforge.net/projects/mysql-python/" target="_blank" rel="noopener">MySQLdb</a>来访问MySQL(当然还有pymysql)，但是它并不支持Python 3.x的版本。所以要另寻出路。那就是<a href="https://pypi.python.org/pypi/mysql-connector-python" target="_blank" rel="noopener">mysql-connector-python</a>，这个貌似是MySQL官方提供的，并且它不依赖于MySQL C客户端library，我下载的是1.1.4版本，下载解压之后，会看到setup.py文件，这样安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python3.2 setup.py install</span><br></pre></td></tr></table></figure><p>然后在程序中就可以用了。<br>下面给出一段查询MySQL记录的示例代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mysql.connector</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"> </span><br><span class="line">__author__ = <span class="string">'codelast'</span></span><br><span class="line"> </span><br><span class="line">username = <span class="string">'root'</span></span><br><span class="line">password = <span class="string">'xxx'</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">db = <span class="string">'mydb'</span></span><br><span class="line"> </span><br><span class="line">connection = mysql.connector.connect(user=username, password=password, host=host, database=db)</span><br><span class="line">cursor = connection.cursor()</span><br><span class="line"> </span><br><span class="line">sql = <span class="string">"SELECT * FROM my_table WHERE id = 9"</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 打印查询到的记录的行数</span></span><br><span class="line">    data = cursor.fetchall()</span><br><span class="line">    print(len(data))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 输出所有记录</span></span><br><span class="line">    <span class="keyword">for</span> (ID, name) <span class="keyword">in</span> data:</span><br><span class="line">        print(<span class="string">"name:[%s]"</span> % (name))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">except</span> mysql.connector.Error <span class="keyword">as</span> err:</span><br><span class="line">    print(<span class="string">"Failed to query table, detail: &#123;&#125;"</span>.format(err.msg))</span><br><span class="line">    sys.exit()</span><br><span class="line"> </span><br><span class="line">connection.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure><p>上面的代码很简单，无非就是从my_table表里查询一些记录，再打印出来。<br>注意 for (ID, name) 中的括号里要写全该表中，你查询的所有字段名，否则会报错。还有其他遍历查询结果的方法，后面会继续陈述。</p><h2 id="『3』逆序遍历list"><a href="#『3』逆序遍历list" class="headerlink" title="『3』逆序遍历list"></a>『3』逆序遍历list</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myList = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> reversed(myList):</span><br><span class="line">    print(item)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>注意是 reversed 不是 reverse。这只是逆序遍历，myList中的数据顺序并不会改变。</p><h2 id="『4』使用MySQLdb访问数据库时，“TypeError-execute-takes-at-most-3-arguments-4-given-”错误的解决办法"><a href="#『4』使用MySQLdb访问数据库时，“TypeError-execute-takes-at-most-3-arguments-4-given-”错误的解决办法" class="headerlink" title="『4』使用MySQLdb访问数据库时，“TypeError: execute() takes at most 3 arguments (4 given)”错误的解决办法"></a>『4』使用MySQLdb访问数据库时，“TypeError: execute() takes at most 3 arguments (4 given)”错误的解决办法</h2><p>Python版本：2.7.3<br>使用2.7.3版本的Python时，访问MySQL的最佳方案应该数使用<a href="http://sourceforge.net/projects/mysql-python/" target="_blank" rel="noopener">MySQLdb</a>了。<br>如果在执行SQL时，你遇到了上面所说的问题，那么你可能是像下面这样写导致的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">"INSERT INTO my_table (field1, field2) VALUES (%s, %s)"</span></span><br><span class="line">cursor.execute(sql, <span class="string">"a"</span>, <span class="string">"b"</span>)</span><br></pre></td></tr></table></figure><p>这是错误的，其实这货根本不是这样用的，当参数多于一个时，你要把它们放在一个tuple里传进去：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">"INSERT INTO my_table (field1, field2) VALUES (%s, %s)"</span></span><br><span class="line">cursor.execute(sql, (<span class="string">"a"</span>, <span class="string">"b"</span>))</span><br></pre></td></tr></table></figure><p>例如<a href="http://stackoverflow.com/questions/17505067/mysql-and-python-execution-only-takes-3-arguments-4-given" target="_blank" rel="noopener">这个</a>链接有个例子。</p><h2 id="『5』使用-lxml-库生成XML（字符串）"><a href="#『5』使用-lxml-库生成XML（字符串）" class="headerlink" title="『5』使用 lxml 库生成XML（字符串）"></a>『5』使用 lxml 库生成XML（字符串）</h2><p>Python版本：2.7.3<br>直接看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:UTF-8</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">XML生成器。文件名：xmlGenerator.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"> </span><br><span class="line">__author__ = <span class="string">'Darran Zhang @ codelast.com'</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XMLGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_xml</span><span class="params">(self)</span>:</span></span><br><span class="line">        commands = etree.Element(<span class="string">'Commands'</span>)</span><br><span class="line">        command = etree.SubElement(commands, <span class="string">'Command'</span>)</span><br><span class="line">        from_user = etree.SubElement(command, <span class="string">'FromUser'</span>)</span><br><span class="line">        from_user.text = <span class="string">u'abc'</span></span><br><span class="line">        cmd = etree.SubElement(command, <span class="string">'Cmd'</span>)</span><br><span class="line">        cmd.text = <span class="string">u'mmmmmmmmmmmmmm'</span></span><br><span class="line">        cmd_extra_data = etree.SubElement(command, <span class="string">'CmdExtraData'</span>)</span><br><span class="line">        cmd_extra_data.text = <span class="string">u'eeeeeeeeee'</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> etree.tostring(commands, pretty_print=<span class="literal">True</span>, xml_declaration=<span class="literal">True</span>, encoding=<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlGenerator <span class="keyword">import</span> XMLGenerator</span><br><span class="line"> </span><br><span class="line">xmlGen = XMLGenerator()</span><br><span class="line">print(xmlGen.generate_xml())</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;Commands&gt;</span><br><span class="line">  &lt;Command&gt;</span><br><span class="line">    &lt;FromUser&gt;abc&lt;/FromUser&gt;</span><br><span class="line">    &lt;Cmd&gt;mmmmmmmmmmmmmm&lt;/Cmd&gt;</span><br><span class="line">    &lt;CmdExtraData&gt;eeeeeeeeee&lt;/CmdExtraData&gt;</span><br><span class="line">  &lt;/Command&gt;</span><br><span class="line">&lt;/Commands&gt;</span><br></pre></td></tr></table></figure><p>可见非常简单。</p><h2 id="『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法"><a href="#『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法" class="headerlink" title="『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法"></a>『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法</h2><p>在PyCharm中可以直接搜索Python package并安装，我遇到的一个问题是：无法安装，错误提示的其中一段为：</p><blockquote><p>EnvironmentError: mysql_config not found</p></blockquote><p>你需要保证你的Ubuntu已经安装了以下这些东西：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server mysql-client libmysqlclient-dev</span><br></pre></td></tr></table></figure><p>然后再试，一切OK。</p><h2 id="『7』”ValueError-zero-length-field-name-in-format”错误的解决办法"><a href="#『7』”ValueError-zero-length-field-name-in-format”错误的解决办法" class="headerlink" title="『7』”ValueError: zero length field name in format”错误的解决办法"></a>『7』”ValueError: zero length field name in format”错误的解决办法</h2><p>Python版本：2.6.6<br>错误出在如下语句：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&#123;&#125;\t&#123;&#125;"</span>.format(<span class="number">123</span>, <span class="number">456</span>)</span><br></pre></td></tr></table></figure><p>我遇到的出问题的Python版本为2.6.6（不知道是不是2.6.*及低版本都有此问题），反正Python 2.7.3就没有这个问题了。<br>上面的代码无非主就是把123和456代替两个大括号。在旧版本的Python上（具体从哪个版本开始不用这样写，我不确定），你要有多个需要format的field时，需要指定它们的顺序：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&#123;0&#125;\t&#123;1&#125;"</span>.format(<span class="number">123</span>, <span class="number">456</span>)</span><br></pre></td></tr></table></figure><p>这样就没问题了。</p><h2 id="『8』对一个字典-dict-，按value进行排序"><a href="#『8』对一个字典-dict-，按value进行排序" class="headerlink" title="『8』对一个字典(dict)，按value进行排序"></a>『8』对一个字典(dict)，按value进行排序</h2><p>Python版本：2.6.6，2.6.9均测试可用（Python3里没有cmp方法了，所以不能用）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sortedList = sorted(myDict.items(), <span class="keyword">lambda</span> x, y: cmp(x[<span class="number">1</span>], y[<span class="number">1</span>]), reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">for</span> (k, v) <span class="keyword">in</span> sortedList:</span><br><span class="line">    print(<span class="string">"&#123;0&#125;\t&#123;1&#125;"</span>.format(k,v))</span><br></pre></td></tr></table></figure><p>其中，myDict是你要将其排序的字典，sortedList是排序之后的结果，变成了一个list，里面是若干个tuple，每个tuple里是一对(key,value)，所以后面用那样的方式对它进行了遍历。</p><h2 id="『9』判断一个字典（dict）中是否包含指定的key"><a href="#『9』判断一个字典（dict）中是否包含指定的key" class="headerlink" title="『9』判断一个字典（dict）中是否包含指定的key"></a>『9』判断一个字典（dict）中是否包含指定的key</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d = dict()</span><br><span class="line"><span class="comment"># 向字典中添加两个元素</span></span><br><span class="line">d[<span class="number">1</span>] = <span class="string">'abc'</span></span><br><span class="line">d[<span class="number">2</span>] = <span class="string">'def'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 检查 3 这个key是否在字典中，结果输出的是“NO”</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">3</span> <span class="keyword">in</span> d:</span><br><span class="line">    print(<span class="string">'YES'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'NO'</span>)</span><br></pre></td></tr></table></figure><h2 id="『10』Python正则简单示例"><a href="#『10』Python正则简单示例" class="headerlink" title="『10』Python正则简单示例"></a>『10』Python正则简单示例</h2><p>先看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">'String url = "http://item.jd.com/1148104.html?erpad_source=abc";'</span></span><br><span class="line">pattern = re.compile(<span class="string">'.*\"(.*)\"'</span>)</span><br><span class="line">match = pattern.match(code)</span><br><span class="line"><span class="keyword">if</span> match:</span><br><span class="line">    print(match.group(<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://item.jd.com/1148104.html?erpad_source=abc</span><br></pre></td></tr></table></figure><p>说明：上面的代码是想把字符串“code”中的双引号里的那个URL打印出来。正则表达式 .<em>\”(.</em>)\” 中的小括号就是第1个group，匹配上的话可以用 group(1) 获取之。</p><h2 id="『11』try…except的示例参考"><a href="#『11』try…except的示例参考" class="headerlink" title="『11』try…except的示例参考"></a>『11』try…except的示例参考</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:               <span class="comment"># 可能会出现异常的一段代码</span></span><br><span class="line">    command_1   <span class="comment"># 如果command_1出现异常，则不执行command_1以及之后的语句</span></span><br><span class="line">    command_2   <span class="comment"># command_1如果正常，则会执行</span></span><br><span class="line"><span class="keyword">except</span>:         <span class="comment"># try中任意一行语句出现异常，直接跳转至except，程序继续运行</span></span><br><span class="line">    command_3</span><br><span class="line">    command_4</span><br></pre></td></tr></table></figure><h2 id="『』To-be-added…"><a href="#『』To-be-added…" class="headerlink" title="『』To be added…"></a>『』To be added…</h2>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker的问题总结</title>
      <link href="/passages/Docker%E7%9A%84%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"/>
      <url>/passages/Docker%E7%9A%84%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><h4 id="1、Docker18-06-1-ce安装-RHEL7-后启动失败-原因-xfsprogs版本过低"><a href="#1、Docker18-06-1-ce安装-RHEL7-后启动失败-原因-xfsprogs版本过低" class="headerlink" title="1、Docker18.06.1-ce安装(RHEL7)后启动失败, 原因(xfsprogs版本过低)"></a>1、Docker18.06.1-ce安装(RHEL7)后启动失败, 原因(xfsprogs版本过低)</h4><p>* 问题分析: </p><blockquote><p>使用/usr/bin/dockerd启动测试发现是文件系统无法创建 <a id="more"></a></p><p>1 WARN[2018-09-15T10:47:39.886191433+08:00] Usage of loopback devices is strongly discouraged for production use. Please use <code>--storage-opt dm.thinpooldev</code> or use <code>man dockerd</code> to refer to dm.thinpooldev section.  storage-driver=devicemapper </p><p>2 INFO[2018-09-15T10:47:40.220046362+08:00] Creating filesystem xfs on device docker-253:4-17133027-base, mkfs args: [-m crc=0,finobt=0 /dev/mapper/docker-253:4-17133027-base]  storage-driver=devicemapper </p><p>3 INFO[2018-09-15T10:47:40.221230038+08:00] Error while creating filesystem xfs on device docker-253:4-17133027-base: exit status 1  storage-driver=devicemapper </p><p>4 ERRO[2018-09-15T10:47:40.221258767+08:00] [graphdriver] prior storage driver devicemapper failed: exit status 1 </p><p>5 Error starting daemon: error initializing graphdriver: exit status 1 </p><p>第三行日志可以找到mkfs的执行参数, 执行发现参数不正确 </p><p>1 2 INFO[2018-09-15T10:47:40.220046362+08:00] Creating filesystem xfs on device docker-253:4-17133027-base, mkfs args: [-m crc=0,finobt=0 /dev/mapper/docker-253:4-17133027-base]  storage-driver=devicemapper </p></blockquote><p>* 解决问题 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install xfsprogs </span><br><span class="line"><span class="meta">#</span> 但是内核版本过低，操作系统7.0</span><br><span class="line"><span class="meta">#</span> 18.06最好升级系统版本到7.4，只能装会1.12版本,问题来了，私有镜像库登入不了</span><br><span class="line"><span class="meta">#</span> 17.12.0兼容</span><br></pre></td></tr></table></figure><h4 id="2、docker-rm-container-失败"><a href="#2、docker-rm-container-失败" class="headerlink" title="2、docker rm container 失败"></a>2、docker rm container 失败</h4><p>现象：</p><blockquote><p>docker version：17.12.0-ce </p><p>偶尔出现docker跟daemon守护进程失去联系 </p></blockquote><p><img src="data:image/png;base64,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J8872bwTn/b9vprVz5/yVdby7pR01zP3KXN/k+145E4iPUflXaNK/Smq1Bepm7L+umLVpzxlO9KdlDknGyfdSZlzsplY3U95yppVl/JHM/cnnNw52STSvZRNpP1p9gzT86buhpPnpE3KprxQpb6YukaVemXapM4z9ylzf0K6o/LO2W2676+J7vrrilWf8lXW8q5JnWfuVxk8T/q9hs/gt/3ZtfzsG8/g//NTvz/f8bnf8RnvzLv9/J/6/ZzuHuErnz3xU5/bHL0h+mcQ8hte8Qzl5Hknm3fi077fV3L7s0/7qduR7qbM8Y37m2zHI3cS03OmrjnZnDA9J3VT1l9X7HrlZtukOylzTjZOupMy52Qzsbqf8pQ1qy7lj2buTzi5c7JJpHspm0j70+xRds/a9aecPCdtUjblyrSZOudkO21S55n7lLk/YbozdcWuL3rTXxPd9dcVqz7lKWtuO8/crzJ4Hn5fP5d3/rPbKd3Zoff0rKxy+Ief+v35js/9js94Z97t5//U7+d09whf+eyJn/rcprR8Q3SS7k7oO6q0aXnnvGqzQ9V+2pRS57u0SdKdb7276fVc8p33pVXvW9/tePWdqStU7bXr85Q5vnG/y1Rp02rvm85b7W96Zeqa3UbV3jdTXqTOM/V6VlZK22bVu9KmWfWq9r7pvJV6ZbVRtfdN56pd39Je91OW5Ltm1aXcM5d2adP+kU3nqtSfZi3f6PkkU/nmtE+54kqbQrXq+2trtZmylXSj25QX3al80+y6JN+oT5n7lLm0S5v2vmke7Rrd6FnRXM/KSmlbTF0x9anzzP2UtXYbz29RtZ82pdT57nbTuHab9qlz9cZ3mjuu1PlONze4Vr1vbzfelVa9b6fdo6ja+6Zz1cmmNG3a++Y70c/Xc/uV0s7v6Oa02+28b3nnu+4V16r3rfdJvfGt5zeo2u82K1Spb3b9RGvKWnoude+7knerXqXbU1b3VFM25d7rueS77lNetPRcSv0qa+m51L2z61rtfdO5ardp733aOa5V71vfdZ/yRtV+2pS83/Ejb4jqObHri1dtJvx+yzP1KWt5pn6VKd67V3ZdybPJT1nJ8xv6vso3TSt1zdR710pZSzunNXWtaeNZOrcvada5+9Jp70xdM228a2mmXcqbJO/TObHri9aqO8lu8pZmnU9eWXWetzTr/CS7zVPWTF2z2ySl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" alt="img"></p><p>docker rm不掉容器 </p><p>解决方法：docker守护进程重启了，现在只能重启解决 </p><p>链接： <a href="https://github.com/moby/moby/issues/36002" target="_blank" rel="noopener">https://github.com/moby/moby/issues/36002</a></p><h4 id="3、"><a href="#3、" class="headerlink" title="3、"></a>3、</h4><h3 id="指北："><a href="#指北：" class="headerlink" title="指北："></a>指北：</h3><h4 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h4><p><img src="data:image/png;base64,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" alt="img"></p><p>原因：版本不兼容   7.2版本 升级系统7.4可解决</p><h4 id="二、no-matching-entries-in-passwd-file"><a href="#二、no-matching-entries-in-passwd-file" class="headerlink" title="二、no matching entries in passwd file"></a>二、<strong>no matching entries in passwd file</strong></h4><blockquote><p>进不去容器 </p><p>重启docker </p></blockquote><h4 id="三、standard-init-linux-go-195-exec-user-process-caused-“exec-format-error”"><a href="#三、standard-init-linux-go-195-exec-user-process-caused-“exec-format-error”" class="headerlink" title="三、standard_init_linux.go:195: exec user process caused “exec format error”"></a>三、<strong>standard_init_linux.go:195: exec user process caused “exec format error”</strong></h4><blockquote><p>进不去容器； </p><p>启动脚本错误 </p><p>启动脚本=======》 #！/bin/bash </p></blockquote><h4 id="四、内核：enterd-disabled-state"><a href="#四、内核：enterd-disabled-state" class="headerlink" title="四、内核：enterd disabled state"></a>四、内核：<strong>enterd disabled state</strong></h4><blockquote><p>被禁用状态 </p><p>主机内核有问题 </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Docker_problem </tag>
            
            <tag> Docker的一些东西 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安静写点东西</title>
      <link href="/passages/%E5%AE%89%E9%9D%99%E5%86%99%E7%82%B9%E4%B8%9C%E8%A5%BF/"/>
      <url>/passages/%E5%AE%89%E9%9D%99%E5%86%99%E7%82%B9%E4%B8%9C%E8%A5%BF/</url>
      
        <content type="html"><![CDATA[<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><div id="hbe-security">  <div class="hbe-input-container">  <input type="password" class="hbe-form-control" id="pass" placeholder="Come on ٩(๑.◡.๑)۶ ，Please ecter Password (*ﾉ▽ﾉ)." />    <label for="pass">Come on ٩(๑.◡.๑)۶ ，Please ecter Password (*ﾉ▽ﾉ).</label>    <div class="bottom-line"></div>  </div></div><div id="decryptionError" style="display: none;">Incorrect Password!</div><div id="noContentError" style="display: none;">No content to display!</div><div id="encrypt-blog" style="display:none">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</div><script src="/lib/crypto-js.js"></script><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 生活需要一点方式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes_填坑</title>
      <link href="/passages/Kubernetes-%E5%A1%AB%E5%9D%91/"/>
      <url>/passages/Kubernetes-%E5%A1%AB%E5%9D%91/</url>
      
        <content type="html"><![CDATA[<h2 id="更新19-4-5"><a href="#更新19-4-5" class="headerlink" title="更新19.4.5"></a>更新19.4.5</h2><h3 id="一、etcd-单点问题"><a href="#一、etcd-单点问题" class="headerlink" title="一、etcd 单点问题"></a>一、etcd 单点问题<a id="more"></a></h3><p>默认<code>kubeadm</code>创建的集群会在内部启动一个单点的 etcd，当然大部分情况下 etcd 还是很稳定的，<strong>但是一但 etcd 由于某种原因挂掉，这个问题会非常严重，会导致整个集群不可用</strong>。具体原因是 etcd 存储着 kubernetes 各种元数据信息；包括 <code>kubectl get pod</code>等等基础命令实际上全部是调用 RESTful API 从 etcd 中获取的信息；<strong>所以一但 etcd 挂掉以后，基本等同于<code>kubectl</code>命令不可用，集群各节点也会因无法从 etcd 获取数据而出现无法调度，最终挂掉</strong>。</p><p><strong>解决办法：是在使用<code>kubeadm</code>创建集群时使用 –external-etcd-endpoints 参数指定外部 etcd 集群，此时<code>kubeadm</code> 将不会在内部创建 etcd，转而使用外部我们指定的 etcd 集群，如果外部 etcd 集群配置了 SSL 加密，那么还需要配合 –external-etcd-cafile、–external-etcd-certfile、–external-etcd-keyfile 三个参数指定 etcd 的 CA证书、CA签发的使用证书和私钥文件，命令如下</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 非 SSL</span><br><span class="line"><span class="meta">#</span> kubeadm init --external-etcd-endpoints http://x.x.x.1:2379</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> etcd SSL</span><br><span class="line"><span class="meta">#</span> kubeadm init --external-etcd-endpoints https://x.x.x.1:2379 --external-etcd-cafile /path/to/ca --external-etcd-certfile /path/to/cert --external-etcd-keyfile /path/to/privatekey</span><br></pre></td></tr></table></figure><h3 id="二、etcd-不可与-master-同在"><a href="#二、etcd-不可与-master-同在" class="headerlink" title="二、etcd 不可与 master 同在"></a>二、etcd 不可与 master 同在</h3><p>‘愿上帝与你同在’……这个坑是由于<code>kubeadm</code>的 check 机制的 bug 造成的，目前还没有修复；表现为 <strong>当 etcd 与 master 在同一节点时，kubeadm init 会失败，同时报错信息提示’已经存在了 /var/lib/etcd 目录，或者 2379 端口被占用’</strong>；因为默认<code>kubeadm</code>会创建 etcd，而默认的 etcd 会占用这个目录和 2379 端口，<strong>即使你加了<code>--external-etcd-endpoints</code>参数，<code>kubeadm</code>仍然会检测这两项条件是否满足，不满足则禁止 init 操作</strong></p><p><strong>解决办法：就是要么外部的 etcd 更换数据目录(/var/lib/etcd)和端口，要么干脆不要和 master 放在同一主机即可</strong></p><h3 id="三、巨大的日志"><a href="#三、巨大的日志" class="headerlink" title="三、巨大的日志"></a>三、巨大的日志</h3><p>熟悉的小伙伴应该清楚，基本上每个 kubernetes 组件都会有个通用的参数 <code>--v</code>；这个参数用于控制 kubernetes 各个组件的日志级别，在早期(alpha)的 kubeadm 版本中，如果不进行调整，默认创建集群所有组件日志级别全部为 <code>--v=4</code> 即最高级别输出，这会导致在业务量大的时候磁盘空间以 <strong>‘我去尼玛’</strong> 的速度增长，尤其是 <code>kube-proxy</code> 组件的容器，会疯狂吃掉你的磁盘空间，然后剩下懵逼的你不知为何。在后续的版本中(beta)发现日志级别已经降到了 <code>--v=2</code>，不过对于完全不怎么看日志的我来说还是无卵用……</p><p><strong>解决办法有两种方案:</strong></p><p><strong>1、如果已经 –v=4 跑起来了(检查方法就是随便 describe 一个 kube-proxy 的容器，看下 command 字段就能看到)，并且无法停止重建集群，那么最简单的办法就是使用<code>kubectl edit ds xxx</code>方式编译一下相关 ds 文件等，然后手动杀掉相关 pod，让 kubernetes 自动重建即可，如果命令行用着不爽也可以通过 dashboard 更改</strong></p><p><strong>2、如果还没开始搭建，或者可以停掉重建，那么只需在<code>kubeadm init</code>之前<code>export KUBE_COMPONENT_LOGLEVEL=&#39;--v=0&#39;</code>即可</strong></p><h3 id="四、新节点加入-dns-要你命"><a href="#四、新节点加入-dns-要你命" class="headerlink" title="四、新节点加入 dns 要你命"></a>四、新节点加入 dns 要你命</h3><p>当 kubeadm 创建好集群以后，如果有需要增加新节点，那么在 <code>kubeadm join</code> 之后务必检查 <code>kube-dns</code> 组件，dns 在某些(weave 启动不完整或不正常)情况下，会由于新节点加入而挂掉，此时整个集群 dns 失效，<strong>所以最好 join 完观察一会 dns 状态，如果发现不正常马上杀掉 dns pod，让 kubernetes 自动重建；如果情况允许最好全部 join 完成后直接干掉 dns 让 kubernetes 重建一下</strong></p><h3 id="五、单点的-dns-浪起来让你怕（更新-19-4-5）"><a href="#五、单点的-dns-浪起来让你怕（更新-19-4-5）" class="headerlink" title="五、单点的 dns 浪起来让你怕（更新-19.4.5）"></a>五、单点的 dns 浪起来让你怕（更新-19.4.5）</h3><p>kubeadm 创建的 dns 默认也是单点的，而 dns 至关重要，只要一挂瞬间整个集群全部 <code>game over</code>；<strong>不过暂时还是没有发现能在 init 时候创建多个 dns 的方法；不过在集群创建后可以通过<code>kubectl edit deploy kube-dns</code>的方式修改其副本数量，让其创建多个副本即可</strong>，<strong><em>目前新版本kubernetes所使用的dns已经不是单pod三container，而是启动两个pod的coredns，解决单点问题</em></strong></p><h3 id="六、coredns一直处于ContainerCreating状态"><a href="#六、coredns一直处于ContainerCreating状态" class="headerlink" title="六、coredns一直处于ContainerCreating状态"></a>六、coredns一直处于ContainerCreating状态</h3><blockquote><p>Node加入集群中后一直处于NotReady状态，查看kube-system的状态，发现coredns一直处于ContainerCreating状态，flannel启动正常</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl get nodes</span><br><span class="line">NAME              STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1.rsq.com   NotReady   master   16h     v1.13.0</span><br><span class="line">node01.rsq.com    NotReady   &lt;none&gt;   16h     v1.13.0</span><br><span class="line">node02.rsq.com    NotReady   &lt;none&gt;   8m39s   v1.13.0</span><br></pre></td></tr></table></figure><p>查看kubelet服务状态，看最后几行的报错</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> systemctl status kubelet</span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /etc/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: active (running) since Wed 2018-12-12 09:24:44 CST; 6min ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line"> Main PID: 123631 (kubelet)</span><br><span class="line">   Memory: 35.2M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─123631 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgrou...</span><br><span class="line"></span><br><span class="line">Dec 12 09:30:57 master1.rsq.com kubelet[123631]: E1212 09:30:57.187292  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:30:57 master1.rsq.com kubelet[123631]: E1212 09:30:57.187480  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Dec 12 09:30:59 master1.rsq.com kubelet[123631]: E1212 09:30:59.187419  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:30:59 master1.rsq.com kubelet[123631]: E1212 09:30:59.187607  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Dec 12 09:31:00 master1.rsq.com kubelet[123631]: W1212 09:31:00.454147  123631 cni.go:203] Unable to update cni config: No networks found in /etc/cni/net.d</span><br><span class="line">Dec 12 09:31:00 master1.rsq.com kubelet[123631]: E1212 09:31:00.454242  123631 kubelet.go:2192] Container runtime network not ready: NetworkReady=false reason:NetworkPluginNot...initialized</span><br><span class="line">Dec 12 09:31:01 master1.rsq.com kubelet[123631]: E1212 09:31:01.188877  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Dec 12 09:31:01 master1.rsq.com kubelet[123631]: E1212 09:31:01.189259  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:31:03 master1.rsq.com kubelet[123631]: E1212 09:31:03.187200  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:31:03 master1.rsq.com kubelet[123631]: E1212 09:31:03.187730  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 附加PS</span><br><span class="line"><span class="meta">#</span> 报错10.244.0.1 网络已存在（更新）</span><br></pre></td></tr></table></figure><p>产生问题原因：</p><p>一直报网络NotReady，我就感觉flannel组件出了问题， 最后网上搜了一些资料解决<br>参考博客：<a href="http://www.cnblogs.com/effortsing/p/10014611.html" target="_blank" rel="noopener">coreDNS一直处于创建中解决</a><br>解决办法：所有节点执行（我只在master节点先执行就解决问题了）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> rm -rf /var/lib/cni/flannel/* &amp;&amp; rm -rf /var/lib/cni/networks/cbr0/* &amp;&amp; ip link delete cni0</span><br><span class="line"><span class="meta">#</span> rm -rf /var/lib/cni/networks/cni0/*</span><br></pre></td></tr></table></figure><p>删除flannel组件，重新下载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> docker rmi quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line"><span class="meta">#</span> kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>查看节点状态已经处于Ready状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl get nodes</span><br><span class="line">NAME              STATUS   ROLES    AGE   VERSION</span><br><span class="line">master1.rsq.com   Ready    master   16h   v1.13.0</span><br><span class="line">node01.rsq.com    Ready    &lt;none&gt;   16h   v1.13.0</span><br><span class="line">node02.rsq.com    Ready    &lt;none&gt;   39m   v1.13.0</span><br></pre></td></tr></table></figure><h3 id="七、kubeadm-join报错"><a href="#七、kubeadm-join报错" class="headerlink" title="七、kubeadm join报错"></a>七、kubeadm join报错</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在部署服务过程中，初始化之后重启了master节点，然后node节点在join进群的时候报错，提示证书是否过期等问题，报错信息如下：</span><br><span class="line"><span class="meta">#</span> kubeadm join 10.0.0.100:6443 --token qxl5b3.5b78nwu3gm1r4u6o --discovery-token-ca-cert-hash sha256:3e20fa8054cbc9000cf3d3586a05a01d8af5721b577856e93c7e243877393d21 --ignore-preflight-errors=Swap</span><br><span class="line"></span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[WARNING Swap]: running with swap on is not supported. Please disable swap</span><br><span class="line">[WARNING SystemVerification]: this Docker version is not on the list of validated versions: 18.09.0. Latest validated version: 18.06</span><br><span class="line">[discovery] Trying to connect to API Server "10.0.0.100:6443"</span><br><span class="line">[discovery] Created cluster-info discovery client, requesting info from "https://10.0.0.100:6443"</span><br><span class="line">[discovery] Failed to request cluster info, will try again: [Get https://10.0.0.100:6443/api/v1/namespaces/kube-public/configmaps/cluster-info: dial tcp 10.0.0.100:6443: connect: connection refused]</span><br><span class="line">[discovery] Failed to request cluster info, will try again: [Get https://10.0.0.100:6443/api/v1/namespaces/kube-public/configmaps/cluster-info: dial tcp 10.0.0.100:6443: connect: connection refused]</span><br></pre></td></tr></table></figure><blockquote><p>产生原因：有可能是时间不同步造成的，在初始化后重启master，重启后会报错</p></blockquote><p>找了好多资料，没有找到可行的，最后kubeadm reset完美解决<br>参考博文： <a href="https://www.cnblogs.com/justmine/p/8886675.html" target="_blank" rel="noopener">k8s踩坑记 - kubeadm join 之 token 失效</a><br>reset之后重新初始化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubeadm reset</span><br><span class="line"><span class="meta">#</span> kubeadm init --kubernetes-version=v1.13.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --token-ttl=0 --ignore-preflight-errors=Swap</span><br></pre></td></tr></table></figure><p>创建所需文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> mkdir -p $HOME/.kube</span><br><span class="line"><span class="meta">#</span> cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line"><span class="meta">#</span> chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><p>查看节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl get nodes</span><br><span class="line">NAME              STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1.rsq.com   NotReady   master   2m49s   v1.13.0</span><br></pre></td></tr></table></figure><h3 id="八、Etcd二进制安装目录也会报错哦"><a href="#八、Etcd二进制安装目录也会报错哦" class="headerlink" title="八、Etcd二进制安装目录也会报错哦"></a>八、Etcd二进制安装目录也会报错哦</h3><p><strong>etcd服务启动后报错etcd cluster ID mismatch：</strong>检查service配置cluster选项有无问题，若无问题，则可能是此前的etcd bootstrap加速启动缓存残留导致，坑爹的是<code>rm -rf /var/lib/etcd/*</code>删除完了之后还是报错，必须<code>rm -rf /var/lib/etcd/</code>才能彻底清除，删除完成后记得再创建该路径mkdir /var/lib/etcd，否则会有类似报错：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcd.service: Failed at step CHDIR spawning /usr/local/bin/etcd: No such file or directory</span><br></pre></td></tr></table></figure><h3 id="九、二进制安装后重建相关组件会出现secrets报错"><a href="#九、二进制安装后重建相关组件会出现secrets报错" class="headerlink" title="九、二进制安装后重建相关组件会出现secrets报错"></a>九、二进制安装后重建相关组件会出现secrets报错</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">May 27 10:34:45 kube-node3 journal: E0527 02:34:45.767392      1 config.go:322] Expected to load root CA config from /var/run/secrets/kubernetes.io/serviceaccount/ca.crt, but got err: open /var/run/secrets/kubernetes.io/serviceaccount/ca.crt: no such file or directory </span><br><span class="line"></span><br><span class="line">May 27 10:34:45 kube-node3 journal: E0527 02:34:45.767392      1 config.go:322] Expected to load root CA config from /var/run/secrets/kubernetes.io/serviceaccount/ca.crt, but got err: open /var/run/secrets/kubernetes.io/serviceaccount/ca.crt: no such file or directory</span><br></pre></td></tr></table></figure><blockquote><p>分析：产生这个错误是因为Kubernetes默认创建的secrets资源不包含用于访问kube-apiserver的根证书 </p><p>需要给apiserver设置安全证书，然后删除默认secrets，系统会自动产生新的secrets </p><p>secrets一般集群安装时默认自动创建 </p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> kubectl delete secret secretname -n Xxx</span><br></pre></td></tr></table></figure><h3 id="十、kubeadm生成集群，加入节点时发现忘记了join-token-怎么办？"><a href="#十、kubeadm生成集群，加入节点时发现忘记了join-token-怎么办？" class="headerlink" title="十、kubeadm生成集群，加入节点时发现忘记了join token 怎么办？"></a>十、kubeadm生成集群，加入节点时发现忘记了join token 怎么办？</h3><blockquote><p>1.生成一条永久有效的token </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> # kubeadm token create --ttl 0 </span><br><span class="line"><span class="meta">&gt;</span> o4avtg.65ji6b778nyacw68 </span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> # kubeadm token list </span><br><span class="line"><span class="meta">&gt;</span> TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION   EXTRA GROUPS </span><br><span class="line"><span class="meta">&gt;</span> dxnj79.rnj561a137ri76ym   &lt;invalid&gt;   2018-11-\#02T14:06:43+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token </span><br><span class="line"><span class="meta">&gt;</span> o4avtg.65ji6b778nyacw68   &lt;forever&gt;   &lt;never&gt;                     authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token </span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>2.获取ca证书sha256编码hash值 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> # openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' </span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> 2cc3029123db737f234186636330e87b5510c173c669f513a9c0e0da395515b0 </span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>3.node节点加入 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> # kubeadm join x.x.x.x:6443 --token o4avtg.65ji6b778nyacw68 --discovery-token-ca-cert-hash sha256:2cc3029123db737f234186636330e87b5510c173c669f513a9c0e0da395515b0 </span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote></blockquote><p>###十一、</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安装-kubeadm_1.13.5</title>
      <link href="/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5/"/>
      <url>/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5/</url>
      
        <content type="html"><![CDATA[<h2 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h2><blockquote><p>kubernetes version：1.13.5</p><p>docker version：18.6.3</p><p>Redhat：7.6</p></blockquote><a id="more"></a><table><thead><tr><th style="text-align:left">x.x.x.1</th><th style="text-align:center">master-1</th><th>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</th></tr></thead><tbody><tr><td style="text-align:left"><strong>x.x.x.2</strong></td><td style="text-align:center"><strong>master-2</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.3</strong></td><td style="text-align:center"><strong>master-3</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.4</strong></td><td style="text-align:center"><strong>vip</strong></td><td></td></tr><tr><td style="text-align:left"><strong>x.x.x.5</strong></td><td style="text-align:center"><strong>node-1</strong></td><td><strong>kubelet、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.6</strong></td><td style="text-align:center"><strong>node-2</strong></td><td><strong>kubelet、docker</strong></td></tr></tbody></table><p>因为担心kubeadm起来的etcd不稳定，这里用到的etcd对于kubernetes来说作为外部etcd集群。即使用二进制安装etcd集群，其余组件用kubeadm来完成安装。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">echo "1" &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class="line"><span class="meta">#</span> 停防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span> 关闭Swap</span><br><span class="line">swapoff -a</span><br><span class="line">sed 's/.*swap.*/#&amp;/' /etc/fstab</span><br><span class="line"><span class="meta">#</span> 关闭防火墙</span><br><span class="line">systemctl disable firewalld &amp;&amp; systemctl stop firewalld &amp;&amp; systemctl status firewalld</span><br><span class="line"><span class="meta">#</span> 关闭Selinux</span><br><span class="line">setenforce  0</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="2、docker安装"><a href="#2、docker安装" class="headerlink" title="2、docker安装"></a>2、docker安装</h3><h4 id="1、下载设置源"><a href="#1、下载设置源" class="headerlink" title="1、下载设置源"></a>1、下载设置源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.daocloud.io/docker/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="2、安装docker"><a href="#2、安装docker" class="headerlink" title="2、安装docker"></a>2、安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r  # 列出docker-ce的版本list</span><br><span class="line">yum install docker-ce-&lt;版本号&gt; -y # -y 安装docker需要的依赖，其中有个container-selinux的也可以单独下载</span><br><span class="line"><span class="meta">#</span> rpm -ivh container-selinux-2.33-1.git86f33cd.el7.noarch.rpm</span><br></pre></td></tr></table></figure><h4 id="3、启动docker"><a href="#3、启动docker" class="headerlink" title="3、启动docker"></a>3、启动docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">docker version # 验证docker安装是否完成并启动成功</span><br></pre></td></tr></table></figure><h3 id="3、kubeadm-kubelet-kubectl安装"><a href="#3、kubeadm-kubelet-kubectl安装" class="headerlink" title="3、kubeadm/kubelet/kubectl安装"></a>3、kubeadm/kubelet/kubectl安装</h3><blockquote><p>各节点安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.13.5 kubeadm-1.13.5 kubectl-1.13.5 --disableexcludes=kubernetes  #禁用除kubernetes之外的仓库,要用 -y 参数，会自动安装kube-cni等插件</span><br><span class="line"></span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet # kubeadm 要求kubelet保持开机自启状态</span><br></pre></td></tr></table></figure><h3 id="4、keepalive安装"><a href="#4、keepalive安装" class="headerlink" title="4、keepalive安装"></a>4、keepalive安装</h3><blockquote><p>master节点安装：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line"></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script CheckK8sMaster &#123;</span><br><span class="line">    script &quot;curl -k https://10.70.49.130:6443&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    timeout 9</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens256 # 网卡</span><br><span class="line">    virtual_router_id 61</span><br><span class="line">    # 主节点权重最高 依次减少</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line">    #修改为本地IP </span><br><span class="line">    mcast_src_ip x.x.x.2</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass sqP05dQgMSlzrxHj</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        x.x.x.1</span><br><span class="line">        #x.x.x.2</span><br><span class="line">        x.x.x.3</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        x.x.x.4</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        CheckK8sMaster</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="kubernetes部署"><a href="#kubernetes部署" class="headerlink" title="kubernetes部署"></a>kubernetes部署</h2><h3 id="1、etcd二进制部署"><a href="#1、etcd二进制部署" class="headerlink" title="1、etcd二进制部署"></a>1、etcd二进制部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 1.cfssl签发证书</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x cfssljson_linux-amd64</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="line">export PATH=/usr/local/bin:$PATH</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 2.根据config.json文件的格式创建如下的ca-config.json文件,过期时间设置成了 87600h</span><br><span class="line">mkdir /root/ssl</span><br><span class="line">cd /root/ssl</span><br><span class="line">cfssl print-defaults config &gt; config.json</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "87600h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "kubernetes": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "BeiJing",</span><br><span class="line">      "L": "BeiJing",</span><br><span class="line">      "O": "k8s",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 3.创建kubernetes-etcd证书</span><br><span class="line">cat &gt; kubernetes-etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "kubernetes",</span><br><span class="line">    "hosts": [</span><br><span class="line">      "x.x.x.1",</span><br><span class="line">      "x.x.x.2",</span><br><span class="line">      "x.x.x.3",</span><br><span class="line">      "x.x.x.4",</span><br><span class="line">      "127.0.0.1",</span><br><span class="line">      "10.254.0.1",</span><br><span class="line">      "kubernetes",</span><br><span class="line">      "kubernetes.default",</span><br><span class="line">      "kubernetes.default.svc",</span><br><span class="line">      "kubernetes.default.svc.cluster",</span><br><span class="line">      "kubernetes.default.svc.cluster.local"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "BeiJing",</span><br><span class="line">            "L": "BeiJing",</span><br><span class="line">            "O": "k8s",</span><br><span class="line">            "OU": "System"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 4.目录证书文件如下</span><br><span class="line">etcd-key.pem etcd.pem ca.pem ca.key</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 保证三节点证书一致</span><br><span class="line">scp /etc/etcd/ssl/* master2:/etc/etcd/ssl/</span><br><span class="line">scp /etc/etcd/ssl/* master3:/etc/etcd/ssl/</span><br></pre></td></tr></table></figure><blockquote><p>证书生成完毕之后，将CA证书ca.pem, etcd秘钥etcd-key.pem, etcd证书etcd.pem拷贝到各节点的/etc/etcd/ssl目录中。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 这里就用etcd 3.3.10版本</span><br><span class="line"><span class="meta">#</span> 一：</span><br><span class="line">wget https://github.com/coreos/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line"><span class="meta">#</span> 解压缩etcd-v3.3.10-linux-amd64.tar.gz，将其中的etcd和etcdctl两个可执行文件复制到各节点的/usr/bin和/usr/local/bin目录。</span><br><span class="line">tar zxvf etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">cp etcd-v3.3.10-linux-amd64/etcd* /usr/local/bin/</span><br><span class="line">cp etcd-v3.3.10-linux-amd64/etcd* /usr/bin/</span><br><span class="line">mkdir /var/lib/etcd     #etcd的数据目录</span><br><span class="line">mkdir /etc/etcd        #etcd的配置文件目录</span><br><span class="line"><span class="meta">#</span> 二：</span><br><span class="line">yum -y install etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 安装好etcd之后，就可以修改etcd配置以及启动service，文件路径为：/etc/etcd/etcd.conf和/usr/lib/systemd/system/etcd.service</span><br><span class="line">cat &gt; /etc/etcd/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta">#</span> [member]</span><br><span class="line">ETCD_NAME=etcd1 # etcd名字 三节点的话为 etcd1 etcd2 etcd3</span><br><span class="line">ETCD_DATA_DIR="/data/etcd" # etcd数据目录指定</span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://x.x.x.1:2380" # 修改每个master节点的ip</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://x.x.x.1:2379"</span><br><span class="line"><span class="meta">#</span>[cluster]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://x.x.x.1:2380"</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://x.x.x.1:2379"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">  --name $&#123;ETCD_NAME&#125; \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">  --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">  --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">  --initial-cluster-token $&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">  --initial-cluster etcd1=https://x.x.x.1:2380,etcd2=https://x.x.x.2:2380,etcd3=https://x.x.x.3:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir=$&#123;ETCD_DATA_DIR&#125;</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 上面在启动参数中指定了etcd的工作目录和数据目录分别是/var/lib/etcd和/data/etcd</span><br><span class="line"><span class="meta">#</span> –cert-file和–key-file分别指定etcd的公钥证书和私钥</span><br><span class="line"><span class="meta">#</span> –peer-cert-file和–peer-key-file分别指定了etcd的Peers通信的公钥证书和私钥。</span><br><span class="line"><span class="meta">#</span> –trusted-ca-file指定了客户端的CA证书</span><br><span class="line"><span class="meta">#</span> –peer-trusted-ca-file指定了Peers的CA证书</span><br><span class="line"><span class="meta">#</span> –initial-cluster-state new表示这是新初始化集群，–name指定的参数值必须在–initial-cluster中</span><br><span class="line"><span class="meta">#</span> 高可用etcd启动需要多节点同时启动才能起来服务</span><br><span class="line"><span class="meta">#</span> 分别在master节点同时启动etcd</span><br><span class="line">systemctl start etcd.service</span><br><span class="line">systemctl enable etcd.service</span><br></pre></td></tr></table></figure><blockquote><p>至此，etcd高可用集群搭建完成，可用一下命令验证etcd集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --endpoints=https://x.x.x.1:2379,https://x.x.x.2:2379,https://x.x.x.3:2379 \</span><br><span class="line">  cluster-health</span><br></pre></td></tr></table></figure><h3 id="2、kubeadm部署"><a href="#2、kubeadm部署" class="headerlink" title="2、kubeadm部署"></a>2、kubeadm部署</h3><h4 id="1、master部署"><a href="#1、master部署" class="headerlink" title="1、master部署"></a>1、master部署</h4><blockquote><p>部署之前请确保下载好相关image，翻墙下载或者国内dockerhub下载kubernetes镜像</p></blockquote><h5 id="1、初始化master1"><a href="#1、初始化master1" class="headerlink" title="1、初始化master1"></a>1、初始化master1</h5><blockquote><p>创建master1的初始化配置文件,网络插件采用flannel，CIDR地址是 “10.244.0.0/16”，如下为1.13.5新版本配置文件。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubeadm-master.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: x.x.x.1  # 本机ip，这里为x.x.x.1-3</span><br><span class="line">  bindPort: 6443</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.5   # kubernetes版本 对应下载的image</span><br><span class="line">imageRepository: k8s.gcr.io  # 自己修改为自己的镜像库名</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - "master1"</span><br><span class="line">  - "master2"</span><br><span class="line">  - "master3"</span><br><span class="line">  - "x.x.x.1"</span><br><span class="line">  - "x.x.x.2"</span><br><span class="line">  - "x.x.x.3"</span><br><span class="line">  - "x.x.x.4"</span><br><span class="line">  - "127.0.0.1"</span><br><span class="line"></span><br><span class="line">controlPlaneEndpoint: "x.x.x.4:8443" # 控制台ip指定，即vip 实现apiserver高可用</span><br><span class="line">etcd:</span><br><span class="line">  external:</span><br><span class="line">     endpoints:</span><br><span class="line">     - https://x.x.x.1:2379</span><br><span class="line">     - https://x.x.x.2:2379</span><br><span class="line">     - https://x.x.x.3:2379</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: "10.244.0.0/16"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 运行初始化命令即可，前提要把相关设置关闭，详情至准备工作</span><br><span class="line"><span class="meta">#</span> 其中在kubelet配置里加入--pod-infra-container-image 参数指定 pause私有镜像库镜像</span><br><span class="line">kubeadm init --config kubeadm-master.yaml</span><br></pre></td></tr></table></figure><blockquote><p>在初始化配置里，对于etcd有两种高可用的选项，一个使用内部etcd，一个使用外部etcd(独立搭建的etcd集群，而不是在初始化中搭建的)，两者初始化配置文件略有不同。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 使用内部etcd的话，初始化yaml文件中etcd配置如下：</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: "https://127.0.0.1:2379,https://x.x.x.x:2379"</span><br><span class="line">      advertise-client-urls: "https://x.x.x.x:2379"</span><br><span class="line">      listen-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-advertise-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-cluster: "master1.hanli.com=https://x.x.x.x:2380"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 使用外部etcd的话，</span><br><span class="line">etcd:    #ETCD的地址</span><br><span class="line">   external:</span><br><span class="line">     endpoints:</span><br><span class="line">     - https://x.x.x.1:2379</span><br><span class="line">     - https://x.x.x.2:2379</span><br><span class="line">     - https://x.x.x.3:2379</span><br></pre></td></tr></table></figure><blockquote><p>init初始化之后，如果成功会出现<code>join</code>，这时就可以运行一下命令</p><p>机器上的用户要使用<code>kubectl</code>来管理集群操作集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><blockquote><p>验证命令</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs # 如下信息</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-1               Healthy   &#123;"health": "true"&#125;</span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br><span class="line">etcd-2               Healthy   &#123;"health": "true"&#125;</span><br><span class="line"></span><br><span class="line">kubectl get node # notReady 状态，是因为没有安装网络插件 Name成ip，可修改kubelet的启动参数即可</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1     NotReady      master     1m      v1.13.5</span><br></pre></td></tr></table></figure><h5 id="2、启动flannel服务"><a href="#2、启动flannel服务" class="headerlink" title="2、启动flannel服务"></a>2、启动flannel服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta">#</span> flannel 默认会使用主机的第一张网卡，如果你有多张网卡，需要通过配置单独指定。修改 kube-flannel.yml 中的以下部分</span><br><span class="line">cat kube-flannel.yml </span><br><span class="line"> containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.11.0-amd64 # 修改下自己私有镜像库的flannel镜像名</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=ens33              #添加</span><br></pre></td></tr></table></figure><hr><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml # 创建pod，因为是ds的所以后续集群里面加节点就会自动启动flannel</span><br><span class="line">kubectl get node # 会发现 node状态变成了 Ready</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1       Ready      master     10m      v1.13.5</span><br><span class="line"></span><br><span class="line">kubectl get po --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-86c58d9df4-r59rv                   1/1     Running   0          59m</span><br><span class="line">kube-system   coredns-86c58d9df4-rbzx5                   1/1     Running   0          59m</span><br><span class="line">kube-system   kube-apiserver-master1                     1/1     Running   0          58m</span><br><span class="line">kube-system   kube-controller-manager-master1            1/1     Running   16         58m</span><br><span class="line">kube-system   kube-flannel-ds-amd64-229j2                1/1     Running   0          42m</span><br><span class="line">kube-system   kube-proxy-4wrg5                           1/1     Running   0          59m</span><br><span class="line">kube-system   kube-scheduler-master1                     1/1     Running   13         58m</span><br></pre></td></tr></table></figure><blockquote><p>不是running状态，就说明出错了，通过查看</p><p>描述：kubectl describe pod kube-scheduler-master.hanli.com -n kube-system</p><p>日志：kubectl logs kube-scheduler-master.hanli.com -n kube-system</p><p>flannel服务启动成功后，coredns也就会自动启动成功，状态为Running</p></blockquote><h5 id="3、初始化其他master节点"><a href="#3、初始化其他master节点" class="headerlink" title="3、初始化其他master节点"></a>3、初始化其他master节点</h5><blockquote><p>首先把master1上生成的ca证书等，拷贝到其他master节点上，最好免密，可使用pscp等批量任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> #!/bin/bash</span><br><span class="line"><span class="meta">&gt;</span> #注意修改为自己的主机名</span><br><span class="line"><span class="meta">&gt;</span> export CONTROL_PLANE_IPS="master2 master3"  </span><br><span class="line"><span class="meta">&gt;</span> </span><br><span class="line"><span class="meta">&gt;</span> # 保证节点有/etc/kubernetes/pki目录</span><br><span class="line"><span class="meta">&gt;</span> # 把以下证书复制到其他master节点</span><br><span class="line"><span class="meta">&gt;</span> for host in $&#123;CONTROL_PLANE_IPS&#125;; do</span><br><span class="line"><span class="meta">&gt;</span> # ！！！修正拷贝证书的时候请指定特定证书拷贝（之前的已经备注，新加的有etcd目录，没有用外部etcd集群），因为在证书拷贝的情况下吃过亏，因此修改此处！！！</span><br><span class="line"><span class="meta">&gt;</span> # 附issue：https://github.com/kubernetes/kubeadm/issues/1321 </span><br><span class="line"><span class="meta">&gt;</span> # 找了好久终于！！！哭</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/pki/*.crt $host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/pki/*.key $host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/pki/*.pub $host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> #scp /etc/kubernetes/admin.conf $host:/etc/kubernetes/admin.conf</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/ca.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/sa.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/front-proxy-ca.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/pki/etcd/ca.* "$&#123;USER&#125;"@$host:/etc/kubernetes/pki/etcd/</span><br><span class="line"><span class="meta">&gt;</span> scp /etc/kubernetes/admin.conf "$&#123;USER&#125;"@$host:/etc/kubernetes/</span><br><span class="line"><span class="meta">&gt;</span> done</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> tree /etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> /etc/kubernetes/pki/</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-etcd-client.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-etcd-client.key</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver.key</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-kubelet-client.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── apiserver-kubelet-client.key</span><br><span class="line"><span class="meta">&gt;</span> ├── ca.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── ca.key</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-ca.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-ca.key</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-client.crt</span><br><span class="line"><span class="meta">&gt;</span> ├── front-proxy-client.key</span><br><span class="line"><span class="meta">&gt;</span> ├── sa.key</span><br><span class="line"><span class="meta">&gt;</span> └── sa.pub</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>In v1.8.0, kubeadm introduced the <code>kubeadm alpha phase</code> command with the aim of making kubeadm more modular. In v1.13.0 this command graduated to <code>kubeadm init phase</code>. This modularity enables you to invoke atomic sub-steps of the bootstrap process. Hence, you can let kubeadm do some parts and fill in yourself where you need customizations.</p><p><code>kubeadm init phase</code> is consistent with the <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow" target="_blank" rel="noopener">kubeadm init workflow</a>, and behind the scene both use the same code.</p><p>在v1.8.0中，kubeadm引入了该<code>kubeadm alpha phase</code>命令，目的是使kubeadm更加模块化。在v1.13.0中，此命令逐渐变为<code>kubeadm init phase</code>。此模块化使您可以调用引导过程的原子子步骤。因此，您可以让kubeadm执行某些操作，并在需要自定义的位置填写您自己的位置。</p><p><code>kubeadm init phase</code>与<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow" target="_blank" rel="noopener">kubeadm init工作流程</a>一致，并且在场景后面都使用相同的代码。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl init --config kube-master.yaml</span><br><span class="line"><span class="meta">#</span> 分别修改对应ip，在在master2-3并执行即可 步骤如master1</span><br><span class="line"><span class="meta">#</span> 等待kube-proxy flannel启动成功即可</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n kube-system</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-9f9d9c76-4zrt4                  1/1     Running   0          2d</span><br><span class="line">coredns-9f9d9c76-dqd4c                  1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-1   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-2   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-3   1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-7ghn7             1/1     Running   1          2d</span><br><span class="line">kube-flannel-ds-amd64-9cqts             1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-f57nh             1/1     Running   1          2d</span><br><span class="line">kube-proxy-8fwts                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-95tjb                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-bls94                        1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kubernetes-dashboard-67d49f7868-x79wf   1/1     Running   0          76m</span><br></pre></td></tr></table></figure><h4 id="2、Work节点加入集群"><a href="#2、Work节点加入集群" class="headerlink" title="2、Work节点加入集群"></a>2、Work节点加入集群</h4><blockquote><p>输入master节点初始化成功之后出现的<code>join</code>命令，出现<code>kubectl get nodes</code>即成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> kubeadm join x.x.x.4:8443 --token bnnsb7.amapp1t78llxn54d --discovery-token-ca-cert-hash sha256:520ef89be84c30e480db6d441a7e4179634a9455f0009e249ebe8f35fa792087</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><h4 id="3、集群验证"><a href="#3、集群验证" class="headerlink" title="3、集群验证"></a>3、集群验证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 节点状态</span><br><span class="line">[root@master] ~$ kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 组件状态</span><br><span class="line">[root@master] ~$  kubectl get cs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 服务账户</span><br><span class="line">[root@master] ~$ kubectl get serviceaccount</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 集群信息</span><br><span class="line">[root@master] ~$ kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 验证dns功能</span><br><span class="line">[root@master] ~$ kubectl run curl --image=radial/busyboxplus:curl -it</span><br><span class="line">[ root@curl-66959f6557-r4crd:/ ]$ nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure><blockquote><p>附录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span># kubelet.service配置文件 /use/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><hr><p>参考链接：</p><p>kubeadm安装1.13.5：<a href="https://blog.csdn.net/fanren224/article/details/86573264#2master1_165" target="_blank" rel="noopener">https://blog.csdn.net/fanren224/article/details/86573264#2master1_165</a></p><p>二进制安装：<a href="https://github.com/mritd/ktool" target="_blank" rel="noopener">https://github.com/mritd/ktool</a></p><p>二进制安装kubernetes_v1.13.4：<a href="https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/" target="_blank" rel="noopener">https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/</a></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Kubernetes_ha </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一点Haproxy参数的文档</title>
      <link href="/passages/%E8%AE%B0%E4%B8%80%E7%82%B9Haproxy%E5%8F%82%E6%95%B0%E7%9A%84%E6%96%87%E6%A1%A3/"/>
      <url>/passages/%E8%AE%B0%E4%B8%80%E7%82%B9Haproxy%E5%8F%82%E6%95%B0%E7%9A%84%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<p>Haproxy的一些配置参数，/etc/haproxy/haproxy.cfg</p><blockquote><p>主要是配置项的超时参数，如下：<a id="more"></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span> # 反映连接haproxy集群报错，查看应用服务器进程大量的端口连接处于colse_wait状态。</span><br><span class="line"><span class="meta">&gt;</span> # 这个haproxy的redis集群类似配置已经好几组了，配置都相同问啥别的都好好的这个却有问题。</span><br><span class="line"><span class="meta">&gt;</span> # 自己尝试使用redis-cli连接（haproxy做的redis分片集群），确实能够正常连接操作，但是连接状态马上就会变成close_wait状态，重新执行命令这个close_wait状态会恢复ESTABLISHED，但是细心看端口号已经变化，也就是redis-cli发生了重新连接。于是问题清晰了：用户客户端工具建立链接后，没有自动重连来保持连接，导致超时，服务器主动断开连接，客户端再次链接的时候socket已经损坏不可用了，导致报错</span><br><span class="line"><span class="meta">&gt;</span> # 解决办法：调整haproxy的超时参数：</span><br><span class="line"><span class="meta">&gt;</span> timeout connect 5s</span><br><span class="line"><span class="meta">&gt;</span> timeout queue   5s</span><br><span class="line"><span class="meta">&gt;</span> timeout client 30s</span><br><span class="line"><span class="meta">&gt;</span> timeout server 30s</span><br><span class="line"><span class="meta">&gt;</span> timeout client-fin 30s</span><br><span class="line"><span class="meta">&gt;</span> timeout server-fin 30s</span><br><span class="line"><span class="meta">&gt;</span> timeout tunnel  1h</span><br><span class="line"><span class="meta">&gt;</span> # 参数解释：</span><br><span class="line"><span class="meta">&gt;</span> timeout connect      连接尝试成功连接到server的超时时间</span><br><span class="line"><span class="meta">&gt;</span> timeout queue        在队列等待连接槽释放的超时时间</span><br><span class="line"><span class="meta">&gt;</span> timeout server       server端非活动状态超时时间</span><br><span class="line"><span class="meta">&gt;</span> timeout client       客户端非活动状态超时时间</span><br><span class="line"><span class="meta">&gt;</span> timeout server-fin   半关闭状态连接，server端非活动超时时间</span><br><span class="line"><span class="meta">&gt;</span> timeout client-fin   半关闭状态连接，client端非活动超时时间</span><br><span class="line"><span class="meta">&gt;</span> timeout tunnel       客户端和服务器端通道非活动超时时间</span><br><span class="line"><span class="meta">&gt;</span></span><br></pre></td></tr></table></figure></blockquote><blockquote></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_list去重</title>
      <link href="/passages/Python-list%E5%8E%BB%E9%87%8D/"/>
      <url>/passages/Python-list%E5%8E%BB%E9%87%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="Python-list去重集中记录一下方法"><a href="#Python-list去重集中记录一下方法" class="headerlink" title="Python_list去重集中记录一下方法"></a>Python_list去重集中记录一下方法</h2><h3 id="怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？"><a href="#怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？" class="headerlink" title="怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？"></a>怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？</h3><h4 id="1-以下的几种情况结果是一样的，去重之后顺序会改变"><a href="#1-以下的几种情况结果是一样的，去重之后顺序会改变" class="headerlink" title="1.以下的几种情况结果是一样的，去重之后顺序会改变:"></a>1.以下的几种情况结果是一样的，去重之后顺序会改变:<a id="more"></a></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最常用</span></span><br><span class="line">ids = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">news_ids = []</span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> ids:</span><br><span class="line">    <span class="keyword">if</span> id <span class="keyword">not</span> <span class="keyword">in</span> news_ids:</span><br><span class="line">        news_ids.append(id)</span><br><span class="line"><span class="keyword">print</span> news_ids</span><br></pre></td></tr></table></figure><h4 id="或用set"><a href="#或用set" class="headerlink" title="或用set"></a>或用set</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用set如果列表里面有字典活着其他数据结构，貌似不会去重。</span></span><br><span class="line">ids = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">ids = list(set(ids))</span><br></pre></td></tr></table></figure><h4 id="或使用itertools-grouby"><a href="#或使用itertools-grouby" class="headerlink" title="或使用itertools.grouby"></a>或使用itertools.grouby</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">ids = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">ids.sort()</span><br><span class="line">it = itertools.groupby(ids)</span><br><span class="line"><span class="keyword">for</span> k, g <span class="keyword">in</span> it:</span><br><span class="line">    <span class="keyword">print</span> k</span><br></pre></td></tr></table></figure><blockquote><p>关于itertools.groupby的原理可以看这里：</p><p>(1) <a href="http://docs.python.org/2/library/itertools.html#itertools.groupby" target="_blank" rel="noopener">http://docs.python.org/2/library/itertools.html#itertools.groupby</a></p><p>(2)<a href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001415616001996f6b32d80b6454caca3d33c965a07611f000" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001415616001996f6b32d80b6454caca3d33c965a07611f000</a></p></blockquote><h4 id="2-怎么能不改变原来的顺序呢？-要用到reduce-关于reduce的介绍-http-docs-python-org-2-library-functions-html-reduce"><a href="#2-怎么能不改变原来的顺序呢？-要用到reduce-关于reduce的介绍-http-docs-python-org-2-library-functions-html-reduce" class="headerlink" title="2.怎么能不改变原来的顺序呢？(要用到reduce 关于reduce的介绍　 http://docs.python.org/2/library/functions.html#reduce)"></a>2.怎么能不改变原来的顺序呢？(要用到reduce 关于reduce的介绍　 <a href="http://docs.python.org/2/library/functions.html#reduce" target="_blank" rel="noopener">http://docs.python.org/2/library/functions.html#reduce</a>)</h4><blockquote><p>关于lambda的文章:<a href="http://www.cnblogs.com/nyist-xsk/p/7404675.html" target="_blank" rel="noopener">http://www.cnblogs.com/nyist-xsk/p/7404675.html</a></p><p>关于reduce的文章: </p><p>(1) <a href="http://www.cnblogs.com/XXCXY/p/5180245.html" target="_blank" rel="noopener">http://www.cnblogs.com/XXCXY/p/5180245.html</a></p><p>(2) <a href="http://www.pythoner.com/46.html" target="_blank" rel="noopener">http://www.pythoner.com/46.html</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: ids = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">In [<span class="number">6</span>]: func = <span class="keyword">lambda</span> x,y:x <span class="keyword">if</span> y <span class="keyword">in</span> x <span class="keyword">else</span> x + [y]</span><br><span class="line">In [<span class="number">7</span>]: reduce(func, [[], ] + ids)</span><br><span class="line">Out[<span class="number">7</span>]: [<span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br></pre></td></tr></table></figure><blockquote><p>其中的 lambda x,y:x if y in x else x + [y] 等价于 lambda x,y: y in x and x or x+[y] 。<br>思路其实就是先把ids变为[[], 1,4,3,……] ,然后在利用reduce的特性.</p></blockquote><h4 id="去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如："><a href="#去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如：" class="headerlink" title="去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如："></a>去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">list2 = []</span><br><span class="line">list1 = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list1:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> list2:</span><br><span class="line">        list2.append(i)</span><br><span class="line">list2</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>]</span><br><span class="line">或者使用删除元素索引的方法对列表去重，并且不改变原列表的顺序</span><br><span class="line"><span class="comment"># python for删除的时候会往前移(垃圾回收机制)，未遍历到的后一个占了前一个被删除的"位置"，导致这个数不会被遍历到，而使最后的结果错误</span></span><br><span class="line"><span class="comment"># 局部变量在栈内存中存在,当for循环语句结束,那么变量会及时被gc(垃圾回收器)及时的释放掉,不浪费空间；</span></span><br><span class="line"><span class="comment"># 如果使用循环之后还想去访问循环语句中控制那个变量,使用while循环。</span></span><br><span class="line"><span class="comment"># 所以使用while循环删除nums中的Val(的下标)</span></span><br><span class="line">nums = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">val = <span class="number">3</span></span><br><span class="line"><span class="keyword">while</span> val <span class="keyword">in</span> nums:</span><br><span class="line">      nums.pop(nums.index(val))</span><br><span class="line"><span class="keyword">print</span> nums</span><br><span class="line"><span class="keyword">return</span> len(nums)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang_问题</title>
      <link href="/passages/Golang-%E9%97%AE%E9%A2%98/"/>
      <url>/passages/Golang-%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>（持续更新）</p><h2 id="一、gorm遇到invalid-connection报错"><a href="#一、gorm遇到invalid-connection报错" class="headerlink" title="一、gorm遇到invalid connection报错"></a>一、gorm遇到invalid connection报错</h2><blockquote><p>(/data/dcops_workspace/src/x.x.x.x/xxxx/model/containerappid_info.go:76)<br>[2019-04-09 14:41:40]  invalid connection<a id="more"></a></p><p>现象：今天使用gorm时，总遇到invalid connection报错，导致<strong>过一段时间</strong>调一下接口服务容器就会重启</p><p>网上查了文档看了gorm的mysql连接池的参数：</p><p>dcosdb.DB().SetMaxIdleConns(10)  // SetMaxIdleConns设置idle connection pool的最大连接数。如果MaxOpenConns的值 &gt; 0，但是小于这里设置的MaxIdleConns，则MaxIdleConns将自动降到与MaxOpenConns的限制相同。如果 &lt;= 0, 则没有空闲连接会被保留。<strong><em>最大空闲连接数</em></strong></p><p>dcosdb.DB().SetMaxOpenConns(100)  //SetMaxOpenConns用于设置Database最大可以打开的连接数。如果 &lt;= 0, 则没有连接限制。且默认值为0（无限制）。<strong><em>数据库最大连接数</em></strong></p><p>dcosdb.DB().SetConnMaxLifetime(time.Second <em> 5)  // SetConnMaxLifetime用于设置连接可被重新使用的最大时间间隔。如果超时，则连接会在重新使用前被关闭。如果 d &lt;= 0, 则连接将被永久保留。**</em>连接最长存活期，超过这个时间连接将不再被复用***</p><p>原因是：程序在重复使用数据库tcp连接池中的某个连接时，该命中连接可能已被服务器过期丢弃，而客户端这边认为该连接为过期，还有效。此时会报错 invalid connection。随后将该连接重连接池中丢弃</p><p>原因参考：<a href="https://blog.csdn.net/dghpgyss/article/details/86480837" target="_blank" rel="noopener">https://blog.csdn.net/dghpgyss/article/details/86480837</a></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发现我把dcosdb.DB().SetConnMaxLifetime(time.Second * 5)这个参数设置成了dcosdb.DB().SetConnMaxLifetime(time.Hour)导致了每次连接丢弃，但是客户端不知道。服务端主动关闭了连接，因为服务端对连接的保持超时时间到了也关闭的，所以可以设置客户端连接超时时间小于服务端DB.SetConnMaxLifetime(time.Second)</span></span><br><span class="line"><span class="comment">// SetConnMaxLifetime sets the maximum amount of time a connection may be reused.</span></span><br><span class="line">dcosdb.DB().SetConnMaxLifetime(time.Second * <span class="number">5</span>)</span><br><span class="line"><span class="comment">// dcosdb.DB().SetConnMaxLifetime(time.Hour) 设置成了1小时</span></span><br></pre></td></tr></table></figure><h2 id="二、"><a href="#二、" class="headerlink" title="二、"></a>二、</h2>]]></content>
      
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发之原子操作</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<p><strong><em>转自：<a href="http://ifeve.com/go-concurrency-atomic/" target="_blank" rel="noopener">http://ifeve.com/go-concurrency-atomic/</a></em></strong></p><blockquote><p>原理多，代码量偏少。</p></blockquote><p>我们已经知道，原子操作即是进行过程中不能被中断的操作。也就是说，针对某个值的原子操作在被进行的过程当中，CPU绝不会再去进行其它的针对该值的操作。无论这些其它的操作是否为原子操作都会是这样。为了实现这样的严谨性，原子操作仅会由一个独立的CPU指令代表和完成。只有这样才能够在并发环境下保证原子操作的绝对安全。<br>Go语言提供的原子操作都是非侵入式的。它们由标准库代码包sync/atomic中的众多函数代表。我们可以通过调用这些函数对几种简单的类型的值进行原子操作。这些类型包括int32、int64、uint32、uint64、uintptr和unsafe.Pointer类型，共6个。这些函数提供的原子操作共有5种，即：增或减、比较并交换、载入、存储和交换。它们分别提供了不同的功能，且适用的场景也有所区别。下面，我们就根据这些种类对Go语言提供的原子操作进行逐一的讲解。<a id="more"></a></p><p>1、增或减<br>被用于进行增或减的原子操作（以下简称原子增/减操作）的函数名称都以“Add”为前缀，并后跟针对的具体类型的名称。例如，实现针对uint32类型的原子增/减操作的函数的名称为AddUint32。事实上，sync/atomic包中的所有函数的命名都遵循此规则。<br>顾名思义，原子增/减操作即可实现对被操作值的增大或减小。因此，被操作值的类型只能是数值类型。更具体的讲，它只能是我们在前面提到的int32、int64、uint32、uint64和uintptr类型。例如，我们如果想原子的把一个int32类型的变量i32的值增大3的话，可以这样做：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newi32 := atomic.AddInt32(&amp;i32, <span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>我们将指向i32变量的值的指针值和代表增减的差值3作为参数传递给了atomic.AddInt32函数。之所以要求第一个参数值必须是一个指针类型的值，是因为该函数需要获得到被操作值在内存中的存放位置，以便施加特殊的CPU指令。从另一个角度看，对于一个不能被取址的数值，我们是无法进行原子操作的。此外，这类函数的第二个参数的类型被操作值的类型总是相同的。因此，在前面那个调用表达式被求值的时候，字面量3会被自动转换为一个int32类型的值。函数atomic.AddInt32在被执行结束之时会返回经过原子操作后的新值。不过不要误会，我们无需把这个新值再赋给原先的变量i32。因为它的值已经在atomic.AddInt32函数返回之前被原子的修改了。<br>与该函数类似的还有atomic.AddInt64函数、atomic.AddUint32函数、atomic.AddUint64函数和atomic.AddUintptr函数。这些函数也可以被用来原子的增/减对应类型的值。例如，如果我们要原子的将int64类型的变量i64的值减小3话，可以这样编写代码：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i64 <span class="keyword">int64</span></span><br><span class="line">atomic.AddInt64(&amp;i64, <span class="number">-3</span>)</span><br></pre></td></tr></table></figure><p>不过，由于atomic.AddUint32函数和atomic.AddUint64函数的第二个参数的类型分别是uint32和uint64，所以我们无法通过传递一个负的数值来减小被操作值。那么，这是不是就意味着我们无法原子的减小uint32或uint64类型的值了呢？幸好，不是这样。Go语言为我们提供了一个可以迂回的达到此目的办法。<br>如果我们想原子的把uint32类型的变量ui32的值增加NN（NN代表了一个负整数），那么我们可以这样调用atomic.AddUint32函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic.AddUint32(&amp;ui32, ^<span class="keyword">uint32</span>(-NN<span class="number">-1</span>))</span><br></pre></td></tr></table></figure><p>对于uint64类型的值来说也是这样。调用表达式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic.AddUint64(&amp;ui64, ^<span class="keyword">uint64</span>(-NN<span class="number">-1</span>))</span><br></pre></td></tr></table></figure><p>表示原子的把uint64类型的变量ui64的值增加NN（或者说减小-NN）。<br>之所以这种方式可以奏效，是因为它利用了二进制补码的特性。我们知道，一个负整数的补码可以通过对它按位（除了符号位之外）求反码并加一得到。我们还知道，一个负整数可以由对它的绝对值减一并求补码后得到的数值的二进制表示来代表。例如，如果NN是一个int类型的变量且其值为-35，那么表达式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32</span>(<span class="keyword">int32</span>(NN))</span><br></pre></td></tr></table></figure><p>和</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^<span class="keyword">uint32</span>(-NN<span class="number">-1</span>)</span><br></pre></td></tr></table></figure><p>的结果值就都会是11111111111111111111111111011101。由此，我们使用^uint32(-NN-1)和^uint64(-NN-1)来分别表示uint32类型和uint64类型的NN就顺理成章了。这样，我们就可以合理的绕过uint32类型和uint64类型对值的限制了。<br>以上是官方提供一种通用解决方案。除此之外，我们还有两个非通用的方案可供选择。首先，需要明确的是，对于一个代表负数的字面常量来说，它们是无法通过简单的类型转换将其转换为uint32类型或uint64类型的值的。例如，表达式uint32(-35)和uint64(-35)都是不合法的。它们都不能通过编译。但是，如果我们事先把这个字面量赋给一个变量然后再对这个变量进行类型转换，那么就可以得到Go语言编译器的认可。我们依然以值为-35的变量NN为例，下面这条语句可以通过编译并被正常执行：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">"The variable: %b.\n"</span>, <span class="keyword">uint32</span>(NN))</span><br></pre></td></tr></table></figure><p>其输出内容为：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The variable: <span class="number">11111111111111111111111111011101.</span></span><br></pre></td></tr></table></figure><p>可以看到，表达式uint32(NN)的结果值的二进制表示与前面的uint32(int32(NN))表达式以及^uint32(-NN-1)表达式的结果值是一致的。它们都可以被用来表示uint32类型的-35。因此，我们也可以使用下面的调用表达式来原子的把变量ui32的值减小-NN：<br>atomic.AddUint32(&amp;ui32, uint32(NN))<br>不过，这样的编写方式仅在NN是数值类型的变量的时候才可以通过编译。如果NN是一个常量，那么也会使表达式uint32(NN)不合法并无法通过编译。它与表达式uint32(-35)造成的编译错误是一致的。在这种情况下，我们可以这样来达到上述目的：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic.AddUint32(&amp;ui32, NN&amp;math.MaxUint32)</span><br></pre></td></tr></table></figure><p>其中，我们用到了标准库代码包math中的常量MaxUint32。math.MaxUint32常量表示的是一个32位的、所有二进制位上均为1的数值。我们把NN和math.MaxUint32进行按位与操作的意义是使前者的值能够被视为一个uint32类型的数值。实际上，对于表达式NN&amp;math.MaxUint32来说，其结果值的二进制表示与前面uint32(int32(NN))表达式以及^uint32(-NN-1)表达式的结果值也是一致的。<br>我们在这里介绍的这两种非官方的解决方案是不能混用的。更具体地说，如果NN是一个常量，那么表达式uint32(NN)是无法通过编译的。而如果NN是一个变量，那么表达式NN&amp;math.MaxUint32就无法通过编译。前者的错误在于代表负整数的字面常量不能被转换为uint32类型的值。后者的错误在于这个按位与运算的结果值的类型不是uint32类型而是int类型，从而导致数据溢出的错误。相比之下，官方给出的那个解决方案的适用范围更广。<br>有些读者可能会有这样的疑问：为什么如此曲折的实现这一功能？直接声明出atomic.SubUint32()函数和atomic.SubUint64()函数不好吗？作者理解，不这样做是为了让这些原子操作的API可以整齐划一，并且避免在扩充它们的时候使sync/atomic包中声明的程序实体成倍增加。（作者向Go语言官方提出了这个问题并引发了一些讨论，他们也许会使用投票的方式来选取更好一些的方案）<br>注意，并不存在名为atomic.AddPointer的函数，因为unsafe.Pointer类型值之间既不能被相加也不能被相减。<br>2、比较并交换<br>有些读者可能很熟悉比较并交换操作的英文称谓——Compare And Swap，简称CAS。在sync/atomic包中，这类原子操作由名称以“CompareAndSwap”为前缀的若干个函数代表。<br>我们依然以针对int32类型值的函数为例。该函数名为CompareAndSwapInt32。其声明如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CompareAndSwapInt32</span><span class="params">(addr *<span class="keyword">int32</span>, old, <span class="built_in">new</span> <span class="keyword">int32</span>)</span> <span class="params">(swapped <span class="keyword">bool</span>)</span></span></span><br></pre></td></tr></table></figure><p>可以看到，CompareAndSwapInt32函数接受三个参数。第一个参数的值应该是指向被操作值的指针值。该值的类型即为*int32。后两个参数的类型都是int32类型。它们的值应该分别代表被操作值的旧值和新值。CompareAndSwapInt32函数在被调用之后会先判断参数addr指向的被操作值与参数old的值是否相等。仅当此判断得到肯定的结果之后，该函数才会用参数new代表的新值替换掉原先的旧值。否则，后面的替换操作就会被忽略。这正是“比较并交换”这个短语的由来。CompareAndSwapInt32函数的结果swapped被用来表示是否进行了值的替换操作。<br>与我们前面讲到的锁相比，CAS操作有明显的不同。它总是假设被操作值未曾被改变（即与旧值相等），并一旦确认这个假设的真实性就立即进行值替换。而使用锁则是更加谨慎的做法。我们总是先假设会有并发的操作要修改被操作值，并使用锁将相关操作放入临界区中加以保护。我们可以说，使用锁的做法趋于悲观，而CAS操作的做法则更加乐观。<br>CAS操作的优势是，可以在不形成临界区和创建互斥量的情况下完成并发安全的值替换操作。这可以大大的减少同步对程序性能的损耗。当然，CAS操作也有劣势。在被操作值被频繁变更的情况下，CAS操作并不那么容易成功。有些时候，我们可能不得不利用for循环以进行多次尝试。示例如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> value <span class="keyword">int32</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addValue</span><span class="params">(delta <span class="keyword">int32</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">v := value</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;value, v, (v + delta)) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，为了保证CAS操作的成功完成，我们仅在CompareAndSwapInt32函数的结果值为true时才会退出循环。这种做法与自旋锁的自旋行为相似。addValue函数会不断的尝试原子的更新value的值，直到这一操作成功为止。操作失败的缘由总会是value的旧值已不与v的值相等了。如果value的值会被并发的修改的话，那么发生这种情况是很正常的。<br>CAS操作虽然不会让某个Goroutine阻塞在某条语句上，但是仍可能会使流程的执行暂时停滞。不过，这种停滞的时间大都极其短暂。<br>请记住，当想并发安全的更新一些类型（更具体的讲是，前文所述的那6个类型）的值的时候，我们总是应该优先选择CAS操作。<br>与此对应，被用来进行原子的CAS操作的函数共有6个。除了我们已经讲过的CompareAndSwapInt32函数之外，还有CompareAndSwapInt64、CompareAndSwapPointer、CompareAndSwapUint32、CompareAndSwapUint64 和CompareAndSwapUintptr函数。这些函数的结果声明列表与CompareAndSwapInt32函数的完全一致。而它们的参数声明列表与后者也非常类似。虽然其中的那三个参数的类型不同，但其遵循的规则是一致的，即：第二个和第三个参数的类型均为与第一个参数的类型（即某个指针类型）紧密相关的那个类型。例如，如果第一个参数的类型为*unsafe.Pointer，那么后两个参数的类型就一定是unsafe.Pointer。这也是由这三个参数的含义决定的。<br>3、载入<br>在前面示例的for循环中，我们使用语句v := value为变量v赋值。但是，要注意，其中的读取value的值的操作并不是并发安全的。在该读取操作被进行的过程中，其它的对此值的读写操作是可以被同时进行的。它们并不会受到任何限制。<br>在第7章的第1节的最后，我们举过这样一个例子：在32位计算架构的计算机上写入一个64位的整数。如果在这个写操作未完成的时候有一个读操作被并发的进行了，那么这个读操作很可能会读取到一个只被修改了一半的数据。这种结果是相当糟糕的。<br>为了原子的读取某个值，sync/atomic代码包同样为我们提供了一系列的函数。这些函数的名称都以“Load”为前缀，意为载入。我们依然以针对int32类型值的那个函数为例。<br>我们下面利用LoadInt32函数对上一个示例稍作修改：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addValue</span><span class="params">(delta <span class="keyword">int32</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">v := atomic.LoadInt32(&amp;value)</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;value, v, (v + delta)) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数atomic.LoadInt32接受一个int32类型的指针值，并会返回该指针值指向的那个值。在该示例中，我们使用调用表达式atomic.LoadInt32(&amp;value)替换掉了标识符value。替换后，那条赋值语句的含义就变为：原子的读取变量value的值并把它赋给变量v。有了“原子的”这个形容词就意味着，在这里读取value的值的同时，当前计算机中的任何CPU都不会进行其它的针对此值的读或写操作。这样的约束是受到底层硬件的支持的。<br>注意，虽然我们在这里使用atomic.LoadInt32函数原子的载入value的值，但是其后面的CAS操作仍然是有必要的。因为，那条赋值语句和if语句并不会被原子的执行。在它们被执行期间，CPU仍然可能进行其它的针对value的值的读或写操作。也就是说，value的值仍然有可能被并发的改变。<br>与atomic.LoadInt32函数的功能类似的函数有atomic.LoadInt64、atomic.LoadPointer、atomic.LoadUint32、atomic.LoadUint64和atomic.LoadUintptr。<br>4、存储<br>与读取操作相对应的是写入操作。而sync/atomic包也提供了与原子的值载入函数相对应的原子的值存储函数。这些函数的名称均以“Store”为前缀。<br>在原子的存储某个值的过程中，任何CPU都不会进行针对同一个值的读或写操作。如果我们把所有针对此值的写操作都改为原子操作，那么就不会出现针对此值的读操作因被并发的进行而读到修改了一半的值的情况了。<br>原子的值存储操作总会成功，因为它并不会关心被操作值的旧值是什么。显然，这与前面讲到的CAS操作是有着明显的区别的。因此，我们并不能把前面展示的addValue函数中的调用atomic.CompareAndSwapInt32函数的表达式替换为对atomic.StoreInt32函数的调用表达式。<br>函数atomic.StoreInt32会接受两个参数。第一个参数的类型是int 32类型的，其含义同样是指向被操作值的指针。而第二个参数则是int32类型的，它的值应该代表欲存储的新值。其它的同类函数也会有类似的参数声明列表。<br>5、交换<br>在sync/atomic代码包中还存在着一类函数。它们的功能与前文所讲的CAS操作和原子载入操作都有些类似。这样的功能可以被称为原子交换操作。这类函数的名称都以“Swap”为前缀。<br>与CAS操作不同，原子交换操作不会关心被操作值的旧值。它会直接设置新值。但它又比原子载入操作多做了一步。作为交换，它会返回被操作值的旧值。此类操作比CAS操作的约束更少，同时又比原子载入操作的功能更强。<br>以atomic.SwapInt32函数为例。它接受两个参数。第一个参数是代表了被操作值的内存地址的int32类型值，而第二个参数则被用来表示新值。注意，该函数是有结果值的。该值即是被新值替换掉的旧值。atomic.SwapInt32函数被调用后，会把第二个参数值置于第一个参数值所表示的内存地址上（即修改被操作值），并将之前在该地址上的那个值作为结果返回。其它的同类函数的声明和作用都与此类似。<br>至此，我们快速且简要地介绍了sync/atomic代码包中的所有函数的功能和用法。这些函数都被用来对特定类型的值进行原子性的操作。如果我们想以并发安全的方式操作单一的特定类型（int32、int64、uint32、uint64、uintptr或unsafe.Pointer）的值的话，应该首先考虑使用这些函数来实现。请注意，原子的减小一些特定类型（确切地说，是uint32类型和uint64类型）的值的实现方式并不那么直观。在Go语言官方对此进行改进之前，我们应该按照他们为我们提供的那种方式来进行此类操作。<br>6、应用于实际<br>下面，我们就使用刚刚介绍的知识再次对在前面示例中创建的myDataFile类型进行改造。在myDataFile类型的第二个版本中，我们仍然使用两个互斥锁来对与roffset字段和woffset字段相关的操作进行保护。myDataFile类型的方法中的绝大多数都包含了这些操作。<br>首先，我们来看对roffset字段的操作。在*myDataFile类型的Read方法中有这样一段代码：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取并更新读偏移量</span></span><br><span class="line"><span class="comment">// 原子操作偏移量</span></span><br><span class="line"><span class="keyword">var</span> offset <span class="keyword">int64</span></span><br><span class="line">df.rmutex.Lock()</span><br><span class="line">offset = df.roffset</span><br><span class="line">df.roffset += <span class="keyword">int64</span>(df.dataLen)</span><br><span class="line">df.rmutex.Unlock()</span><br></pre></td></tr></table></figure><p>这段代码的含义是读取读偏移量的值并把它存入到局部变量中，然后增加读偏移量的值以使其它的并发的读操作能够被正确、有效的进行。为了使程序能够在并发环境下有序的对roffset字段进行操作，我们为这段代码应用了互斥锁rmutex。<br>字段roffset和变量offset都是int64类型的。后者代表了前者的旧值。而字段roffset的新值即为其旧值与dataLen字段的值的和。实际上，这正是原子的CAS操作的适用场景。我们现在用CAS操作来实现该段代码的功能：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取并更新读偏移量</span></span><br><span class="line"><span class="keyword">var</span> offset <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">offset = df.roffset</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt64(&amp;df.roffset, offset,</span><br><span class="line">(offset + <span class="keyword">int64</span>(df.dataLen))) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据roffset和offset的类型，我们选用atomic.CompareAndSwapInt64来进行CAS操作。我们在调用该函数的时候传入了三个参数，分别代表了被操作值的地址、旧值和新值。如果该函数的结果值是true，那么我们就退出for循环。这时，变量offset即是我们需要的读偏移量的值。另一方面，如果该函数的结果值是false，那么就说明在从完成读取到开始更新roffset字段的值的期间内有其它的并发操作对该值进行了更改。当遇到这种情况，我们就需要再次尝试。只要尝试失败，我们就会重新读取roffset字段的值并试图对该值进行CAS操作，直到成功为止。具体的尝试次数与具体的并发环境有关。<br>我们在前面说过，在32位计算架构的计算机上写入一个64位的整数也会存在并发安全方面的隐患。因此，我们还应该将这段代码中的offset = df.roffset语句修改为offset = atomic.LoadInt64(&amp;df.roffset)。<br>除了这里，在*myDataFile类型的Rsn方法中也有针对roffset字段的读操作：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df.rmutex.Lock()</span><br><span class="line"><span class="keyword">defer</span> df.rmutex.Unlock()</span><br><span class="line"><span class="keyword">return</span> df.roffset / <span class="keyword">int64</span>(df.dataLen)</span><br></pre></td></tr></table></figure><p>我们现在去掉施加在上面的锁定和解锁操作，转而使用原子操作来实现它。修改后的代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">offset := atomic.LoadInt64(&amp;df.roffset)</span><br><span class="line"><span class="keyword">return</span> offset / <span class="keyword">int64</span>(df.dataLen)</span><br></pre></td></tr></table></figure><p>这样，我们就在依然保证相关操作的并发安全的前提下去除了对互斥锁rmutex的使用。对于字段woffset和互斥锁wmutex，我们也应该如法炮制。读者可以试着按照上面的方法修改与之相关的Write方法和Wsn方法。<br>在修改完成之后，我们就可以把代表互斥锁的rmutex字段和wmutex字段从myDataFile类型的基本结构中去掉了。这样，该类型的基本结构会显得精简了不少。<br>通过本次改造，我们减少了myDataFile类型及其方法对互斥锁的使用。这对该程度的性能和可伸缩性都会有一定的提升。其主要原因是，原子操作由底层硬件支持，而锁则由操作系统提供的API实现。若实现相同的功能，前者通常会更有效率。读者可以为前面展示的这三个版本的*myDataFile类型的实现编写性能测试，以验证上述观点的正确性。<br>总之，我们要善用原子操作。因为它比锁更加简练和高效。不过，由于原子操作自身的限制，锁依然常用且重要。</p>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发之sync.WaitGroup</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8Bsync-WaitGroup/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8Bsync-WaitGroup/</url>
      
        <content type="html"><![CDATA[<h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br></pre></td></tr></table></figure><h2 id="sync-WaitGroup-Golang内置sync包"><a href="#sync-WaitGroup-Golang内置sync包" class="headerlink" title="sync.WaitGroup/ Golang内置sync包"></a>sync.WaitGroup/ Golang内置sync包<a id="more"></a></h2><blockquote><p>Wg变量：该类型有三个指针方法，即Add、Done和Wait。</p><p>类型sync.WaitGroup是一个结构体类型。当一个sync.WaitGroup类型的变量被声明之后，其值中的那个计数值将会是0。 </p><p>我们可以通过该值的Add方法增大或减少其中的计数值。 如下：</p><p>wg.Add(1) </p><p>与wg.Add(-1)的执行效果是一致的： </p><p>wg.Done() </p><p>总结:</p><p>1、使用Done方法禁忌与Add方法的一样——不要让相应的计数值变为负数。 </p><p>例如，这段代码中的第5条语句会引发一个运行时恐慌： </p><p>var wg sync.WaitGroup </p><p>wg.Add(2) </p><p>wg.Done() </p><p>wg.Done() </p><p>wg.Done() </p><p>2、当我们调用sync.WaitGroup类型值的Wait方法的时候，它会去检查该值中的计数值。如果这个计数值为0，那么该方法会立即返回，且不会对程序的运行产生任何影响。 但是，如果这个计数值大于0，那么该方法的调用方所属的那个Goroutine就会被阻塞。直到该计数值重新变为0之时，为此而被阻塞的所有Goroutine才会被唤醒。 </p></blockquote><h2 id="代码案例"><a href="#代码案例" class="headerlink" title="代码案例"></a>代码案例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协调多个Goroutine的运行。假设，在我们的程序中启用了4个Goroutine，分别是G1、G2、G3和G4。其中，G2、G3和G4是由G1中的代码启用并被用于执行某些特定任务的。G1在启用这3个Goroutine之后要等待这些特定任务的完成。</span></span><br><span class="line"><span class="comment">// 方案1（channel通道）</span></span><br><span class="line">sign := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G2</span></span><br><span class="line">    sign &lt;- <span class="number">2</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G3</span></span><br><span class="line">    sign &lt;- <span class="number">3</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G4</span></span><br><span class="line">    sign &lt;- <span class="number">4</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"G%d is ended.\n"</span>, &lt;-sign)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方案2（sync.WaitGroup）</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G2</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G3</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G4</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(<span class="string">"Finish"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">     <span class="string">"fmt"</span></span><br><span class="line">     <span class="string">"sync"</span></span><br><span class="line">     <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">     <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i = i + <span class="number">1</span> &#123;</span><br><span class="line">          wg.Add(<span class="number">1</span>)</span><br><span class="line">          <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">               <span class="comment">// defer wg.Done()</span></span><br><span class="line">               <span class="keyword">defer</span> wg.Add(<span class="number">-1</span>)</span><br><span class="line">               EchoNumber(n)</span><br><span class="line">          &#125;(i) <span class="comment">// n = i</span></span><br><span class="line">     &#125;</span><br><span class="line">     wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EchoNumber</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">     time.Sleep(<span class="number">3e9</span>)</span><br><span class="line">     fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo入坑-主题篇</title>
      <link href="/passages/Hexo%E5%85%A5%E5%9D%91-%E4%B8%BB%E9%A2%98%E7%AF%87/"/>
      <url>/passages/Hexo%E5%85%A5%E5%9D%91-%E4%B8%BB%E9%A2%98%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo入坑-安装篇</title>
      <link href="/passages/Hexo%E5%85%A5%E5%9D%91-%E5%AE%89%E8%A3%85%E7%AF%87/"/>
      <url>/passages/Hexo%E5%85%A5%E5%9D%91-%E5%AE%89%E8%A3%85%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul><li><font size="3">有一个github账号，没有的话去注册一个</font></li><li><font size="3">安装了git、node.js、npm，并了解相关基础知识</font><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">git --version</span><br></pre></td></tr></table></figure></li><li><p><font size="3">安装了git for Mac（或者其它git客户端）</font><a id="more"></a></p></li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="1-创建github仓库"><a href="#1-创建github仓库" class="headerlink" title="1. 创建github仓库"></a>1. 创建github仓库</h3><p>​    github上新建一个名为<code>用户名.github.io</code>的项目，例如：sheldon-lu.github.io，</p><p>这个项目名是用来做域名用的，当然也可以去申请一个属于自己的域名，一般推荐<a href="https://www.GoDaddy.com/" target="_blank" rel="noopener"><code>godaddy</code></a></p><h3 id="2-配置SSH-key免密上传"><a href="#2-配置SSH-key免密上传" class="headerlink" title="2. 配置SSH key免密上传"></a>2. 配置SSH key免密上传</h3><p>不详细讲了，命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.ssh</span><br><span class="line"><span class="meta">#</span> 检查本机已存在的ssh密钥</span><br><span class="line"><span class="meta">#</span> 如果提示：No such file or directory 说明你是第一次使用git。</span><br><span class="line">ssh-keygen -t rsa -C "邮件地址"</span><br><span class="line"><span class="meta">#</span> 然后连续3次回车，最终会生成一个文件在用户目录下，打开用户目录，找到.ssh\id_rsa.pub文件，记事本打开并复制里面的内容，打开你的github主页，进入个人设置 -&gt; SSH and GPG keys -&gt; New SSH key</span><br><span class="line"><span class="meta">#</span> 测试是否成功，验证命令：</span><br><span class="line">ssh -T git@GitHub.com</span><br><span class="line"><span class="meta">#</span># Hi cnfeat! You've successfully authenticated, but GitHub does not provide shell access.出现这个就是成功了，之后可以测试一下push是否免密上传。</span><br><span class="line"><span class="meta">#</span> 此时你可能还需要配置，这个属于全局config，对于git项目完全可以git clone下来之后进行push等等操作：</span><br><span class="line">git config --global user.name "liuxianan"// 你的github用户名，非昵称</span><br><span class="line">git config --global user.email  "xxx@qq.com"// 填写你的github注册邮箱</span><br></pre></td></tr></table></figure><h3 id="3-Hexo安装及介绍"><a href="#3-Hexo安装及介绍" class="headerlink" title="3. Hexo安装及介绍"></a>3. Hexo安装及介绍</h3><p>官网： <a href="http://hexo.io" target="_blank" rel="noopener">http://hexo.io</a> </p><p>github: <a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">https://github.com/hexojs/hexo</a> </p><p>由于github pages存放的都是静态文件，博客存放的不只是文章内容，还有文章列表、分类、标签、翻页等动态内容，假如每次写完一篇文章都要手动更新博文目录和相关链接信息，相信谁都会疯掉，所以hexo所做的就是将这些md文件都放在本地，每次写完文章后调用写好的命令来批量完成相关页面的生成，然后再将有改动的页面提交到github。 </p><p>安装之前先来说几个注意事项： </p><ol><li><p>很多命令既可以用Windows的cmd来完成，也可以使用git bash来完成，但是部分命令会有一些问题，为避免不必要的问题，建议全部使用git bash来执行（对于windows用户而言）； </p></li><li><p>hexo不同版本差别比较大，网上很多文章的配置信息都是基于2.x的，所以注意不要被误导； </p></li><li><p>hexo有2种_config.yml文件，一个是根目录下的全局的_config.yml，一个是各个theme下的； </p></li></ol><p>这里给官网上的部署命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir &lt;Your blog&gt; # 创建blog文档文件夹</span><br><span class="line">npm install hexo-cli -g # 安装hexo以及hexo命令</span><br><span class="line"><span class="meta">#</span> 初始化一个blog项目，其中'blog'为你的blog名字，hexo会自动下载一些文件到这个目录，包括node_modules.</span><br><span class="line">hexo init blog</span><br><span class="line">cd blog</span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span># 这两个命令是经常会用到的</span><br><span class="line">hexo s -g #生成并本地预览</span><br><span class="line">hexo d -g #生成并上传</span><br></pre></td></tr></table></figure><p>对于mac用户，如果遇到以下报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">安装npm install hexo-cli -g时报错</span><br><span class="line">npm install hexo -g</span><br><span class="line">npm WARN locking Error: EACCES, open &apos;/Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock&apos;</span><br><span class="line">npm WARN locking at Error (native)</span><br><span class="line">npm WARN locking /Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock failed &#123; [Error: EACCES, open &apos;/Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock&apos;]</span><br><span class="line">npm WARN locking errno: -13,</span><br><span class="line">npm WARN locking code: &apos;EACCES&apos;,</span><br><span class="line">npm WARN locking path: &apos;/Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock&apos; &#125;</span><br><span class="line">npm ERR! Darwin 14.0.0</span><br><span class="line">npm ERR! argv &quot;node&quot; &quot;/usr/bin/npm&quot; &quot;install&quot; &quot;hexo&quot; &quot;-g&quot;</span><br><span class="line">npm ERR! node v0.12.3</span><br><span class="line">npm ERR! npm v2.9.1</span><br><span class="line">npm ERR! Attempt to unlock /usr/lib/node_modules/hexo, which hasn&apos;t been locked</span><br><span class="line">npm ERR!</span><br><span class="line">npm ERR! If you need help, you may report this error at:</span><br><span class="line">npm ERR! https://github.com/npm/npm/issues</span><br><span class="line">npm ERR! Please include the following file with any support request:</span><br><span class="line">npm ERR! /Users/lushenneng/blog/npm-debug.log</span><br></pre></td></tr></table></figure><p>解决：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 可以先用这个命令：</span><br><span class="line">sudo npm install hexo-cli -g</span><br><span class="line"><span class="meta">#</span> 如果还是报错可以用这个命令：</span><br><span class="line">sudo npm install --unsafe-perm --verbose -g hexo</span><br><span class="line"><span class="meta">#</span> 加上sudo一般能解决很多问题</span><br></pre></td></tr></table></figure><h3 id="4-START-Hexo"><a href="#4-START-Hexo" class="headerlink" title="4. START Hexo"></a>4. START Hexo</h3><p>在blog目录下的_config.yml配置修改如下：(大概是在最后一行)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository:</span><br><span class="line">    github: git@github.com:sheldon-lu/sheldon_blog.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>我这里不指定用的github.io这个域名是因为我用sheldon-lu.github.io作主域名，sheldon_blog作文根，当然这样的话这边hexo内设置如下：(大概在14行左右开始)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># URL</span><br><span class="line">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</span><br><span class="line">url: https://sheldon-lu.github.io/</span><br><span class="line">root: /sheldon_blog</span><br><span class="line"># permalink: :year/:month/:day/:title/</span><br><span class="line">permalink: passages/:title/</span><br><span class="line">permalink_defaults:</span><br></pre></td></tr></table></figure><p>至此，就可以使用了，浏览器输入域名：<a href="https://sheldon-lu.github.io/sheldon_blog即可" target="_blank" rel="noopener">https://sheldon-lu.github.io/sheldon_blog即可</a></p><hr><p><code>1、这里要说明一下，使用 hexo d 上传至github时如果需要用到 gh-pages 的话，记得在自己github的blog项目下创建个gh-pages的分支，即可;</code></p><p><code>2、_config.yml中配置repository时一定配置的要是ssh，别弄的什么https://github之类的</code></p><p>参考地址：<a href="https://ngwind.github.io/2018/07/27/%E4%BD%BF%E7%94%A8gh-pages+Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%BD%91%E9%A1%B5%E6%95%99%E7%A8%8B/" target="_blank" rel="noopener">https://ngwind.github.io/2018/07/27/%E4%BD%BF%E7%94%A8gh-pages+Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%BD%91%E9%A1%B5%E6%95%99%E7%A8%8B/</a></p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
