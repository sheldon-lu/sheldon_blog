<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Golang简明教程</title>
      <link href="/passages/Golang%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/"/>
      <url>/passages/Golang%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-语言-简明教程"><a href="#Go-语言-简明教程" class="headerlink" title="Go 语言 简明教程"></a>Go 语言 简明教程</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Go 是一个开源的编程语言，它能让构造简单、可靠且高效的软件变得容易。Go是从2007年末由Robert Griesemer, Rob Pike, Ken Thompson主持开发，后来还加入了Ian Lance Taylor, Russ Cox等人，并最终于2009年11月开源，在2012年早些时候发布了Go 1稳定版本。现在Go的开发已经是完全开放的，并且拥有一个活跃的社区。</p><h3 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul><li>开源</li><li>编译性语言, 运行高速</li><li>语法简洁</li><li>并行处理封装</li><li>内存管理、数组安全</li></ul><h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul><li>作为编译性语言调试不如脚本方便</li><li>在数据分析上没有脚本适用</li><li>对底层的控制没有基础语言灵活</li></ul><h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p>常应用于搭载 Web 服务器，存储集群或类似用途的巨型中央服务器的系统编程语言。对于高性能分布式系统领域而言，Go 语言无疑比大多数其它语言有着更高的开发效率。它提供了海量并行的支持，在服务端的开发优势较大。</p><h3 id="语言基础"><a href="#语言基础" class="headerlink" title="语言基础"></a>语言基础</h3><h4 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h4><h5 id="变量和常量"><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h5><p>普通赋值:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// var 变量名称 变量类型 = 值</span></span><br><span class="line"><span class="keyword">var</span> num <span class="keyword">int</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>平行赋值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> num1,num2 <span class="keyword">int</span> = <span class="number">1</span>, <span class="number">2</span></span><br></pre></td></tr></table></figure><p>多行赋值</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    num1 <span class="keyword">int</span> = <span class="number">1</span></span><br><span class="line">    num2 <span class="keyword">int</span> = <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><h5 id="整数类型的命名和宽度"><a href="#整数类型的命名和宽度" class="headerlink" title="整数类型的命名和宽度"></a>整数类型的命名和宽度</h5><p>Go的整数类型一共有10个其中计算架构相关的整数类型有两个:</p><ul><li>有符号的整数类型 int</li><li>无符号的整数类型 uint<br>在不同计算架构的计算机上，它们体现的宽度(存储某个类型的值所需要的空间)是不一样的。空间的单位可以是bit也可以是字节byte。</li></ul><p><img src="https://static.studygolang.com/190927/a6639f0384843c736113e484e6556d18.png" alt="img"></p><p>除了这两个计算架构相关的整数类型之外，还有8个可以显式表达自身宽度的整数类型:</p><p><img src="https://static.studygolang.com/190927/59e336051578f6136d1c318ed3ce19eb.png" alt="img"></p><h5 id="整数类型值的表示法"><a href="#整数类型值的表示法" class="headerlink" title="整数类型值的表示法"></a>整数类型值的表示法</h5><p><img src="https://static.studygolang.com/190927/c231eb2bcfb1f895b2aa51ce3e39f0e6.png" alt="img"></p><p>如果以8进制为变量num赋值:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="number">039</span> <span class="comment">// 用"0"作为前缀以表明这是8进制表示法</span></span><br></pre></td></tr></table></figure><p>如果以16进制为变量num赋值:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num = <span class="number">0x39</span></span><br></pre></td></tr></table></figure><h5 id="浮点数类型"><a href="#浮点数类型" class="headerlink" title="浮点数类型"></a>浮点数类型</h5><p>浮点数类型有两个：float32/float64 浮点数类型的值一般由整数部分、小数点”.”和小数部分组成。另外一种表示方法是在其中加入指数部分。指数部分由”E”或”e”以及带正负号的10进制整数表示。例:3.9E-2表示浮点数0.039。3.9E+1表示浮点数39。<br>有时候浮点数类型值也可以被简化。比如39.0可以被简化为39。0.039可以被简化为.039。 在Go中浮点数的相关部分只能由10进制表示法表示。</p><h5 id="复数类型"><a href="#复数类型" class="headerlink" title="复数类型"></a>复数类型</h5><p>复数类型有两个:complex64和complex128。实际上，complex64类型的值会由两个float32类型的值分别表示复数的实数部分和虚数部分。而complex128类型的值会由两个float64类型的值表示复数的实数部分和虚数部分。<br>负数类型的值一般由浮点数表示的实数部分、加号”+”、浮点数表示的虚数部分以及小写字母”i”组成，比如3.9E+1 + 9.99E-2i。</p><h5 id="byte与rune"><a href="#byte与rune" class="headerlink" title="byte与rune"></a>byte与rune</h5><p>byte与rune都属于别名类型。byte是uint8的别名类型，而rune是int32的别名类型。<br>一个rune的类型值即可表示一个Unicode字符。一个Unicode代码点通常由”U+”和一个以十六进制表示法表示的整数表示，例如英文字母’A’的Unicode代码点为”U+0041”。<br>rune类型的值需要由单引号”‘“包裹，不过我们还可以用另外几种方式表示:</p><p><img src="https://static.studygolang.com/190927/07b54d588437f8df20d3e7555aadedcf.png" alt="img"></p><p>另外在rune类型值的表示中支持几种特殊的字符序列，即:转义符。如下图:</p><p><img src="https://static.studygolang.com/190927/c6daa5b5f6099f532d7fed210b4d9408.png" alt="img"></p><h5 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h5><p>字符串的表示法有两种，即：原生表示法和解释型表示法。原生表示法，需用用反引号”`”把字符序列包起来，如果用解释型表示法，则需要用双引号”””包裹字符序列。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> str1 <span class="keyword">string</span> = “str”</span><br><span class="line"><span class="keyword">var</span> str1 <span class="keyword">string</span> = <span class="string">`str`</span></span><br></pre></td></tr></table></figure><p>二者的区别是，前者表示的是所见即所得的(除了回车符)。后者所表示的值中转义符会起作用。<br>字符串值是不可变的，如果我们创建了一个此类型的值，就不可能再对它本身做任何修改。</p><h5 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h5><p>一个数组是可以容纳若干相同类型的元素的容器。数组的长度是固定的。如下声明一个数组类型:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyNumbers [<span class="number">3</span>]<span class="keyword">int</span></span><br></pre></td></tr></table></figure><p>类型声明语句由关键字type、类型名称和类型字面量组成<br>上面这条类型声明语句实际上是为数组类型[3]int声明了一个别名类型。这使得我们可以把MyNumbers当作数组类型[3]int来使用。<br>我们表示这样一个数组类型的值的时候。应该把该类型的类型字面量写在最左边，然后用花括号包裹该值包含的若干元素，各元素之间以(英文半角)逗号分割，即:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><p>现在我们把这个数组字面量赋给一个名为numbers的变量:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><p>这是一条变量声明语句，它在声明变量的同时为该变量赋值</p><p>另一种方式是在其中的类型字面量中省略代表其长度的数组，例：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = [...]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><p>可以用如下方式访问该变量中的任何一个元素。例:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">numbers[<span class="number">0</span>]</span><br><span class="line">numbers[<span class="number">1</span>]</span><br><span class="line">numbers[<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p>如果要修改数组值中的某一个元素值，可以：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numbers[<span class="number">1</span>] = <span class="number">4</span></span><br></pre></td></tr></table></figure><p>可以用如下方式获取数组长度:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> length = <span class="built_in">len</span>(numbers)</span><br></pre></td></tr></table></figure><p>如果一个数组没有赋值，则它的默认值为</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[length]<span class="keyword">type</span>&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>…&#125;</span><br></pre></td></tr></table></figure><h5 id="切片类型"><a href="#切片类型" class="headerlink" title="切片类型"></a>切片类型</h5><p>切片(slice)与数组一样也是可以若干相同类型元素的容器。与数组不同的是切片类型的长度不确定。每个切片值都会将数组作为其底层数据结构。表示切片类型的字面量如:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[]<span class="keyword">int</span></span><br></pre></td></tr></table></figure><p>或者是:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[]<span class="keyword">string</span></span><br></pre></td></tr></table></figure><p>切片类型的声明可以这样:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MySlice []<span class="keyword">int</span></span><br></pre></td></tr></table></figure><p>对切片值的表示也与数组值相似</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br></pre></td></tr></table></figure><p>操作数组值的方法同样适用于切片值。还有一种操作数组的方式叫做“切片”，实施切片操作的方式就是切片表达式。例:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> number3 = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line"><span class="keyword">var</span> slice1 = numbers3[<span class="number">1</span>:<span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>上例中切片表达式numbers3[1:4]的结果为[]int{2,3,4}很明显被切下的部分不包含元素上界索引指向的元素。实际上slice1这个切片值的底层数组正是number3的值。<br>我们也可以在切片值上实施切片操作：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> slice2 = slice1[<span class="number">1</span>:<span class="number">3</span>]</span><br></pre></td></tr></table></figure><p>除了长度切片值以及数组值还有另外一个属性–容量。数组的容量总是等于其长度，而切片值的容量往往与其长度不同。如下图:</p><p><img src="https://static.studygolang.com/190927/8f028c1a13e77e5f90e8757ed78afe60.png" alt="img"></p><p>如图所示，一个切片值的容量即为它的第一个元素值在其底层数组中的索引值与该数组长度的差值的绝对值。可以使用cap()内建函数获取数组、切片、通道类型的值的容量:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> capacity2 <span class="keyword">int</span> = <span class="built_in">cap</span>(slice2)</span><br></pre></td></tr></table></figure><p>切片类型属于引用类型，它的零值即为nil，即空值。如果我们只声明了一个切片类型而不为它赋值，则它的默认值 nil。</p><p>切片的更多操作方法有些时候我们可以在方括号中放入第三个正整数。如下图所示:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">numbers3[<span class="number">1</span>:<span class="number">4</span>:<span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>第三个正整数为容量上界索引，它意义在于可以把作为结果的切片值的容量设置的更小。它可以限制我们通过这个切片值对其底层数组中的更多元素的访问。上节中numbers3和slice的赋值语句如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers3 = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line"><span class="keyword">var</span> slice1 = numbers3[<span class="number">1</span>:<span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>这时，变量slice1的值是[]int{2,3,4}。但是我们可以通过如下操作将其长度延展与其容量相同:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slice1 = slice1[:<span class="built_in">cap</span>(slice1)]</span><br></pre></td></tr></table></figure><p>通过此操作，变量slice1的值变为了[]int{2,3,4,5}，且其长度和容量均为4。现在number3的值中的索引值在(1,5)范围内的元素都被体现在了slice1的值中。这是以number3的值是slice1的值的底层数组为前提的。这意味着我们可以轻而易举地通过切片访问其底层数组中对应索引值更大的更多元素。如果我们编写的函数返回了这样一个切片值，那么得到它的程序很可能会通过这种技巧访问到本不应该暴露给它的元素。<br>如果我们在切片中加入了第三个索引(即容量上限索引)，如：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> slice1 = numbers3[<span class="number">1</span>:<span class="number">4</span>:<span class="number">4</span>]</span><br></pre></td></tr></table></figure><p>那么在此之后，我们将无法通过slice1访问到number3的值中的第五个元素。<br>虽然切片值在上述方面受到了其容量的限制。但是我们可以通过另外一种手段对其进行不受限制的扩展。这需要用到内建函数append。append会对切片值进行扩展并返回一个新的切片值，使用方法如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slice1 = <span class="built_in">append</span>(slice1, <span class="number">6</span>, <span class="number">7</span>)</span><br></pre></td></tr></table></figure><p>通过上述操作，slice1的值变为了[]int{2,3,4,6,7}。一旦扩展操作超出了被操作的切片值的容量，那么该切片的底层数组就会被替换 最后一种操作切片的方式是“复制”。该操作的实施方法是调用copy函数。该函数接收两个类型相同的切片值作为参数，并把第二个参数值中的元素复制到第一个参数值中的相应位置(索引值相同)上。这里有两点需要注意:</p><ol><li>这种复制遵循最小复制原则，即：被复制的元素的个数总是等于长度较短的那个参值的长度。</li><li>与append函数不同，copy函数会直接对其第一个参数值进行修改。</li></ol><p>例:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> slice4 = []<span class="keyword">int</span>&#123;<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>&#125;</span><br><span class="line"><span class="built_in">copy</span>(slice4, slice1)</span><br></pre></td></tr></table></figure><p>通过上述复制操作，slice4会变成[]int{2,3,4,6,7,0,0}。</p><h5 id="字典类型"><a href="#字典类型" class="headerlink" title="字典类型"></a>字典类型</h5><p>Go语言的字典(Map)类型是一个哈希表的实现。字典类型的字面量如下:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">map</span>[K]T</span><br></pre></td></tr></table></figure><p>其中，”K”为键的类型，而”T”则代表元素(值)的类型。如果我们描述一个键类型为int，值类型为string的字典类型的话：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span></span><br></pre></td></tr></table></figure><p>字典的键类型必须是可比较的，否则会引起错误，即键不能是切片、字典、函数类型</p><p>字典值的字面量表示法实际上与数组的切片的字面量表示法很相似。最左边仍然是类型字面量，右边紧挨着由花括号包裹且有英文逗号分隔的键值对。每个键值对的键和值之间由冒号分隔。以字典类型map[int]string为例。他的值的字面量可以是这样的：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>&#123;<span class="number">1</span>:<span class="string">"a"</span>,<span class="number">2</span>:<span class="string">"b"</span>m,<span class="number">3</span>:<span class="string">"c"</span>&#125;</span><br></pre></td></tr></table></figure><p>我们可以把这个值赋给一个变量</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm := <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>&#123;<span class="number">1</span>:<span class="string">"a"</span>,<span class="number">2</span>:<span class="string">"b"</span>,<span class="number">3</span>:<span class="string">"c"</span>&#125;</span><br></pre></td></tr></table></figure><p>可用索引表达式取出字典中的值：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b := mm[<span class="number">2</span>]</span><br></pre></td></tr></table></figure><p>可以用索引表达式赋值:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm[<span class="number">2</span>] = b + <span class="string">"2"</span></span><br></pre></td></tr></table></figure><p>这样mm中键为2的值变为了”b2”。可以用如下方式向字典中添加一个键值对:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mm[<span class="number">4</span>] = <span class="string">""</span></span><br></pre></td></tr></table></figure><p>对于字典值来说，如果指定键没有对应的值则默认为该类型的空值。所以mm[5]会返回一个””。但是这样的话我们就不知道mm[5]到底是””还是mm[5]没有这个值。所以go提供了另外一种写法:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e, ok := mm[<span class="number">5</span>]</span><br></pre></td></tr></table></figure><p>针对字典的索引表达式可以有两个求职结果，第二个求职结果是bool类型的。它用于表明字典值中是否存在指定的键值对。 从字典中删除键值对的方法非常简单，仅仅是调用内建函数delete：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">delete</span>(mm, <span class="number">4</span>)</span><br></pre></td></tr></table></figure><p>无论mm中是否存在以4为键的键值对，delete都删除。 字典类型属于引用类型，它的零值即为nil</p><h5 id="通道类型"><a href="#通道类型" class="headerlink" title="通道类型"></a>通道类型</h5><p>通道(Channel)是Go语言中一种非常独特的数据结构。它可用于在不同Goroutine之间传递类型化的数据。并且是并发安全的。相比之下，之前几种数据类型都不是并发安全的。<br>Goroutine可以被看作是承载可被并发执行的代码块的载体。它们由Go语言的运行时系统调度，并依托操作系统线程(又称内核线程)来并发地执行其中的代码块。<br>通道类型的表示方法很简单，仅由两部分组成:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">chan</span> T</span><br></pre></td></tr></table></figure><p>在这个类型字面量中，左边是代表通道类型的关键字chan,而右边则是一个可变的部分，即代表该通道类型允许传递的数据的类型(或称通道的元素类型)。<br>与其他的数据类型不同，我们无法表示一个通道类型的值，因此，我们无法用字面量来为通道类型的变量赋值。只能通过调用内建函数make来达到目的。make参数可接受两个参数，第一个参数是代表了将被初始化的值的类型的字面量(例: chan int),而第二个参数则是值的长度，例如,若我们想要初始化一个长度为5且元素类型为int的通道值，则需要这样写:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>make函数也可以被用来初始化切片类型或字典类型的值。<br>暂存在通道值中的数据是先进先出。下面，我们声明一个通道类型的变量，并为其赋值:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure><p>这样一来，我们就可以使用接受操作符&lt;-向通道值发送数据了。当然，也可以使用它从通道值接收数据，例如，如果我们要向通道ch1 发送字符串”value1”，那么应该这样做:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch1 &lt;- “value1<span class="string">"</span></span><br></pre></td></tr></table></figure><p>如果我们从ch1那里接收字符串，则要这样:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;- ch1</span><br></pre></td></tr></table></figure><p>我们可以把接受到字符串赋给一个变量，如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value := &lt;- ch1</span><br></pre></td></tr></table></figure><p>与针对字典值的索引表达式一样，针对通道值的接受操作也可以有第二个结果值:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value, ok := &lt;- ch1</span><br></pre></td></tr></table></figure><p>这里的ok的值是bool类型的。它代表了通道值的状态，true代表通道值有效，而false则代表通道值已无效(或称已关闭)，更深层次的原因是，如果在接受操作进行之前或过程中通道值被关闭了，则接收操作会立即结束并返回一个该通道值的元素类型的零值。<br>可以通过函数close来关闭通道:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">close(ch1)</span><br></pre></td></tr></table></figure><p>对通道值的重复关闭会引发运行时异常，会使程序崩溃。在通道值有效的前提下，针对它的发送操作会在通道值已满(其中缓存的数据的个数已等于它的长度)时被阻塞。而向一个已被关闭的通道值发送数据会引发运行时异常。针对有效通道值的接收操作会在它已经为空时被阻塞。通道类型属于引用类型，它的零值为nil。</p><h4 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h4><h5 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h5><p>对应的关键字为if、 else和else if；</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> a := <span class="number">1</span>; a &gt;= <span class="number">1</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"OK"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="选择语句"><a href="#选择语句" class="headerlink" title="选择语句"></a>选择语句</h5><p>对应的关键字为switch、 case和select</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> i &#123;</span><br><span class="line"> <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"> fmt.Printf(<span class="string">"0"</span>)</span><br><span class="line"> <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"> fmt.Printf(<span class="string">"1"</span>)</span><br><span class="line"> <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line"> <span class="keyword">fallthrough</span></span><br><span class="line"> <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line"> fmt.Printf(<span class="string">"3"</span>)</span><br><span class="line"> <span class="keyword">case</span> <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>:</span><br><span class="line"> fmt.Printf(<span class="string">"4, 5, 6"</span>)</span><br><span class="line"> <span class="keyword">default</span>:</span><br><span class="line"> fmt.Printf(<span class="string">"Default"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h5><p>对应的关键字为for和range；</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sum := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"> sum += i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="跳转语句"><a href="#跳转语句" class="headerlink" title="跳转语句"></a>跳转语句</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">myfunc</span><span class="params">()</span></span> &#123;</span><br><span class="line"> i := <span class="number">0</span></span><br><span class="line"> HERE:</span><br><span class="line"> fmt.Println(i)</span><br><span class="line"> i++</span><br><span class="line"> <span class="keyword">if</span> i &lt; <span class="number">10</span> &#123;</span><br><span class="line"> <span class="keyword">goto</span> HERE</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><h5 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h5><p>首先函数的格式是固定的，func＋函数名＋ 参数 ＋ 返回值（可选） ＋ 函数体。例 :</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>（） </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">fmt.Println(<span class="string">"Hello go"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在golang中有两个特殊的函数，main函数和init函数，main函数不用介绍在所有语言中都一样，它作为一个程序的入口，只能有一个。init函数在每个package是可选的，可有可无，甚至可以有多个(但是强烈建议一个package中一个init函数)，init函数在你导入该package时程序会自动调用init函数，所以init函数不用我们手动调用,另外它只会被调用一次，因为当一个package被多次引用时，它只会被导入一次。</p><h5 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h5><ul><li>普通变量<br>使用普通变量作为函数参数的时候，在传递参数时只是对变量值得拷贝，即将实参的值复制给变参，当函数对变参进行处理时，并不会影响原来实参的值。</li><li>指针<br>函数的变量不仅可以使用普通变量，还可以使用指针变量，使用指针变量作为函数的参数时，在进行参数传递时将是一个地址看呗，即将实参的内存地址复制给变参，这时对变参的修改也将会影响到实参的值。</li><li>数组<br>和其他语言不同的是，go语言在将数组名作为函数参数的时候，参数传递即是对数组的复制。在形参中对数组元素的修改都不会影响到数组元素原来的值。</li><li>slice, map, chan<br>在使用slice, map, chan 作为函数参数时，进行参数传递将是一个地址拷贝，即将底层数组的内存地址复制给参数slice, map, chan 。这时，对slice, map, chan 元素的操作就是对底层数组元素的操作。</li><li>函数名字<br>在go语言中，函数也作为一种数据类型，所以函数也可以作为函数的参数来使用。</li></ul><h5 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h5><p>go语言可以返回局部变量的指针，因为go语言的回收机制是当销毁栈上的临时数据且发现有被外部引用的栈上变量时，会自动转移到堆上。</p><h5 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h5><p>和其他语言类似，golang也支持闭包函数</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">adder</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">     sum := <span class="number">0</span></span><br><span class="line">     <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(x <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">          sum += x</span><br><span class="line">          <span class="keyword">return</span> sum</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     pos, neg := adder(), adder()</span><br><span class="line">     <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">          fmt.Println(</span><br><span class="line">               pos(i),</span><br><span class="line">               neg(<span class="number">-2</span>*i),</span><br><span class="line">          )</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="类"><a href="#类" class="headerlink" title="类"></a>类</h4><h5 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Poem <span class="keyword">struct</span> &#123;</span><br><span class="line">    Title  <span class="keyword">string</span></span><br><span class="line">    Author <span class="keyword">string</span></span><br><span class="line">    intro  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就声明了一个类，其中没有public、protected、private的的声明。<strong>golang用另外一种做法来实现属性的访问权限：属性的开头字母是大写的则在其它包中可以被访问，否则只能在本包中访问。类的声明和方法亦是如此</strong>。</p><h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(poem *Poem)</span> <span class="title">publish</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"poem publish"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(poem Poem)</span> <span class="title">publish</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"poem publish"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和其它语言不一样，golang声明方法和普通方法一致，只是在func后增加了poem <em>Poem这样的声明。加</em>和没有加*的区别在于一个是传递指针对象，一个是传递值对象。</p><p>注意当创建了方法1后将会默认创建出方法2,反之则不会。</p><h5 id="类的实例化"><a href="#类的实例化" class="headerlink" title="类的实例化"></a>类的实例化</h5><p>实例化对象有好几种方式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">poem := &amp;Poem&#123;&#125;</span><br><span class="line"></span><br><span class="line">poem.Author = <span class="string">"Heine"</span></span><br><span class="line"></span><br><span class="line">poem2 := &amp;Poem&#123;Author: <span class="string">"Heine"</span>&#125;</span><br><span class="line"></span><br><span class="line">poem3 := <span class="built_in">new</span>(Poem)</span><br><span class="line"></span><br><span class="line">poem3.Author = <span class="string">"Heine"</span></span><br><span class="line"></span><br><span class="line">poem4 := Poem&#123;&#125;</span><br><span class="line"></span><br><span class="line">poem4.Author = <span class="string">"Heine"</span></span><br><span class="line"></span><br><span class="line">poem5 := Poem&#123;Author: <span class="string">"Heine"</span>&#125;</span><br></pre></td></tr></table></figure><p>实例化的时候可以初始化属性值，如果没有指明则默认为系统默认值。</p><h5 id="伪继承"><a href="#伪继承" class="headerlink" title="伪继承"></a>伪继承</h5><p>golang中不存在继承，但可以使用组合的方式达到类似的效果.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Poem)</span> <span class="title">ShowTitle</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Printf(e.Title)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> Poem <span class="keyword">struct</span> &#123;</span><br><span class="line">    Title  <span class="keyword">string</span></span><br><span class="line">    Author <span class="keyword">string</span></span><br><span class="line">    intro  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ProsePoem <span class="keyword">struct</span> &#123;</span><br><span class="line">    Poem</span><br><span class="line">    Author <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProsePoem属性中声明了Poem，表示组合了Poem的属性和方法<strong>(属性和方法都会被继承)</strong>。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">prosePoem := &amp;ProsePoem&#123;</span><br><span class="line">        Poem: Poem&#123;</span><br><span class="line">            Title:  <span class="string">"Jack"</span>,</span><br><span class="line">            Author: <span class="string">"slow"</span>,</span><br><span class="line">            intro:  <span class="string">"simple"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        Author: <span class="string">"test"</span>,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>如果其中属性有冲突，则以外围的为主，也就是说会被覆盖。同样类方法出现冲突时也会覆盖，并不会支持重载</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ProsePoem <span class="keyword">struct</span> &#123;</span><br><span class="line">    Poem</span><br><span class="line">    Author <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>当访问Author的时候默认为ProsePoem的Author，如果需要访问Poem的Author属性可以使用</strong><br><strong>prosePoem.Poem.Author来访问方法同理</strong>。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">prosePoem := &amp;ProsePoem&#123;&#125;</span><br><span class="line"></span><br><span class="line">prosePoem.Author = <span class="string">"Shelley"</span></span><br><span class="line"></span><br><span class="line">prosePoem.Poem.Author = <span class="string">"Heine"</span></span><br><span class="line"></span><br><span class="line">fmt.Println(prosePoem)</span><br></pre></td></tr></table></figure><p>从输出中可以很直观看到这一点。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;&#123;&#123; Heine &#125; Shelley&#125;</span><br></pre></td></tr></table></figure><h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>Golang的interface是方法的集合也是一种类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Animal <span class="keyword">interface</span> &#123;</span><br><span class="line">    Speak() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Cat <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Cat)</span> <span class="title">Speak</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"cat"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Dog <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d Dog)</span> <span class="title">Speak</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"dog"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span><span class="params">(params <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    fmt.Println(params)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    animals := []Animal&#123;Cat&#123;&#125;, Dog&#123;&#125;&#125;</span><br><span class="line">    <span class="keyword">for</span> _, animal := <span class="keyword">range</span> animals &#123;</span><br><span class="line">        fmt.Println(animal.Speak())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Test(<span class="string">"string"</span>)</span><br><span class="line">    Test(<span class="number">123</span>)</span><br><span class="line">    Test(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上所示，将Struct 向 Interface变量赋值，实际作用是Interface获取了Struct中方法的实现集合。</p><h4 id="断言和反射"><a href="#断言和反射" class="headerlink" title="断言和反射"></a>断言和反射</h4><p>断言是预判确认变量的类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    v := <span class="string">"hello world"</span></span><br><span class="line">    fmt.Println(typeof(v))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">typeof</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> t := v.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">int</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"int"</span></span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">float64</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"float64"</span></span><br><span class="line">    <span class="comment">//... etc</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        _ = t</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"unknown"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反射则是因为interface中实际记录的有存储对象的类型，可以提取出变量的类型</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"reflect"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    v := <span class="string">"hello world"</span></span><br><span class="line">    fmt.Println(typeof(v))</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">typeof</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> reflect.TypeOf(v).String()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-7-回收处理"><a href="#4-7-回收处理" class="headerlink" title="4.7 回收处理"></a>4.7 回收处理</h4><p>在golang当中，defer代码块会在函数调用链表中增加一个函数调用。这个函数调用不是普通的函数调用，而是会在函数正常返回，也就是return之后添加一个函数调用。因此，defer通常用来释放函数内部变量。</p><p>如下示例</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(dstName, srcName <span class="keyword">string</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line">src, err := os.Open(srcName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> src.Close()</span><br><span class="line"></span><br><span class="line">dst, err := os.Create(dstName)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> dst.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> io.Copy(dst, src)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过defer，我们可以在代码中优雅的关闭/清理代码中所使用的变量。defer作为golang清理变量的特性，有其独有且明确的行为。以下是defer三条使用规则。</p><ul><li>当defer被声明时，其参数就会被实时解析<br>即defer的参数的变量值，在代码中defer使用后的位置改变并不会对改变defer用到的值</li><li>defer执行顺序为先进后出<br>在函数中，先定义的defer将会后执行</li><li>defer可以读取有名返回值<br>defer代码块的作用域仍然在函数之内，因此defer仍然可以读取函数内的变量</li></ul><h4 id="make和new的区别"><a href="#make和new的区别" class="headerlink" title="make和new的区别"></a>make和new的区别</h4><p>new 的作用是初始化一个指向类型的指针(*T)，make 的作用是为 slice，map 或 chan 初始化并返回引用(T)。</p><h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p>对于异常处理，golang提供了recover和panic。</p><p>如下示例</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"1"</span>)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="built_in">panic</span>(<span class="string">"fault"</span>)</span><br><span class="line">    fmt.Println(<span class="string">"2"</span>)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">运行结果：</span><br><span class="line">fault</span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p>程序首先运行panic，出现故障，此时跳转到包含recover()的defer函数执行，recover捕获panic，此时panic就不继续传递．但是recover之后，程序并不会返回到panic那个点继续执行以后的动作，而是在recover这个点继续执行以后的动作，即执行上面的defer函数，输出１.</p><p>利用recover处理panic指令，必须利用defer在panic之前声明，否则当panic时，recover无法捕获到panic，无法防止panic扩散．</p><h4 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h4><p>Go调度的几个概念：</p><p>M：内核线程；<br>G：go routine，并发的最小逻辑单元，由程序员创建；<br>P：处理器，执行G的上下文环境，每个P会维护一个本地的go routine队列；</p><p><img src="https://static.studygolang.com/190927/f19c0608b3bda1fa5179412c45a5a307.png" alt="img"></p><p>除了每个P拥有一个本地的go routine队列外，还存在一个全局的go routine队列。</p><p>具体调度原理：</p><ol><li>P的数量在初始化由GOMAXPROCS决定；</li><li>我们要做的就是添加G；</li><li>G的数量超出了M的处理能力，且还有空余P的话，runtime就会自动创建新的M；</li><li>M拿到P后才能干活，取G的顺序：本地队列&gt;全局队列&gt;其他P的队列，如果所有队列都没有可用的G，M会归还P并进入休眠；</li></ol><p>一个G如果发生阻塞等事件会进行阻塞，如下图：</p><p><img src="https://static.studygolang.com/190927/0ac890708a97a7be7c28b6a208bac660.png" alt="img"></p><p>G发生上下文切换条件：</p><ul><li>系统调用；</li><li>读写channel；</li><li>gosched主动放弃，会将G扔进全局队列；</li></ul><p>如上图，一个G发生阻塞时，M0让出P，由M1接管其任务队列；当M0执行的阻塞调用返回后，再将G0扔到全局队列，自己则进入睡眠（没有P了无法干活）；</p><p>下面例子说明协程的使用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">say</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">2</span>; i++ &#123;</span><br><span class="line">        runtime.Gosched()</span><br><span class="line">        fmt.Println(s)</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> say(<span class="string">"world"</span>)</span><br><span class="line">    say(<span class="string">"hello"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">输出结果：</span><br><span class="line"></span><br><span class="line">hello</span><br><span class="line">world</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p>1、先输出了hello,后输出了world.</p><p>2、hello输出了2个，world输出了1个（因为第2个hello输出完，主线程就退出了，第2个world没机会了）</p><p>把代码中的runtime.Gosched()注释掉，执行结果是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p>因为say(“hello”)这句占用了时间，等它执行完，线程也结束了，say(“world”)就没有机会了。</p><p>这里同时可以看出，go中的goroutins并不是同时在运行。事实上，如果没有在代码中通过</p><p>runtime.GOMAXPROCS(n) 其中n是整数，</p><p>指定使用多核的话，goroutins都是在一个线程里的，它们之间通过不停的让出时间片轮流运行，达到类似同时运行的效果。</p><h4 id="包管理"><a href="#包管理" class="headerlink" title="包管理"></a>包管理</h4><h5 id="package-的导入语法"><a href="#package-的导入语法" class="headerlink" title="package 的导入语法"></a>package 的导入语法</h5><p>写 Go 代码的时经常用到 import 这个命令用来导入包，参考如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import( &quot;fmt&quot; )</span><br></pre></td></tr></table></figure><p>然后在代码里面调用该包的方法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println( &quot;hello go&quot; )</span><br></pre></td></tr></table></figure><p>fmt 是 Go 的标准库，它其实是去 GOROOT 下去加载该模块，当然 Go 的 import 还支持如下两种方式来加载自己写的模块：</p><ul><li>相对路径<br>import “./model” // 当前文件同一目录的 model 目录，但是不建议这种方式 import</li><li>绝对路径<br>import “shorturl/model” // 加载 GOPATH/src/shorturl/model 模块</li></ul><h5 id="package-的导入的特殊用法"><a href="#package-的导入的特殊用法" class="headerlink" title="package 的导入的特殊用法"></a>package 的导入的特殊用法</h5><p>上面展示了一些 import 常用的几种方式，但是还有一些特殊的 import ，让很多新手很费解，下面是三种导入包的使用方法。</p><p><strong>点操作</strong></p><p>有时候会看到如下的方式导入包：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import( </span><br><span class="line">    . &quot;fmt&quot; </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这个点操作的含义就是这个包导入之后在你调用这个包的函数时，你可以省略前缀的包名，也就是前面你调用的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println( &quot;hello go&quot; )</span><br></pre></td></tr></table></figure><p>可以写成：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Println( &quot;hello go&quot; )</span><br></pre></td></tr></table></figure><p><strong> 别名操作</strong><br>别名操作顾名思义可以把包命名成另一个用起来容易记忆的名字：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import( </span><br><span class="line">    f &quot;fmt&quot; </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>别名操作调用包函数时前缀变成了重命名的前缀，即：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.Println( &quot;hello go&quot; )</span><br></pre></td></tr></table></figure><p><strong>下划线操作</strong><br>这个操作经常是让很多人费解的一个操作符，请看下面这个 import</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import ( </span><br><span class="line">    _ “github.com/xiyanxiyan10/misakago&quot; </span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>下划线操作并不想引用该包中的方法等，只是希望导入包时自动执行其中的Init()函数来做需要的初始化工作。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux之route详解</title>
      <link href="/passages/Linux%E4%B9%8Broute%E8%AF%A6%E8%A7%A3/"/>
      <url>/passages/Linux%E4%B9%8Broute%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-路由表详解及-route-命令详解"><a href="#Linux-路由表详解及-route-命令详解" class="headerlink" title="Linux 路由表详解及 route 命令详解"></a>Linux 路由表详解及 route 命令详解</h2><h3 id="Linux-内核的路由表"><a href="#Linux-内核的路由表" class="headerlink" title="Linux 内核的路由表"></a>Linux 内核的路由表</h3><p>通过 <code>route</code> 命令查看 Linux 内核的路由表：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">default         gateway         0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.10       10.139.128.1    255.255.255.255 UGH   0      0        0 eth0</span><br><span class="line">10.139.128.0    0.0.0.0         255.255.224.0   U     0      0        0 eth0</span><br><span class="line">link-local      0.0.0.0         255.255.0.0     U     1002   0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-0ab63c131848</span><br><span class="line">172.19.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-bccbfb788da0</span><br><span class="line">172.20.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-7485db25f958</span><br><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.139.128.1    0.0.0.0         UG    0      0        0 eth0</span><br><span class="line">10.0.0.10       10.139.128.1    255.255.255.255 UGH   0      0        0 eth0</span><br><span class="line">10.139.128.0    0.0.0.0         255.255.224.0   U     0      0        0 eth0</span><br><span class="line">169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-0ab63c131848</span><br><span class="line">172.19.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-bccbfb788da0</span><br><span class="line">172.20.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-7485db25f95812345678910111213141516171819202122</span><br></pre></td></tr></table></figure><p>各列字段说明：</p><table><thead><tr><th>列</th><th>含义</th></tr></thead><tbody><tr><td>Destination</td><td>目标网络或目标主机。Destination 为 default（<code>0.0.0.0</code>）时，表示这个是默认网关，所有数据都发到这个网关（这里是 <code>10.139.128.1</code>）</td></tr><tr><td>Gateway</td><td>网关地址，<code>0.0.0.0</code> 表示当前记录对应的 Destination 跟本机在同一个网段，通信时不需要经过网关</td></tr><tr><td>Genmask</td><td>Destination 字段的网络掩码，Destination 是主机时需要设置为 <code>255.255.255.255</code>，是默认路由时会设置为 <code>0.0.0.0</code></td></tr><tr><td>Flags</td><td>标记，含义参考表格后面的解释</td></tr><tr><td>Metric</td><td>路由距离，到达指定网络所需的中转数，是大型局域网和广域网设置所必需的 （不在Linux内核中使用。）</td></tr><tr><td>Ref</td><td>路由项引用次数 （不在Linux内核中使用。）</td></tr><tr><td>Use</td><td>此路由项被路由软件查找的次数</td></tr><tr><td>Iface</td><td>网卡名字，例如 <code>eth0</code></td></tr></tbody></table><p>Flags 含义：</p><ul><li>U 路由是活动的</li><li>H 目标是个主机</li><li>G 需要经过网关</li><li>R 恢复动态路由产生的表项</li><li>D 由路由的后台程序动态地安装</li><li>M 由路由的后台程序修改</li><li>! 拒绝路由</li></ul><h3 id="Linux-内核的路由种类"><a href="#Linux-内核的路由种类" class="headerlink" title="Linux 内核的路由种类"></a>Linux 内核的路由种类</h3><h4 id="主机路由"><a href="#主机路由" class="headerlink" title="主机路由"></a>主机路由</h4><p>路由表中指向单个 IP 地址或主机名的路由记录，其 Flags 字段为 H。下面示例中，对于 <code>10.0.0.10</code> 这个主机，通过网关 <code>10.139.128.1</code> 网关路由：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">10.0.0.10       10.139.128.1    255.255.255.255 UGH   0      0        0 eth0</span><br><span class="line">...12345</span><br></pre></td></tr></table></figure><h4 id="网络路由"><a href="#网络路由" class="headerlink" title="网络路由"></a>网络路由</h4><p>主机可以到达的网络。下面示例中，对于 <code>10.0.0.0/24</code> 这个网络，通过网关 <code>10.139.128.1</code> 网关路由：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">10.0.0.0        10.139.128.1    255.255.255.0   UG    0      0        0 eth01234</span><br></pre></td></tr></table></figure><h4 id="默认路由"><a href="#默认路由" class="headerlink" title="默认路由"></a>默认路由</h4><p>当目标主机的 IP 地址或网络不在路由表中时，数据包就被发送到默认路由（默认网关）上。默认路由的 <code>Destination</code> 是 default 或 <code>0.0.0.0</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">default         gateway         0.0.0.0         UG    0      0        0 eth01234</span><br></pre></td></tr></table></figure><h3 id="route-命令"><a href="#route-命令" class="headerlink" title="route 命令"></a>route 命令</h3><p>route 命令可以显示或设置 Linux 内核中的路由表，主要是静态路由。</p><p>对于局域网中的 Linux 主机，要想访问 Internet，需要将局域网的网关 IP 地址设置为这个主机的默认路由。在命令行中通过 <code>route</code> 命令添加的路由在网卡重启或机器重启后失效。可以在 <code>/etc/rc.local</code> 中添加 route 命令来保证路由设置永久有效。</p><p>选项:</p><ul><li><code>-A</code>：设置地址类型</li><li><code>-C</code>：打印 Linux 内核的路由缓存</li><li><code>-v</code>：显示详细信息</li><li><code>-n</code>：不执行 DNS 反向查找，直接显示数字形式的 IP 地址</li><li><code>-e</code>：netstat 格式显示路由表</li><li><code>-net</code>：到一个网络的路由表</li><li><code>-host</code>：到一个主机的路由表</li></ul><p>参数：</p><ul><li>add：增加路由记录</li><li>del：删除路由记录</li><li>target：目的网络或目的主机</li><li>gw：设置默认网关</li><li>mss：设置TCP的最大区块长度（MSS），单位MB</li><li>window：指定通过路由表的TCP连接的TCP窗口大小</li><li>dev：路由记录所表示的网络接口</li></ul><h4 id="添加路由-add"><a href="#添加路由-add" class="headerlink" title="添加路由 add"></a>添加路由 add</h4><p>可以添加一条可用路由，或添加一条要屏蔽的路由。</p><h5 id="添加主机路由"><a href="#添加主机路由" class="headerlink" title="添加主机路由"></a>添加主机路由</h5><p>添加主机路由时，需要指定网络 ID 和主机 ID，此时需要设置 <code>netmask 255.255.255.255</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route add -net 10.0.0.10 netmask 255.255.255.255 gw 10.139.128.1 dev eth0</span></span><br><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">10.0.0.10       10.139.128.1    255.255.255.255 UGH   0      0        0 eth0</span><br><span class="line">...123456</span><br></pre></td></tr></table></figure><h5 id="添加网络路由"><a href="#添加网络路由" class="headerlink" title="添加网络路由"></a>添加网络路由</h5><p>添加网络路由时，只需指定网络 ID，通过 <code>netmask</code> 设置掩码长度：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route add -net 10.0.0.0 netmask 255.255.255.0 gw 10.139.128.1 dev eth0</span></span><br><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">10.0.0.0        10.139.128.1    255.255.255.0   UG    0      0        0 eth0</span><br><span class="line">...123456</span><br></pre></td></tr></table></figure><h5 id="添加添加同一个局域网的主机"><a href="#添加添加同一个局域网的主机" class="headerlink" title="添加添加同一个局域网的主机"></a>添加添加同一个局域网的主机</h5><p>不指定 gw 选项时，添加的路由记录不使用网关：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route add -net 224.0.0.0 netmask 240.0.0.0 dev eth0</span></span><br><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">224.0.0.0       0.0.0.0         240.0.0.0       U     0      0        0 eth0</span><br><span class="line">...123456</span><br></pre></td></tr></table></figure><h5 id="屏蔽路由"><a href="#屏蔽路由" class="headerlink" title="屏蔽路由"></a>屏蔽路由</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]# route add -net 224.0.0.0 netmask 240.0.0.0 reject</span><br><span class="line">[root@VM_139_74_centos ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">224.0.0.0       -               240.0.0.0       !     0      -        0 -</span><br><span class="line">...123456</span><br></pre></td></tr></table></figure><h4 id="删除路由记录"><a href="#删除路由记录" class="headerlink" title="删除路由记录"></a>删除路由记录</h4><p>跟添加路由类似，可以删除一条可用路由，或删除一条屏蔽的路由。</p><h5 id="删除可用路由"><a href="#删除可用路由" class="headerlink" title="删除可用路由"></a>删除可用路由</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route del -net 224.0.0.0 netmask 240.0.0.01</span><br></pre></td></tr></table></figure><h5 id="删除屏蔽的路由"><a href="#删除屏蔽的路由" class="headerlink" title="删除屏蔽的路由"></a>删除屏蔽的路由</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">route del -net 224.0.0.0 netmask 240.0.0.0 reject1</span><br></pre></td></tr></table></figure><h3 id="删除和添加设置默认网关"><a href="#删除和添加设置默认网关" class="headerlink" title="删除和添加设置默认网关"></a>删除和添加设置默认网关</h3><p>添加或删除默认网关时，Linux 会自动检查网关的可用性：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route add default gw 192.168.1.1</span></span><br><span class="line">SIOCADDRT: Network is unreachable</span><br><span class="line">[root@VM_139_74_centos ~]<span class="comment"># route del default gw 192.168.1.1</span></span><br><span class="line">SIOCDELRT: No such process1234</span><br></pre></td></tr></table></figure><h3 id="ip-route和route命令"><a href="#ip-route和route命令" class="headerlink" title="ip route和route命令"></a>ip route和route命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ip route</span><br><span class="line">default via 172.16.0.1 dev ens192 proto static metric 100 </span><br><span class="line">172.16.0.0/16 dev ens192 proto kernel scope link src 172.16.1.11 metric 100 </span><br><span class="line">172.16.60.4 via 172.16.0.1 dev ens192 </span><br><span class="line">172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 </span><br><span class="line">172.18.0.0/16 dev br-dae2a5b9f054 proto kernel scope link src 172.18.0.1</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         172.16.0.1      0.0.0.0         UG    100    0        0 ens192</span><br><span class="line">172.16.0.0      0.0.0.0         255.255.0.0     U     100    0        0 ens192</span><br><span class="line">172.16.60.4     172.16.0.1      255.255.255.255 UGH   0      0        0 ens192</span><br><span class="line">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0</span><br><span class="line">172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 br-dae2a5b9f054</span><br></pre></td></tr></table></figure><p>第一路由：表示去任何地方，都发送给网卡ens192，并经过网关172.16.0.1，发出。</p><p>第二路由：表示发往 172.16.0.0/16 这个网段的包，都由网卡ens192发出，src 172.16.1.11 表示，网卡ens192的ip是172.16.1.11，metric 100表示 路由距离，到达指定网络所需的中转数。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux之tcpdump详解</title>
      <link href="/passages/Linux%E4%B9%8Btcpdump%E8%AF%A6%E8%A7%A3/"/>
      <url>/passages/Linux%E4%B9%8Btcpdump%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<h2 id="超详细的网络抓包神器-Tcpdump-使用指南"><a href="#超详细的网络抓包神器-Tcpdump-使用指南" class="headerlink" title="超详细的网络抓包神器 Tcpdump 使用指南"></a>超详细的网络抓包神器 Tcpdump 使用指南</h2><p><strong>前言</strong></p><blockquote><p>本文主要内容翻译自<strong>《Tcpdump Examples》[1]</strong>。</p></blockquote><p><code>tcpdump</code> 是一款强大的网络抓包工具，它使用 <code>libpcap</code> 库来抓取网络数据包，这个库在几乎在所有的 Linux/Unix 中都有。熟悉 tcpdump 的使用能够帮助你分析调试网络数据，本文将通过一个个具体的示例来介绍它在不同场景下的使用方法。不管你是系统管理员，程序员，云原生工程师还是 yaml 工程师，掌握 tcpdump 的使用都能让你如虎添翼，升职加薪。</p><h3 id="01基本语法和使用方法"><a href="#01基本语法和使用方法" class="headerlink" title="01基本语法和使用方法"></a>01基本语法和使用方法</h3><p><code>tcpdump</code> 的常用参数如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i eth0 -nn -s0 -v port <span class="number">80</span></span><br></pre></td></tr></table></figure><ul><li><strong>-i</strong> : 选择要捕获的接口，通常是以太网卡或无线网卡，也可以是 <code>vlan</code> 或其他特殊接口。如果该系统上只有一个网络接口，则无需指定。</li><li><strong>-nn</strong> : 单个 n 表示不解析域名，直接显示 IP；两个 n 表示不解析域名和端口。这样不仅方便查看 IP 和端口号，而且在抓取大量数据时非常高效，因为<a href="https://cloud.tencent.com/product/cns?from=10680" target="_blank" rel="noopener">域名解析</a>会降低抓取速度。</li><li><strong>-s0</strong> : tcpdump 默认只会截取前 <code>96</code> 字节的内容，要想截取所有的报文内容，可以使用 <code>-s number</code>， <code>number</code> 就是你要截取的报文字节数，如果是 0 的话，表示截取报文全部内容。</li><li><strong>-v</strong> : 使用 <code>-v</code>，<code>-vv</code> 和 <code>-vvv</code> 来显示更多的详细信息，通常会显示更多与特定协议相关的信息。</li><li><code>port 80</code> : 这是一个常见的端口过滤器，表示仅抓取 <code>80</code> 端口上的流量，通常是 HTTP。</li></ul><p>额外再介绍几个常用参数：</p><ul><li><strong>-p</strong> : 不让网络接口进入混杂模式。默认情况下使用 tcpdump 抓包时，会让网络接口进入混杂模式。一般计算机网卡都工作在非混杂模式下，此时网卡只接受来自网络端口的目的地址指向自己的数据。当网卡工作在混杂模式下时，网卡将来自接口的所有数据都捕获并交给相应的驱动程序。如果设备接入的交换机开启了混杂模式，使用 <code>-p</code> 选项可以有效地过滤噪声。</li><li><strong>-e</strong> : 显示数据链路层信息。默认情况下 tcpdump 不会显示数据链路层信息，使用 <code>-e</code> 选项可以显示源和目的 MAC 地址，以及 VLAN tag 信息。例如：</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -n -e -c <span class="number">5</span> not ip6</span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br-lan, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">18</span>:<span class="number">27</span>:<span class="number">53.619865</span> <span class="number">24</span>:<span class="number">5</span>e:be:<span class="number">0</span>c:<span class="number">17</span>:af &gt; <span class="number">00</span>:e2:<span class="number">69</span>:<span class="number">23</span>:d3:<span class="number">3</span>b, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">1162</span>: <span class="number">192.168</span><span class="number">.100</span><span class="number">.20</span><span class="number">.51410</span> &gt; <span class="number">180.176</span><span class="number">.26</span><span class="number">.193</span><span class="number">.58695</span>: Flags [.], seq <span class="number">2045333376</span>:<span class="number">2045334484</span>, ack <span class="number">3398690514</span>, win <span class="number">751</span>, length <span class="number">1108</span></span><br><span class="line"><span class="number">18</span>:<span class="number">27</span>:<span class="number">53.626490</span> <span class="number">00</span>:e2:<span class="number">69</span>:<span class="number">23</span>:d3:<span class="number">3</span>b &gt; <span class="number">24</span>:<span class="number">5</span>e:be:<span class="number">0</span>c:<span class="number">17</span>:af, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">68</span>: <span class="number">220.173</span><span class="number">.179</span><span class="number">.66</span><span class="number">.36017</span> &gt; <span class="number">192.168</span><span class="number">.100</span><span class="number">.20</span><span class="number">.51410</span>: UDP, length <span class="number">26</span></span><br><span class="line"><span class="number">18</span>:<span class="number">27</span>:<span class="number">53.626893</span> <span class="number">24</span>:<span class="number">5</span>e:be:<span class="number">0</span>c:<span class="number">17</span>:af &gt; <span class="number">00</span>:e2:<span class="number">69</span>:<span class="number">23</span>:d3:<span class="number">3</span>b, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">1444</span>: <span class="number">192.168</span><span class="number">.100</span><span class="number">.20</span><span class="number">.51410</span> &gt; <span class="number">220.173</span><span class="number">.179</span><span class="number">.66</span><span class="number">.36017</span>: UDP, length <span class="number">1402</span></span><br><span class="line"><span class="number">18</span>:<span class="number">27</span>:<span class="number">53.628837</span> <span class="number">00</span>:e2:<span class="number">69</span>:<span class="number">23</span>:d3:<span class="number">3</span>b &gt; <span class="number">24</span>:<span class="number">5</span>e:be:<span class="number">0</span>c:<span class="number">17</span>:af, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">1324</span>: <span class="number">46.97</span><span class="number">.169</span><span class="number">.182</span><span class="number">.6881</span> &gt; <span class="number">192.168</span><span class="number">.100</span><span class="number">.20</span><span class="number">.59145</span>: Flags [P.], seq <span class="number">3058450381</span>:<span class="number">3058451651</span>, ack <span class="number">14349180</span>, win <span class="number">502</span>, length <span class="number">1270</span></span><br><span class="line"><span class="number">18</span>:<span class="number">27</span>:<span class="number">53.629096</span> <span class="number">24</span>:<span class="number">5</span>e:be:<span class="number">0</span>c:<span class="number">17</span>:af &gt; <span class="number">00</span>:e2:<span class="number">69</span>:<span class="number">23</span>:d3:<span class="number">3</span>b, ethertype IPv4 (<span class="number">0x0800</span>), length <span class="number">54</span>: <span class="number">192.168</span><span class="number">.100</span><span class="number">.20</span><span class="number">.59145</span> &gt; <span class="number">192.168</span><span class="number">.100</span><span class="number">.1</span><span class="number">.12345</span>: Flags [.], ack <span class="number">3058451651</span>, win <span class="number">6350</span>, length <span class="number">0</span></span><br><span class="line"><span class="number">5</span> packets captured</span><br></pre></td></tr></table></figure><h4 id="显示-ASCII-字符串"><a href="#显示-ASCII-字符串" class="headerlink" title="显示 ASCII 字符串"></a>显示 ASCII 字符串</h4><p><code>-A</code> 表示使用 <code>ASCII</code> 字符串打印报文的全部数据，这样可以使读取更加简单，方便使用 <code>grep</code> 等工具解析输出内容。<code>-X</code> 表示同时使用十六进制和 <code>ASCII</code> 字符串打印报文的全部数据。这两个参数不能一起使用。例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -A -s0 port <span class="number">80</span></span><br></pre></td></tr></table></figure><h4 id="抓取特定协议的数据"><a href="#抓取特定协议的数据" class="headerlink" title="抓取特定协议的数据"></a>抓取特定协议的数据</h4><p>后面可以跟上协议名称来过滤特定协议的流量，以 UDP 为例，可以加上参数 udp 或 <code>protocol 17</code>，这两个命令意思相同。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i eth0 udp</span><br><span class="line">$ tcpdump -i eth0 proto <span class="number">17</span></span><br></pre></td></tr></table></figure><p>同理，tcp 与 <code>protocol 6</code> 意思相同。</p><h4 id="抓取特定主机的数据"><a href="#抓取特定主机的数据" class="headerlink" title="抓取特定主机的数据"></a>抓取特定主机的数据</h4><p>使用过滤器 <code>host</code> 可以抓取特定目的地和源 IP 地址的流量。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i eth0 host <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><p>也可以使用 <code>src</code> 或 <code>dst</code> 只抓取源或目的地：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i eth0 dst <span class="number">10.10</span><span class="number">.1</span><span class="number">.20</span></span><br></pre></td></tr></table></figure><h4 id="将抓取的数据写入文件"><a href="#将抓取的数据写入文件" class="headerlink" title="将抓取的数据写入文件"></a>将抓取的数据写入文件</h4><p>使用 tcpdump 截取数据报文的时候，默认会打印到屏幕的默认输出，你会看到按照顺序和格式，很多的数据一行行快速闪过，根本来不及看清楚所有的内容。不过，tcpdump 提供了把截取的数据保存到文件的功能，以便后面使用其他图形工具（比如 wireshark，Snort）来分析。</p><p><code>-w</code> 选项用来把数据报文输出到文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i eth0 -s0 -w test.pcap</span><br></pre></td></tr></table></figure><h4 id="行缓冲模式"><a href="#行缓冲模式" class="headerlink" title="行缓冲模式"></a>行缓冲模式</h4><p>如果想实时将抓取到的数据通过管道传递给其他工具来处理，需要使用 <code>-l</code> 选项来开启行缓冲模式（或使用 <code>-c</code> 选项来开启数据包缓冲模式）。使用 <code>-l</code> 选项可以将输出通过立即发送给其他命令，其他命令会立即响应。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i eth0 -s0 -l port <span class="number">80</span> | grep <span class="string">'Server:'</span></span><br></pre></td></tr></table></figure><h4 id="组合过滤器"><a href="#组合过滤器" class="headerlink" title="组合过滤器"></a>组合过滤器</h4><p>过滤的真正强大之处在于你可以随意组合它们，而连接它们的逻辑就是常用的 <code>与/AND/&amp;&amp;</code> 、 <code>或/OR/||</code> 和 <code>非/not/!</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">and or &amp;&amp;</span><br><span class="line">or or ||</span><br><span class="line">not or !</span><br></pre></td></tr></table></figure><h3 id="02过滤器"><a href="#02过滤器" class="headerlink" title="02过滤器"></a>02过滤器</h3><p>关于 tcpdump 的过滤器，这里有必要单独介绍一下。</p><p>机器上的网络报文数量异常的多，很多时候我们只关系和具体问题有关的数据报（比如访问某个网站的数据，或者 icmp 超时的报文等等），而这些数据只占到很小的一部分。把所有的数据截取下来，从里面找到想要的信息无疑是一件很费时费力的工作。而 tcpdump 提供了灵活的语法可以精确地截取关心的数据报，简化分析的工作量。这些选择数据包的语句就是过滤器（filter）！</p><h4 id="Host-过滤器"><a href="#Host-过滤器" class="headerlink" title="Host 过滤器"></a>Host 过滤器</h4><p>Host 过滤器用来过滤某个主机的数据报文。例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump host <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure><p>该命令会抓取所有发往主机 <code>1.2.3.4</code> 或者从主机 <code>1.2.3.4</code> 发出的流量。如果想只抓取从该主机发出的流量，可以使用下面的命令：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump src host <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br></pre></td></tr></table></figure><h4 id="Network-过滤器"><a href="#Network-过滤器" class="headerlink" title="Network 过滤器"></a>Network 过滤器</h4><p>Network 过滤器用来过滤某个网段的数据，使用的是 <strong>CIDR[2]</strong> 模式。可以使用四元组（x.x.x.x）、三元组（x.x.x）、二元组（x.x）和一元组（x）。四元组就是指定某个主机，三元组表示子网掩码为 <code>255.255.255.0</code>，二元组表示子网掩码为 <code>255.255.0.0</code>，一元组表示子网掩码为 <code>255.0.0.0</code>。例如，</p><p>抓取所有发往网段 <code>192.168.1.x</code> 或从网段 <code>192.168.1.x</code> 发出的流量：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump net <span class="number">192.168</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><p>抓取所有发往网段 <code>10.x.x.x</code> 或从网段 <code>10.x.x.x</code> 发出的流量：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump net <span class="number">10</span></span><br></pre></td></tr></table></figure><p>和 Host 过滤器一样，这里也可以指定源和目的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump src net <span class="number">10</span></span><br></pre></td></tr></table></figure><p>也可以使用 CIDR 格式：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump src net <span class="number">172.16</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">12</span></span><br></pre></td></tr></table></figure><h4 id="Proto-过滤器"><a href="#Proto-过滤器" class="headerlink" title="Proto 过滤器"></a>Proto 过滤器</h4><p>Proto 过滤器用来过滤某个协议的数据，关键字为 <code>proto</code>，可省略。proto 后面可以跟上协议号或协议名称，支持 <code>icmp</code>, <code>igmp</code>, <code>igrp</code>, <code>pim</code>, <code>ah</code>, <code>esp</code>, <code>carp</code>, <code>vrrp</code>, <code>udp</code>和 <code>tcp</code>。因为通常的协议名称是保留字段，所以在与 proto 指令一起使用时，必须根据 shell 类型使用一个或两个反斜杠（/）来转义。Linux 中的 shell 需要使用两个反斜杠来转义，MacOS 只需要一个。</p><p>例如，抓取 icmp 协议的报文：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -n proto \\icmp</span><br><span class="line"># 或者</span><br><span class="line">$ tcpdump -n icmp</span><br></pre></td></tr></table></figure><h4 id="Port-过滤器"><a href="#Port-过滤器" class="headerlink" title="Port 过滤器"></a>Port 过滤器</h4><p>Port 过滤器用来过滤通过某个端口的数据报文，关键字为 <code>port</code>。例如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump port <span class="number">389</span></span><br></pre></td></tr></table></figure><h3 id="03理解-tcpdump-的输出"><a href="#03理解-tcpdump-的输出" class="headerlink" title="03理解 tcpdump 的输出"></a>03理解 tcpdump 的输出</h3><p>截取数据只是第一步，第二步就是理解这些数据，下面就解释一下 tcpdump 命令输出各部分的意义。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">27</span>:<span class="number">06.995846</span> IP (tos <span class="number">0x0</span>, ttl <span class="number">64</span>, id <span class="number">45646</span>, offset <span class="number">0</span>, flags [DF], proto TCP (<span class="number">6</span>), length <span class="number">64</span>)</span><br><span class="line">    <span class="number">192.168</span><span class="number">.1</span><span class="number">.106</span><span class="number">.56166</span> &gt; <span class="number">124.192</span><span class="number">.132</span><span class="number">.54</span><span class="number">.80</span>: Flags [S], cksum <span class="number">0xa730</span> (correct), seq <span class="number">992042666</span>, win <span class="number">65535</span>, options [mss <span class="number">1460</span>,nop,wscale <span class="number">4</span>,nop,nop,TS val <span class="number">663433143</span> ecr <span class="number">0</span>,sackOK,eol], length <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">27</span>:<span class="number">07.030487</span> IP (tos <span class="number">0x0</span>, ttl <span class="number">51</span>, id <span class="number">0</span>, offset <span class="number">0</span>, flags [DF], proto TCP (<span class="number">6</span>), length <span class="number">44</span>)</span><br><span class="line">    <span class="number">124.192</span><span class="number">.132</span><span class="number">.54</span><span class="number">.80</span> &gt; <span class="number">192.168</span><span class="number">.1</span><span class="number">.106</span><span class="number">.56166</span>: Flags [S.], cksum <span class="number">0xedc0</span> (correct), seq <span class="number">2147006684</span>, ack <span class="number">992042667</span>, win <span class="number">14600</span>, options [mss <span class="number">1440</span>], length <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">27</span>:<span class="number">07.030527</span> IP (tos <span class="number">0x0</span>, ttl <span class="number">64</span>, id <span class="number">59119</span>, offset <span class="number">0</span>, flags [DF], proto TCP (<span class="number">6</span>), length <span class="number">40</span>)</span><br><span class="line">    <span class="number">192.168</span><span class="number">.1</span><span class="number">.106</span><span class="number">.56166</span> &gt; <span class="number">124.192</span><span class="number">.132</span><span class="number">.54</span><span class="number">.80</span>: Flags [.], cksum <span class="number">0x3e72</span> (correct), ack <span class="number">2147006685</span>, win <span class="number">65535</span>, length <span class="number">0</span></span><br></pre></td></tr></table></figure><p>最基本也是最重要的信息就是数据报的源地址/端口和目的地址/端口，上面的例子第一条数据报中，源地址 ip 是 <code>192.168.1.106</code>，源端口是 <code>56166</code>，目的地址是 <code>124.192.132.54</code>，目的端口是 <code>80</code>。<code>&gt;</code> 符号代表数据的方向。</p><p>此外，上面的三条数据还是 tcp 协议的三次握手过程，第一条就是 <code>SYN</code> 报文，这个可以通过 <code>Flags [S]</code> 看出。下面是常见的 TCP 报文的 Flags:</p><ul><li><code>[S]</code> : SYN（开始连接）</li><li><code>[.]</code> : 没有 Flag</li><li><code>[P]</code> : PSH（推送数据）</li><li><code>[F]</code> : FIN （结束连接）</li><li><code>[R]</code> : RST（重置连接）</li></ul><p>而第二条数据的 <code>[S.]</code> 表示 <code>SYN-ACK</code>，就是 <code>SYN</code> 报文的应答报文。</p><h3 id="04例子"><a href="#04例子" class="headerlink" title="04例子"></a>04例子</h3><p>下面给出一些具体的例子，每个例子都可以使用多种方法来获得相同的输出，你使用的方法取决于所需的输出和网络上的流量。我们在排障时，通常只想获取自己想要的内容，可以通过过滤器和 ASCII 输出并结合管道与 grep、cut、awk 等工具来实现此目的。</p><p>例如，在抓取 HTTP 请求和响应数据包时，可以通过删除标志 <code>SYN/ACK/FIN</code> 来过滤噪声，但还有更简单的方法，那就是通过管道传递给 <code>grep</code>。在达到目的的同时，我们要选择最简单最高效的方法。下面来看例子。</p><h4 id="提取-HTTP-用户代理"><a href="#提取-HTTP-用户代理" class="headerlink" title="提取 HTTP 用户代理"></a>提取 HTTP 用户代理</h4><p>从 HTTP 请求头中提取 HTTP 用户代理：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -A -s1500 -l | grep <span class="string">"User-Agent:"</span></span><br></pre></td></tr></table></figure><p>通过 <code>egrep</code> 可以同时提取用户代理和主机名（或其他头文件）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -A -s1500 -l | egrep -i <span class="string">'User-Agent:|Host:'</span></span><br></pre></td></tr></table></figure><h4 id="只抓取-HTTP-GET-和-POST-流量"><a href="#只抓取-HTTP-GET-和-POST-流量" class="headerlink" title="只抓取 HTTP GET 和 POST 流量"></a>只抓取 HTTP GET 和 POST 流量</h4><p>抓取 HTTP GET 流量：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -s <span class="number">0</span> -A -vv <span class="string">'tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420'</span></span><br></pre></td></tr></table></figure><p>也可以抓取 HTTP POST 请求流量：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -s <span class="number">0</span> -A -vv <span class="string">'tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354'</span></span><br></pre></td></tr></table></figure><p>注意：该方法不能保证抓取到 HTTP POST 有效数据流量，因为一个 POST 请求会被分割为多个 TCP 数据包。</p><p>上述两个表达式中的十六进制将会与 GET 和 POST 请求的 <code>ASCII</code> 字符串匹配。例如，<code>tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4]</code> 首先会<strong>确定我们感兴趣的字节的位置[3]</strong>（在 TCP header 之后），然后选择我们希望匹配的 4 个字节。</p><h4 id="提取-HTTP-请求的-URL"><a href="#提取-HTTP-请求的-URL" class="headerlink" title="提取 HTTP 请求的 URL"></a>提取 HTTP 请求的 URL</h4><p>提取 HTTP 请求的主机名和路径：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -s <span class="number">0</span> -v -n -l | egrep -i <span class="string">"POST /|GET /|Host:"</span></span><br><span class="line"></span><br><span class="line">tcpdump: listening on enp7s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line">POST /wp-login.php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: dev.example.com</span><br><span class="line">GET /wp-login.php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: dev.example.com</span><br><span class="line">GET /favicon.ico HTTP/<span class="number">1.1</span></span><br><span class="line">Host: dev.example.com</span><br><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: dev.example.com</span><br></pre></td></tr></table></figure><h4 id="提取-HTTP-POST-请求中的密码"><a href="#提取-HTTP-POST-请求中的密码" class="headerlink" title="提取 HTTP POST 请求中的密码"></a>提取 HTTP POST 请求中的密码</h4><p>从 HTTP POST 请求中提取密码和主机名：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -s <span class="number">0</span> -A -n -l | egrep -i <span class="string">"POST /|pwd=|passwd=|password=|Host:"</span></span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on enp7s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">11</span>:<span class="number">25</span>:<span class="number">54.799014</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.30</span><span class="number">.39224</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.125</span><span class="number">.80</span>: Flags [P.], seq <span class="number">1458768667</span>:<span class="number">1458770008</span>, ack <span class="number">2440130792</span>, win <span class="number">704</span>, options [nop,nop,TS val <span class="number">461552632</span> ecr <span class="number">208900561</span>], length <span class="number">1341</span>: HTTP: POST /wp-login.php HTTP/<span class="number">1.1</span></span><br><span class="line">.....s..POST /wp-login.php HTTP/<span class="number">1.1</span></span><br><span class="line">Host: dev.example.com</span><br><span class="line">.....s..log=admin&amp;pwd=notmypassword&amp;wp-submit=Log+In&amp;redirect_to=http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>Fdev.example.com%<span class="number">2</span>Fwp-admin%<span class="number">2</span>F&amp;testcookie=<span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="提取-Cookies"><a href="#提取-Cookies" class="headerlink" title="提取 Cookies"></a>提取 Cookies</h4><p>提取 <code>Set-Cookie</code>（服务端的 Cookie）和 <code>Cookie</code>（客户端的 Cookie）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -A -s0 -l | egrep -i <span class="string">'Set-Cookie|Host:|Cookie:'</span></span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on wlp58s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line">Host: dev.example.com</span><br><span class="line">Cookie: wordpress_86be02xxxxxxxxxxxxxxxxxxxc43=admin%<span class="number">7</span>C152xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxfb3e15c744fdd6; _ga=GA1<span class="number">.2</span><span class="number">.21343434343421934</span>; _gid=GA1<span class="number">.2</span><span class="number">.927343434349426</span>; wordpress_test_cookie=WP+Cookie+check; wordpress_logged_in_86be654654645645645654645653fc43=admin%<span class="number">7</span>C15275102testtesttesttestab7a61e; wp-settings-time<span class="number">-1</span>=<span class="number">1527337439</span></span><br></pre></td></tr></table></figure><h4 id="抓取-ICMP-数据包"><a href="#抓取-ICMP-数据包" class="headerlink" title="抓取 ICMP 数据包"></a>抓取 ICMP 数据包</h4><p>查看网络上的所有 ICMP 数据包：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -n icmp</span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on enp7s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">11</span>:<span class="number">34</span>:<span class="number">21.590380</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.217</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.30</span>: ICMP echo request, id <span class="number">27948</span>, seq <span class="number">1</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">34</span>:<span class="number">21.590434</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.30</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.217</span>: ICMP echo reply, id <span class="number">27948</span>, seq <span class="number">1</span>, length <span class="number">64</span></span><br><span class="line"><span class="number">11</span>:<span class="number">34</span>:<span class="number">27.680307</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.159</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span>: ICMP <span class="number">10.10</span><span class="number">.1</span><span class="number">.189</span> udp port <span class="number">59619</span> unreachable, length <span class="number">115</span></span><br></pre></td></tr></table></figure><h4 id="抓取非-ECHO-REPLY-类型的-ICMP-数据包"><a href="#抓取非-ECHO-REPLY-类型的-ICMP-数据包" class="headerlink" title="抓取非 ECHO/REPLY 类型的 ICMP 数据包"></a>抓取非 ECHO/REPLY 类型的 ICMP 数据包</h4><p>通过排除 echo 和 reply 类型的数据包使抓取到的数据包不包括标准的 <code>ping</code> 包：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump <span class="string">'icmp[icmptype] != icmp-echo and icmp[icmptype] != icmp-echoreply'</span></span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on enp7s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">11</span>:<span class="number">37</span>:<span class="number">04.041037</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.189</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.20</span>: ICMP <span class="number">10.10</span><span class="number">.1</span><span class="number">.189</span> udp port <span class="number">36078</span> unreachable, length <span class="number">156</span></span><br></pre></td></tr></table></figure><h4 id="抓取-SMTP-POP3-协议的邮件"><a href="#抓取-SMTP-POP3-协议的邮件" class="headerlink" title="抓取 SMTP/POP3 协议的邮件"></a>抓取 SMTP/POP3 协议的邮件</h4><p>可以提取电子邮件的正文和其他数据。例如，只提取电子邮件的收件人：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn -l port <span class="number">25</span> | grep -i <span class="string">'MAIL FROM\|RCPT TO'</span></span><br></pre></td></tr></table></figure><h4 id="抓取-NTP-服务的查询和响应"><a href="#抓取-NTP-服务的查询和响应" class="headerlink" title="抓取 NTP 服务的查询和响应"></a>抓取 NTP 服务的查询和响应</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump dst port <span class="number">123</span></span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on eth0, link-type EN10MB (Ethernet), capture size <span class="number">65535</span> bytes</span><br><span class="line"><span class="number">21</span>:<span class="number">02</span>:<span class="number">19.112502</span> IP test33.ntp &gt; <span class="number">199.30</span><span class="number">.140</span><span class="number">.74</span>.ntp: NTPv4, Client, length <span class="number">48</span></span><br><span class="line"><span class="number">21</span>:<span class="number">02</span>:<span class="number">19.113888</span> IP <span class="number">216.239</span><span class="number">.35</span><span class="number">.0</span>.ntp &gt; test33.ntp: NTPv4, Server, length <span class="number">48</span></span><br><span class="line"><span class="number">21</span>:<span class="number">02</span>:<span class="number">20.150347</span> IP test33.ntp &gt; <span class="number">216.239</span><span class="number">.35</span><span class="number">.0</span>.ntp: NTPv4, Client, length <span class="number">48</span></span><br><span class="line"><span class="number">21</span>:<span class="number">02</span>:<span class="number">20.150991</span> IP <span class="number">216.239</span><span class="number">.35</span><span class="number">.0</span>.ntp &gt; test33.ntp: NTPv4, Server, length <span class="number">48</span></span><br></pre></td></tr></table></figure><h4 id="抓取-SNMP-服务的查询和响应"><a href="#抓取-SNMP-服务的查询和响应" class="headerlink" title="抓取 SNMP 服务的查询和响应"></a>抓取 SNMP 服务的查询和响应</h4><p>通过 SNMP 服务，渗透测试人员可以获取大量的设备和系统信息。在这些信息中，系统信息最为关键，如操作系统版本、内核版本等。使用 SNMP 协议快速扫描程序 <code>onesixtyone</code>，可以看到目标系统的信息：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ onesixtyone <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span> public</span><br><span class="line"></span><br><span class="line">Scanning <span class="number">1</span> hosts, <span class="number">1</span> communities</span><br><span class="line">10.10.1.10 [public] Linux test33 4.15.0-20-generic #21-Ubuntu SMP Tue Apr 24 06:16:15 UTC 2018 x86_64</span><br></pre></td></tr></table></figure><p>可以通过 tcpdump 抓取 <code>GetRequest</code> 和 <code>GetResponse</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -n -s0  port <span class="number">161</span> and udp</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on wlp58s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">23</span>:<span class="number">39</span>:<span class="number">13.725522</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.159</span><span class="number">.36826</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.20</span><span class="number">.161</span>:  GetRequest(<span class="number">28</span>)  <span class="number">.1</span><span class="number">.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">39</span>:<span class="number">13.728789</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.20</span><span class="number">.161</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.159</span><span class="number">.36826</span>:  GetResponse(<span class="number">109</span>)  <span class="number">.1</span><span class="number">.3</span><span class="number">.6</span><span class="number">.1</span><span class="number">.2</span><span class="number">.1</span><span class="number">.1</span><span class="number">.1</span><span class="number">.0</span>=<span class="string">"Linux testmachine 4.15.0-20-generic #21-Ubuntu SMP Tue Apr 24 06:16:15 UTC 2018 x86_64"</span></span><br></pre></td></tr></table></figure><h4 id="切割-pcap-文件"><a href="#切割-pcap-文件" class="headerlink" title="切割 pcap 文件"></a>切割 pcap 文件</h4><p>当抓取大量数据并写入文件时，可以自动切割为多个大小相同的文件。例如，下面的命令表示每 3600 秒创建一个新文件 <code>capture-(hour).pcap</code>，每个文件大小不超过 <code>200*1000000</code> 字节：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump  -w /tmp/capture-%H.pcap -G <span class="number">3600</span> -C <span class="number">200</span></span><br></pre></td></tr></table></figure><p>这些文件的命名为 <code>capture-{1-24}.pcap</code>，24 小时之后，之前的文件就会被覆盖。</p><h4 id="抓取-IPv6-流量"><a href="#抓取-IPv6-流量" class="headerlink" title="抓取 IPv6 流量"></a>抓取 IPv6 流量</h4><p>可以通过过滤器 <code>ip6</code> 来抓取 IPv6 流量，同时可以指定协议如 TCP：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn ip6 proto <span class="number">6</span></span><br></pre></td></tr></table></figure><p>从之前保存的文件中读取 IPv6 UDP 数据报文：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nr ipv6-test.pcap ip6 proto <span class="number">17</span></span><br></pre></td></tr></table></figure><h4 id="检测端口扫描"><a href="#检测端口扫描" class="headerlink" title="检测端口扫描"></a>检测端口扫描</h4><p>在下面的例子中，你会发现抓取到的报文的源和目的一直不变，且带有标志位 <code>[S]</code> 和 <code>[R]</code>，它们与一系列看似随机的目标端口进行匹配。当发送 <code>SYN</code> 之后，如果目标主机的端口没有打开，就会返回一个 <code>RESET</code>。这是 <code>Nmap</code> 等端口扫描工具的标准做法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn</span><br><span class="line"></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.693601</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.60460</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.5432</span>: Flags [S], seq <span class="number">116466344</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090332</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.693626</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.35470</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.513</span>: Flags [S], seq <span class="number">3400074709</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090332</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.693762</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.44244</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.389</span>: Flags [S], seq <span class="number">2214070267</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090333</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.693772</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.389</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.44244</span>: Flags [R.], seq <span class="number">0</span>, ack <span class="number">2214070268</span>, win <span class="number">0</span>, length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.693783</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.35172</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.1433</span>: Flags [S], seq <span class="number">2358257571</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090333</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.693826</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.33022</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.49153</span>: Flags [S], seq <span class="number">2406028551</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090333</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695567</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.55130</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.49154</span>: Flags [S], seq <span class="number">3230403372</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090334</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695590</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.49154</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.55130</span>: Flags [R.], seq <span class="number">0</span>, ack <span class="number">3230403373</span>, win <span class="number">0</span>, length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695608</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.33460</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.49152</span>: Flags [S], seq <span class="number">3289070068</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090335</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695622</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.49152</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.33460</span>: Flags [R.], seq <span class="number">0</span>, ack <span class="number">3289070069</span>, win <span class="number">0</span>, length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695637</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.34940</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.1029</span>: Flags [S], seq <span class="number">140319147</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090335</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695650</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.1029</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.34940</span>: Flags [R.], seq <span class="number">0</span>, ack <span class="number">140319148</span>, win <span class="number">0</span>, length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695664</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.45648</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.5060</span>: Flags [S], seq <span class="number">2203629201</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090335</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695775</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.49028</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.2000</span>: Flags [S], seq <span class="number">635990431</span>, win <span class="number">29200</span>, options [mss <span class="number">1460</span>,sackOK,TS val <span class="number">3547090335</span> ecr <span class="number">0</span>,nop,wscale <span class="number">7</span>], length <span class="number">0</span></span><br><span class="line"><span class="number">21</span>:<span class="number">46</span>:<span class="number">19.695790</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.199</span><span class="number">.2000</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.10</span><span class="number">.49028</span>: Flags [R.], seq <span class="number">0</span>, ack <span class="number">635990432</span>, win <span class="number">0</span>, length <span class="number">0</span></span><br></pre></td></tr></table></figure><h4 id="过滤-Nmap-NSE-脚本测试结果"><a href="#过滤-Nmap-NSE-脚本测试结果" class="headerlink" title="过滤 Nmap NSE 脚本测试结果"></a>过滤 Nmap NSE 脚本测试结果</h4><p>本例中 Nmap NSE 测试脚本 <code>http-enum.nse</code> 用来检测 HTTP 服务的合法 URL。</p><p>在执行脚本测试的主机上：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -p <span class="number">80</span> --script=http-enum.nse targetip</span><br></pre></td></tr></table></figure><p>在目标主机上：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nn port <span class="number">80</span> | grep <span class="string">"GET /"</span></span><br><span class="line"></span><br><span class="line">GET /w3perl/ HTTP/<span class="number">1.1</span></span><br><span class="line">GET /w-agora/ HTTP/<span class="number">1.1</span></span><br><span class="line">GET /way-board/ HTTP/<span class="number">1.1</span></span><br><span class="line">GET /web800fo/ HTTP/<span class="number">1.1</span></span><br><span class="line">GET /webaccess/ HTTP/<span class="number">1.1</span></span><br><span class="line">GET /webadmin/ HTTP/<span class="number">1.1</span></span><br><span class="line">GET /webAdmin/ HTTP/<span class="number">1.1</span></span><br></pre></td></tr></table></figure><h4 id="抓取-DNS-请求和响应"><a href="#抓取-DNS-请求和响应" class="headerlink" title="抓取 DNS 请求和响应"></a>抓取 DNS 请求和响应</h4><p>向 Google 公共 DNS 发起的出站 <code>DNS</code> 请求和 A 记录响应可以通过 tcpdump 抓取到：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -i wlp58s0 -s0 port <span class="number">53</span></span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on wlp58s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">14</span>:<span class="number">19</span>:<span class="number">06.879799</span> IP test<span class="number">.53852</span> &gt; google-public-dns-a.google.com.domain: <span class="number">26977</span>+ [<span class="number">1</span>au] A? play.google.com. (<span class="number">44</span>)</span><br><span class="line"><span class="number">14</span>:<span class="number">19</span>:<span class="number">07.022618</span> IP google-public-dns-a.google.com.domain &gt; test<span class="number">.53852</span>: <span class="number">26977</span> <span class="number">1</span>/<span class="number">0</span>/<span class="number">1</span> A <span class="number">216.58</span><span class="number">.203</span><span class="number">.110</span> (<span class="number">60</span>)</span><br></pre></td></tr></table></figure><h4 id="抓取-HTTP-有效数据包"><a href="#抓取-HTTP-有效数据包" class="headerlink" title="抓取 HTTP 有效数据包"></a>抓取 HTTP 有效数据包</h4><p>抓取 80 端口的 HTTP 有效数据包，排除 TCP 连接建立过程的数据包（SYN / FIN / ACK）：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump <span class="string">'tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)'</span></span><br></pre></td></tr></table></figure><h4 id="将输出内容重定向到-Wireshark"><a href="#将输出内容重定向到-Wireshark" class="headerlink" title="将输出内容重定向到 Wireshark"></a>将输出内容重定向到 Wireshark</h4><p>通常 <code>Wireshark</code>（或 tshark）比 tcpdump 更容易分析应用层协议。一般的做法是在远程服务器上先使用 <code>tcpdump</code> 抓取数据并写入文件，然后再将文件拷贝到本地工作站上用 <code>Wireshark</code> 分析。</p><p>还有一种更高效的方法，可以通过 ssh 连接将抓取到的数据实时发送给 Wireshark 进行分析。以 MacOS 系统为例，可以通过 <code>brew cask install wireshark</code> 来安装，然后通过下面的命令来分析：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@remotesystem <span class="string">'tcpdump -s0 -c 1000 -nn -w - not port 22'</span> | <span class="regexp">/Applications/</span>Wireshark.app/Contents/MacOS/Wireshark -k -i -</span><br></pre></td></tr></table></figure><p>例如，如果想分析 DNS 协议，可以使用下面的命令：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh root@remotesystem <span class="string">'tcpdump -s0 -c 1000 -nn -w - port 53'</span> | <span class="regexp">/Applications/</span>Wireshark.app/Contents/MacOS/Wireshark -k -i -</span><br></pre></td></tr></table></figure><p>抓取到的数据：</p><p><code>-c</code> 选项用来限制抓取数据的大小。如果不限制大小，就只能通过 <code>ctrl-c</code> 来停止抓取，这样一来不仅关闭了 tcpdump，也关闭了 wireshark。</p><h4 id="找出发包最多的-IP"><a href="#找出发包最多的-IP" class="headerlink" title="找出发包最多的 IP"></a>找出发包最多的 IP</h4><p>找出一段时间内发包最多的 IP，或者从一堆报文中找出发包最多的 IP，可以使用下面的命令：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -nnn -t -c <span class="number">200</span> | cut -f <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span> -d <span class="string">'.'</span> | sort | uniq -c | sort -nr | head -n <span class="number">20</span></span><br><span class="line"></span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on enp7s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">200</span> packets captured</span><br><span class="line"><span class="number">261</span> packets received by filter</span><br><span class="line"><span class="number">0</span> packets dropped by kernel</span><br><span class="line">    <span class="number">108</span> IP <span class="number">10.10</span><span class="number">.211</span><span class="number">.181</span></span><br><span class="line">     <span class="number">91</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.30</span></span><br><span class="line">      <span class="number">1</span> IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.50</span></span><br></pre></td></tr></table></figure><ul><li><strong>cut -f 1,2,3,4 -d ‘.’</strong> : 以 <code>.</code> 为分隔符，打印出每行的前四列。即 IP 地址。</li><li><strong>sort | uniq -c</strong> : 排序并计数</li><li><strong>sort -nr</strong> : 按照数值大小逆向排序</li></ul><h4 id="抓取用户名和密码"><a href="#抓取用户名和密码" class="headerlink" title="抓取用户名和密码"></a>抓取用户名和密码</h4><p>本例将重点放在标准纯文本协议上，过滤出于用户名和密码相关的报文：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump port http or port ftp or port smtp or port imap or port pop3 or port telnet -l -A | egrep -i -B5 <span class="string">'pass=|pwd=|log=|login=|user=|username=|pw=|passw=|passwd=|password=|pass:|user:|username:|password:|login:|pass |user '</span></span><br></pre></td></tr></table></figure><h4 id="抓取-DHCP-报文"><a href="#抓取-DHCP-报文" class="headerlink" title="抓取 DHCP 报文"></a>抓取 DHCP 报文</h4><p>最后一个例子，抓取 DHCP 服务的请求和响应报文，67 为 DHCP 端口，68 为客户机端口。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">$ tcpdump -v -n port <span class="number">67</span> or <span class="number">68</span></span><br><span class="line"></span><br><span class="line">tcpdump: listening on enp7s0, link-type EN10MB (Ethernet), capture size <span class="number">262144</span> bytes</span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">50.059662</span> IP (tos <span class="number">0x10</span>, ttl <span class="number">128</span>, id <span class="number">0</span>, offset <span class="number">0</span>, flags [none], proto UDP (<span class="number">17</span>), length <span class="number">328</span>)</span><br><span class="line">    <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="number">.68</span> &gt; <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span><span class="number">.67</span>: BOOTP/DHCP, Request <span class="keyword">from</span> <span class="number">00</span>:<span class="number">0</span>c:xx:xx:xx:d5, length <span class="number">300</span>, xid <span class="number">0xc9779c2a</span>, Flags [none]</span><br><span class="line">  Client-Ethernet-Address <span class="number">00</span>:<span class="number">0</span>c:xx:xx:xx:d5</span><br><span class="line">  Vendor-rfc1048 Extensions</span><br><span class="line">    Magic Cookie <span class="number">0x63825363</span></span><br><span class="line">    DHCP-Message Option <span class="number">53</span>, length <span class="number">1</span>: Request</span><br><span class="line">    Requested-IP Option <span class="number">50</span>, length <span class="number">4</span>: <span class="number">10.10</span><span class="number">.1</span><span class="number">.163</span></span><br><span class="line">    Hostname Option <span class="number">12</span>, length <span class="number">14</span>: <span class="string">"test-ubuntu"</span></span><br><span class="line">    Parameter-Request Option <span class="number">55</span>, length <span class="number">16</span>:</span><br><span class="line">      Subnet-Mask, BR, Time-Zone, Default-Gateway</span><br><span class="line">      Domain-Name, Domain-Name-Server, Option <span class="number">119</span>, Hostname</span><br><span class="line">      Netbios-Name-Server, Netbios-Scope, MTU, Classless-Static-Route</span><br><span class="line">      NTP, Classless-Static-Route-Microsoft, Static-Route, Option <span class="number">252</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">50.059667</span> IP (tos <span class="number">0x10</span>, ttl <span class="number">128</span>, id <span class="number">0</span>, offset <span class="number">0</span>, flags [none], proto UDP (<span class="number">17</span>), length <span class="number">328</span>)</span><br><span class="line">    <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="number">.68</span> &gt; <span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span><span class="number">.67</span>: BOOTP/DHCP, Request <span class="keyword">from</span> <span class="number">00</span>:<span class="number">0</span>c:xx:xx:xx:d5, length <span class="number">300</span>, xid <span class="number">0xc9779c2a</span>, Flags [none]</span><br><span class="line">  Client-Ethernet-Address <span class="number">00</span>:<span class="number">0</span>c:xx:xx:xx:d5</span><br><span class="line">  Vendor-rfc1048 Extensions</span><br><span class="line">    Magic Cookie <span class="number">0x63825363</span></span><br><span class="line">    DHCP-Message Option <span class="number">53</span>, length <span class="number">1</span>: Request</span><br><span class="line">    Requested-IP Option <span class="number">50</span>, length <span class="number">4</span>: <span class="number">10.10</span><span class="number">.1</span><span class="number">.163</span></span><br><span class="line">    Hostname Option <span class="number">12</span>, length <span class="number">14</span>: <span class="string">"test-ubuntu"</span></span><br><span class="line">    Parameter-Request Option <span class="number">55</span>, length <span class="number">16</span>:</span><br><span class="line">      Subnet-Mask, BR, Time-Zone, Default-Gateway</span><br><span class="line">      Domain-Name, Domain-Name-Server, Option <span class="number">119</span>, Hostname</span><br><span class="line">      Netbios-Name-Server, Netbios-Scope, MTU, Classless-Static-Route</span><br><span class="line">      NTP, Classless-Static-Route-Microsoft, Static-Route, Option <span class="number">252</span></span><br><span class="line"><span class="number">14</span>:<span class="number">37</span>:<span class="number">50.060780</span> IP (tos <span class="number">0x0</span>, ttl <span class="number">64</span>, id <span class="number">53564</span>, offset <span class="number">0</span>, flags [none], proto UDP (<span class="number">17</span>), length <span class="number">339</span>)</span><br><span class="line">    <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span><span class="number">.67</span> &gt; <span class="number">10.10</span><span class="number">.1</span><span class="number">.163</span><span class="number">.68</span>: BOOTP/DHCP, Reply, length <span class="number">311</span>, xid <span class="number">0xc9779c2a</span>, Flags [none]</span><br><span class="line">  Your-IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.163</span></span><br><span class="line">  Server-IP <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">  Client-Ethernet-Address <span class="number">00</span>:<span class="number">0</span>c:xx:xx:xx:d5</span><br><span class="line">  Vendor-rfc1048 Extensions</span><br><span class="line">    Magic Cookie <span class="number">0x63825363</span></span><br><span class="line">    DHCP-Message Option <span class="number">53</span>, length <span class="number">1</span>: ACK</span><br><span class="line">    Server-ID Option <span class="number">54</span>, length <span class="number">4</span>: <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">    Lease-Time Option <span class="number">51</span>, length <span class="number">4</span>: <span class="number">86400</span></span><br><span class="line">    RN Option <span class="number">58</span>, length <span class="number">4</span>: <span class="number">43200</span></span><br><span class="line">    RB Option <span class="number">59</span>, length <span class="number">4</span>: <span class="number">75600</span></span><br><span class="line">    Subnet-Mask Option <span class="number">1</span>, length <span class="number">4</span>: <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">    BR Option <span class="number">28</span>, length <span class="number">4</span>: <span class="number">10.10</span><span class="number">.1</span><span class="number">.255</span></span><br><span class="line">    Domain-Name-Server Option <span class="number">6</span>, length <span class="number">4</span>: <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">    Hostname Option <span class="number">12</span>, length <span class="number">14</span>: <span class="string">"test-ubuntu"</span></span><br><span class="line">    T252 Option <span class="number">252</span>, length <span class="number">1</span>: <span class="number">10</span></span><br><span class="line">    Default-Gateway Option <span class="number">3</span>, length <span class="number">4</span>: <span class="number">10.10</span><span class="number">.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure><h3 id="05总结"><a href="#05总结" class="headerlink" title="05总结"></a>05总结</h3><p>本文主要介绍了 <code>tcpdump</code> 的基本语法和使用方法，并通过一些示例来展示它强大的过滤功能。将 tcpdump 与 wireshark 进行组合可以发挥更强大的功效，本文也展示了如何优雅顺滑地结合 tcpdump 和 wireshark。如果你想了解更多的细节，可以查看 tcpdump 的 <code>man</code> 手册。</p><p><code>本文转截: https://cloud.tencent.com/developer/article/1589827</code></p>]]></content>
      
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安装-kubeadm-1.17/1.18</title>
      <link href="/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-17-1-18/"/>
      <url>/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-17-1-18/</url>
      
        <content type="html"><![CDATA[<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>离线包下载</p><p>在没有互联网到企业内网部署Kubernetes集群</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><ul><li>CentOS Linux release 7.8.2003 (Core)</li><li>Docker 19.03.5</li><li>Kubernetes 1.17.1/1.18.0</li></ul><h2 id="准备安装包"><a href="#准备安装包" class="headerlink" title="准备安装包"></a>准备安装包</h2><h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul><li>在这里<a href="https://docs.docker.com/engine/release-notes/" target="_blank" rel="noopener">查看Docker最新发布的版本号</a></li></ul><h3 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h3><ul><li>最新版本号：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fstorage.googleapis.com%2Fkubernetes-release%2Frelease%2Fstable.txt" target="_blank" rel="noopener">https://storage.googleapis.com/kubernetes-release/release/stable.txt</a></li><li>版本发型说明：<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fkubernetes.io%2Fdocs%2Fsetup%2Frelease%2Fnotes" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/release/notes</a></li></ul><h3 id="使用yum获取依赖包"><a href="#使用yum获取依赖包" class="headerlink" title="使用yum获取依赖包"></a>使用yum获取依赖包</h3><p>首先在一台能联网Centos 7中下载依赖包</p><p>PS：注意这个系统要是全新minimal安装的，干净的，如果已经通过yum安装过一些软件，下载的依赖包可能不完整。</p><ul><li>Centos 7 minimal下载地址：<a href="http://mirrors.aliyun.com/centos/7.7.1908/isos/x86_64/CentOS-7-x86_64-Minimal-1908.iso" target="_blank" rel="noopener">http://mirrors.aliyun.com/centos/7.7.1908/isos/x86_64/CentOS-7-x86_64-Minimal-1908.iso</a></li></ul><p>/root/下创建一个packages目录，所有依赖包会下载到<code>/root/packages</code>目录。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /root/packages/docker</span><br><span class="line">mkdir -p /root/packages/kubernetes</span><br><span class="line">mkdir -p /root/packages/<span class="built_in">source</span></span><br><span class="line">mkdir -p /root/packages/images</span><br><span class="line">mkdir -p /root/packages/plugins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用阿里云镜像源</span></span><br><span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地仓库包，用来创建本地仓库用的</span></span><br><span class="line">yum install --downloadonly --downloaddir=/root/packages/<span class="built_in">source</span> \</span><br><span class="line">    createrepo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实用工具，不做共享存储的话，nfs可不下载。</span></span><br><span class="line">yum install --downloadonly --downloaddir=/root/packages/<span class="built_in">source</span> \</span><br><span class="line">    yum-utils \</span><br><span class="line">    nfs-utils \</span><br><span class="line">    wget</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 时间同步</span></span><br><span class="line">yum install --downloadonly --downloaddir=/root/packages/<span class="built_in">source</span> \</span><br><span class="line">    chrony</span><br><span class="line"></span><br><span class="line"><span class="comment"># HAProxy 和 KeepAlived，一般做高可用安装包</span></span><br><span class="line">yum install --downloadonly --downloaddir=/root/packages/<span class="built_in">source</span> \</span><br><span class="line">    haproxy \</span><br><span class="line">    keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker 依赖包</span></span><br><span class="line">yum install -y --downloadonly --downloaddir=/root/packages/docker \</span><br><span class="line">    device-mapper-persistent-data \</span><br><span class="line">    lvm2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加阿里云Docker源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># docker</span></span><br><span class="line">yum install -y --downloadonly --downloaddir=/root/packages/docker \</span><br><span class="line">    docker-ce-19.03.5 \</span><br><span class="line">    docker-ce-cli-19.03.5 \</span><br><span class="line">    containerd.io</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置K8S的yum源</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubelet/kubeadm/kubectl(版本自选)</span></span><br><span class="line">yum install -y --downloadonly --downloaddir=/root/packages/kubernetes \</span><br><span class="line">    kubelet-1.18.0 \</span><br><span class="line">    kubeadm-1.18.0 \</span><br><span class="line">    kubectl-1.18.0</span><br></pre></td></tr></table></figure><h3 id="获取kubeadm依赖镜像"><a href="#获取kubeadm依赖镜像" class="headerlink" title="获取kubeadm依赖镜像"></a>获取kubeadm依赖镜像</h3><p>离线包下载完成后，准备获取kubeadm用到的镜像列表，这步操作要在一台安装好Docker环境的计算机上进行，拉取完成后打包复制到资源包<code>/root/packages/images</code>目录中。</p><p>如果安装了kubeadm，可使用一下命令获取kubernetes镜像。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images <span class="built_in">list</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- k8s.gcr.io/kube-apiserver:v1.18.0</span><br><span class="line">- k8s.gcr.io/kube-controller-manager:v1.18.0</span><br><span class="line">- k8s.gcr.io/kube-scheduler:v1.18.0</span><br><span class="line">- k8s.gcr.io/kube-proxy:v1.18.0</span><br><span class="line">- k8s.gcr.io/pause:3.2</span><br><span class="line">- k8s.gcr.io/etcd:3.4.3-0</span><br><span class="line">- k8s.gcr.io/coredns:1.6.7</span><br></pre></td></tr></table></figure><p>国内拉阿里云对应镜像。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从阿里云拉取镜像</span></span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/kube-apiserver:v1.18.0</span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/kube-controller-manager:v1.18.0</span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/kube-scheduler:v1.18.0</span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/kube-proxy:v1.18.0</span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/pause:3.2</span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/etcd:3.4.3-0</span><br><span class="line">docker pull registry.cn-qingdao.aliyuncs.com/kubernetes-image/coredns:1.6.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新tag镜像</span></span><br><span class="line">docker images \</span><br><span class="line">    | grep registry.cn-qingdao.aliyuncs.com/kubernetes-image \</span><br><span class="line">    | sed <span class="string">'s/registry.cn-qingdao.aliyuncs.com\/kubernetes-image/k8s.gcr.io/'</span> \</span><br><span class="line">    | awk <span class="string">'&#123;print "docker tag " $3 " " $1 ":" $2&#125;'</span> \</span><br><span class="line">    | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除旧镜像</span></span><br><span class="line">docker images \</span><br><span class="line">    | grep registry.cn-qingdao.aliyuncs.com/kubernetes-image \</span><br><span class="line">    | awk <span class="string">'&#123;print "docker rmi " $1 ":" $2&#125;'</span> \</span><br><span class="line">    | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 /root/packages/images 目录下导出镜像为压缩包</span></span><br><span class="line">docker save -o kube-controller-manager-v1.18.0.tar k8s.gcr.io/kube-controller-manager:v1.18.0</span><br><span class="line">docker save -o kube-apiserver-v1.18.0.tar k8s.gcr.io/kube-apiserver:v1.18.0</span><br><span class="line">docker save -o kube-scheduler-v1.18.0.tar k8s.gcr.io/kube-scheduler:v1.18.0</span><br><span class="line">docker save -o kube-proxy-v1.18.0.tar k8s.gcr.io/kube-proxy:v1.18.0</span><br><span class="line">docker save -o coredns-1.6.7.tar k8s.gcr.io/coredns:1.6.7</span><br><span class="line">docker save -o etcd-3.4.3-0.tar k8s.gcr.io/etcd:3.4.3-0</span><br><span class="line">docker save -o pause-3.2.tar k8s.gcr.io/pause:3.2</span><br></pre></td></tr></table></figure><h3 id="calico网络插件依赖镜像"><a href="#calico网络插件依赖镜像" class="headerlink" title="calico网络插件依赖镜像"></a>calico网络插件依赖镜像</h3><p>从<a href="https://docs.projectcalico.org/v3.10/getting-started/kubernetes/" target="_blank" rel="noopener">Quickstart for Calico on Kubernetes</a>找到<code>calico.yaml</code>文件，命名为<code>calico-v3.10.3.yaml</code>保存到资源包<code>/root/packages/plugins</code>目录中。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat calico-v3.10.3.yaml | grep image: | awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure><p>从文件中搜索<code>image</code>关键字找到如下依赖镜像。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- calico/cni:v3.10.3</span><br><span class="line">- calico/pod2daemon-flexvol:v3.10.3</span><br><span class="line">- calico/node:v3.10.3</span><br><span class="line">- calico/kube-controllers:v3.10.3</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取全部镜像</span></span><br><span class="line">cat calico-v3.10.3.yaml \</span><br><span class="line">    | grep image: \</span><br><span class="line">    | awk <span class="string">'&#123;print "docker pull " $2&#125;'</span> \</span><br><span class="line">    | sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 /root/packages/images 目录下导出镜像为压缩包</span></span><br><span class="line">docker save -o calico-cni-v3.10.3.tar calico/cni:v3.10.3</span><br><span class="line">docker save -o calico-pod2daemon-flexvol-v3.10.3.tar calico/pod2daemon-flexvol:v3.10.3</span><br><span class="line">docker save -o calico-node-v3.10.3.tar calico/node:v3.10.3</span><br><span class="line">docker save -o calico-kube-controllers-v3.10.3.tar calico/kube-controllers:v3.10.3</span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="1、kubernetes-dashboard"><a href="#1、kubernetes-dashboard" class="headerlink" title="1、kubernetes dashboard"></a>1、kubernetes dashboard</h4><p>从GitHub上找到Dashboard最新版本部署文件。</p><ul><li>Dashboard版本发布地址：<a href="https://github.com/kubernetes/dashboard/releases" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard/releases</a></li></ul><h4 id="2、NGINX-Ingress-Controller"><a href="#2、NGINX-Ingress-Controller" class="headerlink" title="2、NGINX Ingress Controller"></a>2、NGINX Ingress Controller</h4><p>同样在官方网站找到部署<code>yaml</code>文件，并获取镜像列。</p><ul><li><a href="https://kubernetes.github.io/ingress-nginx/deploy/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/deploy/</a></li></ul><h2 id="准备工作后，离线安装"><a href="#准备工作后，离线安装" class="headerlink" title="准备工作后，离线安装"></a>准备工作后，离线安装</h2><h3 id="环境-1"><a href="#环境-1" class="headerlink" title="环境"></a>环境</h3><ul><li>Master节点 192.168.1.30</li><li>Worker节点 192.168.1.31</li></ul><h3 id="安装Master"><a href="#安装Master" class="headerlink" title="安装Master"></a>安装Master</h3><p>在<code>master</code>节点上执行。</p><ol><li><code>scp</code>命令上传资源包到<code>/root</code>目录下解压，<code>192.168.1.30</code>改为你节点的IP。</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp packages.tar root@192.168.1.30:/root/</span><br></pre></td></tr></table></figure><ol><li>解压到<code>/root/packages</code>目录</li></ol><p><strong>注意</strong>：解压路径不能修改。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/packages</span><br><span class="line">tar -xzvf packages.tar -C /root/packages</span><br></pre></td></tr></table></figure><ol><li>设置参数并安装</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># master节点的主机名</span></span><br><span class="line"><span class="built_in">export</span> HOSTNAMES=k8smaster</span><br><span class="line"><span class="comment"># kubernetes apiserver的主机地址</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=192.168.1.30</span><br><span class="line"><span class="comment"># 镜像仓库私有仓库名，默认k8s.gcr.io</span></span><br><span class="line"><span class="built_in">export</span> IMAGEREPO=&lt;harbor_address&gt;/kubernetes-image</span><br><span class="line"><span class="comment"># Pod 使用的网段</span></span><br><span class="line"><span class="built_in">export</span> PODSUBNET=10.11.0.0/16</span><br><span class="line"><span class="comment"># etcd数据路径，默认/var/lib/etcd</span></span><br><span class="line"><span class="built_in">export</span> ETCD_DIR=/home/etcd</span><br><span class="line"><span class="comment"># kube的版本信息</span></span><br><span class="line"><span class="built_in">export</span> KUBEVERSION=v1.18.0</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> /root/packages</span><br><span class="line">./main_master.sh</span><br></pre></td></tr></table></figure><h3 id="安装Worker"><a href="#安装Worker" class="headerlink" title="安装Worker"></a>安装Worker</h3><p>如果需要添加节点的话，在<code>worker</code>节点上执行。。。。</p><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="Pod启动报镜像拉取失败"><a href="#Pod启动报镜像拉取失败" class="headerlink" title="Pod启动报镜像拉取失败"></a>Pod启动报镜像拉取失败</h4><p>有些部署文件中设置了镜像拉取策略为<code>imagePullPolicy:Always</code>，意思是每次启动都要拉取镜像，修改为<code>imagePullPolicy:IfNotPresent</code>如果不存在才拉取就行了，或者搭建私有仓库亦可。</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Kubernetes_install </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计篇之Paas基础学习</title>
      <link href="/passages/%E8%AE%BE%E8%AE%A1%E7%AF%87%E4%B9%8BPaas%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"/>
      <url>/passages/%E8%AE%BE%E8%AE%A1%E7%AF%87%E4%B9%8BPaas%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Paas </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计架构 </tag>
            
            <tag> Paas </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang碎片之http包</title>
      <link href="/passages/Golang%E7%A2%8E%E7%89%87%E4%B9%8Bhttp%E5%8C%85/"/>
      <url>/passages/Golang%E7%A2%8E%E7%89%87%E4%B9%8Bhttp%E5%8C%85/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Golang-Study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang碎片之GPM</title>
      <link href="/passages/Golang%E7%A2%8E%E7%89%87%E4%B9%8BGPM/"/>
      <url>/passages/Golang%E7%A2%8E%E7%89%87%E4%B9%8BGPM/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Golang-Study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络爬虫系列一</title>
      <link href="/passages/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E7%B3%BB%E5%88%97%E4%B8%80/"/>
      <url>/passages/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E7%B3%BB%E5%88%97%E4%B8%80/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> 爬虫 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网络学习篇之TCP</title>
      <link href="/passages/%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0%E7%AF%87%E4%B9%8BTCP/"/>
      <url>/passages/%E7%BD%91%E7%BB%9C%E5%AD%A6%E4%B9%A0%E7%AF%87%E4%B9%8BTCP/</url>
      
        <content type="html"><![CDATA[<h2 id="TCP三次握手和四次挥手以及11种状态"><a href="#TCP三次握手和四次挥手以及11种状态" class="headerlink" title="TCP三次握手和四次挥手以及11种状态"></a>TCP三次握手和四次挥手以及11种状态</h2><h3 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h3><p>置位概念：根据TCP的包头字段，存在3个重要的标识ACK、SYN、FIN</p><blockquote><p>ACK：表示验证字段 SYN：位数置1，表示建立TCP连接 FIN：位数置1，表示断开TCP连接<a id="more"></a></p></blockquote><img src="/passages/网络学习篇之TCP/1.png"><p><strong>三次握手过程说明：</strong></p><p>1.由客户端发送建立TCP连接的请求报文，其中报文中包含seq序列号，是由发送端随机生成的，并且将报文中的SYN字段置为1，表示需要建立TCP连接。（SYN=1，seq=x，x为随机生成数值）2.由服务端回复客户端发送的TCP连接请求报文，其中包含seq序列号，是由回复端随机生成的，并且将SYN置为1，而且会产生ACK字段，ACK字段数值是在客户端发送过来的序列号seq的基础上加1进行回复，以便客户端收到信息时，知晓自己的TCP建立请求已得到验证。（SYN=1，ACK=x+1，seq=y，y为随机生成数值）这里的ack加1可以理解为是确认和谁建立连接。3.客户端收到服务端发送的TCP建立验证请求后，会使自己的序列号加1表示，并且再次回复ACK验证请求，在服务端发过来的seq上加1进行回复。（SYN=1，ACK=y+1，seq=x+1）</p><h3 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h3><img src="/passages/网络学习篇之TCP/2.png"><p><strong>四次挥手过程说明：</strong></p><p>1.客户端发送断开TCP连接请求的报文，其中报文中包含seq序列号，是由发送端随机生成的，并且还将报文中的FIN字段置为1，表示需要断开TCP连接。（FIN=1，seq=x，x由客户端随机生成）2.服务端会回复客户端发送的TCP断开请求报文，其包含seq序列号，是由回复端随机生成的，而且会产生ACK字段，ACK字段数值是在客户端发过来的seq序列号基础上加1进行回复，以便客户端收到信息时，知晓自己的TCP断开请求已经得到验证。（FIN=1，ACK=x+1，seq=y，y由服务端随机生成）3.服务端在回复完客户端的TCP断开请求后，不会马上进行TCP连接的断开，服务端会先确保断开前，所有传输到A的数据是否已经传输完毕，一旦确认传输数据完毕，就会将回复报文的FIN字段置1，并且产生随机seq序列号。（FIN=1，ACK=x+1，seq=z，z由服务端随机生成）4.客户端收到服务端的TCP断开请求后，会回复服务端的断开请求，包含随机生成的seq字段和ACK字段，ACK字段会在服务端的TCP断开请求的seq基础上加1，从而完成服务端请求的验证回复。（FIN=1，ACK=z+1，seq=h，h为客户端随机生成）</p><p>至此TCP断开的4次挥手过程完毕</p><h3 id="11种状态"><a href="#11种状态" class="headerlink" title="11种状态"></a>11种状态</h3><img src="/passages/网络学习篇之TCP/3.png"><p>1.一开始，建立连接之前服务器和客户端的状态都为CLOSED；2.服务器创建socket后开始监听，变为LISTEN状态；3.客户端请求建立连接，向服务器发送SYN报文，客户端的状态变味SYN_SENT；4.服务器收到客户端的报文后向客户端发送ACK和SYN报文，此时服务器的状态变为SYN_RCVD；5.然后，客户端收到ACK、SYN，就向服务器发送ACK，客户端状态变为ESTABLISHED；6.服务器端收到客户端的ACK后变为ESTABLISHED。此时3次握手完成，连接建立！</p><img src="/passages/网络学习篇之TCP/4.png"><p><strong>由于TCP连接是全双工的，断开连接会比建立连接麻烦一点点。</strong></p><p>1.客户端先向服务器发送FIN报文，请求断开连接，其状态变为FIN_WAIT1；2.服务器收到FIN后向客户端发送ACK，服务器的状态围边CLOSE_WAIT；3.客户端收到ACK后就进入FIN_WAIT2状态，此时连接已经断开了一半了。如果服务器还有数据要发送给客户端，就会继续发送；4.直到发完数据，就会发送FIN报文，此时服务器进入LAST_ACK状态；5.客户端收到服务器的FIN后，马上发送ACK给服务器，此时客户端进入TIME_WAIT状态；6.再过了2MSL长的时间后进入CLOSED状态。服务器收到客户端的ACK就进入CLOSED状态。</p><p>至此，还有一个状态没有出来：CLOSING状态。</p><p><strong>CLOSING状态表示：</strong> 客户端发送了FIN，但是没有收到服务器的ACK，却收到了服务器的FIN，这种情况发生在服务器发送的ACK丢包的时候，因为网络传输有时会有意外。</p><p>•<strong>LISTEN</strong>：等待从任何远端TCP 和端口的连接请求。•<strong>SYN_SENT</strong>：发送完一个连接请求后等待一个匹配的连接请求。•<strong>SYN_RECEIVED</strong>：发送连接请求并且接收到匹配的连接请求以后等待连接请求确认。•<strong>ESTABLISHED</strong>：表示一个打开的连接，接收到的数据可以被投递给用户。连接的数据传输阶段的正常状态。•<strong>FIN_WAIT_1</strong>：等待远端TCP 的连接终止请求，或者等待之前发送的连接终止请求的确认。•<strong>FIN_WAIT_2</strong>：等待远端TCP 的连接终止请求。•<strong>CLOSE_WAIT</strong>：等待本地用户的连接终止请求。•<strong>CLOSING</strong>：等待远端TCP 的连接终止请求确认。•<strong>LAST_ACK</strong>：等待先前发送给远端TCP 的连接终止请求的确认（包括它字节的连接终止请求的确认）•<strong>TIME_WAIT</strong>：等待足够的时间过去以确保远端TCP 接收到它的连接终止请求的确认。•<strong>TIME_WAIT</strong> 两个存在的理由：•可靠的实现tcp全双工连接的终止；•允许老的重复分节在网络中消逝。•<strong>CLOSED</strong>：不在连接状态（这是为方便描述假想的状态，实际不存在）</p>]]></content>
      
      
      <categories>
          
          <category> Network </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之harbor实践篇</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bharbor%E5%AE%9E%E8%B7%B5%E7%AF%87/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bharbor%E5%AE%9E%E8%B7%B5%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="harbor文档"><a href="#harbor文档" class="headerlink" title="harbor文档"></a>harbor文档</h2><h3 id="一、docker-compose安装"><a href="#一、docker-compose安装" class="headerlink" title="一、docker-compose安装"></a>一、docker-compose安装<a id="more"></a></h3><p>1、确认安装pip，pip -v</p><p>2、如果没有安装pip， 执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install python-pip</span><br></pre></td></tr></table></figure><p>3、升级pip用新安装可不用执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade pip</span><br></pre></td></tr></table></figure><p>4、安装docker-compose</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure><p>5、检查docker-compose安装：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -version</span><br></pre></td></tr></table></figure><h3 id="二、Harbor安装"><a href="#二、Harbor安装" class="headerlink" title="二、Harbor安装"></a>二、Harbor安装</h3><p>1、Harbor安装部署(按1.5.4版本，前提安装好docker服务并启动)</p><p>Harbor安装步骤(确保80端口没被占用)：</p><ol><li><a href="https://github.com/goharbor/harbor/releases下载对应包" target="_blank" rel="noopener">https://github.com/goharbor/harbor/releases下载对应包</a>;</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://storage.googleapis.com/harbor-releases/release-1.5.0/harbor-offline-installer-v1.5.4.tgz</span><br><span class="line">tar zxvf harbor-offline-installer-v1.5.4.tgz</span><br><span class="line">cd harbor</span><br></pre></td></tr></table></figure><ol start="2"><li>修改配置文件harbor.cfg;</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 有个hostname参数修改为本主机ip；hostname = xxx</span><br></pre></td></tr></table></figure><ol start="3"><li>执行install.sh来install and start Harbor;</li></ol><p>harbor开源地址：<a href="https://github.com/goharbor/harbor" target="_blank" rel="noopener">https://github.com/goharbor/harbor</a></p><p>2、Harbor启停：</p><p>  方式一：</p><p>​    关闭harbor服务：docker-compose down -v</p><p>​    修改配置文件：vim harbor.cfg</p><p>​    重新生成配置文件：./prepare或者或者bash prepare</p><p>​    启动Harbor服务：docker-compose up -d</p><p>  方式二：</p><p>​    修改配置文件：vim harbor.cfg</p><p>​    重新生成配置文件：./prepare或者或者bash prepare</p><p>​    重启harbor：docker-compose down -v &amp;&amp; docker-compose up -d</p><p>  注意：如果更改了harbor.cfg文件，必须要重新执行install脚本,或者执行./prepare脚本，生成新的配置文件； </p><p>3、常用debug方式:</p><p>  docker info查看docker程序的配置信息</p><p>  docker-compose ps：查看harbor相关的容器信息</p><p>4、Harbor测试：</p><p>浏览器测试：直接输入<harbor-ip>打开页面可查看</harbor-ip></p><p>  登录仓库：docker login <harbor-ip></harbor-ip></p><p>  默认账号：admin/Harbor12345</p><p>  镜像推送：docker push <harbor-ip>/library/IMAGE[:TAG]</harbor-ip></p><p>  针对无证书harbor, 可以修改docker insecure-registry</p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之harbor实践篇2</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bharbor%E5%AE%9E%E8%B7%B5%E7%AF%872/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bharbor%E5%AE%9E%E8%B7%B5%E7%AF%872/</url>
      
        <content type="html"><![CDATA[<h2 id="记录harbor-1-5升级到1-9"><a href="#记录harbor-1-5升级到1-9" class="headerlink" title="记录harbor 1.5升级到1.9"></a>记录harbor 1.5升级到1.9</h2><h3 id="背景："><a href="#背景：" class="headerlink" title="背景："></a>背景：</h3><h6 id="简明："><a href="#简明：" class="headerlink" title="简明："></a>简明：</h6><p>内网环境<code>harbor1.5.0</code>升级要1.9<a id="more"></a></p><h6 id="要点："><a href="#要点：" class="headerlink" title="要点："></a>要点：</h6><p>（1）harbor数据库在<code>v1.6</code>版本做了很大的升级。数据库从原来的<code>MySQL</code>升级为<code>postgresql</code>数据库。根据<a href="https://github.com/goharbor/harbor/blob/master/docs/migration_guide.md" target="_blank" rel="noopener">官方文档</a>的解释，旧版本的harbor升级到最新的<code>v1.9</code>,需先将harbor升级到<code>v1.6</code>,再升级到更高的版本。<br>（2）从<code>v1.8.0</code>开始，Harbor的配置已更改为<code>.yml</code>文件，迁移器将配置文件从<code>harbor.cfg</code>转换为<code>harbor.yml</code>。<br>（3）从<code>v1.6.0</code>开始，Harbor会在启动时自动尝试迁移数据库，因此如果从<code>v1.6.0</code>或更高版本升级，则无需调用迁移器工具来迁移数据库，只需要更新<code>cfg</code>文件即可。<br>（4）从<code>v1.7.0</code>开始，支持Helm Chart部署。</p><h6 id="方案："><a href="#方案：" class="headerlink" title="方案："></a>方案：</h6><p>先从1.5升级到1.6，再从1.6升级到1.7，然后升级到1.9（按照官方文档的升级路线）</p><h3 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h3><hr><h5 id="一、harbor1-5-0升级到harbor1-6-3（既要升级db也要升级cfg）"><a href="#一、harbor1-5-0升级到harbor1-6-3（既要升级db也要升级cfg）" class="headerlink" title="一、harbor1.5.0升级到harbor1.6.3（既要升级db也要升级cfg）"></a>一、harbor1.5.0升级到harbor1.6.3（既要升级db也要升级cfg）</h5><h6 id="（1）停下在运行的harbor"><a href="#（1）停下在运行的harbor" class="headerlink" title="（1）停下在运行的harbor"></a>（1）停下在运行的harbor</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon ~]# cd harbor</span><br><span class="line">[root@bogon harbor]# ls</span><br><span class="line">common                    docker-compose.notary.yml  ha          harbor.v1.5.0.tar.gz  LICENSE  prepare</span><br><span class="line">docker-compose.clair.yml  docker-compose.yml         harbor.cfg  install.sh            NOTICE</span><br><span class="line">[root@bogon harbor]# docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                    PORTS                                                              NAMES</span><br><span class="line">717ef68de036        vmware/harbor-jobservice:v1.5.0        "/harbor/start.sh"       40 minutes ago      Up 40 minutes                                                                                harbor-jobservice</span><br><span class="line">ee95661aa905        vmware/nginx-photon:v1.5.0             "nginx -g 'daemon ..."   40 minutes ago      Up 38 minutes (healthy)   0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp   nginx</span><br><span class="line">85aa0167d66a        vmware/harbor-ui:v1.5.0                "/harbor/start.sh"       40 minutes ago      Up 40 minutes (healthy)                                                                      harbor-ui</span><br><span class="line">cb256cbf09ed        vmware/clair-photon:v2.0.1-v1.5.0      "/docker-entrypoin..."   40 minutes ago      Up 40 minutes (healthy)   6060-6061/tcp                                                      clair</span><br><span class="line">e3aa51500bdc        vmware/postgresql-photon:v1.5.0        "/entrypoint.sh po..."   40 minutes ago      Up 40 minutes (healthy)   5432/tcp                                                           clair-db</span><br><span class="line">dce4338d4071        vmware/registry-photon:v2.6.2-v1.5.0   "/entrypoint.sh se..."   40 minutes ago      Up 40 minutes (healthy)   5000/tcp                                                           registry</span><br><span class="line">43e6fbebc160        vmware/harbor-db:v1.5.0                "/usr/local/bin/do..."   40 minutes ago      Up 40 minutes (healthy)   3306/tcp                                                           harbor-db</span><br><span class="line">eca25eea5b18        vmware/harbor-adminserver:v1.5.0       "/harbor/start.sh"       40 minutes ago      Up 40 minutes (healthy)                                                                      harbor-adminserver</span><br><span class="line">d68e94c20695        vmware/redis-photon:v1.5.0             "docker-entrypoint..."   40 minutes ago      Up 40 minutes             6379/tcp                                                           redis</span><br><span class="line">280da2ce97a9        vmware/harbor-log:v1.5.0               "/bin/sh -c /usr/l..."   40 minutes ago      Up 40 minutes (healthy)   127.0.0.1:1514-&gt;10514/tcp                                          harbor-log</span><br><span class="line">[root@bogon harbor]# </span><br><span class="line">[root@bogon harbor]# docker-compose -f docker-compose.yml -f docker-compose.clair.yml down -v</span><br></pre></td></tr></table></figure><h6 id="（2）备份harbor目录"><a href="#（2）备份harbor目录" class="headerlink" title="（2）备份harbor目录"></a>（2）备份harbor目录</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# cd ..</span><br><span class="line">[root@bogon lanjian]# cp -r harbor harbor1.5.0-bak</span><br></pre></td></tr></table></figure><h6 id="（3）下载harbor-1-6-3镜像、数据迁移工具，以及1-5-0数据迁移工具"><a href="#（3）下载harbor-1-6-3镜像、数据迁移工具，以及1-5-0数据迁移工具" class="headerlink" title="（3）下载harbor 1.6.3镜像、数据迁移工具，以及1.5.0数据迁移工具"></a>（3）下载harbor 1.6.3镜像、数据迁移工具，以及1.5.0数据迁移工具</h6><p>Get the Lastest Harbor release package from <a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">Github</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost lanjian]# docker pull goharbor/harbor-migrator:v1.6.0</span><br><span class="line">Trying to pull repository docker.io/goharbor/harbor-migrator ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/harbor-migrator</span><br><span class="line">51be32cd3c9d: Pull complete </span><br><span class="line">7e261d84cd9e: Pull complete </span><br><span class="line">f52c9d206429: Pull complete </span><br><span class="line">e399eeb55d79: Pull complete </span><br><span class="line">Digest: sha256:a8398de33c60bba7ad93ddcf977791e187e8b8553214f5589c749959bd265712</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/harbor-migrator:v1.6.0</span><br><span class="line">[root@localhost lanjian]# docker images |grep harbor</span><br><span class="line">docker.io/goharbor/harbor-migrator     v1.6.3              dac56e1d921f        11 months ago       799 MB</span><br><span class="line">docker.io/goharbor/harbor-migrator     v1.6.0              22775c4e4066        14 months ago       803 MB</span><br><span class="line">vmware/harbor-log                      v1.5.0              62bb6b8350d9        18 months ago       200 MB</span><br><span class="line">vmware/harbor-jobservice               v1.5.0              aca9fd2e867f        18 months ago       194 MB</span><br><span class="line">vmware/harbor-ui                       v1.5.0              1055166068d0        18 months ago       212 MB</span><br><span class="line">vmware/harbor-adminserver              v1.5.0              019bc4544829        18 months ago       183 MB</span><br><span class="line">vmware/harbor-db                       v1.5.0              82354dcf564f        18 months ago       526 MB</span><br><span class="line">vmware/harbor-migrator                 v1.5.0              466c57ab0dc3        18 months ago       1.16 GB</span><br></pre></td></tr></table></figure><h6 id="（4）备份cfg和db"><a href="#（4）备份cfg和db" class="headerlink" title="（4）备份cfg和db"></a>（4）备份cfg和db</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]# docker run -it --rm -e DB_USR=root -e DB_PWD=root123 -v /data/database:/var/lib/mysql -v /home/lanjian/harbor/harbor.cfg:/harbor-migration/harbor-cfg/harbor.cfg -v /home/lanjian/backup:/harbor-migration/backup goharbor/harbor-migrator:v1.6.3 backup</span><br></pre></td></tr></table></figure><h6 id="（5）升级数据库框架（将MySQL框架升级为postgresql）并同步数据"><a href="#（5）升级数据库框架（将MySQL框架升级为postgresql）并同步数据" class="headerlink" title="（5）升级数据库框架（将MySQL框架升级为postgresql）并同步数据"></a>（5）升级数据库框架（将MySQL框架升级为postgresql）并同步数据</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]# docker run -it --rm -e DB_USR=root -e DB_PWD=root123 -v /data/database:/var/lib/mysql -v /home/lanjian/harbor/harbor.cfg:/harbor-migration/harbor-cfg/harbor.cfg goharbor/harbor-migrator:v1.6.0 up</span><br></pre></td></tr></table></figure><h6 id="（6）升级harbor镜像及cfg并拷贝过去"><a href="#（6）升级harbor镜像及cfg并拷贝过去" class="headerlink" title="（6）升级harbor镜像及cfg并拷贝过去"></a>（6）升级harbor镜像及cfg并拷贝过去</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost lanjian]# mkdir harbor-1.6.3</span><br><span class="line">[root@localhost lanjian]# cd 下载</span><br><span class="line">[root@localhost 下载]# tar zxvf harbor-offline-installer-v1.6.3.tgz -C ../harbor1.6.3/</span><br><span class="line">[root@localhost 下载]# cd ../harbor1.6.3/</span><br><span class="line">[root@localhost harbor1.6.3]# ls</span><br><span class="line">harbor</span><br><span class="line">[root@localhost harbor1.6.3]# cd harbor/</span><br><span class="line">[root@localhost harbor]# ls</span><br><span class="line">common                          docker-compose.clair.yml   docker-compose.yml  harbor.cfg            install.sh  NOTICE               prepare</span><br><span class="line">docker-compose.chartmuseum.yml  docker-compose.notary.yml  ha                  harbor.v1.6.3.tar.gz  LICENSE     open_source_license</span><br><span class="line">[root@localhost harbor]#  docker run -it --rm -v /root/backup/harbor.cfg:/harbor-migration/harbor-cfg/harbor.cfg goharbor/harbor-migrator:v1.6.0 --cfg up</span><br><span class="line">[root@localhost backup]# cp harbor.cfg /home/lanjian/harbor/</span><br><span class="line">cp：是否覆盖"/home/lanjian/harbor/harbor.cfg"？ yes</span><br><span class="line">[root@localhost backup]#</span><br></pre></td></tr></table></figure><h6 id="（7）启动harbor1-6-3并验证"><a href="#（7）启动harbor1-6-3并验证" class="headerlink" title="（7）启动harbor1.6.3并验证"></a>（7）启动harbor1.6.3并验证</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]# ./install.sh</span><br></pre></td></tr></table></figure><p>验证下版本是否完成升级，以及用户、镜像是否都正常<br><img src="/passages/学习杂记之harbor实践篇2/3.png"></p><img src="/passages/学习杂记之harbor实践篇2/2.png"><p>二、harbor1.6.3升级到1.7.0（相当于只需要升级cfg文件不用管db）</p><h6 id="（1）同样的，停下正在运行的harbor"><a href="#（1）同样的，停下正在运行的harbor" class="headerlink" title="（1）同样的，停下正在运行的harbor"></a>（1）同样的，停下正在运行的harbor</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost lanjian]# cd harbor</span><br><span class="line">[root@localhost harbor]# docker-compose -f docker-compose.yml -f docker-compose.clair.yml down</span><br></pre></td></tr></table></figure><h6 id="（2）备份数据"><a href="#（2）备份数据" class="headerlink" title="（2）备份数据"></a>（2）备份数据</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost lanjian]# mkdir harbor1.6.0-bak</span><br><span class="line">[root@localhost lanjian]# mv harbor harbor1.6.0-bak/harbor</span><br><span class="line">[root@localhost lanjian]# cp -r /data/database harbor1.6.0-bak/</span><br></pre></td></tr></table></figure><h6 id="（3）下载harbor-v1-7-0离线安装包解压和migrate容器镜像"><a href="#（3）下载harbor-v1-7-0离线安装包解压和migrate容器镜像" class="headerlink" title="（3）下载harbor v1.7.0离线安装包解压和migrate容器镜像"></a>（3）下载harbor v1.7.0离线安装包解压和migrate容器镜像</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost 下载]# tar zxvf harbor-offline-installer-v1.7.0.tgz</span><br><span class="line">[root@localhost 下载]# mv harbor ../harbor</span><br><span class="line">[root@localhost lanjian]# docker pull goharbor/harbor-migrator:v1.7.0</span><br></pre></td></tr></table></figure><h6 id="（4）升级harbor-cfg"><a href="#（4）升级harbor-cfg" class="headerlink" title="（4）升级harbor.cfg"></a>（4）升级harbor.cfg</h6><p>官方文档：NOTE: The ${harbor_cfg} will be overwritten, you must move it to your installation directory after migration.<br>即是在备份目录里直接升级cfg文件的，然后再拷贝到新的harbor目录下，所以为防止意外，先对harbor.cfg再备份一次后再升级<br>PS：这里挂载volume时需要注意宿主机和容器都需要绝对路径，不然会报错，宿主机虽然可以相对路径，但其实所谓的相对路径指的是/var/lib/docker/volumes/，与宿主机的当前目录无关。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]# cd ../harbor1.6.0-bak/</span><br><span class="line">[root@localhost harbor]# cp harbor.cfg harbor.cfg.bak</span><br><span class="line">[root@localhost harbor]# docker run -it --rm -v /home/lanjian/harbor1.6.0-bak/harbor/harbor.cfg:/harbor-migration/harbor-cfg/harbor.cfg docker.io/goharbor/harbor-migrator:v1.7.0 --cfg up</span><br><span class="line">Please backup before upgrade, </span><br><span class="line">Enter y to continue updating or n to abort: y</span><br><span class="line">The path of the migrated harbor.cfg is not set, the input file will be overwritten.</span><br><span class="line">input version: 1.6.0, migrator chain: ['1.7.0']</span><br><span class="line">migrating to version 1.7.0</span><br><span class="line">Written new values to /harbor-migration/harbor-cfg/harbor.cfg</span><br></pre></td></tr></table></figure><p>我们看到当前cfg文件已经被修改了，不是1.6的了，将其拷贝到1.7的安装路径下面即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]# cat harbor.cfg|grep version</span><br><span class="line"><span class="meta">#</span><span class="bash">This attribute is <span class="keyword">for</span> migrator to detect the version of the .cfg file, DO NOT MODIFY!</span></span><br><span class="line">_version = 1.7.0</span><br><span class="line"><span class="meta">#</span><span class="bash">Log files are rotated log_rotate_count <span class="built_in">times</span> before being removed. If count is 0, old versions are removed rather than rotated.</span></span><br><span class="line">[root@localhost harbor]# mv harbor.cfg /home/lanjian/harbor/</span><br></pre></td></tr></table></figure><h6 id="（5）启动harbor-v1-7-0并打开UI确认升级完成情况"><a href="#（5）启动harbor-v1-7-0并打开UI确认升级完成情况" class="headerlink" title="（5）启动harbor v1.7.0并打开UI确认升级完成情况"></a>（5）启动harbor v1.7.0并打开UI确认升级完成情况</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost harbor]# cd /home/lanjian/harbor</span><br><span class="line">[root@localhost harbor]# ./install.sh</span><br></pre></td></tr></table></figure><p>如果需要安装clair则带上参数 –with-clair哈<br><img src="/passages/学习杂记之harbor实践篇2/4.png"></p><h5 id="三、harbor-1-7升级到1-9（升级cfg为yml）"><a href="#三、harbor-1-7升级到1-9（升级cfg为yml）" class="headerlink" title="三、harbor 1.7升级到1.9（升级cfg为yml）"></a>三、harbor 1.7升级到1.9（升级cfg为yml）</h5><p>特别注意两点：<br>With the introduction of storage and artifact quotas in version 1.9.0, migration from 1.7.x and 1.8.x might take a few minutes. This is because the core walks through all blobs in the registry and populates the database with information about the layers and artifacts in projects.<br>因为引入了storage and artifact quotas，这次升级会比较费时间，核心会遍历仓库和数据库中的层信息</p><p>With the introduction of storage and artifact quotas in version 1.9.0, replication between version 1.9.0 and a previous version of Harbor does not work. You must upgrade all Harbor nodes to 1.9.0 if you have configured replication between them.<br>因为引入了storage and artifact quotas，所以同步复制只能再1.9的版本之间进行，如果其中一个仓库低于1.9则无法进行同步</p><h6 id="（1）停止正在运行的harbor"><a href="#（1）停止正在运行的harbor" class="headerlink" title="（1）停止正在运行的harbor"></a>（1）停止正在运行的harbor</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# docker-compose -f docker-compose.yml -f docker-compose.clair.yml down -v</span><br></pre></td></tr></table></figure><h6 id="（2）备份数据-1"><a href="#（2）备份数据-1" class="headerlink" title="（2）备份数据"></a>（2）备份数据</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon lanjian]# mkdir harbor1.7.0-bak</span><br><span class="line">[root@bogon lanjian]# mv harbor harbor1.7.0-bak/harbor</span><br><span class="line">[root@bogon lanjian]# cp -r /data/database harbor1.7.0-bak/</span><br></pre></td></tr></table></figure><h6 id="（3）下载harbor-1-9-0安装包解压及migrator镜像"><a href="#（3）下载harbor-1-9-0安装包解压及migrator镜像" class="headerlink" title="（3）下载harbor 1.9.0安装包解压及migrator镜像"></a>（3）下载harbor 1.9.0安装包解压及migrator镜像</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon lanjian]# docker pull goharbor/harbor-migrator:v1.9.0</span><br><span class="line">[root@bogon 下载]# tar zxvf harbor-offline-installer-v1.9.0.tgz -C /home/lanjian/</span><br><span class="line">[root@bogon lanjian]# cd harbor</span><br><span class="line">[root@bogon harbor]# ls</span><br><span class="line">harbor.v1.9.0.tar.gz  harbor.yml  install.sh  LICENSE  prepare</span><br></pre></td></tr></table></figure><h6 id="（4）升级cfg为yml文件"><a href="#（4）升级cfg为yml文件" class="headerlink" title="（4）升级cfg为yml文件"></a>（4）升级cfg为yml文件</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# docker run -it --rm -v /home/lanjian/harbor1.7.0-bak/harbor/harbor.cfg:/harbor-migration/harbor-cfg/harbor.yml -v /home/lanjian/harbor/harbor.yml:/harbor-migration/harbor-cfg-out/harbor.yml docker.io/goharbor/harbor-migrator:v1.9.0 --cfg up</span><br></pre></td></tr></table></figure><p>发现有报错：jinja2.exceptions.UndefinedError: ‘chart’ is undefined</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Please backup before upgrade, </span><br><span class="line">Enter y to continue updating or n to abort: y</span><br><span class="line">Command for config file migration: python ./cfg/run.py --input /harbor-migration/harbor-cfg/harbor.yml --output /harbor-migration/harbor-cfg-out/harbor.yml</span><br><span class="line">input version: 1.7.0, migrator chain: ['1.8.0', '1.9.0']</span><br><span class="line">migrating to version 1.8.0</span><br><span class="line">migrating to version 1.9.0</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File "./cfg/run.py", line 70, in &lt;module&gt;</span><br><span class="line">    main()</span><br><span class="line">  File "./cfg/run.py", line 46, in main</span><br><span class="line">    m.migrate(curr_input_path, curr_output_path)</span><br><span class="line">  File "/harbor-migration/cfg/migrator_1_9_0/__init__.py", line 21, in migrate</span><br><span class="line">    f.write(tpl.render(**config_dict))</span><br><span class="line">  File "/usr/lib/python2.7/site-packages/jinja2/environment.py", line 1008, in render</span><br><span class="line">    return self.environment.handle_exception(exc_info, True)</span><br><span class="line">  File "/usr/lib/python2.7/site-packages/jinja2/environment.py", line 780, in handle_exception</span><br><span class="line">    reraise(exc_type, exc_value, tb)</span><br><span class="line">  File "/harbor-migration/cfg/migrator_1_9_0/harbor.yml.jinja", line 122, in top-level template code</span><br><span class="line">    absolute_url: &#123;&#123; chart.absolute_url if chart.absolute_url == 'enabled' else 'disabled' &#125;&#125;</span><br><span class="line">  File "/usr/lib/python2.7/site-packages/jinja2/environment.py", line 430, in getattr</span><br><span class="line">    return getattr(obj, attribute)</span><br><span class="line">jinja2.exceptions.UndefinedError: 'chart' is undefined</span><br></pre></td></tr></table></figure><p>通过查看<a href="https://github.com/goharbor/harbor/issues/9174" target="_blank" rel="noopener">issue 9174</a>以及<a href="https://github.com/goharbor/harbor/issues/9146" target="_blank" rel="noopener">issue 9146</a>：<br>发现很多人都报了这个错误，原因时由于 1.7.x 版本的 harbar.cfg 中不存在下面的相关的配置（在1.8版本开始在模板中使用了chart，且为必须项Required Parameters for Harbor Deployment）：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">chart:</span></span><br><span class="line"><span class="attr">  absolute_url:</span> <span class="string">disabled</span></span><br></pre></td></tr></table></figure><p>解决方案有两个：<br>（1）先升级到1.8.x版本，并在harbor.yml中加入上述chart配置。<br>（2）替换官方的migrator镜像为issue中大神thatsk提供的镜像。<br><img src="/passages/学习杂记之harbor实践篇2/5.png"><br>为了避免麻烦，我直接选择方案二，替换掉官方的同步迁移镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# docker pull thatsk/harbor-migrator:v1.9.0</span><br><span class="line">[root@bogon harbor]# docker run -it --rm -v /home/lanjian/harbor1.7.0-bak/harbor/harbor.cfg:/harbor-migration/harbor-cfg/harbor.yml -v /home/lanjian/harbor/harbor.yml:/harbor-migration/harbor-cfg-out/harbor.yml docker.io/thatsk/harbor-migrator:v1.9.0 --cfg up                        </span><br><span class="line">Please backup before upgrade, </span><br><span class="line">Enter y to continue updating or n to abort: y</span><br><span class="line">Command for config file migration: python ./cfg/run.py --input /harbor-migration/harbor-cfg/harbor.yml --output /harbor-migration/harbor-cfg-out/harbor.yml</span><br><span class="line">input version: 1.7.0, migrator chain: ['1.8.0', '1.9.0']</span><br><span class="line">migrating to version 1.8.0</span><br><span class="line">migrating to version 1.9.0</span><br><span class="line">Written new values to /harbor-migration/harbor-cfg-out/harbor.yml</span><br></pre></td></tr></table></figure><p>升级成功</p><h6 id="（5）启动harbor并检查UI"><a href="#（5）启动harbor并检查UI" class="headerlink" title="（5）启动harbor并检查UI"></a>（5）启动harbor并检查UI</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# ./install.sh --with-clair</span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line">✖ Need to upgrade docker package to 17.06.0+.</span><br><span class="line">[root@bogon harbor]# docker --version</span><br><span class="line">Docker version 1.13.1, build b2f74b2/1.13.1</span><br></pre></td></tr></table></figure><p>提示docker版本太低，需要升级，那么就升吧，步骤：<br>先停止docker，删除旧版本，然后安装yum管理工具，然后添加国内镜像源，查看版本，安装指定的docker版本以及docker-compose版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon bin]# systemctl stop docker</span><br><span class="line">[root@bogon bin]# rpm -qa | grep docker</span><br><span class="line">docker-1.13.1-94.gitb2f74b2.el7.centos.x86_64</span><br><span class="line">docker-client-1.13.1-94.gitb2f74b2.el7.centos.x86_64</span><br><span class="line">docker-common-1.13.1-94.gitb2f74b2.el7.centos.x86_64</span><br><span class="line">[root@bogon bin]# yum remove docker-common-1.13.1-94.gitb2f74b2.el7.centos.x86_64</span><br><span class="line"></span><br><span class="line">[root@bogon bin]# yum install -y yum-utils</span><br><span class="line">[root@bogon bin]# yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">adding repo from: https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">grabbing file https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">repo saved to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">[root@bogon bin]# yum list docker-ce --showduplicates|sort -r</span><br><span class="line">已加载插件：fastestmirror, langpacks</span><br><span class="line">可安装的软件包</span><br><span class="line"> * updates: mirrors.neusoft.edu.cn</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * extras: mirrors.neusoft.edu.cn</span><br><span class="line"> * epel: mirror.lzu.edu.cn</span><br><span class="line">docker-ce.x86_64            3:19.03.5-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.4-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.3-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.2-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.0-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.9-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.8-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.7-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.6-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.5-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.4-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.3-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.2-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.0-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.3.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.2.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.1.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.0.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.12.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.12.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.09.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.09.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.2.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.3.ce-1.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.2.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line"> * base: mirrors.nju.edu.cn</span><br><span class="line">[root@bogon bin]# yum install docker-ce.x86_64.18.03.0.ce-1.el7.centos</span><br><span class="line">[root@bogon bin]# systemctl start docker</span><br><span class="line">[root@bogon bin]# systemctl enable docker</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br><span class="line">[root@bogon bin]# docker version</span><br><span class="line">Client:</span><br><span class="line"> Version:       18.03.0-ce</span><br><span class="line"> API version:   1.37</span><br><span class="line"> Go version:    go1.9.4</span><br><span class="line"> Git commit:    0520e24</span><br><span class="line"> Built: Wed Mar 21 23:09:15 2018</span><br><span class="line"> OS/Arch:       linux/amd64</span><br><span class="line"> Experimental:  false</span><br><span class="line"> Orchestrator:  swarm</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line"> Engine:</span><br><span class="line">  Version:      18.03.0-ce</span><br><span class="line">  API version:  1.37 (minimum version 1.12)</span><br><span class="line">  Go version:   go1.9.4</span><br><span class="line">  Git commit:   0520e24</span><br><span class="line">  Built:        Wed Mar 21 23:13:03 2018</span><br><span class="line">  OS/Arch:      linux/amd64</span><br><span class="line">  Experimental: false</span><br></pre></td></tr></table></figure><p>PS：这里又趟坑了，在yum-config-manager时报错：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">File "/bin/yum-config-manager", line 135</span><br><span class="line">    except yum.Errors.RepoError, e:</span><br><span class="line">                               ^</span><br><span class="line">SyntaxError: invalid syntax</span><br></pre></td></tr></table></figure><p>这时python升级为3.x后的问题，yum-config-manager还是用Python2写的，所以我们需要替换掉这个文件的Python版本：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon bin]# head -n 1 /bin/yum-config-manager</span><br><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/python -tt</span></span><br><span class="line">[root@bogon bin]# ll /usr/bin/ |grep -i pytho</span><br><span class="line">-rwxr-xr-x.   1 root root       11312 11月 14 2018 abrt-action-analyze-python</span><br><span class="line">lrwxrwxrwx    1 root root          16 9月  29 23:10 python -&gt; /usr/bin/python3</span><br><span class="line">lrwxrwxrwx    1 root root           9 4月  27 2019 python2 -&gt; python2.7</span><br><span class="line">-rwxr-xr-x    1 root root        7216 4月   9 2019 python2.7</span><br><span class="line">lrwxrwxrwx.   1 root root          24 3月   4 2019 python3 -&gt; /usr/local/bin/python3.6</span><br><span class="line">lrwxrwxrwx    1 root root          24 3月  14 2019 python_backup_20190314 -&gt; /etc/alternatives/python</span><br><span class="line">lrwxrwxrwx.   1 root root           7 3月   3 2019 python_old -&gt; python2</span><br><span class="line">[root@bogon bin]# vim /bin/yum-config-manager</span><br><span class="line">[root@bogon bin]# head -n 1 /bin/yum-config-manager</span><br><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/python2 -tt</span></span><br></pre></td></tr></table></figure><p>继续升级docker-compose，这个简单些，可以通过pip安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# rm /usr/local/bin/docker-compose</span><br><span class="line">[root@bogon harbor]# pip install docker-compose==1.18.0</span><br><span class="line">[root@bogon harbor]# docker-compose version</span><br><span class="line">docker-compose version 1.18.0, build 8dd22a9</span><br><span class="line">docker-py version: 2.7.0</span><br><span class="line">CPython version: 3.6.0</span><br><span class="line">OpenSSL version: OpenSSL 1.0.2k-fips  26 Jan 2017</span><br></pre></td></tr></table></figure><p>好了，我们终于可以继续启动harbor了：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bogon harbor]# ./install.sh --with-clair  </span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://192.168.137.7. </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure><p>完成，检查下UI、镜像和log，升级成功！经历了那么多版本，终于完成了，奈斯！</p><img src="/passages/学习杂记之harbor实践篇2/1.png">]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Helm3学习</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BHelm3%E5%AD%A6%E4%B9%A0/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BHelm3%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="Helm3私有仓库搭建"><a href="#Helm3私有仓库搭建" class="headerlink" title="Helm3私有仓库搭建"></a>Helm3私有仓库搭建</h2><h3 id="1、运行web容器作为私有仓库"><a href="#1、运行web容器作为私有仓库" class="headerlink" title="1、运行web容器作为私有仓库"></a>1、运行web容器作为私有仓库<a id="more"></a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#运行web容器</span><br><span class="line">[root@node01 ~]# docker run -d -p 9999:80 -v /var/www:/usr/local/apache2/htdocs httpd</span><br><span class="line">#创建目录，用于存放charts包</span><br><span class="line">[root@node01 ~]# mkdir -p /var/www/charts</span><br></pre></td></tr></table></figure><h3 id="2、通过helm-package将tesetchart打包"><a href="#2、通过helm-package将tesetchart打包" class="headerlink" title="2、通过helm package将tesetchart打包"></a>2、通过helm package将tesetchart打包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# helm create testchart      #创建testechart</span><br><span class="line">[root@master ~]# helm package testchart    #进行打包</span><br><span class="line">#执行打包操作后，会在当前目录下生成一个名为testchart-0.1.0.tgz的包</span><br></pre></td></tr></table></figure><h3 id="3、执行helm-repo-index生成库的index文件"><a href="#3、执行helm-repo-index生成库的index文件" class="headerlink" title="3、执行helm repo index生成库的index文件"></a>3、执行helm repo index生成库的index文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mkdir myrepo</span><br><span class="line">[root@master ~]# mv testchart-0.1.0.tgz myrepo/</span><br><span class="line">[root@master ~]# helm repo index myrepo/ --url http://192.168.20.3:81/charts</span><br><span class="line">#上述的url是第一步所运行的httpd镜像所在的节点IP+端口</span><br><span class="line">[root@master ~]# ls myrepo/      #确定index.yaml文件已生成</span><br><span class="line">index.yaml  testchart-0.1.0.tgz</span><br></pre></td></tr></table></figure><h3 id="4、将生成的index-yaml文件及charts包复制到httpd容器所在节点映射到本地的目录"><a href="#4、将生成的index-yaml文件及charts包复制到httpd容器所在节点映射到本地的目录" class="headerlink" title="4、将生成的index.yaml文件及charts包复制到httpd容器所在节点映射到本地的目录"></a>4、将生成的index.yaml文件及charts包复制到httpd容器所在节点映射到本地的目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd myrepo/</span><br><span class="line">[root@master myrepo]# scp index.yaml testchart-0.1.0.tgz node01:/var/www/charts</span><br></pre></td></tr></table></figure><h3 id="5、通过helm-repo-add-将新仓库添加到helm"><a href="#5、通过helm-repo-add-将新仓库添加到helm" class="headerlink" title="5、通过helm repo add 将新仓库添加到helm"></a>5、通过helm repo add 将新仓库添加到helm</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#下面的URL是web容器的URL</span><br><span class="line">[root@master myrepo]# helm repo add newrepo http://192.168.20.3:81/charts</span><br><span class="line">[root@master myrepo]# helm repo list   #确认返回的列表有新添加的仓库</span><br></pre></td></tr></table></figure><p>其实，配置至此，已经可以正常供内网环境使用这个charts包的私有仓库了，下面是一些验证。</p><h3 id="6、搜索复制到node01上的charts包"><a href="#6、搜索复制到node01上的charts包" class="headerlink" title="6、搜索复制到node01上的charts包"></a>6、搜索复制到node01上的charts包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#搜索testchart（使用scp复制到node01的包）</span><br><span class="line">[root@master myrepo]# helm search testchart     </span><br><span class="line">NAME                CHART VERSION   APP VERSION DESCRIPTION                </span><br><span class="line">local/testchart     0.1.0           1.0         A Helm chart for Kubernetes</span><br><span class="line">newrepo/testchart   0.1.0           1.0         A Helm chart for Kubernetes</span><br><span class="line">#可以看到返回的结果有新创建的库下对应的包“newrepo/testchart”</span><br><span class="line">#此时的搜索结果和本地没有关系，因为这个包是从web容器中搜索到的，可以将本地的包删除再进行搜索测试</span><br><span class="line">[root@master myrepo]# ls</span><br><span class="line">index.yaml  testchart-0.1.0.tgz</span><br><span class="line">[root@master myrepo]# rm -rf *</span><br><span class="line">[root@master myrepo]# helm search testchart</span><br><span class="line">#还是可以看到私有仓库中的包的</span><br></pre></td></tr></table></figure><h3 id="7、从新的私有库中安装testchart进行测试"><a href="#7、从新的私有库中安装testchart进行测试" class="headerlink" title="7、从新的私有库中安装testchart进行测试"></a>7、从新的私有库中安装testchart进行测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#可以像使用共有库一样使用这个私有库了</span><br><span class="line">[root@master myrepo]# helm install newrepo/testchart -n my-nginx</span><br></pre></td></tr></table></figure><h3 id="8、更新charts包所运行服务的镜像"><a href="#8、更新charts包所运行服务的镜像" class="headerlink" title="8、更新charts包所运行服务的镜像"></a>8、更新charts包所运行服务的镜像</h3><p>其实就是一个服务版本升级的操作，大概思路如下：修改解压后的charts包目录下的values.yaml文件为所需的值（values.yaml文件包含的是这个服务的值，可以在里面指定镜像及标签、数据持久化的类型等等），修改完成后，再使用下面的命令进行升级操作。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# helm upgrade -f sunqiuming-chart/values.yaml my-nginx newrepo/testchart</span><br><span class="line">#my-nginx是之前实例的名称，可以通过“helm list”查看实例名称</span><br><span class="line">#newrepo/testchart ：为自定义仓库中的chart包</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Helm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Jenkins系列</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BJenkins%E7%B3%BB%E5%88%97/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BJenkins%E7%B3%BB%E5%88%97/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Jenkins系列2</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BJenkins%E7%B3%BB%E5%88%972/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BJenkins%E7%B3%BB%E5%88%972/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Jenkins </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之keepalive概念</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bkeepalive%E6%A6%82%E5%BF%B5/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bkeepalive%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Keepalive </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之keepalive概念2</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bkeepalive%E6%A6%82%E5%BF%B52/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bkeepalive%E6%A6%82%E5%BF%B52/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Keepalive </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之keepalive概念3</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bkeepalive%E6%A6%82%E5%BF%B53/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8Bkeepalive%E6%A6%82%E5%BF%B53/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Keepalive </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Prometheus命令篇</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BPrometheus%E5%91%BD%E4%BB%A4%E7%AF%87/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BPrometheus%E5%91%BD%E4%BB%A4%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="PromQL-常用命令"><a href="#PromQL-常用命令" class="headerlink" title="PromQL 常用命令"></a>PromQL 常用命令</h2><h2 id="PromQL-用途"><a href="#PromQL-用途" class="headerlink" title="PromQL 用途"></a>PromQL 用途</h2><blockquote><p>PromQL 可以非常方便的对监控样本数据进行统计分析，PromQL 支持常见运算符和一些内置的函数，监控告警也是依赖PromQL实现的。</p></blockquote><h2 id="时间序列"><a href="#时间序列" class="headerlink" title="时间序列"></a>时间序列<a id="more"></a></h2><p>在时间序列中，每一个点称之为样本，每个样本由三部分组成：</p><ul><li>指标：由指标名称和描述指标的级别组成的。</li><li>时间戳：一个精确到毫秒级别的时间戳</li><li>值：一个<code>float64</code>位的值</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;--------------- metric=&quot;&quot; ---------------------=&quot;&quot;&gt;&lt;-timestamp -=&quot;&quot;&gt;&lt;-value-&gt;</span><br><span class="line"></span><br><span class="line">http_request_total&#123;status=”200”, method=”GET”&#125;@1434417560938 =&gt; 94355</span><br></pre></td></tr></table></figure><h3 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h3><p>形式上所有的指标都是由如下的格式标示：</p><blockquote><p>{=, …}</p></blockquote><p>在<code>Prometheus</code>的底层实现中指标名称实际上是以<code>__name__=</code>的形式保存在数据库中的。</p><blockquote><p>api_http_requests_total{method=”POST”, handler=”/messages”}</p></blockquote><p>等价于</p><blockquote><p>{name=”api_http_requests_total”，method=”POST”, handler=”/messages”}</p></blockquote><p>所以底层存储的是<code>map[string]string</code>.如下是<code>Promtheus</code>中的<code>Metric</code>的源码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Metric LabelSet</span><br><span class="line"></span><br><span class="line">type LabelSet map[LabelName]LabelValue</span><br><span class="line"></span><br><span class="line">type LabelName string</span><br><span class="line"></span><br><span class="line">type LabelValue string</span><br></pre></td></tr></table></figure><h3 id="Metric-类型"><a href="#Metric-类型" class="headerlink" title="Metric 类型"></a>Metric 类型</h3><blockquote><p>每一种指标标示的意义都不一样，因此对应的类型不一样，比如系统负载是随着时间变化而变化的值，cpu使用时间是一个一直递增的值，只要系统不重启。</p></blockquote><ul><li>Counter：只增不减的计数器</li><li>Gauge：可增可减的仪表盘</li><li>Histogram和Summary分析数据分布情况</li></ul><h2 id="初识-PromQL"><a href="#初识-PromQL" class="headerlink" title="初识 PromQL"></a>初识 PromQL</h2><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><ul><li><p>等于：<code>http_requests_total{instance=&quot;localhost:9090&quot;}</code></p></li><li><p>不等于：<code>http_requests_total{instance!=&quot;localhost:9090&quot;}</code></p></li><li><p>匹配：<code>http_requests_total{environment=~&quot;staging|testing|development&quot;,method!=&quot;GET&quot;}</code> 多个值用<code>|</code>连接。</p></li><li><p>排除：<code>http_requests_total{environment!~&quot;staging|testing|development&quot;,method!=&quot;GET&quot;}</code>不存在这几个值之间。</p></li><li><p>范围查询：<code>http_request_total{}[5m] 5m</code>以内的数据，这叫区间数据，还有瞬时数据，只返回最近的一条<code>http_request_total{}</code>。还支持如下的时间范围查询。</p></li><li><ul><li>s - 秒</li><li>m - 分钟</li><li>h - 小时</li><li>d - 天</li><li>w - 周</li><li>y - 年</li></ul></li><li><p>时间位移：选择一个参考点，上面的范围查询都是使用的是当前的时间值，位移操作的关键字为<code>offset</code></p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http_request_total&#123;&#125; offset 5m</span><br><span class="line">http_request_total&#123;&#125;[1d] offset 1d</span><br></pre></td></tr></table></figure><ul><li><p>聚合操作：</p></li><li><ul><li><code>sum</code>函数：对指标进行求和，如：<code>sum(http_request_total)</code></li><li><code>avg</code>函数：对指标进行求平均值。</li></ul></li></ul><h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><h3 id="运算符-1"><a href="#运算符-1" class="headerlink" title="运算符"></a>运算符</h3><ul><li><code>+</code> (加法)</li><li><code>-</code> (减法)</li><li><code>*</code> (乘法)</li><li><code>/</code> (除法)</li><li><code>%</code> (求余)</li><li><code>^</code> (幂运算)</li></ul><p>当瞬时向量与标量之间进行数学运算时，数学运算符会依次作用域瞬时向量中的每一个样本值，从而得到一组新的时间序列。如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node_memory_free_bytes_total / (1024 * 1024)</span><br></pre></td></tr></table></figure><p>如果是瞬时向量与瞬时向量之间进行数学运算时，左边向量元素匹配（标签完全一致）右边向量元素，如果没找到匹配元素，则直接抛弃。如下两个指标进行相加操作，唯一不同的就是值，连时间戳都是一样的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;device=&quot;sda&quot;,instance=&quot;localhost:9100&quot;,job=&quot;node_exporter&quot;&#125;=&gt;1634967552@1518146427.807 + 864551424@1518146427.807</span><br><span class="line"></span><br><span class="line">&#123;device=&quot;sdb&quot;,instance=&quot;localhost:9100&quot;,job=&quot;node_exporter&quot;&#125;=&gt;0@1518146427.807 + 1744384@1518146427.807</span><br></pre></td></tr></table></figure><h3 id="布尔运算"><a href="#布尔运算" class="headerlink" title="布尔运算"></a>布尔运算</h3><p>瞬时向量与标量进行布尔运算时，<code>PromQL</code>依次比较向量中的所有时间序列样本的值，如果比较结果为<code>true</code>则保留，反之丢弃。</p><ul><li><code>==</code> (相等)</li><li><code>!=</code> (不相等)</li><li><code>&gt;</code> (大于)</li><li><code>&lt;</code> (小于)</li><li><code>&gt;=</code> (大于等于)</li><li><code>&lt;=</code> (小于等于)</li></ul><h3 id="bool-修饰符"><a href="#bool-修饰符" class="headerlink" title="bool 修饰符"></a>bool 修饰符</h3><p><code>bool</code>修饰符，使用<code>bool</code>修改符后，布尔运算不会对时间序列进行过滤，而是直接依次瞬时向量中的各个样本数据与标量的比较结果<code>0</code>或者<code>1</code>。从而形成一条新的时间序列.和上面的图进行对比。</p><h3 id="集合运行"><a href="#集合运行" class="headerlink" title="集合运行"></a>集合运行</h3><ul><li><code>and</code> (并且)</li><li><code>or</code> (或者)</li><li><code>unless</code> (排除)</li></ul><p><code>vector1 and vector2</code> 会产生一个由vector1的元素组成的新的向量。该向量包含vector1中完全匹配vector2中的元素组成。</p><p><code>vector1 or vector2</code> 会产生一个新的向量，该向量包含vector1中所有的样本数据，以及vector2中没有与vector1匹配到的样本数据。</p><p><code>vector1 unless vector2</code> 会产生一个新的向量，新向量中的元素由vector1中没有与vector2匹配的元素组成。</p><h3 id="操作符优先级"><a href="#操作符优先级" class="headerlink" title="操作符优先级"></a>操作符优先级</h3><p>如下计算每个实例上每个核心cpu的使用率:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">100 * (1-avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by (instance,cpu))</span><br></pre></td></tr></table></figure><p>在PromQL操作符中优先级由高到低依次为：</p><ul><li><code>^</code></li><li><code>*, /, %</code></li><li><code>+, -</code></li><li><code>==, !=, &lt;=, &lt;, &gt;=, &gt;</code></li><li><code>and, unless</code></li><li><code>or</code></li></ul><h3 id="向量匹配模式详解"><a href="#向量匹配模式详解" class="headerlink" title="向量匹配模式详解"></a>向量匹配模式详解</h3><p>向量与向量之间运算时会基于默认的匹配规则，依次找到右边边向量元素和左边向量元素匹配(标签完全一致)的进行运算，不匹配则丢弃。在<code>PromQL</code>中有两种典型的匹配模式。</p><h4 id="一对一（one-to-one）"><a href="#一对一（one-to-one）" class="headerlink" title="一对一（one to one）"></a>一对一（one to one）</h4><p>一对一匹配模式会从操作符两边获取瞬时向量依次比较并找到唯一匹配的样本值，使用的表达式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vector1 &lt;operator&gt; vector2</span><br></pre></td></tr></table></figure><p>在操作符两边表达式标签不一致的情况下，可以使用<code>on(label list)</code>或者<code>ignoring(label list）</code>来修改便签的匹配行为。使用<code>ignoreing</code>可以在匹配时忽略某些便签。而<code>on</code>则用于将匹配行为限定在某些便签之内。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure><p>例如当存在样本：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  24</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  30</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;put&quot;, code=&quot;501&quot;&#125;  3</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 6</span><br><span class="line">method_code:http_errors:rate5m&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 21</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;get&quot;&#125;  600</span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;del&quot;&#125;  34</span><br><span class="line">method:http_requests:rate5m&#123;method=&quot;post&quot;&#125; 120</span><br></pre></td></tr></table></figure><p>使用PromQL表达式：使用了<code>ignoring</code>之后忽略了第一组向量的<code>code</code>标签，这样就和第二组向量拥有一样的标签了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m&#123;code=&quot;500&quot;&#125; / ignoring(code) method:http_requests:rate5m</span><br></pre></td></tr></table></figure><p>该表达式会返回在过去5分钟内，HTTP请求状态码为500的在所有请求中的比例。如果没有使用<code>ignoring(code)</code>，操作符两边表达式返回的瞬时向量中将找不到任何一个标签完全相同的匹配项。</p><p>因此结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;method=&quot;get&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;post&quot;&#125; 0.05            //   6 / 120</span><br></pre></td></tr></table></figure><p>同时由于<code>method</code>为<code>put</code>和<code>del</code>的样本找不到匹配项，因此不会出现在结果当中。</p><h4 id="多对一和一对多"><a href="#多对一和一对多" class="headerlink" title="多对一和一对多"></a>多对一和一对多</h4><p>多对一和一对多两种匹配模式指的是“一”侧的每一个向量元素可以与”多”侧的多个元素匹配的情况。在这种情况下，必须使用<code>group</code>修饰符：<code>group_left</code>或者<code>group_right</code>来确定哪一个向量具有更高的基数（充当“多”的角色）。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; ignoring(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_left(&lt;label list&gt;) &lt;vector expr&gt;</span><br><span class="line">&lt;vector expr&gt; &lt;bin-op&gt; on(&lt;label list&gt;) group_right(&lt;label list&gt;) &lt;vector expr&gt;</span><br></pre></td></tr></table></figure><p>多对一和一对多两种模式一定是出现在操作符两侧表达式返回的向量标签不一致的情况。因此需要使用<code>ignoring</code>和<code>on</code>修饰符来排除或者限定匹配的标签列表。</p><p>例如,使用表达式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">method_code:http_errors:rate5m / ignoring(code) group_left method:http_requests:rate5m</span><br></pre></td></tr></table></figure><p>该表达式中，左向量<code>method_code:http_errors:rate5m</code>包含两个标签<code>method</code>和<code>code</code>。而右向量<code>method:http_requests:rate5m</code>中只包含一个标签<code>method</code>，因此匹配时需要使用<code>ignoring</code>限定匹配的标签为<code>code</code>。在限定匹配标签后，右向量中的元素可能匹配到多个左向量中的元素 因此该表达式的匹配模式为多对一，需要使用<code>group</code>修饰符<code>group_left</code>指定左向量具有更好的基数。</p><p>最终的运算结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;method=&quot;get&quot;, code=&quot;500&quot;&#125;  0.04            //  24 / 600</span><br><span class="line">&#123;method=&quot;get&quot;, code=&quot;404&quot;&#125;  0.05            //  30 / 600</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;500&quot;&#125; 0.05            //   6 / 120</span><br><span class="line">&#123;method=&quot;post&quot;, code=&quot;404&quot;&#125; 0.175           //  21 / 120</span><br></pre></td></tr></table></figure><blockquote><p>提醒：<code>group</code>修饰符只能在比较和数学运算符中使用。在逻辑运算<code>and</code>,<code>unless</code>和<code>or</code>中默认与右向量中的所有元素进行匹配。</p></blockquote><h2 id="聚合操作"><a href="#聚合操作" class="headerlink" title="聚合操作"></a>聚合操作</h2><p><code>Prometheus</code>提供了一些内置的聚合操作符，这些操作符只能作用于瞬时向量，可以将瞬时表达式返回的样本数据进行聚合，形成一个新的时间序列。内置的聚合函数如下：</p><ul><li><code>sum</code> (求和)</li><li><code>min</code> (最小值)</li><li><code>max</code> (最大值)</li><li><code>avg</code> (平均值)</li><li><code>stddev</code> (标准差)</li><li><code>stdvar</code> (标准差异)</li><li><code>count</code> (计数)</li><li><code>count_values</code> (对value进行计数)</li><li><code>bottomk</code> (后n条时序)</li><li><code>topk</code> (前n条时序)</li><li><code>quantile</code> (分布统计)</li></ul><p>使用聚合操作的语法如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;aggr-op&gt;([parameter,] &lt;vector expression&gt;) [without|by (&lt;label list&gt;)]</span><br></pre></td></tr></table></figure><p>其中只有<code>count_values</code>, <code>quantile</code>, <code>topk</code>, <code>bottomk</code>支持参数(parameter)。<code>aggr-op</code>就是上面的聚合函数。</p><p><code>without</code>用于移除计算结果中的标签,<code>by</code>则相反，只保留此标签。通过<code>without</code>和<code>by</code>可以按照样本的问题对数据进行聚合。</p><h2 id="PromQL-内置函数"><a href="#PromQL-内置函数" class="headerlink" title="PromQL 内置函数"></a>PromQL 内置函数</h2><h3 id="计算Counter类型的指标增长率"><a href="#计算Counter类型的指标增长率" class="headerlink" title="计算Counter类型的指标增长率"></a>计算<code>Counter</code>类型的指标增长率</h3><ul><li><p><code>increase(v range-vector)</code>函数：获取区间向量的增长量</p></li><li><p><code>rate(v range-vector)</code>函数：rate函数可以直接计算区间向量v在时间窗口内平均增长速率</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rate(node_cpu[2m])</span><br><span class="line">increase(node_cpu[2m]) / 120</span><br><span class="line">上面的两个计算结果是一致的，increase(node_cpu[2m])获取的是两分钟之内的增长量，除以120s之后得到的就是两分钟之间的平均增长率。</span><br></pre></td></tr></table></figure></li><li><p><code>irate(v range-vector)</code>函数：<code>irate</code>函数是通过区间向量中最后两个两本数据来计算区间向量的增长速率,计算的是一个瞬时增长速率。</p></li></ul><h3 id="预测Gauge指标变化趋势"><a href="#预测Gauge指标变化趋势" class="headerlink" title="预测Gauge指标变化趋势"></a>预测Gauge指标变化趋势</h3><ul><li><code>predict_linear(v range-vector, t scalar)</code>函数：基于简单的线性回归的方式进行<code>t</code>秒后的<code>v</code>值的预测。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Offer面试题的一些</title>
      <link href="/passages/Offer%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9A%84%E4%B8%80%E4%BA%9B/"/>
      <url>/passages/Offer%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9A%84%E4%B8%80%E4%BA%9B/</url>
      
        <content type="html"><![CDATA[<h2 id="问题汇总"><a href="#问题汇总" class="headerlink" title="问题汇总"></a>问题汇总</h2><p>接下来，就总结一下，我在当初面试时，被问到的一些常见问题。</p><p>问题总共可分为七类：数学题、计算机基础、数据结构、机器学习相关、深度学习相关、项目相关、业务场景。</p><p>项目相关的问题，根据每个人的项目经历而不同，这个需要自行准备了，根据实际情况阐述。</p><p>本文主要记录另外六类问题。<a id="more"></a></p><h3 id="数学题"><a href="#数学题" class="headerlink" title="数学题"></a>数学题</h3><p>面试的时候偶尔会被问道数学题，这里也值得准备一下，特别是算法岗。</p><p>面试的题型完全看面试官的风格，比如问问泰勒展开、偏导啥的，还有一些五花八门的小智力题。</p><p>不过这类考点，考得并不多，十场面试，可能就碰到一场问数学题的。</p><h3 id="计算机基础"><a href="#计算机基础" class="headerlink" title="计算机基础"></a>计算机基础</h3><p>计算机基础属于常考内容。一般都会问一些 linux 基础，比如常用 linux 指令，平时经常用 linux 的话，这个问题不大。</p><p>如果没有这方面基础的，就需要提前学一学了。</p><p>此外，还会问一下关于你熟悉的计算机语言的基础知识，比如我说我更熟悉 python ，那么面试官可能就会问一些关于 python 基础的问题。</p><p>常考问题如下：</p><p>1) 进程和线程的区别？</p><p>答：进程拥有一个完整的虚拟地址空间，不依赖于线程而独立存在；反之，线程是进程的一部分，没有自己的地址空间，与进程内的其他线程一起共享分配给该进程的所有资源。</p><p>比如：开个 QQ，开了一个进程；开了迅雷，开了一个进程。在 QQ 的这个进程里，传输文字开一个线程、传输语音开了一个线程、弹出对话框又开了一个线程。所以运行某个软件，相当于开了一个进程。在这个软件运行的过程里（在这个进程里），多个工作支撑的完成 QQ 的运行，那么这“多个工作”分别有一个线程。所以一个进程管着多个线程。通俗的讲：“进程是爹妈，管着众多的线程儿子”。</p><p>2) 为什么说 python 的线程是伪线程？</p><p>答：在 python 的原始解释器 CPython 中存在着 <strong>GIL</strong>（Global Interpreter Lock，全局解释器锁），因此在解释执行 python 代码时，会产生互斥锁来限制线程对共享资源的访问，直到解释器遇到 I/O 操作或者操作次数达到一定数目时才会释放 GIL 。</p><p>所以，虽然 CPython 的线程库直接封装了系统的原生线程，但 CPython 整体作为一个进程，同一时间只会有一个线程在跑，其他线程则处于等待状态。这就造成了即使在多核 CPU 中，多线程也只是做着分时切换而已。</p><p>3) python 的 append 和 extend 有什么区别？</p><p>答：extend() 接受一个列表参数，把参数列表的元素添加到列表的尾部，append() 接受一个对象参数，把对象添加到列表的尾部。</p><p>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">b = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">a.append(b)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]]</span><br></pre></td></tr></table></figure><p>而：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">b = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">a.extend(b)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure><p>输出结果为：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br></pre></td></tr></table></figure><p>4) linux 下创建定时任务使用什么指令？</p><p>答：可以使用 crontab 命令。</p><p>5) 数据库 Mysql 和 MongoDB 的区别？</p><p>答：Mysql 是关系型数据库，MongoDB 是文档型数据库。MongoDB 占用空间大，典型的用空间换时间原则的类型。Mysql 相对成熟，MongoDB 较为年轻。</p><p>6) 你知道的加解密算法有哪些？</p><p>答：AES（对称加密）、RSA（非对称加密）、MD5（Hash算法）等。</p><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>个人感觉数据结构最重要，面试五花八门什么题都有，但是唯一统一的，就是数据结构基础。</p><p>不考数据结构的情况也有，但这种情况少之又少。</p><p>数据结构的考法，也各有不同。<strong>有的让说思路，有的让在线写代码。</strong></p><p>所以，复习的方法应该是：<strong>审题-&gt;思考-&gt;表达-&gt;码字。</strong></p><p>首先，认真审题，审题很重要。然后组织语言，把自己所想表达清楚。</p><p>别小看这一步，一些公司面试都是让先说解题思路，再写代码，甚至是只需要说思路。</p><p>已分门别类整理好，有需要的自取。</p><p>地址：<a href="https://cuijiahua.com/blog/2018/02/basis_67.html" target="_blank" rel="noopener">https://cuijiahua.com/blog/2018/02/basis_67.html</a></p><p>下面对一些常见题型进行汇总，这些也是我当初面试时，真实被问到的题目以及相关扩展题。</p><p><strong>链表：</strong></p><p>1) 找出单链表的倒数第K个元素（仅允许遍历一遍链表）</p><p>答：使用指针追赶的方法，定义一个 fast 指针和一个 slow 指针，fast 指针先走 K 步，然后 fast 和slow 同时继续走。当 fast 指针走到链表尾部时，slow 指向的位置就是倒数第 K 个元素。</p><p><strong>注意</strong>：要考虑链表长度应该大于 K 。</p><p>2) 找出单链表的中间元素（仅允许遍历一遍链表）</p><p>答：使用指针追赶的方法，定义一个 fast 指针和一个 slow 指针，两个指针同时走，fast 指针每次走两步，slow 指针每次走一步。当 fast 指针到链表尾部时，slow 指针指向的就是链表的中间元素。</p><p>3) 判断单链表是否有环？</p><p>答：使用指针追赶的方法，定义一个 fast 指针和一个 slow 指针，两个指针同时走，fast 指针每次走两步，slow 指针每次走一步。如果有环，则两者会相遇；如果没有环，fast 指针会遇到 NULL 退出。</p><p>4) 已知单链表有环，如何知道环的长度？</p><p>答：使用指针追赶的方法，定义一个 fast 指针和一个 slow 指针，两个指针同时走，fast 指针每次走两步，slow 指针每次走一步，找到碰撞点。然后使用 slow 指针，从该碰撞点开始遍历，绕着走一起圈，再次回到该点，所走过的结点数就是环的长度。</p><p>5) 如何找到环的入口结点？</p><p>答：先使用题 4 的方法，计算出环的长度。然后重新从头结点开始遍历，定义定义一个 fast 指针和一个 slow 指针，fast 指针先走 l（环的长度）步，然后两个指针以相同的速度在链表上向前移动，直到它们再次相遇，那么这个相遇点即为环的入口结点。</p><p>6) 判断两个无环单链表是否相交？</p><p>答：一旦两个链表相交，那么两个链表从相交节点开始到尾节点一定都是相同的节点。所以，如果他们相交的话，那么他们最后的一个节点一定是相同的，因此分别遍历到两个链表的尾部，然后判断他们是否相同。</p><p>7) 如何知道两个单链表（可能有环）是否相交？</p><p>答：根据两个链表是否有环来分别处理，若相交这个环属于两个链表共有</p><p>（1）如果两个链表都没有环，如题 6 所示方法。</p><p>（2）一个有环，一个没环，肯定不相交。</p><p>（3）两个都有环。在 A 链表上，使用指针追赶的方法，找到两个指针碰撞点，之后判断碰撞点是否在 B 链表上。如果在，则相交。</p><p>8) 寻找两个相交链表的第一个公共结点。</p><p>答：我们也可以先让把长的链表的头砍掉，让两个链表长度相同，这样，同时遍历也能找到公共结点。此时，时间复杂度 O(m+n)，空间复杂度为 O(MAX(m,n)) 。</p><p>9) 反转链表。</p><p>答：我们使用三个指针，分别指向当前遍历到的结点、它的前一个结点以及后一个结点。在遍历的时候，交换当前结点的尾结点和前一个结点的。</p><p><strong>数组：</strong></p><p>1) 给定一个数组（非递减排序），同时给定一个目标数字，找出这个数字在该数组中第一次出现的位置，如果不存在，返回-1。例如[1,3,5,5,5,5,8,9,13,15]，输入5，返回2，输入8，返回6，输入18，返回-1。</p><p>答：使用二分查找法即可。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BinarySearch</span><span class="params">(input_list, end, value)</span>:</span></span><br><span class="line"><span class="keyword">if</span> end == <span class="number">0</span> <span class="keyword">or</span> value &lt; input_list[<span class="number">0</span>] <span class="keyword">or</span> value &gt; input_list[<span class="number">-1</span>]:</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">left = <span class="number">0</span></span><br><span class="line">right = end - <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> left &lt;= right:</span><br><span class="line">middle = left + (right - left) // <span class="number">2</span></span><br><span class="line"><span class="keyword">if</span> input_list[middle] &gt;= value:</span><br><span class="line">right = middle - <span class="number">1</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">left = middle + <span class="number">1</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">return</span> left <span class="keyword">if</span> left &lt; end <span class="keyword">else</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">input_list = [<span class="number">1</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">5</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">13</span>,<span class="number">15</span>]</span><br><span class="line">target = <span class="number">5</span></span><br><span class="line">print(BinarySearch(input_list, len(input_list), target))</span><br></pre></td></tr></table></figure><p>运行结果如下图所示：</p><img src="/passages/Offer面试题的一些/images/life_2_2.png">  <p>2) 给定一个数组，里面有很多数字（乱序），找出其中最大的 4 个数字。</p><p>答：最简单的办法就是先排序再找出最大的四数，这种方法时间复杂度过高。一个更好的方法是使用堆排序，即维护一个存储最大的4个数的最小堆。</p><p>解析：这的思想和代码可以参考《最小的K个数》，这里仅仅做了一个变形。</p><p>3) 给定一个整数的数组 nums，返回相加为 target 的两个数字的索引值。假设每次输入都只有一个答案，并且不会使用同一个元素两次。</p><p>答：<strong>如果这个数组是已经排序的</strong>，可以使用头指针和尾指针，我们可以定义一个头指针 left，一个尾指针 right 。left 指针指向元素值+ right 指针指向元素值的和为 sum，用 sum 和 target 比较。如果sum &gt; target，说明和大了，那么 right 右指针左移一位，然后重新判断。反之，如果 sum &lt; target，说明和小了，那么 left 左指针右移以为，然后会从新判断。直到找到 sum=target 的情况。<strong>如果没有排序</strong>，可以使用使用哈希表，也就是散列表。</p><p>解析：如果没有排序，这道题就是Leetcode中的一道题。</p><p>4) 给定一个字符串，找到最长无重复子字符串。</p><p>答：定义两个变量 longest 和 left ，longest 用于存储最长子字符串的长度，left 存储无重复子串左边的起始位置。然后创建一个哈希表，遍历整个字符串，如果字符串没有在哈希表中出现，说明没有遇到过该字符，则此时计算最长无重复子串，当哈希表中的值小于 left，说明 left 位置更新了，需要重新计算最长无重复子串。每次在哈希表中将当前字符串对应的赋值加 1 。</p><p>解析：Leetcode中的一道题。</p><p><strong>二叉树：</strong></p><p>1) 给定任意一棵二叉树，假设每个结点之间的距离相等，现从任意叶结点，点燃这颗二叉树，假设结点到结点间的燃烧时间均为 1s，问需要多久能烧完整颗二叉树。</p><p>答：二叉树燃烧，需要向父结点遍历。此外，因为是燃烧整颗二叉树，所以结点间应该是扩散式的同时燃烧。因此思路是找到点燃的叶结点到另一个结点的最大距离。</p><p><strong>其他：</strong></p><p>1) 不使用现成的开根号库函数，如何实现开平方根的操作？</p><p>答：可以使用二分查找法或者牛顿法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*-coding:utf-8 -*-</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqrt_binary_search</span><span class="params">(target)</span>:</span></span><br><span class="line">left = <span class="number">0</span></span><br><span class="line">right = target</span><br><span class="line">mid = (left + right) / <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> abs(mid*mid-target) &gt; <span class="number">0.000001</span>:</span><br><span class="line"><span class="keyword">if</span> mid*mid == target:</span><br><span class="line"><span class="keyword">return</span> mid</span><br><span class="line"><span class="keyword">elif</span> mid*mid &gt; target:</span><br><span class="line">right = mid</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">left = mid</span><br><span class="line">mid = (left + right) / <span class="number">2</span></span><br><span class="line"><span class="keyword">return</span> mid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sqrt_newton</span><span class="params">(target)</span>:</span></span><br><span class="line">k = target</span><br><span class="line"><span class="keyword">while</span> abs(k*k-target) &gt; <span class="number">0.000001</span>:</span><br><span class="line">k = <span class="number">0.5</span>*(k+target/k)</span><br><span class="line"><span class="keyword">return</span> k</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">print(<span class="string">"二分查找法:"</span>,sqrt_binary_search(<span class="number">64</span>))</span><br><span class="line">print(<span class="string">"牛顿法:"</span>,sqrt_newton(<span class="number">64</span>))</span><br></pre></td></tr></table></figure><p>运行结果如下图所示：</p><img src="/passages/Offer面试题的一些/images/life_2_1.png">  <p>2) 一个自然序列，从0开始，去掉凡是出现8和9的数，请问去掉后的序列中的第2018个数是多少？</p><p>答：这道题只要理解题意就好了，怎奈我当时紧张，感觉答的不好，其实事后仔细一想还是蛮简单的。例如去掉后的序列为：0，1，2，3，4，5，6，7，10，11，12，13，14，15，16，17，20，21，22，23，24，25，26，27，30，31，32，33，34，35，36，37···。通过数字规律，会发现，其实这个就是10进制转8进制，第9个数是10，第17个数是20，第25个数是30。那么，第2018个数是多少？用除八取余法，得3742。而第2018个数，应该是3742-1=3741。</p><p>3) EXCEL中，列序是有规律的。A，B，C···，Z，接着是AA，AB，···，AZ，再接着是BA，BB，···，BZ。这样一直循环下去，等到有三位的时候就是从AAA开始。请问，第2018个数对应的序列号是多少？</p><p>答：这道题还是进制转换问题，是10进制转26进制。比如第27个数：27除以26为1余1，那么结果就是AA，第53个数：53除以26为2余1，那么结果就是BA。同理，第2018个数：使用除26取余法，得到最终结果为BYP。</p><h3 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h3><p>1) 什么是归一化，归一化的作用是什么？</p><p>答：<strong>归一化</strong>是将数据变为(0,1)之间的小数，主要是为了数据处理方便，把数据映射到0~1范围之内处理，处理起来可以更加便捷快速。<strong>归一化的作用</strong>是把有量纲表达式变为无量纲表达式，归一化是一种简化计算的方式，即将有量纲的表达式，经过变化，化为无量纲的表达式，成为纯量。同时，提高迭代求解的收敛速度，提高迭代求解的精度。</p><p><strong>相应扩展：</strong></p><p>深度学习中的归一化应该怎么理解？</p><p>答：神经网络学习过程的本质是为了学习数据分布，一旦训练数据与测试数据的分布不同，那么网络的泛化能力也大大降低；另一方面，一旦每批训练数据的分布各不相同，那么网络就要在每次迭代都去学习适应不同的分布，这样会大大降低网络的训练速度，这也正是为什么我们需要对数据进行归一化处理的原因。对于深度网络的训练是一个复杂的过程，只要网络的前面几层发生微小的改变，那么后面几层就会被累积放大下去。一旦网络某一层的输入数据的分布发生改变，那么这一层网络就需要去适应学习这个新的数据分布，所以如果训练过程中，训练数据的分布一直在发生变化，那么将会影响网络的训练速度。因此，我们一般会对输入数据进行”白化”除理，使得它的均值是0，方差是1。</p><p>2) 标准化是什么？</p><p>答：数据的标准化是将数据按比例缩放，使之落入一个小的特定区间。由于信用指标体系的各个指标度量单位是不同的，为了能够将指标参与评价计算，需要对指标进行规范化处理，通过函数变化将其数值映射到某个数值区间。</p><p><strong>相应扩展：</strong></p><p>常见的数据归一化方法有哪些？</p><p>答：min-max标准化、z-score标准化等。</p><p>对于数据标准化/归一化的详细内容，可以参见：</p><p><a href="https://blog.csdn.net/pipisorry/article/details/52247379" target="_blank" rel="noopener">https://blog.csdn.net/pipisorry/article/details/52247379</a></p><p>3) 在推导公式的时候，要向量化，这是什么意思？</p><p>答：其实就是将多组数据，放到一个矩阵里，进行矩阵运算。因为如果是一条一条遍历计算参数，需要用到for循环，这样很浪费时间。python的第三方库提供了很好的矩阵计算支持，我们完全可以把多组数据放到一个矩阵里，这样可以实现多组数据同时计算。这个向量化推导，就是根据一条数据计算公式推导出矩阵运算公式，这样可以方便我们写代码。</p><p>4) 在逻辑回归中，我们使用的是sigmoid函数，知道sigmoid函数吧？</p><p>答：知道。</p><p>继续问：那么tanh函数和它有什么区别呢？</p><p>答：它们的值域不同，sigmoid函数将输出映射到0~1的范围内，而tanh函数将输出映射到-1~1的范围内。同时，它们过零点的值也不同，sigmoid函数的过零点的值为0.5，tanh函数过零点的值为0。当我们更偏向于当激活函数的输入是0时，输出也是0的函数时候，就需要使用tanh函数，而非sigmoid函数。</p><p>5) SVM和Logistic的区别？</p><p>答：（1）SVM不是概率输出，Logistic Regression是概率输出。也就是说，当一个新样本来了，SVM只会告诉你它的分类，而Logistic Regression会告诉你它属于某类的概率！（2）异常点的鲁棒性问题。当训练样本中存在异常点时，由于Logistic Regression的lost function中有每一个点的贡献，所以某种程度上“削弱了”异常点的贡献。而SVM只需要考虑支持向量，此时支持向量本来就不是很多的情况下，几个异常点就很有可能极大影响SVM的表现。（3）目标函数不同。Logistic Regression使用cross entropy loss，互熵损失。而SVM使用hinge loss，铰链损失。（4）实际问题中，如果数据量非常大，特征维度很高，使用SVM搞不定时，还是用Logistic Regression吧，速度更快一些。</p><p>6) 常见的损失函数有哪些？</p><ul><li>铰链损失（Hinge Loss）：主要用于支持向量机（SVM） 中；</li><li>互熵损失 （Cross Entropy Loss，Softmax Loss ）：用于Logistic 回归与Softmax 分类中；</li><li>平方损失（Square Loss）：主要是最小二乘法（OLS）中；</li><li>指数损失（Exponential Loss） ：主要用于Adaboost 集成学习算法中；</li><li>其他损失（如0-1损失，绝对值损失）。</li></ul><p>参考链接：<a href="https://blog.csdn.net/u010976453/article/details/78488279" target="_blank" rel="noopener">https://blog.csdn.net/u010976453/article/details/78488279</a></p><p>7) GBDT和XGBOOST的区别有哪些？</p><ul><li>传统GBDT以CART作为基分类器，xgboost还支持线性分类器，这个时候xgboost相当于带L1和L2正则化项的逻辑斯蒂回归（分类问题）或者线性回归（回归问题）。</li><li>传统GBDT在优化时只用到一阶导数信息，xgboost则对代价函数进行了二阶泰勒展开，同时用到了一阶和二阶导数。顺便提一下，xgboost工具支持自定义代价函数，只要函数可一阶和二阶求导。</li><li>xgboost在代价函数里加入了正则项，用于控制模型的复杂度。正则项里包含了树的叶子节点个数、每个叶子节点上输出的score的L2模的平方和。从Bias-variance tradeoff角度来讲，正则项降低了模型的variance，使学习出来的模型更加简单，防止过拟合，这也是xgboost优于传统GBDT的一个特性。</li><li>Shrinkage（缩减），相当于学习速率（xgboost中的eta）。xgboost在进行完一次迭代后，会将叶子节点的权重乘上该系数，主要是为了削弱每棵树的影响，让后面有更大的学习空间。实际应用中，一般把eta设置得小一点，然后迭代次数设置得大一点。（补充：传统GBDT的实现也有学习速率）</li><li><p>列抽样（column subsampling）。xgboost借鉴了随机森林的做法，支持列抽样，不仅能降低过拟合，还能减少计算，这也是xgboost异于传统gbdt的一个特性。</p></li><li><p>对缺失值的处理。对于特征的值有缺失的样本，xgboost可以自动学习出它的分裂方向。</p></li><li><p>xgboost工具支持并行。boosting不是一种串行的结构吗?怎么并行的？注意xgboost的并行不是tree粒度的并行，xgboost也是一次迭代完才能进行下一次迭代的（第t次迭代的代价函数里包含了前面t-1次迭代的预测值）。xgboost的并行是在特征粒度上的。我们知道，决策树的学习最耗时的一个步骤就是对特征的值进行排序（因为要确定最佳分割点），xgboost在训练之前，预先对数据进行了排序，然后保存为block结构，后面的迭代中重复地使用这个结构，大大减小计算量。这个block结构也使得并行成为了可能，在进行节点的分裂时，需要计算每个特征的增益，最终选增益最大的那个特征去做分裂，那么各个特征的增益计算就可以开多线程进行。</p></li><li><p>可并行的近似直方图算法。树节点在进行分裂时，我们需要计算每个特征的每个分割点对应的增益，即用贪心法枚举所有可能的分割点。当数据无法一次载入内存或者在分布式情况下，贪心算法效率就会变得很低，所以xgboost还提出了一种可并行的近似直方图算法，用于高效地生成候选的分割点。</p></li></ul><p>参考自：<a href="https://blog.csdn.net/u010976453/article/details/78488279" target="_blank" rel="noopener">https://www.zhihu.com/question/41354392</a></p><h3 id="深度学习"><a href="#深度学习" class="headerlink" title="深度学习"></a>深度学习</h3><p><strong>目标检测算法相关：</strong></p><p>1) 简述下 YOLO 算法原理？</p><p>答：Yolo算法采用一个单独的CNN模型实现end-to-end的目标检测，模型参考自GoogleNet，YOLO的CNN网络将输入的图片分割成SxS的网络，然后每个单元格负责去检测那些中心点落在该格子内的目标。每个单元格会预测B个边界框（bounding box）以及边界框的置信度（confidence score）。所谓置信度其实包含两个方面，一是这个边界框含有目标的可能性大小，二是这个边界框的准确度，边界框的准确度可以用预测框与实际框（ground truth）的IOU（intersection over union，交并比）来表征。边界框的大小与位置可以用4个值来表征：（x,y,w,h），其中(x,y)是边界框的中心坐标，而(w,h)是边界框的宽与高。还有一点要注意，中心坐标的预测值(x,y)是相对于每个单元格左上角坐标点的偏移值，并且单位是相对于单元格大小的，而(w,h)预测值是相对于整个图片的宽与高的比例。这样，每个边界框的预测值实际上包含5个元素：(x,y,w,h,c)，其中前4个表征边界框的大小与位置，而最后一个值是置信度。每个单元格需要预测 (B<em>5+C) 个值。如果将输入图片划分为 S</em>S 网格，那么最终预测值为 S<em>S</em>(B<em>5+C) 大小的张量。对于PASCAL VOC数据，其共有20个类别，如果使用 S=7,B=2 ，那么最终的预测结果就是 7</em>7*30大小的张量。</p><p>2) 相对于YOLO，YOLO v2有哪些改进？</p><ul><li>首先，将dropout层去掉，在每个卷积层添加了Batch Normalization，mAP提高了2%；</li><li>其次，使用高分辨率分类器，将输入分辨率数据有224<em>224变为448</em>448，mAP提高了4%；</li><li>第三，引入anchor boxes来预测bounding boxes，去掉网络中的全连接层。准确率只有小幅度的下降，而召回率则提升了7%，说明可以通过进一步的工作来加强准确率，的确有改进空间；</li><li>第四，使用维度聚类，本文使用K-means聚类方法训练bounding boxes，可以自行找到更好的boxes宽高维度；同时使用直接位置预测(Direct lacation prediction)，将定位预测值归一化，使参数更容易得到学习，模型更加稳定。作者使用Dimension Clusters和Direct location prediction这两项anchor boxes改进方法，mAP获得了5%的提升。</li><li>第五，增加细粒度特征(Fine-Grained Feature)，是模型获得多尺度的适应性，简单添加了一个转移层（ passthrough layer），这一层要把浅层特征图（分辨率为26 * 26，是底层分辨率4倍）连接到深层特征图。这样做相当于做了一次特征融合，有利于检测小目标。</li><li>最后，多尺度训练(Multi-Scale Training)，方法就是几次迭代之后就会微调网络，每过10次训练（10 epoch），就会随机选择新的图片尺寸。YOLO网络使用的降采样参数为32，那么就使用32的倍数进行尺度池化{320,352，…，608}。最终最小的尺寸为320 <em> 320，最大的尺寸为608 </em> 608。接着按照输入尺寸调整网络进行训练。这种机制使得网络可以更好地预测不同尺寸的图片，意味着同一个网络可以进行不同分辨率的检测任务，在小尺寸图片上YOLOv2运行更快，在速度和精度上达到了平衡。</li></ul><p>3) 深度学习方法与传统机器学习方法的区别是什么？</p><p>答：机器学习包括深度学习，深度学习是使用卷积层<strong>学习特征</strong>，而非像机器学习那样需要人为<strong>提取特征</strong>，深度学习可以自行学习到更深层次的特征。机器学习方法的各个公式有数学理论推导支持，深度学习方法就像一个黑匣子，缺少数学理论支持。</p><p>4) YOLO的损失函数是什么？</p><p>答：YOLO算法将目标检测看成回归问题，采用的是均方差损失函数。公式如下图所示：</p><img src="/passages/Offer面试题的一些/images/life_2_3.jpg">  <h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>种这题目也是常出题目，会给定你一个场景来提问。</p><p>1) 如果给了你很多数据，这些数据已经标注好，即已经做好分类，现在让你训练出一个模型，用于区分新来的数据属于哪一类，你需要怎么做呢？可以说下详细的流程吗？</p><p>答：首先这是一个分类问题，首先应该想到的是可以尝试使用常用的分类算法，例如朴素贝叶斯、决策树或者SVM。拿到数据之后，做的第一件事就是特征工程。然后将数据分类两部分，一部分用于训练，另一部分用于测试，即分为训练集和测试集，不混用。其实，使用什么分类算法倒是其次，重要在于选好特征，对于给定的特征，需要做一些过滤，比如一些干扰数据，如果对于结果影响很大，可以尝试舍弃这些数据。除此之外，看看是否需要对数据进行归一化处理，将数据无量纲化。然后对已经处理好的特征，送入分类算法中，让其学习。最后，可以通过查看测试集的预测准确度，对一些算法必要参数进行优化调试。</p><p>解析：我当时差不多就是这么回答的，只要有的说，让面试官认为你做过相关工作即可。</p><p>2) 如果给你1亿个数据，让你找出其中第 1000 大的数据，你会怎么做？我们先不考虑多进程和多线程，也不考虑数据库，如何在算法方面给出思路呢？</p><p>答：可以使用堆排序，创建一个存储1000个数据的小根堆。先将1亿个数据的前1000个数据放入这个小根堆中，然后继续遍历，对于新插入的数据，需要与小根堆的最小值进行比较，如果待插入的数据比这个最小值还小，那么不插入，如果比这个最小值大，那么就插入该数，并重新调整小根堆，随后继续使用此方法遍历整个数据。遍历一次数据后，就得到了前1000大的数据，然后输出小根堆的最小值，即根值，即可得到第1000大的数据。</p><p>PS：还有一种思路，有就是利用 MapReduce，实际工作中，非常常用的工具。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>本文总结的题目，都是我当初刚参加工作面试遇到的一些常规题目，例如 YOLO 系列算法，现在已经出了 YOLO v3、YOLO v4 ，有新算法就得看，需要跟进最新的进展。</li><li>临阵磨枪，不快也光。面试前，看一看自己的笔记，没准面试的时候正好碰到。</li><li>好好准备，祝在座的各位，人人都是 offer 收割机。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面试 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Offer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker系列之三部曲3</title>
      <link href="/passages/Docker%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E9%83%A8%E6%9B%B23/"/>
      <url>/passages/Docker%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E9%83%A8%E6%9B%B23/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Docker的一些东西 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker系列之三部曲2</title>
      <link href="/passages/Docker%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E9%83%A8%E6%9B%B22/"/>
      <url>/passages/Docker%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E9%83%A8%E6%9B%B22/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-镜像三部曲2"><a href="#Docker-镜像三部曲2" class="headerlink" title="Docker 镜像三部曲2"></a>Docker 镜像三部曲2</h2><p>本系列文章将分为三个部分：<a id="more"></a></p><p>第一部分，因为这是镜像精简之路至关重要的一环。在这部分内容中，我会解释静态链接和动态链接的区别，它们对镜像带来的影响，以及如何避免那些不好的影响。中间会穿插一部分对 Alpine 镜像的介绍。</p><p>第二部分将会针对不同的语言来选择适当的精简策略，其中主要讨论 Go，同时也涉及到了 Java，Node，Python，Ruby 和 Rust。这一部分也会详细介绍 Alpine 镜像的避坑指南。什么？你不知道 Alpine 镜像有哪些坑？我来告诉你。</p><p>第三部分将会探讨适用于大多数语言和框架的通用精简策略，例如使用常见的基础镜像、提取可执行文件和减小每一层的体积。同时还会介绍一些更加奇特或激进的工具，例如 Bazel，Distroless，DockerSlim 和 UPX，虽然这些工具在某些特定场景下能带来奇效，但大多情况下会起到反作用。</p><h3 id="Go-语言镜像精简"><a href="#Go-语言镜像精简" class="headerlink" title="Go 语言镜像精简"></a>Go 语言镜像精简</h3><p>Go 语言程序编译时会将所有必须的依赖编译到二进制文件中，但也不能完全肯定它使用的是静态链接，因为 Go 的某些包是依赖系统标准库的，例如使用到 DNS 解析的包。只要代码中导入了这些包，编译的二进制文件就需要调用到某些系统库，为了这个需求，Go 实现了一种机制叫 cgo，以允许 Go 调用 C 代码，这样编译好的二进制文件就可以调用系统库。</p><p>也就是说，如果 Go 程序使用了 net 包，就会生成一个动态的二进制文件，如果想让镜像能够正常工作，必须将需要的库文件复制到镜像中，或者直接使用 busybox:glibc 镜像。</p><p>当然，你也可以禁止 cgo，这样 Go 就不会使用系统库，使用内置的实现来替代系统库（例如使用内置的 DNS 解析器），这种情况下生成的二进制文件就是静态的。可以通过设置环境变量 CGO_ENABLED=0 来禁用 cgo，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM golang</span><br><span class="line">COPY whatsmyip.go .</span><br><span class="line">ENV CGO_ENABLED=0</span><br><span class="line">RUN go build whatsmyip.go</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=0 /go/whatsmyip .</span><br><span class="line">CMD [&quot;./whatsmyip&quot;]</span><br></pre></td></tr></table></figure><p>由于编译生成的是静态二进制文件，因此可以直接跑在 scratch 镜像中。</p><p>当然，也可以不用完全禁用 cgo，可以通过 -tags 参数指定需要使用的内建库，例如 -tags netgo 就表示使用内建的 net 包，不依赖系统库：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go build -tags netgo whatsmyip.go</span><br></pre></td></tr></table></figure><p>这样指定之后，如果导入的其他包都没有用到系统库，那么编译得到的就是静态二进制文件。也就是说，只要还有一个包用到了系统库，都会开启 cgo，最后得到的就是动态二进制文件。要想一劳永逸，还是设置环境变量 CGO_ENABLED=0 吧。</p><h3 id="Alpine-镜像探秘"><a href="#Alpine-镜像探秘" class="headerlink" title="Alpine 镜像探秘"></a>Alpine 镜像探秘</h3><p><a href="http://mp.weixin.qq.com/s?__biz=MzA5OTAyNzQ2OA==&amp;mid=2649706151&amp;idx=1&amp;sn=52dc3eb0fb6ae29580fcad61ec405a49&amp;chksm=889371c4bfe4f8d239edebfd6814ada68d0c921d27b9b1984cc3388fdeb48b45047c57739d81&amp;scene=21#wechat_redirect" target="_blank" rel="noopener">上篇文章</a>已经对 Alpine 镜像作了简要的介绍，并保证会在后面的文章中花很大的篇幅来讨论 Alpine 镜像，现在时候到了！</p><p>Alpine 是众多 Linux 发行版中的一员，和 CentOS、Ubuntu、Archlinux 之类一样，只是一个发行版的名字，号称小巧安全，有自己的包管理工具 apk。</p><p>与 CentOS 和 Ubuntu 不同，Alpine 并没有像 Red Hat 或 Canonical 之类的大公司为其提供维护支持，软件包的数量也比这些发行版少很多（如果只看开箱即用的默认软件仓库，Alpine 只有 10000 个软件包，而 Ubuntu、Debian 和 Fedora 的软件包数量均大于 50000。）</p><p>容器崛起之前，Alpine 还是个无名之辈，可能是因为大家并不是很关心操作系统本身的大小，毕竟大家只关心业务数据和文档，程序、库文件和系统本身的大小通常可以忽略不计。</p><p>容器技术席卷整个软件产业之后，大家都注意到了一个问题，那就是容器的镜像太大了，浪费磁盘空间，拉取镜像的时间也很长。于是，人们开始寻求适用于容器的更小的镜像。对于那些耳熟能详的发行版（例如 Ubuntu、Debian、Fedora）来说，只能通过删除某些工具（例如 ifconfig 和 netstat）将镜像体积控制在 100M 以下。而对于 Alpine 而言，什么都不用删除，镜像大小也就只有 5M 而已。</p><p>Alpine 镜像的另一个优势是包管理工具的执行速度非常快，安装软件体验非常顺滑。诚然，在传统的虚拟机上不需要太关心软件包的安装速度，同一个包只需要装一次即可，无需不停重复安装。容器就不一样了，你可能会定期构建新镜像，也可能会在运行的容器中临时安装某些调试工具，如果软件包的安装速度很慢，会很快消磨掉我们的耐心。</p><p>为了更直观，我们来做个简单的对比测试，看看不同的发行版安装 tcpdump 需要多长时间，测试命令如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time docker run &lt;image&gt; &lt;packagemanager&gt; install tcpdump</span><br></pre></td></tr></table></figure><p>测试结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Base image           Size      Time to install tcpdump </span><br><span class="line">---------------------------------------------------------</span><br><span class="line">alpine:3.11          5.6 MB      1-2s</span><br><span class="line">archlinux:20200106   409 MB      7-9s</span><br><span class="line">centos:8             237 MB      5-6s</span><br><span class="line">debian:10            114 MB      5-7s</span><br><span class="line">fedora:31            194 MB    35-60s</span><br><span class="line">ubuntu:18.04          64 MB      6-8s</span><br></pre></td></tr></table></figure><p>如果你想了解更多关于 Alpine 的内幕，可以看看 Natanel Copa 的演讲[1]。</p><p>好吧，既然 Alpine 这么棒，为什么不用它作为所有镜像的基础镜像呢？别急，先一步一步来，为了趟平所有的坑，需要分两种情况来考虑：</p><ol><li>使用 Alpine 作为第二构建阶段（run 阶段）的基础镜像</li><li>使用 ALpine 作为所有构建阶段（run 阶段和 build 阶段）的基础镜像</li></ol><p><strong>run 阶段使用 Alpine</strong></p><p>带着激动的心情，将 Alpine 镜像加入了 Dockerfile：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM gcc AS mybuildstage</span><br><span class="line">COPY hello.c .</span><br><span class="line">RUN gcc -o hello hello.c</span><br><span class="line"></span><br><span class="line">FROM alpine</span><br><span class="line">COPY --from=mybuildstage hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>第一个坑来了，启动容器出现了错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">standard_init_linux.go:211: exec user process caused &quot;no such file or directory&quot;</span><br></pre></td></tr></table></figure><p>这个报错在上篇文章已经见识过了，上篇文章的场景是使用 scratch 镜像作为 C 语言程序的基础镜像，错误的原因是 scratch 镜像中缺少动态库文件。可是为什么使用 Alpine 镜像也有报错，难道它也缺少动态库文件？</p><p>也不完全是，Alpine 使用的也是动态库，毕竟它的设计目标之一就是占用更少的空间。但 Alpine 使用的标准库与大多数发行版不同，它使用的是 musl libc，这个库相比于 glibc 更小、更简单、更安全，但是与大家常用的标准库 glibc 并不兼容。</p><p>你可能又要问了：『既然 musl libc 更小、更简单，还特么更安全，为啥其他发行版还在用 glibc？』</p><p>mmm……因为 glibc 有很多额外的扩展，并且很多程序都用到了这些扩展，而 musl libc 是不包含这些扩展的。详情可以参考 musl 的文档[2]。</p><p>也就是说，如果想让程序跑在 Alpine 镜像中，必须在编译时使用 musl libc 作为动态库。</p><p><strong>所有阶段使用 Alpine</strong></p><p>为了生成一个与 musl libc 链接的二进制文件，有两条路：</p><ol><li>某些官方镜像提供了 Alpine 版本，可以直接拿来用。</li><li>还有些官方镜像没有提供 Alpine 版本，我们需要自己构建。</li></ol><p>Golang 镜像就属于第一种情况，golang:alpine 提供了基于 Alpine 构建的 Go 工具链。</p><p>构建 Go 程序可以使用下面的 Dockerfile：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:alpine</span><br><span class="line">COPY hello.go .</span><br><span class="line">RUN go build hello.go</span><br><span class="line"></span><br><span class="line">FROM alpine</span><br><span class="line">COPY --from=0 /go/hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>生成的镜像大小为 7.5M，对于一个只打印 『hello world』的程序来说确实有点大了，但我们可以换个角度：</p><ul><li>即使程序很复杂，生成的镜像也不会很大。</li><li>包含了很多有用的调试工具。</li><li>即使运行时缺少某些特殊的调试工具，也可以迅速安装。</li></ul><p>Go 语言搞定了，C 语言呢？并没有 gcc:alpine 这样的镜像啊。只能以 Alpine 镜像作为基础镜像，自己安装 C 编译器了，Dockerfile 如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine</span><br><span class="line">RUN apk add build-base</span><br><span class="line">COPY hello.c .</span><br><span class="line">RUN gcc -o hello hello.c</span><br><span class="line"></span><br><span class="line">FROM alpine</span><br><span class="line">COPY --from=0 hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>必须安装 build-base，如果安装 gcc，就只有编译器，没有标准库。build-base 相当于 Ubuntu 的 build-essentials，引入了编译器、标准库和 make 之类的工具。</p><p>最后来对比一下不同构建方法得到的 『hello world』镜像大小：</p><ul><li>使用基础镜像 golang 构建：805MB</li><li>多阶段构建，build 阶段使用基础镜像 golang，run 阶段使用基础镜像 ubuntu：66.2MB</li><li>多阶段构建，build 阶段使用基础镜像 golang:alpine，run 阶段使用基础镜像 alpine：7.6MB</li><li>多阶段构建，build 阶段使用基础镜像 golang，run 阶段使用基础镜像 scratch：2MB</li></ul><p>最终镜像体积减少了 99.75%，相当惊人了。再来看一个更实际的例子，上一节提到的使用 net 的程序，最终的镜像大小对比：</p><ul><li>使用基础镜像 golang 构建：810MB</li><li>多阶段构建，build 阶段使用基础镜像 golang，run 阶段使用基础镜像 ubuntu：71.2MB</li><li>多阶段构建，build 阶段使用基础镜像 golang:alpine，run 阶段使用基础镜像 alpine：12.6MB</li><li>多阶段构建，build 阶段使用基础镜像 golang，run 阶段使用基础镜像 busybox:glibc：12.2MB</li><li>多阶段构建，build 阶段使用基础镜像 golang 并使用参数 CGO_ENABLED=0，run 阶段使用基础镜像 ubuntu：7MB</li></ul><p>镜像体积仍然减少了 99%。</p><h3 id="Java-语言镜像精简"><a href="#Java-语言镜像精简" class="headerlink" title="Java 语言镜像精简"></a>Java 语言镜像精简</h3><p>Java 属于编译型语言，但运行时还是要跑在 JVM 中。那么对于 Java 语言来说，该如何使用多阶段构建呢？</p><p><strong>静态还是动态？</strong></p><p>从概念上来看，Java 使用的是动态链接，因为 Java 代码需要调用 JVM 提供的 Java API，这些 API 的代码都在可执行文件之外，通常是 JAR 文件或 WAR 文件。</p><p>然而这些 Java 库并不是完全独立于系统库的，某些 Java 函数最终还是会调用系统库，例如打开文件时需要调用 open(), fopen() 或它们的变体，因此 JVM 本身可能会与系统库动态链接。</p><p>这就意味着理论上可以使用任意的 JVM 来运行 Java 程序，系统标准库是 musl libc 还是 glibc 都无所谓。因此，也就可以使用任意带有 JVM 的基础镜像来构建 Java 程序，也可以使用任意带有 JVM 的镜像作为运行 Java 程序的基础镜像。</p><p><strong>类文件格式</strong></p><p>Java 类文件（Java 编译器生成的字节码）的格式会随着版本而变化，且大部分变化都是 Java API 的变化。还有一部分更改与 Java 语言本身有关，例如 Java 5 中添加了泛型，这种变化就可能会导致类文件格式的变化，从而破坏与旧版本的兼容性。</p><p>所以默认情况下，使用给定版本的 Java 编译器编译的类不能与更早版本的 JVM 兼容，但可以指定编译器的 -target （Java 8 及其以下版本）参数或者 –release （Java 9 及其以上版本）参数来使用较旧的类文件格式。–release 参数还可以指定类文件的路径，以确保程序运行在指定的 JVM 版本中（例如 Java 11），不会意外调用 Java 12 的 API。</p><p><strong>JDK vs JRE</strong></p><p>如果你对大多数平台上的 Java 打包方式很熟悉，那你应该知道 JDK 和 JRE。</p><p>JRE 即 Java 运行时环境（Java Runtime Environment），包含了运行 Java 程序所需要的环境，即 JVM。</p><p>JDK 即 Java 开发工具包（Java Development Kit），既包含了 JRE，也包含了开发 Java 程序所需的工具，即 Java 编译器。</p><p>大多数 Java 镜像都提供了 JDK 和 JRE 两种标签，因此可以在多阶段构建的 build 阶段使用 JDK 作为基础镜像，run 阶段使用 JRE 作为基础镜像。</p><p><strong>Java vs OpenJDK</strong></p><ul><li>推荐使用 OpenJDK，因为开源啊，更新勤快啊~~</li><li>也可以使用 amazoncorretto[3]，这是 Amazon fork OpenJDK 后打了补丁的版本，号称企业级。</li></ul><p><strong>开始构建</strong></p><p>说了那么多，到底该用哪个镜像呢？这里给出几个参考：</p><ul><li>openjdk:8-jre-alpine（85MB）</li><li>openjdk:11-jre（267MB）或者 openjdk:11-jre-slim（204MB）</li><li>openjdk:14-alpine（338MB）</li></ul><p>如果你想要更直观的数据，可以看我的例子，还是搬出屡试不爽的 『hello world』，只不过这次是 Java 版本：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">hello</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello, world!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不同构建方法得到的镜像大小：</p><ul><li>使用基础镜像 java 构建：643MB</li><li>使用基础镜像 openjdk 构建：490MB</li><li>多阶段构建，build 阶段使用基础镜像 openjdk，run 阶段使用基础镜像 openjdk:jre：479MB</li><li>使用基础镜像 amazoncorretto 构建：390MB</li><li>多阶段构建，build 阶段使用基础镜像 openjdk:11，run 阶段使用基础镜像 openjdk:11-jre：267MB</li><li>多阶段构建，build 阶段使用基础镜像 openjdk:8，run 阶段使用基础镜像 openjdk:8-jre-alpine：85MB</li></ul><p>所有的 Dockerfile 都可以在这个仓库[4]找到。</p><h3 id="解释型语言镜像精简"><a href="#解释型语言镜像精简" class="headerlink" title="解释型语言镜像精简"></a>解释型语言镜像精简</h3><p>对于诸如 Node、Python、Rust 之类的解释型语言来说，情况就比较复杂一点了。先来看看 Alpine 镜像。</p><p><strong>Alpine 镜像</strong></p><p>对于解释型语言来说，如果程序仅用到了标准库或者依赖项和程序本身使用的是同一种语言，且无需调用 C 库和外部依赖，那么使用 Alpine 作为基础镜像一般是没有啥问题的。一旦你的程序需要调用外部依赖，情况就复杂了，想继续使用 Alpine 镜像，就得安装这些依赖。根据难度可以划分为三个等级：</p><ul><li>简单：依赖库有针对 Alpine 的安装说明，一般会说明需要安装哪些软件包以及如何建立依赖关系。但这种情况非常罕见，原因前面也提到了，Alpine 的软件包数量比大多数流行的发行版要少得多。</li><li>中等：依赖库没有针对 Alpine 的安装说明，但有针对别的发行版的安装说明。我们可以通过对比找到与别的发行版的软件包相匹配的 Alpine 软件包（假如有的话）。</li><li>困难：依赖库没有针对 Alpine 的安装说明，但有针对别的发行版的安装说明，但是 Alpine 也没有与之对应的软件包。这种情况就必须从源码开始构建！</li></ul><p>最后一种情况最不推荐使用 Alpine 作为基础镜像，不但不能减小体积，可能还会适得其反，因为你需要安装编译器、依赖库、头文件等等……更重要的是，构建时间会很长，效率低下。如果非要考虑多阶段构建，就更复杂了，你得搞清楚如何将所有的依赖编译成二进制文件，想想就头大。因此一般不推荐在解释型语言中使用多阶段构建。</p><p>有一种特殊情况会同时遇到 Alpine 的绝大多数问题：将 Python 用于数据科学。numpy 和 pandas 之类的包都被预编译成了 wheel[5]，wheel 是 Python 新的打包格式，被编译成了二进制，用于替代 Python 传统的 egg 文件，可以通过 pip 直接安装。但这些 wheel 都绑定了特定的 C 库，这就意味着在大多数使用 glibc 的镜像中都可以正常安装，但 Alpine 镜像就不行，原因你懂得，前面已经说过了。如果非要在 Alpine 中安装，你需要安装很多依赖，重头构建，耗时又费力，有一篇文章专门解释了这个问题：使用 Alpine 构建 Pyhton 镜像会将构建速度拖慢 50 倍[6]！</p><p>既然 Alpine 镜像这么坑，那么是不是只要是 Python 写的程序就不推荐使用 Alpine 镜像来构建呢？也不能完全这么肯定，至少 Python 用于数据科学时不推荐使用 Alpine，其他情况还是要具体情况具体分析，如果有可能，还是可以试一试 Alpine 的。</p><p><strong>:slim 镜像</strong></p><p>如果实在不想折腾，可以选择一个折衷的镜像 xxx:slim。slim 镜像一般都基于 Debian 和 glibc，删除了许多非必需的软件包，优化了体积。如果构建过程中需要编译器，那么 slim 镜像不适合，除此之外大多数情况下还是可以使用 slim 作为基础镜像的。</p><p>下面是主流的解释型语言的 Alpine 镜像和 slim 镜像大小对比：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Image            Size</span><br><span class="line">---------------------------</span><br><span class="line">node             939 MB</span><br><span class="line">node:alpine      113 MB</span><br><span class="line">node:slim        163 MB</span><br><span class="line">python           932 MB</span><br><span class="line">python:alpine    110 MB</span><br><span class="line">python:slim      193 MB</span><br><span class="line">ruby             842 MB</span><br><span class="line">ruby:alpine       54 MB</span><br><span class="line">ruby:slim        149 MB</span><br></pre></td></tr></table></figure><p>再来举个特殊情况的例子，同时安装 matplotlib，numpy 和 pandas，不同的基础镜像构建的镜像大小如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Image and technique         Size</span><br><span class="line">--------------------------------------</span><br><span class="line">python                      1.26 GB</span><br><span class="line">python:slim                  407 MB</span><br><span class="line">python:alpine                523 MB</span><br><span class="line">python:alpine multi-stage    517 MB</span><br></pre></td></tr></table></figure><p>可以看到这种情况下使用 Alpine 并没有任何帮助，即使使用多阶段构建也无济于事。</p><p>但也不能全盘否定 Alpine，比如下面这种情况：包含大量依赖的 Django 应用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Image and technique         Size</span><br><span class="line">--------------------------------------</span><br><span class="line">python                      1.23 GB</span><br><span class="line">python:alpine                636 MB</span><br><span class="line">python:alpine multi-stage    391 MB</span><br></pre></td></tr></table></figure><p>最后来总结一下：到底使用哪个基础镜像并不能盖棺定论，有时使用 Alpine 效果更好，有时反而使用 slim 效果更好，如果你对镜像体积有着极致的追求，可以这两种镜像都尝试一下。相信随着时间的推移，我们就会积累足够的经验，知道哪种情况该用 Alpine，哪种情况该用 slim，不用再一个一个尝试。</p><h3 id="Rust-语言镜像精简"><a href="#Rust-语言镜像精简" class="headerlink" title="Rust 语言镜像精简"></a>Rust 语言镜像精简</h3><p>Rust 是最初由 Mozilla 设计的现代编程语言，并且在 Web 和基础架构领域中越来越受欢迎。Rust 编译的二进制文件动态链接到 C 库，可以正常运行于 Ubuntu、Debian 和 Fedora 之类的镜像中，但不能运行于 busybox:glibc 中。因为 Rust 二进制需要调用 libdl 库，busybox:glibc 中不包含该库。</p><p>还有一个 rust:alpine 镜像，Rust 编译的二进制也可以正常运行其中。</p><p>如果考虑编译成静态链接，可以参考 Rust 官方文档[7]。在 Linux 上需要构建一个特殊版本的 Rust 编译器，构建的依赖库就是 musl libc，你没有看错，就是 Alpine 中的那个 musl libc。如果你想获得更小的镜像，请按照文档中的说明进行操作，最后将生成的二进制文件扔进 scratch 镜像中就好了。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本系列文章的前两部分介绍了优化 Docker 镜像体积的常用方法，以及如何针对不同类型的语言运用这些方法。最后一部分将会介绍如何在减少镜像体积的同时，还能减少 I/O 和内存使用量，同时还会介绍一些虽然与容器无关但对优化镜像有帮助的技术。</p><p>相关链接：</p><ol><li><a href="https://dockercon.docker.com/watch/6nK1TVGjuTpFfnZNKEjCEr" target="_blank" rel="noopener">https://dockercon.docker.com/watch/6nK1TVGjuTpFfnZNKEjCEr</a></li><li><a href="https://wiki.musl-libc.org/functional-differences-from-glibc.html" target="_blank" rel="noopener">https://wiki.musl-libc.org/functional-differences-from-glibc.html</a></li><li><a href="https://hub.docker.com/_/amazoncorretto" target="_blank" rel="noopener">https://hub.docker.com/_/amazoncorretto</a></li><li><a href="https://github.com/jpetazzo/minimage" target="_blank" rel="noopener">https://github.com/jpetazzo/minimage</a></li><li><a href="https://pythonwheels.com/" target="_blank" rel="noopener">https://pythonwheels.com/</a></li><li><a href="https://pythonspeed.com/articles/alpine-docker-python/" target="_blank" rel="noopener">https://pythonspeed.com/articles/alpine-docker-python/</a></li><li><a href="https://doc.rust-lang.org/1.9.0/book/advanced-linking.html#static-linking" target="_blank" rel="noopener">https://doc.rust-lang.org/1.9.0/book/advanced-linking.html#static-linking</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Docker的一些东西 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes碎片之基础概念2</title>
      <link href="/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B52/"/>
      <url>/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B52/</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><h3 id="Kubernetes是什么"><a href="#Kubernetes是什么" class="headerlink" title="Kubernetes是什么"></a>Kubernetes是什么</h3><p>Kubernetes是Google于2014年根据其内部Brog体系开源的一个容器编列办理体系，可运用声明式的装备（以yaml文件的方法）主动地履行容器化应用程序的办理，包含布置、弹性、负载均衡、回滚等。<a id="more"></a></p><h3 id="Kubernetes架构"><a href="#Kubernetes架构" class="headerlink" title="Kubernetes架构"></a>Kubernetes架构</h3><p>咱们先来看一张Kubernetes的架构图</p><img src="/passages/Kubernetes碎片之基础概念2/1.png"><p>Kubernetes是一套分布式体系， 与大多数分布式体系类似，包含操控节点（master node）与作业节点（worker node）。</p><h4 id="master-node"><a href="#master-node" class="headerlink" title="master node"></a>master node</h4><p>操控节点便是指挥官，担任发号施令的，其上运转一些办理服务来对整个体系进行办理与操控，包含</p><ul><li>apiserver：作为整个体系的对外接口，供给一套Restful API供客户端调用，任何的资源恳求/调用操作都是经过kube-apiserver供给的接口进行,如kubectl、kubernetes dashboard等办理工具便是经过apiserver来完成对集群的办理</li><li>kube-scheduler：资源调度器，担任将容器组分配到哪些节点上</li><li>kube-controller-manager：办理操控器，集群中处理惯例使命的后台线程，<a href="https://www.jmwww.net/a/13201.html" target="_blank" rel="noopener">破解QQ空间访问权限</a>包含节点操控器（担任监听节点停机的事件并作出对应响应）、endpoint-controller（改写服务与容器组的关联信息）、replication-controller（保护容器组的副本数为指定的数值）、Service Account &amp; Token操控器（担任为新的命名空间创立默许的 Service Account 以及 API Access Token）</li><li>etcd：数据存储，存储集群一切的装备信息</li><li>coredns：完成集群内部经过服务称号进行容器组拜访的功能</li></ul><h4 id="worker-node"><a href="#worker-node" class="headerlink" title="worker node"></a>worker node</h4><p>作业节点便是详细干活的小兵，其上也运转一些服务来履行指挥官分派的使命，包含</p><ul><li>kubelet：是作业节点上履行操作的署理程序，担任容器的生命周期办理，定期履行容器健康检查，并上报容器的运转状况</li><li>kube-proxy：是一个具有负载均衡才能的简单的网络拜访署理，担任将拜访某个服务的恳求分配到作业节点的详细某个容器上（kube-proxy也运转于master node上）</li><li>Docker Daemon：这个不难理解，一切服务或容器组都要以Docker容器的方法来运转（但Kubernetes其实不局限于Docker，它支撑任何完成了Kubernetes容器引擎接口的容器引擎，如containerd、rktlet）</li></ul><p>别的还有既在master node上也在worker node上运转的网络通讯组件 kube-flannel。</p><h3 id="Kubernetes根本概念"><a href="#Kubernetes根本概念" class="headerlink" title="Kubernetes根本概念"></a>Kubernetes根本概念</h3><p>咱们再来看第二张图</p><img src="/passages/Kubernetes碎片之基础概念2/2.png"><p>功能组件在上面现已做了介绍。Kubernetes的操作目标主要包含容器组（Pod），服务（Service），副本操控器（replication-controller），及环绕这些的其它辅助目标</p><h4 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h4><p>Pod是Kubernetes创立或布置的最小根本单元。一个Pod封装一个或多个应用容器、存储资源、一个独立的网络IP以及办理操控容器运转方法的策略选项。Pod中的每个容器同享网络命名空间（包含IP与端口），Pod内的容器能够运用localhost相互通讯。Pod能够指定一组同享存储卷Volumes，Pod中一切容器都能够拜访同享的Volumes，Volumes用于数据耐久化，防止容器重启丢掉数据。</p><h4 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h4><p>Kubernetes运用Volume来处理Pod中容器重启数据丢掉的问题，以及Pod中多个容器间数据同享的问题。Kubernetes支撑的Volume类型包含：</p><ul><li>emptyDir：当Pod分配到Node上时，将会创立emptyDir，只要Node上的Pod一直运转，Volume就会一直存在。当Pod（不论任何原因）从Node上被删去时，emptyDir也同时会删去，存储的数据也将永久删去，但删去容器不影响emptyDir</li><li>hostPath：hostPath答应挂载Node上的文件体系到Pod里边去。如果Pod需要运用Node上的文件，能够运用hostPath</li><li>nfs: 运用nfs网络文件体系供给的同享目录</li></ul><h4 id="ReplicationController"><a href="#ReplicationController" class="headerlink" title="ReplicationController"></a>ReplicationController</h4><p>ReplicationController保证在任何时候都有按装备的Pod副本数在运转。现在推荐运用装备ReplicaSet（下一代ReplicationController）的Deployment来建立副本办理机制。</p><h4 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h4><p>ReplicaSet是下一代ReplicationController，两者的唯一区别是ReplicaSet支撑新的根据调集的选择器，而ReplicationController仅支撑根据相等选择器的需求。</p><h4 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h4><p>Deployment为Pod与ReplicaSet供给了声明式的界说，描述你想要的目标状况是什么，Deployment controller就会帮你将Pod与ReplicaSet的实践状况改变到你想要的目标状况。</p><h4 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h4><p>一个Service能够看做一组供给相同服务的Pod的对外拜访接口。Kubernetes供给两种类型的Service：</p><ul><li>NodePort： 集群外部能够经过Node IP与Node Port来拜访详细某个Pod</li><li>ClusterIP：指经过集群的内部IP暴露服务，服务只能够在集群内部能够拜访，这也是默许的 ServiceType</li></ul><h4 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h4><p>Label便是一对key/value，能够附加到各种资源目标上，如Node、Pod、Service等，一个资源目标能够界说任意数量的Label。能够经过Label选择器来选择具备某个（些）Label的资源。</p><h4 id="PV-amp-PVC"><a href="#PV-amp-PVC" class="headerlink" title="PV &amp; PVC"></a>PV &amp; PVC</h4><p>PersistentVolume（PV） 为用户供给了一个存储笼统，由办理员设置，它是集群的一部分。就像节点是集群中的资源一样，PV也是集群中的资源。 PV是Volume之类的卷插件，但具有独立于Pod的生命周期。</p><p>PersistentVolumeClaim（PVC）是用户存储的恳求。它与Pod类似。2020QQ空间相册密码破解Pod耗费节点资源，PVC耗费PV资源。Pod能够恳求特定级别的资源（CPU和内存）。PVC能够恳求特定大小和拜访形式的存储资源（例如，能够以读/写或只读形式挂载）。</p><h4 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h4><p>Secret处理了密码、token、密钥等灵敏数据的存储问题，Secret的三种类型：</p><ul><li>Service Account ：用来拜访Kubernetes API，由Kubernetes主动创立，而且会主动挂载到Pod的/run/secrets/kubernetes.io/serviceaccount目录中</li><li>Opaque ：Base64编码格式的Secret，用来存储密码、密钥等</li><li>kubernetes.io/dockerconfigjson ：用来存储docker registry的认证信息</li></ul><h4 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h4><p>ConfigMap用来保存key/value对的装备数据，这个数据能够在Pods里运用，或许被用来为像controller一样的体系组件存储装备数据。ConfigMap能够方便的处理不含灵敏信息的字符串（灵敏信息可运用Secret）。</p><h4 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h4><p>Namespace类似于Kubernetes中的虚拟集群，便于不同的分组在同享运用整个集群的资源的同时还能被别离办理。比方咱们如果开发测验共用一个Kubernetes集群，则能够将开发环境的服务布置到dev的namespace，测验环境的布置到test的namespace。</p><h4 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h4><p>为集群服务供给外部拜访，包含根据Nginx与Traefik两个版别，为服务供给域名绑定拜访与途径路由功能。也能够根据Ingress完成服务的灰度发布。</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker系列之三部曲1</title>
      <link href="/passages/Docker%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E9%83%A8%E6%9B%B21/"/>
      <url>/passages/Docker%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E9%83%A8%E6%9B%B21/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-镜像三部曲1"><a href="#Docker-镜像三部曲1" class="headerlink" title="Docker 镜像三部曲1"></a>Docker 镜像三部曲1</h2><p>本系列文章将分为三个部分：<a id="more"></a></p><p>对于刚接触容器的人来说，他们很容易被自己构建的 Docker 镜像体积吓到，我只需要一个几 MB 的可执行文件而已，为何镜像的体积会达到 1 GB 以上？本文将会介绍几个奇技淫巧来帮助你精简镜像，同时又不牺牲开发人员和运维人员的操作便利性。本系列文章将分为三个部分：</p><p>第一部分着重介绍多阶段构建（multi-stage builds），因为这是镜像精简之路至关重要的一环。在这部分内容中，我会解释静态链接和动态链接的区别，它们对镜像带来的影响，以及如何避免那些不好的影响。中间会穿插一部分对 Alpine 镜像的介绍。</p><p>第二部分将会针对不同的语言来选择适当的精简策略，其中主要讨论 Go，同时也涉及到了 Java，Node，Python，Ruby 和 Rust。这一部分也会详细介绍 Alpine 镜像的避坑指南。什么？你不知道 Alpine 镜像有哪些坑？我来告诉你。</p><p>第三部分将会探讨适用于大多数语言和框架的通用精简策略，例如使用常见的基础镜像、提取可执行文件和减小每一层的体积。同时还会介绍一些更加奇特或激进的工具，例如 Bazel，Distroless，DockerSlim 和 UPX，虽然这些工具在某些特定场景下能带来奇效，但大多情况下会起到反作用。</p><h3 id="万恶之源"><a href="#万恶之源" class="headerlink" title="万恶之源"></a>万恶之源</h3><p>我敢打赌，每一个初次使用自己写好的代码构建 Docker 镜像的人都会被镜像的体积吓到，来看一个例子。</p><p>让我们搬出那个屡试不爽的 hello world C 程序：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* hello.c */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hello, world!"</span>);</span><br><span class="line">    return0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并通过下面的 Dockerfile 构建镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM gcc</span><br><span class="line">COPY hello.c .</span><br><span class="line">RUN gcc -o hello hello.c</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>然后你会发现构建成功的镜像体积远远超过了 1 GB……因为该镜像包含了整个 gcc 镜像的内容。</p><p>如果使用 Ubuntu 镜像，安装 C 编译器，最后编译程序，你会得到一个大概 300 MB 大小的镜像，比上面的镜像小多了。但还是不够小，因为编译好的可执行文件还不到 20 KB：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l hello</span><br><span class="line">-rwxr-xr-x   1 root root 16384 Nov 18 14:36 hello</span><br></pre></td></tr></table></figure><p>类似地，Go 语言版本的 hello world 会得到相同的结果：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span><span class="string">"fmt"</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span> <span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"Hello, world!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用基础镜像 golang 构建的镜像大小是 800 MB，而编译后的可执行文件只有 2 MB 大小：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l hello</span><br><span class="line">-rwxr-xr-x 1 root root 2008801 Jan 15 16:41 hello</span><br></pre></td></tr></table></figure><p>还是不太理想，有没有办法大幅度减少镜像的体积呢？往下看。</p><p>为了更直观地对比不同镜像的大小，所有镜像都使用相同的镜像名，不同的标签。例如：hello:gcc，hello:ubuntu，hello:thisweirdtrick 等等，这样就可以直接使用命令 docker images hello 列出所有镜像名为 hello 的镜像，不会被其他镜像所干扰。</p><h3 id="多阶段构建"><a href="#多阶段构建" class="headerlink" title="多阶段构建"></a>多阶段构建</h3><p>要想大幅度减少镜像的体积，多阶段构建是必不可少的。多阶段构建的想法很简单：“我不想在最终的镜像中包含一堆 C 或 Go 编译器和整个编译工具链，我只要一个编译好的可执行文件！”</p><p>多阶段构建可以由多个 FROM 指令识别，每一个 FROM 语句表示一个新的构建阶段，阶段名称可以用 AS 参数指定，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM gcc AS mybuildstage</span><br><span class="line">COPY hello.c .</span><br><span class="line">RUN gcc -o hello hello.c</span><br><span class="line">FROM ubuntu</span><br><span class="line">COPY --from=mybuildstage hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>本例使用基础镜像 gcc 来编译程序 hello.c，然后启动一个新的构建阶段，它以 ubuntu 作为基础镜像，将可执行文件 hello 从上一阶段拷贝到最终的镜像中。最终的镜像大小是 64 MB，比之前的 1.1 GB 减少了 95%：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker images minimageREPOSITORY          TAG                    ...         SIZE</span><br><span class="line">minimage            hello-c.gcc            ...         1.14GB</span><br><span class="line">minimage            hello-c.gcc.ubuntu     ...         64.2MB</span><br></pre></td></tr></table></figure><p>还能不能继续优化？当然能。在继续优化之前，先提醒一下：</p><p>在声明构建阶段时，可以不必使用关键词 AS，最终阶段拷贝文件时可以直接使用序号表示之前的构建阶段（从零开始）。也就是说，下面两行是等效的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">COPY --from=mybuildstage hello .</span><br><span class="line">COPY --from=0 hello .</span><br></pre></td></tr></table></figure><p>如果 Dockerfile 内容是很复杂，构建阶段也不是很多，可以直接使用序号表示构建阶段。一旦 Dockerfile 变复杂了，构建阶段增多了，最好还是通过关键词 AS 为每个阶段命名，这样也便于后期维护。</p><p><strong>使用经典的基础镜像</strong></p><p>我强烈建议在构建的第一阶段使用经典的基础镜像，这里经典的镜像指的是 CentOS，Debian，Fedora 和 Ubuntu 之类的镜像。你可能还听说过 Alpine 镜像，不要用它！至少暂时不要用，后面我会告诉你有哪些坑。</p><p><strong>COPY –from 使用绝对路径</strong></p><p>从上一个构建阶段拷贝文件时，使用的路径是相对于上一阶段的根目录的。如果你使用 golang 镜像作为构建阶段的基础镜像，就会遇到类似的问题。假设使用下面的 Dockerfile 来构建镜像：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM golang</span><br><span class="line">COPY hello.go .</span><br><span class="line">RUN go build hello.go</span><br><span class="line">FROM ubuntuCOPY --from=0 hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>你会看到这样的报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY failed: stat /var/lib/docker/overlay2/1be...868/merged/hello: no such file or directory</span><br></pre></td></tr></table></figure><p>这是因为 COPY 命令想要拷贝的是 /hello，而 golang 镜像的 WORKDIR 是 /go，所以可执行文件的真正路径是 /go/hello。</p><p>当然你可以使用绝对路径来解决这个问题，但如果后面基础镜像改变了 WORKDIR 怎么办？你还得不断地修改绝对路径，所以这个方案还是不太优雅。最好的方法是在第一阶段指定 WORKDIR，在第二阶段使用绝对路径拷贝文件，这样即使基础镜像修改了 WORKDIR，也不会影响到镜像的构建。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM golang</span><br><span class="line">WORKDIR /src</span><br><span class="line">COPY hello.go .</span><br><span class="line">RUN go build hello.go</span><br><span class="line">FROM ubuntu</span><br><span class="line">COPY --from=0 /src/hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>最后的效果还是很惊人的，将镜像的体积直接从 800 MB 降低到了 66 MB：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker images minimageREPOSITORY     TAG                              ...    SIZEminimage       hello-go.golang                  ...    805MBminimage       hello-go.golang.ubuntu-workdir   ...    66.2MB</span><br></pre></td></tr></table></figure><h3 id="FROM-scratch-的魔力"><a href="#FROM-scratch-的魔力" class="headerlink" title="FROM scratch 的魔力"></a>FROM scratch 的魔力</h3><p>回到我们的 hello world，C 语言版本的程序大小为 16 kB，Go 语言版本的程序大小为 2 MB，那么我们到底能不能将镜像缩减到这么小？能否构建一个只包含我需要的程序，没有任何多余文件的镜像？</p><p>答案是肯定的，你只需要将多阶段构建的第二阶段的基础镜像改为 scratch 就好了。scratch 是一个虚拟镜像，不能被 pull，也不能运行，因为它表示空、nothing！这就意味着新镜像的构建是从零开始，不存在其他的镜像层。例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM golang</span><br><span class="line">COPY hello.go .</span><br><span class="line">RUN go build hello.go</span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=0 /go/hello .</span><br><span class="line">CMD [&quot;./hello&quot;]</span><br></pre></td></tr></table></figure><p>这一次构建的镜像大小正好就是 2 MB，堪称完美！</p><p>然而，但是，使用 scratch 作为基础镜像时会带来很多的不便，且听我一一道来。</p><p><strong>缺少 shell</strong></p><p>scratch 镜像的第一个不便是没有 shell，这就意味着 CMD/RUN 语句中不能使用字符串，例如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...FROM scratch</span><br><span class="line">COPY --from=0 /go/hello .</span><br><span class="line">CMD ./hello</span><br></pre></td></tr></table></figure><p>如果你使用构建好的镜像创建并运行容器，就会遇到下面的报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused &quot;exec: \&quot;/bin/sh\&quot;: stat /bin/sh: no such file or directory&quot;: unknown.</span><br></pre></td></tr></table></figure><p>从报错信息可以看出，镜像中并不包含 /bin/sh，所以无法运行程序。这是因为当你在 CMD/RUN 语句中使用字符串作为参数时，这些参数会被放到 /bin/sh 中执行，也就是说，下面这两条语句是等效的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CMD ./hello</span><br><span class="line">CMD /bin/sh -c &quot;./hello&quot;</span><br></pre></td></tr></table></figure><p>解决办法其实也很简单：<strong>使用 JSON 语法取代字符串语法。</strong>例如，将 CMD ./hello 替换为 CMD [“./hello”]，这样 Docker 就会直接运行程序，不会把它放到 shell 中运行。</p><p><strong>缺少调试工具</strong></p><p>scratch 镜像不包含任何调试工具，ls、ps、ping 这些统统没有，当然了，shell 也没有（上文提过了），你无法使用 docker exec 进入容器，也无法查看网络堆栈信息等等。</p><p>如果想查看容器中的文件，可以使用 docker cp；如果想查看或调试网络堆栈，可以使用 docker run –net container:，或者使用 nsenter；为了更好地调试容器，Kubernetes 也引入了一个新概念叫 Ephemeral Containers[1]，但现在还是 Alpha 特性。</p><p>虽然有这么多杂七杂八的方法可以帮助我们调试容器，但它们会将事情变得更加复杂，我们追求的是简单，越简单越好。</p><p>折中一下可以选择 busybox 或 alpine 镜像来替代 scratch，虽然它们多了那么几 MB，但从整体来看，这只是牺牲了少量的空间来换取调试的便利性，还是很值得的。</p><p><strong>缺少 libc</strong></p><p>这是最难解决的问题。使用 scratch 作为基础镜像时，Go 语言版本的 hello world 跑得很欢快，C 语言版本就不行了，或者换个更复杂的 Go 程序也是跑不起来的（例如用到了网络相关的工具包），你会遇到类似于下面的错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">standard_init_linux.go:211: exec user process caused &quot;no such file or directory&quot;</span><br></pre></td></tr></table></figure><p>从报错信息可以看出缺少文件，但没有告诉我们到底缺少哪些文件，其实这些文件就是程序运行所必需的动态库（dynamic library）。</p><p>那么，什么是动态库？为什么需要动态库？</p><p>所谓动态库、静态库，指的是程序编译的链接阶段，链接成可执行文件的方式。静态库指的是在链接阶段将汇编生成的目标文件.o 与引用到的库一起链接打包到可执行文件中，因此对应的链接方式称为静态链接（static linking）。而动态库在程序编译时并不会被连接到目标代码中，而是在程序运行是才被载入，因此对应的链接方式称为动态链接（dynamic linking）。</p><p>90 年代的程序大多使用的是静态链接，因为当时的程序大多数都运行在软盘或者盒式磁带上，而且当时根本不存在标准库。这样程序在运行时与函数库再无瓜葛，移植方便。但对于 Linux 这样的分时系统，会在在同一块硬盘上并发运行多个程序，这些程序基本上都会用到标准的 C 库，这时使用动态链接的优点就体现出来了。使用动态链接时，可执行文件不包含标准库文件，只包含到这些库文件的索引。例如，某程序依赖于库文件 libtrigonometry.so 中的 cos 和 sin 函数，该程序运行时就会根据索引找到并加载 libtrigonometry.so，然后程序就可以调用这个库文件中的函数。</p><p>使用动态链接的好处显而易见：</p><ol><li>节省磁盘空间，不同的程序可以共享常见的库。</li><li>节省内存，共享的库只需从磁盘中加载到内存一次，然后在不同的程序之间共享。</li><li>更便于维护，库文件更新后，不需要重新编译使用该库的所有程序。严格来说，动态库与共享库（shared libraries）相结合才能达到节省内存的功效。Linux 中动态库的扩展名是 .so（ shared object），而 Windows 中动态库的扩展名是 .DLL（Dynamic-link library[2]）。</li></ol><p>回到最初的问题，默认情况下，C 程序使用的是动态链接，Go 程序也是。上面的 hello world 程序使用了标准库文件 libc.so.6，所以只有镜像中包含该文件，程序才能正常运行。使用 scratch 作为基础镜像肯定是不行的，使用 busybox 和 alpine 也不行，因为 busybox 不包含标准库，而 alpine 使用的标准库是 musl libc，与大家常用的标准库 glibc 不兼容，后续的文章会详细解读，这里就不赘述了。</p><p>那么该如何解决标准库的问题呢？有三种方案。</p><p>1、使用静态库</p><p>我们可以让编译器使用静态库编译程序，办法有很多，如果使用 gcc 作为编译器，只需加上一个参数 -static：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -o hello hello.c -static</span><br></pre></td></tr></table></figure><p>编译完的可执行文件大小为 760 kB，相比于之前的 16kB 是大了好多，这是因为可执行文件中包含了其运行所需要的库文件。编译完的程序就可以跑在 scratch 镜像中了。</p><p>如果使用 alpine 镜像作为基础镜像来编译，得到的可执行文件会更小（&lt; 100kB），下篇文章会详述。</p><p>2、拷贝库文件到镜像中</p><p>为了找出程序运行需要哪些库文件，可以使用 ldd 工具：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ldd hello    </span><br><span class="line">linux-vdso.so.1 (0x00007ffdf8acb000)    </span><br><span class="line">libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007ff897ef6000)    </span><br><span class="line">/lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007ff8980f7000)</span><br></pre></td></tr></table></figure><p>从输出结果可知，该程序只需要 libc.so.6 这一个库文件。linux-vdso.so.1 与一种叫做 VDSO[3] 的机制有关，用来加速某些系统调用，可有可无。ld-linux-x86-64.so.2 表示动态链接器本身，包含了所有依赖的库文件的信息。</p><p>你可以选择将 ldd 列出的所有库文件拷贝到镜像中，但这会很难维护，特别是当程序有大量依赖库时。对于 hello world 程序来说，拷贝库文件完全没有问题，但对于更复杂的程序（例如使用到 DNS 的程序），就会遇到令人费解的问题：glibc（GNU C library）通过一种相当复杂的机制来实现 DNS，这种机制叫 NSS（Name Service Switch, 名称服务开关）。它需要一个配置文件 /etc/nsswitch.conf 和额外的函数库，但使用 ldd 时不会显示这些函数库，因为这些库在程序运行后才会加载。如果想让 DNS 解析正确工作，必须要拷贝这些额外的库文件（/lib64/libnss_*）。</p><p>我个人不建议直接拷贝库文件，因为它非常难以维护，后期需要不断地更改，而且还有很多未知的隐患。</p><p>3、使用 busybox:glibc 作为基础镜像</p><p>有一个镜像可以完美解决所有的这些问题，那就是 busybox:glibc。它只有 5 MB 大小，并且包含了 glibc 和各种调试工具。如果你想选择一个合适的镜像来运行使用动态链接的程序，busybox:glibc 是最好的选择。</p><p>注意：如果你的程序使用到了除标准库之外的库，仍然需要将这些库文件拷贝到镜像中。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>最后来对比一下不同构建方法构建的镜像大小：</p><ul><li>原始的构建方法：1.14 GB</li><li>使用 ubuntu 镜像的多阶段构建：64.2 MB</li><li>使用 alpine 镜像和静态 glibc：6.5 MB</li><li>使用 alpine 镜像和动态库：5.6 MB</li><li>使用 scratch 镜像和静态 glibc：940 kB</li><li>使用 scratch 镜像和静态 musl libc：94 kB</li></ul><p>最终我们将镜像的体积减少了 99.99%。</p><p>但我不建议使用 sratch 作为基础镜像，因为调试起来非常麻烦，但如果你喜欢，那我也不会拦着你。</p><p>下篇文章将会着重介绍 Go 语言的镜像精简策略，其中会花很大的篇幅来讨论 alpine 镜像，因为它实在是太酷了，在使用它之前必须得摸清它的底细。</p><p>相关链接：</p><ol><li><a href="https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/</a></li><li><a href="https://en.wikipedia.org/wiki/Dynamic-link_library" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Dynamic-link_library</a></li><li><a href="https://en.wikipedia.org/wiki/VDSO" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/VDSO</a></li></ol>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Docker的一些东西 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes碎片之</title>
      <link href="/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B51/"/>
      <url>/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B51/</url>
      
        <content type="html"><![CDATA[<h2 id="详解-K8s-容器基本概念"><a href="#详解-K8s-容器基本概念" class="headerlink" title="详解 K8s 容器基本概念"></a>详解 K8s 容器基本概念</h2><h3 id="容器与镜像"><a href="#容器与镜像" class="headerlink" title="容器与镜像"></a>容器与镜像</h3><h4 id="什么是容器？"><a href="#什么是容器？" class="headerlink" title="什么是容器？"></a>什么是容器？<a id="more"></a></h4><p>在介绍容器的具体概念之前，先简单回顾一下操作系统是如何管理进程的。</p><p>首先，当我们登录到操作系统之后，可以通过 ps 等操作看到各式各样的进程，这些进程包括系统自带的服务和用户的应用进程。那么，这些进程都有什么样的特点？</p><ul><li>第一，这些进程可以相互看到、相互通信；</li><li>第二，它们使用的是同一个文件系统，可以对同一个文件进行读写操作；</li><li>第三，这些进程会使用相同的系统资源。</li></ul><p>这样的三个特点会带来什么问题呢？</p><ul><li>因为这些进程能够相互看到并且进行通信，高级权限的进程可以攻击其他进程；</li><li>因为它们使用的是同一个文件系统，因此会带来两个问题：这些进程可以对于已有的数据进行增删改查，具有高级权限的进程可能会将其他进程的数据删除掉，破坏掉其他进程的正常运行；此外，进程与进程之间的依赖可能会存在冲突，如此一来就会给运维带来很大的压力；</li><li>因为这些进程使用的是同一个宿主机的资源，应用之间可能会存在资源抢占的问题，当一个应用需要消耗大量 CPU 和内存资源的时候，就可能会破坏其他应用的运行，导致其他应用无法正常地提供服务。</li></ul><p>针对上述的三个问题，如何为进程提供一个独立的运行环境呢？</p><ul><li>针对不同进程使用同一个文件系统所造成的问题而言，Linux 和 Unix 操作系统可以通过 chroot 系统调用将子目录变成根目录，达到视图级别的隔离；进程在 chroot 的帮助下可以具有独立的文件系统，对于这样的文件系统进行增删改查不会影响到其他进程；</li><li>因为进程之间相互可见并且可以相互通信，使用 Namespace 技术来实现进程在资源的视图上进行隔离。在 chroot 和 Namespace 的帮助下，进程就能够运行在一个独立的环境下了；</li><li>但在独立的环境下，进程所使用的还是同一个操作系统的资源，一些进程可能会侵蚀掉整个系统的资源。为了减少进程彼此之间的影响，可以通过 Cgroup 来限制其资源使用率，设置其能够使用的 CPU 以及内存量。</li></ul><p>那么，应该如何定义这样的进程集合呢？</p><p>其实，容器就是一个视图隔离、资源可限制、独立文件系统的进程集合。所谓“视图隔离”就是能够看到部分进程以及具有独立的主机名等；控制资源使用率则是可以对于内存大小以及 CPU 使用个数等进行限制。容器就是一个进程集合，它将系统的其他资源隔离开来，具有自己独立的资源视图。</p><p>容器具有一个独立的文件系统，因为使用的是系统的资源，所以在独立的文件系统内不需要具备内核相关的代码或者工具，我们只需要提供容器所需的二进制文件、配置文件以及依赖即可。只要容器运行时所需的文件集合都能够具备，那么这个容器就能够运行起来。</p><h4 id="什么是镜像？"><a href="#什么是镜像？" class="headerlink" title="什么是镜像？"></a>什么是镜像？</h4><p>综上所述，我们将这些容器运行时所需要的所有的文件集合称之为容器镜像。</p><p>那么，一般都是通过什么样的方式来构建镜像的呢？通常情况下，我们会采用 Dockerfile 来构建镜像，这是因为 Dockerfile 提供了非常便利的语法糖，能够帮助我们很好地描述构建的每个步骤。当然，每个构建步骤都会对已有的文件系统进行操作，这样就会带来文件系统内容的变化，我们将这些变化称之为 changeset。当我们把构建步骤所产生的变化依次作用到一个空文件夹上，就能够得到一个完整的镜像。changeset 的分层以及复用特点能够带来几点优势：</p><ul><li>第一，能够提高分发效率，简单试想一下，对于大的镜像而言，如果将其拆分成各个小块就能够提高镜像的分发效率，这是因为镜像拆分之后就可以并行下载这些数据；</li><li>第二，因为这些数据是相互共享的，也就意味着当本地存储上包含了一些数据的时候，只需要下载本地没有的数据即可，举个简单的例子就是 golang 镜像是基于 alpine 镜像进行构建的，当本地已经具有了 alpine 镜像之后，在下载 golang 镜像的时候只需要下载本地 alpine 镜像中没有的部分即可；</li><li>第三，因为镜像数据是共享的，因此可以节约大量的磁盘空间，简单设想一下，当本地存储具有了 alpine 镜像和 golang 镜像，在没有复用的能力之前，alpine 镜像具有 5M 大小，golang 镜像有 300M 大小，因此就会占用 305M 空间；而当具有了复用能力之后，只需要 300M 空间即可。</li></ul><h4 id="如何构建镜像？"><a href="#如何构建镜像？" class="headerlink" title="如何构建镜像？"></a>如何构建镜像？</h4><p>如下图所示的 Dockerfile 适用于描述如何构建 golang 应用的。</p><p>如图所示：</p><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/vbERicIdYZbAP61azKhfsYLmZwVZiaicibLm1icXF86IoqfXuYa8KDOFK4jbqfC7r8vOib4m6NVuCUicmwBoFOUsqPWIQ/640?wx_fmt=jpeg&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p><ol><li>FROM 行表示以下的构建步骤基于什么镜像进行构建，正如前面所提到的，镜像是可以复用的；</li><li>WORKDIR 行表示会把接下来的构建步骤都在哪一个相应的具体目录下进行，其起到的作用类似于 Shell 里面的 cd；</li><li>COPY 行表示的是可以将宿主机上的文件拷贝到容器镜像内；</li><li>RUN 行表示在具体的文件系统内执行相应的动作。当我们运行完毕之后就可以得到一个应用了；</li><li>CMD 行表示使用镜像时的默认程序名字。</li></ol><p>当有了 Dockerfile 之后，就可以通过 docker build 命令构建出所需要的应用。构建出的结果存储在本地，一般情况下，镜像构建会在打包机或者其他的隔离环境下完成。</p><p>那么，这些镜像如何运行在生产环境或者测试环境上呢？这时候就需要一个中转站或者中心存储，我们称之为 docker registry，也就是镜像仓库，其负责存储所有产生的镜像数据。我们只需要通过 docker push 就能够将本地镜像推动到镜像仓库中，这样一来，就能够在生产环境上或者测试环境上将相应的数据下载下来并运行了。</p><h4 id="如何运行容器？"><a href="#如何运行容器？" class="headerlink" title="如何运行容器？"></a>如何运行容器？</h4><p>运行一个容器一般情况下分为三步：</p><ul><li>第一步：从镜像仓库中将相应的镜像下载下来；</li><li>第二步：当镜像下载完成之后就可以通过 docker images 来查看本地镜像，这里会给出一个完整的列表，我们可以在列表中选中想要的镜像；</li><li>第三步：当选中镜像之后，就可以通过 docker run 来运行这个镜像得到想要的容器，当然可以通过多次运行得到多个容器。一个镜像就相当于是一个模板，一个容器就像是一个具体的运行实例，因此镜像就具有了一次构建、到处运行的特点。</li></ul><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>简单回顾一下，容器就是和系统其它部分隔离开来的进程集合，这里的其他部分包括进程、网络资源以及文件系统等。而镜像就是容器所需要的所有文件集合，其具备一次构建、到处运行的特点。</p><h3 id="容器的生命周期"><a href="#容器的生命周期" class="headerlink" title="容器的生命周期"></a>容器的生命周期</h3><h4 id="容器运行时的生命周期"><a href="#容器运行时的生命周期" class="headerlink" title="容器运行时的生命周期"></a>容器运行时的生命周期</h4><p>容器是一组具有隔离特性的进程集合，在使用 docker run 的时候会选择一个镜像来提供独立的文件系统并指定相应的运行程序。这里指定的运行程序称之为 initial 进程，这个 initial 进程启动的时候，容器也会随之启动，当 initial 进程退出的时候，容器也会随之退出。</p><p>因此，可以认为容器的生命周期和 initial 进程的生命周期是一致的。当然，因为容器内不只有这样的一个 initial 进程，initial 进程本身也可以产生其他的子进程或者通过 docker exec 产生出来的运维操作，也属于 initial 进程管理的范围内。当 initial 进程退出的时候，所有的子进程也会随之退出，这样也是为了防止资源的泄漏。但是这样的做法也会存在一些问题，首先应用里面的程序往往是有状态的，其可能会产生一些重要的数据，当一个容器退出被删除之后，数据也就会丢失了，这对于应用方而言是不能接受的，所以需要将容器所产生出来的重要数据持久化下来。容器能够直接将数据持久化到指定的目录上，这个目录就称之为数据卷。</p><p>数据卷有一些特点，其中非常明显的就是数据卷的生命周期是独立于容器的生命周期的，也就是说容器的创建、运行、停止、删除等操作都和数据卷没有任何关系，因为它是一个特殊的目录，是用于帮助容器进行持久化的。简单而言，我们会将数据卷挂载到容器内，这样一来容器就能够将数据写入到相应的目录里面了，而且容器的退出并不会导致数据的丢失。</p><p>通常情况下，数据卷管理主要有两种方式：</p><p>第一种是通过 bind 的方式，直接将宿主机的目录直接挂载到容器内；这种方式比较简单，但是会带来运维成本，因为其依赖于宿主机的目录，需要对于所有的宿主机进行统一管理。</p><p>第二种是将目录管理交给运行引擎。</p><h3 id="容器项目架构"><a href="#容器项目架构" class="headerlink" title="容器项目架构"></a>容器项目架构</h3><h4 id="moby-容器引擎架构"><a href="#moby-容器引擎架构" class="headerlink" title="moby 容器引擎架构"></a>moby 容器引擎架构</h4><p>moby 是目前最流行的容器管理引擎，mobydaemon 会对上提供有关于容器、镜像、网络以及 Volume的管理。moby daemon 所依赖的最重要的组件就是 containerd，containerd 是一个容器运行时管理引擎，其独立于 moby daemon ，可以对上提供容器、镜像的相关管理。</p><p>containerd 底层有 containerd shim 模块，其类似于一个守护进程，这样设计的原因有几点：</p><p>首先，containerd 需要管理容器生命周期，而容器可能是由不同的容器运行时所创建出来的，因此需要提供一个灵活的插件化管理。而 shim 就是针对于不同的容器运行时所开发的，这样就能够从 containerd 中脱离出来，通过插件的形式进行管理。</p><p>其次，因为 shim 插件化的实现，使其能够被 containerd 动态接管。如果不具备这样的能力，当 moby daemon 或者 containerd daemon 意外退出的时候，容器就没人管理了，那么它也会随之消失、退出，这样就会影响到应用的运行。</p><p>最后，因为随时可能会对 moby 或者 containerd 进行升级，如果不提供 shim 机制，那么就无法做到原地升级，也无法做到不影响业务的升级，因此 containerd shim 非常重要，它实现了动态接管的能力。</p><h3 id="容器-VS-VM"><a href="#容器-VS-VM" class="headerlink" title="容器 VS VM"></a>容器 VS VM</h3><h4 id="容器和-VM-之间的差异"><a href="#容器和-VM-之间的差异" class="headerlink" title="容器和 VM 之间的差异"></a>容器和 VM 之间的差异</h4><p>VM 利用 Hypervisor 虚拟化技术来模拟 CPU、内存等硬件资源，这样就可以在宿主机上建立一个 Guest OS，这是常说的安装一个虚拟机。</p><p>每一个 Guest OS 都有一个独立的内核，比如 Ubuntu、CentOS 甚至是 Windows 等，在这样的 Guest OS 之下，每个应用都是相互独立的，VM 可以提供一个更好的隔离效果。但这样的隔离效果需要付出一定的代价，因为需要把一部分的计算资源交给虚拟化，这样就很难充分利用现有的计算资源，并且每个 Guest OS 都需要占用大量的磁盘空间，比如 Windows 操作系统的安装需要 10~30G 的磁盘空间，Ubuntu 也需要 5~6G，同时这样的方式启动很慢。正是因为虚拟机技术的缺点，催生出了容器技术。容器是针对于进程而言的，因此无需 Guest OS，只需要一个独立的文件系统提供其所需要文件集合即可。所有的文件隔离都是进程级别的，因此启动时间快于 VM，并且所需的磁盘空间也小于 VM。当然了，进程级别的隔离并没有想象中的那么好，隔离效果相比 VM 要差很多。</p><p>总体而言，容器和 VM 相比，各有优劣，因此容器技术也在向着强隔离方向发展。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li>容器是一个进程集合，具有自己独特的视图视角；</li><li>镜像是容器所需要的所有文件集合，其具备一次构建、到处运行的特点；</li><li>容器的生命周期和 initial 进程的生命周期是一样的；</li><li>容器和 VM 相比，各有优劣，容器技术在向着强隔离方向发展。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes碎片之命令执行篇</title>
      <link href="/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%AF%87/"/>
      <url>/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%AF%87/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes碎片之证书详解</title>
      <link href="/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3/"/>
      <url>/passages/Kubernetes%E7%A2%8E%E7%89%87%E4%B9%8B%E8%AF%81%E4%B9%A6%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_study </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发篇</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E7%AF%87/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="Golang之并发篇"><a href="#Golang之并发篇" class="headerlink" title="Golang之并发篇"></a>Golang之并发篇</h2><h3 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A.进程是程序在操作系统中的一次执行过程，系统进行资源分配和调度的一个独立单位。</span><br><span class="line"></span><br><span class="line">B.线程是进程的一个执行实体，是CPU调度和分派的基本单位，它是比进程更小的能独立运行的基本单位。</span><br><span class="line"></span><br><span class="line">C.一个进程可以创建和撤销多个线程；同一进程中的多个线程之间可以并发执行。</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119160736443-318205395.png" alt="img"></p><h3 id="并发和并行"><a href="#并发和并行" class="headerlink" title="并发和并行"></a>并发和并行<a id="more"></a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">并发：多线程程序在一个核的cpu上运行</span><br><span class="line">并行：多线程程序在多个核的cpu上运行</span><br><span class="line">举例: 一个妈给一个碗给多个小孩喂饭，，是并发</span><br><span class="line">　　　　一个妈给每个小孩一人一个碗，就是并行</span><br></pre></td></tr></table></figure><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119161120193-1746947231.png" alt="img"></p><h3 id="协程和线程"><a href="#协程和线程" class="headerlink" title="协程和线程"></a>协程和线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">协程：独立的栈空间，共享堆空间，调度由用户自己控制，本质上有点类似于用户级协程，这些用户级线程的调度也是自己实现的。</span><br><span class="line">线程：一个线程上可以跑多个协程，协程是轻量级的线程。</span><br></pre></td></tr></table></figure><p><strong>例子</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        i++</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> test() <span class="comment">//起一个协程执行test（）</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"i : runnging in main"</span>)</span><br><span class="line">        time.Sleep(time.Second )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="GPM"><a href="#GPM" class="headerlink" title="GPM"></a>GPM</h3><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119164420162-1968227687.png" alt="img"></p><p><img src="https://images2017.cnblogs.com/blog/1132884/201801/1132884-20180119164737381-1301671524.png" alt="img"></p><p><strong>设置Golang运行的cpu核数。</strong></p><p><strong>1.8版本以上，默认跑多个核</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    num := runtime.NumCPU()</span><br><span class="line">    runtime.GOMAXPROCS(num)</span><br><span class="line">    fmt.Println(num)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并发计算</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    m    = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">uint64</span>)</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> task <span class="keyword">struct</span> &#123;</span><br><span class="line">    n <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calc</span><span class="params">(t *task)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">uint64</span></span><br><span class="line">    sum = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; t.n; i++ &#123;</span><br><span class="line">        sum *= <span class="keyword">uint64</span>(i)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(t.n, sum)</span><br><span class="line">    lock.Lock()</span><br><span class="line">    m[t.n] = sum</span><br><span class="line">    lock.Unlock()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">        t := &amp;task&#123;n: i&#125;</span><br><span class="line">        <span class="keyword">go</span> calc(t)<span class="comment">//并发执行，谁快谁先出 </span></span><br><span class="line">    &#125;</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">    <span class="comment">//lock.Lock()</span></span><br><span class="line">    <span class="comment">//for k, v := range m &#123;</span></span><br><span class="line">    <span class="comment">//    fmt.Printf("%d!=%v\n", k, v)</span></span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">//lock.Unlock()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><h4 id="channel概念"><a href="#channel概念" class="headerlink" title="channel概念"></a>channel概念</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a.类似unix中的管道(pipe)</span><br><span class="line">b.先进先出</span><br><span class="line">c.线程安全，多个goroutine同时访问，不需要枷锁</span><br><span class="line">d.channel是有类型的，一个整数的channel只能存整数</span><br></pre></td></tr></table></figure><h4 id="channel声明"><a href="#channel声明" class="headerlink" title="channel声明"></a>channel声明</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> age <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> mapchan <span class="keyword">chan</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> test <span class="keyword">chan</span> student</span><br><span class="line"><span class="keyword">var</span> test1 <span class="keyword">chan</span> *student</span><br></pre></td></tr></table></figure><h4 id="channel初始化"><a href="#channel初始化" class="headerlink" title="channel初始化"></a>channel初始化</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">使用<span class="built_in">make</span>进行初始化</span><br><span class="line"><span class="keyword">var</span> test <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">test = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>,<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test <span class="keyword">chan</span> <span class="keyword">string</span></span><br><span class="line">test=<span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>,<span class="number">10</span>)</span><br></pre></td></tr></table></figure><h4 id="channel基本操作"><a href="#channel基本操作" class="headerlink" title="channel基本操作"></a>channel基本操作</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">从channel读取数据</span><br><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line">a = &lt;-testChan</span><br></pre></td></tr></table></figure><h4 id="从channel写入数据"><a href="#从channel写入数据" class="headerlink" title="从channel写入数据"></a>从channel写入数据</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span> = <span class="number">10</span></span><br><span class="line">testChan &lt;- a</span><br></pre></td></tr></table></figure><p>第一个例子</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> stuChan <span class="keyword">chan</span> *student</span><br><span class="line">    stuChan = <span class="built_in">make</span>(<span class="keyword">chan</span> *student, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    stu := student&#123;name: <span class="string">"stu001"</span>&#125;</span><br><span class="line"></span><br><span class="line">    stuChan &lt;- &amp;stu</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stu01 <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">    stu01 = &lt;-stuChan</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> stu02 *student</span><br><span class="line">    stu02, ok := stu01.(*student)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        fmt.Println(<span class="string">"can not convert"</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(stu02)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="goroutine与channel"><a href="#goroutine与channel" class="headerlink" title="goroutine与channel"></a>goroutine与channel</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//起一个读的协程</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> b <span class="keyword">int</span></span><br><span class="line">        b = &lt;-ch</span><br><span class="line">        fmt.Println(b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    intChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">go</span> write(intChan)</span><br><span class="line">    <span class="keyword">go</span> read(intChan)</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>读，取，字符串</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    ch &lt;- <span class="string">"Washington"</span></span><br><span class="line">    ch &lt;- <span class="string">"Tripoli"</span></span><br><span class="line">    ch &lt;- <span class="string">"London"</span></span><br><span class="line">    ch &lt;- <span class="string">"Beijing"</span></span><br><span class="line">    ch &lt;- <span class="string">"Tokio"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        input = &lt;-ch</span><br><span class="line">        fmt.Println(input)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> sendData(ch)</span><br><span class="line">    <span class="keyword">go</span> getData(ch)</span><br><span class="line">    time.Sleep(<span class="number">3</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Channel缓冲区"><a href="#Channel缓冲区" class="headerlink" title="Channel缓冲区"></a>Channel缓冲区</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只能放一个元素的testChan</span></span><br><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span></span><br><span class="line">a = &lt;-testChan</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// testChan是带缓冲区的chan，一次可以放10个元素</span></span><br><span class="line"><span class="keyword">var</span> testChan <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">testChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">int</span> = <span class="number">10</span></span><br><span class="line">testChan &lt;- a</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    m    = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">uint64</span>)</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> task <span class="keyword">struct</span> &#123;</span><br><span class="line">    n <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calc</span><span class="params">(t *task)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sum <span class="keyword">uint64</span></span><br><span class="line">    sum = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; t.n; i++ &#123;</span><br><span class="line">        sum *= <span class="keyword">uint64</span>(i)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(t.n, sum)</span><br><span class="line">    lock.Lock()</span><br><span class="line">    m[t.n] = sum</span><br><span class="line">    lock.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">16</span>; i++ &#123;</span><br><span class="line">        t := &amp;task&#123;n: i&#125;</span><br><span class="line">        <span class="keyword">go</span> calc(t)</span><br><span class="line">    &#125;</span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Second)</span><br><span class="line">    lock.Lock()</span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"%d!=%v\n"</span>, k, v)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    lock.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calc</span><span class="params">(taskChan <span class="keyword">chan</span> <span class="keyword">int</span>, resChan <span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> taskChan &#123;</span><br><span class="line">        flag := <span class="literal">true</span></span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">2</span>; i &lt; v; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> v%i == <span class="number">0</span> &#123;</span><br><span class="line">                flag = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> flag &#123;</span><br><span class="line">            resChan &lt;- v</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(<span class="string">"exit"</span>)</span><br><span class="line">    exitChan &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    intChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1000</span>)</span><br><span class="line">    resultChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1000</span>)</span><br><span class="line">    exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">8</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">            intChan &lt;- i</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(intChan)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> calc(intChan, resultChan, exitChan)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待所有计算的goroutine全部退出</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line">            &lt;-exitChan</span><br><span class="line">            fmt.Println(<span class="string">"wait goroute"</span>, i, <span class="string">"exited"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(resultChan)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> v := <span class="keyword">range</span> resultChan &#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        v, ok := &lt;-ch</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> send(ch, exitChan)</span><br><span class="line">    <span class="keyword">go</span> recv(ch, exitChan)</span><br><span class="line">    <span class="keyword">var</span> total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ = <span class="keyword">range</span> exitChan &#123;</span><br><span class="line">        total++</span><br><span class="line">        <span class="keyword">if</span> total == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="检测管道是否关闭"><a href="#检测管道是否关闭" class="headerlink" title="检测管道是否关闭"></a>检测管道是否关闭</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> b <span class="keyword">int</span></span><br><span class="line">        b, ok := &lt;-ch</span><br><span class="line">        <span class="comment">//检测管道是否关闭</span></span><br><span class="line">        <span class="keyword">if</span> ok == <span class="literal">false</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">"chan is close"</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(b)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="如何关闭chan"><a href="#如何关闭chan" class="headerlink" title="如何关闭chan"></a>如何关闭chan</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 使用内置函数close进行关闭，chan关闭之后，for range遍历chan中</span><br><span class="line">已经存在的元素后结束</span><br><span class="line">2. 使用内置函数close进行关闭，chan关闭之后，没有使用for range的写法</span><br><span class="line">需要使用，v, ok := &lt;- ch进行判断chan是否关闭</span><br></pre></td></tr></table></figure><h3 id="chan的只读和只写"><a href="#chan的只读和只写" class="headerlink" title="chan的只读和只写"></a>chan的只读和只写</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">只读的声明</span><br><span class="line">Var 变量的名字 &lt;-chan int</span><br><span class="line">Var readChan &lt;- chan int</span><br><span class="line"></span><br><span class="line">只写的声明</span><br><span class="line">Var 变量的名字 chan&lt;- int</span><br><span class="line">Var writeChan chan&lt;- int</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//只写chan</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(ch <span class="keyword">chan</span>&lt;- <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        ch &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(ch)</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//只读chan</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(ch &lt;-<span class="keyword">chan</span> <span class="keyword">int</span>, exitChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        v, ok := &lt;-ch</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> a <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    exitChan &lt;- a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>) <span class="comment">//初始化chan</span></span><br><span class="line">    exitChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> send(ch, exitChan)</span><br><span class="line">    <span class="keyword">go</span> recv(ch, exitChan)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ = <span class="keyword">range</span> exitChan &#123;</span><br><span class="line">        total++</span><br><span class="line">        <span class="keyword">if</span> total == <span class="number">2</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不阻塞</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">    ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> i <span class="keyword">int</span></span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            ch &lt;- i</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            ch2 &lt;- i * i</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">            i++</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> v := &lt;-ch:</span><br><span class="line">            fmt.Println(v)</span><br><span class="line">        <span class="keyword">case</span> v := &lt;-ch2:</span><br><span class="line">            fmt.Println(v)</span><br><span class="line">        <span class="keyword">case</span> &lt;-time.After(time.Second):</span><br><span class="line">            fmt.Println(<span class="string">"get data timeout"</span>)</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发之条件变量</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/</url>
      
        <content type="html"><![CDATA[<blockquote><p>条件变量</p></blockquote><p>在Go语言中，sync.Cond类型代表了条件变量。与互斥锁和读写锁不同，简单的声明无法创建出一个可用的条件变量。为了得到这样一个条件变量，我们需要用到sync.NewCond函数。该函数的声明如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCond</span><span class="params">(l Locker)</span> *<span class="title">Cond</span></span></span><br></pre></td></tr></table></figure><p>条件变量总是要与互斥量组合使用。因此，sync.NewCond函数的唯一参数是sync.Locker类型的，而具体的参数值既可以是一个互斥锁也可以是一个读写锁。sync.NewCond函数在被调用之后会返回一个*sync.Cond类型的结果值。我们可以调用该值拥有的几个方法来操纵对应的条件变量。<a id="more"></a></p><p>类型*sync.Cond的方法集合中有三个方法，即：Wait方法、Signal方法和Broadcast方法。它们分别代表了等待通知、单发通知和广播通知的操作。</p><p>方法Wait会自动的对与该条件变量关联的那个锁进行解锁，并且使调用方所在的Goroutine被阻塞。一旦该方法收到通知，就会试图再次锁定该锁。如果锁定成功，它就会唤醒那个被它阻塞的Goroutine。否则，该方法会等待下一个通知，那个Goroutine也会继续被阻塞。而方法Signal和Broadcast的作用都是发送通知以唤醒正在为此而被阻塞的Goroutine。不同的是，前者的目标只有一个，而后者的目标则是所有。</p><p>在Read方法中，我们对一种边界情况进行了特殊处理，即：如果*os.File类型的f字段的ReadAt方法在被调用后返回了一个非nil且等于io.EOF的错误值，那么Read方法就忽略这个错误并再次尝试读取相同位置的数据块，直到读取成功为止。从这个特殊处理的具体流程上来看，似乎使用条件变量来作为辅助手段会带来一些好处。下面我们就来动手试验一下。</p><p>我们先在结构体类型myDataFile增加一个类型为*sync.Cond的字段rcond。为了快速实现想法，我们暂时不考虑怎样初始化这个字段，而直接去改造Read方法和Write方法。</p><p>在Read方法中，我们使用一个for循环来达到重新尝试获取数据块的目的。为此，我们添加了若干条重复的语句、降低了程序的性能，还造成了一个潜在的问题——在某个情况下读写锁fmutex不会被读解锁。为了解决这一系列新生的问题，我们使用代表条件变量的字段rcond。Read方法的第三个版本如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(df *myDataFile)</span> <span class="title">Read</span><span class="params">()</span> <span class="params">(rsn <span class="keyword">int64</span>, d Data, err error)</span></span> &#123;</span><br><span class="line"><span class="comment">// 读取并更新读偏移量</span></span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line"><span class="comment">// 读取一个数据块</span></span><br><span class="line">rsn = offset / <span class="keyword">int64</span>(df.dataLen)</span><br><span class="line">bytes := <span class="built_in">make</span>([]<span class="keyword">byte</span>, df.dataLen)</span><br><span class="line">df.fmutex.RLock()</span><br><span class="line"><span class="keyword">defer</span> df.fmutex.RUnlock()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">_, err = df.f.ReadAt(bytes, offset)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line">df.rcond.Wait()</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">d = bytes</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们假设条件变量rcond与读写锁fmutex中的“读锁”相关联。可以看到，我们让defer df.fmutex.RUnlock()语句回归了，并删除了所有return语句和continue语句前面的针对fmutex的读解锁操作。这都得益于新增在continue语句前面的df.rcond.Wait()。添加这条语句的意义在于：当发现由文件内容读取造成的EOF错误时，要让当前Goroutine暂时放弃fmutex的“读锁”并等待通知的到来。放弃fmutex的“读锁”也就意味着Write方法中的数据块写操作不会受到它的阻碍了。在写操作完成之后，我们应该及时向条件变量rcond发送通知以唤醒为此而等待的Goroutine。请注意，在某个Goroutine被唤醒之后，应该再次检查需要被满足的条件。在这里，这个需要被满足的条件是在进行文件内容读取时不会造成EOF错误。如果该条件被满足，那么就可以进行后续的操作了。否则，应该再次放弃“读锁”并等待通知。这也是我们依然保留for循环的原因。</p><p>这里有两点需要特别注意。</p><ul><li>一定要在调用rcond的Wait方法之前锁定与之关联的那个“读锁”，否则就会造成对Wait方法的调用永远无法返回。这种情况会导致流程执行的停滞，甚至整个程序的死锁！导致这种结果的原因与条件变量和读写锁的内部实现方式有关（结果也许并不应该是这样，作者已经向Go语言官方提交了一个issue；Go语言官方已经接受了这个issue，并承诺将会在Go 1.4版本中改进它）。假设，与条件变量rcond关联的是某个读写锁的“写锁”或普通的互斥锁，那么对rcond.Wait方法的调用将会引发一个运行时恐慌。原因是，该方法会先对与之关联的锁进行解锁，而试图解锁未被锁定的锁就会引发一个运行时恐慌。</li><li>一定不要忘记在读操作完成之前解锁与条件变量rcond关联的那个“读锁”，否则对读写锁的写锁定操作将会阻塞相关的Goroutine。其根本原因是，条件变量rcond的Wait方法在返回之前会重新锁定与之关联的那个“读锁”。因此，在结束这个从文件中读取一个数据块的流程之前，我们应该调用fmutex字段的RLock方法。那条defer语句就起到了这个作用。</li></ul><p>我们对Read方法的这次改进使得它的实现变得更加简洁和清晰了。不过，要想使其中的条件变量rcond真正发挥作用，还需要Write方法的配合。换句话说，为了让rcond.Wait方法可以适时的返回，我们要在向文件写入一个数据块之后及时的向rcond发送通知。添加了这一操作的Write方法如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(df *myDataFile)</span> <span class="title">Write</span><span class="params">(d Data)</span> <span class="params">(wsn <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line"><span class="keyword">var</span> bytes []<span class="keyword">byte</span></span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line">df.fmutex.Lock()</span><br><span class="line"><span class="keyword">defer</span> df.fmutex.Unlock()</span><br><span class="line">_, err = df.f.Write(bytes)</span><br><span class="line">df.rcond.Signal()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于一个数据块只能由某一个读操作读取，所以我们只是使用条件变量的Signal方法去通知某一个为此等待的Wait方法，并以此唤醒某一个相关的Goroutine。这可以免去其它相关的Goroutine中的一些无谓操作。</p><p>与Wait方法不同，我们在调用条件变量的Signal方法和Broadcast方法之前无需锁定与之关联的锁。随之，相应的解锁操作也是不需要的。在这个Write方法中的锁定操作和解锁的操作针对的并不是df.rcond.Signal()语句。</p><p>我们一直在说，条件变量rcond是与读写锁fmutex的“读锁”关联的。这是怎样做到的呢？读者还记得我们在上一节提到读写锁的RLocker方法吗？它会返回当前读写锁中的“读锁”。这个结果值同时也是sync.Locker接口的实现。因此，我们可以把它作为参数值传给sync.NewCond函数。所以，我们在NewDataFile函数中的声明df变量的语句的后面加入了这样一条语句：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df.rcond = sync.NewCond(df.fmutex.RLocker())</span><br></pre></td></tr></table></figure><p>在这之后，我们就可以像前面那样使用这个条件变量了。</p><p>随着对*myDataFile类型和NewDataFile函数的改造的完成，我们也将结束本节。Go语言提供的互斥锁、读写锁和条件变量都基本遵循了POSIX标准中描述的对应的同步工具的行为规范。它们简单且高效。我们可以使用它们为复杂的类型提供并发安全的保证。在一些情况下，它们比通道更加灵活。在只需对一个或多个临界区进行保护的时候，使用锁往往会对程序的性能损耗更小。</p>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes问题之解惑篇5</title>
      <link href="/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%875/"/>
      <url>/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%875/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes问题之解惑篇4</title>
      <link href="/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%874/"/>
      <url>/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%874/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes问题之解惑篇3</title>
      <link href="/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%873/"/>
      <url>/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%873/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes问题之解惑篇2</title>
      <link href="/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%872/"/>
      <url>/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%872/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes问题之解惑篇</title>
      <link href="/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%87/"/>
      <url>/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E8%A7%A3%E6%83%91%E7%AF%87/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列四</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%974/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%974/</url>
      
        <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><a id="more"></a><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列三</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%973/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%973/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro系列三-–-micro使用"><a href="#Go-Micro系列三-–-micro使用" class="headerlink" title="Go-Micro系列三 – micro使用"></a>Go-Micro系列三 – micro使用</h2><p>go_micro框架微服务架构为srv、api</p><a id="more"></a><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列二</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%972/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%972/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro系列二-–-micro介绍以及微服务"><a href="#Go-Micro系列二-–-micro介绍以及微服务" class="headerlink" title="Go-Micro系列二 – micro介绍以及微服务"></a>Go-Micro系列二 – micro介绍以及微服务</h2><h3 id="MicroInstroduct"><a href="#MicroInstroduct" class="headerlink" title="MicroInstroduct"></a>Micro<em>Instroduct</em></h3><p>go-micro是一个go语言的微服务框架，可以大幅度的提升开发效率，并完成一套微服务的架构，其架构借用官方的图</p><p><img src="https://micro.mu/images/runtime01.svg?load" alt="img"></p><p>首先go-micro框架是一套微服务分布式的框架，其拥有以下特性：<a id="more"></a></p><ul><li>服务注册/发现</li><li>负载均衡</li><li>消息解码，并默认支持json以及protobuf</li><li>基于rpc的请求响应</li><li>异步的消息通讯</li><li>最后也是我觉得最牛的一点，接口可插拔，你可以不管用运行环境到底是使用的etcd或者consul来做服务发现，是使用http或rabbitmq做通讯，使用kafka做订阅还是用rabbitmq或者redis，是的，所有的一些都是可以插拔的，只要在运行时加入对应的启动参数，就可以使用对应的插件</li></ul><h3 id="微服务Instroduct"><a href="#微服务Instroduct" class="headerlink" title="微服务Instroduct"></a>微服务<em>Instroduct</em></h3><p><strong>微服务</strong>的概念，可以理解为，将单体应用（所有功能揉在一起的应用）拆分成 N 个小型的应用（服务），每个应用只完成很小的一部分服务，拆分的粒度没有硬性标准，一般按照业务边界进行拆分，如订单服务、用户服务这样的垂直拆分。微服务的理念在传统的单机部署中并未见到明显的优势，但当越来越多的应用被部署到云中的时候，微服务的优势就立刻体现出来了，包括：</p><img src="/passages/Go-Micro系列2/micro1.jpeg"> <p>单应用共用数据库，而微服务每个服务使用不同或相同数据库</p><ul><li>独立部署，每个服务独立去部署，独立运行于不同的进程，使得每个服务可以根据负载做部署数量调整</li><li>服务降级，当系统负载增高，需要对某些关键业务做优先增配时，可以对不关键、低级别的业务做服务降级，临时关闭某些服务来保证关键业务的稳定</li><li>功能单一，技术选型更广，由于微服务的功能相对单一，可以针对不同的微服务采用更适合的编程语言、数据库等，例如做朋友关系、二度好友功能就考虑使用neo4j的图形数据库，底层稳定性要求高的微服务则可以通过Java来开发，并发比较高的微服务则可以考虑使用Go来开发等等</li><li>后期维护隔离，对功能的后期开发升级不会影响整体的应用稳定性</li><li>单独测试，单独开发，可以使每个微服务由不同的团队去开发、去单独测试，增加了整体开发的速度</li><li>复用性，多个不同的应用可以直接复用某个微服务</li></ul><img src="/passages/Go-Micro系列2/micro2.jpeg"><p>单应用不同模块运行在单一进程中，而微服务则每个服务运行于不同的进程</p><p>而go-micro正是这样一个针对微服务开发的框架，其将所有热插拔的插件发布于<a href="https://github.com/micro/go-plugins/" target="_blank" rel="noopener">go-plugins</a>，开发者可以根据需求引用，同时在运行时追加响应的运行参数即可启用插件。</p><p>PS: <a href="https://mp.weixin.qq.com/s?__biz=MzU5MjkwNTAzNA==&amp;mid=2247483742&amp;idx=1&amp;sn=7a32c1ad0e01d577e6b6b669065bca8f&amp;chksm=fe19d77bc96e5e6d6bc23678880b6f5e923f3e5bf25ffe4117479d0b7faad1e632584b8b1b55&amp;scene=126&amp;sessionid=1587439120&amp;key=528b03e392832552fff01d7f6d7bb71cb74141bf62d10a2545ba16e56c33c6a8a9f0cab4370878c147eee86713742c1138f0430325d9e5bd626d662caf29d442242c7a258a90938d671e0fffb9eeac9d&amp;ascene=1&amp;uin=MTk3MjAxMzk4MQ%3D%3D&amp;devicetype=Windows+10&amp;version=62080079&amp;lang=zh_CN&amp;exportkey=AUB7EkRmscCAjEhbBRmp6RM%3D&amp;pass_ticket=zvIYROTKu1pgkZLFPYjFyvHC7STAirxDtBXR4TJMT%2FpbNqhaYU2SQEtJ4TnDY%2BUs" target="_blank" rel="noopener">Micro更新V2公告</a></p><p><a href="https://github.com/micro/go-micro" target="_blank" rel="noopener">Micro项目地址</a></p><p><center>更新时间：2020-04-21<center></center></center></p><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro系列一</title>
      <link href="/passages/Go-Micro%E7%B3%BB%E5%88%971/"/>
      <url>/passages/Go-Micro%E7%B3%BB%E5%88%971/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro系列一-–-入门篇"><a href="#Go-Micro系列一-–-入门篇" class="headerlink" title="Go-Micro系列一 – 入门篇"></a>Go-Micro系列一 – 入门篇</h2><p><code>go 1.13.0</code> go版本 1.12 - 1.13</p><blockquote><p>官方貌似20200227开始更新版本，关于micro的V2、GO MOD更新</p></blockquote><h3 id="安装go-micro"><a href="#安装go-micro" class="headerlink" title="安装go-micro"></a>安装go-micro</h3><h4 id="安装consul"><a href="#安装consul" class="headerlink" title="安装consul"></a>安装consul</h4><p>安装服务发现能力，<strong>docker安装consul</strong>或者<strong>本地安装运行consul</strong>，consul在本地开发环境使用方便便于调试。</p><p>1、docker安装consul<a id="more"></a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --net=host -e &apos;CONSUL_LOCAL_CONFIG=&#123;&quot;skip_leave_on_interrupt&quot;: true&#125;&apos;  --name consul_server  consul agent -server -bind=192.168.0.111 -bootstrap-expect=1  -node=node1 -client 0.0.0.0 -ui</span><br></pre></td></tr></table></figure><p>2、本地安装运行consul</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">windows:</span><br><span class="line">https://www.consul.io/downloads.html</span><br><span class="line">mac:</span><br><span class="line">https://www.consul.io/downloads.html</span><br><span class="line"></span><br><span class="line">直接下载对应操作系统的版本即可，自行添加环境变量</span><br><span class="line">consul命令即可直接运行，默认端口8500</span><br><span class="line"></span><br><span class="line">consul agent -server -bind=192.168.0.111 -bootstrap-expect=1  -node=node1 -client 0.0.0.0 -ui</span><br><span class="line">consul agent -dev  # 本地开发测试直接运行dev即可</span><br></pre></td></tr></table></figure><p>以上两种方式运行，浏览器输入<a href="http://192.168.0.111:8500/" target="_blank" rel="noopener">http://192.168.0.111:8500</a> 能看到consul的UI页面表示正常启动</p><h4 id="安装Micro"><a href="#安装Micro" class="headerlink" title="安装Micro"></a>安装Micro</h4><h5 id="基础知识补充"><a href="#基础知识补充" class="headerlink" title="基础知识补充"></a>基础知识补充</h5><p>go的包管理工具 – gomod</p><p>可参考：<a href="https://segmentfault.com/a/1190000018389353?utm_source=tag-newest" target="_blank" rel="noopener">https://segmentfault.com/a/1190000018389353?utm_source=tag-newest</a></p><p> <a href="https://segmentfault.com/a/1190000020293616?utm_source=tag-newest" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020293616?utm_source=tag-newest</a></p><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#linux/mac 下</span><br><span class="line">export GO111MODULE=on</span><br><span class="line">export GOPROXY=https://goproxy.cn,direct</span><br><span class="line"># windows下设置如下环境变量</span><br><span class="line">setx GO111MODULE on</span><br><span class="line">setx GOPROXY https://goproxy.cn,direct</span><br><span class="line"></span><br><span class="line"># go 1.12</span><br><span class="line">export GO111MODULE=on</span><br><span class="line">export GOPROXY=https://goproxy.cn</span><br><span class="line"># 使用如下指令安装</span><br><span class="line"># micro为二进制命令文件</span><br><span class="line">go get -u -v github.com/micro/micro</span><br><span class="line">go get -u -v github.com/micro/go-micro</span><br><span class="line"></span><br><span class="line">#如果没有git请自行安装git</span><br><span class="line">#下载地址</span><br><span class="line">#https://git-scm.com/downloads/</span><br></pre></td></tr></table></figure><h4 id="安装Protoc"><a href="#安装Protoc" class="headerlink" title="安装Protoc"></a>安装Protoc</h4><p>1、访问如下网址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/protocolbuffers/protobuf/releases</span><br></pre></td></tr></table></figure><p>2、下载,不同的版本文件名称不一样，Win选择protoc-xx-win64.zip，Mac选择protoc-xx-osx-x86_64.zip</p><p>3、解压到目标zip文件，添加<code>xxxxx\bin</code>到环境变量<code>path</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Win</span><br><span class="line">e:\dev\protoc-xx-win64\bin</span><br><span class="line">Mac</span><br><span class="line">/xxx/user/protoc-xx-osx-x86_64/bin</span><br></pre></td></tr></table></figure><p>PS：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/micro/protobuf/&#123;proto,protoc-gen-go&#125;</span><br></pre></td></tr></table></figure><p>发现无法用 <code>protoc-gen-go</code> 生成代码。所以我去下载了<code>protobuf</code>。</p><p>这里我是MAC系统所以，下载对应的mac版本 <a href="https://github.com/google/protobuf/releases/download/v3.0.0/protoc-3.0.0-osx-x86_64.zip" target="_blank" rel="noopener">protobuf</a>，有问题可以自行选择各种系统版本。</p><h4 id="安装protoc-gen-micro插件"><a href="#安装protoc-gen-micro插件" class="headerlink" title="安装protoc-gen-micro插件"></a>安装protoc-gen-micro插件</h4><p>这个插件主要作用是通过<code>.proto</code>文件生成适用于<code>go-micro</code>的代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u -v github.com/micro/protoc-gen-micro</span><br></pre></td></tr></table></figure><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">consul</span><br><span class="line">protoc</span><br><span class="line">micro --version</span><br></pre></td></tr></table></figure><h4 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h4><p>两种方法，一种使用micro自动生成代码，另一种手动创建；注意，手动创建可以自定义目录，自行<code>go mod init</code>，自动生成代码会生成在goPath中的指定目录。可自行选择</p><p>这里使用自动生成代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&gt;micro new $GOPATH/microapp/hello</span><br><span class="line">Creating service go.micro.srv.hello in $GOPATH\microapp\hello</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">├── main.go</span><br><span class="line">├── plugin.go</span><br><span class="line">├── handler</span><br><span class="line">│   └── hello.go</span><br><span class="line">├── subscriber</span><br><span class="line">│   └── hello.go</span><br><span class="line">├── proto\hello</span><br><span class="line">│   └── hello.proto</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── Makefile</span><br><span class="line">├── README.md</span><br><span class="line">└── go.mod</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">download protobuf for micro:</span><br><span class="line"></span><br><span class="line">brew install protobuf</span><br><span class="line">go get -u github.com/golang/protobuf/&#123;proto,protoc-gen-go&#125;</span><br><span class="line">go get -u github.com/micro/protoc-gen-micro</span><br><span class="line"></span><br><span class="line">compile the proto file hello.proto:</span><br><span class="line"></span><br><span class="line">cd $GOPATH\microapp\hello</span><br><span class="line">protoc --proto_path=.:$GOPATH/src --go_out=. --micro_out=. proto/hello/hello.proto</span><br></pre></td></tr></table></figure><h5 id="生成适配proto的golang代码"><a href="#生成适配proto的golang代码" class="headerlink" title="生成适配proto的golang代码"></a>生成适配proto的golang代码</h5><blockquote><p>注意：在win系统下<code>$GOPATH</code>环境变量无效,因此如上脚本将创建微服务失败,因此我们需要对如上脚本进行处理</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#切换到项目目录下</span><br><span class="line">&gt;cd $GOPATH\microapp\hello</span><br><span class="line"></span><br><span class="line"># 根据proto生成文件</span><br><span class="line">&gt;protoc --proto_path=. --go_out=. --micro_out=. proto/hello/hello.proto</span><br></pre></td></tr></table></figure><h5 id="启动应用"><a href="#启动应用" class="headerlink" title="启动应用"></a>启动应用</h5><p><strong>对于现在的新版本已经默认不使用consul了。可以降低micro版本或者插件代码插入consul插件即可使用consul</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#启动consul</span><br><span class="line">&gt;consul agent -dev</span><br><span class="line">#默认mdns启动</span><br><span class="line">&gt;go run main.go </span><br><span class="line">2019/08/19 13:00:46 Transport [http] Listening on [::]:54689</span><br><span class="line">2019/08/19 13:00:46 Broker [http] Connected to [::]:54690</span><br><span class="line">2019/08/19 13:00:46 Registry [mdns] Registering node: go.micro.srv.hello-4851dce2-ab5d-4e4c-801e-44dae5d93f26</span><br><span class="line">2019/08/19 13:00:46 Subscribing go.micro.srv.hello-4851dce2-ab5d-4e4c-801e-44dae5d93f26 to topic: go.micro.srv.hello</span><br><span class="line">2019/08/19 13:00:46 Subscribing go.micro.srv.hello-4851dce2-ab5d-4e4c-801e-44dae5d93f26 to topic: go.micro.srv.hello</span><br><span class="line"></span><br><span class="line">#指定registry只需要添加参数即可，默认使用端口8500</span><br><span class="line">&gt;go run main.go --registry=consul</span><br><span class="line"></span><br><span class="line">## 注意这里没有指定注册consul，默认使用mdns（windows中无法使用mdns，并不是注册中心，使用的广播）</span><br><span class="line">## 了解mdns，自行查看</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在mian.go目录下新建一个插件文件plugins.go</span></span><br><span class="line"><span class="comment">// cat plugins.go 导入consul插件即可</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="string">"github.com/micro/go-plugins/registry/consul"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用的时候或者build带上plugins文件</span></span><br><span class="line"><span class="comment">// go run main.go plugins.go --registry=consul</span></span><br></pre></td></tr></table></figure><p><a href="https://micro.mu/docs/" target="_blank" rel="noopener">官方文档附上链接</a></p><h5 id="查看是否启动"><a href="#查看是否启动" class="headerlink" title="查看是否启动"></a>查看是否启动</h5><p><strong>这里说一个micro需要跟go-micro的版本兼容，不然无法使用micro命令</strong></p><p><strong>当然，如果你后期不适用micro api，micro命令不用也没关系</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#也可以去consul的ui查看，更加直观</span><br><span class="line">&gt;micro list services --registry=consul</span><br><span class="line">go.micro.srv.hello</span><br><span class="line">topic:go.micro.srv.hello</span><br></pre></td></tr></table></figure><h5 id="启动restful-api接口支持支持"><a href="#启动restful-api接口支持支持" class="headerlink" title="启动restful api接口支持支持"></a>启动restful api接口支持支持</h5><p>注意其中的–namespace参数,我们每一个微服务都属于一个命名空间,通过api暴露出来该命名空间后,满足<code>go.micro.srv.*</code>格式的微服务都可以访问。如<code>go.micro.srv.hello</code>可以通过如下格式访问</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:8080/user/call</span><br><span class="line">&gt;micro api --namespace=go.micro.srv --registry=consul</span><br><span class="line">2019/08/19 13:07:11 Registering API Default Handler at /</span><br><span class="line">2019/08/19 13:07:11 HTTP API Listening on [::]:8080</span><br><span class="line">2019/08/19 13:07:11 Transport [http] Listening on [::]:54934</span><br><span class="line">2019/08/19 13:07:11 Broker [http] Connected to [::]:54935</span><br><span class="line">2019/08/19 13:07:11 Registry [consul] Registering node: go.micro.api-1753185c-b8e1-49c4-aa0f-617f243a8e2a</span><br></pre></td></tr></table></figure><h5 id="验证api接口"><a href="#验证api接口" class="headerlink" title="验证api接口"></a>验证api接口</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST -d &quot;&#123;name: nihao&#125;&quot; http://127.0.0.1:8080/user/call -H &quot;Content-Type:application/json&quot;</span><br><span class="line"></span><br><span class="line"># output: hello nihao</span><br></pre></td></tr></table></figure><h3 id="系列链接"><a href="#系列链接" class="headerlink" title="系列链接"></a>系列链接</h3><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p><p>-&gt; </p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Go-Micro相关</title>
      <link href="/passages/Go-Micro%E7%9B%B8%E5%85%B3/"/>
      <url>/passages/Go-Micro%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<h2 id="Go-Micro的那些"><a href="#Go-Micro的那些" class="headerlink" title="Go-Micro的那些"></a>Go-Micro的那些</h2><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
            <tag> Go-Micro </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React相关</title>
      <link href="/passages/React%E7%9B%B8%E5%85%B3/"/>
      <url>/passages/React%E7%9B%B8%E5%85%B3/</url>
      
        <content type="html"><![CDATA[<p>TODO</p><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Ceph集群部署</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BCeph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BCeph%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h3 id="CentOS7下安装Ceph供Kubernetes使用"><a href="#CentOS7下安装Ceph供Kubernetes使用" class="headerlink" title="CentOS7下安装Ceph供Kubernetes使用"></a>CentOS7下安装Ceph供Kubernetes使用</h3><h4 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">系统：CentOS7，一个非系统分区分配给ceph</span><br><span class="line">docker：18.06-ce</span><br><span class="line">kubernetes：1.11.3</span><br><span class="line">ceph：luminous</span><br></pre></td></tr></table></figure><h4 id="Ceph部署准备"><a href="#Ceph部署准备" class="headerlink" title="Ceph部署准备"></a>Ceph部署准备<a id="more"></a></h4><h5 id="节点规划"><a href="#节点规划" class="headerlink" title="节点规划"></a>节点规划</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">192.168.105.92 lab1  # master1</span><br><span class="line">192.168.105.93 lab2  # master2</span><br><span class="line">192.168.105.94 lab3  # master3</span><br><span class="line">192.168.105.95 lab4  # node4</span><br><span class="line">192.168.105.96 lab5  # node5</span><br><span class="line">192.168.105.97 lab6  # node6</span><br><span class="line">192.168.105.98 lab7  # node7</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">监控节点：lab1、lab2、lab3</span><br><span class="line">OSD节点：lab4、lab5、lab6、lab7</span><br><span class="line">MDS节点：lab4</span><br></pre></td></tr></table></figure><h5 id="添加yum源"><a href="#添加yum源" class="headerlink" title="添加yum源"></a>添加yum源</h5><p>我们使用阿里云yum源：(CeontOS和epel也是阿里云yum源)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/yum.repos.d/ceph.repo</span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-luminous/el7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-luminous/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=https://mirrors.aliyun.com/ceph/rpm-luminous/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">type=rpm-md</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/ceph/keys/release.asc</span><br></pre></td></tr></table></figure><p>注意：ceph集群中节点都需要添加该yum源</p><h5 id="安装Ceph部署工具"><a href="#安装Ceph部署工具" class="headerlink" title="安装Ceph部署工具"></a>安装Ceph部署工具</h5><p><strong>以下操作在lab1上root用户操作</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">安装 ceph-deploy</span><br><span class="line">yum -y install ceph-deploy</span><br></pre></td></tr></table></figure><h5 id="安装时间同步工具chrony"><a href="#安装时间同步工具chrony" class="headerlink" title="安装时间同步工具chrony"></a>安装时间同步工具chrony</h5><p>以下操作在所有ceph节点root用户操作</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改/etc/chrony.conf前面的server段为如下</span></span><br><span class="line">server ntp1.aliyun.com iburst</span><br><span class="line">server ntp2.aliyun.com iburst</span><br><span class="line">server ntp3.aliyun.com iburst</span><br><span class="line">server ntp4.aliyun.com iburst</span><br></pre></td></tr></table></figure><h5 id="安装SSH服务"><a href="#安装SSH服务" class="headerlink" title="安装SSH服务"></a>安装SSH服务</h5><p>默认已正常运行，略</p><h5 id="创建部署-CEPH-的用户"><a href="#创建部署-CEPH-的用户" class="headerlink" title="创建部署 CEPH 的用户"></a>创建部署 CEPH 的用户</h5><p><strong>以下操作在所有ceph节点root用户操作</strong></p><p>ceph-deploy 工具必须以普通用户登录 Ceph 节点，且此用户拥有无密码使用 sudo 的权限，因为它需要在安装软件及配置文件的过程中，不必输入密码。</p><p>较新版的 ceph-deploy 支持用 –username 选项提供可无密码使用 sudo 的用户名（包括 root ，虽然不建议这样做）。使用 ceph-deploy –username {username} 命令时，指定的用户必须能够通过无密码 SSH 连接到 Ceph 节点，因为 ceph-deploy 中途不会提示输入密码。</p><p>建议在集群内的所有 Ceph 节点上给 ceph-deploy 创建一个特定的用户，但不要用 “ceph” 这个名字。全集群统一的用户名可简化操作（非必需），然而你应该避免使用知名用户名，因为黑客们会用它做暴力破解（如 root 、 admin 、 {productname} ）。后续步骤描述了如何创建无 sudo 密码的用户，你要用自己取的名字替换 {username} 。</p><p>注意：<br>从 Infernalis 版起，用户名 “ceph” 保留给了 Ceph 守护进程。如果 Ceph 节点上已经有了 “ceph” 用户，升级前必须先删掉这个用户。</p><p><strong>我们使用用户名ceph-admin</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username="ceph-admin"</span><br><span class="line">useradd $&#123;username&#125; &amp;&amp; echo 'PASSWORD' | passwd $&#123;ceph-admin&#125; --stdinecho "$&#123;username&#125; ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod 0440 /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod a+x /etc/sudoers.d/</span><br></pre></td></tr></table></figure><h5 id="允许无密码-SSH-登录"><a href="#允许无密码-SSH-登录" class="headerlink" title="允许无密码 SSH 登录"></a>允许无密码 SSH 登录</h5><p>以下操作在lab1节点ceph-admin用户操作</p><p>正因为 ceph-deploy 不支持输入密码，你必须在管理节点上生成 SSH 密钥并把其公钥分发到各 Ceph 节点。 ceph-deploy 会尝试给初始 monitors 生成 SSH 密钥对。</p><p>生成 SSH 密钥对，但不要用 sudo 或 root 用户。提示 “Enter passphrase” 时，直接回车，口令即为空：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">su - ceph-admin  # 切换到此用户，因为ceph-deploy也用此用户</span><br><span class="line">ssh-keygen</span><br><span class="line"></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/ceph-admin/.ssh/id_rsa): </span><br><span class="line">/home/ceph-admin/.ssh/id_rsa already exists.</span><br><span class="line">Overwrite (y/n)? y</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /home/ceph-admin/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /home/ceph-admin/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br></pre></td></tr></table></figure><p>把公钥拷贝到各 Ceph 节点，把下列命令中的 {username} 替换成前面创建部署 Ceph 的用户里的用户名。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">username="ceph-admin"</span><br><span class="line">ssh-copy-id $&#123;username&#125;@lab1</span><br><span class="line">ssh-copy-id $&#123;username&#125;@lab2</span><br><span class="line">ssh-copy-id $&#123;username&#125;@lab3</span><br></pre></td></tr></table></figure><p>（推荐做法）修改 ceph-deploy 管理节点上的 ~/.ssh/config 文件，这样 ceph-deploy 就能用你所建的用户名登录 Ceph 节点了，而无需每次执行 ceph-deploy 都要指定 –username {username} 。这样做同时也简化了 ssh 和 scp 的用法。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Host lab1</span><br><span class="line">   Hostname lab1</span><br><span class="line">   User ceph-admin</span><br><span class="line">Host lab2</span><br><span class="line">   Hostname lab2</span><br><span class="line">   User ceph-admin</span><br><span class="line">Host lab3</span><br><span class="line">   Hostname lab3</span><br><span class="line">   User ceph-admin</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Bad owner or permissions on /home/ceph-admin/.ssh/config</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要用chmod 600 ~/.ssh/config解决。</span></span><br></pre></td></tr></table></figure><h5 id="开放所需端口"><a href="#开放所需端口" class="headerlink" title="开放所需端口"></a>开放所需端口</h5><blockquote><p>以下操作在所有监视器节点<code>root</code>用户操作</p></blockquote><p>Ceph Monitors 之间默认使用 <code>6789</code> 端口通信， OSD 之间默认用 6800:7300 这个范围内的端口通信。</p><p><code>firewall-cmd --zone=public --add-port=6789/tcp --permanent &amp;&amp; firewall-cmd --reload</code></p><h5 id="终端（-TTY-）"><a href="#终端（-TTY-）" class="headerlink" title="终端（ TTY ）"></a>终端（ TTY ）</h5><blockquote><p>以下操作在所有ceph节点root用户操作</p></blockquote><p>在 CentOS 和 RHEL 上执行 ceph-deploy 命令时可能会报错。如果你的 Ceph 节点默认设置了 requiretty ，执行 sudo visudo 禁用它，并找到 Defaults requiretty 选项，把它改为 Defaults:ceph !requiretty 或者直接注释掉，这样 ceph-deploy 就可以用之前创建的用户（创建部署 Ceph 的用户 ）连接了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i -r 's@Defaults(.*)!visiblepw@Defaults:ceph-admin\1!visiblepw@g' /etc/sudoers</span><br></pre></td></tr></table></figure><h5 id="SELINUX"><a href="#SELINUX" class="headerlink" title="SELINUX"></a>SELINUX</h5><blockquote><p>以下操作在所有ceph节点root用户操作</p></blockquote><p>如果原来是开启的，需要重启生效。</p><p>永久关闭 修改/etc/sysconfig/selinux文件设置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux</span><br></pre></td></tr></table></figure><h5 id="整理以上所有ceph节点操作"><a href="#整理以上所有ceph节点操作" class="headerlink" title="整理以上所有ceph节点操作"></a>整理以上所有ceph节点操作</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl enable chronyd</span><br><span class="line"></span><br><span class="line">username="ceph-admin"</span><br><span class="line">useradd $&#123;username&#125; &amp;&amp; echo 'PASSWORD' | passwd $&#123;username&#125; --stdin</span><br><span class="line">echo "$&#123;username&#125; ALL = (root) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod 0440 /etc/sudoers.d/$&#123;username&#125;</span><br><span class="line">chmod a+x /etc/sudoers.d/</span><br><span class="line">sed -i -r 's@Defaults(.*)!visiblepw@Defaults:ceph-admin\1!visiblepw@g' /etc/sudoers</span><br><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/sysconfig/selinux</span><br><span class="line">yum -y install ceph</span><br></pre></td></tr></table></figure><h4 id="存储集群部署"><a href="#存储集群部署" class="headerlink" title="存储集群部署"></a>存储集群部署</h4><blockquote><p>以下操作在lab节点<code>ceph-admin</code>用户操作</p></blockquote><p>我们创建一个 Ceph 存储集群，它有一个 Monitor 和两个 OSD 守护进程。一旦集群达到 active + clean 状态，再扩展它：增加第三个 OSD 、增加元数据服务器和两个 Ceph Monitors。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su - ceph-admin</span><br><span class="line">mkdir ceph-cluster</span><br></pre></td></tr></table></figure><p>如果在某些地方碰到麻烦，想从头再来，可以用下列命令清除配置：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy purgedata &#123;ceph-node&#125; [&#123;ceph-node&#125;]</span><br><span class="line">ceph-deploy forgetkeys</span><br><span class="line">rm -rf /etc/ceph/*</span><br><span class="line">rm -rf /var/lib/ceph/*/*</span><br><span class="line">rm -rf /var/log/ceph/*</span><br><span class="line">rm -rf /var/run/ceph/*</span><br></pre></td></tr></table></figure><h5 id="创建集群并准备配置"><a href="#创建集群并准备配置" class="headerlink" title="创建集群并准备配置"></a>创建集群并准备配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ceph-cluster</span><br><span class="line">ceph-deploy new lab1</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ls -l</span><br><span class="line">total 24</span><br><span class="line">-rw-rw-r-- 1 ceph-admin ceph-admin   196 Aug 17 14:31 ceph.conf</span><br><span class="line">-rw-rw-r-- 1 ceph-admin ceph-admin 12759 Aug 17 14:31 ceph-deploy-ceph.log</span><br><span class="line">-rw------- 1 ceph-admin ceph-admin    73 Aug 17 14:31 ceph.mon.keyring</span><br><span class="line">[ceph-admin@lab1 ceph-cluster]$ more ceph.mon.keyring </span><br><span class="line">[mon.]</span><br><span class="line">key = AQC2a3ZbAAAAABAAor15nkYQCXuC681B/Q53og==</span><br><span class="line">caps mon = allow *</span><br><span class="line">[ceph-admin@lab1 ceph-cluster]$ more ceph.conf </span><br><span class="line">[global]</span><br><span class="line">fsid = fb212173-233c-4c5e-a98e-35be9359f8e2</span><br><span class="line">mon_initial_members = lab1</span><br><span class="line">mon_host = 192.168.105.92</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br></pre></td></tr></table></figure><p>把 Ceph 配置文件里的默认副本数从 3 改成 2 ，这样只有两个 OSD 也可以达到 active + clean 状态。把下面这行加入 [global] 段：</p><p><code>osd pool default size = 2</code></p><p>再把 <code>public network</code> 写入 Ceph 配置文件的<code>[global]</code>段下</p><p><code>public network = 192.168.105.0/24</code></p><p>安装 Ceph</p><p><code>ceph-deploy install lab1 lab4 lab5 --no-adjust-repos</code></p><p>配置monitor(s)并收集所有密钥：</p><p><code>ceph-deploy mon create-initial</code></p><p>完成上述操作后，当前目录里应该会出现这些密钥环：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy mon create-initial</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy mon create-initial</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : create-initial</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x1160f38&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function mon at 0x115c2a8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  keyrings                      : None</span><br><span class="line">[ceph_deploy.mon][DEBUG ] Deploying mon, cluster ceph hosts lab1</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host lab1 ...</span><br><span class="line">[lab1][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab1][DEBUG ] connected to host: lab1 </span><br><span class="line">[lab1][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab1][DEBUG ] detect machine type</span><br><span class="line">[lab1][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO ] distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[lab1][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[lab1][DEBUG ] get remote short hostname</span><br><span class="line">[lab1][DEBUG ] deploying mon to lab1</span><br><span class="line">[lab1][DEBUG ] get remote short hostname</span><br><span class="line">[lab1][DEBUG ] remote hostname: lab1</span><br><span class="line">[lab1][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[lab1][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[lab1][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-lab1/done</span><br><span class="line">[lab1][DEBUG ] done path does not exist: /var/lib/ceph/mon/ceph-lab1/done</span><br><span class="line">[lab1][INFO ] creating keyring file: /var/lib/ceph/tmp/ceph-lab1.mon.keyring</span><br><span class="line">[lab1][DEBUG ] create the monitor keyring file</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph-mon --cluster ceph --mkfs -i lab1 --keyring /var/lib/ceph/tmp/ceph-lab1.mon.keyring --setuser 167 --setgroup 167</span><br><span class="line">[lab1][INFO ] unlinking keyring file /var/lib/ceph/tmp/ceph-lab1.mon.keyring</span><br><span class="line">[lab1][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[lab1][DEBUG ] create the init path if it does not exist</span><br><span class="line">[lab1][INFO ] Running command: sudo systemctl enable ceph.target</span><br><span class="line">[lab1][INFO ] Running command: sudo systemctl enable ceph-mon@lab1</span><br><span class="line">[lab1][INFO ] Running command: sudo systemctl start ceph-mon@lab1</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[lab1][DEBUG ] ********************************************************************************</span><br><span class="line">[lab1][DEBUG ] status for monitor: mon.lab1</span><br><span class="line">[lab1][DEBUG ] &#123;</span><br><span class="line">[lab1][DEBUG ]   "election_epoch": 3, </span><br><span class="line">[lab1][DEBUG ]   "extra_probe_peers": [], </span><br><span class="line">[lab1][DEBUG ]   "feature_map": &#123;</span><br><span class="line">[lab1][DEBUG ]     "mon": &#123;</span><br><span class="line">[lab1][DEBUG ]       "group": &#123;</span><br><span class="line">[lab1][DEBUG ]         "features": "0x3ffddff8eea4fffb", </span><br><span class="line">[lab1][DEBUG ]         "num": 1, </span><br><span class="line">[lab1][DEBUG ]         "release": "luminous"</span><br><span class="line">[lab1][DEBUG ]       &#125;</span><br><span class="line">[lab1][DEBUG ]     &#125;</span><br><span class="line">[lab1][DEBUG ]   &#125;, </span><br><span class="line">[lab1][DEBUG ]   "features": &#123;</span><br><span class="line">[lab1][DEBUG ]     "quorum_con": "4611087853745930235", </span><br><span class="line">[lab1][DEBUG ]     "quorum_mon": [</span><br><span class="line">[lab1][DEBUG ]       "kraken", </span><br><span class="line">[lab1][DEBUG ]       "luminous"</span><br><span class="line">[lab1][DEBUG ]     ], </span><br><span class="line">[lab1][DEBUG ]     "required_con": "153140804152475648", </span><br><span class="line">[lab1][DEBUG ]     "required_mon": [</span><br><span class="line">[lab1][DEBUG ]       "kraken", </span><br><span class="line">[lab1][DEBUG ]       "luminous"</span><br><span class="line">[lab1][DEBUG ]     ]</span><br><span class="line">[lab1][DEBUG ]   &#125;, </span><br><span class="line">[lab1][DEBUG ]   "monmap": &#123;</span><br><span class="line">[lab1][DEBUG ]     "created": "2018-08-17 14:46:18.770540", </span><br><span class="line">[lab1][DEBUG ]     "epoch": 1, </span><br><span class="line">[lab1][DEBUG ]     "features": &#123;</span><br><span class="line">[lab1][DEBUG ]       "optional": [], </span><br><span class="line">[lab1][DEBUG ]       "persistent": [</span><br><span class="line">[lab1][DEBUG ]         "kraken", </span><br><span class="line">[lab1][DEBUG ]         "luminous"</span><br><span class="line">[lab1][DEBUG ]       ]</span><br><span class="line">[lab1][DEBUG ]     &#125;, </span><br><span class="line">[lab1][DEBUG ]     "fsid": "fb212173-233c-4c5e-a98e-35be9359f8e2", </span><br><span class="line">[lab1][DEBUG ]     "modified": "2018-08-17 14:46:18.770540", </span><br><span class="line">[lab1][DEBUG ]     "mons": [</span><br><span class="line">[lab1][DEBUG ]       &#123;</span><br><span class="line">[lab1][DEBUG ]         "addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab1][DEBUG ]         "name": "lab1", </span><br><span class="line">[lab1][DEBUG ]         "public_addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab1][DEBUG ]         "rank": 0</span><br><span class="line">[lab1][DEBUG ]       &#125;</span><br><span class="line">[lab1][DEBUG ]     ]</span><br><span class="line">[lab1][DEBUG ]   &#125;, </span><br><span class="line">[lab1][DEBUG ]   "name": "lab1", </span><br><span class="line">[lab1][DEBUG ]   "outside_quorum": [], </span><br><span class="line">[lab1][DEBUG ]   "quorum": [</span><br><span class="line">[lab1][DEBUG ]     0</span><br><span class="line">[lab1][DEBUG ]   ], </span><br><span class="line">[lab1][DEBUG ]   "rank": 0, </span><br><span class="line">[lab1][DEBUG ]   "state": "leader", </span><br><span class="line">[lab1][DEBUG ]   "sync_provider": []</span><br><span class="line">[lab1][DEBUG ] &#125;</span><br><span class="line">[lab1][DEBUG ] ********************************************************************************</span><br><span class="line">[lab1][INFO ] monitor: mon.lab1 is running</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO ] processing monitor mon.lab1</span><br><span class="line">[lab1][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab1][DEBUG ] connected to host: lab1 </span><br><span class="line">[lab1][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab1][DEBUG ] detect machine type</span><br><span class="line">[lab1][DEBUG ] find the location of an executable</span><br><span class="line">[lab1][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[ceph_deploy.mon][INFO ] mon.lab1 monitor has reached quorum!</span><br><span class="line">[ceph_deploy.mon][INFO ] all initial monitors are running and have formed quorum</span><br><span class="line">[ceph_deploy.mon][INFO ] Running gatherkeys...</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing keys in temp directory /tmp/tmpfUkCWD</span><br><span class="line">[lab1][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab1][DEBUG ] connected to host: lab1 </span><br><span class="line">[lab1][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab1][DEBUG ] detect machine type</span><br><span class="line">[lab1][DEBUG ] get remote short hostname</span><br><span class="line">[lab1][DEBUG ] fetch remote file</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --admin-daemon=/var/run/ceph/ceph-mon.lab1.asok mon_status</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.admin</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.admin osd allow * mds allow * mon allow * mgr allow *</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-mds</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-mds mon allow profile bootstrap-mds</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-mgr</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-mgr mon allow profile bootstrap-mgr</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-osd</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-osd mon allow profile bootstrap-osd</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get client.bootstrap-rgw</span><br><span class="line">[lab1][INFO ] Running command: sudo /usr/bin/ceph --connect-timeout=25 --cluster=ceph --name mon. --keyring=/var/lib/ceph/mon/ceph-lab1/keyring auth get-or-create client.bootstrap-rgw mon allow profile bootstrap-rgw</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.client.admin.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-mds.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-mgr.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] keyring 'ceph.mon.keyring' already exists</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-osd.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Storing ceph.bootstrap-rgw.keyring</span><br><span class="line">[ceph_deploy.gatherkeys][INFO ] Destroy temp directory /tmp/tmpfUkCWD</span><br></pre></td></tr></table></figure><p>用 ceph-deploy 把配置文件和 admin 密钥拷贝到管理节点和 Ceph 节点，这样你每次执行 Ceph 命令行时就无需指定 <code>monitor</code> 地址和<code>ceph.client.admin.keyring</code>了。</p><p><code>ceph-deploy admin lab1 lab4 lab5</code></p><blockquote><p>注意<br>ceph-deploy 和本地管理主机（ admin-node ）通信时，必须通过主机名可达。必要时可修改 /etc/hosts ，加入管理主机的名字。</p></blockquote><p>确保你对 ceph.client.admin.keyring 有正确的操作权限。</p><p><code>sudo chmod +r /etc/ceph/ceph.client.admin.keyring</code></p><p>安装mrg</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mgr create lab1</span><br><span class="line">ceph-deploy mgr create lab2</span><br><span class="line">ceph-deploy mgr create lab3</span><br></pre></td></tr></table></figure><p>检查集群的健康状况。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph health</span><br><span class="line">HEALTH_OK</span><br></pre></td></tr></table></figure><h5 id="增加OSD"><a href="#增加OSD" class="headerlink" title="增加OSD"></a>增加OSD</h5><p>列举磁盘并擦净</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy disk list lab4</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy disk list lab4</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  debug                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : list</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x20d97e8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  host                          : ['lab4']</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function disk at 0x20ca7d0&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[lab4][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab4][DEBUG ] connected to host: lab4 </span><br><span class="line">[lab4][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab4][DEBUG ] detect machine type</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo fdisk -l</span><br><span class="line">[lab4][INFO ] Disk /dev/sda: 107.4 GB, 107374182400 bytes, 209715200 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/sdb: 214.7 GB, 214748364800 bytes, 419430400 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/cl-root: 97.8 GB, 97840529408 bytes, 191094784 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/cl-swap: 8455 MB, 8455716864 bytes, 16515072 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43_tmeta: 12 MB, 12582912 bytes, 24576 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43_tdata: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43-tpool: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-tp_1f4ce4f4bfb224aa385f35516236af43: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[lab4][INFO ] Disk /dev/mapper/vg_a66945efa6324ffeb209d165cac8ede9-brick_1f4ce4f4bfb224aa385f35516236af43: 2147 MB, 2147483648 bytes, 4194304 sectors</span><br><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy disk zap lab4 /dev/sdb</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy disk zap lab4 /dev/sdb</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  debug                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : zap</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0xd447e8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  host                          : lab4</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function disk at 0xd357d0&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  disk                          : ['/dev/sdb']</span><br><span class="line">[ceph_deploy.osd][DEBUG ] zapping /dev/sdb on lab4</span><br><span class="line">[lab4][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab4][DEBUG ] connected to host: lab4 </span><br><span class="line">[lab4][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab4][DEBUG ] detect machine type</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.osd][INFO ] Distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[lab4][DEBUG ] zeroing last few blocks of device</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo /usr/sbin/ceph-volume lvm zap /dev/sdb</span><br><span class="line">[lab4][DEBUG ] --&gt; Zapping: /dev/sdb</span><br><span class="line">[lab4][DEBUG ] Running command: /usr/sbin/cryptsetup status /dev/mapper/</span><br><span class="line">[lab4][DEBUG ]  stdout: /dev/mapper/ is inactive.</span><br><span class="line">[lab4][DEBUG ] Running command: wipefs --all /dev/sdb</span><br><span class="line">[lab4][DEBUG ] Running command: dd if=/dev/zero of=/dev/sdb bs=1M count=10</span><br><span class="line">[lab4][DEBUG ] --&gt; Zapping successful for: /dev/sdb</span><br></pre></td></tr></table></figure><p>同理，lab5的sdb也一样。</p><p>创建pv、vg、lv，略。</p><p>创建 OSD</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy osd create lab4 --fs-type btrfs --data vg1/lvol0     </span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy osd create lab4 --fs-type btrfs --data vg1/lvol0</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  bluestore                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x26d4908&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  fs_type                       : btrfs</span><br><span class="line">[ceph_deploy.cli][INFO ]  block_wal                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  journal                       : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : create</span><br><span class="line">[ceph_deploy.cli][INFO ]  host                          : lab4</span><br><span class="line">[ceph_deploy.cli][INFO ]  filestore                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function osd at 0x26c4758&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  zap_disk                      : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  data                          : vg1/lvol0</span><br><span class="line">[ceph_deploy.cli][INFO ]  block_db                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  dmcrypt                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  dmcrypt_key_dir               : /etc/ceph/dmcrypt-keys</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  debug                         : False</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Creating OSD on cluster ceph with data device vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab4][DEBUG ] connected to host: lab4 </span><br><span class="line">[lab4][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab4][DEBUG ] detect machine type</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.osd][INFO ] Distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Deploying osd to lab4</span><br><span class="line">[lab4][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo /usr/sbin/ceph-volume --cluster ceph lvm create --bluestore --data vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph-authtool --gen-print-key</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring -i - osd new 7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph-authtool --gen-print-key</span><br><span class="line">[lab4][DEBUG ] Running command: mount -t tmpfs tmpfs /var/lib/ceph/osd/ceph-1</span><br><span class="line">[lab4][DEBUG ] Running command: chown -h ceph:ceph /dev/vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /dev/dm-2</span><br><span class="line">[lab4][DEBUG ] Running command: ln -s /dev/vg1/lvol0 /var/lib/ceph/osd/ceph-1/block</span><br><span class="line">[lab4][DEBUG ] Running command: ceph --cluster ceph --name client.bootstrap-osd --keyring /var/lib/ceph/bootstrap-osd/ceph.keyring mon getmap -o /var/lib/ceph/osd/ceph-1/activate.monmap</span><br><span class="line">[lab4][DEBUG ]  stderr: got monmap epoch 1</span><br><span class="line">[lab4][DEBUG ] Running command: ceph-authtool /var/lib/ceph/osd/ceph-1/keyring --create-keyring --name osd.1 --add-key AQAmjHZbiiGUChAAVCWdPZqHms99mLgSZ7M+fQ==</span><br><span class="line">[lab4][DEBUG ]  stdout: creating /var/lib/ceph/osd/ceph-1/keyring</span><br><span class="line">[lab4][DEBUG ] added entity osd.1 auth auth(auid = 18446744073709551615 key=AQAmjHZbiiGUChAAVCWdPZqHms99mLgSZ7M+fQ== with 0 caps)</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-1/keyring</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-1/</span><br><span class="line">[lab4][DEBUG ] Running command: /bin/ceph-osd --cluster ceph --osd-objectstore bluestore --mkfs -i 1 --monmap /var/lib/ceph/osd/ceph-1/activate.monmap --keyfile - --osd-data /var/lib/ceph/osd/ceph-1/ --osd-uuid 7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62 --setuser ceph --setgroup ceph</span><br><span class="line">[lab4][DEBUG ] --&gt; ceph-volume lvm prepare successful for: vg1/lvol0</span><br><span class="line">[lab4][DEBUG ] Running command: ceph-bluestore-tool --cluster=ceph prime-osd-dir --dev /dev/vg1/lvol0 --path /var/lib/ceph/osd/ceph-1</span><br><span class="line">[lab4][DEBUG ] Running command: ln -snf /dev/vg1/lvol0 /var/lib/ceph/osd/ceph-1/block</span><br><span class="line">[lab4][DEBUG ] Running command: chown -h ceph:ceph /var/lib/ceph/osd/ceph-1/block</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /dev/dm-2</span><br><span class="line">[lab4][DEBUG ] Running command: chown -R ceph:ceph /var/lib/ceph/osd/ceph-1</span><br><span class="line">[lab4][DEBUG ] Running command: systemctl enable ceph-volume@lvm-1-7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62</span><br><span class="line">[lab4][DEBUG ]  stderr: Created symlink from /etc/systemd/system/multi-user.target.wants/ceph-volume@lvm-1-7bb2b8f4-9e9d-4cd2-a2da-802a953a4d62.service to /usr/lib/systemd/system/ceph-volume@.service.</span><br><span class="line">[lab4][DEBUG ] Running command: systemctl start ceph-osd@1</span><br><span class="line">[lab4][DEBUG ] --&gt; ceph-volume lvm activate successful for osd ID: 1</span><br><span class="line">[lab4][DEBUG ] --&gt; ceph-volume lvm create successful for: vg1/lvol0</span><br><span class="line">[lab4][INFO ] checking OSD status...</span><br><span class="line">[lab4][DEBUG ] find the location of an executable</span><br><span class="line">[lab4][INFO ] Running command: sudo /bin/ceph --cluster=ceph osd stat --format=json</span><br><span class="line">[lab4][WARNIN] there is 1 OSD down</span><br><span class="line">[lab4][WARNIN] there is 1 OSD out</span><br><span class="line">[ceph_deploy.osd][DEBUG ] Host lab4 is now ready for osd use.</span><br></pre></td></tr></table></figure><p><code>ceph-deploy osd create lab5 --fs-type btrfs --data vg1/lvol0</code></p><h4 id="扩展集群"><a href="#扩展集群" class="headerlink" title="扩展集群"></a>扩展集群</h4><p>一个基本的集群启动并开始运行后，下一步就是扩展集群。在 lab6、lab7 各上添加一个 OSD 守护进程和一个元数据服务器。然后分别在 lab2 和 lab3 上添加 <code>Ceph Monitor</code>，以形成 Monitors 的法定人数。</p><p>添加 MONITORS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ceph-deploy mon add lab2</span><br><span class="line">ceph-deploy mon add lab3</span><br></pre></td></tr></table></figure><p>过程：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph-deploy mon add lab3</span><br><span class="line">[ceph_deploy.conf][DEBUG ] found configuration file at: /home/ceph-admin/.cephdeploy.conf</span><br><span class="line">[ceph_deploy.cli][INFO ] Invoked (2.0.1): /bin/ceph-deploy mon add lab3</span><br><span class="line">[ceph_deploy.cli][INFO ] ceph-deploy options:</span><br><span class="line">[ceph_deploy.cli][INFO ]  username                      : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  verbose                       : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  overwrite_conf                : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  subcommand                    : add</span><br><span class="line">[ceph_deploy.cli][INFO ]  quiet                         : False</span><br><span class="line">[ceph_deploy.cli][INFO ]  cd_conf                       : &lt;ceph_deploy.conf.cephdeploy.Conf instance at 0x29f0f38&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  cluster                       : ceph</span><br><span class="line">[ceph_deploy.cli][INFO ]  mon                           : ['lab3']</span><br><span class="line">[ceph_deploy.cli][INFO ]  func                          : &lt;function mon at 0x29ec2a8&gt;</span><br><span class="line">[ceph_deploy.cli][INFO ]  address                       : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  ceph_conf                     : None</span><br><span class="line">[ceph_deploy.cli][INFO ]  default_release               : False</span><br><span class="line">[ceph_deploy.mon][INFO ] ensuring configuration of new mon host: lab3</span><br><span class="line">[ceph_deploy.admin][DEBUG ] Pushing admin keys and conf to lab3</span><br><span class="line">[lab3][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab3][DEBUG ] connected to host: lab3 </span><br><span class="line">[lab3][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab3][DEBUG ] detect machine type</span><br><span class="line">[lab3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[ceph_deploy.mon][DEBUG ] Adding mon to cluster ceph, host lab3</span><br><span class="line">[ceph_deploy.mon][DEBUG ] using mon address by resolving host: 192.168.105.94</span><br><span class="line">[ceph_deploy.mon][DEBUG ] detecting platform for host lab3 ...</span><br><span class="line">[lab3][DEBUG ] connection detected need for sudo</span><br><span class="line">[lab3][DEBUG ] connected to host: lab3 </span><br><span class="line">[lab3][DEBUG ] detect platform information from remote host</span><br><span class="line">[lab3][DEBUG ] detect machine type</span><br><span class="line">[lab3][DEBUG ] find the location of an executable</span><br><span class="line">[ceph_deploy.mon][INFO ] distro info: CentOS Linux 7.5.1804 Core</span><br><span class="line">[lab3][DEBUG ] determining if provided host has same hostname in remote</span><br><span class="line">[lab3][DEBUG ] get remote short hostname</span><br><span class="line">[lab3][DEBUG ] adding mon to lab3</span><br><span class="line">[lab3][DEBUG ] get remote short hostname</span><br><span class="line">[lab3][DEBUG ] write cluster configuration to /etc/ceph/&#123;cluster&#125;.conf</span><br><span class="line">[lab3][DEBUG ] create the mon path if it does not exist</span><br><span class="line">[lab3][DEBUG ] checking for done path: /var/lib/ceph/mon/ceph-lab3/done</span><br><span class="line">[lab3][DEBUG ] done path does not exist: /var/lib/ceph/mon/ceph-lab3/done</span><br><span class="line">[lab3][INFO ] creating keyring file: /var/lib/ceph/tmp/ceph-lab3.mon.keyring</span><br><span class="line">[lab3][DEBUG ] create the monitor keyring file</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph --cluster ceph mon getmap -o /var/lib/ceph/tmp/ceph.lab3.monmap</span><br><span class="line">[lab3][WARNIN] got monmap epoch 2</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph-mon --cluster ceph --mkfs -i lab3 --monmap /var/lib/ceph/tmp/ceph.lab3.monmap --keyring /var/lib/ceph/tmp/ceph-lab3.mon.keyring --setuser 167 --setgroup 167</span><br><span class="line">[lab3][INFO ] unlinking keyring file /var/lib/ceph/tmp/ceph-lab3.mon.keyring</span><br><span class="line">[lab3][DEBUG ] create a done file to avoid re-doing the mon deployment</span><br><span class="line">[lab3][DEBUG ] create the init path if it does not exist</span><br><span class="line">[lab3][INFO ] Running command: sudo systemctl enable ceph.target</span><br><span class="line">[lab3][INFO ] Running command: sudo systemctl enable ceph-mon@lab3</span><br><span class="line">[lab3][WARNIN] Created symlink from /etc/systemd/system/ceph-mon.target.wants/ceph-mon@lab3.service to /usr/lib/systemd/system/ceph-mon@.service.</span><br><span class="line">[lab3][INFO ] Running command: sudo systemctl start ceph-mon@lab3</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab3.asok mon_status</span><br><span class="line">[lab3][WARNIN] lab3 is not defined in `mon initial members`</span><br><span class="line">[lab3][WARNIN] monitor lab3 does not exist in monmap</span><br><span class="line">[lab3][INFO ] Running command: sudo ceph --cluster=ceph --admin-daemon /var/run/ceph/ceph-mon.lab3.asok mon_status</span><br><span class="line">[lab3][DEBUG ] ********************************************************************************</span><br><span class="line">[lab3][DEBUG ] status for monitor: mon.lab3</span><br><span class="line">[lab3][DEBUG ] &#123;</span><br><span class="line">[lab3][DEBUG ]   "election_epoch": 0, </span><br><span class="line">[lab3][DEBUG ]   "extra_probe_peers": [</span><br><span class="line">[lab3][DEBUG ]     "192.168.105.93:6789/0"</span><br><span class="line">[lab3][DEBUG ]   ], </span><br><span class="line">[lab3][DEBUG ]   "feature_map": &#123;</span><br><span class="line">[lab3][DEBUG ]     "mon": &#123;</span><br><span class="line">[lab3][DEBUG ]       "group": &#123;</span><br><span class="line">[lab3][DEBUG ]         "features": "0x3ffddff8eea4fffb", </span><br><span class="line">[lab3][DEBUG ]         "num": 1, </span><br><span class="line">[lab3][DEBUG ]         "release": "luminous"</span><br><span class="line">[lab3][DEBUG ]       &#125;</span><br><span class="line">[lab3][DEBUG ]     &#125;</span><br><span class="line">[lab3][DEBUG ]   &#125;, </span><br><span class="line">[lab3][DEBUG ]   "features": &#123;</span><br><span class="line">[lab3][DEBUG ]     "quorum_con": "0", </span><br><span class="line">[lab3][DEBUG ]     "quorum_mon": [], </span><br><span class="line">[lab3][DEBUG ]     "required_con": "144115188077969408", </span><br><span class="line">[lab3][DEBUG ]     "required_mon": [</span><br><span class="line">[lab3][DEBUG ]       "kraken", </span><br><span class="line">[lab3][DEBUG ]       "luminous"</span><br><span class="line">[lab3][DEBUG ]     ]</span><br><span class="line">[lab3][DEBUG ]   &#125;, </span><br><span class="line">[lab3][DEBUG ]   "monmap": &#123;</span><br><span class="line">[lab3][DEBUG ]     "created": "2018-08-17 16:38:21.075805", </span><br><span class="line">[lab3][DEBUG ]     "epoch": 3, </span><br><span class="line">[lab3][DEBUG ]     "features": &#123;</span><br><span class="line">[lab3][DEBUG ]       "optional": [], </span><br><span class="line">[lab3][DEBUG ]       "persistent": [</span><br><span class="line">[lab3][DEBUG ]         "kraken", </span><br><span class="line">[lab3][DEBUG ]         "luminous"</span><br><span class="line">[lab3][DEBUG ]       ]</span><br><span class="line">[lab3][DEBUG ]     &#125;, </span><br><span class="line">[lab3][DEBUG ]     "fsid": "4395328d-17fc-4039-96d0-1d3241a4cafa", </span><br><span class="line">[lab3][DEBUG ]     "modified": "2018-08-17 17:58:23.179585", </span><br><span class="line">[lab3][DEBUG ]     "mons": [</span><br><span class="line">[lab3][DEBUG ]       &#123;</span><br><span class="line">[lab3][DEBUG ]         "addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "name": "lab1", </span><br><span class="line">[lab3][DEBUG ]         "public_addr": "192.168.105.92:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "rank": 0</span><br><span class="line">[lab3][DEBUG ]       &#125;, </span><br><span class="line">[lab3][DEBUG ]       &#123;</span><br><span class="line">[lab3][DEBUG ]         "addr": "192.168.105.93:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "name": "lab2", </span><br><span class="line">[lab3][DEBUG ]         "public_addr": "192.168.105.93:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "rank": 1</span><br><span class="line">[lab3][DEBUG ]       &#125;, </span><br><span class="line">[lab3][DEBUG ]       &#123;</span><br><span class="line">[lab3][DEBUG ]         "addr": "192.168.105.94:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "name": "lab3", </span><br><span class="line">[lab3][DEBUG ]         "public_addr": "192.168.105.94:6789/0", </span><br><span class="line">[lab3][DEBUG ]         "rank": 2</span><br><span class="line">[lab3][DEBUG ]       &#125;</span><br><span class="line">[lab3][DEBUG ]     ]</span><br><span class="line">[lab3][DEBUG ]   &#125;, </span><br><span class="line">[lab3][DEBUG ]   "name": "lab3", </span><br><span class="line">[lab3][DEBUG ]   "outside_quorum": [</span><br><span class="line">[lab3][DEBUG ]     "lab3"</span><br><span class="line">[lab3][DEBUG ]   ], </span><br><span class="line">[lab3][DEBUG ]   "quorum": [], </span><br><span class="line">[lab3][DEBUG ]   "rank": 2, </span><br><span class="line">[lab3][DEBUG ]   "state": "probing", </span><br><span class="line">[lab3][DEBUG ]   "sync_provider": []</span><br><span class="line">[lab3][DEBUG ] &#125;</span><br><span class="line">[lab3][DEBUG ] ********************************************************************************</span><br><span class="line">[lab3][INFO ] monitor: mon.lab3 is running</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[ceph-admin@lab1 ceph-cluster]$ ceph quorum_status --format json-pretty</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "election_epoch": 12,</span><br><span class="line">    "quorum": [</span><br><span class="line">        0,</span><br><span class="line">        1,</span><br><span class="line">        2</span><br><span class="line">    ],</span><br><span class="line">    "quorum_names": [</span><br><span class="line">        "lab1",</span><br><span class="line">        "lab2",</span><br><span class="line">        "lab3"</span><br><span class="line">    ],</span><br><span class="line">    "quorum_leader_name": "lab1",</span><br><span class="line">    "monmap": &#123;</span><br><span class="line">        "epoch": 3,</span><br><span class="line">        "fsid": "4395328d-17fc-4039-96d0-1d3241a4cafa",</span><br><span class="line">        "modified": "2018-08-17 17:58:23.179585",</span><br><span class="line">        "created": "2018-08-17 16:38:21.075805",</span><br><span class="line">        "features": &#123;</span><br><span class="line">            "persistent": [</span><br><span class="line">                "kraken",</span><br><span class="line">                "luminous"</span><br><span class="line">            ],</span><br><span class="line">            "optional": []</span><br><span class="line">        &#125;,</span><br><span class="line">        "mons": [</span><br><span class="line">            &#123;</span><br><span class="line">                "rank": 0,</span><br><span class="line">                "name": "lab1",</span><br><span class="line">                "addr": "192.168.105.92:6789/0",</span><br><span class="line">                "public_addr": "192.168.105.92:6789/0"</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "rank": 1,</span><br><span class="line">                "name": "lab2",</span><br><span class="line">                "addr": "192.168.105.93:6789/0",</span><br><span class="line">                "public_addr": "192.168.105.93:6789/0"</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                "rank": 2,</span><br><span class="line">                "name": "lab3",</span><br><span class="line">                "addr": "192.168.105.94:6789/0",</span><br><span class="line">                "public_addr": "192.168.105.94:6789/0"</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>添加元数据服务器</em></p><p>至少需要一个元数据服务器才能使用 CephFS ，执行下列命令创建元数据服务器：</p><p><code>ceph-deploy mds create lab4</code></p><p>到此，可以创建RBD和cephFS的ceph集群搭建完成。</p><h4 id="Ceph使用技巧"><a href="#Ceph使用技巧" class="headerlink" title="Ceph使用技巧"></a>Ceph使用技巧</h4><p><em>推送配置文件</em></p><p>只推送配置文件</p><p><code>ceph-deploy --overwrite-conf config push lab1 lab2</code></p><p>推送配置文件和client.admin key</p><p><code>ceph-deploy admin lab1 lab2</code></p><p><em>查看状态的常用命令</em></p><p>集群状态</p><p><code>ceph -s</code></p><p>查看正在操作的动作</p><p><code>ceph -w</code></p><p>查看已经创建的磁盘</p><p><code>rbd ls -l</code></p><p>查看ceph集群 </p><p><code>ceph osd tree</code></p><p>查看ceph授权信息</p><p><code>ceph auth get client.admin</code></p><p>移除monitor节点</p><p><code>ceph-deploy mon destroy lab1</code></p><p>详细列出集群每块磁盘的使用情况</p><p><code>ceph osd df</code></p><p>检查 MDS 状态:</p><p><code>ceph mds stat</code></p><p><em>开启Dashbord管理界面</em></p><p>创建管理域密钥<br><code>ceph auth get-or-create mgr.lab1 mon &#39;allow profile mgr&#39; osd &#39;allow *&#39; mds &#39;allow *&#39;</code><br>或：<br><code>ceph auth get-key client.admin | base64</code></p><p><em>开启 ceph-mgr 管理域</em></p><p><code>ceph-mgr -i master</code></p><p>开启dashboard</p><p><code>ceph mgr module enable dashboard</code></p><p>绑定开启 dashboard 模块的 ceph-mgr 节点的 ip 地址</p><p><code>ceph config-key set mgr/dashboard/master/server_addr 192.168.105.92</code></p><p>dashboard 默认运行在7000端口</p><p><em>RBD常用命令</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">创建pool</span><br><span class="line">若少于5个OSD， 设置pg_num为128。</span><br><span class="line">5~10个OSD，设置pg_num为512。</span><br><span class="line">10~50个OSD，设置pg_num为4096。</span><br><span class="line"></span><br><span class="line">超过50个OSD，可以参考pgcalc计算。</span><br><span class="line">ceph osd pool create rbd 128 128 </span><br><span class="line">rbd pool init rbd</span><br><span class="line"></span><br><span class="line">删除pool</span><br><span class="line">ceph osd pool rm rbd rbd –yes-i-really-really-mean-it </span><br><span class="line">## ceph.conf 添加 </span><br><span class="line">## mon_allow_pool_delete = true</span><br><span class="line"></span><br><span class="line">手动创建一个rbd磁盘</span><br><span class="line">rbd create --image-feature layering [rbd-name] -s 10240</span><br></pre></td></tr></table></figure><p><em>OSD常用命令</em></p><p>清除磁盘上的逻辑卷</p><p><code>ceph-volume lvm zap --destroy /dev/vdc</code>   # 本机操作<br><code>ceph-deploy disk zap lab4 /dev/sdb</code>           # 远程操作</p><p>创建osd</p><p><code>ceph-deploy osd create lab4 --fs-type btrfs --data vg1/lvol0</code></p><p>删除osd节点的node4</p><p>查看节点node4上的所有osd，比如osd.9 osd.10：</p><p><code>ceph osd tree</code>                                                        #查看目前cluster状态</p><p>把node4上的所欲osd踢出集群：（node1节点上执行）</p><p><code>ceph osd out osd.9</code><br><code>ceph osd out osd.10</code></p><p>让node4上的所有osd停止工作：（node4上执行）</p><p><code>service ceph stop osd.9</code><br><code>service ceph stop osd.10</code></p><p>查看node4上osd的状态是否为down，权重为0</p><p><code>ceph osd tree</code></p><p>移除node4上的所有osd：</p><p><code>ceph osd crush remove osd.9</code><br><code>ceph osd crush remove osd.10</code></p><p>删除节点node4：</p><p><code>ceph osd crush remove ceph-node4</code></p><p>替换一个失效的磁盘驱动</p><p>首先<code>ceph osd tree</code> 查看down掉的osd，将因盘问题down掉的osd及相关key删除</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ceph osd out osd.0                         # 都在node1节点下执行</span><br><span class="line">ceph osd crush rm osd.0</span><br><span class="line">ceph auth del osd.0</span><br><span class="line">ceph osd rm osd.0</span><br></pre></td></tr></table></figure><p>zap新磁盘 清理新磁盘：<br><code>ceph-deploy disk zap node1 /dev/sdb</code><br>在磁盘上新建一个osd，ceph会把它添加为osd:0：<br><code>ceph-deploy --overwrite-conf osd create node1 /dev/sdb</code></p><h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><p>[1] <a href="http://docs.ceph.com/docs/master/start/" target="_blank" rel="noopener">http://docs.ceph.com/docs/master/start/</a><br>[2] <a href="http://docs.ceph.org.cn/start/" target="_blank" rel="noopener">http://docs.ceph.org.cn/start/</a><br>[3] <a href="http://docs.ceph.org.cn/install/manual-deployment/" target="_blank" rel="noopener">http://docs.ceph.org.cn/install/manual-deployment/</a><br>[4] <a href="http://www.cnblogs.com/freedom314/p/9247602.html" target="_blank" rel="noopener">http://www.cnblogs.com/freedom314/p/9247602.html</a><br>[5] <a href="http://docs.ceph.org.cn/rados/operations/monitoring/" target="_blank" rel="noopener">http://docs.ceph.org.cn/rados/operations/monitoring/</a></p>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Ceph单节点部署</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BCeph%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BCeph%E5%8D%95%E8%8A%82%E7%82%B9%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<h2 id="Ceph集群单节点安装"><a href="#Ceph集群单节点安装" class="headerlink" title="Ceph集群单节点安装"></a>Ceph集群单节点安装</h2><p>创建虚拟机（正常步骤）</p><p>添加ceph.repo，安装ceph-deploy<a id="more"></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/yum.repos.d/ceph.repo</span><br><span class="line"></span><br><span class="line">[Ceph]</span><br><span class="line">name=Ceph packages for $basearch</span><br><span class="line">baseurl=http://hk.ceph.com/rpm-jewel/el7/$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[Ceph-noarch]</span><br><span class="line">name=Ceph noarch packages</span><br><span class="line">baseurl=http://hk.ceph.com/rpm-jewel/el7/noarch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line">[ceph-source]</span><br><span class="line">name=Ceph source packages</span><br><span class="line">baseurl=http://hk.ceph.com/rpm-jewel/el7/SRPMS</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装ceph-deploy</span></span><br><span class="line">yum clean all</span><br><span class="line">yum install ceph-deploy</span><br></pre></td></tr></table></figure><p>创建集群，并安装ceph相关软件包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建目录</span></span><br><span class="line">mkdir -p  /root/cluster &amp; cd /root/cluster &amp; rm -f /root/cluster/*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入目录，创建集群</span></span><br><span class="line">cd /root/cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装依赖</span></span><br><span class="line">yum install -y yum-utils &amp;&amp; yum-config-manager --add-repo  https://dl.fedoraproject.org/pub/epel/7/x86_64/ &amp;&amp; yum install --nogpgcheck -y  epel-release &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &amp;&amp; rm -f  /etc/yum.repos.d/dl.fedoraproject.org*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这一步非常重要，如果跳过这一步，直接进行ceph的安装，可能会报如下的错误：</span></span><br><span class="line">Error: Package: 1:ceph-common-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: libbabeltrace.so.1()(64bit)</span><br><span class="line">Error: Package: 1:librados2-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 1:librgw2-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: libfcgi.so.0()(64bit)</span><br><span class="line">Error: Package: 1:librbd1-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: liblttng-ust.so.0()(64bit)</span><br><span class="line">Error: Package: 1:ceph-common-10.2.10-0.el7.x86_64 (Ceph)</span><br><span class="line">​           Requires: libbabeltrace-ctf.so.1()(64bit)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装ceph软件包</span></span><br><span class="line">yum install ceph ceph-radosgw</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 虚机准备工作</span></span><br><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> swapoff -a</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 确认ceph软件包版本</span></span><br><span class="line">ceph-deploy --version</span><br><span class="line">ceph -v</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开始部署</span></span><br><span class="line">ceph-deploy new $HOSTNAME</span><br></pre></td></tr></table></figure><p>修改配置文件，配置初始化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> osd的pool副本数size为1，可设置</span></span><br><span class="line">echo osd pool default size = 1 &gt;&gt; ceph.conf   </span><br><span class="line">echo osd crush chooseleaf type = 0 &gt;&gt; ceph.conf</span><br><span class="line">echo osd max object name len = 256 &gt;&gt; ceph.conf</span><br><span class="line">echo osd journal size = 128 &gt;&gt; ceph.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ceph.conf配置</span></span><br><span class="line">cat ceph.conf</span><br><span class="line">[global]</span><br><span class="line">fsid = 90602ee8-b900-44f2-b218-9dd4fc8273af</span><br><span class="line">mon_initial_members = ceph-node</span><br><span class="line">mon_host = 10.100.2.36</span><br><span class="line">auth_cluster_required = cephx</span><br><span class="line">auth_service_required = cephx</span><br><span class="line">auth_client_required = cephx</span><br><span class="line">osd pool default size = 1    </span><br><span class="line">osd crush chooseleaf type = 0</span><br><span class="line">osd max object name len = 256</span><br><span class="line">osd journal size = 128</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> monitor初始化</span></span><br><span class="line">ceph-deploy mon create-initial</span><br></pre></td></tr></table></figure><p>添加osd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建文件夹，添加osd</span></span><br><span class="line">mkdir -p /var/run/ceph/</span><br><span class="line">chown ceph:ceph /var/run/ceph/</span><br><span class="line">mkdir -p /osd &amp; rm -rf /osd/*</span><br><span class="line">chown ceph:ceph /osd</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy osd prepare $HOSTNAME:/osd</span><br><span class="line">ceph-deploy osd activate $HOSTNAME:/osd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证ceph状态是否健康</span></span><br><span class="line">ceph -s</span><br></pre></td></tr></table></figure><h2 id="Ceph开启CephFS挂载"><a href="#Ceph开启CephFS挂载" class="headerlink" title="Ceph开启CephFS挂载"></a>Ceph开启CephFS挂载</h2><p>安装前确定集群状态是正常的</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ceph -s</span><br><span class="line">​    cluster 817696dd-7d7d-459d-8ce3-314326f2c056</span><br><span class="line">​     health HEALTH_OK</span><br><span class="line">​     monmap e1: 1 mons at &#123;ceph-node=10.100.2.36:6789/0&#125;</span><br><span class="line">​            election epoch 3, quorum 0 ceph-node</span><br><span class="line">​      fsmap e5: 1/1/1 up &#123;0=ceph-node=up:active&#125;</span><br><span class="line">​     osdmap e10: 1 osds: 1 up, 1 in</span><br><span class="line">​            flags sortbitwise,require_jewel_osds</span><br><span class="line">​      pgmap v10806: 192 pgs, 3 pools, 2068 bytes data, 20 objects</span><br><span class="line">​            1681 MB used, 49493 MB / 51175 MB avail</span><br><span class="line">​                 192 active+clean</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> cephfs需要启用mds元数据数据服务，检查元数据服务是否创建</span></span><br><span class="line">ceph mds stat</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如下则为正常</span></span><br><span class="line">ceph mds stat</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 正常显示为 e5: 1/1/1 up &#123;0=ceph-node=up:active&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 全为0的话，则添加mds节点</span></span><br><span class="line">ceph-deploy mds create ceph-node</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建cephfs文件系统</span></span><br><span class="line">ceph osd pool create cephfs_data 64</span><br><span class="line">ceph osd pool create cephfs_metadata 64</span><br><span class="line">ceph fs new cephfs cephfs_metadata cephfs_data</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载，这里默认使用admin用户；可自己创建用户挂载</span></span><br><span class="line">mkdir /mnt/cephfs</span><br><span class="line">mount -t ceph 10.100.2.36:6789:/ /aseit-data/cephfs -o name=admin,secret=AQBM82RdI6TAExAAoix7KkMBtSPDSh6ZG69iHg==</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> secret在/etc/ceph/ceph.client.admin.keyring的base64</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可创建client用户来使用</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证</span></span><br><span class="line">df -h</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## 安装以及挂载cephfs时出现的问题：</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1.mount error 5 = Input/output error</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. mount error 22 = Invalid argument</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第一个，首先先查mds服务是正常，不存在则添加，即ceph-deploy mds create ceph-node</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 第二个，密钥不正确，检查密钥，即-o name=admin,secret=AQBM82RdI6TAExAAoix7KkMBtSPDSh6ZG69iHg==挂载时使用</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下面为卸载ceph操作</span></span><br><span class="line">ps aux|grep ceph |awk '&#123;print $2&#125;'|xargs kill -9</span><br><span class="line">ps -ef|grep ceph</span><br><span class="line">ceph-deploy uninstall  [&#123;ceph-node&#125;]                                  # 卸载所有ceph程序</span><br><span class="line">ceph-deploy purge   [[ceph-node&#125; [&#123;ceph-node&#125;]                        #删除ceph相关的包</span><br><span class="line">ceph-deploy purgedata &#123;ceph-node&#125; [&#123;ceph-node&#125;]                       # 删除ceph相关的包</span><br><span class="line">ceph-deploy forgetkeys</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录:"></a>附录:</h2><h3 id="单节点安装ceph脚本"><a href="#单节点安装ceph脚本" class="headerlink" title="单节点安装ceph脚本"></a>单节点安装ceph脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">echo</span> 10.100.2.36 <span class="variable">$HOSTNAME</span> &gt;&gt;  /etc/hosts</span></span><br><span class="line"></span><br><span class="line">yum clean all</span><br><span class="line"><span class="meta">#</span><span class="bash">rm -rf /etc/yum.repos.d/*.repo</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line"><span class="meta">#</span><span class="bash">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'/aliyuncs/d'</span> /etc/yum.repos.d/CentOS-Base.repo</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'s/$releasever/7/g'</span> /etc/yum.repos.d/CentOS-Base.repo</span></span><br><span class="line"><span class="meta">#</span><span class="bash">sed -i <span class="string">'/aliyuncs/d'</span> /etc/yum.repos.d/epel.repo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">echo</span> <span class="string">"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">[ceph]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">name=ceph</span></span><br><span class="line"><span class="meta">#</span><span class="bash">baseurl=https://mirrors.aliyun.com/ceph/rpm-jewel/el7/x86_64/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gpgcheck=0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">[ceph-noarch]</span></span><br><span class="line"><span class="meta">#</span><span class="bash">name=cephnoarch</span></span><br><span class="line"><span class="meta">#</span><span class="bash">baseurl=https://mirrors.aliyun.com/ceph/rpm-jewel/el7/noarch/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">gpgcheck=0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">" &gt; /etc/yum.repos.d/ceph.repo</span></span></span><br><span class="line"></span><br><span class="line">yum install -y yum-utils &amp;&amp; yum-config-manager --add-repo https://dl.fedoraproject.org/pub/epel/7/x86_64/ &amp;&amp; yum install --nogpgcheck -y epel-release &amp;&amp; rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7 &amp;&amp; rm -f /etc/yum.repos.d/dl.fedoraproject.org*</span><br><span class="line"></span><br><span class="line">yum install ceph ceph-radosgw ceph-deploy -y</span><br><span class="line"></span><br><span class="line">mkdir -p  /root/cluster &amp; cd /root/cluster &amp; rm -f /root/cluster/*</span><br><span class="line">cd /root/cluster</span><br><span class="line"></span><br><span class="line">sed -i 's/SELINUX=.*/SELINUX=disabled/' /etc/selinux/config</span><br><span class="line">setenforce 0</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash">swapoff -a</span></span><br><span class="line"></span><br><span class="line">ceph-deploy new $HOSTNAME</span><br><span class="line"></span><br><span class="line">echo osd pool default size = 1 &gt;&gt; ceph.conf</span><br><span class="line">echo osd crush chooseleaf type = 0 &gt;&gt; ceph.conf</span><br><span class="line">echo osd max object name len = 256 &gt;&gt; ceph.conf</span><br><span class="line">echo osd journal size = 128 &gt;&gt; ceph.conf</span><br><span class="line"></span><br><span class="line">mkdir -p /var/run/ceph/</span><br><span class="line">chown ceph:ceph /var/run/ceph/</span><br><span class="line">mkdir -p /osd &amp; rm -rf /osd/*</span><br><span class="line">chown ceph:ceph /osd</span><br><span class="line">ceph-deploy mon create-initial</span><br><span class="line">ceph-deploy osd prepare $HOSTNAME:/osd</span><br><span class="line">ceph-deploy osd activate  $HOSTNAME:/osd</span><br><span class="line"></span><br><span class="line">ceph -s</span><br></pre></td></tr></table></figure><h3 id="ceph重装清理脚本"><a href="#ceph重装清理脚本" class="headerlink" title="ceph重装清理脚本"></a>ceph重装清理脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">\#!/bin/bash</span><br><span class="line"></span><br><span class="line">ps aux|grep ceph |awk '&#123;print $2&#125;'|xargs kill -9</span><br><span class="line">ps -ef|grep ceph</span><br><span class="line"></span><br><span class="line">umount /var/lib/ceph/osd/*</span><br><span class="line">rm -rf /var/lib/ceph/osd/*</span><br><span class="line">rm -rf /var/lib/ceph/mon/*</span><br><span class="line">rm -rf /var/lib/ceph/mds/*</span><br><span class="line">rm -rf /var/lib/ceph/bootstrap-mds/*</span><br><span class="line">rm -rf /var/lib/ceph/bootstrap-osd/*</span><br><span class="line">rm -rf /var/lib/ceph/bootstrap-mon/*</span><br><span class="line">rm -rf /var/lib/ceph/tmp/*</span><br><span class="line">rm -rf /etc/ceph/*</span><br><span class="line">rm -rf /var/run/ceph/*</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>学习杂记之Ceph相关概念</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BCeph%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BCeph%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Ceph是一个统一的分布式存储系统，最早起源于Sage就读博士期间的工作（最早的成果于2004年发表），随后贡献给开源社区。其设计初衷是提供较好的性能、可靠性和可扩展性。在经过多年的发展之后，目前已得到众多云计算厂商的支持并被广泛应用。RedHat及OpenStack都可与Ceph整合以支持虚拟机镜像的后端存储。  </p><p>Ceph的优势可以概括为以下四个方面：<a id="more"></a></p><ol><li>高性能 <ul><li>摒弃了传统的集中式存储元数据寻址的方案，采用CRUSH算法，数据分布均衡，并行度高</li><li>考虑了容灾域的隔离，能够实现各类负载的副本放置规则，例如跨机房、机架感知等</li><li>能够支持上千个存储节点的规模。支持TB到PB级的数据  </li></ul></li><li>高可用  <ul><li>副本数可以灵活控制</li><li>支持故障域分隔，数据强一致性</li><li>多种故障场景自动进行修复自愈</li><li>没有单点故障，自动管理  </li></ul></li><li>高扩展性<ul><li>去中心化</li><li>扩展灵活</li><li>随着节点增加，性能线性增长</li></ul></li><li>特性丰富<ul><li>支持三种存储接口：<font color="red">对象存储</font>，<font color="red">块设备存储</font>，<font color="red">文件存储</font></li><li>支持自定义接口，支持多种语言驱动  </li></ul></li></ol><h2 id="Ceph基本结构"><a href="#Ceph基本结构" class="headerlink" title="Ceph基本结构"></a>Ceph基本结构</h2><p>Ceph的基本组成结构如下图：  </p><img src="/passages/学习杂记之Ceph相关概念/images/Ceph架构图.png"><p>Ceph的底层是<strong>RADOS</strong>，RADOS本身也是分布式存储系统，Ceph所有的存储功能都是基于RADOS实现的。RADOS采用C++开发，所提供的原生Librados API包括C和C++两种。Ceph的上层应用调用本机上的librados API，再由后者通过socket与RADOS集群中的其他节点通信并完成各种操作。  </p><p>RADOS GateWay、RBD其作用是在librados库的基础上提供抽象层次更高、更便于应用或客户端使用的上层接口。其中RADOS GW是一个提供与Amazon S3和Swift兼容的RESTful API的gateway，以供相应的对象存储应用开发使用。RBD则提供了一个标准的块设备接口，常用于在虚拟化的场景下为虚拟机创建volume。目前，RedHat已经将RBD驱动集成在KVM/QEMU中，以提供虚拟机访问性能。这两种方式目前在云计算中应用的比较多。  </p><p>CephFS则提供了POSIX接口，用户可直接通过客户端挂载使用。它是内核态的程序，所有无需调用用户空间的librados库。它通过内核中的net模块来与RADOS进行交互。  </p><h2 id="Ceph基本组件及概念"><a href="#Ceph基本组件及概念" class="headerlink" title="Ceph基本组件及概念"></a>Ceph基本组件及概念</h2><h3 id="Ceph基本组件"><a href="#Ceph基本组件" class="headerlink" title="Ceph基本组件"></a>Ceph基本组件</h3><img src="/passages/学习杂记之Ceph相关概念/images/Ceph基本组件.png">  <p>如上图所示，Ceph主要有三个基本进程：  </p><ul><li>OSD  </li></ul><p>用于集群中所有数据与对象的存储。处理集群数据的复制、恢复、回填、再均衡。并向其他osd守护进程发送心跳，然后向Mon提供一些监控信息。  </p><p>当Ceph存储集群设定的数据有两个副本时（一共存两份），则至少需要两个OSD守护进程，即两个OSD节点，集群才能到达active+clean状态。  </p><ul><li>MDS(可选)  </li></ul><p>为Ceph文件系统提供元数据计算、缓存与同步。在Ceph中，元数据也是存储在osd节点中的，mds类似于元数据的代理缓存服务器。MDS进程并不是必须的进程，只有需要使用CephFS时，才需要配置MDS节点。  </p><ul><li>Monitor  </li></ul><p>监控整个集群的状态，维护集群的cluster MAP二进制表，保证集群数据的一致性。ClusterMAP描述了对象块存储的物理位置，以及一个将设备聚合到物理位置的桶列表。  </p><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><ul><li>Object  </li></ul><p>Ceph最底层的存储单元，每个Object包含元数据和原始数据。  </p><ul><li>PG  </li></ul><p>全称Placement Groups，是一个逻辑的概念，一个PG包含多个OSD。引入PG这一层其实是为了更好的分配数据和定位数据。  </p><ul><li>RADOS  </li></ul><p>全称Reliable Autonomic Distributed Object Store，是Ceph集群的精华，用户实现数据分配、Failover等集群操作。  </p><ul><li>Librados  </li></ul><p>Librados是RADOS提供的库。因为RADOS很难直接访问，因此上层的RBD、RGW和CephFS都是通过Librados访问的。  </p><ul><li>CRUSH  </li></ul><p>是Ceph使用的数据分布算法，让数据分配到预期的地方。  </p><ul><li>RBD  </li></ul><p>全称RADOS block device，是Ceph对外提供的块设备服务。  </p><ul><li>RGW  </li></ul><p>全称RADOS GateWay，是Ceph对外提供的对象存储服务，接口与S3、Swift兼容。  </p><ul><li>CephFS  </li></ul><p>全称Ceph File System，是Ceph对外提供的文件系统服务。  </p><h2 id="Ceph-核心组件"><a href="#Ceph-核心组件" class="headerlink" title="Ceph 核心组件"></a>Ceph 核心组件</h2><p>Ceph的核心组件包括Ceph OSD、Ceph Monitor和Ceph MSD。</p><h3 id="OSD"><a href="#OSD" class="headerlink" title="OSD"></a>OSD</h3><p>首先介绍下Ceph数据的存储过程，如下图：  </p><img src="/passages/学习杂记之Ceph相关概念/images/Ceph数据存储过程.png">  <p>无论使用哪种存储方式（对象、块、文件系统），存储的数据都会被切分成对象（Objects）。Objects size大小可以由管理员调整，通常为2M或者4M。每个对象都会有一个唯一的OID，有ino和ono生成：ino是文件的File ID，用于全局唯一标示每一个文件，而ono是分片的编号。例如，一个文件FileID是A，它被切成两个对象，一个编号为0，另一个编号为1，那么这两个对象的OID则为A0和A1。OID的好处是可以唯一标示每一个不同的对象，并且存储了对象与文件的从属关系。由于Ceph的所有数据都虚拟成了整齐划一的对象，所以在读写时效率都会比较高。  </p><p>但是对象并不会直接存储进OSD中，因为对象的size很小，在一个大规模的集群中可能有几百到几千万个对象。如此多的对象光是遍历寻址速度都会很缓慢；而且如果将对象直接通过某种固定映射的哈希算法映射到osd上，当这个osd损坏时，对象无法自动迁移到其他osd上面（因为映射函数不允许）。为了解决这些问题，Ceph引入了归置组的概念，即PG。  </p><p>PG是一个逻辑概念，Linux系统中可以直接看到对象，但是无法直接看到PG。它在数据寻址时类似于数据库中的索引：每个对象都会固定映射进一个PG中，所以当我们寻找一个对象时，只需要先找到对象所属的PG，然后遍历这个PG就可以了，无需遍历所有对象。而且在数据迁移时，也是一PG作为基本单位进行迁移，Ceph不会直接操作对象。  </p><p>对象是如何映射进PG的？首先使用静态hash函数对OID做hash取出特征码，用特征码与PG的数量取模，得到的序号就是PGID。由于这种设计，PG的数量多寡直接决定了数据分布的均匀性，所以合理设置的PG数量可以很好地提升Ceph集群的性能并使数据均匀分布。  </p><p>最后PG会根据管理员设置的副本数量进行复制，然后通过CRUSH算法存储到不同的OSD节点上（其实是把PG中的所有对象存储到节点上），第一个osd节点即为主节点，其余均为从节点。  </p><p>下面是一段Ceph中的伪代码，简要描述了Ceph的数据存储流程：  </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">locator = object_name</span><br><span class="line">obj_hash = hash(locator)</span><br><span class="line">pg = obj_hash % num_pg</span><br><span class="line">osds_for_pg = crush(pg) <span class="comment"># return a list of osds</span></span><br><span class="line">primary = osds_for_pg[<span class="number">0</span>]</span><br><span class="line">replicas = osds_for_og[<span class="number">1</span>:]</span><br></pre></td></tr></table></figure><img src="/passages/学习杂记之Ceph相关概念/images/OSDs.png">  <p>上图中更好地诠释了Ceph数据流的存储过程，数据无论是从三个接口哪一种写入的，最终都要切分成对象存储到底层的RADOS中。逻辑上通过算法先映射到PG上，最终存储进OSD节点里。图中除了之前介绍过的概念之外多了个pools的概念。  </p><img src="/passages/学习杂记之Ceph相关概念/images/pools.png">  <p>Pool是管理员自定义的命名空间，像其他的命名空间一样，用来隔离对象与PG。我们在调用API存储，即使用对象存储时，需要指定对象要存储进哪一个POOL中。除了隔离数据，我们也可以分别对不同的POOL设置不同的优化策略，比如副本数、数据清洗次数、数据块及对象大小等。  </p><p>OSD是强一致性的分布式存储，它的读写流程如下图：  </p><img src="/passages/学习杂记之Ceph相关概念/images/Ceph读写流程.png">  <p>Ceph的读写操作采用主从模型，客户端要读写数据时，只能向对象所对应的的主OSD节点发起请求。主节点在接受写请求时，会同步的向从OSD中写入数据。当所有的OSD节点都写入完成后，主节点才会向客户端报告写入完成的信息，因此保证了主从节点数据的高度一致性。而读取的时候，客户端也只会向主OSD节点发送读请求，并不会有类似数据库中读写分离的情况出现，这也是处于强一致性的考虑。由于所有写操作都要交给主OSD节点来处理，所以在数据量很大的时候，性能可能会比较慢，为了克服这个问题以及让Ceph能支持事务，每个OSD节点都包含一个journal文件，稍后介绍。  </p><p>数据流向的介绍就先到这，现在回到正题：OSD进程。在Ceph中，每一个OSD进程都可以称作是一个OSD节点，也就是说，每台存储服务器可靠包含了众多的OSD节点，每个OSD节点监听不同的端口，类似于在同一台服务器上跑多个MySQL或Redis。每个OSD节点可以设置一个目录作为实际存储区域，也可以是一个分区、一整块硬盘。如下图，当前这台机器上跑了两个OSD进程，每个OSD监听4个端口，分别用于接收客户请求、传输数据、发送心跳、同步数据等操作。  </p><img src="/passages/学习杂记之Ceph相关概念/images/OSD进程.png">  <p>如上图所示，osd节点默认监听tcp的6800到6803端口，如果同一台服务器上有多个OSD节点，则依次往后排序。  </p><p>在生成环境中OSD最少可能都有上百个，所以每个OSD都有一个全局的编号，类似OSD0、OSD1、OSD2等等，序号根据OSD诞生的顺序排列，并且是全局唯一的。存储了相同PG的OSD节点除了想Mon节点发送心跳外，还会互相发送心跳信息以检测PG数据副本是否正常。  </p><p>之前在介绍数据流向时说过，每个OSD节点都包含一个journal文件，如下图：  </p><img src="/passages/学习杂记之Ceph相关概念/images/journal.png">  <p>默认大小为5G，也就是说创建一个OSD节点，还没使用就要被journal占用5G的空间。这个值是可以调整的，具体大小要依据OSD的总大小而定。  </p><p>Journal的作用类似于MySQL innodb引擎中的事务日志系统。当有突发的大量写入操作时，Ceph可以先把一些零散的，随机的IO请求保存到缓存中进行合并，然后在同一向内核发起IO请求。这样做效率会比较高，但是一旦OSD节点崩溃，缓存中的数据就会丢失，所以数据在还未写进硬盘时，都会记录到journal中，当OSD崩溃后重新启东市，会自动尝试从journal恢复因崩溃而丢失的缓存数据。因此journal的IO是非常密集的，而且由于一个数据IO两次，很大程度上也损耗了硬件的IO性能，所以通常在生产环境中，使用ssd来单独存储journal文件以提高Ceph的读写性能。  </p><h3 id="monitor节点"><a href="#monitor节点" class="headerlink" title="monitor节点"></a>monitor节点</h3><p>Mon节点监控着整个Ceph集群的状态信息，监听于tcp的6789端口。每个Ceph集群中至少要有一个Mon节点，官方推荐每个集群至少部署三台。Mon节点中保存了最新的版本集群数据分布图（Cluster Map）的主副本。客户端在使用时，需要挂载Mon节点的6789端口，下载最新的Cluster Map，通过CRUSH算法获得集群中各OSD的IP地址，然后再与OSD节点直接建立连接来传输数据。所以对于Ceph来说，并不需要有集中式的主节点用于计算与寻址，客户端分摊了这部分工作。而且客户端也可以直接和OSD通信，省去了中间代理服务器的额外开销。  </p><p>Mon节点之间使用Paxos算法来保持各节点Cluster Map的一致性；各Mon节点的功能总体是一样的，相互间的关系可以被简单理解为主备关系。如果主Mon节点损坏，其他Mon存活节点超过半数时，集群还可以正常运行。当故障Mon节点恢复时，会主动从其他Mon节点拉取最新的Cluster Map。  </p><p>Mon节点并不会主动轮询各个OSD的当前状态，相反，OSD只有在一些特殊情况下才会上报自己的信息，平常只会简单的发送心跳。特殊情况包括：1、新的OSD被加入集群；2、某个OSD发现自身或其他OSD发生异常。Mon节点在收到这些上报信息时，则会更新Cluster Map信息并加以扩缩。  </p><p>Cluster Map信息是以异步且lazy的形式扩散的。Monitor并不会在每一次Cluster Map版本更新后都将新版广播至全体OSD，而是有OSD向自己上报信息时，将更新恢复给对方。类似的，各个OSD也是在和其他OSD通信时，如果发现对方的OSD中持有的Cluster Map版本较低，则把自己更新的版本发送给对方。  </p><img src="/passages/学习杂记之Ceph相关概念/images/推荐架构.png">  <p>这里的Ceph除了管理网段外，设了两个网段，一个用于客户端读写传输数据，另一个用于各OSD节点之间同步数据和发送心跳信息等。这样做的好处是可以分担网卡的IO压力。否则在数据清洗时，客户端的读写速度会变得极为缓慢。  </p><h3 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h3><p>Mds是Ceph集群中的元数据服务器，而通常情况它都不是必须的，因为只有在使用CephFS的时候才需要它，而目前云计算中用到的更广泛的是另外两种存储方式。  </p><p>Mds虽然是元数据服务器，但是它不负责存储元数据，元数据也是被切成对象存在各个OSD节点中，如下图：  </p>  <p>在创建CephFS时，要至少创建两个Pool，一个用于存储数据，另一个用于存放元数据。Mds只是负责接收用户的元数据查询请求，然后从OSD中把数据取出来映射进自己的内存中供客户访问。所以Mds其实类似一个代理缓存服务器，替OSD分担了用户的访问压力，如下图：  </p><img src="/passages/学习杂记之Ceph相关概念/images/Mds.png">  <h2 id="Ceph-各概念之间的关系"><a href="#Ceph-各概念之间的关系" class="headerlink" title="Ceph 各概念之间的关系"></a>Ceph 各概念之间的关系</h2><h3 id="存储数据与Object的关系"><a href="#存储数据与Object的关系" class="headerlink" title="存储数据与Object的关系"></a>存储数据与Object的关系</h3><p>当用户要将数据存储到Ceph集群时，存储数据都会被分割成多个Object，每个Object都有一个Object ID，每个Object的大小是可以设置的，默认为4MB。Object可以看做是Ceph存储的最小存储单元。 </p><h4 id="Object-与-PG"><a href="#Object-与-PG" class="headerlink" title="Object 与 PG"></a>Object 与 PG</h4><p>由于Object的数量很多，所以Ceph引入了PG的概念用于管理Object，每个Object最后都会通过CRUSH计算映射到某个PG中，一个PG可以包含多个Object。</p><p>Ceph条带化之后，将获得N个带有唯一OID（即Object的id）。Object id是进行线性映射生成的，即有file的元数据、Ceph条带化产生的Object的序号连缀而成。此时object需要映射到PG中，该映射包括两部分：  </p><ol><li>有Ceph集群指定的静态Hash函数计算Object的OID，获取到其Hash值</li><li>将该Hash值与mask进行操作，从而获得PG ID  </li></ol><p>根据RADOS的设计，假定集群中设定的PG总数为M（M一般为2的整数幂），则mask的值为M-1.由此，Hash值计算之后，进行按位与操作是想从所有PG中近似均匀地随机选择。基于该原理以及概率论的相关原理，当用于数据量庞大的Object以及PG时，获得到的PG ID是近似均匀的，  </p><h4 id="PG-与-OSD"><a href="#PG-与-OSD" class="headerlink" title="PG 与 OSD"></a>PG 与 OSD</h4><p>由PG映射到数据存储的实际单元OSD中，该映射是由CRUSH算法来确定的，将PG ID作为该算法的输入，获得到包含N个OSD的集合，集合的第一个OSD被作为主OSD，其余的OSD则依次作为从OSD。N为该PG所在POOL下的副本数量，在生产环境中N一般为3；OSD集合中的OSD将共同存储和维护该PG下的Object。需要注意的是，CRUSH算法的结果不是绝对不变的，而是受其他因素的影响。其影响因素主要有以下两个：  </p><ol><li>当前系统状态，也就是Cluster Map（集群映射）。当系统中的OSD状态、数量发生变化时，Cluster Map可能发生变化，而这种变化将会影响到PG和OSD之间的映射</li><li>存储策略配置。这里的策略主要与安全相关。利用策略配置，系统管理员可以指定承载同一个PG的3个OSD分别位于数据中心的不同服务器乃至机架上，从而进一步改善存储的可靠性。  </li></ol><p>因此，只有在Cluster Map和存储策略都不发生变化的时候，PG和OSD之间的映射关系才是固定不变的。在实际使用中，策略已经配置通常不会改变。而系统状态的改变或者是因为设备损坏，或者是因为存储集群规模扩大。好在Ceph本身提供了对于这种变化的自动化支持，因而即便PG和OSD之间的映射关系发生了变化，并不会对应用造成困扰。事实上，Ceph正是需要有目的的利用这种动态映射关系。正是利用了CRUSH的动态特性，Ceph才可以将一个PG根据需要动态迁移到不同的OSD组合上，从而自动化地实现高可靠性、数据分布re-blancing等特性。  </p><p>之所以在此次映射中使用CRUSH算法，而不是其他Hash算法，原因之一是CRUSH具有上述可配置特性，可以根据管理员的配置参数决定OSD的物理位置映射策略；另一方面是因为CRUSH具有特殊的“稳定性”，也就是当系统中加入新的OSD导致系统规模增大时，大部分PG与OSD之间的映射关系不会发生改变，只是少部分PG的映射关系会发生变化并引发数据迁移。这种可配置性和稳定性都不是普通Hash算法所能提供的。因此，CRUSH算法的设计也是Ceph的核心内容之一。  </p><h4 id="PG-与-PGP"><a href="#PG-与-PGP" class="headerlink" title="PG 与 PGP"></a>PG 与 PGP</h4><p>PG是用来存放Object的，PGP相当于是PG存放OSD的一种排列组合。举个例子，比如有3个OSD，OSD.1、OSD.2和OSD.3，副本数是2，如果PGP的数目为1，那么PG存放的OSD组合就只有一种可能：[OSD.1，OSD.2]，那么所有的PG主从副本分别存放到OSD.1和OSD.2；如果PGP设为2，那么OSD组合就有两种，[OSD.1，OSD.2]和[OSD.1，OSD.3]，是不是很像数学中的排列组合，PGP就是代表这个意思。一般来说应该将PG和PGP的数量设置为相等。接下来我们来通过一组实验来进一步说明：  </p><p>先创建一个名为testpool包含6个PG和6个PGP的存储池：  </p><blockquote><p>ceph osd pool create testpool 6 6</p></blockquote><p>通过写数据后我们查看下PG的分布情况，使用以下命令：      </p><blockquote><p>ceph pg dump pgs | grep ^1 | awk ‘{print $1,$2,$15}’  </p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumped pgs in format plain</span><br><span class="line">1.1 75 [3,6,0]</span><br><span class="line">1.0 83 [7,0,6]</span><br><span class="line">1.3 144 [4,1,2]</span><br><span class="line">1.2 146 [7,4,1]</span><br><span class="line">1.5 86 [4,6,3]</span><br><span class="line">1.4 80 [3,0,4]</span><br></pre></td></tr></table></figure><p>第1列为PG的ID，第2列为该PG所存储的对象数目，第3列为该PG所在的OSD。  </p><p>我们扩大PG再看看：  </p><blockquote><p>ceph osd pool set testpool pg_num 12  </p></blockquote><p>再用上面的命令查询分布情况：  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.1 37 [3,6,0]</span><br><span class="line">1.9 38 [3,6,0]</span><br><span class="line">1.0 41 [7,0,6]</span><br><span class="line">1.8 42 [7,0,6]</span><br><span class="line">1.3 48 [4,1,2]</span><br><span class="line">1.b 48 [4,1,2]</span><br><span class="line">1.7 48 [4,1,2]</span><br><span class="line">1.2 48 [7,4,1]</span><br><span class="line">1.6 49 [7,4,1]</span><br><span class="line">1.a 49 [7,4,1]</span><br><span class="line">1.5 86 [4,6,3]</span><br><span class="line">1.4 80 [3,0,4]</span><br></pre></td></tr></table></figure><p>可以看到PG的数量增加到12个了，PG1.1的对象数量本来是75个，现在是37个，可以看到它把对象数分给新增的PG1.9了，刚好是38，加起来为75，而且可以看到PG1.1和PG1.9的OSD盘是一样的。而且可以看到OSD盘的组合还是那6种。  </p><p>我们增加PGP的数量来看下，使用命令：  </p><blockquote><p>ceph osd pool set testpool pgp_num 12  </p></blockquote><p>在看下：  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.a 49 [1,2,6]</span><br><span class="line">1.b 48 [1,6,2]</span><br><span class="line">1.1 37 [3,6,0]</span><br><span class="line">1.0 41 [7,0,6]</span><br><span class="line">1.3 48 [4,1,2]</span><br><span class="line">1.2 48 [7,4,1]</span><br><span class="line">1.5 86 [4,6,3]</span><br><span class="line">1.4 80 [3,0,4]</span><br><span class="line">1.7 48 [1,6,0]</span><br><span class="line">1.6 49 [3,6,7]</span><br><span class="line">1.9 38 [1,4,2]</span><br><span class="line">1.8 42 [1,2,3]</span><br></pre></td></tr></table></figure><p>再看PG1.1和PG1.9，可以看到PG1.9不在[3,6,0]上，而是在[1,4,2]上，该组合时新增加的。可以知道增加PGP_NUM其实是增加了OSD盘的组合。  </p><p>通过上述实验可以得出：  </p><ol><li>PG是指定存储池存储对象的目录有多少个，PGP是存储池PG的OSD分布组合个数</li><li>PG的增加会引起PG内的数据进行分裂，分裂到相同的OSD上新生成的PG中</li><li>PGP的增加会引起部分PG的分布变化，但是不会引起PG内对象的变动</li></ol><h4 id="PG-与-Pool"><a href="#PG-与-Pool" class="headerlink" title="PG 与 Pool"></a>PG 与 Pool</h4><p>Pool也是一个逻辑存储概念，我们创建存储池pool的时候，都需要指定PG和PGP的数量，逻辑上来说PG是属于某个存储池的，就像Object是属于某个PG的一样。  </p><p>下图表明了存储数据、Object、PG、Pool、OSD、存储磁盘的关系：  </p><img src="/passages/学习杂记之Ceph相关概念/images/关系图.png"><h3 id="Ceph-条带化"><a href="#Ceph-条带化" class="headerlink" title="Ceph 条带化"></a>Ceph 条带化</h3><p>众所周知，存储设备具有吞吐量限制，它影响读写性能和可扩展性能。所以存储系统通常都支持条带化以增加存储系统的吞吐量并提升性能，数据条带化最常见的方式是做RAID。与Ceph的条带化最相似的是RAID 0或者是“带区卷”。Ceph条带化提供了类似RAID 0的吞吐量，N路RAID镜像的可靠性已经更快速的恢复能力。  </p><p>在磁盘阵列中，数据是以条带（stripe）的方式贯穿在磁盘阵列所有硬盘中的。这种数据的分配方式可以弥补OS读取数据量跟不上的不足。  </p><p>1.将条带单元（stripe unit）从阵列的第一个硬盘到最后一个硬盘收集起来，就可以称为条带（stripe）。有的时候，条带单元也被称为交错深度。在光纤技术中，一个条带单元被叫做段。  </p><p>2.数据在阵列中的硬盘上是以条带的形式分布的，条带化是指数据在阵列中所有硬盘中的存储过程。文件中的数据被分割成小块的数据段在阵列中的硬盘顺序上的存储，这个最小数据块就叫做条带单元。  </p><p>决定Ceph条带化数据的3个因素：  </p><ul><li><p>对象大小：处于分布式集群中的对象拥有一个最大可配置的尺寸（例如，2MB，4MB等），对象大小应该足够大以适应大量的条带单元。</p></li><li><p>条带宽度：条带有一个可以配置的单元大小，Ceph Client端将数据写入对象，分成相同大小的条带单元，除了最后一个条带之外；每个条带宽度，应该是对象大小的一部分，这样使得一个对象可以包含多个条带单元。</p></li><li><p>条带总量：Ceph客户端写入一系列的条带单元到一系列的对象，这就决定了条带的总量，这些对象被称为对象集。当Ceph客户端写入的对象集合中的最后一个对象之后，它将会返回到对象集合中的第一个对象处。  </p></li></ul><h2 id="CRUSH-算法"><a href="#CRUSH-算法" class="headerlink" title="CRUSH 算法"></a>CRUSH 算法</h2><h3 id="数据分布算法挑战"><a href="#数据分布算法挑战" class="headerlink" title="数据分布算法挑战"></a>数据分布算法挑战</h3><ul><li><strong>数据分布和负载均衡</strong>：<ul><li>a.数据分布均衡，使数据能均匀地分布到各个节点上</li><li>b.负载均衡，使数据访问读写操作的负载在各个节点和磁盘的负载均衡</li></ul></li><li><strong>灵活应对集群伸缩</strong>：<ul><li>a.系统可以方便的增加或者删除节点设备，并且对节点失效进行处理</li><li>b.增加或者删除节点设备后，能自动实现数据的均衡，并且尽可能少的迁移数据</li></ul></li><li><strong>支持大规模集群</strong>：<ul><li>要求数据分布算法维护的元数据相对较小，并且计算量不能太大。随着集群规模的增加，数据分布算法的开销相对较小</li></ul></li></ul><h3 id="CRUSH-算法说明"><a href="#CRUSH-算法说明" class="headerlink" title="CRUSH 算法说明"></a>CRUSH 算法说明</h3><ul><li>CRUSH（Controlled Replication Under Scalable Hashing）是一种基于伪随机控制数据分布、复制的算法。Ceph是为大规模分布式存储系统（PB级的数据和成百上千台存储设备）而设计的，在大规模的存储系统里，必须考虑数据的平衡分布和负载（提高资源利用率）、最大化系统的性能以及系统的扩展和硬件容错等。CRUSH就是为解决上述问题而设计的。在Ceph集群里，CRUSH只需要一个简洁而层次清晰的设备描述，包括存储集群和副本放置策略，就可以有效地把数据对象映射到存储设备上，且这个过程是完全分布式的，在集群系统中的任何一方都可以独立计算任何对象的位置；另外，大型系统存储结构是动态变化的（存储节点的扩展或者缩容、硬件故障等），CRUSH能够处理存储设备的变更（添加或删除），并最小化由于存储设备的变更而导致的数据迁移。   </li><li>PG到OSD的映射过程的算法叫做CRUSH算法。</li><li>CRUSH算法是一个伪随机的过程，它可以从所有的OSD中，随机性选择一个OSD集合，但是同一个PG每次随机选择的结果是不变的，也就是映射的OSD集合是固定的。</li></ul><h3 id="CRUSH-基本原理"><a href="#CRUSH-基本原理" class="headerlink" title="CRUSH 基本原理"></a>CRUSH 基本原理</h3><p><strong>CRUSH 算法因子</strong>：  </p><ul><li><strong>层次化的Cluster Map</strong>： 反映了存储系统层级的物理拓扑结构。定义了OSD集群具有层级关系的静态拓扑结构。OSD层级使得CRUSH算法在选择OSD时实现了机架感知能力，也就是通过规则定义，使得副本可以分布在不同的机架、不同的机房中，提高数据的安全性</li><li><strong>Placement Rules</strong>： 决定了一个PG的对象副本如何选择的规则，通过这些可以自己设定规则，用户可以自定义设置副本在集群中的分布</li></ul><h3 id="CRUSH-关系分析"><a href="#CRUSH-关系分析" class="headerlink" title="CRUSH 关系分析"></a>CRUSH 关系分析</h3><p>从本质上讲，CRUSH算法是通过存储设备的权重来计算数据对象的分布。在计算过程中，通过Cluster Map（集群映射）、Data Distribution Policy（数据分布策略）和给出的一个随机数共同决定数据对象的最终位置。  </p><h4 id="Cluster-Map"><a href="#Cluster-Map" class="headerlink" title="Cluster Map"></a>Cluster Map</h4><p>Cluster Map记录所有可用的存储资源以及可用的存储资源及相互之间的空间层次结构（集群中有多少个机架、机架上有多少个服务器、每个服务器上有多少磁盘等信息）。所谓Map，顾名思义，就是类似于我们生活中的地图。在Ceph存储里，数据的索引都是通过各种不同的Map来实现的。另一方面，Map使得Ceph集群存储设备在物理层做了一层防护。例如，在多副本结构上，通过设置合理的Map（故障域设置为Host级），可以保证在某一服务器死机的情况下，有其他副本保留在正常的存储节点上，能够继续提供服务，实现存储的高可用。设置更高的故障域级别（如Rack、Row等）能保证整机柜或同一排机柜在掉电情况下数据的高可用性和完整性。  </p><h5 id="1-Cluster-Map的分层结构"><a href="#1-Cluster-Map的分层结构" class="headerlink" title="1.Cluster Map的分层结构"></a>1.Cluster Map的分层结构</h5><p>Cluster Map由Device和Bucket构成。它们都有自己的ID和权重值，并且形成一个以Device为叶子节点、Bucket为躯干的树状结果。  </p><img src="/passages/学习杂记之Ceph相关概念/images/CRUSH架构图.png">  <p>Bucket拥有不同的类型，如Host、Row、Rack、Room等，通常我们默认把机架类型定义为Rack，主机类型定义为Host，数据中心（IDC机房）定义为Data Center。Bucket的类型都是虚拟结构，可以根据自己的喜好设计合适的类型。Device节点的权重值代表了存储设备的容量与性能。其中，磁盘容量是权重大小的关键因素。  </p><p>OSD的权重值越高，对应磁盘会被分配写入更多的数据。总体来说，数据会被均匀写入分布于集群所有磁盘，从而提高整体性能和可靠性。无论磁盘的规格容量，总能够均匀使用。  </p><p>关于OSD权重值的大小值的配比，官方默认值设置为1TB容量的硬盘，对应权重为1。可以在/etc/init.d/ceph源码里查看相关的内容。  </p><p><strong>Bucket随机算法类型</strong>  </p><img src="/passages/学习杂记之Ceph相关概念/images/ceph_bucket.png">  <ul><li><strong>一般的buckets</strong>：适合所有子节点权重相同，而且很少添加删除item</li><li><strong>list buckets</strong>：适用于集群扩展类型。增加item，产生最优的数据移动，查找item，时间复杂对为O(n)</li><li><strong>tree buckets</strong>：查找复杂的为O(log n)，添加删除叶子节点是，其它节点node_id不变</li><li><strong>straw buckets</strong>：允许所有项通过类似抽签的方式来与其它项公平“竞争”。定位副本时，bucket中的每一项都对应一个随机长度的straw，且拥有最长长度的straw会获得胜利（被选中）；添加或者重新计算，子树之间的数据移动提供最优的解决方案</li></ul><h5 id="2-恢复与动态平衡"><a href="#2-恢复与动态平衡" class="headerlink" title="2.恢复与动态平衡"></a>2.恢复与动态平衡</h5><p>在默认情况下，当集群里有组件故障时（主要是OSD，也可能是磁盘或者网络等），Ceph会把OSD标记为down，如果在300s内未能回复，集群就会开始进行恢复状态。这个“300s”可以通过“mon osd down ourt interval”配置选项修改等待时间。PG（Placement Groups）是Ceph数据管理（包括复制、修复等操作）单元。当客户端把读写请求（对象单元）推送到Ceph时，通过CRUSH提供的Hash算法把对象映射到PG。PG在CRUSH策略的影响下，最终会被映射到OSD上。  </p><h4 id="Data-Distribution-Policy"><a href="#Data-Distribution-Policy" class="headerlink" title="Data Distribution Policy"></a>Data Distribution Policy</h4><p>Data Distribution Policy由Placement Rules组成。Rule决定了每个数据对象有多少个副本，这些副本存储的限制条件（比如3个副本放在不同的机架中）。一个典型的rule如下所示：  </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rule replicated_ruleset &#123;                   ##rule名字</span><br><span class="line">      ruleset 0                             #rule的ID</span><br><span class="line">      type replicated                       ##类型为副本模式，另外一种模式为纠删码（EC）</span><br><span class="line">      min_size 1                            ##如果存储池的副本数大于这个值，此rule不会应用</span><br><span class="line">      max_size 10                           ##如果存储池的副本数大于这个值，此rule不会应用</span><br><span class="line">      step take default                     ##以default root 为入口</span><br><span class="line">      step chooseleaf firstn 0 type host    ##隔离城为host级，即不同副本在不同的主机上</span><br><span class="line">      step emit                             ##提交</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据实际的设备环境，可以定制符合自己需求的Rule。  </p><h3 id="CRUSH-中的伪随机"><a href="#CRUSH-中的伪随机" class="headerlink" title="CRUSH 中的伪随机"></a>CRUSH 中的伪随机</h3><p>$$CRUSH(x) \quad \rightarrow \quad (osd1,osd2 \cdots\cdots osdN)$$  </p><p>CRUSH使用了多参数的Hash函数，在Hash之后，映射都是按既定规则选择的，这使得从x到OSD的集合是确定的和独立的。CRUSH只使用Cluster Map、Placement Ruels、X。CRUSH是伪随机算法，相似输入的结果之间没有相关性。  </p><p>下面通过计算PG的ID来看CRUSH的一个计算过程：  </p><ol><li>Client输入pool ID和对象ID（如pool=’liverpool’,object-id=’john’）</li><li>CRUSH获得对象ID并对其Hash运算</li><li>CRUSH计算OSD个数，Hash取模获得PG的ID（如0x58）</li><li>CRUSH获得已命名pool的ID（如liverpool=4）</li><li>CRUSH预先考虑到pool ID相同的PG ID（如4.0x58）</li></ol><p>在Ceph集群里，当有数据对象要写入集群时，需要进行两次映射，第一次从Object–&gt;PG，第二层是PG–&gt;OSD set。每一次的映射都是与其他对象不相关的，这充分体现了CEUSH的独立性（充分分散）和确定性（可确定的存储位置）。  </p><h2 id="Ceph-IO流程及数据分布"><a href="#Ceph-IO流程及数据分布" class="headerlink" title="Ceph IO流程及数据分布"></a>Ceph IO流程及数据分布</h2><img src="/passages/学习杂记之Ceph相关概念/images/rados_io_1.png">  <h3 id="正常IO流程图"><a href="#正常IO流程图" class="headerlink" title="正常IO流程图"></a>正常IO流程图</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_io_2.png">  <p>步骤：  </p><ol><li>Client 创建Cluster handler</li><li>Client 读取配置文件</li><li>Client 连接上Monitor，获取集群map信息</li><li>Client 读写IO 根据Crushmap算法请求对应的主OSD数据节点</li><li>主OSD数据节点同时写入另外两个副本节点数据</li><li>等待主节点以及另外两个副本节点写完数据状态</li><li>主节点及副本节点写入状态都成功后，返回给Client，IO写入完成  </li></ol><h3 id="新主IO流程图"><a href="#新主IO流程图" class="headerlink" title="新主IO流程图"></a>新主IO流程图</h3><p>说明：  </p><p>如果新加入的OSD1取代了原有的OSD4成为Primary OSD，由于OSD1上未创建PG，不存在数据，那么PG上的IO无法进行，怎样工作呢？  </p><img src="/passages/学习杂记之Ceph相关概念/images/ceph_io_3.png">  <p>步骤：  </p><ol><li>Client 连接Monitor获取集群Map信息</li><li>同时新主OSD1由于没有PG，数据会主动上报Monitor告知让OSD2临时接替为主</li><li>临时主OSD2会把数据全量同步给新主OSD1</li><li>Client IO读写直接连接临时主OSD2进行读写</li><li>OSD2收到读写IO，同时写入另外两个副本节点</li><li>等待OSD2以及另外两副本写入成功  </li><li>OSD2三分数据都写入成功返回给Client，此时Client IO读写完毕</li><li>如果OSD1数据同步完毕，临时主OSD2会交出主角色</li><li>OSD1成为主节点，OSD2变成副本  </li></ol><h3 id="Ceph-IO算法流程"><a href="#Ceph-IO算法流程" class="headerlink" title="Ceph IO算法流程"></a>Ceph IO算法流程</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_io_4.png">   <ol><li>File用户需要读写文件，File-&gt;Object映射：  <ul><li>a. ino（File的元数据，File的唯一ID）</li><li>b. ono（File切分产生的某个Object的序号，默认以4M切分一个块大小）</li><li>c. oid（object id： ino + ono）</li></ul></li><li>Object是RADOS需要的对象。Ceph指定一个静态Hash函数计算OID的值，将OID映射成一个近似均匀分布的伪随机值，然后和mask按位相与，得到PGID。Object-&gt;PG映射：  <ul><li>a. hash(oid) &amp; mask -&gt; pgid</li><li>b. mask = PG总数m（m为2的整数幂）-1</li></ul></li><li>PG（Placement Group），用途是对Object的存储进行组织和位置映射，类似Redis Cluster里面的slot的概念。一个PG里面会有很多Object。采用CRUSH算法，将PGID带入其中，然后得到一组OSD。PG-&gt;OSD映射：  <ul><li>CRUSH(pgid) -&gt; (osd1,osd2,osd3)</li></ul></li></ol><h3 id="Ceph-RBD-IO流程"><a href="#Ceph-RBD-IO流程" class="headerlink" title="Ceph RBD IO流程"></a>Ceph RBD IO流程</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_rbd_io.png">  <p>步骤：  </p><ol><li>客户端创建一个Pool，需要为这个Pool指定PG的数量</li><li>创建pool/image RBD设备进行挂载</li><li>用户写入的数据进行切块，每个块的大小默认为4M，并且每个块都有一个名字，即Object+序号</li><li>将每个Object通过PG进行副本位置的分配</li><li>PG根据CRUSH算法会寻找3个OSD，把这个Object分别保存在这三个OSD上</li><li>OSD上实际是把底层的Disk进行了格式化操作，一般部署工具会将它格式化为xfs文件系统</li><li>Object的存储就变成了存储一个名为rbd0.object1.file的文件  </li></ol><h3 id="Ceph-RBD-IO框架图"><a href="#Ceph-RBD-IO框架图" class="headerlink" title="Ceph RBD IO框架图"></a>Ceph RBD IO框架图</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_rbd_io1.png">  <p>客户端写数据OSD过程：  </p><ol><li>采用的是librbd的形式，使用librbd创建一个块设备，向这个块设备写入数据  </li><li>在客户端本地通过调用librados接口，然后经过pool、rbd、object、pg进行层层映射，在PG这一层中，可以知道数据保存在哪3个OSD上，以及这3个OSD的主从关系</li><li>客户端与primary OSD建立socket通信，将要写入的数据传给primary OSD，由primary OSD再将数据发送给其他replica OSD数据节点  </li></ol><h3 id="Ceph-数据扩容PG分布"><a href="#Ceph-数据扩容PG分布" class="headerlink" title="Ceph 数据扩容PG分布"></a>Ceph 数据扩容PG分布</h3><p>场景数据迁移流程：  </p><ul><li>现状3个OSD，4个PG</li><li>扩容到4个OSD，4个PG</li></ul><p>现状：  </p><img src="/passages/学习杂记之Ceph相关概念/images/ceph_recory_1.png">  <p>扩容后：  </p><img src="/passages/学习杂记之Ceph相关概念/images/ceph_recory_2.png">  <p>说明：  </p><p>每个OSD上分布很多PG，并且每个PG会自动散落在不同的OSD上。如果扩容，那么相应的PG会自动迁移到新的OSD上，保证PG数量的均衡  </p><h2 id="Ceph心跳机制"><a href="#Ceph心跳机制" class="headerlink" title="Ceph心跳机制"></a>Ceph心跳机制</h2><h3 id="心跳介绍"><a href="#心跳介绍" class="headerlink" title="心跳介绍"></a>心跳介绍</h3><p>心跳是用于节点间检测对方是否发送故障，以便及时发现故障点进入相应的故障处理流程。  </p><p><strong>问题：</strong>  </p><ul><li>故障检测时间和心跳报文带来的负载之间做权衡</li><li>心跳频率太高则过多的心跳报文会影响系统性能</li><li>心跳频率过低则会延长发现故障节点的时间，从而影响系统的可用性  </li></ul><p><strong>故障检测策略应该能够做到：</strong></p><ul><li><strong>及时</strong>：节点发生异常如宕机或网络中断时，集群可以在可接受的时间范围内感知</li><li><strong>适当的压力</strong>：包括对节点的压力和网络的压力</li><li><strong>容忍网络抖动</strong>：网络偶尔延迟</li><li><strong>扩散机制</strong>：节点存活状态改变导致的元信息变化需要通过某种机制扩散到整个集群</li></ul><h3 id="Ceph-心跳检查"><a href="#Ceph-心跳检查" class="headerlink" title="Ceph 心跳检查"></a>Ceph 心跳检查</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_heartbeat_1.png">  <p><strong>OSD节点会监听public、cluster、front和back四个端口</strong></p><ul><li><strong>public端口</strong>：监听来自Monitor和Client的连接</li><li><strong>cluster端口</strong>：监听来自OSD Peer的连接</li><li><strong>front端口</strong>：供客户端连接集群使用的网卡，这里临时给集群内部之间进行心跳</li><li><strong>back端口</strong>：供集群内部使用的网卡，集群内部之间进行心跳</li><li><strong>hbclient</strong>：发送ping心跳的messenger</li></ul><h3 id="Ceph-OSD之间相互心跳检查"><a href="#Ceph-OSD之间相互心跳检查" class="headerlink" title="Ceph OSD之间相互心跳检查"></a>Ceph OSD之间相互心跳检查</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_heartbeat_osd.png"><p>步骤：  </p><ul><li>同一个PG内的OSD相互心跳，它们互相发送PING/PONG信息</li><li>每隔6s检测一次（实际会在这个基础上加一个随机时间来避免峰值）</li><li>20s没有检测到心跳回复，加入failure队列  </li></ul><h3 id="Ceph-OSD与Mon心跳检测"><a href="#Ceph-OSD与Mon心跳检测" class="headerlink" title="Ceph OSD与Mon心跳检测"></a>Ceph OSD与Mon心跳检测</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_heartbeat_mon.png">  <p><strong>OSD报告给Monitor</strong>:</p><ul><li>OSD有事件发生时（比如故障、PG变更）</li><li>自身启动5s内</li><li>OSD周期性的上报给Monitor<ul><li>OSD检查failure_queue中的伙伴OSD失败信息</li><li>向Monitor发送失效报告，并将失败信息加入failure_pending队列，然后将其从failure_queue移除</li><li>收到来自failure_queue或者failure_pending中的OSD的心跳时，将其从这两个队列中移除，并告知Monitor取消之前的失效报告</li><li>当发生与Monitor网络重连时，会将failure_pending中的错误报告加回到failure_queue中，并再次发送给Monitor</li></ul></li><li>Monitor统计下线OSD<ul><li>Monitor收集来自OSD的伙伴失效报告</li><li>当错误报告指向的OSD失效超过一定阈值，且足够多的OSD报告其失效时，将该OSD下线  </li></ul></li></ul><h2 id="Ceph心跳检测总结"><a href="#Ceph心跳检测总结" class="headerlink" title="Ceph心跳检测总结"></a>Ceph心跳检测总结</h2><p>Ceph通过伙伴OSD汇报失效节点和Monitor统计来自OSD的心跳两种方式判定OSD节点失效。  </p><ul><li><p><strong>及时</strong>：伙伴OSD可以在秒级发现节点失效并汇报Monitor，并在几分钟内由Monitor将失效OSD下线</p></li><li><p><strong>适当压力</strong>：由于有伙伴OSD汇报机制，Monitor与OSD之间的心跳统计更像是一种保险措施，因此OSD向Monitor发送心跳的间隔可以长达600s，Monitor的检测阈值也可以长达900s。Ceph实际上是将故障检测过程中中心节点的压力分散到所有的OSD上，以此提高中心节点Monitor的可靠性，进而提高这个集群的可靠性</p></li><li><p><strong>容忍网络抖动</strong>：Monitor收到OSD对其伙伴OSD的汇报后，并没有马上将目标OSD下线，而是周期性地等待几个条件：  </p><ul><li>目标OSD的失效时间大于通过固定量osd_heartbeat_grace和历史网络条件动态确定的阈值</li><li>来自不同主机的汇报到的mod_osd_min_down_reports</li><li>慢速前两个条件失效汇报没有被源OSD取消</li></ul></li><li><p><strong>扩散</strong>：作为中心节点的Monitor并没有在更OSDMap后尝试广播通知所有的OSD和Client，而是惰性的等待OSD和Client来获取，以此来减少Monitor压力并简化交互逻辑</p></li></ul><h2 id="Ceph通信框架"><a href="#Ceph通信框架" class="headerlink" title="Ceph通信框架"></a>Ceph通信框架</h2><h3 id="Ceph通信框架种类介绍"><a href="#Ceph通信框架种类介绍" class="headerlink" title="Ceph通信框架种类介绍"></a>Ceph通信框架种类介绍</h3><p><strong>网络通信框架三种不同的实现方式</strong>：  </p><ul><li><strong>Simple线程模式</strong><ul><li><strong>特点</strong>：每一个网络链接，都会创建两个线程，一个用于接收，一个用于发送</li><li><strong>缺点</strong>：大量的链接会产生大量的线程，会消耗CPU资源，影响性能</li></ul></li><li><strong>Async事件的I/O多路复用模式</strong><ul><li><strong>说明</strong>：这种是目前网络通信中广泛采用的方式。K版默认已经使用Async</li></ul></li><li><strong>XIO方式使用了开源的网络通信库accelio来实现</strong><ul><li><strong>说明</strong>：这种方式需要依赖第三方库accelio的稳定性</li></ul></li></ul><h3 id="Ceph通信框架设计模式"><a href="#Ceph通信框架设计模式" class="headerlink" title="Ceph通信框架设计模式"></a>Ceph通信框架设计模式</h3><p><strong>设计模式（Subscribe/Publish）</strong></p><p>订阅发布模式又名观察者模式，它意图是”定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变是，所有依赖于它的对象都得到通知并被自动更新“。  </p><h3 id="Ceph通信框架流程图"><a href="#Ceph通信框架流程图" class="headerlink" title="Ceph通信框架流程图"></a>Ceph通信框架流程图</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_message.png">  <p>步骤：  </p><ul><li>Accepter监听peer的请求，调用SimpleMessenger::add_accept_pip3()创建新的pipe到SimpleMessenger::pipes来处理该请求</li><li>Pipe用于消息的读取和发生。该类主要有两个组件：Pipe::Reader，Pipe::Writer用来处理消息读取和发送</li><li>Messenger作为消息的发布者，各个Dispatcher子类作为消息的订阅者，Messenger收到消息之后，通过Pipe对取消息，然后转给Dispatcher处理</li><li>Dispatcher是订阅者的基类，具体的订阅者后端继承该类，初始化的时候通过Messenger::add_dispatcher_tail/head注册到Messenger::dispatchers。收到消息后，通知该类处理</li><li>DispatchQueue该类用来缓存收到的消息，然后唤醒DispatchQueue::dispatch_thread线程找到后端的Dispatch处理消息</li></ul><img src="/passages/学习杂记之Ceph相关概念/images/ceph_message_2.png">  <h3 id="Ceph通信框架类图"><a href="#Ceph通信框架类图" class="headerlink" title="Ceph通信框架类图"></a>Ceph通信框架类图</h3><img src="/passages/学习杂记之Ceph相关概念/images/ceph_message_3.png">  <h3 id="Ceph通信数据格式"><a href="#Ceph通信数据格式" class="headerlink" title="Ceph通信数据格式"></a>Ceph通信数据格式</h3><p>通信协议格式需要双方约定数据格式。  </p><p><strong>消息的内容主要分为三部分</strong>：  </p><ul><li>header        //消息头 类型消息的信封</li><li>user data     //需要发送的实际数据<ul><li>payload     //操作保存元数据</li><li>middle      //预留字段</li><li>data        //读写数据</li></ul></li><li>footer        //消息的结束标记  </li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span> :</span> <span class="keyword">public</span> RefCountedObject &#123;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  ceph_msg_header  header;      <span class="comment">// 消息头</span></span><br><span class="line">  ceph_msg_footer  footer;      <span class="comment">// 消息尾</span></span><br><span class="line">  bufferlist       payload;  <span class="comment">// "front" unaligned blob</span></span><br><span class="line">  bufferlist       middle;   <span class="comment">// "middle" unaligned blob</span></span><br><span class="line">  bufferlist       data;     <span class="comment">// data payload (page-alignment will be preserved where possible)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* recv_stamp is set when the Messenger starts reading the</span></span><br><span class="line"><span class="comment">   * Message off the wire */</span></span><br><span class="line">  <span class="keyword">utime_t</span> recv_stamp;       <span class="comment">//开始接收数据的时间戳</span></span><br><span class="line">  <span class="comment">/* dispatch_stamp is set when the Messenger starts calling dispatch() on</span></span><br><span class="line"><span class="comment">   * its endpoints */</span></span><br><span class="line">  <span class="keyword">utime_t</span> dispatch_stamp;   <span class="comment">//dispatch 的时间戳</span></span><br><span class="line">  <span class="comment">/* throttle_stamp is the point at which we got throttle */</span></span><br><span class="line">  <span class="keyword">utime_t</span> throttle_stamp;   <span class="comment">//获取throttle 的slot的时间戳</span></span><br><span class="line">  <span class="comment">/* time at which message was fully read */</span></span><br><span class="line">  <span class="keyword">utime_t</span> recv_complete_stamp;  <span class="comment">//接收完成的时间戳</span></span><br><span class="line"></span><br><span class="line">  ConnectionRef connection;     <span class="comment">//网络连接</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> magic = <span class="number">0</span>;           <span class="comment">//消息的魔术字</span></span><br><span class="line"></span><br><span class="line">  bi::list_member_hook&lt;&gt; dispatch_q;    <span class="comment">//boost::intrusive 成员字段</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ceph_msg_header</span> &#123;</span></span><br><span class="line">    __le64 seq;       <span class="comment">// 当前session内 消息的唯一 序号</span></span><br><span class="line">    __le64 tid;       <span class="comment">// 消息的全局唯一的 id</span></span><br><span class="line">    __le16 type;      <span class="comment">// 消息类型</span></span><br><span class="line">    __le16 priority;  <span class="comment">// 优先级</span></span><br><span class="line">    __le16 version;   <span class="comment">// 版本号</span></span><br><span class="line"></span><br><span class="line">    __le32 front_len; <span class="comment">// payload 的长度</span></span><br><span class="line">    __le32 middle_len;<span class="comment">// middle 的长度</span></span><br><span class="line">    __le32 data_len;  <span class="comment">// data 的 长度</span></span><br><span class="line">    __le16 data_off;  <span class="comment">// 对象的数据偏移量</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ceph_entity_name</span> <span class="title">src</span>;</span> <span class="comment">//消息源</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* oldest code we think can decode this.  unknown if zero. */</span></span><br><span class="line">    __le16 compat_version;</span><br><span class="line">    __le16 reserved;</span><br><span class="line">    __le32 crc;       <span class="comment">/* header crc32c */</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ceph_msg_footer</span> &#123;</span></span><br><span class="line">    __le32 front_crc, middle_crc, data_crc; <span class="comment">//crc校验码</span></span><br><span class="line">    __le64  sig; <span class="comment">//消息的64位signature</span></span><br><span class="line">    __u8 flags; <span class="comment">//结束标志</span></span><br><span class="line">&#125; __attribute__ ((packed));</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Ceph </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes_Istio-Gateway_Ingress-Controller</title>
      <link href="/passages/Kubernetes-Istio-Gateway-Ingress-Controller/"/>
      <url>/passages/Kubernetes-Istio-Gateway-Ingress-Controller/</url>
      
        <content type="html"><![CDATA[<blockquote><p>最近在istio，然后想总结下ingress-controller和istio-gateway的区别。</p><p>在Kubernetes环境中，Kubernetes Ingress用于配置需要在集群外部公开的服务。</p><p>但是在Istio服务网格中，更好的方法是使用新的配置模型，即Istio Gateway；Gateway允许将Istio流量管理的功能应用于进入集群的流量。</p><p>这里的ingress为nginx ingress</p></blockquote><p>通过灰度发布，来看一下ingress与istio的实现方式的差异 <a id="more"></a></p><h3 id="环境准备："><a href="#环境准备：" class="headerlink" title="环境准备："></a>环境准备：</h3><blockquote><p>kubernetes环境     1.13.5</p><p>部署istio                 1.1.1</p></blockquote><h3 id="Istio："><a href="#Istio：" class="headerlink" title="Istio："></a>Istio：</h3><blockquote><p>部署两个服务：</p><p>old</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/xxxxx/old-nginx</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    run:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><blockquote><p>new</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    matchLabels:</span></span><br><span class="line"><span class="attr">      run:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        run:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/xxxxx/new-nginx</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">          protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">    protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    run:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">  sessionAffinity:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><blockquote><p>输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get svc</span></span><br><span class="line">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP   172.19.0.1      &lt;none&gt;        443/TCP        9h</span><br><span class="line">new-nginx    NodePort    172.19.8.168    &lt;none&gt;        80:31904/TCP   4h</span><br><span class="line">old-nginx    NodePort    172.19.12.148   &lt;none&gt;        80:31545/TCP   4h</span><br></pre></td></tr></table></figure><blockquote><p>测试两个服务</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl run -it --rm bash --image=appropriate/curl --restart=Never curl 172.19.8.168</span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> kubectl run -it --rm bash --image=appropriate/curl --restart=Never curl 172.19.12.148</span></span><br><span class="line">old</span><br></pre></td></tr></table></figure><blockquote><p>创建Gateway对象/用的istio官方yaml</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld-gateway</span> <span class="comment"># name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    istio:</span> <span class="string">ingressgateway</span>  <span class="comment"># use istio default controller</span></span><br><span class="line"><span class="attr">  servers:</span></span><br><span class="line"><span class="attr">  - port:</span></span><br><span class="line"><span class="attr">      number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">http</span></span><br><span class="line"><span class="attr">      protocol:</span> <span class="string">HTTP</span></span><br><span class="line"><span class="attr">    hosts:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure><blockquote><p>确定Istio入口IP和port</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl get svc istio-ingressgateway -n istio-system</span></span><br><span class="line">NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)                                      AGE</span><br><span class="line">istio-ingressgateway   LoadBalancer   172.19.14.182   (pending)   80:31380/TCP,443:31390/TCP,31400:31400/...   10h</span><br></pre></td></tr></table></figure><blockquote><p>确认<code>EXTERNAL-IP</code>设置了值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export INGRESS_HOST= $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.status.loadBalancer.ingress[0].ip&#125;')</span><br><span class="line">export INGRESS_PORT= $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="http")].port&#125;')</span><br><span class="line">export SECURE_INGRESS_PORT= $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='&#123;.spec.ports[?(@.name=="https")].port&#125;')</span><br></pre></td></tr></table></figure><blockquote><p>满足特定规则：</p><p>例如，我们希望请求头中带有user且值为new的客户端请求才能访问new service</p><p>我们可以创建一个对应的<code>VirtualService</code>为通过<code>Gateway</code>进入的流量配置路由</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span>   <span class="comment"># istio route rule </span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld</span>     <span class="comment"># name</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">helloworld-gateway</span> <span class="comment"># link Gateway</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">new</span>       <span class="comment"># match headers -&gt; user (-&gt; exact -&gt;) new  [headers: user: new]</span></span><br><span class="line"><span class="attr">    route:</span>                 <span class="comment"># 会访问new-nginx，满足头部要求即可</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">  - route:</span>                 <span class="comment"># 否则就访问old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><blockquote><p>客户端测试</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br></pre></td></tr></table></figure><blockquote><p>在满足特定规则和权重：</p><p>例如，我们希望请求头中带有user且值为new的客户端请求有50%的比例访问new service，那么我们可以创建一个这样的<code>VirtualService</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">helloworld-gateway</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - match:</span></span><br><span class="line"><span class="attr">    - headers:</span></span><br><span class="line"><span class="attr">        user:</span></span><br><span class="line"><span class="attr">          exact:</span> <span class="string">new</span>          <span class="comment"># 这里跟上面的一样，符合头部 user: new就会访问到这一层</span></span><br><span class="line"><span class="attr">    route:</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">50</span>              </span><br><span class="line">                             <span class="comment"># 另外因为这里设置了两个访问规则，即首先符合头部，然后会有50%的几率会访问到new-nginx，另外50%会访问到old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">50</span></span><br><span class="line"><span class="attr">  - route:</span>                    <span class="comment"># 如果不匹配头部，那就全部访问到old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><blockquote><p>客户端测试</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl -H <span class="string">"user: new"</span> http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br></pre></td></tr></table></figure><blockquote><p>权重随机访问：</p><p>例如，我们仅仅希望20%的客户端请求访问new service，那么我们可以创建一个这样的<code>VirtualService</code></p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">helloworld</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  gateways:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">helloworld-gateway</span></span><br><span class="line"><span class="attr">  hosts:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">  - route:</span>                        </span><br><span class="line">  <span class="comment"># 这条virtual Service 设置了权重来几率性访问nginx；20%new-nginx，80% old-nginx</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">20</span></span><br><span class="line"><span class="attr">    - destination:</span></span><br><span class="line"><span class="attr">        host:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">        port:</span></span><br><span class="line"><span class="attr">          number:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">      weight:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>客户端测试</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">old</span><br><span class="line"><span class="meta">$</span><span class="bash"> curl http://<span class="variable">$INGRESS_HOST</span>:<span class="variable">$INGRESS_PORT</span></span></span><br><span class="line">new</span><br></pre></td></tr></table></figure><h3 id="Nginx-Ingress"><a href="#Nginx-Ingress" class="headerlink" title="Nginx Ingress"></a>Nginx Ingress</h3><blockquote><p>不支持权重，貌似能够支持headers头</p></blockquote><p>Nginx:</p><blockquote><p>使用$http_ 获取http请求的header，根据配置中是否为完整或者正则匹配，匹配foo的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ....</span><br><span class="line">    if ($http_foo = "bar") &#123;  //完全匹配</span><br><span class="line">    #if ($http_foo ~ "bar") &#123;  //正则匹配</span><br><span class="line">           proxy_pass http://default-new-nginx-80;</span><br><span class="line">           break;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://default-old-nginx-80;</span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>使用$cookie_获取http请求的cookie，根据配置中是否为完整或者正则匹配，匹配foo的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ....</span><br><span class="line">    if ($cookie_foo ~ "^bar") &#123;  //正则匹配</span><br><span class="line">    # if ($cookie_foo = "bar") &#123;  //完全匹配</span><br><span class="line">         proxy_pass http://default-new-nginx-80;</span><br><span class="line">         break;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://default-old-nginx-80;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><blockquote><p>使用$arg_获取http的请求参数，根据配置中是否为完整或者正则匹配，匹配foo的值</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    ....</span><br><span class="line">    if ($arg_foo ~ "^bar") &#123;  //正则匹配</span><br><span class="line">    # if ($arg_foo = "bar") &#123;  //完全匹配</span><br><span class="line">         proxy_pass http://default-new-nginx-80;</span><br><span class="line">         break;</span><br><span class="line">    &#125;</span><br><span class="line">    proxy_pass http://default-old-nginx-80;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>这里用到的两个服务为istio用的两个服务：</p><blockquote><p>应用部署完毕后，我们看要怎么配置ingress才能够正确的刷新到ngixn.conf，在nginx-ingress-controller中，它支持 nginx.ingress.kubernetes.io/configuration-snippet 这样一个注解允许我们在location里配置自定义需求。同时结合nginx-ingress-controller的upstream命名方式namespace-serviceName-port的方式配置注解信息。如下ingress yaml所示:</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">nginx.ingress.kubernetes.io/configuration-snippet:</span> <span class="string">|</span></span><br><span class="line"><span class="string">       if ($http_foo ~ "^.*bar$") &#123;</span></span><br><span class="line"><span class="string">         proxy_pass http://default-new-nginx-80;</span></span><br><span class="line"><span class="string">         break;</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string"></span><span class="attr">  name:</span> <span class="string">gray-release</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  rules:</span></span><br><span class="line"><span class="attr">    - host:</span> <span class="string">www.example.com</span></span><br><span class="line"><span class="attr">      http:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="attr">          - backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">old-nginx</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/</span></span><br><span class="line"><span class="attr">          - backend:</span></span><br><span class="line"><span class="attr">              serviceName:</span> <span class="string">new-nginx</span></span><br><span class="line"><span class="attr">              servicePort:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">            path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure><blockquote><p>输出</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> curl -H "Host: www.example.com"  http://172.16.0.9</span><br><span class="line">old</span><br><span class="line"> curl -H "Host: www.example.com"  http://172.16.0.9</span><br><span class="line">old</span><br><span class="line"> curl -H "Host: www.example.com"  http://172.16.0.9</span><br><span class="line">old</span><br><span class="line"> curl -H "Host: www.example.com" -H "foo: bar" http://172.16.0.9</span><br><span class="line">new</span><br><span class="line"> curl -H "Host: www.example.com" -H "foo: bar" http://172.16.0.9</span><br><span class="line">new</span><br><span class="line"> curl -H "Host: www.example.com" -H "foo: bar" http://172.16.0.9</span><br><span class="line">new</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Ingress </tag>
            
            <tag> Istio </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes_1.13.5_ingress</title>
      <link href="/passages/Kubernetes-1-13-5%E9%83%A8%E7%BD%B2ingress/"/>
      <url>/passages/Kubernetes-1-13-5%E9%83%A8%E7%BD%B2ingress/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes部署mysql-opreator</title>
      <link href="/passages/Kubernetes%E9%83%A8%E7%BD%B2mysql-opreator/"/>
      <url>/passages/Kubernetes%E9%83%A8%E7%BD%B2mysql-opreator/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
            <tag> kubernetes-opreator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安装-kubeadm_1.13.5(非外部etcd)</title>
      <link href="/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5-%E9%9D%9E%E5%A4%96%E9%83%A8etcd/"/>
      <url>/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5-%E9%9D%9E%E5%A4%96%E9%83%A8etcd/</url>
      
        <content type="html"><![CDATA[<blockquote><p>之前写过一篇kubernetes安装的，用到的是外部的etcd，即etcd单独二进制安装，kubeadm初始化指定即可；</p><p>本篇用的纯kubeadm安装高可用集群，master组件静态pod</p></blockquote><h2 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h2><blockquote><p>kubernetes version：1.13.5</p><p>docker version：18.6.3</p><p>Redhat：7.6</p></blockquote><a id="more"></a><table><thead><tr><th style="text-align:left">x.x.x.1</th><th style="text-align:center">master-1</th><th>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</th></tr></thead><tbody><tr><td style="text-align:left"><strong>x.x.x.2</strong></td><td style="text-align:center"><strong>master-2</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.3</strong></td><td style="text-align:center"><strong>master-3</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.4</strong></td><td style="text-align:center"><strong>vip</strong></td><td></td></tr><tr><td style="text-align:left"><strong>x.x.x.5</strong></td><td style="text-align:center"><strong>node-1</strong></td><td><strong>kubelet、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.6</strong></td><td style="text-align:center"><strong>node-2</strong></td><td><strong>kubelet、docker</strong></td></tr></tbody></table><p>因为担心kubeadm起来的etcd不稳定，这里用到的etcd对于kubernetes来说作为外部etcd集群。即使用二进制安装etcd集群，其余组件用kubeadm来完成安装。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">echo "1" &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭Swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed 's/.*swap.*/#&amp;/' /etc/fstab</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭防火墙</span></span><br><span class="line">systemctl disable firewalld &amp;&amp; systemctl stop firewalld &amp;&amp; systemctl status firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭Selinux</span></span><br><span class="line">setenforce  0</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="2、docker安装"><a href="#2、docker安装" class="headerlink" title="2、docker安装"></a>2、docker安装</h3><h4 id="1、下载设置源"><a href="#1、下载设置源" class="headerlink" title="1、下载设置源"></a>1、下载设置源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.daocloud.io/docker/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="2、安装docker"><a href="#2、安装docker" class="headerlink" title="2、安装docker"></a>2、安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r  # 列出docker-ce的版本list</span><br><span class="line">yum install docker-ce-&lt;版本号&gt; -y # -y 安装docker需要的依赖，其中有个container-selinux的也可以单独下载</span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm -ivh container-selinux-2.33-1.git86f33cd.el7.noarch.rpm</span></span><br></pre></td></tr></table></figure><h4 id="3、启动docker"><a href="#3、启动docker" class="headerlink" title="3、启动docker"></a>3、启动docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">docker version # 验证docker安装是否完成并启动成功</span><br></pre></td></tr></table></figure><h3 id="3、kubeadm-kubelet-kubectl安装"><a href="#3、kubeadm-kubelet-kubectl安装" class="headerlink" title="3、kubeadm/kubelet/kubectl安装"></a>3、kubeadm/kubelet/kubectl安装</h3><blockquote><p>各节点安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.13.5 kubeadm-1.13.5 kubectl-1.13.5 --disableexcludes=kubernetes  #禁用除kubernetes之外的仓库,要用 -y 参数，会自动安装kube-cni等插件</span><br><span class="line"></span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet # kubeadm 要求kubelet保持开机自启状态</span><br></pre></td></tr></table></figure><h3 id="4、keepalive安装"><a href="#4、keepalive安装" class="headerlink" title="4、keepalive安装"></a>4、keepalive安装</h3><blockquote><p>master节点安装：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line"></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script CheckK8sMaster &#123;</span><br><span class="line">    script &quot;curl -k https://10.70.49.130:6443&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    timeout 9</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens256 # 网卡</span><br><span class="line">    virtual_router_id 61</span><br><span class="line">    # 主节点权重最高 依次减少</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line">    #修改为本地IP </span><br><span class="line">    mcast_src_ip x.x.x.2</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass sqP05dQgMSlzrxHj</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        x.x.x.1</span><br><span class="line">        #x.x.x.2</span><br><span class="line">        x.x.x.3</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        x.x.x.4</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        CheckK8sMaster</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="kubernetes部署"><a href="#kubernetes部署" class="headerlink" title="kubernetes部署"></a>kubernetes部署</h2><h4 id="1、master部署"><a href="#1、master部署" class="headerlink" title="1、master部署"></a>1、master部署</h4><blockquote><p>部署之前请确保下载好相关image，翻墙下载或者国内dockerhub下载kubernetes镜像</p></blockquote><h5 id="1、初始化master1"><a href="#1、初始化master1" class="headerlink" title="1、初始化master1"></a>1、初始化master1</h5><blockquote><p>创建master1的初始化配置文件,网络插件采用flannel，CIDR地址是 “10.244.0.0/16”，如下为1.13.5新版本配置文件。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubeadm-master.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">nodeRegistration:</span><br><span class="line">  name: 10.78.229.193        # 指定node name，kubectl get no会显示ip</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: x.x.x.1  # 本机ip，这里为x.x.x.1-3</span><br><span class="line">  bindPort: 6443</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.5   # kubernetes版本 对应下载的image</span><br><span class="line">imageRepository: k8s.gcr.io  # 自己修改为自己的镜像库名</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - "master1"</span><br><span class="line">  - "master2"</span><br><span class="line">  - "master3"</span><br><span class="line">  - "x.x.x.1"</span><br><span class="line">  - "x.x.x.2"</span><br><span class="line">  - "x.x.x.3"</span><br><span class="line">  - "x.x.x.4"</span><br><span class="line">  - "127.0.0.1"</span><br><span class="line"></span><br><span class="line">controlPlaneEndpoint: "x.x.x.4:8443" # 控制台ip指定，即vip 实现apiserver高可用</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd     # 随意指定即可</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: "10.244.0.0/16"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行初始化命令即可，前提要把相关设置关闭，详情至准备工作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中在kubelet配置里加入--pod-infra-container-image 参数指定 pause私有镜像库镜像</span></span><br><span class="line">kubeadm init --config kubeadm-master.yaml</span><br></pre></td></tr></table></figure><blockquote><p>在初始化配置里，对于etcd有两种高可用的选项，一个使用内部etcd，一个使用外部etcd(独立搭建的etcd集群，而不是在初始化中搭建的)，两者初始化配置文件略有不同。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用内部etcd的话，初始化yaml文件中etcd配置如下：</span></span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: "https://127.0.0.1:2379,https://x.x.x.x:2379"</span><br><span class="line">      advertise-client-urls: "https://x.x.x.x:2379"</span><br><span class="line">      listen-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-advertise-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-cluster: "master1.hanli.com=https://x.x.x.x:2380"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用外部etcd的话，</span></span><br><span class="line">etcd:    #ETCD的地址</span><br><span class="line">   external:</span><br><span class="line">     endpoints:</span><br><span class="line">     - https://x.x.x.1:2379</span><br><span class="line">     - https://x.x.x.2:2379</span><br><span class="line">     - https://x.x.x.3:2379</span><br></pre></td></tr></table></figure><blockquote><p>init初始化之后，如果成功会出现<code>join</code>，这时就可以运行一下命令</p><p>机器上的用户要使用<code>kubectl</code>来管理集群操作集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><blockquote><p>验证命令</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs # 如下信息</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br><span class="line"></span><br><span class="line">kubectl get node # notReady 状态，是因为没有安装网络插件 Name成ip，可修改kubelet的启动参数即可</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1     NotReady      master     1m      v1.13.5</span><br></pre></td></tr></table></figure><h5 id="2、启动flannel服务"><a href="#2、启动flannel服务" class="headerlink" title="2、启动flannel服务"></a>2、启动flannel服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> flannel 默认会使用主机的第一张网卡，如果你有多张网卡，需要通过配置单独指定。修改 kube-flannel.yml 中的以下部分</span></span><br><span class="line">cat kube-flannel.yml </span><br><span class="line"> containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.11.0-amd64 # 修改下自己私有镜像库的flannel镜像名</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=ens33              #添加</span><br></pre></td></tr></table></figure><hr><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml # 创建pod，因为是ds的所以后续集群里面加节点就会自动启动flannel</span><br><span class="line">kubectl get node # 会发现 node状态变成了 Ready</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1       Ready      master     10m      v1.13.5</span><br><span class="line"></span><br><span class="line">kubectl get po --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-86c58d9df4-r59rv                   1/1     Running   0          59m</span><br><span class="line">kube-system   coredns-86c58d9df4-rbzx5                   1/1     Running   0          59m</span><br><span class="line">kube-system   kube-apiserver-master1                     1/1     Running   0          58m</span><br><span class="line">kube-system   kube-controller-manager-master1            1/1     Running   16         58m</span><br><span class="line">kube-system   kube-flannel-ds-amd64-229j2                1/1     Running   0          42m</span><br><span class="line">kube-system   kube-proxy-4wrg5                           1/1     Running   0          59m</span><br><span class="line">kube-system   kube-scheduler-master1                     1/1     Running   13         58m</span><br></pre></td></tr></table></figure><blockquote><p>不是running状态，就说明出错了，通过查看</p><p>描述：kubectl describe pod kube-scheduler-master.hanli.com -n kube-system</p><p>日志：kubectl logs kube-scheduler-master.hanli.com -n kube-system</p><p>flannel服务启动成功后，coredns也就会自动启动成功，状态为Running</p></blockquote><h5 id="3、初始化其他master节点"><a href="#3、初始化其他master节点" class="headerlink" title="3、初始化其他master节点"></a>3、初始化其他master节点</h5><blockquote><p>首先把master1上生成的ca证书等，拷贝到其他master节点上，最好免密，可使用pscp等批量任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#!/bin/bash</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#注意修改为自己的主机名</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">export</span> CONTROL_PLANE_IPS=<span class="string">"master2 master3"</span>  </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 保证节点有/etc/kubernetes/pki目录</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 把以下证书复制到其他master节点</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$&#123;CONTROL_PLANE_IPS&#125;</span>; <span class="keyword">do</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># ！！！修正拷贝证书的时候请指定特定证书拷贝（之前的已经备注，新加的有etcd目录，没有用外部etcd集群），因为在证书拷贝的情况下吃过亏，因此修改此处！！！</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 附issue：https://github.com/kubernetes/kubeadm/issues/1321 </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 找了好久终于！！！哭</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/pki/*.crt $host:/etc/kubernetes/pki/</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/pki/*.key $host:/etc/kubernetes/pki/</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/pki/*.pub $host:/etc/kubernetes/pki/</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/admin.conf $host:/etc/kubernetes/admin.conf</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/ca.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/sa.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/front-proxy-ca.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/etcd/ca.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/etcd/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/admin.conf <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> tree /etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> /etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-etcd-client.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-etcd-client.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-kubelet-client.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-kubelet-client.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── ca.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── ca.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-ca.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-ca.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-client.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-client.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── sa.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> └── sa.pub</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 分别修改对应ip 参数`--node-name`，在在master2、3执行master1出现的join命令即可 步骤如下：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于控制平面node 增加 `--experimental-control-plane` 即可，只有master node采用，更方便。当然还有复杂的通过原子操作来add etcd node 增加 etcd-cluster</span></span><br><span class="line">kubeadm join x.x.x.4:8443 --token bnnsb7.amapp1t78llxn54d --discovery-token-ca-cert-hash sha256:520ef89be84c30e480db6d441a7e4179634a9455f0009e249ebe8f35fa792087 --experimental-control-plane --node-name=x.x.x.2#(对应主机ip) </span><br><span class="line"><span class="meta">#</span><span class="bash"> 等待kube-proxy flannel启动成功即可</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种方案，kubectl get cs直观的看不到etcd集群的，可通过一下命令：</span></span><br><span class="line">kubectl exec -n kube-system etcd-x.x.x.1 -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://x.x.x.1:2379 member list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这里把master2、3节点采用原子操作加入etcd集群步骤写下来：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置证书</span></span><br><span class="line">kubeadm init phase certs all --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd证书</span></span><br><span class="line">kubeadm init phase etcd local --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成kubelet配置文件</span></span><br><span class="line">kubeadm init phase kubeconfig kubelet --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动kubelet</span></span><br><span class="line">kubeadm init phase kubelet-start --config kubernetes.yaml </span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置kubectl命令</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd集群加节点</span></span><br><span class="line">kubectl exec -n kube-system etcd-x.x.x.1 -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://x.x.x.1:2379 member add etcd2 https://x.x.x.2:2380</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 kube-apiserver、kube-controller-manager、kube-scheduler</span></span><br><span class="line">kubeadm init phase kubeconfig all --config kubernetes.yaml</span><br><span class="line">kubeadm init phase control-plane all --config kubernetes.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 标记master</span></span><br><span class="line">kubeadm init phase mark-control-plane --config kubernetes.yaml</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n kube-system</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-9f9d9c76-4zrt4                  1/1     Running   0          2d</span><br><span class="line">coredns-9f9d9c76-dqd4c                  1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-1   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-2   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-3   1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-7ghn7             1/1     Running   1          2d</span><br><span class="line">kube-flannel-ds-amd64-9cqts             1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-f57nh             1/1     Running   1          2d</span><br><span class="line">kube-proxy-8fwts                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-95tjb                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-bls94                        1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kubernetes-dashboard-67d49f7868-x79wf   1/1     Running   0          76m</span><br></pre></td></tr></table></figure><h4 id="2、Work节点加入集群"><a href="#2、Work节点加入集群" class="headerlink" title="2、Work节点加入集群"></a>2、Work节点加入集群</h4><blockquote><p>输入master节点初始化成功之后出现的<code>join</code>命令，出现<code>kubectl get nodes</code>即成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> kubeadm join x.x.x.4:8443 --token bnnsb7.amapp1t78llxn54d --discovery-token-ca-cert-hash sha256:520ef89be84c30e480db6d441a7e4179634a9455f0009e249ebe8f35fa792087</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><h4 id="3、集群验证"><a href="#3、集群验证" class="headerlink" title="3、集群验证"></a>3、集群验证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 节点状态</span></span><br><span class="line">[root@master] ~$ kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 组件状态</span></span><br><span class="line">[root@master] ~$  kubectl get cs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务账户</span></span><br><span class="line">[root@master] ~$ kubectl get serviceaccount</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群信息</span></span><br><span class="line">[root@master] ~$ kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证dns功能</span></span><br><span class="line">[root@master] ~$ kubectl run curl --image=radial/busyboxplus:curl -it</span><br><span class="line">[ root@curl-66959f6557-r4crd:/ ]$ nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure><blockquote><p>附录：</p><p><strong><code>打算把以前kubernetes二进制安装的步骤，也迁过来。kubeadm已经GA，之后也会一直用kubeadm了</code></strong></p><p><strong><em><code>kubeadm token create --print-join-command</code></em></strong>可以获取 kubeadm join命令，比以前真的方便很多了         =。=</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># kubelet.service配置文件 /use/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><hr><p>参考链接：</p><p>kubeadm安装1.13.5：<a href="https://blog.csdn.net/fanren224/article/details/86573264#2master1_165" target="_blank" rel="noopener">https://blog.csdn.net/fanren224/article/details/86573264#2master1_165</a></p><p>二进制安装：<a href="https://github.com/mritd/ktool" target="_blank" rel="noopener">https://github.com/mritd/ktool</a></p><p>二进制安装kubernetes_v1.13.4：<a href="https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/" target="_blank" rel="noopener">https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/</a></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Kubernetes_install </tag>
            
            <tag> Kubernetes_ha </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_set集合操作</title>
      <link href="/passages/Python-set%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/"/>
      <url>/passages/Python-set%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="Python-set集合类型小结"><a href="#Python-set集合类型小结" class="headerlink" title="Python_set集合类型小结"></a>Python_set集合类型小结</h2><p>下面来点简单的小例子说明把。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x = set(<span class="string">'spam'</span>)</span><br><span class="line">y = set([<span class="string">'h'</span>,<span class="string">'a'</span>,<span class="string">'m'</span>])</span><br><span class="line">x, y</span><br><span class="line">(set([<span class="string">'a'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'m'</span>]), set([<span class="string">'a'</span>, <span class="string">'h'</span>, <span class="string">'m'</span>]))</span><br></pre></td></tr></table></figure><p>再来些小应用。<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; &gt; x &amp; y <span class="comment"># 交集</span></span><br><span class="line">&gt; &gt; &gt; set([<span class="string">'a'</span>, <span class="string">'m'</span>])</span><br><span class="line"></span><br><span class="line">&gt; &gt; &gt; x | y <span class="comment"># 并集</span></span><br><span class="line">&gt; &gt; &gt; set([<span class="string">'a'</span>, <span class="string">'p'</span>, <span class="string">'s'</span>, <span class="string">'h'</span>, <span class="string">'m'</span>])</span><br><span class="line"></span><br><span class="line">&gt; &gt; &gt; x - y <span class="comment"># 差集</span></span><br><span class="line">&gt; &gt; &gt; set([<span class="string">'p'</span>, <span class="string">'s'</span>])</span><br></pre></td></tr></table></figure><p>记得以前个网友提问怎么去除海量列表里重复元素，用hash来解决也行，只不过感觉在性能上不是很高，用set解决还是很不错的，示例如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>,<span class="number">11</span>,<span class="number">22</span>]</span><br><span class="line">b = set(a)</span><br><span class="line">b</span><br><span class="line">set([<span class="number">33</span>, <span class="number">11</span>, <span class="number">44</span>, <span class="number">22</span>])</span><br><span class="line">c = [i <span class="keyword">for</span> i <span class="keyword">in</span> b]</span><br><span class="line">c</span><br><span class="line">[<span class="number">33</span>, <span class="number">11</span>, <span class="number">44</span>, <span class="number">22</span>]</span><br></pre></td></tr></table></figure><p>很酷把，几行就可以搞定。</p><h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>集合用于包含一组无序的对象。要创建集合，可使用set()函数并像下面这样提供一系列的项：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = set([<span class="number">3</span>,<span class="number">5</span>,<span class="number">9</span>,<span class="number">10</span>])      <span class="comment">#创建一个数值集合</span></span><br><span class="line">t = set(<span class="string">"Hello"</span>)         <span class="comment">#创建一个唯一字符的集合</span></span><br></pre></td></tr></table></figure><p>与列表和元组不同，集合是无序的，也无法通过数字进行索引。此外，集合中的元素不能重复。例如，如果检查前面代码中t集合的值，结果会是:</p> <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; &gt; &gt; t</span><br><span class="line">set([<span class="string">'H'</span>, <span class="string">'e'</span>, <span class="string">'l'</span>, <span class="string">'o'</span>])</span><br></pre></td></tr></table></figure><p>注意只出现了一个’l’。</p><p>集合支持一系列标准操作，包括并集、交集、差集和对称差集，例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = t | s          <span class="comment"># t 和 s的并集</span></span><br><span class="line">b = t &amp; s          <span class="comment"># t 和 s的交集</span></span><br><span class="line">c = t – s          <span class="comment"># 求差集（项在t中，但不在s中）</span></span><br><span class="line">d = t ^ s          <span class="comment"># 对称差集（项在t或s中，但不会同时出现在二者中）</span></span><br></pre></td></tr></table></figure><p>基本操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t.add(<span class="string">'x'</span>)            <span class="comment"># 添加一项</span></span><br><span class="line"></span><br><span class="line">s.update([<span class="number">10</span>,<span class="number">37</span>,<span class="number">42</span>])  <span class="comment"># 在s中添加多项</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">t.remove(<span class="string">'H'</span>)</span><br><span class="line"><span class="comment"># 使用remove()可以删除一项：</span></span><br><span class="line"></span><br><span class="line">len(s)</span><br><span class="line"><span class="comment"># set 的长度</span></span><br><span class="line"></span><br><span class="line">x <span class="keyword">in</span> s</span><br><span class="line"><span class="comment"># 测试 x 是否是 s 的成员</span></span><br><span class="line"></span><br><span class="line">x <span class="keyword">not</span> <span class="keyword">in</span> s</span><br><span class="line"><span class="comment"># 测试 x 是否不是 s 的成员</span></span><br><span class="line"></span><br><span class="line">s.issubset(t)</span><br><span class="line">s &lt;= t</span><br><span class="line"><span class="comment"># 测试是否 s 中的每一个元素都在 t 中</span></span><br><span class="line"></span><br><span class="line">s.issuperset(t)</span><br><span class="line">s &gt;= t</span><br><span class="line"><span class="comment"># 测试是否 t 中的每一个元素都在 s 中</span></span><br><span class="line"></span><br><span class="line">s.union(t)</span><br><span class="line">s | t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 和 t 中的每一个元素</span></span><br><span class="line"></span><br><span class="line">s.intersection(t)</span><br><span class="line">s &amp; t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 和 t 中的公共元素</span></span><br><span class="line"></span><br><span class="line">s.difference(t)</span><br><span class="line">s - t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 中有但是 t 中没有的元素</span></span><br><span class="line"></span><br><span class="line">s.symmetric_difference(t)</span><br><span class="line">s ^ t</span><br><span class="line"><span class="comment"># 返回一个新的 set 包含 s 和 t 中不重复的元素</span></span><br><span class="line"></span><br><span class="line">s.copy()</span><br><span class="line"><span class="comment"># 返回 set “s”的一个浅复制</span></span><br></pre></td></tr></table></figure><blockquote><p>请注意：union(), intersection(), difference() 和 symmetric_difference() 的非运算符（non-operator，就是形如 s.union()这样的）版本将会接受任何 iterable 作为参数。相反，它们的运算符版本（operator based counterparts）要求参数必须是 sets。这样可以避免潜在的错误，如：为了更可读而使用 set(‘abc’) &amp; ‘cbs’ 来替代 set(‘abc’).intersection(‘cbs’)。从 2.3.1 版本中做的更改：以前所有参数都必须是 sets。</p><p>另外，Set 和 ImmutableSet 两者都支持 set 与 set 之间的比较。两个 sets 在也只有在这种情况下是相等的：每一个 set 中的元素都是另一个中的元素（二者互为subset）。一个 set 比另一个 set 小，只有在第一个 set 是第二个 set 的 subset 时（是一个 subset，但是并不相等）。一个 set 比另一个 set 打，只有在第一个 set 是第二个 set 的 superset 时（是一个 superset，但是并不相等）</p></blockquote><p><strong>子 set 和相等比较并不产生完整的排序功能。例如：任意两个 sets 都不相等也不互为子 set，因此以下的运算都会返回 False：a&lt;b, a==b, 或者a&gt;b。因此，sets 不提供 <strong>cmp</strong> 方法。</strong></p><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">hash(s)</span><br><span class="line"><span class="comment"># 返回 s 的 hash 值</span></span><br><span class="line"></span><br><span class="line">s.update(t)</span><br><span class="line">s |= t</span><br><span class="line"><span class="comment"># 返回增加了 set “t”中元素后的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.intersection_update(t)</span><br><span class="line">s &amp;= t</span><br><span class="line"><span class="comment"># 返回只保留含有 set “t”中元素的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.difference_update(t)</span><br><span class="line">s -= t</span><br><span class="line"><span class="comment"># 返回删除了 set “t”中含有的元素后的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.symmetric_difference_update(t)</span><br><span class="line">s ^= t</span><br><span class="line"><span class="comment"># 返回含有 set “t”或者 set “s”中有而不是两者都有的元素的 set “s”</span></span><br><span class="line"></span><br><span class="line">s.add(x)</span><br><span class="line"><span class="comment"># 向 set “s”中增加元素 x</span></span><br><span class="line"></span><br><span class="line">s.remove(x)</span><br><span class="line"><span class="comment"># 从 set “s”中删除元素 x, 如果不存在则引发 KeyError</span></span><br><span class="line"></span><br><span class="line">s.discard(x)</span><br><span class="line"><span class="comment"># 如果在 set “s”中存在元素 x, 则删除</span></span><br><span class="line"></span><br><span class="line">s.pop()</span><br><span class="line"><span class="comment"># 删除并且返回 set “s”中的一个不确定的元素, 如果为空则引发 KeyError，随机删除并打印</span></span><br><span class="line"></span><br><span class="line">s.clear()</span><br><span class="line"><span class="comment"># 删除 set “s”中的所有元素</span></span><br></pre></td></tr></table></figure><blockquote><p>请注意：非运算符版本的 update(), intersection_update(), difference_update()和symmetric_difference_update()将会接受任意 iterable 作为参数。从 2.3.1 版本做的更改：以前所有参数都必须是 sets。</p><p>还请注意：这个模块还包含一个 union_update() 方法，它是 update() 方法的一个别名。包含这个方法是为了向后兼容。程序员们应该多使用 update() 方法，因为这个方法也被内置的 set() 和 frozenset() 类型支持。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_list或dict合并</title>
      <link href="/passages/Python-list%E6%88%96dict%E5%90%88%E5%B9%B6/"/>
      <url>/passages/Python-list%E6%88%96dict%E5%90%88%E5%B9%B6/</url>
      
        <content type="html"><![CDATA[<h3 id="对于两个list、两个dict合并数据"><a href="#对于两个list、两个dict合并数据" class="headerlink" title="对于两个list、两个dict合并数据"></a>对于两个list、两个dict合并数据</h3><h4 id="1-两个字典："><a href="#1-两个字典：" class="headerlink" title="1.两个字典："></a>1.两个字典：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a= &#123;<span class="string">'a'</span>:<span class="number">1</span>,<span class="string">'b'</span>:<span class="number">2</span>,<span class="string">'c'</span>:<span class="number">3</span>&#125; </span><br><span class="line">b= &#123;<span class="string">'aa'</span>:<span class="number">11</span>,<span class="string">'bb'</span>:<span class="number">22</span>,<span class="string">'cc'</span>:<span class="number">33</span>&#125;</span><br></pre></td></tr></table></figure><p>合并1：dict(a,**b)  操作如下：<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = dict(a,**b)</span><br></pre></td></tr></table></figure><p>合并2：dict(a.items()+b.items())  如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = dict(a.item() + b.items())</span><br></pre></td></tr></table></figure><p>合并3：c = {}  c.update(a)  c.update(b) 输出c 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c = &#123;&#125;</span><br><span class="line">c.update(a)</span><br><span class="line">c.update(b)</span><br></pre></td></tr></table></figure><h3 id="2-两个list合并："><a href="#2-两个list合并：" class="headerlink" title="2.两个list合并："></a>2.两个list合并：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>] </span><br><span class="line">b = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>]</span><br></pre></td></tr></table></figure><p>合并1：a+b 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = a+b</span><br></pre></td></tr></table></figure><p>合并2：a+=b 这时a的值变成了合并后的结果，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a += b  <span class="comment"># ====&gt; a = a+b</span></span><br></pre></td></tr></table></figure><p>合并3：a.extend(b) 和+=结果一样，输出a  如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.extend(b) <span class="comment"># a += b</span></span><br></pre></td></tr></table></figure><p>合并4：a.append(b)将b看成list一个元素和a合并成一个新的list，合并后的结果输入a 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.append(b) <span class="comment"># list add other list &gt;&gt; [1,2,3,[1,2,3]]</span></span><br></pre></td></tr></table></figure><p> 合并5：a[0:0] = b 使用切片，如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a[<span class="number">0</span>:<span class="number">0</span>] = b</span><br></pre></td></tr></table></figure><blockquote><p>附录：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment"># 方法一：</span></span><br><span class="line">&gt; list1 = [<span class="string">'k1'</span>,<span class="string">'k2'</span>,<span class="string">'k3'</span>]</span><br><span class="line">&gt; list2 = [<span class="string">'v1'</span>,<span class="string">'v2'</span>,<span class="string">'v3'</span>]</span><br><span class="line">&gt; dic = dict(map(<span class="keyword">lambda</span> x,y:[x,y],list1,list2))</span><br><span class="line">&gt; &gt;&gt;&gt; print(dic)</span><br><span class="line">&gt; &#123;<span class="string">'k3'</span>: <span class="string">'v3'</span>, <span class="string">'k2'</span>: <span class="string">'v2'</span>, <span class="string">'k1'</span>: <span class="string">'v1'</span>&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment"># 方法二：</span></span><br><span class="line">&gt; &gt;&gt;&gt; dict(zip(list1,list2))</span><br><span class="line">&gt; &#123;<span class="string">'k3'</span>: <span class="string">'v3'</span>, <span class="string">'k2'</span>: <span class="string">'v2'</span>, <span class="string">'k1'</span>: <span class="string">'v1'</span>&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="comment"># 方法三：</span></span><br><span class="line">&gt; &gt;&gt;&gt; l1=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]</span><br><span class="line">&gt; &gt;&gt;&gt; l2=[<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]</span><br><span class="line">&gt; &gt;&gt;&gt; &#123;k:v <span class="keyword">for</span> k,v <span class="keyword">in</span> zip(l1,l2)&#125;</span><br><span class="line">&gt; &#123;<span class="number">1</span>: <span class="number">4</span>, <span class="number">2</span>: <span class="number">5</span>, <span class="number">3</span>: <span class="number">6</span>, <span class="number">4</span>: <span class="number">7</span>, <span class="number">5</span>: <span class="number">8</span>, <span class="number">6</span>: <span class="number">9</span>&#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; &gt;&gt;&gt; x = &#123;<span class="number">1</span>: <span class="number">4</span>, <span class="number">2</span>: <span class="number">5</span>, <span class="number">3</span>: <span class="number">6</span>, <span class="number">4</span>: <span class="number">7</span>, <span class="number">5</span>: <span class="number">8</span>, <span class="number">6</span>: <span class="number">9</span>&#125;</span><br><span class="line">&gt; &gt;&gt;&gt; &#123;v:k <span class="keyword">for</span> k,v <span class="keyword">in</span> x.items()&#125;            <span class="comment">#反过来 将字典中的v和k调换</span></span><br><span class="line">&gt; &#123;<span class="number">4</span>: <span class="number">1</span>, <span class="number">5</span>: <span class="number">2</span>, <span class="number">6</span>: <span class="number">3</span>, <span class="number">7</span>: <span class="number">4</span>, <span class="number">8</span>: <span class="number">5</span>, <span class="number">9</span>: <span class="number">6</span>&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></blockquote><blockquote></blockquote>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_list交集、差集和并集</title>
      <link href="/passages/Python-list%E4%BA%A4%E9%9B%86%E3%80%81%E5%B7%AE%E9%9B%86%E5%92%8C%E5%B9%B6%E9%9B%86/"/>
      <url>/passages/Python-list%E4%BA%A4%E9%9B%86%E3%80%81%E5%B7%AE%E9%9B%86%E5%92%8C%E5%B9%B6%E9%9B%86/</url>
      
        <content type="html"><![CDATA[<blockquote><p>举例说明</p></blockquote><p>a_list = [1,2,3,4]<br>b_list = [1,4,5]</p><h3 id="一-差集"><a href="#一-差集" class="headerlink" title="一. 差集"></a>一. 差集</h3><p>很明显结果是[2,3,5]，下面我们说一下具体方法。<a id="more"></a><br>方法a.正常法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ret_list = []</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> a_list:</span><br><span class="line">    <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> b_list:</span><br><span class="line">        ret_list.append(item)</span><br></pre></td></tr></table></figure><p>方法b.简化版：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = [item <span class="keyword">for</span> item <span class="keyword">in</span> a_list <span class="keyword">if</span> item <span class="keyword">not</span> <span class="keyword">in</span> b_list]</span><br></pre></td></tr></table></figure><p>方法c.高级版：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = list(set(a_list)^set(b_list))</span><br></pre></td></tr></table></figure><h3 id="二-并集"><a href="#二-并集" class="headerlink" title="二. 并集"></a>二. 并集</h3><p>很明显结果是[1,2,3,4,5],下面是具体方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = list(set(a_list).union(set(b_list)))</span><br></pre></td></tr></table></figure><h3 id="三-交集"><a href="#三-交集" class="headerlink" title="三. 交集"></a>三. 交集</h3><p>很明显结果是[1,4]，下面是具体方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_list = list( ( set(a_list).union(set(b_list)) )^( set(a_list)^set(b_list) ) )</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_问题小结(2)</title>
      <link href="/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-2/"/>
      <url>/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-2/</url>
      
        <content type="html"><![CDATA[<blockquote><p>环境：未特别注明的话，均为Python 3.6.5，IDE：VS code</p><p>遇到的都是基础问题，分了两篇。</p><p>担心一篇写多了会看不下去</p><p><a href="https://blog.csdn.net/xinzechen/article/details/89446322" target="_blank" rel="noopener">https://blog.csdn.net/xinzechen/article/details/89446322</a>  vscode的问题</p></blockquote><h2 id="『1』关于python无法显示中文的问题：SyntaxError-Non-ASCII-character-‘-xe4’-in-file-test-py-on-line-3-but-no-encoding-declared。"><a href="#『1』关于python无法显示中文的问题：SyntaxError-Non-ASCII-character-‘-xe4’-in-file-test-py-on-line-3-but-no-encoding-declared。" class="headerlink" title="『1』关于python无法显示中文的问题：SyntaxError: Non-ASCII character ‘\xe4’ in file test.py on line 3, but no encoding declared。"></a>『1』关于python无法显示中文的问题：SyntaxError: Non-ASCII character ‘\xe4’ in file test.py on line 3, but no encoding declared。</h2><p>python：2.7.15</p><p>解决办法：  在以后的每一个需要显示汉字的python文件中， 可以采用如下方法在 #!/usr/bin/python的下一行加上一句话来定义编码格式， 我以utf-8编码为例。<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 第一种：</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 第二种：</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#-*-coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 第三种：</span></span><br><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment">#vim: set fileencoding:utf-8</span></span><br></pre></td></tr></table></figure><h2 id="『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文"><a href="#『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文" class="headerlink" title="『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文"></a>『2』有时候在去数据的时候会遇到数据内有中文，但是取出来的是unicode码，用了很多方法也转不了中文</h2><p>解决:</p><p>“反编码”我自己起的名字，大概意思就是我得到一串字符，是unicode码，如：‘\u53eb\u6211’，进行反编码后得到其对应的汉字。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">f=<span class="string">'\u53eb\u6211'</span></span><br><span class="line"><span class="keyword">print</span> f</span><br><span class="line">print(f.decode(<span class="string">'unicode-escape'</span>))</span><br><span class="line"></span><br><span class="line">list_words为列表类型</span><br><span class="line">str(list_words).decode( <span class="string">'string_escape'</span> )</span><br><span class="line"></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"> </span><br><span class="line">list_words = [ <span class="string">'你'</span>, <span class="string">'我'</span>, <span class="string">'他'</span> ]</span><br><span class="line">print( list_words )                                        </span><br><span class="line">print( str(list_words).decode( <span class="string">'string_escape'</span> ) )         <span class="comment"># 正常显示汉字（可靠性不高，原因尚不明确）</span></span><br><span class="line"> </span><br><span class="line">list_words_result = json.dumps( list_words, encoding=<span class="string">'UTF-8'</span>, ensure_ascii=<span class="literal">False</span> )   <span class="comment"># 正常显示汉字 （经实验可靠性较高）</span></span><br></pre></td></tr></table></figure><p>结果为: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">\u53eb\u6211 </span><br><span class="line">叫我</span><br></pre></td></tr></table></figure><h2 id="『3』在编译时会出现这样的错：IndentationError-expected-an-indented-block"><a href="#『3』在编译时会出现这样的错：IndentationError-expected-an-indented-block" class="headerlink" title="『3』在编译时会出现这样的错：IndentationError:expected an indented block"></a>『3』在编译时会出现这样的错：<strong>IndentationError:expected an indented block</strong></h2><p>说明此处需要缩进，你只要在出现错误的那一行，按空格或Tab（但不能混用）键缩进就行。</p><h2 id="『4』SyntaxError-invalid-syntax-：语法错误。"><a href="#『4』SyntaxError-invalid-syntax-：语法错误。" class="headerlink" title="『4』SyntaxError:invalid syntax ：语法错误。"></a>『4』<strong>SyntaxError:invalid syntax</strong> ：语法错误。</h2><p>最常见的，最基础的错误</p><p>英文是“非法语句”的意思。漏标点符号（例如漏分号，漏&amp;号），多标点符号，拼写错，等等都会造成这种错</p><h2 id="『5』url连接超时解决："><a href="#『5』url连接超时解决：" class="headerlink" title="『5』url连接超时解决："></a>『5』<strong>url连接超时解决</strong>：</h2><p>1）使用的是urllib不是urllib2，所以无法直接在urlopen里面加timeout参数，只能是设置全局脚本的超时时间</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">socket.setdefaulttimeout(<span class="number">60</span>)</span><br></pre></td></tr></table></figure><p>设置全局的超时时间为60s。</p><p>2）urllib，urllib2常会一起使用（两者分别提供不同的功能）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">html = urllib.urlopen(url).read()</span><br><span class="line"><span class="comment"># 修改为</span></span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">html = urllib2.urlopen(url, timeout=<span class="number">60</span>).read()</span><br></pre></td></tr></table></figure><h2 id="『6』UnboundLocalError-local-variable-‘appname’-referenced-before-assignment："><a href="#『6』UnboundLocalError-local-variable-‘appname’-referenced-before-assignment：" class="headerlink" title="『6』UnboundLocalError: local variable ‘appname’ referenced before assignment："></a>『6』<strong>UnboundLocalError: local variable ‘appname’ referenced before assignment：</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;u&apos;batchrealnameverifytask&apos;: 99.41, u&apos;bptask100000188408&apos;: 98.77, u&apos;clsexpflowmaintask576&apos;: 101.28&#125;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;get_app_cpu_from_influxdb.py&quot;, line 89, in &lt;module&gt;</span><br><span class="line">    appname = get_sql_info(key)</span><br><span class="line">  File &quot;get_app_cpu_from_influxdb.py&quot;, line 28, in get_sql_info</span><br><span class="line">    return appname</span><br></pre></td></tr></table></figure><p>变量问题：变量在被赋值之前被使用定义</p><h2 id="『7』TypeError-sequence-item-1-expected-string-or-Unicode-NoneType-found"><a href="#『7』TypeError-sequence-item-1-expected-string-or-Unicode-NoneType-found" class="headerlink" title="『7』TypeError: sequence item 1: expected string or Unicode, NoneType found"></a>『7』<strong>TypeError: sequence item 1: expected string or Unicode, NoneType found</strong></h2><p>期望值未发现：str或者unicode类型</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">message = <span class="string">u"应用的CPU利用率超过%s,请检查应用:%s"</span>%(str(threshold)+<span class="string">'%'</span>,<span class="string">","</span>.join(app_name))</span><br><span class="line"></span><br><span class="line"><span class="comment"># =====================&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span></span><br><span class="line"></span><br><span class="line">message = <span class="string">"应用的CPU利用率超过%s,请检查应用:%s"</span>%(str(threshold)+<span class="string">'%'</span>,<span class="string">","</span>.join(app_name))</span><br></pre></td></tr></table></figure><h2 id="『8』UnicodeDecodeError-‘ascii’-codec-can’t-decode-byte-0xe5-in-position-1-ordinal-not-in-range-128"><a href="#『8』UnicodeDecodeError-‘ascii’-codec-can’t-decode-byte-0xe5-in-position-1-ordinal-not-in-range-128" class="headerlink" title="『8』UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xe5 in position 1: ordinal not in range(128)"></a>『8』<strong>UnicodeDecodeError: ‘ascii’ codec can’t decode byte 0xe5 in position 1: ordinal not in range(128)</strong></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关于编码问题：</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding( <span class="string">"utf-8"</span> )</span><br></pre></td></tr></table></figure><h2 id="『9』IndentationError-unindent-does-not-match-any-outer-indentation-level"><a href="#『9』IndentationError-unindent-does-not-match-any-outer-indentation-level" class="headerlink" title="『9』IndentationError: unindent does not match any outer indentation level"></a>『9』<strong>IndentationError: unindent does not match any outer indentation level</strong></h2><p>【问题】</p><p>一个python脚本，本来都运行好好的，然后写了几行代码，而且也都确保每行都对齐了，但是运行的时候，却出现语法错误：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IndentationError: unindent does not match any outer indentation level</span><br></pre></td></tr></table></figure><p>【解决过程】</p><p>1.对于此错误，最常见的原因是，的确没有对齐。但是我根据错误提示的行数，去代码中看了下，没啥问题啊。</p><p>都是用TAB键，对齐好了的，没有不对齐的行数啊。</p><p>2.以为是前面的注释的内容影响后面的语句的语法了，所以把前面的注释也删除了。</p><p>结果还是此语法错误。</p><p>3.后来折腾了半天，突然想到了，把当前python脚本的所有字符都显示出来看看有没有啥特殊的字符。tab与空格混用了</p><h2 id="『10』request-https报错："><a href="#『10』request-https报错：" class="headerlink" title="『10』request  https报错："></a>『10』<strong>request  https报错：</strong></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  忽略警告：InsecureRequestWarning: Unverified HTTPS request is being made. Adding certificate verification is strongly advised.</span></span><br><span class="line">requests.packages.urllib3.disable_warnings(）</span><br></pre></td></tr></table></figure><h2 id="『11』python安装MySQLdb的时候一直有问题"><a href="#『11』python安装MySQLdb的时候一直有问题" class="headerlink" title="『11』python安装MySQLdb的时候一直有问题"></a>『11』<strong>python安装MySQLdb的时候一直有问题</strong></h2><p>在Linux下 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install MySQL-python</span><br></pre></td></tr></table></figure><p>如果安装之后仍不能正常运行，尝试用yum install MySQL-python，因为这个模块需要一些第三方程序来运行的。 </p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_问题小结(1)</title>
      <link href="/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-1/"/>
      <url>/passages/Python-%E9%97%AE%E9%A2%98%E5%B0%8F%E7%BB%93-1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>环境：未特别注明的话，均为Python 3.6.5，IDE：VS code</p></blockquote><h2 id="『1』TypeError-unbound-method-问题"><a href="#『1』TypeError-unbound-method-问题" class="headerlink" title="『1』TypeError: unbound method 问题"></a>『1』TypeError: unbound method 问题</h2><p>今天执行了下之前写的Python接口文件，源码如下:<a id="more"></a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">__author__ = <span class="string">'Administrator'</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> readData <span class="keyword">import</span> dictionary</span><br><span class="line">readIt = &#123;&#125;</span><br><span class="line">readIt = dictionary.onlyCellValue(<span class="string">"E:\python\API\eadData.xls"</span>, <span class="string">"Sheet1"</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> readIt</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> readIt:</span><br><span class="line">    temp_list = readIt[key]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(temp_list)):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"第"</span>+(i+<span class="number">1</span>)+<span class="string">"个参数为"</span>+temp_list[i]</span><br></pre></td></tr></table></figure><p>在运行时报错：TypeError: unbound method onlyCellValue() must be called with dictionary instance as first argument (got str instance instead)，后经在网上查看，发现时由于调用其他类时，未在后面添加括号，添加括号后，运行正常。这是由于未添加括号情况下，未被认为是类的实例，故报此错；</p><blockquote><p>改正后的：readIt = dictionary().onlyCellValue(“E:\python\API\eadData.xls”, “Sheet1”, 1)</p></blockquote><h2 id="『2』Python访问MySQL"><a href="#『2』Python访问MySQL" class="headerlink" title="『2』Python访问MySQL"></a>『2』Python访问MySQL</h2><p>听说很多人都使用著名的<a href="http://sourceforge.net/projects/mysql-python/" target="_blank" rel="noopener">MySQLdb</a>来访问MySQL(当然还有pymysql)，但是它并不支持Python 3.x的版本。所以要另寻出路。那就是<a href="https://pypi.python.org/pypi/mysql-connector-python" target="_blank" rel="noopener">mysql-connector-python</a>，这个貌似是MySQL官方提供的，并且它不依赖于MySQL C客户端library，我下载的是1.1.4版本，下载解压之后，会看到setup.py文件，这样安装：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python3.2 setup.py install</span><br></pre></td></tr></table></figure><p>然后在程序中就可以用了。<br>下面给出一段查询MySQL记录的示例代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mysql.connector</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"> </span><br><span class="line">__author__ = <span class="string">'codelast'</span></span><br><span class="line"> </span><br><span class="line">username = <span class="string">'root'</span></span><br><span class="line">password = <span class="string">'xxx'</span></span><br><span class="line">host = <span class="string">'127.0.0.1'</span></span><br><span class="line">db = <span class="string">'mydb'</span></span><br><span class="line"> </span><br><span class="line">connection = mysql.connector.connect(user=username, password=password, host=host, database=db)</span><br><span class="line">cursor = connection.cursor()</span><br><span class="line"> </span><br><span class="line">sql = <span class="string">"SELECT * FROM my_table WHERE id = 9"</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 打印查询到的记录的行数</span></span><br><span class="line">    data = cursor.fetchall()</span><br><span class="line">    print(len(data))</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 输出所有记录</span></span><br><span class="line">    <span class="keyword">for</span> (ID, name) <span class="keyword">in</span> data:</span><br><span class="line">        print(<span class="string">"name:[%s]"</span> % (name))</span><br><span class="line"> </span><br><span class="line"><span class="keyword">except</span> mysql.connector.Error <span class="keyword">as</span> err:</span><br><span class="line">    print(<span class="string">"Failed to query table, detail: &#123;&#125;"</span>.format(err.msg))</span><br><span class="line">    sys.exit()</span><br><span class="line"> </span><br><span class="line">connection.commit()</span><br><span class="line">cursor.close()</span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure><p>上面的代码很简单，无非就是从my_table表里查询一些记录，再打印出来。<br>注意 for (ID, name) 中的括号里要写全该表中，你查询的所有字段名，否则会报错。还有其他遍历查询结果的方法，后面会继续陈述。</p><h2 id="『3』逆序遍历list"><a href="#『3』逆序遍历list" class="headerlink" title="『3』逆序遍历list"></a>『3』逆序遍历list</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">myList = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> reversed(myList):</span><br><span class="line">    print(item)</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>注意是 reversed 不是 reverse。这只是逆序遍历，myList中的数据顺序并不会改变。</p><h2 id="『4』使用MySQLdb访问数据库时，“TypeError-execute-takes-at-most-3-arguments-4-given-”错误的解决办法"><a href="#『4』使用MySQLdb访问数据库时，“TypeError-execute-takes-at-most-3-arguments-4-given-”错误的解决办法" class="headerlink" title="『4』使用MySQLdb访问数据库时，“TypeError: execute() takes at most 3 arguments (4 given)”错误的解决办法"></a>『4』使用MySQLdb访问数据库时，“TypeError: execute() takes at most 3 arguments (4 given)”错误的解决办法</h2><p>Python版本：2.7.3<br>使用2.7.3版本的Python时，访问MySQL的最佳方案应该数使用<a href="http://sourceforge.net/projects/mysql-python/" target="_blank" rel="noopener">MySQLdb</a>了。<br>如果在执行SQL时，你遇到了上面所说的问题，那么你可能是像下面这样写导致的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">"INSERT INTO my_table (field1, field2) VALUES (%s, %s)"</span></span><br><span class="line">cursor.execute(sql, <span class="string">"a"</span>, <span class="string">"b"</span>)</span><br></pre></td></tr></table></figure><p>这是错误的，其实这货根本不是这样用的，当参数多于一个时，你要把它们放在一个tuple里传进去：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sql = <span class="string">"INSERT INTO my_table (field1, field2) VALUES (%s, %s)"</span></span><br><span class="line">cursor.execute(sql, (<span class="string">"a"</span>, <span class="string">"b"</span>))</span><br></pre></td></tr></table></figure><p>例如<a href="http://stackoverflow.com/questions/17505067/mysql-and-python-execution-only-takes-3-arguments-4-given" target="_blank" rel="noopener">这个</a>链接有个例子。</p><h2 id="『5』使用-lxml-库生成XML（字符串）"><a href="#『5』使用-lxml-库生成XML（字符串）" class="headerlink" title="『5』使用 lxml 库生成XML（字符串）"></a>『5』使用 lxml 库生成XML（字符串）</h2><p>Python版本：2.7.3<br>直接看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:UTF-8</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">XML生成器。文件名：xmlGenerator.py</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"> </span><br><span class="line">__author__ = <span class="string">'Darran Zhang @ codelast.com'</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XMLGenerator</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">generate_xml</span><span class="params">(self)</span>:</span></span><br><span class="line">        commands = etree.Element(<span class="string">'Commands'</span>)</span><br><span class="line">        command = etree.SubElement(commands, <span class="string">'Command'</span>)</span><br><span class="line">        from_user = etree.SubElement(command, <span class="string">'FromUser'</span>)</span><br><span class="line">        from_user.text = <span class="string">u'abc'</span></span><br><span class="line">        cmd = etree.SubElement(command, <span class="string">'Cmd'</span>)</span><br><span class="line">        cmd.text = <span class="string">u'mmmmmmmmmmmmmm'</span></span><br><span class="line">        cmd_extra_data = etree.SubElement(command, <span class="string">'CmdExtraData'</span>)</span><br><span class="line">        cmd_extra_data.text = <span class="string">u'eeeeeeeeee'</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> etree.tostring(commands, pretty_print=<span class="literal">True</span>, xml_declaration=<span class="literal">True</span>, encoding=<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure><p>测试代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlGenerator <span class="keyword">import</span> XMLGenerator</span><br><span class="line"> </span><br><span class="line">xmlGen = XMLGenerator()</span><br><span class="line">print(xmlGen.generate_xml())</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&apos;1.0&apos; encoding=&apos;utf-8&apos;?&gt;</span><br><span class="line">&lt;Commands&gt;</span><br><span class="line">  &lt;Command&gt;</span><br><span class="line">    &lt;FromUser&gt;abc&lt;/FromUser&gt;</span><br><span class="line">    &lt;Cmd&gt;mmmmmmmmmmmmmm&lt;/Cmd&gt;</span><br><span class="line">    &lt;CmdExtraData&gt;eeeeeeeeee&lt;/CmdExtraData&gt;</span><br><span class="line">  &lt;/Command&gt;</span><br><span class="line">&lt;/Commands&gt;</span><br></pre></td></tr></table></figure><p>可见非常简单。</p><h2 id="『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法"><a href="#『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法" class="headerlink" title="『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法"></a>『6』在PyCharm中无法安装MySQL-python这个package的一个解决办法</h2><p>在PyCharm中可以直接搜索Python package并安装，我遇到的一个问题是：无法安装，错误提示的其中一段为：</p><blockquote><p>EnvironmentError: mysql_config not found</p></blockquote><p>你需要保证你的Ubuntu已经安装了以下这些东西：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install mysql-server mysql-client libmysqlclient-dev</span><br></pre></td></tr></table></figure><p>然后再试，一切OK。</p><h2 id="『7』”ValueError-zero-length-field-name-in-format”错误的解决办法"><a href="#『7』”ValueError-zero-length-field-name-in-format”错误的解决办法" class="headerlink" title="『7』”ValueError: zero length field name in format”错误的解决办法"></a>『7』”ValueError: zero length field name in format”错误的解决办法</h2><p>Python版本：2.6.6<br>错误出在如下语句：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&#123;&#125;\t&#123;&#125;"</span>.format(<span class="number">123</span>, <span class="number">456</span>)</span><br></pre></td></tr></table></figure><p>我遇到的出问题的Python版本为2.6.6（不知道是不是2.6.*及低版本都有此问题），反正Python 2.7.3就没有这个问题了。<br>上面的代码无非主就是把123和456代替两个大括号。在旧版本的Python上（具体从哪个版本开始不用这样写，我不确定），你要有多个需要format的field时，需要指定它们的顺序：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"&#123;0&#125;\t&#123;1&#125;"</span>.format(<span class="number">123</span>, <span class="number">456</span>)</span><br></pre></td></tr></table></figure><p>这样就没问题了。</p><h2 id="『8』对一个字典-dict-，按value进行排序"><a href="#『8』对一个字典-dict-，按value进行排序" class="headerlink" title="『8』对一个字典(dict)，按value进行排序"></a>『8』对一个字典(dict)，按value进行排序</h2><p>Python版本：2.6.6，2.6.9均测试可用（Python3里没有cmp方法了，所以不能用）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sortedList = sorted(myDict.items(), <span class="keyword">lambda</span> x, y: cmp(x[<span class="number">1</span>], y[<span class="number">1</span>]), reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">for</span> (k, v) <span class="keyword">in</span> sortedList:</span><br><span class="line">    print(<span class="string">"&#123;0&#125;\t&#123;1&#125;"</span>.format(k,v))</span><br></pre></td></tr></table></figure><p>其中，myDict是你要将其排序的字典，sortedList是排序之后的结果，变成了一个list，里面是若干个tuple，每个tuple里是一对(key,value)，所以后面用那样的方式对它进行了遍历。</p><h2 id="『9』判断一个字典（dict）中是否包含指定的key"><a href="#『9』判断一个字典（dict）中是否包含指定的key" class="headerlink" title="『9』判断一个字典（dict）中是否包含指定的key"></a>『9』判断一个字典（dict）中是否包含指定的key</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d = dict()</span><br><span class="line"><span class="comment"># 向字典中添加两个元素</span></span><br><span class="line">d[<span class="number">1</span>] = <span class="string">'abc'</span></span><br><span class="line">d[<span class="number">2</span>] = <span class="string">'def'</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 检查 3 这个key是否在字典中，结果输出的是“NO”</span></span><br><span class="line"><span class="keyword">if</span> <span class="number">3</span> <span class="keyword">in</span> d:</span><br><span class="line">    print(<span class="string">'YES'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">'NO'</span>)</span><br></pre></td></tr></table></figure><h2 id="『10』Python正则简单示例"><a href="#『10』Python正则简单示例" class="headerlink" title="『10』Python正则简单示例"></a>『10』Python正则简单示例</h2><p>先看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">'String url = "http://item.jd.com/1148104.html?erpad_source=abc";'</span></span><br><span class="line">pattern = re.compile(<span class="string">'.*\"(.*)\"'</span>)</span><br><span class="line">match = pattern.match(code)</span><br><span class="line"><span class="keyword">if</span> match:</span><br><span class="line">    print(match.group(<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://item.jd.com/1148104.html?erpad_source=abc</span><br></pre></td></tr></table></figure><p>说明：上面的代码是想把字符串“code”中的双引号里的那个URL打印出来。正则表达式 .<em>\”(.</em>)\” 中的小括号就是第1个group，匹配上的话可以用 group(1) 获取之。</p><h2 id="『11』try…except的示例参考"><a href="#『11』try…except的示例参考" class="headerlink" title="『11』try…except的示例参考"></a>『11』try…except的示例参考</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:               <span class="comment"># 可能会出现异常的一段代码</span></span><br><span class="line">    command_1   <span class="comment"># 如果command_1出现异常，则不执行command_1以及之后的语句</span></span><br><span class="line">    command_2   <span class="comment"># command_1如果正常，则会执行</span></span><br><span class="line"><span class="keyword">except</span>:         <span class="comment"># try中任意一行语句出现异常，直接跳转至except，程序继续运行</span></span><br><span class="line">    command_3</span><br><span class="line">    command_4</span><br></pre></td></tr></table></figure><h2 id="『』To-be-added…"><a href="#『』To-be-added…" class="headerlink" title="『』To be added…"></a>『』To be added…</h2>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker的问题总结</title>
      <link href="/passages/Docker%E7%9A%84%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/"/>
      <url>/passages/Docker%E7%9A%84%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h3 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h3><h4 id="1、Docker18-06-1-ce安装-RHEL7-后启动失败-原因-xfsprogs版本过低"><a href="#1、Docker18-06-1-ce安装-RHEL7-后启动失败-原因-xfsprogs版本过低" class="headerlink" title="1、Docker18.06.1-ce安装(RHEL7)后启动失败, 原因(xfsprogs版本过低)"></a>1、Docker18.06.1-ce安装(RHEL7)后启动失败, 原因(xfsprogs版本过低)</h4><p>* 问题分析: </p><blockquote><p>使用/usr/bin/dockerd启动测试发现是文件系统无法创建 <a id="more"></a></p><p>1 WARN[2018-09-15T10:47:39.886191433+08:00] Usage of loopback devices is strongly discouraged for production use. Please use <code>--storage-opt dm.thinpooldev</code> or use <code>man dockerd</code> to refer to dm.thinpooldev section.  storage-driver=devicemapper </p><p>2 INFO[2018-09-15T10:47:40.220046362+08:00] Creating filesystem xfs on device docker-253:4-17133027-base, mkfs args: [-m crc=0,finobt=0 /dev/mapper/docker-253:4-17133027-base]  storage-driver=devicemapper </p><p>3 INFO[2018-09-15T10:47:40.221230038+08:00] Error while creating filesystem xfs on device docker-253:4-17133027-base: exit status 1  storage-driver=devicemapper </p><p>4 ERRO[2018-09-15T10:47:40.221258767+08:00] [graphdriver] prior storage driver devicemapper failed: exit status 1 </p><p>5 Error starting daemon: error initializing graphdriver: exit status 1 </p><p>第三行日志可以找到mkfs的执行参数, 执行发现参数不正确 </p><p>1 2 INFO[2018-09-15T10:47:40.220046362+08:00] Creating filesystem xfs on device docker-253:4-17133027-base, mkfs args: [-m crc=0,finobt=0 /dev/mapper/docker-253:4-17133027-base]  storage-driver=devicemapper </p></blockquote><p>* 解决问题 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install xfsprogs </span><br><span class="line"><span class="meta">#</span><span class="bash"> 但是内核版本过低，操作系统7.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 18.06最好升级系统版本到7.4，只能装会1.12版本,问题来了，私有镜像库登入不了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 17.12.0兼容</span></span><br></pre></td></tr></table></figure><h4 id="2、docker-rm-container-失败"><a href="#2、docker-rm-container-失败" class="headerlink" title="2、docker rm container 失败"></a>2、docker rm container 失败</h4><p>现象：</p><blockquote><p>docker version：17.12.0-ce </p><p>偶尔出现docker跟daemon守护进程失去联系 </p></blockquote><p><img src="data:image/png;base64,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J8872bwTn/b9vprVz5/yVdby7pR01zP3KXN/k+145E4iPUflXaNK/Smq1Bepm7L+umLVpzxlO9KdlDknGyfdSZlzsplY3U95yppVl/JHM/cnnNw52STSvZRNpP1p9gzT86buhpPnpE3KprxQpb6YukaVemXapM4z9ylzf0K6o/LO2W2676+J7vrrilWf8lXW8q5JnWfuVxk8T/q9hs/gt/3ZtfzsG8/g//NTvz/f8bnf8RnvzLv9/J/6/ZzuHuErnz3xU5/bHL0h+mcQ8hte8Qzl5Hknm3fi077fV3L7s0/7qduR7qbM8Y37m2zHI3cS03OmrjnZnDA9J3VT1l9X7HrlZtukOylzTjZOupMy52Qzsbqf8pQ1qy7lj2buTzi5c7JJpHspm0j70+xRds/a9aecPCdtUjblyrSZOudkO21S55n7lLk/YbozdcWuL3rTXxPd9dcVqz7lKWtuO8/crzJ4Hn5fP5d3/rPbKd3Zoff0rKxy+Ief+v35js/9js94Z97t5//U7+d09whf+eyJn/rcprR8Q3SS7k7oO6q0aXnnvGqzQ9V+2pRS57u0SdKdb7276fVc8p33pVXvW9/tePWdqStU7bXr85Q5vnG/y1Rp02rvm85b7W96Zeqa3UbV3jdTXqTOM/V6VlZK22bVu9KmWfWq9r7pvJV6ZbVRtfdN56pd39Je91OW5Ltm1aXcM5d2adP+kU3nqtSfZi3f6PkkU/nmtE+54kqbQrXq+2trtZmylXSj25QX3al80+y6JN+oT5n7lLm0S5v2vmke7Rrd6FnRXM/KSmlbTF0x9anzzP2UtXYbz29RtZ82pdT57nbTuHab9qlz9cZ3mjuu1PlONze4Vr1vbzfelVa9b6fdo6ja+6Zz1cmmNG3a++Y70c/Xc/uV0s7v6Oa02+28b3nnu+4V16r3rfdJvfGt5zeo2u82K1Spb3b9RGvKWnoude+7knerXqXbU1b3VFM25d7rueS77lNetPRcSv0qa+m51L2z61rtfdO5ardp733aOa5V71vfdZ/yRtV+2pS83/Ejb4jqObHri1dtJvx+yzP1KWt5pn6VKd67V3ZdybPJT1nJ8xv6vso3TSt1zdR710pZSzunNXWtaeNZOrcvada5+9Jp70xdM228a2mmXcqbJO/TObHri9aqO8lu8pZmnU9eWXWetzTr/CS7zVPWTF2z2ySl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" alt="img"></p><p>docker rm不掉容器 </p><p>解决方法：docker守护进程重启了，现在只能重启解决 </p><p>链接： <a href="https://github.com/moby/moby/issues/36002" target="_blank" rel="noopener">https://github.com/moby/moby/issues/36002</a></p><h4 id="3、"><a href="#3、" class="headerlink" title="3、"></a>3、</h4><h3 id="指北："><a href="#指北：" class="headerlink" title="指北："></a>指北：</h3><h4 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h4><p><img src="data:image/png;base64,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" alt="img"></p><p>原因：版本不兼容   7.2版本 升级系统7.4可解决</p><h4 id="二、no-matching-entries-in-passwd-file"><a href="#二、no-matching-entries-in-passwd-file" class="headerlink" title="二、no matching entries in passwd file"></a>二、<strong>no matching entries in passwd file</strong></h4><blockquote><p>进不去容器 </p><p>重启docker </p></blockquote><h4 id="三、standard-init-linux-go-195-exec-user-process-caused-“exec-format-error”"><a href="#三、standard-init-linux-go-195-exec-user-process-caused-“exec-format-error”" class="headerlink" title="三、standard_init_linux.go:195: exec user process caused “exec format error”"></a>三、<strong>standard_init_linux.go:195: exec user process caused “exec format error”</strong></h4><blockquote><p>进不去容器； </p><p>启动脚本错误 </p><p>启动脚本=======》 #！/bin/bash </p></blockquote><h4 id="四、内核：enterd-disabled-state"><a href="#四、内核：enterd-disabled-state" class="headerlink" title="四、内核：enterd disabled state"></a>四、内核：<strong>enterd disabled state</strong></h4><blockquote><p>被禁用状态 </p><p>主机内核有问题 </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Docker </tag>
            
            <tag> Docker的一些东西 </tag>
            
            <tag> Docker_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安静写点东西</title>
      <link href="/passages/%E5%AE%89%E9%9D%99%E5%86%99%E7%82%B9%E4%B8%9C%E8%A5%BF/"/>
      <url>/passages/%E5%AE%89%E9%9D%99%E5%86%99%E7%82%B9%E4%B8%9C%E8%A5%BF/</url>
      
        <content type="html"><![CDATA[<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><div id="hbe-security">  <div class="hbe-input-container">  <input type="password" class="hbe-form-control" id="pass" placeholder="Come on ٩(๑.◡.๑)۶ ，Please ecter Password (*ﾉ▽ﾉ)." />    <label for="pass">Come on ٩(๑.◡.๑)۶ ，Please ecter Password (*ﾉ▽ﾉ).</label>    <div class="bottom-line"></div>  </div></div><div id="decryptionError" style="display: none;">Incorrect Password!</div><div id="noContentError" style="display: none;">No content to display!</div><div id="encrypt-blog" style="display:none">U2FsdGVkX19pBGTJMlzXQMvn+ll6XiUQdczjGS10rjhTsyUD+8UCLRyRJlYSz5sRoHqJxvCqs+OkttRppe1dvqiIe4jaY20gQyv6MCYqSUHTIemCPsuGlkjQggiGeSObarAlKLYnaB69o5amdZjNZBCl0ZK+1GwcPZV/ndNQM13XBzE2q/iIyjAhT/LJmQPDkMzc1Jugo71TVW/ZXytV3HLLvKLPm7MRyU7p5pcGCCbpD7TGGDuBupBBllmBiNAyCTa7bjSb9vFFodHTIhxFmztmjZ5LHzN7qE/+UqHmATaBCuHTiN68jXxebEB2c7YvwxGt4x6yT3mH/h88sw73NR+mUBUIBmBD9SujAXlRF0FpzYGb08I1Dr64RI4nDmzVr0tVOLqqgaHEpvnBp9jZWC+nnK1KQcp9dEm3xZtC1ZlVnu0LSkdG5cu3EpTCndnWzR6OW6fz2RdgOmo5ZcGIwJq+tcKm/eQdk23focJgXhzPc2y6nl1RY1TlFO+YNEBfkkXCdmHi3mZNMhRDD/c2c392rQm4UcvkcibsUTDzSwiQW453o116cUQaXPswNS3pbqueBPLV/7CE/XSaFhDqL2dJ3Ii85FNqcDP0MreAXG6CtFvcPiV3yVSfzg3m/zI5442IaONmC0Wgy0efGsW59aQtM29OTxMa/lsx3FwUKGTUgOLcsRJ+UOLxU2ocYAucP17F8eVkXR9pQoru5QsHdq6Id6Jf/otZjGXAjtbi44ypfJaVG4ZPqcSjybeBCiVMfbd0TfVSeUJ0Y4KJiMBgGNokA7HbMVg70Yj/1y2uctlrC25gn9kHJuRKtoRS6fVNE17XAT+uJl5VE/pOhf1/IlWhMhaUrrUDZvUbI1TlLiQVmfWy7W5g6pJBqN1oNRi8anG9fKvrCxm+dElzh286qkIvCcDsECXWDBve+ZtflHTFfdU/rHG1pnYsV8Gq7uxZHDE3LxJCLQx4Z+R4q/cRksYdpPYcPgvm/rv9l5sdmzIdchC3WMuwz17f0Vr5fxMtrLJcqJZRxUhnS5mgOlSKpLxh8F+5bX0pIVri1LWTwJmRwvng6HxKnUDpNbFEG50mGgzsr0NMtTM64NYimkmyEq+AFlw0TP87c/Yt4+JY4m2KKEPM1RgiDXPjy0WFzP/V4W026wE2E16tItUKr8n8cnKJH/UnpNlp5nB3Swp5EPOtrwXP3gxIvcFcBfQlo89zff8BfQ8yELrw8G9PzPE1XXM407y/6ibeZsbOlo57UM3V/SFv8lg2eGdMQXdS71wwIa8rprP6Z3E8SyFBj5PMQIw42Z50/diRu5xmlsE/TskH58JXMYr4kPw/qAyhlTDkN/7BL0pGRf/vsYrnzmjUrTL1xygY10qrSmqxleWK1Z2h0maikIrn0DsFzPA7Jv/37ML+k97oB7lQIjs9TuF/E33F5+8br6aQi012sLYKa1ETzSpVRwNHF+XjgFsKsiyH+ocyUcDEyr4g3DmkceVSVRe7wFJ3mEgIIJSLjl53V6WgJ9B2r4Bh2olt52xrPIUXy3iFw/OY4/BSU4zgCofeW5cnhV2ssCmHgM7b53Tk+OLku6XSg+x6MxoTHGiXVhjCcKVzEjBTNxUsC80pnEbl2J9x7nNgIWDTdlB1D12DTb796A3TGOWepDdotuYIs/QfqTKsZyTFVPUGiqncjtHri0Glq6ziQR5edNr3BQXRwmT6C7t2VhvCkqYNCIBBsS5YRLYIpL+cctUfnhcxGg4DL0XjHqRwGSHAFtoM6ECYtr4wd+QsK90P1oIUFcjpuqUQSo40FdLXULnQrMLHz4M81IED8zUtpgh2TZ+TiP3P2PuE3lvhh5sgcQXcs8hrHEZfB8olP5hVsU2qraO+3i9l9ywLkgCaww5VuE65Be9Zy1Plot7M5zrUiDllIBcwBu0vIeWYiZg4cOLdi4wetqbRppDB2nXhcrWbkLXW8cIZ10QnwdYOtGdpDcEtBhYx6OVKz5ei8G7tvcaxfsriDR1OYm97VRfY4X14SjNkC5u2CDZyI35gxWshz5E7RnNMzBLRpacFZsBvTUeZ33QNXKFQsElU7tVeqxT88fRKiSzKYBWbj7/glNBcQwPNO52b2KMhKdRv051t5Ofy6gVqSYqYPFJU7cRmYb7ex4KJivL8VMYSZ8XyTNBhWw4wbJ6GF4DbzNAxDdzBOJm+zrlyPgp8KuWttFix4h7KXEKw1h31ROe/TGVLakWB49PzTj5y6ygY42ewS8LKVbCp5MNig1A2Jg5hdN2SwuNoFF5Eo2oNTpFtSnwENzIiuQjM8cdQEZrFnBbJlK1lHMUoPUftMDsiS87cy/ssL4WvczcgGV073OMnQHz2xAXB5+M+EWvPpIXroD8D0Y6wCS+1273Vn3TIuQ0lEFsPGNUjTFy7pQ4Se1XAyn1u9TC++P1I1kSmMtQUxOVALJeDaSLiFrIfAKPxqz1CS6qJNP+yufXt29WDLajYYnsAqWudfWfXdFS46icYgNuj4fUsxCET7/Ieo03GeHKpYoAdGBcv6Q+PCOUx4kw9ff+d+F+dLazlpaaGnh3faZWsx7KAVPxeq9b3CBicnATO63+pkdGHirL4Cp761OOY5bDTVF8l1BUYvm80qCozqI29hwk9M0Xjnxvo42BlYUJqyip99QSrAxeSozzfkAEO1tXocAW1EXFzsXRAMbuam+iv5ekbJlynoRUaz3pg1Ec0h5PPUgg/0fmQQKTpWfXiy6z6blrZuJbHD943rGw6/1A1MGZD50kyvXwQfd3Edc8vH1N8fUHUnjYZYsl/96oCmUXwIWjvlFtbvhFCvyROTPRt5veYyWBzpRwGxFCOwHaK67IKJ5UOSWknB9jyRnqEG/PvXEUD05LO6HjnxDksh0Am4m/nz6oaUtKb37AnQTcFByw6q73ypVeRLbCQvYstD8uSTmLfFeUkL1lWByR2Q2VH9UkUMPntZaIUuxYuq+bmbZwit9jwFPciCZqejv3YC9ocybcAXvWbY60jvxNFfRmdt/HUVHoGGwhobJMnJ4H9O2PUK3/lTNfE+ikpqj7uzNiib9d0ISZAOKqKEKdUDQqtX1NnIHGwp5SCvh4X6b/jOtEbpwC5zpM4xr5PF9I=</div><script src="/lib/crypto-js.js"></script><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
        <tags>
            
            <tag> 生活需要一点方式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes问题之填坑篇</title>
      <link href="/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E5%A1%AB%E5%9D%91%E7%AF%87/"/>
      <url>/passages/Kubernetes%E9%97%AE%E9%A2%98%E4%B9%8B%E5%A1%AB%E5%9D%91%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="更新19-4-5"><a href="#更新19-4-5" class="headerlink" title="更新19.4.5"></a>更新19.4.5</h2><h3 id="一、etcd-单点问题"><a href="#一、etcd-单点问题" class="headerlink" title="一、etcd 单点问题"></a>一、etcd 单点问题<a id="more"></a></h3><p>默认<code>kubeadm</code>创建的集群会在内部启动一个单点的 etcd，当然大部分情况下 etcd 还是很稳定的，<strong>但是一但 etcd 由于某种原因挂掉，这个问题会非常严重，会导致整个集群不可用</strong>。具体原因是 etcd 存储着 kubernetes 各种元数据信息；包括 <code>kubectl get pod</code>等等基础命令实际上全部是调用 RESTful API 从 etcd 中获取的信息；<strong>所以一但 etcd 挂掉以后，基本等同于<code>kubectl</code>命令不可用，集群各节点也会因无法从 etcd 获取数据而出现无法调度，最终挂掉</strong>。</p><p><strong>解决办法：是在使用<code>kubeadm</code>创建集群时使用 –external-etcd-endpoints 参数指定外部 etcd 集群，此时<code>kubeadm</code> 将不会在内部创建 etcd，转而使用外部我们指定的 etcd 集群，如果外部 etcd 集群配置了 SSL 加密，那么还需要配合 –external-etcd-cafile、–external-etcd-certfile、–external-etcd-keyfile 三个参数指定 etcd 的 CA证书、CA签发的使用证书和私钥文件，命令如下</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 非 SSL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm init --external-etcd-endpoints http://x.x.x.1:2379</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> etcd SSL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm init --external-etcd-endpoints https://x.x.x.1:2379 --external-etcd-cafile /path/to/ca --external-etcd-certfile /path/to/cert --external-etcd-keyfile /path/to/privatekey</span></span><br></pre></td></tr></table></figure><h3 id="二、etcd-不可与-master-同在"><a href="#二、etcd-不可与-master-同在" class="headerlink" title="二、etcd 不可与 master 同在"></a>二、etcd 不可与 master 同在</h3><p>‘愿上帝与你同在’……这个坑是由于<code>kubeadm</code>的 check 机制的 bug 造成的，目前还没有修复；表现为 <strong>当 etcd 与 master 在同一节点时，kubeadm init 会失败，同时报错信息提示’已经存在了 /var/lib/etcd 目录，或者 2379 端口被占用’</strong>；因为默认<code>kubeadm</code>会创建 etcd，而默认的 etcd 会占用这个目录和 2379 端口，<strong>即使你加了<code>--external-etcd-endpoints</code>参数，<code>kubeadm</code>仍然会检测这两项条件是否满足，不满足则禁止 init 操作</strong></p><p><strong>解决办法：就是要么外部的 etcd 更换数据目录(/var/lib/etcd)和端口，要么干脆不要和 master 放在同一主机即可</strong></p><h3 id="三、巨大的日志"><a href="#三、巨大的日志" class="headerlink" title="三、巨大的日志"></a>三、巨大的日志</h3><p>熟悉的小伙伴应该清楚，基本上每个 kubernetes 组件都会有个通用的参数 <code>--v</code>；这个参数用于控制 kubernetes 各个组件的日志级别，在早期(alpha)的 kubeadm 版本中，如果不进行调整，默认创建集群所有组件日志级别全部为 <code>--v=4</code> 即最高级别输出，这会导致在业务量大的时候磁盘空间以 <strong>‘我去尼玛’</strong> 的速度增长，尤其是 <code>kube-proxy</code> 组件的容器，会疯狂吃掉你的磁盘空间，然后剩下懵逼的你不知为何。在后续的版本中(beta)发现日志级别已经降到了 <code>--v=2</code>，不过对于完全不怎么看日志的我来说还是无卵用……</p><p><strong>解决办法有两种方案:</strong></p><p><strong>1、如果已经 –v=4 跑起来了(检查方法就是随便 describe 一个 kube-proxy 的容器，看下 command 字段就能看到)，并且无法停止重建集群，那么最简单的办法就是使用<code>kubectl edit ds xxx</code>方式编译一下相关 ds 文件等，然后手动杀掉相关 pod，让 kubernetes 自动重建即可，如果命令行用着不爽也可以通过 dashboard 更改</strong></p><p><strong>2、如果还没开始搭建，或者可以停掉重建，那么只需在<code>kubeadm init</code>之前<code>export KUBE_COMPONENT_LOGLEVEL=&#39;--v=0&#39;</code>即可</strong></p><h3 id="四、新节点加入-dns-要你命"><a href="#四、新节点加入-dns-要你命" class="headerlink" title="四、新节点加入 dns 要你命"></a>四、新节点加入 dns 要你命</h3><p>当 kubeadm 创建好集群以后，如果有需要增加新节点，那么在 <code>kubeadm join</code> 之后务必检查 <code>kube-dns</code> 组件，dns 在某些(weave 启动不完整或不正常)情况下，会由于新节点加入而挂掉，此时整个集群 dns 失效，<strong>所以最好 join 完观察一会 dns 状态，如果发现不正常马上杀掉 dns pod，让 kubernetes 自动重建；如果情况允许最好全部 join 完成后直接干掉 dns 让 kubernetes 重建一下</strong></p><h3 id="五、单点的-dns-浪起来让你怕（更新-19-4-5）"><a href="#五、单点的-dns-浪起来让你怕（更新-19-4-5）" class="headerlink" title="五、单点的 dns 浪起来让你怕（更新-19.4.5）"></a>五、单点的 dns 浪起来让你怕（更新-19.4.5）</h3><p>kubeadm 创建的 dns 默认也是单点的，而 dns 至关重要，只要一挂瞬间整个集群全部 <code>game over</code>；<strong>不过暂时还是没有发现能在 init 时候创建多个 dns 的方法；不过在集群创建后可以通过<code>kubectl edit deploy kube-dns</code>的方式修改其副本数量，让其创建多个副本即可</strong>，<strong><em>目前新版本kubernetes所使用的dns已经不是单pod三container，而是启动两个pod的coredns，解决单点问题</em></strong></p><h3 id="六、coredns一直处于ContainerCreating状态"><a href="#六、coredns一直处于ContainerCreating状态" class="headerlink" title="六、coredns一直处于ContainerCreating状态"></a>六、coredns一直处于ContainerCreating状态</h3><blockquote><p>Node加入集群中后一直处于NotReady状态，查看kube-system的状态，发现coredns一直处于ContainerCreating状态，flannel启动正常</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME              STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1.rsq.com   NotReady   master   16h     v1.13.0</span><br><span class="line">node01.rsq.com    NotReady   &lt;none&gt;   16h     v1.13.0</span><br><span class="line">node02.rsq.com    NotReady   &lt;none&gt;   8m39s   v1.13.0</span><br></pre></td></tr></table></figure><p>查看kubelet服务状态，看最后几行的报错</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> systemctl status kubelet</span></span><br><span class="line">● kubelet.service - kubelet: The Kubernetes Node Agent</span><br><span class="line">   Loaded: loaded (/etc/systemd/system/kubelet.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /etc/systemd/system/kubelet.service.d</span><br><span class="line">           └─10-kubeadm.conf</span><br><span class="line">   Active: active (running) since Wed 2018-12-12 09:24:44 CST; 6min ago</span><br><span class="line">     Docs: https://kubernetes.io/docs/</span><br><span class="line"> Main PID: 123631 (kubelet)</span><br><span class="line">   Memory: 35.2M</span><br><span class="line">   CGroup: /system.slice/kubelet.service</span><br><span class="line">           └─123631 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --config=/var/lib/kubelet/config.yaml --cgrou...</span><br><span class="line"></span><br><span class="line">Dec 12 09:30:57 master1.rsq.com kubelet[123631]: E1212 09:30:57.187292  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:30:57 master1.rsq.com kubelet[123631]: E1212 09:30:57.187480  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Dec 12 09:30:59 master1.rsq.com kubelet[123631]: E1212 09:30:59.187419  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:30:59 master1.rsq.com kubelet[123631]: E1212 09:30:59.187607  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Dec 12 09:31:00 master1.rsq.com kubelet[123631]: W1212 09:31:00.454147  123631 cni.go:203] Unable to update cni config: No networks found in /etc/cni/net.d</span><br><span class="line">Dec 12 09:31:00 master1.rsq.com kubelet[123631]: E1212 09:31:00.454242  123631 kubelet.go:2192] Container runtime network not ready: NetworkReady=false reason:NetworkPluginNot...initialized</span><br><span class="line">Dec 12 09:31:01 master1.rsq.com kubelet[123631]: E1212 09:31:01.188877  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Dec 12 09:31:01 master1.rsq.com kubelet[123631]: E1212 09:31:01.189259  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:31:03 master1.rsq.com kubelet[123631]: E1212 09:31:03.187200  123631 pod_workers.go:190] Error syncing pod cea84a11-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-fzs9l_kube-...</span><br><span class="line">Dec 12 09:31:03 master1.rsq.com kubelet[123631]: E1212 09:31:03.187730  123631 pod_workers.go:190] Error syncing pod cea7ebef-fd24-11e8-a282-000c291e37c2 ("coredns-86c58d9df4-hrwvk_kube-...</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 附加PS</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 报错10.244.0.1 网络已存在（更新）</span></span><br></pre></td></tr></table></figure><p>产生问题原因：</p><p>一直报网络NotReady，我就感觉flannel组件出了问题， 最后网上搜了一些资料解决<br>参考博客：<a href="http://www.cnblogs.com/effortsing/p/10014611.html" target="_blank" rel="noopener">coreDNS一直处于创建中解决</a><br>解决办法：所有节点执行（我只在master节点先执行就解决问题了）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /var/lib/cni/flannel/* &amp;&amp; rm -rf /var/lib/cni/networks/cbr0/* &amp;&amp; ip link delete cni0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> rm -rf /var/lib/cni/networks/cni0/*</span></span><br></pre></td></tr></table></figure><p>删除flannel组件，重新下载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> docker rmi quay.io/coreos/flannel:v0.10.0-amd64</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br></pre></td></tr></table></figure><p>查看节点状态已经处于Ready状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME              STATUS   ROLES    AGE   VERSION</span><br><span class="line">master1.rsq.com   Ready    master   16h   v1.13.0</span><br><span class="line">node01.rsq.com    Ready    &lt;none&gt;   16h   v1.13.0</span><br><span class="line">node02.rsq.com    Ready    &lt;none&gt;   39m   v1.13.0</span><br></pre></td></tr></table></figure><h3 id="七、kubeadm-join报错"><a href="#七、kubeadm-join报错" class="headerlink" title="七、kubeadm join报错"></a>七、kubeadm join报错</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">在部署服务过程中，初始化之后重启了master节点，然后node节点在join进群的时候报错，提示证书是否过期等问题，报错信息如下：</span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm join 10.0.0.100:6443 --token qxl5b3.5b78nwu3gm1r4u6o --discovery-token-ca-cert-hash sha256:3e20fa8054cbc9000cf3d3586a05a01d8af5721b577856e93c7e243877393d21 --ignore-preflight-errors=Swap</span></span><br><span class="line"></span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[WARNING Swap]: running with swap on is not supported. Please disable swap</span><br><span class="line">[WARNING SystemVerification]: this Docker version is not on the list of validated versions: 18.09.0. Latest validated version: 18.06</span><br><span class="line">[discovery] Trying to connect to API Server "10.0.0.100:6443"</span><br><span class="line">[discovery] Created cluster-info discovery client, requesting info from "https://10.0.0.100:6443"</span><br><span class="line">[discovery] Failed to request cluster info, will try again: [Get https://10.0.0.100:6443/api/v1/namespaces/kube-public/configmaps/cluster-info: dial tcp 10.0.0.100:6443: connect: connection refused]</span><br><span class="line">[discovery] Failed to request cluster info, will try again: [Get https://10.0.0.100:6443/api/v1/namespaces/kube-public/configmaps/cluster-info: dial tcp 10.0.0.100:6443: connect: connection refused]</span><br></pre></td></tr></table></figure><blockquote><p>产生原因：有可能是时间不同步造成的，在初始化后重启master，重启后会报错</p></blockquote><p>找了好多资料，没有找到可行的，最后kubeadm reset完美解决<br>参考博文： <a href="https://www.cnblogs.com/justmine/p/8886675.html" target="_blank" rel="noopener">k8s踩坑记 - kubeadm join 之 token 失效</a><br>reset之后重新初始化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubeadm reset</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> kubeadm init --kubernetes-version=v1.13.0 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --token-ttl=0 --ignore-preflight-errors=Swap</span></span><br></pre></td></tr></table></figure><p>创建所需文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> mkdir -p <span class="variable">$HOME</span>/.kube</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span></span><br></pre></td></tr></table></figure><p>查看节点</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubectl get nodes</span></span><br><span class="line">NAME              STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1.rsq.com   NotReady   master   2m49s   v1.13.0</span><br></pre></td></tr></table></figure><h3 id="八、Etcd二进制安装目录也会报错哦"><a href="#八、Etcd二进制安装目录也会报错哦" class="headerlink" title="八、Etcd二进制安装目录也会报错哦"></a>八、Etcd二进制安装目录也会报错哦</h3><p><strong>etcd服务启动后报错etcd cluster ID mismatch：</strong>检查service配置cluster选项有无问题，若无问题，则可能是此前的etcd bootstrap加速启动缓存残留导致，坑爹的是<code>rm -rf /var/lib/etcd/*</code>删除完了之后还是报错，必须<code>rm -rf /var/lib/etcd/</code>才能彻底清除，删除完成后记得再创建该路径mkdir /var/lib/etcd，否则会有类似报错：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">etcd.service: Failed at step CHDIR spawning /usr/local/bin/etcd: No such file or directory</span><br></pre></td></tr></table></figure><h3 id="九、二进制安装后重建相关组件会出现secrets报错"><a href="#九、二进制安装后重建相关组件会出现secrets报错" class="headerlink" title="九、二进制安装后重建相关组件会出现secrets报错"></a>九、二进制安装后重建相关组件会出现secrets报错</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">May 27 10:34:45 kube-node3 journal: E0527 02:34:45.767392      1 config.go:322] Expected to load root CA config from /var/run/secrets/kubernetes.io/serviceaccount/ca.crt, but got err: open /var/run/secrets/kubernetes.io/serviceaccount/ca.crt: no such file or directory </span><br><span class="line"></span><br><span class="line">May 27 10:34:45 kube-node3 journal: E0527 02:34:45.767392      1 config.go:322] Expected to load root CA config from /var/run/secrets/kubernetes.io/serviceaccount/ca.crt, but got err: open /var/run/secrets/kubernetes.io/serviceaccount/ca.crt: no such file or directory</span><br></pre></td></tr></table></figure><blockquote><p>分析：产生这个错误是因为Kubernetes默认创建的secrets资源不包含用于访问kube-apiserver的根证书 </p><p>需要给apiserver设置安全证书，然后删除默认secrets，系统会自动产生新的secrets </p><p>secrets一般集群安装时默认自动创建 </p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> kubectl delete secret secretname -n Xxx</span></span><br></pre></td></tr></table></figure><h3 id="十、kubeadm生成集群，加入节点时发现忘记了join-token-怎么办？"><a href="#十、kubeadm生成集群，加入节点时发现忘记了join-token-怎么办？" class="headerlink" title="十、kubeadm生成集群，加入节点时发现忘记了join token 怎么办？"></a>十、kubeadm生成集群，加入节点时发现忘记了join token 怎么办？</h3><blockquote><p>1.生成一条永久有效的token </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># kubeadm token create --ttl 0 </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> o4avtg.65ji6b778nyacw68 </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># kubeadm token list </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION   EXTRA GROUPS </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> dxnj79.rnj561a137ri76ym   &lt;invalid&gt;   2018-11-\<span class="comment">#02T14:06:43+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> o4avtg.65ji6b778nyacw68   &lt;forever&gt;   &lt;never&gt;                     authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>2.获取ca证书sha256编码hash值 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //' </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 2cc3029123db737f234186636330e87b5510c173c669f513a9c0e0da395515b0 </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>3.node节点加入 </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># kubeadm join x.x.x.x:6443 --token o4avtg.65ji6b778nyacw68 --discovery-token-ca-cert-hash sha256:2cc3029123db737f234186636330e87b5510c173c669f513a9c0e0da395515b0 </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote></blockquote><p>###十一、</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> kubernetes_problem </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes安装-kubeadm_1.13.5</title>
      <link href="/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5/"/>
      <url>/passages/Kubernetes%E5%AE%89%E8%A3%85-kubeadm-1-13-5/</url>
      
        <content type="html"><![CDATA[<h2 id="环境描述"><a href="#环境描述" class="headerlink" title="环境描述"></a>环境描述</h2><blockquote><p>kubernetes version：1.13.5</p><p>docker version：18.6.3</p><p>Redhat：7.6</p></blockquote><a id="more"></a><table><thead><tr><th style="text-align:left">x.x.x.1</th><th style="text-align:center">master-1</th><th>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</th></tr></thead><tbody><tr><td style="text-align:left"><strong>x.x.x.2</strong></td><td style="text-align:center"><strong>master-2</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.3</strong></td><td style="text-align:center"><strong>master-3</strong></td><td><strong>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、keepalive、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.4</strong></td><td style="text-align:center"><strong>vip</strong></td><td></td></tr><tr><td style="text-align:left"><strong>x.x.x.5</strong></td><td style="text-align:center"><strong>node-1</strong></td><td><strong>kubelet、docker</strong></td></tr><tr><td style="text-align:left"><strong>x.x.x.6</strong></td><td style="text-align:center"><strong>node-2</strong></td><td><strong>kubelet、docker</strong></td></tr></tbody></table><p>因为担心kubeadm起来的etcd不稳定，这里用到的etcd对于kubernetes来说作为外部etcd集群。即使用二进制安装etcd集群，其余组件用kubeadm来完成安装。</p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="1、准备工作"><a href="#1、准备工作" class="headerlink" title="1、准备工作"></a>1、准备工作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">echo "1" &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停防火墙</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭Swap</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed 's/.*swap.*/#&amp;/' /etc/fstab</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭防火墙</span></span><br><span class="line">systemctl disable firewalld &amp;&amp; systemctl stop firewalld &amp;&amp; systemctl status firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"> 关闭Selinux</span></span><br><span class="line">setenforce  0</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/sysconfig/selinux</span><br><span class="line">sed -i "s/^SELINUX=permissive/SELINUX=disabled/g" /etc/selinux/config</span><br></pre></td></tr></table></figure><h3 id="2、docker安装"><a href="#2、docker安装" class="headerlink" title="2、docker安装"></a>2、docker安装</h3><h4 id="1、下载设置源"><a href="#1、下载设置源" class="headerlink" title="1、下载设置源"></a>1、下载设置源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager \</span><br><span class="line">--add-repo \</span><br><span class="line">https://download.daocloud.io/docker/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure><h4 id="2、安装docker"><a href="#2、安装docker" class="headerlink" title="2、安装docker"></a>2、安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r  # 列出docker-ce的版本list</span><br><span class="line">yum install docker-ce-&lt;版本号&gt; -y # -y 安装docker需要的依赖，其中有个container-selinux的也可以单独下载</span><br><span class="line"><span class="meta">#</span><span class="bash"> rpm -ivh container-selinux-2.33-1.git86f33cd.el7.noarch.rpm</span></span><br></pre></td></tr></table></figure><h4 id="3、启动docker"><a href="#3、启动docker" class="headerlink" title="3、启动docker"></a>3、启动docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start docker</span><br><span class="line">docker version # 验证docker安装是否完成并启动成功</span><br></pre></td></tr></table></figure><h3 id="3、kubeadm-kubelet-kubectl安装"><a href="#3、kubeadm-kubelet-kubectl安装" class="headerlink" title="3、kubeadm/kubelet/kubectl安装"></a>3、kubeadm/kubelet/kubectl安装</h3><blockquote><p>各节点安装</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">yum install -y kubelet-1.13.5 kubeadm-1.13.5 kubectl-1.13.5 --disableexcludes=kubernetes  #禁用除kubernetes之外的仓库,要用 -y 参数，会自动安装kube-cni等插件</span><br><span class="line"></span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable kubelet # kubeadm 要求kubelet保持开机自启状态</span><br></pre></td></tr></table></figure><h3 id="4、keepalive安装"><a href="#4、keepalive安装" class="headerlink" title="4、keepalive安装"></a>4、keepalive安装</h3><blockquote><p>master节点安装：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">yum install -y keepalived</span><br><span class="line">systemctl start keepalived</span><br><span class="line"></span><br><span class="line">vim /etc/keepalived/keepalived.conf</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_k8s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script CheckK8sMaster &#123;</span><br><span class="line">    script &quot;curl -k https://10.70.49.130:6443&quot;</span><br><span class="line">    interval 3</span><br><span class="line">    timeout 9</span><br><span class="line">    fall 2</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens256 # 网卡</span><br><span class="line">    virtual_router_id 61</span><br><span class="line">    # 主节点权重最高 依次减少</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line">    #修改为本地IP </span><br><span class="line">    mcast_src_ip x.x.x.2</span><br><span class="line">    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass sqP05dQgMSlzrxHj</span><br><span class="line">    &#125;</span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        x.x.x.1</span><br><span class="line">        #x.x.x.2</span><br><span class="line">        x.x.x.3</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        x.x.x.4</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        CheckK8sMaster</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="kubernetes部署"><a href="#kubernetes部署" class="headerlink" title="kubernetes部署"></a>kubernetes部署</h2><h3 id="1、etcd二进制部署"><a href="#1、etcd二进制部署" class="headerlink" title="1、etcd二进制部署"></a>1、etcd二进制部署</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.cfssl签发证书</span></span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class="line">chmod +x cfssl_linux-amd64</span><br><span class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class="line">chmod +x cfssljson_linux-amd64</span><br><span class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl-certinfo_linux-amd64</span><br><span class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="line">export PATH=/usr/local/bin:$PATH</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 2.根据config.json文件的格式创建如下的ca-config.json文件,过期时间设置成了 87600h</span></span><br><span class="line">mkdir /root/ssl</span><br><span class="line">cd /root/ssl</span><br><span class="line">cfssl print-defaults config &gt; config.json</span><br><span class="line">cfssl print-defaults csr &gt; csr.json</span><br><span class="line"></span><br><span class="line">cat &gt; ca-config.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "signing": &#123;</span><br><span class="line">    "default": &#123;</span><br><span class="line">      "expiry": "87600h"</span><br><span class="line">    &#125;,</span><br><span class="line">    "profiles": &#123;</span><br><span class="line">      "kubernetes": &#123;</span><br><span class="line">        "usages": [</span><br><span class="line">            "signing",</span><br><span class="line">            "key encipherment",</span><br><span class="line">            "server auth",</span><br><span class="line">            "client auth"</span><br><span class="line">        ],</span><br><span class="line">        "expiry": "87600h"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">cat &gt; ca-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  "CN": "kubernetes",</span><br><span class="line">  "key": &#123;</span><br><span class="line">    "algo": "rsa",</span><br><span class="line">    "size": 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  "names": [</span><br><span class="line">    &#123;</span><br><span class="line">      "C": "CN",</span><br><span class="line">      "ST": "BeiJing",</span><br><span class="line">      "L": "BeiJing",</span><br><span class="line">      "O": "k8s",</span><br><span class="line">      "OU": "System"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 3.创建kubernetes-etcd证书</span></span><br><span class="line">cat &gt; kubernetes-etcd-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">    "CN": "kubernetes",</span><br><span class="line">    "hosts": [</span><br><span class="line">      "x.x.x.1",</span><br><span class="line">      "x.x.x.2",</span><br><span class="line">      "x.x.x.3",</span><br><span class="line">      "x.x.x.4",</span><br><span class="line">      "127.0.0.1",</span><br><span class="line">      "10.254.0.1",</span><br><span class="line">      "kubernetes",</span><br><span class="line">      "kubernetes.default",</span><br><span class="line">      "kubernetes.default.svc",</span><br><span class="line">      "kubernetes.default.svc.cluster",</span><br><span class="line">      "kubernetes.default.svc.cluster.local"</span><br><span class="line">    ],</span><br><span class="line">    "key": &#123;</span><br><span class="line">        "algo": "rsa",</span><br><span class="line">        "size": 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    "names": [</span><br><span class="line">        &#123;</span><br><span class="line">            "C": "CN",</span><br><span class="line">            "ST": "BeiJing",</span><br><span class="line">            "L": "BeiJing",</span><br><span class="line">            "O": "k8s",</span><br><span class="line">            "OU": "System"</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-etcd-csr.json | cfssljson -bare etcd</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 4.目录证书文件如下</span></span><br><span class="line">etcd-key.pem etcd.pem ca.pem ca.key</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 保证三节点证书一致</span></span><br><span class="line">scp /etc/etcd/ssl/* master2:/etc/etcd/ssl/</span><br><span class="line">scp /etc/etcd/ssl/* master3:/etc/etcd/ssl/</span><br></pre></td></tr></table></figure><blockquote><p>证书生成完毕之后，将CA证书ca.pem, etcd秘钥etcd-key.pem, etcd证书etcd.pem拷贝到各节点的/etc/etcd/ssl目录中。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 这里就用etcd 3.3.10版本</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 一：</span></span><br><span class="line">wget https://github.com/coreos/etcd/releases/download/v3.3.10/etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压缩etcd-v3.3.10-linux-amd64.tar.gz，将其中的etcd和etcdctl两个可执行文件复制到各节点的/usr/bin和/usr/<span class="built_in">local</span>/bin目录。</span></span><br><span class="line">tar zxvf etcd-v3.3.10-linux-amd64.tar.gz</span><br><span class="line">cp etcd-v3.3.10-linux-amd64/etcd* /usr/local/bin/</span><br><span class="line">cp etcd-v3.3.10-linux-amd64/etcd* /usr/bin/</span><br><span class="line">mkdir /var/lib/etcd     #etcd的数据目录</span><br><span class="line">mkdir /etc/etcd        #etcd的配置文件目录</span><br><span class="line"><span class="meta">#</span><span class="bash"> 二：</span></span><br><span class="line">yum -y install etcd</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装好etcd之后，就可以修改etcd配置以及启动service，文件路径为：/etc/etcd/etcd.conf和/usr/lib/systemd/system/etcd.service</span></span><br><span class="line">cat &gt; /etc/etcd/etcd.conf &lt;&lt; EOF</span><br><span class="line"><span class="meta">#</span><span class="bash"> [member]</span></span><br><span class="line">ETCD_NAME=etcd1 # etcd名字 三节点的话为 etcd1 etcd2 etcd3</span><br><span class="line">ETCD_DATA_DIR="/data/etcd" # etcd数据目录指定</span><br><span class="line">ETCD_LISTEN_PEER_URLS="https://x.x.x.1:2380" # 修改每个master节点的ip</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS="https://x.x.x.1:2379"</span><br><span class="line"><span class="meta">#</span><span class="bash">[cluster]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://x.x.x.1:2380"</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS="https://x.x.x.1:2379"</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=https://github.com/coreos</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">  --name $&#123;ETCD_NAME&#125; \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">  --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">  --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">  --initial-cluster-token $&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">  --initial-cluster etcd1=https://x.x.x.1:2380,etcd2=https://x.x.x.2:2380,etcd3=https://x.x.x.3:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir=$&#123;ETCD_DATA_DIR&#125;</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 上面在启动参数中指定了etcd的工作目录和数据目录分别是/var/lib/etcd和/data/etcd</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> –cert-file和–key-file分别指定etcd的公钥证书和私钥</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> –peer-cert-file和–peer-key-file分别指定了etcd的Peers通信的公钥证书和私钥。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> –trusted-ca-file指定了客户端的CA证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> –peer-trusted-ca-file指定了Peers的CA证书</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> –initial-cluster-state new表示这是新初始化集群，–name指定的参数值必须在–initial-cluster中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 高可用etcd启动需要多节点同时启动才能起来服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 分别在master节点同时启动etcd</span></span><br><span class="line">systemctl start etcd.service</span><br><span class="line">systemctl enable etcd.service</span><br></pre></td></tr></table></figure><blockquote><p>至此，etcd高可用集群搭建完成，可用一下命令验证etcd集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --endpoints=https://x.x.x.1:2379,https://x.x.x.2:2379,https://x.x.x.3:2379 \</span><br><span class="line">  cluster-health</span><br></pre></td></tr></table></figure><h3 id="2、kubeadm部署"><a href="#2、kubeadm部署" class="headerlink" title="2、kubeadm部署"></a>2、kubeadm部署</h3><h4 id="1、master部署"><a href="#1、master部署" class="headerlink" title="1、master部署"></a>1、master部署</h4><blockquote><p>部署之前请确保下载好相关image，翻墙下载或者国内dockerhub下载kubernetes镜像</p></blockquote><h5 id="1、初始化master1"><a href="#1、初始化master1" class="headerlink" title="1、初始化master1"></a>1、初始化master1</h5><blockquote><p>创建master1的初始化配置文件,网络插件采用flannel，CIDR地址是 “10.244.0.0/16”，如下为1.13.5新版本配置文件。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubeadm-master.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: x.x.x.1  # 本机ip，这里为x.x.x.1-3</span><br><span class="line">  bindPort: 6443</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta1</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.5   # kubernetes版本 对应下载的image</span><br><span class="line">imageRepository: k8s.gcr.io  # 自己修改为自己的镜像库名</span><br><span class="line"></span><br><span class="line">apiServer:</span><br><span class="line">  certSANs:</span><br><span class="line">  - "master1"</span><br><span class="line">  - "master2"</span><br><span class="line">  - "master3"</span><br><span class="line">  - "x.x.x.1"</span><br><span class="line">  - "x.x.x.2"</span><br><span class="line">  - "x.x.x.3"</span><br><span class="line">  - "x.x.x.4"</span><br><span class="line">  - "127.0.0.1"</span><br><span class="line"></span><br><span class="line">controlPlaneEndpoint: "x.x.x.4:8443" # 控制台ip指定，即vip 实现apiserver高可用</span><br><span class="line">etcd:</span><br><span class="line">  external:</span><br><span class="line">     endpoints:</span><br><span class="line">     - https://x.x.x.1:2379</span><br><span class="line">     - https://x.x.x.2:2379</span><br><span class="line">     - https://x.x.x.3:2379</span><br><span class="line">networking:</span><br><span class="line">  podSubnet: "10.244.0.0/16"</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行初始化命令即可，前提要把相关设置关闭，详情至准备工作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中在kubelet配置里加入--pod-infra-container-image 参数指定 pause私有镜像库镜像</span></span><br><span class="line">kubeadm init --config kubeadm-master.yaml</span><br></pre></td></tr></table></figure><blockquote><p>在初始化配置里，对于etcd有两种高可用的选项，一个使用内部etcd，一个使用外部etcd(独立搭建的etcd集群，而不是在初始化中搭建的)，两者初始化配置文件略有不同。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用内部etcd的话，初始化yaml文件中etcd配置如下：</span></span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: "https://127.0.0.1:2379,https://x.x.x.x:2379"</span><br><span class="line">      advertise-client-urls: "https://x.x.x.x:2379"</span><br><span class="line">      listen-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-advertise-peer-urls: "https://x.x.x.x:2380"</span><br><span class="line">      initial-cluster: "master1.hanli.com=https://x.x.x.x:2380"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用外部etcd的话，</span></span><br><span class="line">etcd:    #ETCD的地址</span><br><span class="line">   external:</span><br><span class="line">     endpoints:</span><br><span class="line">     - https://x.x.x.1:2379</span><br><span class="line">     - https://x.x.x.2:2379</span><br><span class="line">     - https://x.x.x.3:2379</span><br></pre></td></tr></table></figure><blockquote><p>init初始化之后，如果成功会出现<code>join</code>，这时就可以运行一下命令</p><p>机器上的用户要使用<code>kubectl</code>来管理集群操作集群</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure><blockquote><p>验证命令</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get cs # 如下信息</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">etcd-1               Healthy   &#123;"health": "true"&#125;</span><br><span class="line">etcd-0               Healthy   &#123;"health": "true"&#125;</span><br><span class="line">etcd-2               Healthy   &#123;"health": "true"&#125;</span><br><span class="line"></span><br><span class="line">kubectl get node # notReady 状态，是因为没有安装网络插件 Name成ip，可修改kubelet的启动参数即可</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1     NotReady      master     1m      v1.13.5</span><br></pre></td></tr></table></figure><h5 id="2、启动flannel服务"><a href="#2、启动flannel服务" class="headerlink" title="2、启动flannel服务"></a>2、启动flannel服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta">#</span><span class="bash"> flannel 默认会使用主机的第一张网卡，如果你有多张网卡，需要通过配置单独指定。修改 kube-flannel.yml 中的以下部分</span></span><br><span class="line">cat kube-flannel.yml </span><br><span class="line"> containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.11.0-amd64 # 修改下自己私有镜像库的flannel镜像名</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=ens33              #添加</span><br></pre></td></tr></table></figure><hr><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml # 创建pod，因为是ds的所以后续集群里面加节点就会自动启动flannel</span><br><span class="line">kubectl get node # 会发现 node状态变成了 Ready</span><br><span class="line">NAME         STATUS       ROLES     AGE     VERSION</span><br><span class="line">master1       Ready      master     10m      v1.13.5</span><br><span class="line"></span><br><span class="line">kubectl get po --all-namespaces</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-86c58d9df4-r59rv                   1/1     Running   0          59m</span><br><span class="line">kube-system   coredns-86c58d9df4-rbzx5                   1/1     Running   0          59m</span><br><span class="line">kube-system   kube-apiserver-master1                     1/1     Running   0          58m</span><br><span class="line">kube-system   kube-controller-manager-master1            1/1     Running   16         58m</span><br><span class="line">kube-system   kube-flannel-ds-amd64-229j2                1/1     Running   0          42m</span><br><span class="line">kube-system   kube-proxy-4wrg5                           1/1     Running   0          59m</span><br><span class="line">kube-system   kube-scheduler-master1                     1/1     Running   13         58m</span><br></pre></td></tr></table></figure><blockquote><p>不是running状态，就说明出错了，通过查看</p><p>描述：kubectl describe pod kube-scheduler-master.hanli.com -n kube-system</p><p>日志：kubectl logs kube-scheduler-master.hanli.com -n kube-system</p><p>flannel服务启动成功后，coredns也就会自动启动成功，状态为Running</p></blockquote><h5 id="3、初始化其他master节点"><a href="#3、初始化其他master节点" class="headerlink" title="3、初始化其他master节点"></a>3、初始化其他master节点</h5><blockquote><p>首先把master1上生成的ca证书等，拷贝到其他master节点上，最好免密，可使用pscp等批量任务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#!/bin/bash</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#注意修改为自己的主机名</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">export</span> CONTROL_PLANE_IPS=<span class="string">"master2 master3"</span>  </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> </span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 保证节点有/etc/kubernetes/pki目录</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 把以下证书复制到其他master节点</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="keyword">for</span> host <span class="keyword">in</span> <span class="variable">$&#123;CONTROL_PLANE_IPS&#125;</span>; <span class="keyword">do</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># ！！！修正拷贝证书的时候请指定特定证书拷贝（之前的已经备注，新加的有etcd目录，没有用外部etcd集群），因为在证书拷贝的情况下吃过亏，因此修改此处！！！</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 附issue：https://github.com/kubernetes/kubeadm/issues/1321 </span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 找了好久终于！！！哭</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/pki/*.crt $host:/etc/kubernetes/pki/</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/pki/*.key $host:/etc/kubernetes/pki/</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/pki/*.pub $host:/etc/kubernetes/pki/</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment">#scp /etc/kubernetes/admin.conf $host:/etc/kubernetes/admin.conf</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/ca.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/sa.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/front-proxy-ca.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/pki/etcd/ca.* <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/pki/etcd/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> scp /etc/kubernetes/admin.conf <span class="string">"<span class="variable">$&#123;USER&#125;</span>"</span>@<span class="variable">$host</span>:/etc/kubernetes/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="keyword">done</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> tree /etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> /etc/kubernetes/pki/</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-etcd-client.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-etcd-client.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-kubelet-client.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── apiserver-kubelet-client.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── ca.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── ca.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-ca.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-ca.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-client.crt</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── front-proxy-client.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ├── sa.key</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> └── sa.pub</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote><p>In v1.8.0, kubeadm introduced the <code>kubeadm alpha phase</code> command with the aim of making kubeadm more modular. In v1.13.0 this command graduated to <code>kubeadm init phase</code>. This modularity enables you to invoke atomic sub-steps of the bootstrap process. Hence, you can let kubeadm do some parts and fill in yourself where you need customizations.</p><p><code>kubeadm init phase</code> is consistent with the <a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow" target="_blank" rel="noopener">kubeadm init workflow</a>, and behind the scene both use the same code.</p><p>在v1.8.0中，kubeadm引入了该<code>kubeadm alpha phase</code>命令，目的是使kubeadm更加模块化。在v1.13.0中，此命令逐渐变为<code>kubeadm init phase</code>。此模块化使您可以调用引导过程的原子子步骤。因此，您可以让kubeadm执行某些操作，并在需要自定义的位置填写您自己的位置。</p><p><code>kubeadm init phase</code>与<a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-workflow" target="_blank" rel="noopener">kubeadm init工作流程</a>一致，并且在场景后面都使用相同的代码。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl init --config kube-master.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 分别修改对应ip，在在master2-3并执行即可 步骤如master1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 等待kube-proxy flannel启动成功即可</span></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -n kube-system</span><br><span class="line">NAME                                  READY     STATUS    RESTARTS   AGE</span><br><span class="line">coredns-9f9d9c76-4zrt4                  1/1     Running   0          2d</span><br><span class="line">coredns-9f9d9c76-dqd4c                  1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-apiserver-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-1   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-2   1/1     Running   0          2d</span><br><span class="line">kube-controller-manager-zjjh-rq-k8s-3   1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-7ghn7             1/1     Running   1          2d</span><br><span class="line">kube-flannel-ds-amd64-9cqts             1/1     Running   0          2d</span><br><span class="line">kube-flannel-ds-amd64-f57nh             1/1     Running   1          2d</span><br><span class="line">kube-proxy-8fwts                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-95tjb                        1/1     Running   0          2d</span><br><span class="line">kube-proxy-bls94                        1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-1            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-2            1/1     Running   0          2d</span><br><span class="line">kube-scheduler-zjjh-rq-k8s-3            1/1     Running   0          2d</span><br><span class="line">kubernetes-dashboard-67d49f7868-x79wf   1/1     Running   0          76m</span><br></pre></td></tr></table></figure><h4 id="2、Work节点加入集群"><a href="#2、Work节点加入集群" class="headerlink" title="2、Work节点加入集群"></a>2、Work节点加入集群</h4><blockquote><p>输入master节点初始化成功之后出现的<code>join</code>命令，出现<code>kubectl get nodes</code>即成功</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> kubeadm join x.x.x.4:8443 --token bnnsb7.amapp1t78llxn54d --discovery-token-ca-cert-hash sha256:520ef89be84c30e480db6d441a7e4179634a9455f0009e249ebe8f35fa792087</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><h4 id="3、集群验证"><a href="#3、集群验证" class="headerlink" title="3、集群验证"></a>3、集群验证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 节点状态</span></span><br><span class="line">[root@master] ~$ kubectl get nodes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 组件状态</span></span><br><span class="line">[root@master] ~$  kubectl get cs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 服务账户</span></span><br><span class="line">[root@master] ~$ kubectl get serviceaccount</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 集群信息</span></span><br><span class="line">[root@master] ~$ kubectl cluster-info</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证dns功能</span></span><br><span class="line">[root@master] ~$ kubectl run curl --image=radial/busyboxplus:curl -it</span><br><span class="line">[ root@curl-66959f6557-r4crd:/ ]$ nslookup kubernetes.default</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes.default</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure><blockquote><p>附录：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"><span class="comment"># kubelet.service配置文件 /use/lib/systemd/system/kubelet.service.d/10-kubeadm.conf</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><hr><p>参考链接：</p><p>kubeadm安装1.13.5：<a href="https://blog.csdn.net/fanren224/article/details/86573264#2master1_165" target="_blank" rel="noopener">https://blog.csdn.net/fanren224/article/details/86573264#2master1_165</a></p><p>二进制安装：<a href="https://github.com/mritd/ktool" target="_blank" rel="noopener">https://github.com/mritd/ktool</a></p><p>二进制安装kubernetes_v1.13.4：<a href="https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/" target="_blank" rel="noopener">https://mritd.me/2019/03/16/set-up-kubernetes-1.13.4-cluster/</a></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Kubernetes_install </tag>
            
            <tag> Kubernetes_ha </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一点Haproxy参数的文档</title>
      <link href="/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BHaproxy%E5%8F%82%E6%95%B0/"/>
      <url>/passages/%E5%AD%A6%E4%B9%A0%E6%9D%82%E8%AE%B0%E4%B9%8BHaproxy%E5%8F%82%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<p>Haproxy的一些配置参数，/etc/haproxy/haproxy.cfg</p><blockquote><p>主要是配置项的超时参数，如下：<a id="more"></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 反映连接haproxy集群报错，查看应用服务器进程大量的端口连接处于colse_wait状态。</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 这个haproxy的redis集群类似配置已经好几组了，配置都相同问啥别的都好好的这个却有问题。</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 自己尝试使用redis-cli连接（haproxy做的redis分片集群），确实能够正常连接操作，但是连接状态马上就会变成close_wait状态，重新执行命令这个close_wait状态会恢复ESTABLISHED，但是细心看端口号已经变化，也就是redis-cli发生了重新连接。于是问题清晰了：用户客户端工具建立链接后，没有自动重连来保持连接，导致超时，服务器主动断开连接，客户端再次链接的时候socket已经损坏不可用了，导致报错</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 解决办法：调整haproxy的超时参数：</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout connect 5s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout queue   5s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout client 30s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout server 30s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout client-fin 30s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout server-fin 30s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout tunnel  1h</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="comment"># 参数解释：</span></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout connect      连接尝试成功连接到server的超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout queue        在队列等待连接槽释放的超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout server       server端非活动状态超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout client       客户端非活动状态超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout server-fin   半关闭状态连接，server端非活动超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout client-fin   半关闭状态连接，client端非活动超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> timeout tunnel       客户端和服务器端通道非活动超时时间</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure></blockquote><blockquote></blockquote>]]></content>
      
      
      <categories>
          
          <category> Study </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 学习杂记 </tag>
            
            <tag> Haproxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python_list去重</title>
      <link href="/passages/Python-list%E5%8E%BB%E9%87%8D/"/>
      <url>/passages/Python-list%E5%8E%BB%E9%87%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="Python-list去重集中记录一下方法"><a href="#Python-list去重集中记录一下方法" class="headerlink" title="Python_list去重集中记录一下方法"></a>Python_list去重集中记录一下方法</h2><h3 id="怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？"><a href="#怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？" class="headerlink" title="怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？"></a>怎么快速的对列表进行去重呢，去重之后原来的顺序会不会改变呢？</h3><h4 id="1-以下的几种情况结果是一样的，去重之后顺序会改变"><a href="#1-以下的几种情况结果是一样的，去重之后顺序会改变" class="headerlink" title="1.以下的几种情况结果是一样的，去重之后顺序会改变:"></a>1.以下的几种情况结果是一样的，去重之后顺序会改变:<a id="more"></a></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最常用</span></span><br><span class="line">ids = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">news_ids = []</span><br><span class="line"><span class="keyword">for</span> id <span class="keyword">in</span> ids:</span><br><span class="line">    <span class="keyword">if</span> id <span class="keyword">not</span> <span class="keyword">in</span> news_ids:</span><br><span class="line">        news_ids.append(id)</span><br><span class="line"><span class="keyword">print</span> news_ids</span><br></pre></td></tr></table></figure><h4 id="或用set"><a href="#或用set" class="headerlink" title="或用set"></a>或用set</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用set如果列表里面有字典活着其他数据结构，貌似不会去重。</span></span><br><span class="line">ids = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">ids = list(set(ids))</span><br></pre></td></tr></table></figure><h4 id="或使用itertools-grouby"><a href="#或使用itertools-grouby" class="headerlink" title="或使用itertools.grouby"></a>或使用itertools.grouby</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line">ids = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">ids.sort()</span><br><span class="line">it = itertools.groupby(ids)</span><br><span class="line"><span class="keyword">for</span> k, g <span class="keyword">in</span> it:</span><br><span class="line">    <span class="keyword">print</span> k</span><br></pre></td></tr></table></figure><blockquote><p>关于itertools.groupby的原理可以看这里：</p><p>(1) <a href="http://docs.python.org/2/library/itertools.html#itertools.groupby" target="_blank" rel="noopener">http://docs.python.org/2/library/itertools.html#itertools.groupby</a></p><p>(2)<a href="https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001415616001996f6b32d80b6454caca3d33c965a07611f000" target="_blank" rel="noopener">https://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001415616001996f6b32d80b6454caca3d33c965a07611f000</a></p></blockquote><h4 id="2-怎么能不改变原来的顺序呢？-要用到reduce-关于reduce的介绍-http-docs-python-org-2-library-functions-html-reduce"><a href="#2-怎么能不改变原来的顺序呢？-要用到reduce-关于reduce的介绍-http-docs-python-org-2-library-functions-html-reduce" class="headerlink" title="2.怎么能不改变原来的顺序呢？(要用到reduce 关于reduce的介绍　 http://docs.python.org/2/library/functions.html#reduce)"></a>2.怎么能不改变原来的顺序呢？(要用到reduce 关于reduce的介绍　 <a href="http://docs.python.org/2/library/functions.html#reduce" target="_blank" rel="noopener">http://docs.python.org/2/library/functions.html#reduce</a>)</h4><blockquote><p>关于lambda的文章:<a href="http://www.cnblogs.com/nyist-xsk/p/7404675.html" target="_blank" rel="noopener">http://www.cnblogs.com/nyist-xsk/p/7404675.html</a></p><p>关于reduce的文章: </p><p>(1) <a href="http://www.cnblogs.com/XXCXY/p/5180245.html" target="_blank" rel="noopener">http://www.cnblogs.com/XXCXY/p/5180245.html</a></p><p>(2) <a href="http://www.pythoner.com/46.html" target="_blank" rel="noopener">http://www.pythoner.com/46.html</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">5</span>]: ids = [<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">In [<span class="number">6</span>]: func = <span class="keyword">lambda</span> x,y:x <span class="keyword">if</span> y <span class="keyword">in</span> x <span class="keyword">else</span> x + [y]</span><br><span class="line">In [<span class="number">7</span>]: reduce(func, [[], ] + ids)</span><br><span class="line">Out[<span class="number">7</span>]: [<span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>]</span><br></pre></td></tr></table></figure><blockquote><p>其中的 lambda x,y:x if y in x else x + [y] 等价于 lambda x,y: y in x and x or x+[y] 。<br>思路其实就是先把ids变为[[], 1,4,3,……] ,然后在利用reduce的特性.</p></blockquote><h4 id="去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如："><a href="#去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如：" class="headerlink" title="去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如："></a>去列表去重，不改变原来的顺序，还可以使用一个空列表把原列表里面不重复的数据”装起来”，例如：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">list2 = []</span><br><span class="line">list1 = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">5</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list1:</span><br><span class="line">    <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> list2:</span><br><span class="line">        list2.append(i)</span><br><span class="line">list2</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>]</span><br><span class="line">或者使用删除元素索引的方法对列表去重，并且不改变原列表的顺序</span><br><span class="line"><span class="comment"># python for删除的时候会往前移(垃圾回收机制)，未遍历到的后一个占了前一个被删除的"位置"，导致这个数不会被遍历到，而使最后的结果错误</span></span><br><span class="line"><span class="comment"># 局部变量在栈内存中存在,当for循环语句结束,那么变量会及时被gc(垃圾回收器)及时的释放掉,不浪费空间；</span></span><br><span class="line"><span class="comment"># 如果使用循环之后还想去访问循环语句中控制那个变量,使用while循环。</span></span><br><span class="line"><span class="comment"># 所以使用while循环删除nums中的Val(的下标)</span></span><br><span class="line">nums = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">1</span>]</span><br><span class="line">val = <span class="number">3</span></span><br><span class="line"><span class="keyword">while</span> val <span class="keyword">in</span> nums:</span><br><span class="line">      nums.pop(nums.index(val))</span><br><span class="line"><span class="keyword">print</span> nums</span><br><span class="line"><span class="keyword">return</span> len(nums)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Python </tag>
            
            <tag> Python_碎片化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang_问题</title>
      <link href="/passages/Golang-%E9%97%AE%E9%A2%98/"/>
      <url>/passages/Golang-%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>（持续更新）</p><h2 id="一、gorm遇到invalid-connection报错"><a href="#一、gorm遇到invalid-connection报错" class="headerlink" title="一、gorm遇到invalid connection报错"></a>一、gorm遇到invalid connection报错</h2><blockquote><p>(/data/dcops_workspace/src/x.x.x.x/xxxx/model/containerappid_info.go:76)<br>[2019-04-09 14:41:40]  invalid connection<a id="more"></a></p><p>现象：今天使用gorm时，总遇到invalid connection报错，导致<strong>过一段时间</strong>调一下接口服务容器就会重启</p><p>网上查了文档看了gorm的mysql连接池的参数：</p><p>dcosdb.DB().SetMaxIdleConns(10)  // SetMaxIdleConns设置idle connection pool的最大连接数。如果MaxOpenConns的值 &gt; 0，但是小于这里设置的MaxIdleConns，则MaxIdleConns将自动降到与MaxOpenConns的限制相同。如果 &lt;= 0, 则没有空闲连接会被保留。<strong><em>最大空闲连接数</em></strong></p><p>dcosdb.DB().SetMaxOpenConns(100)  //SetMaxOpenConns用于设置Database最大可以打开的连接数。如果 &lt;= 0, 则没有连接限制。且默认值为0（无限制）。<strong><em>数据库最大连接数</em></strong></p><p>dcosdb.DB().SetConnMaxLifetime(time.Second <em> 5)  // SetConnMaxLifetime用于设置连接可被重新使用的最大时间间隔。如果超时，则连接会在重新使用前被关闭。如果 d &lt;= 0, 则连接将被永久保留。**</em>连接最长存活期，超过这个时间连接将不再被复用***</p><p>原因是：程序在重复使用数据库tcp连接池中的某个连接时，该命中连接可能已被服务器过期丢弃，而客户端这边认为该连接为过期，还有效。此时会报错 invalid connection。随后将该连接重连接池中丢弃</p><p>原因参考：<a href="https://blog.csdn.net/dghpgyss/article/details/86480837" target="_blank" rel="noopener">https://blog.csdn.net/dghpgyss/article/details/86480837</a></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 发现我把dcosdb.DB().SetConnMaxLifetime(time.Second * 5)这个参数设置成了dcosdb.DB().SetConnMaxLifetime(time.Hour)导致了每次连接丢弃，但是客户端不知道。服务端主动关闭了连接，因为服务端对连接的保持超时时间到了也关闭的，所以可以设置客户端连接超时时间小于服务端DB.SetConnMaxLifetime(time.Second)</span></span><br><span class="line"><span class="comment">// SetConnMaxLifetime sets the maximum amount of time a connection may be reused.</span></span><br><span class="line">dcosdb.DB().SetConnMaxLifetime(time.Second * <span class="number">5</span>)</span><br><span class="line"><span class="comment">// dcosdb.DB().SetConnMaxLifetime(time.Hour) 设置成了1小时</span></span><br></pre></td></tr></table></figure><h2 id="二、"><a href="#二、" class="headerlink" title="二、"></a>二、</h2>]]></content>
      
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发之原子操作</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8B%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<p><strong><em>转自：<a href="http://ifeve.com/go-concurrency-atomic/" target="_blank" rel="noopener">http://ifeve.com/go-concurrency-atomic/</a></em></strong></p><blockquote><p>原理多，代码量偏少。</p></blockquote><p>我们已经知道，原子操作即是进行过程中不能被中断的操作。也就是说，针对某个值的原子操作在被进行的过程当中，CPU绝不会再去进行其它的针对该值的操作。无论这些其它的操作是否为原子操作都会是这样。为了实现这样的严谨性，原子操作仅会由一个独立的CPU指令代表和完成。只有这样才能够在并发环境下保证原子操作的绝对安全。<br>Go语言提供的原子操作都是非侵入式的。它们由标准库代码包sync/atomic中的众多函数代表。我们可以通过调用这些函数对几种简单的类型的值进行原子操作。这些类型包括int32、int64、uint32、uint64、uintptr和unsafe.Pointer类型，共6个。这些函数提供的原子操作共有5种，即：增或减、比较并交换、载入、存储和交换。它们分别提供了不同的功能，且适用的场景也有所区别。下面，我们就根据这些种类对Go语言提供的原子操作进行逐一的讲解。<a id="more"></a></p><p>1、增或减<br>被用于进行增或减的原子操作（以下简称原子增/减操作）的函数名称都以“Add”为前缀，并后跟针对的具体类型的名称。例如，实现针对uint32类型的原子增/减操作的函数的名称为AddUint32。事实上，sync/atomic包中的所有函数的命名都遵循此规则。<br>顾名思义，原子增/减操作即可实现对被操作值的增大或减小。因此，被操作值的类型只能是数值类型。更具体的讲，它只能是我们在前面提到的int32、int64、uint32、uint64和uintptr类型。例如，我们如果想原子的把一个int32类型的变量i32的值增大3的话，可以这样做：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newi32 := atomic.AddInt32(&amp;i32, <span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>我们将指向i32变量的值的指针值和代表增减的差值3作为参数传递给了atomic.AddInt32函数。之所以要求第一个参数值必须是一个指针类型的值，是因为该函数需要获得到被操作值在内存中的存放位置，以便施加特殊的CPU指令。从另一个角度看，对于一个不能被取址的数值，我们是无法进行原子操作的。此外，这类函数的第二个参数的类型被操作值的类型总是相同的。因此，在前面那个调用表达式被求值的时候，字面量3会被自动转换为一个int32类型的值。函数atomic.AddInt32在被执行结束之时会返回经过原子操作后的新值。不过不要误会，我们无需把这个新值再赋给原先的变量i32。因为它的值已经在atomic.AddInt32函数返回之前被原子的修改了。<br>与该函数类似的还有atomic.AddInt64函数、atomic.AddUint32函数、atomic.AddUint64函数和atomic.AddUintptr函数。这些函数也可以被用来原子的增/减对应类型的值。例如，如果我们要原子的将int64类型的变量i64的值减小3话，可以这样编写代码：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> i64 <span class="keyword">int64</span></span><br><span class="line">atomic.AddInt64(&amp;i64, <span class="number">-3</span>)</span><br></pre></td></tr></table></figure><p>不过，由于atomic.AddUint32函数和atomic.AddUint64函数的第二个参数的类型分别是uint32和uint64，所以我们无法通过传递一个负的数值来减小被操作值。那么，这是不是就意味着我们无法原子的减小uint32或uint64类型的值了呢？幸好，不是这样。Go语言为我们提供了一个可以迂回的达到此目的办法。<br>如果我们想原子的把uint32类型的变量ui32的值增加NN（NN代表了一个负整数），那么我们可以这样调用atomic.AddUint32函数：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic.AddUint32(&amp;ui32, ^<span class="keyword">uint32</span>(-NN<span class="number">-1</span>))</span><br></pre></td></tr></table></figure><p>对于uint64类型的值来说也是这样。调用表达式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic.AddUint64(&amp;ui64, ^<span class="keyword">uint64</span>(-NN<span class="number">-1</span>))</span><br></pre></td></tr></table></figure><p>表示原子的把uint64类型的变量ui64的值增加NN（或者说减小-NN）。<br>之所以这种方式可以奏效，是因为它利用了二进制补码的特性。我们知道，一个负整数的补码可以通过对它按位（除了符号位之外）求反码并加一得到。我们还知道，一个负整数可以由对它的绝对值减一并求补码后得到的数值的二进制表示来代表。例如，如果NN是一个int类型的变量且其值为-35，那么表达式</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32</span>(<span class="keyword">int32</span>(NN))</span><br></pre></td></tr></table></figure><p>和</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^<span class="keyword">uint32</span>(-NN<span class="number">-1</span>)</span><br></pre></td></tr></table></figure><p>的结果值就都会是11111111111111111111111111011101。由此，我们使用^uint32(-NN-1)和^uint64(-NN-1)来分别表示uint32类型和uint64类型的NN就顺理成章了。这样，我们就可以合理的绕过uint32类型和uint64类型对值的限制了。<br>以上是官方提供一种通用解决方案。除此之外，我们还有两个非通用的方案可供选择。首先，需要明确的是，对于一个代表负数的字面常量来说，它们是无法通过简单的类型转换将其转换为uint32类型或uint64类型的值的。例如，表达式uint32(-35)和uint64(-35)都是不合法的。它们都不能通过编译。但是，如果我们事先把这个字面量赋给一个变量然后再对这个变量进行类型转换，那么就可以得到Go语言编译器的认可。我们依然以值为-35的变量NN为例，下面这条语句可以通过编译并被正常执行：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Printf(<span class="string">"The variable: %b.\n"</span>, <span class="keyword">uint32</span>(NN))</span><br></pre></td></tr></table></figure><p>其输出内容为：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The variable: <span class="number">11111111111111111111111111011101.</span></span><br></pre></td></tr></table></figure><p>可以看到，表达式uint32(NN)的结果值的二进制表示与前面的uint32(int32(NN))表达式以及^uint32(-NN-1)表达式的结果值是一致的。它们都可以被用来表示uint32类型的-35。因此，我们也可以使用下面的调用表达式来原子的把变量ui32的值减小-NN：<br>atomic.AddUint32(&amp;ui32, uint32(NN))<br>不过，这样的编写方式仅在NN是数值类型的变量的时候才可以通过编译。如果NN是一个常量，那么也会使表达式uint32(NN)不合法并无法通过编译。它与表达式uint32(-35)造成的编译错误是一致的。在这种情况下，我们可以这样来达到上述目的：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic.AddUint32(&amp;ui32, NN&amp;math.MaxUint32)</span><br></pre></td></tr></table></figure><p>其中，我们用到了标准库代码包math中的常量MaxUint32。math.MaxUint32常量表示的是一个32位的、所有二进制位上均为1的数值。我们把NN和math.MaxUint32进行按位与操作的意义是使前者的值能够被视为一个uint32类型的数值。实际上，对于表达式NN&amp;math.MaxUint32来说，其结果值的二进制表示与前面uint32(int32(NN))表达式以及^uint32(-NN-1)表达式的结果值也是一致的。<br>我们在这里介绍的这两种非官方的解决方案是不能混用的。更具体地说，如果NN是一个常量，那么表达式uint32(NN)是无法通过编译的。而如果NN是一个变量，那么表达式NN&amp;math.MaxUint32就无法通过编译。前者的错误在于代表负整数的字面常量不能被转换为uint32类型的值。后者的错误在于这个按位与运算的结果值的类型不是uint32类型而是int类型，从而导致数据溢出的错误。相比之下，官方给出的那个解决方案的适用范围更广。<br>有些读者可能会有这样的疑问：为什么如此曲折的实现这一功能？直接声明出atomic.SubUint32()函数和atomic.SubUint64()函数不好吗？作者理解，不这样做是为了让这些原子操作的API可以整齐划一，并且避免在扩充它们的时候使sync/atomic包中声明的程序实体成倍增加。（作者向Go语言官方提出了这个问题并引发了一些讨论，他们也许会使用投票的方式来选取更好一些的方案）<br>注意，并不存在名为atomic.AddPointer的函数，因为unsafe.Pointer类型值之间既不能被相加也不能被相减。<br>2、比较并交换<br>有些读者可能很熟悉比较并交换操作的英文称谓——Compare And Swap，简称CAS。在sync/atomic包中，这类原子操作由名称以“CompareAndSwap”为前缀的若干个函数代表。<br>我们依然以针对int32类型值的函数为例。该函数名为CompareAndSwapInt32。其声明如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CompareAndSwapInt32</span><span class="params">(addr *<span class="keyword">int32</span>, old, <span class="built_in">new</span> <span class="keyword">int32</span>)</span> <span class="params">(swapped <span class="keyword">bool</span>)</span></span></span><br></pre></td></tr></table></figure><p>可以看到，CompareAndSwapInt32函数接受三个参数。第一个参数的值应该是指向被操作值的指针值。该值的类型即为*int32。后两个参数的类型都是int32类型。它们的值应该分别代表被操作值的旧值和新值。CompareAndSwapInt32函数在被调用之后会先判断参数addr指向的被操作值与参数old的值是否相等。仅当此判断得到肯定的结果之后，该函数才会用参数new代表的新值替换掉原先的旧值。否则，后面的替换操作就会被忽略。这正是“比较并交换”这个短语的由来。CompareAndSwapInt32函数的结果swapped被用来表示是否进行了值的替换操作。<br>与我们前面讲到的锁相比，CAS操作有明显的不同。它总是假设被操作值未曾被改变（即与旧值相等），并一旦确认这个假设的真实性就立即进行值替换。而使用锁则是更加谨慎的做法。我们总是先假设会有并发的操作要修改被操作值，并使用锁将相关操作放入临界区中加以保护。我们可以说，使用锁的做法趋于悲观，而CAS操作的做法则更加乐观。<br>CAS操作的优势是，可以在不形成临界区和创建互斥量的情况下完成并发安全的值替换操作。这可以大大的减少同步对程序性能的损耗。当然，CAS操作也有劣势。在被操作值被频繁变更的情况下，CAS操作并不那么容易成功。有些时候，我们可能不得不利用for循环以进行多次尝试。示例如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> value <span class="keyword">int32</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addValue</span><span class="params">(delta <span class="keyword">int32</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">v := value</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;value, v, (v + delta)) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，为了保证CAS操作的成功完成，我们仅在CompareAndSwapInt32函数的结果值为true时才会退出循环。这种做法与自旋锁的自旋行为相似。addValue函数会不断的尝试原子的更新value的值，直到这一操作成功为止。操作失败的缘由总会是value的旧值已不与v的值相等了。如果value的值会被并发的修改的话，那么发生这种情况是很正常的。<br>CAS操作虽然不会让某个Goroutine阻塞在某条语句上，但是仍可能会使流程的执行暂时停滞。不过，这种停滞的时间大都极其短暂。<br>请记住，当想并发安全的更新一些类型（更具体的讲是，前文所述的那6个类型）的值的时候，我们总是应该优先选择CAS操作。<br>与此对应，被用来进行原子的CAS操作的函数共有6个。除了我们已经讲过的CompareAndSwapInt32函数之外，还有CompareAndSwapInt64、CompareAndSwapPointer、CompareAndSwapUint32、CompareAndSwapUint64 和CompareAndSwapUintptr函数。这些函数的结果声明列表与CompareAndSwapInt32函数的完全一致。而它们的参数声明列表与后者也非常类似。虽然其中的那三个参数的类型不同，但其遵循的规则是一致的，即：第二个和第三个参数的类型均为与第一个参数的类型（即某个指针类型）紧密相关的那个类型。例如，如果第一个参数的类型为*unsafe.Pointer，那么后两个参数的类型就一定是unsafe.Pointer。这也是由这三个参数的含义决定的。<br>3、载入<br>在前面示例的for循环中，我们使用语句v := value为变量v赋值。但是，要注意，其中的读取value的值的操作并不是并发安全的。在该读取操作被进行的过程中，其它的对此值的读写操作是可以被同时进行的。它们并不会受到任何限制。<br>在第7章的第1节的最后，我们举过这样一个例子：在32位计算架构的计算机上写入一个64位的整数。如果在这个写操作未完成的时候有一个读操作被并发的进行了，那么这个读操作很可能会读取到一个只被修改了一半的数据。这种结果是相当糟糕的。<br>为了原子的读取某个值，sync/atomic代码包同样为我们提供了一系列的函数。这些函数的名称都以“Load”为前缀，意为载入。我们依然以针对int32类型值的那个函数为例。<br>我们下面利用LoadInt32函数对上一个示例稍作修改：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addValue</span><span class="params">(delta <span class="keyword">int32</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">v := atomic.LoadInt32(&amp;value)</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;value, v, (v + delta)) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数atomic.LoadInt32接受一个int32类型的指针值，并会返回该指针值指向的那个值。在该示例中，我们使用调用表达式atomic.LoadInt32(&amp;value)替换掉了标识符value。替换后，那条赋值语句的含义就变为：原子的读取变量value的值并把它赋给变量v。有了“原子的”这个形容词就意味着，在这里读取value的值的同时，当前计算机中的任何CPU都不会进行其它的针对此值的读或写操作。这样的约束是受到底层硬件的支持的。<br>注意，虽然我们在这里使用atomic.LoadInt32函数原子的载入value的值，但是其后面的CAS操作仍然是有必要的。因为，那条赋值语句和if语句并不会被原子的执行。在它们被执行期间，CPU仍然可能进行其它的针对value的值的读或写操作。也就是说，value的值仍然有可能被并发的改变。<br>与atomic.LoadInt32函数的功能类似的函数有atomic.LoadInt64、atomic.LoadPointer、atomic.LoadUint32、atomic.LoadUint64和atomic.LoadUintptr。<br>4、存储<br>与读取操作相对应的是写入操作。而sync/atomic包也提供了与原子的值载入函数相对应的原子的值存储函数。这些函数的名称均以“Store”为前缀。<br>在原子的存储某个值的过程中，任何CPU都不会进行针对同一个值的读或写操作。如果我们把所有针对此值的写操作都改为原子操作，那么就不会出现针对此值的读操作因被并发的进行而读到修改了一半的值的情况了。<br>原子的值存储操作总会成功，因为它并不会关心被操作值的旧值是什么。显然，这与前面讲到的CAS操作是有着明显的区别的。因此，我们并不能把前面展示的addValue函数中的调用atomic.CompareAndSwapInt32函数的表达式替换为对atomic.StoreInt32函数的调用表达式。<br>函数atomic.StoreInt32会接受两个参数。第一个参数的类型是int 32类型的，其含义同样是指向被操作值的指针。而第二个参数则是int32类型的，它的值应该代表欲存储的新值。其它的同类函数也会有类似的参数声明列表。<br>5、交换<br>在sync/atomic代码包中还存在着一类函数。它们的功能与前文所讲的CAS操作和原子载入操作都有些类似。这样的功能可以被称为原子交换操作。这类函数的名称都以“Swap”为前缀。<br>与CAS操作不同，原子交换操作不会关心被操作值的旧值。它会直接设置新值。但它又比原子载入操作多做了一步。作为交换，它会返回被操作值的旧值。此类操作比CAS操作的约束更少，同时又比原子载入操作的功能更强。<br>以atomic.SwapInt32函数为例。它接受两个参数。第一个参数是代表了被操作值的内存地址的int32类型值，而第二个参数则被用来表示新值。注意，该函数是有结果值的。该值即是被新值替换掉的旧值。atomic.SwapInt32函数被调用后，会把第二个参数值置于第一个参数值所表示的内存地址上（即修改被操作值），并将之前在该地址上的那个值作为结果返回。其它的同类函数的声明和作用都与此类似。<br>至此，我们快速且简要地介绍了sync/atomic代码包中的所有函数的功能和用法。这些函数都被用来对特定类型的值进行原子性的操作。如果我们想以并发安全的方式操作单一的特定类型（int32、int64、uint32、uint64、uintptr或unsafe.Pointer）的值的话，应该首先考虑使用这些函数来实现。请注意，原子的减小一些特定类型（确切地说，是uint32类型和uint64类型）的值的实现方式并不那么直观。在Go语言官方对此进行改进之前，我们应该按照他们为我们提供的那种方式来进行此类操作。<br>6、应用于实际<br>下面，我们就使用刚刚介绍的知识再次对在前面示例中创建的myDataFile类型进行改造。在myDataFile类型的第二个版本中，我们仍然使用两个互斥锁来对与roffset字段和woffset字段相关的操作进行保护。myDataFile类型的方法中的绝大多数都包含了这些操作。<br>首先，我们来看对roffset字段的操作。在*myDataFile类型的Read方法中有这样一段代码：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取并更新读偏移量</span></span><br><span class="line"><span class="comment">// 原子操作偏移量</span></span><br><span class="line"><span class="keyword">var</span> offset <span class="keyword">int64</span></span><br><span class="line">df.rmutex.Lock()</span><br><span class="line">offset = df.roffset</span><br><span class="line">df.roffset += <span class="keyword">int64</span>(df.dataLen)</span><br><span class="line">df.rmutex.Unlock()</span><br></pre></td></tr></table></figure><p>这段代码的含义是读取读偏移量的值并把它存入到局部变量中，然后增加读偏移量的值以使其它的并发的读操作能够被正确、有效的进行。为了使程序能够在并发环境下有序的对roffset字段进行操作，我们为这段代码应用了互斥锁rmutex。<br>字段roffset和变量offset都是int64类型的。后者代表了前者的旧值。而字段roffset的新值即为其旧值与dataLen字段的值的和。实际上，这正是原子的CAS操作的适用场景。我们现在用CAS操作来实现该段代码的功能：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取并更新读偏移量</span></span><br><span class="line"><span class="keyword">var</span> offset <span class="keyword">int64</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">offset = df.roffset</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt64(&amp;df.roffset, offset,</span><br><span class="line">(offset + <span class="keyword">int64</span>(df.dataLen))) &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据roffset和offset的类型，我们选用atomic.CompareAndSwapInt64来进行CAS操作。我们在调用该函数的时候传入了三个参数，分别代表了被操作值的地址、旧值和新值。如果该函数的结果值是true，那么我们就退出for循环。这时，变量offset即是我们需要的读偏移量的值。另一方面，如果该函数的结果值是false，那么就说明在从完成读取到开始更新roffset字段的值的期间内有其它的并发操作对该值进行了更改。当遇到这种情况，我们就需要再次尝试。只要尝试失败，我们就会重新读取roffset字段的值并试图对该值进行CAS操作，直到成功为止。具体的尝试次数与具体的并发环境有关。<br>我们在前面说过，在32位计算架构的计算机上写入一个64位的整数也会存在并发安全方面的隐患。因此，我们还应该将这段代码中的offset = df.roffset语句修改为offset = atomic.LoadInt64(&amp;df.roffset)。<br>除了这里，在*myDataFile类型的Rsn方法中也有针对roffset字段的读操作：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df.rmutex.Lock()</span><br><span class="line"><span class="keyword">defer</span> df.rmutex.Unlock()</span><br><span class="line"><span class="keyword">return</span> df.roffset / <span class="keyword">int64</span>(df.dataLen)</span><br></pre></td></tr></table></figure><p>我们现在去掉施加在上面的锁定和解锁操作，转而使用原子操作来实现它。修改后的代码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">offset := atomic.LoadInt64(&amp;df.roffset)</span><br><span class="line"><span class="keyword">return</span> offset / <span class="keyword">int64</span>(df.dataLen)</span><br></pre></td></tr></table></figure><p>这样，我们就在依然保证相关操作的并发安全的前提下去除了对互斥锁rmutex的使用。对于字段woffset和互斥锁wmutex，我们也应该如法炮制。读者可以试着按照上面的方法修改与之相关的Write方法和Wsn方法。<br>在修改完成之后，我们就可以把代表互斥锁的rmutex字段和wmutex字段从myDataFile类型的基本结构中去掉了。这样，该类型的基本结构会显得精简了不少。<br>通过本次改造，我们减少了myDataFile类型及其方法对互斥锁的使用。这对该程度的性能和可伸缩性都会有一定的提升。其主要原因是，原子操作由底层硬件支持，而锁则由操作系统提供的API实现。若实现相同的功能，前者通常会更有效率。读者可以为前面展示的这三个版本的*myDataFile类型的实现编写性能测试，以验证上述观点的正确性。<br>总之，我们要善用原子操作。因为它比锁更加简练和高效。不过，由于原子操作自身的限制，锁依然常用且重要。</p>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Golang并发之sync.WaitGroup</title>
      <link href="/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8Bsync-WaitGroup/"/>
      <url>/passages/Golang%E5%B9%B6%E5%8F%91%E4%B9%8Bsync-WaitGroup/</url>
      
        <content type="html"><![CDATA[<h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br></pre></td></tr></table></figure><h2 id="sync-WaitGroup-Golang内置sync包"><a href="#sync-WaitGroup-Golang内置sync包" class="headerlink" title="sync.WaitGroup/ Golang内置sync包"></a>sync.WaitGroup/ Golang内置sync包<a id="more"></a></h2><blockquote><p>Wg变量：该类型有三个指针方法，即Add、Done和Wait。</p><p>类型sync.WaitGroup是一个结构体类型。当一个sync.WaitGroup类型的变量被声明之后，其值中的那个计数值将会是0。 </p><p>我们可以通过该值的Add方法增大或减少其中的计数值。 如下：</p><p>wg.Add(1) </p><p>与wg.Add(-1)的执行效果是一致的： </p><p>wg.Done() </p><p>总结:</p><p>1、使用Done方法禁忌与Add方法的一样——不要让相应的计数值变为负数。 </p><p>例如，这段代码中的第5条语句会引发一个运行时恐慌： </p><p>var wg sync.WaitGroup </p><p>wg.Add(2) </p><p>wg.Done() </p><p>wg.Done() </p><p>wg.Done() </p><p>2、当我们调用sync.WaitGroup类型值的Wait方法的时候，它会去检查该值中的计数值。如果这个计数值为0，那么该方法会立即返回，且不会对程序的运行产生任何影响。 但是，如果这个计数值大于0，那么该方法的调用方所属的那个Goroutine就会被阻塞。直到该计数值重新变为0之时，为此而被阻塞的所有Goroutine才会被唤醒。 </p></blockquote><h2 id="代码案例"><a href="#代码案例" class="headerlink" title="代码案例"></a>代码案例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协调多个Goroutine的运行。假设，在我们的程序中启用了4个Goroutine，分别是G1、G2、G3和G4。其中，G2、G3和G4是由G1中的代码启用并被用于执行某些特定任务的。G1在启用这3个Goroutine之后要等待这些特定任务的完成。</span></span><br><span class="line"><span class="comment">// 方案1（channel通道）</span></span><br><span class="line">sign := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">byte</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G2</span></span><br><span class="line">    sign &lt;- <span class="number">2</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G3</span></span><br><span class="line">    sign &lt;- <span class="number">3</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G4</span></span><br><span class="line">    sign &lt;- <span class="number">4</span></span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">    fmt.Printf(<span class="string">"G%d is ended.\n"</span>, &lt;-sign)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方案2（sync.WaitGroup）</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G2</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G3</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//G4</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(<span class="string">"Finish"</span>)</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">     <span class="string">"fmt"</span></span><br><span class="line">     <span class="string">"sync"</span></span><br><span class="line">     <span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">     <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">     <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i = i + <span class="number">1</span> &#123;</span><br><span class="line">          wg.Add(<span class="number">1</span>)</span><br><span class="line">          <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">               <span class="comment">// defer wg.Done()</span></span><br><span class="line">               <span class="keyword">defer</span> wg.Add(<span class="number">-1</span>)</span><br><span class="line">               EchoNumber(n)</span><br><span class="line">          &#125;(i) <span class="comment">// n = i</span></span><br><span class="line">     &#125;</span><br><span class="line">     wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EchoNumber</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">     time.Sleep(<span class="number">3e9</span>)</span><br><span class="line">     fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Golang并发 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Golang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo入坑-主题篇</title>
      <link href="/passages/Hexo%E5%85%A5%E5%9D%91-%E4%B8%BB%E9%A2%98%E7%AF%87/"/>
      <url>/passages/Hexo%E5%85%A5%E5%9D%91-%E4%B8%BB%E9%A2%98%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexo入坑-安装篇</title>
      <link href="/passages/Hexo%E5%85%A5%E5%9D%91-%E5%AE%89%E8%A3%85%E7%AF%87/"/>
      <url>/passages/Hexo%E5%85%A5%E5%9D%91-%E5%AE%89%E8%A3%85%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul><li><font size="3">有一个github账号，没有的话去注册一个</font></li><li><font size="3">安装了git、node.js、npm，并了解相关基础知识</font><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node -v</span><br><span class="line">git --version</span><br></pre></td></tr></table></figure></li><li><p><font size="3">安装了git for Mac（或者其它git客户端）</font><a id="more"></a></p></li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="1-创建github仓库"><a href="#1-创建github仓库" class="headerlink" title="1. 创建github仓库"></a>1. 创建github仓库</h3><p>​    github上新建一个名为<code>用户名.github.io</code>的项目，例如：sheldon-lu.github.io，</p><p>这个项目名是用来做域名用的，当然也可以去申请一个属于自己的域名，一般推荐<a href="https://www.GoDaddy.com/" target="_blank" rel="noopener"><code>godaddy</code></a></p><h3 id="2-配置SSH-key免密上传"><a href="#2-配置SSH-key免密上传" class="headerlink" title="2. 配置SSH key免密上传"></a>2. 配置SSH key免密上传</h3><p>不详细讲了，命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.ssh</span><br><span class="line"><span class="meta">#</span> 检查本机已存在的ssh密钥</span><br><span class="line"><span class="meta">#</span> 如果提示：No such file or directory 说明你是第一次使用git。</span><br><span class="line">ssh-keygen -t rsa -C "邮件地址"</span><br><span class="line"><span class="meta">#</span> 然后连续3次回车，最终会生成一个文件在用户目录下，打开用户目录，找到.ssh\id_rsa.pub文件，记事本打开并复制里面的内容，打开你的github主页，进入个人设置 -&gt; SSH and GPG keys -&gt; New SSH key</span><br><span class="line"><span class="meta">#</span> 测试是否成功，验证命令：</span><br><span class="line">ssh -T git@GitHub.com</span><br><span class="line"><span class="meta">#</span># Hi cnfeat! You've successfully authenticated, but GitHub does not provide shell access.出现这个就是成功了，之后可以测试一下push是否免密上传。</span><br><span class="line"><span class="meta">#</span> 此时你可能还需要配置，这个属于全局config，对于git项目完全可以git clone下来之后进行push等等操作：</span><br><span class="line">git config --global user.name "liuxianan"// 你的github用户名，非昵称</span><br><span class="line">git config --global user.email  "xxx@qq.com"// 填写你的github注册邮箱</span><br></pre></td></tr></table></figure><h3 id="3-Hexo安装及介绍"><a href="#3-Hexo安装及介绍" class="headerlink" title="3. Hexo安装及介绍"></a>3. Hexo安装及介绍</h3><p>官网： <a href="http://hexo.io" target="_blank" rel="noopener">http://hexo.io</a> </p><p>github: <a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">https://github.com/hexojs/hexo</a> </p><p>由于github pages存放的都是静态文件，博客存放的不只是文章内容，还有文章列表、分类、标签、翻页等动态内容，假如每次写完一篇文章都要手动更新博文目录和相关链接信息，相信谁都会疯掉，所以hexo所做的就是将这些md文件都放在本地，每次写完文章后调用写好的命令来批量完成相关页面的生成，然后再将有改动的页面提交到github。 </p><p>安装之前先来说几个注意事项： </p><ol><li><p>很多命令既可以用Windows的cmd来完成，也可以使用git bash来完成，但是部分命令会有一些问题，为避免不必要的问题，建议全部使用git bash来执行（对于windows用户而言）； </p></li><li><p>hexo不同版本差别比较大，网上很多文章的配置信息都是基于2.x的，所以注意不要被误导； </p></li><li><p>hexo有2种_config.yml文件，一个是根目录下的全局的_config.yml，一个是各个theme下的； </p></li></ol><p>这里给官网上的部署命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir &lt;Your blog&gt; # 创建blog文档文件夹</span><br><span class="line">npm install hexo-cli -g # 安装hexo以及hexo命令</span><br><span class="line"><span class="meta">#</span> 初始化一个blog项目，其中'blog'为你的blog名字，hexo会自动下载一些文件到这个目录，包括node_modules.</span><br><span class="line">hexo init blog</span><br><span class="line">cd blog</span><br><span class="line">npm install</span><br><span class="line">hexo server</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span># 这两个命令是经常会用到的</span><br><span class="line">hexo s -g #生成并本地预览</span><br><span class="line">hexo d -g #生成并上传</span><br></pre></td></tr></table></figure><p>对于mac用户，如果遇到以下报错：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">安装npm install hexo-cli -g时报错</span><br><span class="line">npm install hexo -g</span><br><span class="line">npm WARN locking Error: EACCES, open &apos;/Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock&apos;</span><br><span class="line">npm WARN locking at Error (native)</span><br><span class="line">npm WARN locking /Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock failed &#123; [Error: EACCES, open &apos;/Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock&apos;]</span><br><span class="line">npm WARN locking errno: -13,</span><br><span class="line">npm WARN locking code: &apos;EACCES&apos;,</span><br><span class="line">npm WARN locking path: &apos;/Users/lushenneng/.npm/_locks/hexo-4ded2cf5ea4a8daa.lock&apos; &#125;</span><br><span class="line">npm ERR! Darwin 14.0.0</span><br><span class="line">npm ERR! argv &quot;node&quot; &quot;/usr/bin/npm&quot; &quot;install&quot; &quot;hexo&quot; &quot;-g&quot;</span><br><span class="line">npm ERR! node v0.12.3</span><br><span class="line">npm ERR! npm v2.9.1</span><br><span class="line">npm ERR! Attempt to unlock /usr/lib/node_modules/hexo, which hasn&apos;t been locked</span><br><span class="line">npm ERR!</span><br><span class="line">npm ERR! If you need help, you may report this error at:</span><br><span class="line">npm ERR! https://github.com/npm/npm/issues</span><br><span class="line">npm ERR! Please include the following file with any support request:</span><br><span class="line">npm ERR! /Users/lushenneng/blog/npm-debug.log</span><br></pre></td></tr></table></figure><p>解决：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> 可以先用这个命令：</span><br><span class="line">sudo npm install hexo-cli -g</span><br><span class="line"><span class="meta">#</span> 如果还是报错可以用这个命令：</span><br><span class="line">sudo npm install --unsafe-perm --verbose -g hexo</span><br><span class="line"><span class="meta">#</span> 加上sudo一般能解决很多问题</span><br></pre></td></tr></table></figure><h3 id="4-START-Hexo"><a href="#4-START-Hexo" class="headerlink" title="4. START Hexo"></a>4. START Hexo</h3><p>在blog目录下的_config.yml配置修改如下：(大概是在最后一行)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repository:</span><br><span class="line">    github: git@github.com:sheldon-lu/sheldon_blog.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>我这里不指定用的github.io这个域名是因为我用sheldon-lu.github.io作主域名，sheldon_blog作文根，当然这样的话这边hexo内设置如下：(大概在14行左右开始)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># URL</span><br><span class="line">## If your site is put in a subdirectory, set url as &apos;http://yoursite.com/child&apos; and root as &apos;/child/&apos;</span><br><span class="line">url: https://sheldon-lu.github.io/</span><br><span class="line">root: /sheldon_blog</span><br><span class="line"># permalink: :year/:month/:day/:title/</span><br><span class="line">permalink: passages/:title/</span><br><span class="line">permalink_defaults:</span><br></pre></td></tr></table></figure><p>至此，就可以使用了，浏览器输入域名：<a href="https://sheldon-lu.github.io/sheldon_blog即可" target="_blank" rel="noopener">https://sheldon-lu.github.io/sheldon_blog即可</a></p><hr><p><code>1、这里要说明一下，使用 hexo d 上传至github时如果需要用到 gh-pages 的话，记得在自己github的blog项目下创建个gh-pages的分支，即可;</code></p><p><code>2、_config.yml中配置repository时一定配置的要是ssh，别弄的什么https://github之类的</code></p><p>参考地址：<a href="https://ngwind.github.io/2018/07/27/%E4%BD%BF%E7%94%A8gh-pages+Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%BD%91%E9%A1%B5%E6%95%99%E7%A8%8B/" target="_blank" rel="noopener">https://ngwind.github.io/2018/07/27/%E4%BD%BF%E7%94%A8gh-pages+Hexo%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E7%BD%91%E9%A1%B5%E6%95%99%E7%A8%8B/</a></p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
